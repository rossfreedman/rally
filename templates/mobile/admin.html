{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block title %}Admin Panel | Rally{% endblock %}

{% block content %}
<!-- Impersonation Alert Banner (only shown when impersonating) -->
<div id="impersonation-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
  <div class="flex items-center">
    <div class="flex-shrink-0">
      <i class="fas fa-user-secret text-yellow-600 text-lg"></i>
    </div>
    <div class="ml-3 flex-1">
      <p class="text-sm text-yellow-700">
        <span class="font-medium">Admin Mode:</span> You are impersonating <span id="impersonated-user-name" class="font-semibold"></span>
      </p>
    </div>
    <div class="ml-auto">
      <button onclick="stopImpersonation()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 text-xs rounded-md transition-colors">
        Stop Impersonation
      </button>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 py-6">
  <!-- Welcome Message -->
  <div class="welcome-section text-center mb-8">
    <h1 class="text-2xl font-bold text-gray-800">
      Admin Panel
    </h1>
    <p class="text-sm text-gray-500 mt-2">
      Manage users, leagues, clubs, and system data
    </p>
  </div>


  <!-- 2. Rally Data Management Section -->
  <div class="icon-section mb-8">
    <div class="flex items-center justify-center mb-6">
      <div class="flex-grow border-t-2 border-gray-400"></div>
      <div class="section-header text-xl font-bold px-4 text-center">
        Rally Data Management
      </div>
      <div class="flex-grow border-t-2 border-gray-400"></div>
    </div>
    <div class="icon-grid grid grid-cols-2 md:grid-cols-7 gap-4" aria-label="Rally Data Management">
      <a href="/admin/leagues" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-trophy text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Leagues</span>
      </a>
      <a href="/admin/clubs" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-building text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Clubs</span>
      </a>
      <a href="/admin/series" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-list text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Series</span>
      </a>
      <a href="/admin/users" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-users text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Users</span>
      </a>
      <a href="/admin/add-player" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-user-plus text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Add Player</span>
      </a>
      <a href="/admin/etl" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-database text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">ETL</span>
      </a>
      <a href="/admin/test-notifications" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-envelope text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Test Email</span>
      </a>
        </div>
      </div>
      

  <!-- 3. User Impersonation Section -->
  <div class="icon-section mb-8">
    <div class="flex items-center justify-center mb-6">
      <div class="flex-grow border-t-2 border-gray-400"></div>
      <div class="section-header text-xl font-bold px-4 text-center">
        User Impersonation
      </div>
      <div class="flex-grow border-t-2 border-gray-400"></div>
    </div>
    
    <!-- User Impersonation Controls -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-user-secret text-indigo-600 mr-2"></i>
            Impersonate User
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            Temporarily log in as another user for testing and debugging
          </p>
        </div>
      </div>

      <!-- Impersonation Controls -->
      <div class="space-y-4">
        <!-- User Selection Type-ahead -->
        <div>
          <label for="impersonation-user-input" class="block text-sm font-medium text-gray-700 mb-2">
            Search User to Impersonate:
          </label>
          <div class="relative">
            <input 
              type="text" 
              id="impersonation-user-input" 
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-sm"
              placeholder="Type name or email to search..."
              autocomplete="off"
            />
            <div id="impersonation-user-dropdown" class="absolute z-50 w-full bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-y-auto">
              <!-- Type-ahead results will be populated here -->
            </div>
          </div>
          <!-- Hidden input to store selected user data -->
          <input type="hidden" id="impersonation-user-data" />
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3">
          <button 
            onclick="startImpersonation()" 
            class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center"
          >
            <i class="fas fa-play mr-2"></i>
            Start Impersonation
          </button>
          <button 
            onclick="stopImpersonation()" 
            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center"
          >
            <i class="fas fa-stop mr-2"></i>
            Stop Impersonation
          </button>
        </div>

        <!-- Security Notice -->
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
          <div class="flex items-start">
            <i class="fas fa-shield-alt text-amber-500 mt-0.5 mr-3"></i>
            <div class="text-sm">
              <p class="font-medium text-amber-700 mb-1">Security Notice:</p>
              <ul class="text-amber-700 space-y-1 list-disc list-inside">
                <li>Only non-admin users can be impersonated</li>
                <li>Your original admin session is safely backed up</li>
                <li>All impersonation actions are logged for audit purposes</li>
                <li>Stop impersonation when finished testing</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
// Impersonation JavaScript

// Impersonation functions with type-ahead functionality
let searchTimeout;
let selectedUserData = null;

// Initialize type-ahead functionality
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('impersonation-user-input');
    const dropdown = document.getElementById('impersonation-user-dropdown');
    
    if (input && dropdown) {
        // Handle input changes with debouncing
        input.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Hide dropdown if query is too short
            if (query.length < 2) {
                dropdown.classList.add('hidden');
                selectedUserData = null;
                document.getElementById('impersonation-user-data').value = '';
                return;
            }
            
            // Debounce the search
            searchTimeout = setTimeout(() => {
                searchUsers(query);
            }, 300);
        });
        
        // Handle input focus
        input.addEventListener('focus', function(e) {
            const query = e.target.value.trim();
            if (query.length >= 2 && dropdown.innerHTML.trim() !== '') {
                dropdown.classList.remove('hidden');
            }
        });
        
        // Handle clicks outside to close dropdown
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
        
        // Handle keyboard navigation
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.classList.add('hidden');
            }
        });
    }
});

// Search users function
async function searchUsers(query) {
    try {
        const response = await fetch(`/api/admin/search-users-for-impersonation?q=${encodeURIComponent(query)}`);
        const users = await response.json();
        
        const dropdown = document.getElementById('impersonation-user-dropdown');
        
        if (users.length === 0) {
            dropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">No users found</div>';
        } else {
            dropdown.innerHTML = '';
            
            users.forEach(user => {
                // Create user header
                const userDiv = document.createElement('div');
                userDiv.className = 'px-3 py-2 border-b border-gray-100 cursor-pointer hover:bg-gray-50';
                userDiv.innerHTML = `
                    <div class="font-medium text-gray-900">${user.first_name} ${user.last_name}</div>
                    <div class="text-sm text-gray-600">${user.email}</div>
                `;
                
                // Handle user selection (no player context)
                userDiv.addEventListener('click', function() {
                    selectUser(user, null);
                });
                
                dropdown.appendChild(userDiv);
                
                // Add player contexts if they exist
                if (user.player_contexts && user.player_contexts.length > 0) {
                    user.player_contexts.forEach(context => {
                        const contextDiv = document.createElement('div');
                        contextDiv.className = 'px-3 py-2 pl-6 border-b border-gray-100 cursor-pointer hover:bg-gray-50 text-sm';
                        contextDiv.innerHTML = `
                            <div class="text-gray-700">${context.display_name}</div>
                            <div class="text-xs text-gray-500">${context.player_name}</div>
                        `;
                        
                        // Handle context selection
                        contextDiv.addEventListener('click', function() {
                            selectUser(user, context);
                        });
                        
                        dropdown.appendChild(contextDiv);
                    });
                }
            });
        }
        
        dropdown.classList.remove('hidden');
    } catch (error) {
        console.error('Error searching users:', error);
        const dropdown = document.getElementById('impersonation-user-dropdown');
        dropdown.innerHTML = '<div class="px-3 py-2 text-red-500 text-sm">Error searching users</div>';
        dropdown.classList.remove('hidden');
    }
}

// Select user function
function selectUser(user, context) {
    selectedUserData = {
        user: user,
        context: context
    };
    
    const input = document.getElementById('impersonation-user-input');
    const dropdown = document.getElementById('impersonation-user-dropdown');
    const dataInput = document.getElementById('impersonation-user-data');
    
    // Update input display
    if (context) {
        input.value = `${user.first_name} ${user.last_name} - ${context.display_name}`;
    } else {
        input.value = `${user.first_name} ${user.last_name} (${user.email}) - No Player Context`;
    }
    
    // Store data in hidden input
    dataInput.value = JSON.stringify({
        user_email: user.email,
        tenniscores_player_id: context ? context.tenniscores_player_id : null
    });
    
    // Hide dropdown
    dropdown.classList.add('hidden');
}

async function startImpersonation() {
    const selectedValue = document.getElementById('impersonation-user-data').value;
    if (!selectedValue || !selectedUserData) {
        alert('Please search and select a user to impersonate');
        return;
    }
    
    let userEmail, playerId, displayText;
    try {
        const selection = JSON.parse(selectedValue);
        userEmail = selection.user_email;
        playerId = selection.tenniscores_player_id; // Can be null for users without player contexts
        
        // Get display text from the selected user data
        if (selectedUserData.context) {
            displayText = selectedUserData.context.display_name;
        } else {
            displayText = `${selectedUserData.user.first_name} ${selectedUserData.user.last_name} (${selectedUserData.user.email})`;
        }
    } catch (error) {
        alert('Invalid selection. Please search and select a user to impersonate.');
        return;
    }
    
    const contextInfo = playerId ? `\nAs player: ${displayText}` : '\n(No player context)';
    if (!confirm(`Are you sure you want to impersonate:\n${userEmail}${contextInfo}\n\nThis will temporarily replace your session with theirs.`)) {
        return;
    }
    
    try {
        // Show loading state
        const button = document.querySelector('button[onclick="startImpersonation()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting Impersonation...';
        button.disabled = true;
        
        const response = await fetch('/api/admin/start-impersonation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user_email: userEmail,
                tenniscores_player_id: playerId  // Can be null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show brief success message and redirect to mobile home immediately
            const contextMsg = playerId ? ` in context: ${displayText}` : ' (no player context)';
            
            // Create a temporary success message div
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-0 left-0 right-0 bg-green-500 text-white p-4 text-center z-50';
            successDiv.innerHTML = `âœ… Successfully started impersonating ${userEmail}${contextMsg}<br/>Redirecting to their view...`;
            document.body.appendChild(successDiv);
            
            // Redirect to mobile home after brief delay
            setTimeout(() => {
                window.location.href = '/mobile';
            }, 1500);
        } else {
            // Restore button state on error
            button.innerHTML = originalText;
            button.disabled = false;
            alert(`Failed to start impersonation: ${result.error}`);
        }
    } catch (error) {
        console.error('Error starting impersonation:', error);
        // Restore button state on error
        const button = document.querySelector('button[onclick="startImpersonation()"]');
        button.innerHTML = '<i class="fas fa-play mr-2"></i>Start Impersonation';
        button.disabled = false;
        alert('Error starting impersonation');
    }
}

async function stopImpersonation() {
    if (!confirm('Stop impersonation and return to your admin session?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/stop-impersonation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Impersonation stopped. Returning to admin session.');
            window.location.reload();
        } else {
            alert(`Failed to stop impersonation: ${result.error}`);
        }
    } catch (error) {
        console.error('Error stopping impersonation:', error);
        alert('Error stopping impersonation');
    }
}

async function checkImpersonationStatus() {
    try {
        const response = await fetch('/api/admin/impersonation-status');
        const status = await response.json();
        
        if (status.is_impersonating) {
            document.getElementById('impersonation-banner').classList.remove('hidden');
            const playerContext = status.impersonated_user.player_context;
            const displayText = playerContext && playerContext.club && playerContext.series 
                ? `${status.impersonated_user.first_name} ${status.impersonated_user.last_name} (${status.impersonated_user.email}) as ${playerContext.club.name}, ${playerContext.series.name}`
                : `${status.impersonated_user.first_name} ${status.impersonated_user.last_name} (${status.impersonated_user.email})`;
            document.getElementById('impersonated-user-name').textContent = displayText;
        }
    } catch (error) {
        console.error('Error checking impersonation status:', error);
    }
}

</script>

<style>
/* Custom styles for various elements */
.bg-yellow-100 { background-color: #fef3c7; }
.border-yellow-500 { border-color: #f59e0b; }
.text-yellow-600 { color: #d97706; }
.text-yellow-700 { color: #b45309; }
.bg-yellow-600 { background-color: #d97706; }
.hover\:bg-yellow-700:hover { background-color: #b45309; }

.bg-indigo-600 { background-color: #4f46e5; }
.hover\:bg-indigo-700:hover { background-color: #4338ca; }
.focus\:ring-indigo-500:focus { --tw-ring-color: #6366f1; }
.focus\:border-indigo-500:focus { border-color: #6366f1; }
.text-indigo-600 { color: #4f46e5; }

.bg-amber-50 { background-color: #fffbeb; }
.border-amber-200 { border-color: #fde68a; }
.text-amber-500 { color: #f59e0b; }
.text-amber-700 { color: #b45309; }

/* Responsive adjustments */
@media (max-width: 768px) {
  .icon-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Color utilities */
.bg-red-600 {
  background-color: #dc2626;
}

.text-red-600 {
  color: #dc2626;
}

.hover\:bg-red-700:hover {
  background-color: #b91c1c;
}

.hover\:bg-gray-300:hover {
  background-color: #d1d5db;
}
</style>
{% endblock %} 