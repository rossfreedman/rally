{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block title %}Admin Panel | Rally{% endblock %}

{% block content %}
<!-- Impersonation Alert Banner (only shown when impersonating) -->
<div id="impersonation-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-4">
  <div class="flex items-center">
    <div class="flex-shrink-0">
      <i class="fas fa-user-secret text-yellow-600 text-lg"></i>
    </div>
    <div class="ml-3 flex-1">
      <p class="text-sm text-yellow-700">
        <span class="font-medium">Admin Mode:</span> You are impersonating <span id="impersonated-user-name" class="font-semibold"></span>
      </p>
    </div>
    <div class="ml-auto">
      <button onclick="stopImpersonation()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 text-xs rounded-md transition-colors">
        Stop Impersonation
      </button>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 py-6">
  <!-- Welcome Message -->
  <div class="welcome-section text-center mb-8">
    <h1 class="text-2xl font-bold text-gray-800">
      Admin Panel
    </h1>
    <p class="text-sm text-gray-500 mt-2">
      Manage users, leagues, clubs, and system data
    </p>
  </div>

  <!-- 1. Activity Dashboard Section (Embedded) -->
  <div class="icon-section mb-8">
    <div class="flex items-center justify-center mb-6">
      <div class="flex-grow border-t-2 border-gray-400"></div>
      <div class="section-header text-xl font-bold px-4 text-center">
        Activity Dashboard
      </div>
      <div class="flex-grow border-t-2 border-gray-400"></div>
    </div>
    
    <!-- Stats Overview Cards -->
    <div class="stats-section mb-6">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
        <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
          <div class="flex items-center">
            <div class="p-2 bg-blue-100 rounded-lg">
              <i class="fas fa-chart-line text-blue-600 text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Total Activities</p>
              <p class="text-xl font-bold text-gray-900" id="total-activities">-</p>
            </div>
          </div>
        </div>
        
        <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
          <div class="flex items-center">
            <div class="p-2 bg-green-100 rounded-lg">
              <i class="fas fa-calendar-day text-green-600 text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Today</p>
              <p class="text-xl font-bold text-gray-900" id="today-activities">-</p>
            </div>
          </div>
        </div>
        
        <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
          <div class="flex items-center">
            <div class="p-2 bg-purple-100 rounded-lg">
              <i class="fas fa-users text-purple-600 text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Active Users</p>
              <p class="text-xl font-bold text-gray-900" id="active-users">-</p>
            </div>
          </div>
        </div>
        
        <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
          <div class="flex items-center">
            <div class="p-2 bg-orange-100 rounded-lg">
              <i class="fas fa-bolt text-orange-600 text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Activity Rate</p>
              <p class="text-lg font-bold text-gray-900" id="activity-rate">-</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
      
      <!-- Activity Timeline - Left Column -->
      <div class="lg:col-span-2">
        <!-- Activity Timeline -->
        <div class="timeline-section bg-white rounded-lg shadow">
          <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-clock mr-2 text-blue-600"></i>Recent Activity
              </h2>
              <div class="flex items-center space-x-2">
                <button id="refresh-timeline" class="text-gray-500 hover:text-blue-600 transition-colors">
                  <i class="fas fa-sync-alt"></i>
                </button>
                <span class="text-sm text-gray-500" id="timeline-status">Loading...</span>
              </div>
            </div>
          </div>
          
          <div class="timeline-container p-4" style="max-height: 400px; overflow-y: auto;">
            <div id="timeline-content">
              <!-- Timeline items will be loaded here -->
              <div class="flex items-center justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span class="ml-2 text-gray-600">Loading activities...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="space-y-4">
        
        <!-- Top Active Users -->
        <div class="top-players-section bg-white rounded-lg shadow">
          <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-star mr-2 text-yellow-600"></i>Most Active Users
            </h2>
            <p class="text-sm text-gray-600 mt-1">Top performers today</p>
          </div>
          <div class="p-4">
            <div id="top-players-content">
              <div class="flex items-center justify-center py-4">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-yellow-600"></div>
                <span class="ml-2 text-gray-600 text-sm">Loading users...</span>
              </div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- 2. Rally Data Management Section -->
  <div class="icon-section mb-8">
    <div class="flex items-center justify-center mb-6">
      <div class="flex-grow border-t-2 border-gray-400"></div>
      <div class="section-header text-xl font-bold px-4 text-center">
        Rally Data Management
      </div>
      <div class="flex-grow border-t-2 border-gray-400"></div>
    </div>
    <div class="icon-grid grid grid-cols-2 md:grid-cols-5 gap-4" aria-label="Rally Data Management">
      <a href="/admin/leagues" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-trophy text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Leagues</span>
      </a>
      <a href="/admin/clubs" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-building text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Clubs</span>
      </a>
      <a href="/admin/series" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-list text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Series</span>
      </a>
      <a href="/admin/users" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-users text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Users</span>
      </a>
      <a href="/admin/etl" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-database text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">ETL</span>
      </a>
    </div>
  </div>

  <!-- 3. Testing & Debug Section -->
  <div class="icon-section mb-8">
    <div class="flex items-center justify-center mb-6">
      <div class="flex-grow border-t-2 border-gray-400"></div>
      <div class="section-header text-xl font-bold px-4 text-center">
        Testing & Debug
      </div>
      <div class="flex-grow border-t-2 border-gray-400"></div>
    </div>
    <div class="icon-grid grid grid-cols-2 md:grid-cols-4 gap-4" aria-label="Testing & Debug">
      <a href="/admin/test-notifications" class="icon-btn flex flex-col items-center p-4 bg-white rounded-lg shadow hover:shadow-md transition-shadow">
        <i class="fas fa-sms text-3xl mb-3" style="color: #10645c !important;"></i>
        <span class="icon-label text-center font-semibold">Test SMS</span>
      </a>
    </div>
    
    <!-- Detailed Logging Notifications Section -->
    <div class="mt-6 bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-bell text-red-600 mr-2"></i>
            Detailed Logging Notifications
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            Send SMS alert to admin (773-213-8911) for every user activity when enabled
          </p>
        </div>
        <div class="flex items-center space-x-3">
          <span id="logging-status" class="text-sm text-gray-500">Loading...</span>
          <!-- Toggle Button -->
          <button 
            id="detailed-logging-toggle-btn" 
            onclick="handleToggleClick()"
            class="px-4 py-2 rounded-lg font-medium text-sm transition-colors duration-200 bg-gray-200 text-gray-700"
          >
            <span id="toggle-btn-text">Loading...</span>
          </button>
        </div>
      </div>
      
      <!-- Status Information -->
      <div id="logging-notifications-info" class="border-t border-gray-100 pt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-medium text-gray-700">Admin Phone:</span>
            <span class="text-gray-600 ml-2">773-213-8911</span>
          </div>
          <div>
            <span class="font-medium text-gray-700">Current Status:</span>
            <span id="logging-current-status" class="ml-2">
              <i class="fas fa-spinner fa-spin text-gray-400"></i> Loading...
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Dashboard and Impersonation JavaScript
let dashboardData = {
  activities: [],
  stats: {},
  topPlayers: [],
  currentFilter: 'today',
  emptyText: 'No activities today'
};

// Load users for impersonation dropdown and initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadUsersForImpersonation();
    checkImpersonationStatus();
    initializeDashboard();
    loadDetailedLoggingStatus();
});

// Dashboard initialization
function initializeDashboard() {
  loadDashboardStats();
  loadTimelineActivities();
  loadTopPlayers();
  
  // Set up auto-refresh
  setInterval(refreshDashboardData, 30000); // Refresh every 30 seconds
}

async function loadDashboardStats() {
  try {
    // Include admin filtering - default to exclude admin activities for cleaner overview
    const response = await fetch('/api/admin/dashboard/stats?exclude_admin=true&exclude_impersonated=false');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.stats = data.stats;
      updateStatsDisplay();
    }
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
  }
}

async function loadTimelineActivities() {
  try {
    document.getElementById('timeline-status').textContent = 'Loading...';
    
    // Filter out admin activities for cleaner overview consistent with other sections
    const response = await fetch('/api/admin/dashboard/activities?limit=10&exclude_admin=true&exclude_impersonated=false');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.activities = data.activities;
      renderTimeline();
      document.getElementById('timeline-status').textContent = 'Updated just now';
    }
  } catch (error) {
    console.error('Error loading timeline activities:', error);
    document.getElementById('timeline-status').textContent = 'Error loading';
  }
}

async function loadTopPlayers() {
  try {
    // Include admin filtering - default to exclude admin activities for cleaner overview
    const response = await fetch('/api/admin/dashboard/top-players?limit=5&exclude_admin=true&exclude_impersonated=false');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.topPlayers = data.top_players;
      renderTopPlayers();
    }
  } catch (error) {
    console.error('Error loading top users:', error);
  }
}

function updateStatsDisplay() {
  const stats = dashboardData.stats;
  document.getElementById('total-activities').textContent = formatNumber(stats.total_activities || 0);
  document.getElementById('today-activities').textContent = formatNumber(stats.today_activities || 0);
  document.getElementById('active-users').textContent = formatNumber(stats.active_users_today || 0);
  
  // Calculate activity rate (activities per hour today)
  const currentHour = new Date().getHours();
  const rate = currentHour > 0 ? Math.round((stats.today_activities || 0) / currentHour) : (stats.today_activities || 0);
  document.getElementById('activity-rate').textContent = `${rate}/hr`;
}

function renderTimeline() {
  const container = document.getElementById('timeline-content');
  const activities = dashboardData.activities;
  
  if (activities.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activities</p>';
    return;
  }
  
  const html = activities.map(activity => {
    const timeAgo = getTimeAgo(activity.timestamp);
    const actionIcon = getActionTypeIcon(activity.action_type);
    const actionColor = getActionTypeColor(activity.action_type);
    
    return `
      <div class="timeline-item ${activity.action_type} mb-4">
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-${actionColor}-100 rounded-full flex items-center justify-center">
              <i class="${actionIcon} text-${actionColor}-600 text-sm"></i>
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-gray-900">
                ${activity.action_description}
              </p>
              <p class="text-xs text-gray-500">${timeAgo}</p>
            </div>
            
            ${activity.user ? `
              <p class="text-xs text-gray-600 mt-1">
                <i class="fas fa-user mr-1"></i>
                ${activity.user.first_name} ${activity.user.last_name}
              </p>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function renderTopPlayers() {
  const container = document.getElementById('top-players-content');
  const players = dashboardData.topPlayers;
  
  if (players.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No user activity data</p>';
    return;
  }
  
  const html = players.map((player, index) => {
    const rankIcon = index < 3 ? ['🥇', '🥈', '🥉'][index] : `#${index + 1}`;
    
    return `
      <div class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0">
        <div class="flex items-center space-x-3">
          <span class="text-sm font-bold" style="min-width: 30px;">${rankIcon}</span>
          <div>
            <p class="text-sm font-medium text-gray-900">
              ${player.first_name} ${player.last_name}
            </p>
            <p class="text-xs text-gray-600">
              ${player.club_name || 'Unknown Club'}
            </p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm font-bold text-gray-900">${formatNumber(player.activity_count)}</p>
          <p class="text-xs text-gray-600">activities</p>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function refreshDashboardData() {
  loadDashboardStats();
  const currentFilter = dashboardData.currentFilter || 'today';
  loadTimelineActivities(currentFilter);
  loadTopPlayers();
}

// Event handlers
document.addEventListener('click', function(e) {
  if (e.target.id === 'refresh-timeline' || e.target.parentElement.id === 'refresh-timeline') {
    refreshDashboardData();
  }
});

// Activity filter change handler
document.addEventListener('change', function(e) {
  if (e.target.id === 'activity-filter') {
    const selectedFilter = e.target.value;
    loadTimelineActivities(selectedFilter);
  }
});

// Utility functions
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

function getTimeAgo(timestamp) {
  const now = new Date();
  const time = new Date(timestamp);
  const diffMs = now - time;
  const diffMins = Math.floor(diffMs / 60000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  
  const diffHours = Math.floor(diffMins / 60);
  if (diffHours < 24) return `${diffHours}h ago`;
  
  const diffDays = Math.floor(diffHours / 24);
  return `${diffDays}d ago`;
}

function getActionTypeIcon(actionType) {
  const iconMap = {
    'page_visit': 'fas fa-eye',
    'user_action': 'fas fa-mouse-pointer',
    'login': 'fas fa-sign-in-alt',
    'logout': 'fas fa-sign-out-alt',
    'availability_update': 'fas fa-calendar-check',
    'poll_voted': 'fas fa-vote-yea',
    'ai_chat': 'fas fa-robot',
    'simulation_run': 'fas fa-play-circle',
    'admin_action': 'fas fa-user-shield'
  };
  return iconMap[actionType] || 'fas fa-circle';
}

function getActionTypeColor(actionType) {
  const colorMap = {
    'page_visit': 'blue',
    'user_action': 'green',
    'login': 'green',
    'logout': 'gray',
    'availability_update': 'cyan',
    'poll_voted': 'purple',
    'ai_chat': 'indigo',
    'simulation_run': 'orange',
    'admin_action': 'red'
  };
  return colorMap[actionType] || 'gray';
}

// Impersonation functions (existing code)
async function loadUsersForImpersonation() {
    try {
        const response = await fetch('/api/admin/users-for-impersonation');
        const users = await response.json();
        
        const select = document.getElementById('impersonation-user-select');
        select.innerHTML = '<option value="">Select a user to impersonate...</option>';
        
        users.forEach(user => {
            if (user.player_contexts && user.player_contexts.length > 0) {
                // User has player contexts - show hierarchy
                const userHeader = document.createElement('option');
                userHeader.value = '';
                userHeader.textContent = `${user.first_name} ${user.last_name} (${user.email})`;
                userHeader.disabled = true;
                userHeader.style.fontWeight = 'bold';
                userHeader.style.backgroundColor = '#f3f4f6';
                select.appendChild(userHeader);
                
                // Add player contexts for this user
                user.player_contexts.forEach(context => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        user_email: user.email,
                        tenniscores_player_id: context.tenniscores_player_id
                    });
                    option.textContent = `  └── ${context.display_name}`;
                    option.style.paddingLeft = '20px';
                    select.appendChild(option);
                });
            } else {
                // User has no player contexts - show directly as selectable
                const option = document.createElement('option');
                option.value = JSON.stringify({
                    user_email: user.email,
                    tenniscores_player_id: null  // No player context
                });
                option.textContent = `${user.first_name} ${user.last_name} (${user.email}) - No Player Context`;
                option.style.color = '#6b7280'; // Gray color to indicate no context
                select.appendChild(option);
            }
            
            // Add separator (except for last user)
            if (users.indexOf(user) < users.length - 1) {
                const separator = document.createElement('option');
                separator.value = '';
                separator.textContent = '────────────────────────';
                separator.disabled = true;
                separator.style.color = '#9ca3af';
                select.appendChild(separator);
            }
        });
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('impersonation-user-select').innerHTML = '<option value="">Error loading users</option>';
    }
}

async function startImpersonation() {
    const selectedValue = document.getElementById('impersonation-user-select').value;
    if (!selectedValue) {
        alert('Please select a user to impersonate');
        return;
    }
    
    let userEmail, playerId, displayText;
    try {
        const selection = JSON.parse(selectedValue);
        userEmail = selection.user_email;
        playerId = selection.tenniscores_player_id; // Can be null for users without player contexts
        
        // Get display text from the selected option
        const select = document.getElementById('impersonation-user-select');
        displayText = select.options[select.selectedIndex].textContent.trim();
    } catch (error) {
        alert('Invalid selection. Please choose a user to impersonate.');
        return;
    }
    
    const contextInfo = playerId ? `\nAs player: ${displayText}` : '\n(No player context)';
    if (!confirm(`Are you sure you want to impersonate:\n${userEmail}${contextInfo}\n\nThis will temporarily replace your session with theirs.`)) {
        return;
    }
    
    try {
        // Show loading state
        const button = document.querySelector('button[onclick="startImpersonation()"]');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting Impersonation...';
        button.disabled = true;
        
        const response = await fetch('/api/admin/start-impersonation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                user_email: userEmail,
                tenniscores_player_id: playerId  // Can be null
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show brief success message and redirect to mobile home immediately
            const contextMsg = playerId ? ` in context: ${displayText}` : ' (no player context)';
            
            // Create a temporary success message div
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-0 left-0 right-0 bg-green-500 text-white p-4 text-center z-50';
            successDiv.innerHTML = `✅ Successfully started impersonating ${userEmail}${contextMsg}<br/>Redirecting to their view...`;
            document.body.appendChild(successDiv);
            
            // Redirect to mobile home after brief delay
            setTimeout(() => {
                window.location.href = '/mobile';
            }, 1500);
        } else {
            // Restore button state on error
            button.innerHTML = originalText;
            button.disabled = false;
            alert(`Failed to start impersonation: ${result.error}`);
        }
    } catch (error) {
        console.error('Error starting impersonation:', error);
        // Restore button state on error
        const button = document.querySelector('button[onclick="startImpersonation()"]');
        button.innerHTML = '<i class="fas fa-play mr-2"></i>Start Impersonation';
        button.disabled = false;
        alert('Error starting impersonation');
    }
}

async function stopImpersonation() {
    if (!confirm('Stop impersonation and return to your admin session?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/stop-impersonation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Impersonation stopped. Returning to admin session.');
            window.location.reload();
        } else {
            alert(`Failed to stop impersonation: ${result.error}`);
        }
    } catch (error) {
        console.error('Error stopping impersonation:', error);
        alert('Error stopping impersonation');
    }
}

async function checkImpersonationStatus() {
    try {
        const response = await fetch('/api/admin/impersonation-status');
        const status = await response.json();
        
        if (status.is_impersonating) {
            document.getElementById('impersonation-banner').classList.remove('hidden');
            const playerContext = status.impersonated_user.player_context;
            const displayText = playerContext && playerContext.club && playerContext.series 
                ? `${status.impersonated_user.first_name} ${status.impersonated_user.last_name} (${status.impersonated_user.email}) as ${playerContext.club.name}, ${playerContext.series.name}`
                : `${status.impersonated_user.first_name} ${status.impersonated_user.last_name} (${status.impersonated_user.email})`;
            document.getElementById('impersonated-user-name').textContent = displayText;
        }
    } catch (error) {
        console.error('Error checking impersonation status:', error);
    }
}

// Detailed Logging Notifications Functions
let loggingNotificationsEnabled = false; // Track current state

async function loadDetailedLoggingStatus() {
    try {
        const response = await fetch('/api/admin/detailed-logging-notifications/status');
        const data = await response.json();
        
        if (data.success) {
            loggingNotificationsEnabled = data.enabled;
            updateLoggingUI(data.enabled);
        } else {
            console.error('Error loading detailed logging status:', data.error);
            document.getElementById('logging-current-status').innerHTML = '<span class="text-red-600">Error loading status</span>';
        }
    } catch (error) {
        console.error('Error loading detailed logging status:', error);
        document.getElementById('logging-current-status').innerHTML = '<span class="text-red-600">Error loading status</span>';
    }
}

function updateLoggingUI(isEnabled) {
    const toggleBtn = document.getElementById('detailed-logging-toggle-btn');
    const toggleBtnText = document.getElementById('toggle-btn-text');
    const loggingStatus = document.getElementById('logging-status');
    const loggingCurrentStatus = document.getElementById('logging-current-status');
    
    if (isEnabled) {
        toggleBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm transition-colors duration-200 bg-red-600 text-white hover:bg-red-700';
        toggleBtnText.textContent = 'Disable';
        loggingStatus.textContent = 'Enabled';
        loggingStatus.className = 'text-sm text-red-600 font-medium';
        loggingCurrentStatus.innerHTML = '<span class="text-red-600 font-medium">🔔 Active</span>';
    } else {
        toggleBtn.className = 'px-4 py-2 rounded-lg font-medium text-sm transition-colors duration-200 bg-gray-200 text-gray-700 hover:bg-gray-300';
        toggleBtnText.textContent = 'Enable';
        loggingStatus.textContent = 'Disabled';
        loggingStatus.className = 'text-sm text-gray-500';
        loggingCurrentStatus.innerHTML = '<span class="text-gray-500">🔇 Inactive</span>';
    }
}

async function handleToggleClick() {
    const newState = !loggingNotificationsEnabled;
    
    try {
        // Show loading state
        document.getElementById('toggle-btn-text').textContent = 'Loading...';
        document.getElementById('detailed-logging-toggle-btn').disabled = true;
        document.getElementById('logging-current-status').innerHTML = '<i class="fas fa-spinner fa-spin text-gray-400"></i> Updating...';
        
        const response = await fetch('/api/admin/detailed-logging-notifications/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: newState })
        });
        
        const result = await response.json();
        
        if (result.success) {
            loggingNotificationsEnabled = newState;
            updateLoggingUI(newState);
            
            // Show success message
            const action = newState ? 'enabled' : 'disabled';
            const alertClass = newState ? 'bg-red-500' : 'bg-green-500';
            
            // Create temporary success notification
            const notification = document.createElement('div');
            notification.className = `fixed top-16 right-4 ${alertClass} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300`;
            notification.innerHTML = `✅ Detailed logging notifications ${action}!`;
            document.body.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
            
        } else {
            // Revert to original state on error
            updateLoggingUI(loggingNotificationsEnabled);
            alert(`Failed to ${newState ? 'enable' : 'disable'} detailed logging: ${result.error}`);
        }
    } catch (error) {
        console.error('Error toggling detailed logging:', error);
        // Revert to original state on error
        updateLoggingUI(loggingNotificationsEnabled);
        alert('Error toggling detailed logging');
    } finally {
        // Re-enable button
        document.getElementById('detailed-logging-toggle-btn').disabled = false;
    }
}
</script>

<style>
/* Dashboard Styles */
.stat-card {
  transition: transform 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.timeline-item {
  position: relative;
}

/* Custom styles for various elements */
.bg-yellow-100 { background-color: #fef3c7; }
.border-yellow-500 { border-color: #f59e0b; }
.text-yellow-600 { color: #d97706; }
.text-yellow-700 { color: #b45309; }
.bg-yellow-600 { background-color: #d97706; }
.hover\:bg-yellow-700:hover { background-color: #b45309; }

.bg-indigo-600 { background-color: #4f46e5; }
.hover\:bg-indigo-700:hover { background-color: #4338ca; }
.focus\:ring-indigo-500:focus { --tw-ring-color: #6366f1; }
.focus\:border-indigo-500:focus { border-color: #6366f1; }
.text-indigo-600 { color: #4f46e5; }

.bg-amber-50 { background-color: #fffbeb; }
.border-amber-200 { border-color: #fde68a; }
.text-amber-500 { color: #f59e0b; }
.text-amber-700 { color: #b45309; }

/* Background color utilities */
.bg-blue-100 { background-color: #dbeafe; }
.bg-green-100 { background-color: #dcfce7; }
.bg-purple-100 { background-color: #e9d5ff; }
.bg-orange-100 { background-color: #fed7aa; }
.bg-gray-100 { background-color: #f3f4f6; }

/* Text color utilities */
.text-blue-600 { color: #2563eb; }
.text-green-600 { color: #16a34a; }
.text-purple-600 { color: #9333ea; }
.text-orange-600 { color: #ea580c; }
.text-gray-600 { color: #4b5563; }
.text-yellow-600 { color: #d97706; }

/* Loading states */
.loading {
  opacity: 0.6;
  pointer-events: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .stats-section .grid {
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }
  
  .stat-card {
    padding: 0.75rem;
  }
  
  .stat-card .text-xl {
    font-size: 1.125rem;
  }
}

@media (max-width: 640px) {
  .stats-section .grid {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }
  
  .stat-card {
    padding: 1rem;
  }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .icon-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Color utilities */
.bg-red-600 {
  background-color: #dc2626;
}

.text-red-600 {
  color: #dc2626;
}

.hover\:bg-red-700:hover {
  background-color: #b91c1c;
}

.hover\:bg-gray-300:hover {
  background-color: #d1d5db;
}
</style>
{% endblock %} 