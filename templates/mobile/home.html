{% extends "mobile/layout.html" %}
{% set cache_buster = range(100000, 999999) | random %}
{% set timestamp = range(1000000000, 9999999999) | random %}

{% block content %}
<!-- Force no cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- Custom CSS for main-alt page -->
<style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
        }
        
        .section-hero {
            background: #045454;
        }
        
        .pti-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
            border: 8px solid #bff863;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(191, 248, 99, 0.3);
        }
        
        .hover-lift {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }
        
        /* Scroll margin for sticky navigation */
        #schedule, #dashboard, #team, #club, #play {
            scroll-margin-top: 135px; /* Account for sticky nav + header height (51px navbar) */
        }
        
        .carousel {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .carousel::-webkit-scrollbar {
            display: none;
        }

        /* Sticky Navigation Styles */
        .sticky-nav {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: #045454;
        }
        
        /* Ensure sticky navigation works properly */
        .sticky-nav-container {
            position: relative;
            z-index: 50;
        }
        
        .sticky-nav-container.fixed {
            position: fixed !important;
            top: 51px !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
        }
        
        /* Placeholder for fixed navigation to prevent layout shift */
        .sticky-nav-placeholder {
            display: none;
            height: 0;
            transition: height 0.3s ease;
        }
        
        .sticky-nav-placeholder.active {
            display: block;
            height: 80px; /* Height of nav container to prevent layout shift */
        }

        .sticky-nav.scrolled {
            background: rgba(4, 84, 84, 0.98);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            border: 0.5px solid white !important;
        }

        .nav-button.scrolled {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-button.scrolled:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Active state styling */
        .nav-button.active {
            background: #bff863 !important;
            color: #045454 !important;
        }

        .nav-button.active:hover {
            background: #bff863 !important;
            color: #045454 !important;
        }

        /* Main section header styling - only for main sections */
        .main-section-header {
            border: 0.5px solid white !important;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Add padding to account for sticky nav */
        .main-content {
            padding-top: 0;
        }

        /* Persistence styles */
        .persistent-card {
            transition: all 0.3s ease;
        }
        
        .persistent-card.loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .persistent-card.loaded {
            opacity: 1;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Video aspect ratio */
        .aspect-video {
            aspect-ratio: 16 / 9;
            position: relative;
            width: 100%;
        }

        /* Fallback for browsers that don't support aspect-ratio */
        @supports not (aspect-ratio: 16 / 9) {
            .aspect-video {
                padding-bottom: 56.25%; /* 16:9 aspect ratio */
                height: 0;
                position: relative;
            }
            .aspect-video > * {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        }
    </style>

<!-- Main content starts here -->

    <!-- ============================================
         HEADER (Fixed at top, below navbar)
         ============================================ -->
    <div class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4" style="margin-top: 11px;">
        <header class="section-hero text-white shadow-lg rounded-2xl py-6 px-6">
            <div class="flex items-start gap-4">
                <!-- Logo Section -->
                <div class="flex-shrink-0">
                    {% if session_data and session_data.user and session_data.user.club_logo %}
                    <img src="/{{ session_data.user.club_logo }}" 
                         alt="{{ session_data.user.club }} Logo" 
                         class="w-20 h-20 object-contain rounded-xl"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    {% endif %}
                    <div class="w-20 h-20 text-white flex items-center justify-center font-bold text-lg rounded-xl" 
                         style="{% if session_data and session_data.user and session_data.user.club_logo %}display: none;{% endif %}background-color: #bff863; color: #045454;">
                        {{ session_data.user.club[0:2] if session_data and session_data.user and session_data.user.club else 'CL' }}
                    </div>
                </div>
                
                <!-- Text Section -->
                <div class="flex-1">
                    <h1 class="text-3xl font-bold tracking-tight mb-2">Welcome back, {{ session_data.user.first_name }}</h1>
                    {% if session_data and session_data.user and session_data.user.league_name %}
                    <!-- League Information -->
                    <div class="space-y-1">
                        <div>
                            <span class="font-medium text-white/90">{{ session_data.user.league_name }}</span>
                        </div>
                        
                        <div>
                            <span class="font-medium text-white/80">{{ session_data.user.series }} @ {{ session_data.user.club }}</span>
                        </div>
                    </div>
                    
                    <!-- League Selector Chip -->
                    <div class="mt-3">
                        <button id="leagueSwitcherTrigger" class="px-3 py-1 rounded-full text-xs font-medium hidden transition-colors duration-200 shadow-sm hover:opacity-90" style="background-color: #bff863; color: #045454;" aria-label="Change League/Team" onclick="showLeagueSwitcher()">
                            Switch League/Team
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            
        </header>
    </div>

    <!-- Sticky Navigation Tabs (Persistent below header) -->
    <div id="sticky-nav-container" class="sticky-nav-container max-w-7xl mx-auto px-2 sm:px-3 lg:px-4 py-4" style="position: sticky; top: 51px; z-index: 40;">
        <nav id="main-nav" class="sticky-nav rounded-3xl px-6 py-4 shadow-xl">
            <div class="flex gap-1.5 justify-center">
                <a href="#schedule" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Schedule</a>
                <a href="#dashboard" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Stats</a>
                <a href="#team" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Team</a>
                <a href="#club" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Club</a>
                <a href="#play" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Play</a>
            </div>
        </nav>
    </div>
    
    <!-- Placeholder to prevent layout shift when nav becomes fixed -->
    <div id="sticky-nav-placeholder" class="sticky-nav-placeholder"></div>

    <main class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4 py-8 space-y-12">

        <!-- ============================================
             1. SCHEDULE SECTION
             ============================================ -->
        <section id="schedule" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Schedule</h2>
            </div>
            
            <!-- Next Match Hero -->
            <div class="rounded-3xl p-8 text-white shadow-xl hover-lift" style="background-color: #045454;">
                <div id="next-match-loading" class="text-center py-8">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="next-match-content" class="hidden">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold text-left" style="color: #bff863;">Next Match</h3>
                    </div>
                    <div id="next-match-details"></div>
                </div>
                
                <div id="next-match-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-alt text-4xl mb-4 opacity-50"></i>
                    <p class="text-white/80">No upcoming matches scheduled</p>
                </div>
            </div>
            

            <!-- Upcoming Matches & Practices -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Future Matches -->
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-trophy" style="color: #bff863;"></i>
                            Future Matches
                        </h3>
                    </div>
                    
                    <div id="opponents-loading" class="text-center py-8">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                    
                    <div id="opponents-content" class="hidden space-y-3"></div>
                    
                    <div id="opponents-empty" class="hidden text-center py-8">
                        <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No upcoming matches</p>
                    </div>
                    
                    <a href="/mobile/availability-calendar" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        Update Match Availability ‚Üí
                    </a>
                </div>
                
                <!-- Next 3 Practices -->
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-dumbbell" style="color: #bff863;"></i>
                            Next 3 Practices
                        </h3>
                    </div>
                    
                    <div id="practices-loading" class="text-center py-8">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                    
                    <div id="practices-content" class="hidden space-y-3"></div>
                    
                    <div id="practices-empty" class="hidden text-center py-8">
                        <i class="fas fa-dumbbell text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No upcoming practices</p>
                    </div>
                    
                    <a href="/mobile/availability-calendar" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        Update Practice Availability ‚Üí
                    </a>
                </div>
            </div>
        </section>

        <!-- ============================================
             2. MY STATS SECTION
             ============================================ -->
        <section id="dashboard" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="main-section-header bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-4 relative overflow-hidden" style="margin-top: -25px;">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                     <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Stats</h2>
            </div>
            
            <!-- PTI Hero Card -->
            <div class="section-hero rounded-3xl p-8 sm:p-12 text-center text-white shadow-xl hover-lift persistent-card" id="pti-card">
                <div id="pti-loading" class="py-8">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="pti-content" class="hidden">
                    <h3 class="text-xl font-semibold mb-6 text-white/90">My PTI</h3>
                    <div class="pti-circle mx-auto mb-6">
                        <div id="pti-value" class="text-6xl font-bold">--</div>
                    </div>
                    <p id="pti-message" class="text-lg text-white/90 max-w-2xl mx-auto"></p>
                <a href="/mobile/analyze-me" class="inline-block mt-6 px-8 py-3 rounded-full font-semibold transition shadow-lg" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                    Tell me more ‚Üí
                </a>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="space-y-4">
                <!-- First Row: My Record and Win Rate -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- My Record -->
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift persistent-card" id="record-card">
                        <div class="text-2xl font-bold text-[#045454] mb-4">My Record</div>
                        <div id="my-record" class="text-3xl font-bold text-[#045454]">-- - --</div>
                    </div>
                    
                    <!-- Win Rate -->
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift persistent-card" id="winrate-card">
                        <div class="text-2xl font-bold text-[#045454] mb-4">Win Rate</div>
                        <div id="win-rate" class="text-3xl font-bold text-[#045454]">--%</div>
                    </div>
                </div>
                
                <!-- Second Row: Win Streak and Best Partner -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Win Streak -->
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                        <div class="text-2xl font-bold text-[#045454] mb-4">Win Streak</div>
                        <div id="win-streak" class="text-3xl font-bold text-rally-green">üî• --</div>
                    </div>
                    
                    <!-- Best Partner -->
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                        <div class="text-2xl font-bold text-[#045454] mb-4">Best Partner</div>
                        <div id="best-partner-content">
                            <div class="text-center py-4">
                                <div class="w-8 h-8 border-4 border-gray-200 border-t-[#045454] rounded-full animate-spin mx-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Last Match Results -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-[#045454] mb-4">My Last Match</h3>
                <div id="last-match-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                <div id="last-match-content" class="hidden"></div>
                <div id="last-match-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-times text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No recent matches found</p>
                </div>
            </div>
        </section>


        <!-- ============================================
             3. TEAM SECTION
             ============================================ -->
        <section class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div id="team" class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Team</h2>
            </div>
            
            <!-- Captain's Message -->
            <div id="captain-message-section" class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 shadow-md border-l-4 border-rally-green hidden">
                <h3 class="text-xl font-bold text-[#045454] mb-3 flex items-center gap-2">
                    <i class="fas fa-bullhorn text-rally-green"></i>
                    Captain's Message
                </h3>
                <div id="captain-message-content"></div>
            </div>
            
            <!-- How Are We Doing? -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-6" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0" style="color: #bff863;">How Are We Doing?</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- First Row: Total Points, Avg Pts, and Behind 1st -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Total<br>Points</div>
                            <div id="team-points" class="text-3xl font-bold text-rally-green">--</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Avg<br>Pts</div>
                            <div id="avg-points" class="text-3xl font-bold text-blue-500">--</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Behind<br>1st</div>
                            <div id="points-behind" class="text-3xl font-bold text-orange-500">--</div>
                        </div>
                    </div>
                    
                    <!-- Second Row: Team Record and Win Rate -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Team Record</div>
                            <div id="team-record" class="text-2xl font-bold text-[#045454]">-- - --</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Win Rate</div>
                            <div id="team-win-rate" class="text-3xl font-bold text-[#045454]">--%</div>
                        </div>
                    </div>
                </div>
                
                <a href="/mobile/my-team" class="block mt-6 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    View All Team Stats ‚Üí
                </a>
            </div>
            
            <!-- Series Overview -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0" style="color: #bff863;">Series Standings</h3>
                </div>
                
                <div class="mb-4 px-4 py-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-base font-medium text-blue-700 text-center">
                        <i class="fas fa-arrows-alt-h mr-2 text-blue-600"></i>
                        Scroll right to see all columns
                    </p>
                </div>
                
                <div id="series-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="series-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table id="seriesTable" class="text-sm text-left min-w-full">
                            <!-- Table will be populated by JS -->
                        </table>
                    </div>
                </div>
                
                <a href="/mobile/my-series" class="block mt-6 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    View Full Series Standings ‚Üí
                </a>
                
                <a href="/mobile/teams-players" class="block mt-3 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    Scout Additional Teams & Players ‚Üí
                </a>
            </div>
            
            <!-- Team Polls -->
            <div id="team-polls-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-poll" style="color: #bff863;"></i>
                        Team Polls
                    </h3>
                </div>
                
                <!-- Active Polls -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-[#045454] mb-3 flex items-center gap-2">
                        <i class="fas fa-clock text-green-500"></i>
                        Active Polls
                    </h4>
                    <div id="active-polls-content" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">Loading active polls...</div>
                    </div>
                </div>
                
                <!-- Past Polls -->
                <div class="mb-4">
                    <h4 class="text-lg font-semibold text-[#045454] mb-3 flex items-center gap-2">
                        <i class="fas fa-history text-gray-500"></i>
                        Past Polls
                    </h4>
                    <div id="past-polls-content" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">Loading past polls...</div>
                    </div>
                </div>
                
                <a href="/mobile/polls" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    View All Polls ‚Üí
                </a>
            </div>
        </section>

        <!-- ============================================
             4. CLUB SECTION
             ============================================ -->
        <section id="club" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Club</h2>
            </div>
            
            
            <!-- Club Highlights Grid -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Teams in 1st Place -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-trophy" style="color: #bff863;"></i>
                            {{ session_data.user.club or 'Club' }} Teams in 1st Place
                        </h3>
                    </div>
                    
                    <!-- Loading state -->
                    <div id="first-place-loading" class="text-center py-4">
                        <div class="w-6 h-6 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-2">Loading teams...</p>
                    </div>
                    
                    <!-- Table content -->
                    <div id="first-place-content" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="py-1 px-2 text-left text-xs font-medium text-gray-700">Team</th>
                                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700">Place</th>
                                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700">Avg Pts</th>
                                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700">Total Pts</th>
                                    </tr>
                                </thead>
                                <tbody id="first-place-teams-table">
                                    <!-- Teams will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- View All Teams Button -->
                        <div class="mt-4 pt-3 border-t border-gray-200">
                            <button onclick="viewAllClubTeams()" class="w-full bg-[#045454] text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-[#033d3d] transition-colors">
                                View all {{ session_data.user.club or 'Club' }} teams ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <!-- Empty state -->
                    <div id="first-place-empty" class="hidden text-center py-4">
                        <i class="fas fa-trophy text-2xl text-gray-300 mb-2"></i>
                        <p class="text-sm text-gray-500">No teams in 1st place</p>
                    </div>
                </div>
                
                
                <!-- PTI Movers & Shakers -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-chart-line" style="color: #bff863;"></i>
                            PTI Movers & Shakers
                        </h3>
                    </div>
                    <div id="pti-movers-list" class="space-y-2 mb-4">
                        <div class="text-center text-gray-500 py-4">Loading...</div>
                    </div>
                    <a href="/mobile/pti-movers" class="block w-full text-center py-2 px-4 text-white rounded-lg font-medium transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        View More ‚Üí
                    </a>
                </div>
            </div>
            
            <!-- Who's Hot at Club -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-fire" style="color: #bff863;"></i>
                        Who's Hot at {{ session_data.user.club }}
                    </h3>
                </div>
                
                <div id="players-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="players-carousel" class="hidden space-y-2"></div>
                
                <div id="players-empty" class="hidden text-center py-8">
                    <i class="fas fa-users text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No player data available</p>
                </div>
            </div>
            
            <!-- Club Events -->
            <div id="club-events-section" class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6 shadow-md hidden">
                <h3 class="text-2xl font-bold text-[#045454] mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-star text-purple-600"></i>
                    Club Events
                </h3>
                <div id="club-events-content"></div>
            </div>
            
            <!-- Food & Beer -->
            <div class="grid md:grid-cols-2 gap-6">
                <div id="food-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-utensils" style="color: #bff863;"></i>
                            Food Menu
                        </h3>
                    </div>
                    <div id="food-content"></div>
                </div>
                
                <div id="beer-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-beer" style="color: #bff863;"></i>
                            Beer Menu
                        </h3>
                    </div>
                    <div id="beer-content"></div>
                </div>
            </div>
            
            <a href="/mobile/my-club" class="block text-center py-4 text-white rounded-2xl font-semibold transition text-lg shadow-md" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                More Club Info ‚Üí
            </a>
        </section>

        <!-- ============================================
             5. PLAY SECTION
             ============================================ -->
        <section id="play" class="space-y-6 pb-12">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Play</h2>
            </div>
            
            <!-- Pickup Games -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-users" style="color: #bff863;"></i>
                        Pickup Games
                    </h3>
                </div>
                
                <div id="pickup-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="pickup-content" class="hidden space-y-3"></div>
                
                <div id="pickup-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No pickup games available</p>
                </div>
                
                <div class="flex gap-3 mt-4">
                    <a href="/mobile/pickup-games" class="flex-1 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        View All<br>Pickup Games ‚Üí
                    </a>
                    <a href="/mobile/create-pickup-game?type=public" class="flex-1 text-center py-3 rounded-xl font-semibold transition" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                        Create<br>Pickup Game ‚Üí
                    </a>
                </div>
            </div>
            
            <!-- Find People to Play -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-user-friends" style="color: #bff863;"></i>
                        Find People to Play
                    </h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Quick Search Form -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                            <input type="text" id="quickFirstName" placeholder="Enter first name" 
                                   class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-rally-green focus:border-rally-green">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                            <input type="text" id="quickLastName" placeholder="Enter last name" 
                                   class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-rally-green focus:border-rally-green">
                        </div>
                    </div>
                    
                    <!-- Search Buttons -->
                    <div class="pt-2">
                        <button id="quickSearchBtn" class="w-full px-4 py-3 text-white rounded-lg focus:outline-none focus:ring-2 transition-colors duration-200 font-medium" style="background-color: #045454; border-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                            <i class="fas fa-search mr-2"></i>Search Players
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Latest Paddle Tip -->
            <div class="rounded-3xl p-8 text-white shadow-xl hover-lift" style="background-color: #045454;">
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-3xl"></i>
                    Latest Paddle Tip
                </h3>
                
                <div id="paddle-tip-loading" class="text-center py-8">
                    <div class="w-8 h-8 border-4 border-white/30 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="paddle-tip-content" class="hidden text-lg mb-6 text-white/90">
                    <!-- Dynamic content will be loaded here -->
                </div>
                
                <div id="paddle-tip-empty" class="hidden text-center py-8">
                    <i class="fas fa-lightbulb text-4xl text-white/50 mb-2"></i>
                    <p class="text-white/70">Paddle tips coming soon!</p>
                </div>
                
                <a href="/mobile/improve" class="inline-block px-8 py-3 bg-white rounded-full font-semibold hover:bg-gray-100 transition shadow-lg" style="color: #045454;">
                    Improve My Game ‚Üí
                </a>
            </div>
            
            <!-- Featured Training Video -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-play-circle" style="color: #bff863;"></i>
                        Featured Training Video
                    </h3>
                </div>
                
                <div id="training-video-content" class="space-y-4">
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <i class="fas fa-video text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-4">Loading featured video...</p>
                        <div class="w-8 h-8 border-4 border-gray-300 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                </div>
                
                <a href="/mobile/training-videos" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    Browse All Videos ‚Üí
                </a>
            </div>
            
            <!-- My Lessons -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-graduation-cap" style="color: #bff863;"></i>
                        My Lessons
                    </h3>
                </div>
                
                <div id="lessons-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="lessons-content" class="hidden space-y-3"></div>
                
                <div id="lessons-empty" class="hidden text-center py-8">
                    <i class="fas fa-graduation-cap text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No lessons scheduled</p>
                </div>
                
                <a href="/mobile/schedule-lesson" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    Schedule Lesson ‚Üí
                </a>
            </div>
        </section>


    </main>

    <!-- ============================================
         JAVASCRIPT - DATA LOADING
         ============================================ -->
    <script id="main-alt-script-{{ cache_buster }}-{{ timestamp }}">
        // Cache buster: {{ cache_buster }} - Timestamp: {{ timestamp }}
        console.log('Main Alt JavaScript loaded - Cache buster: {{ cache_buster }} - Timestamp: {{ timestamp }}');
        console.log('Testing if our script is working...');
        
        // Force immediate execution to prevent caching issues
        (function() {
            console.log('Immediate execution function called - Script ID: main-alt-script-{{ cache_buster }}-{{ timestamp }}');
            console.log('JavaScript syntax check passed');
        })();
        
        // Set session data for JavaScript access
        try {
            window.sessionData = {
                user: {
                    id: {{ session_data.user.id | default('null') }},
                    first_name: "{{ session_data.user.first_name | default('') }}",
                    last_name: "{{ session_data.user.last_name | default('') }}",
                    email: "{{ session_data.user.email | default('') }}",
                    club: "{{ session_data.user.club | default('') }}",
                    team_name: "{{ session_data.user.team_name | default('') }}",
                    team_id: {{ session_data.user.team_id | default('null') }},
                    series: "{{ session_data.user.series | default('') }}",
                    league_id: {{ session_data.user.league_id | default('null') }},
                    league_name: "{{ session_data.user.league_name | default('') }}",
                    tenniscores_player_id: "{{ session_data.user.tenniscores_player_id | default('') }}"
                }
            };
            console.log('Session data set successfully');
        } catch (error) {
            console.error('Error setting session data:', error);
            window.sessionData = {};
        }
        
        // Add a visible test to make sure our script is running
        window.testStickyNav = function() {
            console.log('Test function called');
            const nav = document.getElementById('main-nav');
            if (nav) {
                nav.style.border = '5px solid red';
                console.log('Navigation element found and styled');
            } else {
                console.log('Navigation element NOT found');
            }
        };
        
        // Test if we can find the navigation element right away
        setTimeout(function() {
            const nav = document.getElementById('main-nav');
            console.log('Navigation element found:', nav);
            if (nav) {
                console.log('Navigation classes:', nav.className);
                console.log('Navigation position:', nav.offsetTop);
            }
        }, 100);
        
        // Initialize all data on page load - OPTIMIZED
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting OPTIMIZED initialization');
            
            // Initialize persistence system
            initPersistence();
            
            // OPTIMIZED: Load data in parallel for better performance
            loadAllDataInParallel();
            
            console.log('About to initialize sticky navigation');
            initStickyNavigation();
            console.log('Sticky navigation initialization complete');
            
            // Check for multiple leagues and show league switcher if needed
            checkMultipleLeagues();
            
            // Check for multiple teams in current league and show league switcher if needed
            checkMultipleClubs();
            
            // Set up PTI visibility observer as fallback (in case PTI data loads later)
            setupPTIVisibilityObserver();
            
            // Test PTI elements existence
            console.log('üîç PTI Elements Test:', {
                ptiCard: !!document.getElementById('pti-card'),
                ptiLoading: !!document.getElementById('pti-loading'),
                ptiContent: !!document.getElementById('pti-content'),
                ptiValue: !!document.getElementById('pti-value')
            });
        });
        
        // OPTIMIZED: Load all data in parallel instead of sequentially
        async function loadAllDataInParallel() {
            console.log('üîÑ Starting parallel data loading...');
            
            try {
                // Load all data simultaneously using Promise.allSettled for better error handling
                console.log('üîç Parallel loading: Starting Promise.allSettled');
                const results = await Promise.allSettled([
                    loadPTIData(),
                    loadUpcomingMatches(),
                    loadPractices(),
                    loadTopPlayers(),
                    loadNotifications(),
                    loadTeamData(),
                    loadSeriesStandings(),
                    loadPickupGames(),
                    loadMyLessons(),
                    loadPaddleTip()
                ]);
                
                console.log('üîç Parallel loading: Promise.allSettled completed');
                console.log('üîç Parallel loading: Results:', results.map((result, index) => ({
                    index,
                    status: result.status,
                    error: result.status === 'rejected' ? result.reason : null
                })));
                
                // Debug PTI loading specifically
                const ptiResult = results[0]; // PTI is first in the array
                console.log('üîç PTI Loading Result:', ptiResult);
                if (ptiResult.status === 'rejected') {
                    console.error('‚ùå PTI Loading Failed:', ptiResult.reason);
                } else {
                    console.log('‚úÖ PTI Loading Completed Successfully');
                }
                
                // Check PTI card visibility
                const ptiCard = document.getElementById('pti-card');
                const ptiContent = document.getElementById('pti-content');
                const ptiLoading = document.getElementById('pti-loading');
                console.log('üîç PTI Card Elements Check:', {
                    ptiCard: !!ptiCard,
                    ptiContent: !!ptiContent,
                    ptiLoading: !!ptiLoading,
                    ptiCardClasses: ptiCard ? ptiCard.className : 'N/A',
                    ptiContentClasses: ptiContent ? ptiContent.className : 'N/A',
                    ptiLoadingClasses: ptiLoading ? ptiLoading.className : 'N/A'
                });
                
                console.log('‚úÖ All data loaded in parallel');
            } catch (error) {
                console.error('‚ùå Error during parallel loading:', error);
            }
        }
        
        // OPTIMIZED: Add simple caching to avoid repeated API calls
        const apiCache = new Map();
        const CACHE_DURATION = 30000; // 30 seconds
        
        function getCachedData(key) {
            const cached = apiCache.get(key);
            if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
                console.log(`üì¶ Using cached data for ${key}`);
                return cached.data;
            }
            return null;
        }
        
        function setCachedData(key, data) {
            apiCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
            console.log(`üíæ Cached data for ${key}`);
        }
        
        // OPTIMIZED: Enhanced fetch with caching
        async function fetchWithCache(url, cacheKey) {
            // Check cache first
            const cachedData = getCachedData(cacheKey);
            if (cachedData) {
                return cachedData;
            }
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                // Cache the data
                setCachedData(cacheKey, data);
                return data;
            } catch (error) {
                console.error(`‚ùå Error fetching ${cacheKey}:`, error);
                throw error;
            }
        }

        // ============================================
        // PERSISTENCE SYSTEM
        // ============================================
        function initPersistence() {
            console.log('Initializing persistence system...');
            
            // Restore persisted data immediately
            restorePersistedData();
            
            // Set up periodic saving
            setInterval(savePersistedData, 30000); // Save every 30 seconds
            
            // Save on page unload
            window.addEventListener('beforeunload', savePersistedData);
            
            console.log('Persistence system initialized');
        }

        function savePersistedData() {
            try {
                const dashboardData = {
                    user: window.sessionData && window.sessionData.user ? {
                        tenniscores_player_id: window.sessionData.user.tenniscores_player_id,
                        team_id: window.sessionData.user.team_id
                    } : null,
                    pti: {
                        value: document.getElementById('pti-value')?.textContent || '--',
                        message: document.getElementById('pti-message')?.textContent || '',
                        timestamp: Date.now()
                    },
                    record: {
                        value: document.getElementById('my-record')?.textContent || '-- - --',
                        className: document.getElementById('my-record')?.className || '',
                        timestamp: Date.now()
                    },
                    winRate: {
                        value: document.getElementById('win-rate')?.textContent || '--%',
                        className: document.getElementById('win-rate')?.className || '',
                        timestamp: Date.now()
                    }
                };
                
                localStorage.setItem('rally_dashboard_data', JSON.stringify(dashboardData));
                console.log('Dashboard data persisted to localStorage');
            } catch (error) {
                console.error('Error saving persisted data:', error);
            }
        }

        function restorePersistedData() {
            try {
                const savedData = localStorage.getItem('rally_dashboard_data');
                if (!savedData) {
                    console.log('No persisted data found');
                    return;
                }
                
                const dashboardData = JSON.parse(savedData);
                const now = Date.now();
                const maxAge = 5 * 60 * 1000; // 5 minutes
                
                // Check if cached data is for the current user
                const currentUser = window.sessionData && window.sessionData.user;
                const cachedUser = dashboardData.user;
                
                if (currentUser && cachedUser && 
                    (currentUser.tenniscores_player_id !== cachedUser.tenniscores_player_id ||
                     currentUser.team_id !== cachedUser.team_id)) {
                    console.log('Cached data is for different user/team, clearing cache');
                    localStorage.removeItem('rally_dashboard_data');
                    return;
                }
                
                // Restore PTI data if recent and valid
                if (dashboardData.pti && (now - dashboardData.pti.timestamp) < maxAge) {
                    const ptiCard = document.getElementById('pti-card');
                    if (ptiCard) {
                        // Only restore if we had valid PTI data (not "--")
                        if (dashboardData.pti.value && dashboardData.pti.value !== '--' && parseFloat(dashboardData.pti.value) > 0) {
                            ptiCard.classList.add('loaded');
                            // Start with 0.0 and prepare for animation when visible
                            document.getElementById('pti-value').textContent = '0.0';
                            document.getElementById('pti-message').textContent = dashboardData.pti.message;
                            document.getElementById('pti-loading').classList.add('hidden');
                            const ptiContent = document.getElementById('pti-content');
                            ptiContent.classList.remove('hidden');
                            ptiContent.style.setProperty('display', 'block', 'important'); // Force display with !important
                            ptiContent.style.setProperty('visibility', 'visible', 'important'); // Force visibility with !important
                            ptiContent.style.setProperty('opacity', '1', 'important'); // Force opacity with !important
                            ptiContent.style.setProperty('height', 'auto', 'important'); // Force height with !important
                            ptiContent.style.setProperty('width', 'auto', 'important'); // Force width with !important
                            // Set up PTI animation to start when card becomes visible
                            pendingPTIAnimation = parseFloat(dashboardData.pti.value);
                            setupPTIVisibilityObserver();
                            console.log('PTI data restored from cache, animation will start when card is visible');
                            
                            // If the card is already visible, start animation immediately
                            console.log('üîç PTI Card Debug (Cached):', {
                                element: ptiCard,
                                classes: ptiCard.className,
                                style: ptiCard.style.display,
                                hidden: ptiCard.classList.contains('hidden'),
                                offsetHeight: ptiCard.offsetHeight,
                                offsetWidth: ptiCard.offsetWidth
                            });
                            
                            const rect = ptiCard.getBoundingClientRect();
                            const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
                            console.log('üîç PTI Card Visibility (Cached):', {
                                rect: rect,
                                isVisible: isVisible,
                                pendingAnimation: pendingPTIAnimation
                            });
                            
                            if (isVisible && pendingPTIAnimation !== null) {
                                console.log('PTI card is already visible, starting animation immediately');
                                animatePTICounter(pendingPTIAnimation);
                                pendingPTIAnimation = null;
                            }
                        } else {
                            // Hide PTI card if cached data was invalid
                            ptiCard.classList.add('hidden');
                        }
                    }
                }
                
                // Restore record data if recent
                if (dashboardData.record && (now - dashboardData.record.timestamp) < maxAge) {
                    const recordCard = document.getElementById('record-card');
                    if (recordCard) {
                        recordCard.classList.add('loaded');
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = dashboardData.record.value;
                        if (dashboardData.record.className) {
                            recordElement.className = dashboardData.record.className;
                        }
                        console.log('Record data restored from cache');
                    }
                }
                
                // Restore win rate data if recent
                if (dashboardData.winRate && (now - dashboardData.winRate.timestamp) < maxAge) {
                    const winrateCard = document.getElementById('winrate-card');
                    if (winrateCard) {
                        winrateCard.classList.add('loaded');
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = dashboardData.winRate.value;
                        if (dashboardData.winRate.className) {
                            winRateElement.className = dashboardData.winRate.className;
                        }
                        console.log('Win rate data restored from cache');
                    }
                }
                
                console.log('Persisted data restored successfully');
            } catch (error) {
                console.error('Error restoring persisted data:', error);
            }
        }
        
        // ============================================
        // PTI ANIMATION & VISIBILITY DETECTION
        // ============================================
        
        // Global variable to store PTI value for animation when card becomes visible
        let pendingPTIAnimation = null;
        let ptiObserver = null; // Track observer to prevent duplicates
        
        // Set up intersection observer for PTI card visibility
        function setupPTIVisibilityObserver() {
            const ptiCard = document.getElementById('pti-card');
            if (!ptiCard || ptiObserver) return; // Don't set up if already exists
            
            ptiObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && pendingPTIAnimation !== null) {
                        console.log('PTI card is now visible, starting animation');
                        animatePTICounter(pendingPTIAnimation);
                        pendingPTIAnimation = null; // Clear pending animation
                        ptiObserver.unobserve(entry.target); // Stop observing once animation starts
                        ptiObserver = null; // Clear observer reference
                    }
                });
            }, {
                threshold: 0.3, // Trigger when 30% of the card is visible
                rootMargin: '0px 0px -50px 0px' // Start animation slightly before fully visible
            });
            
            ptiObserver.observe(ptiCard);
        }
        
        function animatePTICounter(targetPTI) {
            const ptiElement = document.getElementById('pti-value');
            if (!ptiElement) return;
            
            // Start with 0 immediately
            ptiElement.textContent = '0.0';
            
            // Wait 1 second before starting the animation
            setTimeout(() => {
                const duration = 4000; // 4 seconds total (increased from 3)
                const startTime = performance.now();
                const startValue = 0;
                const endValue = targetPTI;
                
                function customEasing(t) {
                    // Calculate what percentage of the final value represents the last 2.0 points
                    const lastTwoPointsRatio = Math.min(2.0 / endValue, 0.4); // Increased cap to 40%
                    const fastPhaseEnd = 1 - lastTwoPointsRatio; // Adjust phase split based on final value
                    
                    if (t <= fastPhaseEnd) {
                        // Fast phase: Quick animation to (100% - last 2 points)
                        const fastProgress = t / fastPhaseEnd;
                        return (1 - lastTwoPointsRatio) * (1 - Math.pow(1 - fastProgress, 2));
                    } else {
                        // Slow phase: Extremely slow animation for the last 2.0 points
                        const slowProgress = (t - fastPhaseEnd) / (1 - fastPhaseEnd);
                        const slowEasing = 1 - Math.pow(1 - slowProgress, 8); // Even slower easing (power of 8)
                        return (1 - lastTwoPointsRatio) + lastTwoPointsRatio * slowEasing;
                    }
                }
                
                function updateCounter(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Apply custom easing function
                    const easedProgress = customEasing(progress);
                    
                    // Calculate current value
                    const currentValue = startValue + (endValue - startValue) * easedProgress;
                    
                    // Update display with one decimal place
                    ptiElement.textContent = currentValue.toFixed(1);
                    
                    // Continue animation if not complete
                    if (progress < 1) {
                        requestAnimationFrame(updateCounter);
                    } else {
                        // Ensure final value is exact
                        ptiElement.textContent = endValue.toFixed(1);
                    }
                }
                
                // Start the animation
                requestAnimationFrame(updateCounter);
            }, 1000); // 1 second delay
        }
        
        // ============================================
        // PTI DATA LOADING
        // ============================================
        async function loadPTIData() {
            console.log('üîç loadPTIData: Starting PTI data loading');
            const loading = document.getElementById('pti-loading');
            const content = document.getElementById('pti-content');
            const ptiCard = document.getElementById('pti-card');
            
            console.log('üîç loadPTIData: Elements found - loading:', !!loading, 'content:', !!content, 'ptiCard:', !!ptiCard);
            console.log('üîç loadPTIData: Loading classes:', loading ? loading.className : 'N/A');
            console.log('üîç loadPTIData: Content classes:', content ? content.className : 'N/A');
            
            try {
                // Use the same API as analyze-me page for consistent PTI data
                console.log('üîç loadPTIData: Making API call to /api/player-analysis');
                const response = await fetch('/api/player-analysis');
                console.log('üîç loadPTIData: API response status:', response.status, 'ok:', response.ok);
                
                loading.classList.add('hidden');
                loading.style.display = 'none'; // Force hide loading
                loading.style.setProperty('display', 'none', 'important');
                console.log('üîç PTI Loading: Hidden loading spinner');
                
                if (!response.ok) {
                    console.log('üîç loadPTIData: PTI API not available (likely CNSWPL player), continuing without PTI data');
                    // For CNSWPL players who don't have PTI, show a message and continue
                    loading.classList.add('hidden');
                    loading.style.display = 'none'; // Force hide loading
                    loading.style.setProperty('display', 'none', 'important');
                    content.classList.remove('hidden');
                    content.style.display = 'block'; // Force display
                    content.style.setProperty('display', 'block', 'important');
                    console.log('üîç PTI Loading: Showing PTI content (N/A case)');
                    
                    // CRITICAL: Remove hidden class from main PTI card container
                    const ptiCardElement = document.getElementById('pti-card');
                    if (ptiCardElement) {
                        ptiCardElement.classList.remove('hidden');
                        ptiCardElement.style.display = 'block';
                        ptiCardElement.style.setProperty('display', 'block', 'important');
                        console.log('üîç PTI Card: Removed hidden class from main container (N/A case)');
                    }
                    
                    document.getElementById('pti-value').textContent = 'N/A';
                    document.getElementById('pti-message').innerHTML = '<div class="text-lg text-white/90 mt-2 font-semibold">PTI not available for CNSWPL</div>';
                    document.getElementById('pti-card').classList.add('loaded');
                    savePersistedData();
                    
                    // Still load Best Partner, Last Match, and Win Streak data even without PTI
                    console.log('üîç Main loading: About to call loadBestPartner()');
                    await loadBestPartner();
                    
                    console.log('üîç Main loading: About to call loadLastMatchData()');
                    await loadLastMatchData();
                    
                    console.log('üîç Main loading: About to call loadWinStreakData()');
                    await loadWinStreakData();
                    
                    console.log('üîç loadPTIData: Successfully completed without PTI data');
                    return;
                }
                
                const data = await response.json();
                console.log('üîç loadPTIData: API response data:', data);
                console.log('üîç loadPTIData: data.error:', data.error, 'data.success:', data.success);
                
                if (data.error || !data.success) {
                    console.log('üîç loadPTIData: PTI data error or no success (likely CNSWPL player), continuing without PTI data');
                    // For CNSWPL players who don't have PTI, show a message and continue
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                    content.style.display = 'block'; // Force display
                    document.getElementById('pti-value').textContent = 'N/A';
                    document.getElementById('pti-message').innerHTML = '<div class="text-lg text-white/90 mt-2 font-semibold">PTI not available for CNSWPL</div>';
                    document.getElementById('pti-card').classList.add('loaded');
                    savePersistedData();
                    
                    // Still load Best Partner, Last Match, and Win Streak data even without PTI
                    console.log('üîç Main loading: About to call loadBestPartner()');
                    await loadBestPartner();
                    
                    console.log('üîç Main loading: About to call loadLastMatchData()');
                    await loadLastMatchData();
                    
                    console.log('üîç Main loading: About to call loadWinStreakData()');
                    await loadWinStreakData();
                    
                    // Load current season stats for CNSWPL players (who don't have PTI)
                    console.log('üîç Loading current season stats for CNSWPL player...');
                    const seasonStatsResponse = await fetch('/api/current-season-stats');
                    console.log('Current season stats response status:', seasonStatsResponse.status);
                    if (seasonStatsResponse.ok) {
                        const seasonStatsData = await seasonStatsResponse.json();
                        console.log('Current season stats data:', seasonStatsData);
                        if (seasonStatsData.success && seasonStatsData.matches > 0) {
                            // Use the actual current season data from analyze-me
                            const wins = seasonStatsData.wins || 0;
                            const losses = seasonStatsData.losses || 0;
                            const winRate = Math.round(seasonStatsData.win_rate || 0);
                            
                            // Apply color coding based on win rate
                            let recordColor = '';
                            let winRateColor = '';
                            
                            if (winRate > 50) {
                                recordColor = 'text-green-500';
                                winRateColor = 'text-green-500';
                            } else if (winRate >= 34 && winRate <= 50) {
                                recordColor = 'text-yellow-500';
                                winRateColor = 'text-yellow-500';
                            } else {
                                recordColor = 'text-red-500';
                                winRateColor = 'text-red-500';
                            }
                            
                            // Set record with color
                            const recordElement = document.getElementById('my-record');
                            recordElement.textContent = `${wins} - ${losses}`;
                            recordElement.className = `text-3xl font-bold ${recordColor}`;
                            
                            // Set win rate with color
                            const winRateElement = document.getElementById('win-rate');
                            winRateElement.textContent = `${winRate}%`;
                            winRateElement.className = `text-3xl font-bold ${winRateColor}`;
                            
                            // Mark cards as loaded and save to persistence
                            document.getElementById('record-card').classList.add('loaded');
                            document.getElementById('winrate-card').classList.add('loaded');
                            savePersistedData();
                        } else {
                            // Fallback if no matches
                            const recordElement = document.getElementById('my-record');
                            recordElement.textContent = '0 - 0';
                            recordElement.className = 'text-3xl font-bold text-red-500';
                            
                            const winRateElement = document.getElementById('win-rate');
                            winRateElement.textContent = '0%';
                            winRateElement.className = 'text-3xl font-bold text-red-500';
                            
                            document.getElementById('record-card').classList.add('loaded');
                            document.getElementById('winrate-card').classList.add('loaded');
                            savePersistedData();
                        }
                    } else {
                        // Fallback if API fails
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = '0 - 0';
                        recordElement.className = 'text-3xl font-bold text-red-500';
                        
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = '0%';
                        winRateElement.className = 'text-3xl font-bold text-red-500';
                        
                        document.getElementById('record-card').classList.add('loaded');
                        document.getElementById('winrate-card').classList.add('loaded');
                        savePersistedData();
                    }
                    
                    console.log('üîç loadPTIData: Successfully completed without PTI data');
                    return;
                }
                
                // Check if user has valid PTI data
                console.log('üîç PTI Debug - Raw API response:', data);
                console.log('üîç PTI Debug - data.current_pti:', data.current_pti, 'type:', typeof data.current_pti);
                const currentPTI = data.current_pti;
                console.log('üîç PTI Debug - currentPTI value:', currentPTI, 'type:', typeof currentPTI);
                console.log('üîç PTI Debug - currentPTI === null || currentPTI === undefined:', currentPTI === null || currentPTI === undefined);
                if (currentPTI === null || currentPTI === undefined) {
                    console.log('üîç loadPTIData: No valid PTI data (likely CNSWPL player), continuing without PTI data');
                    // For CNSWPL players who don't have PTI, show a message and continue
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                    content.style.display = 'block'; // Force display
                    document.getElementById('pti-value').textContent = 'N/A';
                    document.getElementById('pti-message').innerHTML = '<div class="text-lg text-white/90 mt-2 font-semibold">PTI not available for CNSWPL</div>';
                    document.getElementById('pti-card').classList.add('loaded');
                    savePersistedData();
                    
                    // Still load Best Partner, Last Match, and Win Streak data even without PTI
                    console.log('üîç Main loading: About to call loadBestPartner()');
                    await loadBestPartner();
                    
                    console.log('üîç Main loading: About to call loadLastMatchData()');
                    await loadLastMatchData();
                    
                    console.log('üîç Main loading: About to call loadWinStreakData()');
                    await loadWinStreakData();
                    
                    // Load current season stats for CNSWPL players (who don't have PTI)
                    console.log('üîç Loading current season stats for CNSWPL player...');
                    const seasonStatsResponse = await fetch('/api/current-season-stats');
                    console.log('Current season stats response status:', seasonStatsResponse.status);
                    if (seasonStatsResponse.ok) {
                        const seasonStatsData = await seasonStatsResponse.json();
                        console.log('Current season stats data:', seasonStatsData);
                        if (seasonStatsData.success && seasonStatsData.matches > 0) {
                            // Use the actual current season data from analyze-me
                            const wins = seasonStatsData.wins || 0;
                            const losses = seasonStatsData.losses || 0;
                            const winRate = Math.round(seasonStatsData.win_rate || 0);
                            
                            // Apply color coding based on win rate
                            let recordColor = '';
                            let winRateColor = '';
                            
                            if (winRate > 50) {
                                recordColor = 'text-green-500';
                                winRateColor = 'text-green-500';
                            } else if (winRate >= 34 && winRate <= 50) {
                                recordColor = 'text-yellow-500';
                                winRateColor = 'text-yellow-500';
                            } else {
                                recordColor = 'text-red-500';
                                winRateColor = 'text-red-500';
                            }
                            
                            // Set record with color
                            const recordElement = document.getElementById('my-record');
                            recordElement.textContent = `${wins} - ${losses}`;
                            recordElement.className = `text-3xl font-bold ${recordColor}`;
                            
                            // Set win rate with color
                            const winRateElement = document.getElementById('win-rate');
                            winRateElement.textContent = `${winRate}%`;
                            winRateElement.className = `text-3xl font-bold ${winRateColor}`;
                            
                            // Mark cards as loaded and save to persistence
                            document.getElementById('record-card').classList.add('loaded');
                            document.getElementById('winrate-card').classList.add('loaded');
                            savePersistedData();
                        } else {
                            // Fallback if no matches
                            const recordElement = document.getElementById('my-record');
                            recordElement.textContent = '0 - 0';
                            recordElement.className = 'text-3xl font-bold text-red-500';
                            
                            const winRateElement = document.getElementById('win-rate');
                            winRateElement.textContent = '0%';
                            winRateElement.className = 'text-3xl font-bold text-red-500';
                            
                            document.getElementById('record-card').classList.add('loaded');
                            document.getElementById('winrate-card').classList.add('loaded');
                            savePersistedData();
                        }
                    } else {
                        // Fallback if API fails
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = '0 - 0';
                        recordElement.className = 'text-3xl font-bold text-red-500';
                        
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = '0%';
                        winRateElement.className = 'text-3xl font-bold text-red-500';
                        
                        document.getElementById('record-card').classList.add('loaded');
                        document.getElementById('winrate-card').classList.add('loaded');
                        savePersistedData();
                    }
                    
                    console.log('üîç loadPTIData: Successfully completed without PTI data');
                    return;
                }
                
                // Show PTI card if we have valid data
                content.classList.remove('hidden');
                content.style.setProperty('display', 'block', 'important'); // Force display with !important
                content.style.setProperty('visibility', 'visible', 'important'); // Force visibility with !important
                content.style.setProperty('opacity', '1', 'important'); // Force opacity with !important
                content.style.setProperty('height', 'auto', 'important'); // Force height with !important
                content.style.setProperty('width', 'auto', 'important'); // Force width with !important
                console.log('üîç PTI Loading: Showing PTI content (success case)');
                
                // CRITICAL: Remove hidden class from main PTI card container
                const ptiCardElement = document.getElementById('pti-card');
                if (ptiCardElement) {
                    ptiCardElement.classList.remove('hidden');
                    ptiCardElement.style.display = 'block';
                    ptiCardElement.style.setProperty('display', 'block', 'important');
                    console.log('üîç PTI Card: Removed hidden class from main container');
                }
                
                // Debug: Check if hidden class was actually removed
                console.log('üîç PTI Content Debug:', {
                    element: content,
                    classes: content.className,
                    hasHidden: content.classList.contains('hidden'),
                    computedStyle: window.getComputedStyle(content).display,
                    visibility: window.getComputedStyle(content).visibility,
                    opacity: window.getComputedStyle(content).opacity,
                    height: window.getComputedStyle(content).height,
                    width: window.getComputedStyle(content).width,
                    position: window.getComputedStyle(content).position,
                    top: window.getComputedStyle(content).top,
                    left: window.getComputedStyle(content).left
                });
                
                // Set up PTI animation to start when card becomes visible
                pendingPTIAnimation = currentPTI;
                setupPTIVisibilityObserver();
                
                // If the card is already visible, start animation immediately
                const ptiCard = document.getElementById('pti-card');
                if (ptiCard) {
                    console.log('üîç PTI Card Debug:', {
                        element: ptiCard,
                        classes: ptiCard.className,
                        style: ptiCard.style.display,
                        hidden: ptiCard.classList.contains('hidden'),
                        offsetHeight: ptiCard.offsetHeight,
                        offsetWidth: ptiCard.offsetWidth
                    });
                    
                    const rect = ptiCard.getBoundingClientRect();
                    const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
                    console.log('üîç PTI Card Visibility:', {
                        rect: rect,
                        isVisible: isVisible,
                        pendingAnimation: pendingPTIAnimation
                    });
                    
                    if (isVisible && pendingPTIAnimation !== null) {
                        console.log('PTI card is already visible, starting animation immediately');
                        animatePTICounter(pendingPTIAnimation);
                        pendingPTIAnimation = null;
                    }
                } else {
                    console.log('üîç PTI Card Debug: Element not found!');
                }
                
                // Calculate PTI delta since start of season (same logic as analyze-me)
                let deltaDisplay = '';
                if (data.delta_available && data.pti_delta !== null) {
                    const ptiDelta = data.pti_delta;
                    if (ptiDelta > 0) {
                        deltaDisplay = `<div class="text-lg text-white/90 mt-2 font-semibold">+${ptiDelta.toFixed(1)} since start of season</div>`;
                    } else if (ptiDelta < 0) {
                        deltaDisplay = `<div class="text-lg text-white/90 mt-2 font-semibold">${ptiDelta.toFixed(1)} since start of season</div>`;
                    } else {
                        deltaDisplay = `<div class="text-lg text-white/90 mt-2 font-semibold">No change since start of season</div>`;
                    }
                }
                
                // Get current season stats from the same API as analyze-me page
                const seasonStatsResponse = await fetch('/api/current-season-stats');
                console.log('Current season stats response status:', seasonStatsResponse.status);
                if (seasonStatsResponse.ok) {
                    const seasonStatsData = await seasonStatsResponse.json();
                    console.log('Current season stats data:', seasonStatsData);
                    if (seasonStatsData.success && seasonStatsData.matches > 0) {
                        // Use the actual current season data from analyze-me
                        const wins = seasonStatsData.wins || 0;
                        const losses = seasonStatsData.losses || 0;
                        const winRate = Math.round(seasonStatsData.win_rate || 0);
                        
                        // Apply color coding based on win rate
                        let recordColor = '';
                        let winRateColor = '';
                        
                        if (winRate > 50) {
                            recordColor = 'text-green-500';
                            winRateColor = 'text-green-500';
                        } else if (winRate >= 34 && winRate <= 50) {
                            recordColor = 'text-yellow-500';
                            winRateColor = 'text-yellow-500';
                        } else {
                            recordColor = 'text-red-500';
                            winRateColor = 'text-red-500';
                        }
                        
                        // Set record with color
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = `${wins} - ${losses}`;
                        recordElement.className = `text-3xl font-bold ${recordColor}`;
                        
                        // Set win rate with color
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = `${winRate}%`;
                        winRateElement.className = `text-3xl font-bold ${winRateColor}`;
                        
                        // Mark cards as loaded and save to persistence
                        document.getElementById('record-card').classList.add('loaded');
                        document.getElementById('winrate-card').classList.add('loaded');
                        savePersistedData();
                        
                        // Random "no streak" messages
                        const noStreakMessages = [
                            'No streak yet‚Ä¶ but the fuse is lit. üî•',
                            'Win streak? Not yet ‚Äî but you\'re due.',
                            'Still warming up‚Ä¶ streak coming soon.',
                            'No streak yet, but every rally starts somewhere.',
                            'You\'re one win away from bragging rights.',
                            'No streak yet ‚Äî time to flip the script.',
                            'Keep grindin\'‚Ä¶ that streak\'s loading. ‚è≥',
                            'Not streakin\' yet‚Ä¶ but it\'s comin\'.',
                            'Still searching for that hot hand‚Ä¶ stay with it.',
                            'No streak yet ‚Äî gotta start the fire before it burns.',
                            'No win streak yet...keep work\'in at it...you\'ll get there.',
                            'No streak yet‚Ä¶ but hey, Rome wasn\'t built in one set.',
                            'No streak yet ‚Äî maybe your paddle\'s still in warm-up mode.',
                            'No streak? Must be saving it for the playoffs.',
                            'Still streakless. Maybe bribe your partner with bagels next time. ü•Ø',
                            'Technically, not losing is a streak‚Ä¶ right?'
                        ];
                        
                        // Function to get random message
                        const getRandomNoStreakMessage = () => {
                            const randomIndex = Math.floor(Math.random() * noStreakMessages.length);
                            return `<span class="text-lg text-gray-600">${noStreakMessages[randomIndex]}</span>`;
                        };
                        
                        // Calculate win streak from last-3-matches (for streak only)
                        const lastMatchesResponse = await fetch('/api/last-3-matches');
                        if (lastMatchesResponse.ok) {
                            const lastMatchesData = await lastMatchesResponse.json();
                            if (lastMatchesData.matches && lastMatchesData.matches.length > 0) {
                                let currentStreak = 0;
                                const matches = lastMatchesData.matches.reverse();
                                
                                for (const match of matches) {
                                    // Determine if player won by checking if their ID is in the winning team
                                    const userPlayerId = window.sessionData && window.sessionData.user && window.sessionData.user.tenniscores_player_id;
                                    let won = false;
                                    
                                    if (match.Winner === 'home') {
                                        // Home team won - check if player is in home team
                                        won = match['Home Player 1'] === userPlayerId || match['Home Player 2'] === userPlayerId;
                                    } else if (match.Winner === 'away') {
                                        // Away team won - check if player is in away team
                                        won = match['Away Player 1'] === userPlayerId || match['Away Player 2'] === userPlayerId;
                                    }
                                    
                                    if (won) {
                                        currentStreak++;
                                    } else {
                                        break; // Stop counting streak after first loss
                                    }
                                }
                                
                                // Win streak will be loaded separately
                            } else {
                                // Win streak will be loaded separately
                            }
                        } else {
                            document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                        }
                    } else {
                        // No current season data available - this shouldn't happen if player has matches
                        console.log('No current season data available - this indicates a data issue');
                        console.log('Season stats data:', seasonStatsData);
                        
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = '0 - 0';
                        recordElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                        
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = '0%';
                        winRateElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                        
                        document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                        // Mark cards as loaded and save to persistence
                        document.getElementById('record-card').classList.add('loaded');
                        document.getElementById('winrate-card').classList.add('loaded');
                        savePersistedData();
                    }
                } else {
                    // Fallback if current-season-stats fails
                    const recordElement = document.getElementById('my-record');
                    recordElement.textContent = '0 - 0';
                    recordElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                    
                    const winRateElement = document.getElementById('win-rate');
                    winRateElement.textContent = '0%';
                    winRateElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                    
                    document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                    // Mark cards as loaded and save to persistence
                    document.getElementById('record-card').classList.add('loaded');
                    document.getElementById('winrate-card').classList.add('loaded');
                    savePersistedData();
                }
                
                // Display only the delta information (PTI value is already shown in the circle)
                let message = '';
                
                document.getElementById('pti-message').innerHTML = message + deltaDisplay;
                
                // Mark card as loaded and save to persistence
                document.getElementById('pti-card').classList.add('loaded');
                savePersistedData();
                
                // Load best partner data using the same API as analyze-me page
                console.log('üîç Main loading: About to call loadBestPartner()');
                await loadBestPartner();
                
                // Load last match data using the same API as analyze-me page
                console.log('üîç Main loading: About to call loadLastMatchData()');
                await loadLastMatchData();
                
                // Load win streak data
                console.log('üîç Main loading: About to call loadWinStreakData()');
                await loadWinStreakData();
                
                console.log('üîç loadPTIData: Successfully completed PTI data loading');
                
                // Final check of element states
                console.log('üîç PTI Final State Check:', {
                    loadingClasses: loading.className,
                    contentClasses: content.className,
                    loadingStyle: loading.style.display,
                    contentStyle: content.style.display,
                    loadingHidden: loading.classList.contains('hidden'),
                    contentHidden: content.classList.contains('hidden')
                });
                
            } catch (error) {
                console.error('üîç loadPTIData: Error loading PTI data:', error);
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                content.style.display = 'block'; // Force display
                document.getElementById('pti-value').textContent = '--';
                document.getElementById('pti-message').innerHTML = 'Unable to load stats';
                // Mark card as loaded and save to persistence
                document.getElementById('pti-card').classList.add('loaded');
                savePersistedData();
            }
        }
        
        // ============================================
        // UPCOMING MATCHES LOADING
        // ============================================
        async function loadUpcomingMatches() {
            const nextMatchLoading = document.getElementById('next-match-loading');
            const nextMatchContent = document.getElementById('next-match-content');
            const nextMatchEmpty = document.getElementById('next-match-empty');
            const opponentsLoading = document.getElementById('opponents-loading');
            const opponentsContent = document.getElementById('opponents-content');
            const opponentsEmpty = document.getElementById('opponents-empty');
            
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                
                nextMatchLoading.classList.add('hidden');
                opponentsLoading.classList.add('hidden');
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    nextMatchEmpty.classList.remove('hidden');
                    opponentsEmpty.classList.remove('hidden');
                    return;
                }
                
                // Filter for upcoming matches only (not practices)
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Today at midnight
                const upcomingMatches = data.matches
                    .filter(match => {
                        try {
                            const matchDate = new Date(match.date);
                            const matchDateOnly = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate()); // Match date at midnight
                            const isUpcoming = matchDateOnly >= today; // Include today's matches
                            const isNotPractice = match.type === 'match' && match.away_team && match.away_team !== 'Practice';
                            return isUpcoming && isNotPractice;
                        } catch (e) {
                            return false;
                        }
                    });
                
                if (upcomingMatches.length === 0) {
                    nextMatchEmpty.classList.remove('hidden');
                    opponentsEmpty.classList.remove('hidden');
                    return;
                }
                
                // Next Match (first one)
                const nextMatch = upcomingMatches[0];
                nextMatchContent.classList.remove('hidden');
                
                // Debug logging for Scout Competition button
                console.log('üîç Next Match Debug:', {
                    homeTeam: nextMatch.home_team,
                    awayTeam: nextMatch.away_team,
                    homeTeamId: nextMatch.home_team_id,
                    awayTeamId: nextMatch.away_team_id,
                    allFields: Object.keys(nextMatch)
                });
                
                const homeTeam = nextMatch.home_team || '';
                const awayTeam = nextMatch.away_team || '';
                const isHome = homeTeam.includes('{{ session_data.user.club | replace("'", "\\'") }}') || homeTeam.includes('{{ session_data.user.team_name | replace("'", "\\'") }}');
                const opponentName = isHome ? awayTeam : homeTeam;
                
                const matchDate = new Date(nextMatch.date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = nextMatch.time || 'TBD';
                const location = nextMatch.location || 'TBD';
                
                // Construct maps query using club_address field (same pattern as availability page)
                const clubAddress = nextMatch.club_address || '';
                const mapsQuery = clubAddress && location ? `${location}, ${clubAddress}` : (clubAddress || location);
                
                // Get opponent team ID for Scout Competition button
                let scoutCompetitionUrl = '/mobile/teams-players';
                if (opponentName && opponentName !== 'TBD') {
                    // Determine which team ID belongs to the opponent (not the user's team)
                    const userTeamId = {{ session_data.user.team_id | default('null') }};
                    let opponentTeamId = null;
                    
                    // If user is home team, opponent is away team
                    if (isHome) {
                        opponentTeamId = nextMatch.away_team_id;
                    } else {
                        // If user is away team, opponent is home team
                        opponentTeamId = nextMatch.home_team_id;
                    }
                    
                    // Debug logging for Scout Competition URL construction
                    console.log('üîç Scout Competition Debug:', {
                        isHome: isHome,
                        userTeamId: userTeamId,
                        opponentTeamId: opponentTeamId,
                        homeTeamId: nextMatch.home_team_id,
                        awayTeamId: nextMatch.away_team_id,
                        opponentName: opponentName
                    });
                    
                    if (opponentTeamId && opponentTeamId !== userTeamId) {
                        scoutCompetitionUrl = `/mobile/teams-players?team_id=${opponentTeamId}`;
                        console.log('‚úÖ Using team_id URL:', scoutCompetitionUrl);
                    } else {
                        // Fallback: use opponent name for team lookup
                        scoutCompetitionUrl = `/mobile/teams-players?team=${encodeURIComponent(opponentName)}`;
                        console.log('‚ö†Ô∏è Using fallback team name URL:', scoutCompetitionUrl);
                    }
                }
                
                document.getElementById('next-match-details').innerHTML = `
                    <div class="text-5xl font-bold mb-4">vs ${opponentName}</div>
                    <div class="flex items-center gap-6 text-lg flex-wrap">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar"></i>
                            ${dateStr}
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clock"></i>
                            ${timeStr}
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt"></i>
                            ${location}
                        </div>
                    </div>
                    <div class="flex items-center gap-3 mt-3">
                        <a href="https://maps.google.com/?q=${encodeURIComponent(mapsQuery)}" target="_blank" class="text-xs px-5 py-1 bg-white rounded-full font-semibold hover:bg-gray-100 transition text-center" style="color: #045454;">Get Directions</a>
                        <button onclick="showWeatherModal('${mapsQuery}', '${matchDate}')" class="text-xs px-3 py-1 bg-white rounded-full font-semibold hover:bg-gray-100 transition text-center" style="color: #045454;">Check Weather</button>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <a href="${scoutCompetitionUrl}" class="flex items-center gap-2 px-4 py-2 rounded-full transition" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                            <i class="fas fa-search"></i>
                            Scout Competition
                        </a>
                    </div>
                    
                    <!-- My Availability Sub-section -->
                    <div class="mt-6 pt-6 border-t border-white/20">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="fas fa-user-check text-xl"></i>
                            <h4 class="text-xl font-bold">My Availability</h4>
                        </div>
                        <div id="my-availability-loading" class="text-center py-4">
                            <div class="w-8 h-8 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                        </div>
                        <div id="my-availability-content" class="hidden">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                        <div id="my-availability-empty" class="hidden text-center py-4">
                            <i class="fas fa-question-circle text-2xl mb-2 opacity-50"></i>
                            <p class="text-white/80 text-sm">Availability not set</p>
                        </div>
                        <a href="/mobile/availability-calendar" class="block mt-3 text-center py-2 text-white rounded-xl font-semibold transition text-sm" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                            Update Availability ‚Üí
                        </a>
                        <a href="/mobile/availability" class="block mt-2 text-center py-2 text-white rounded-xl font-semibold transition text-sm" style="background-color: rgba(255,255,255,0.1);" onmouseover="this.style.backgroundColor='rgba(255,255,255,0.2)'" onmouseout="this.style.backgroundColor='rgba(255,255,255,0.1)'">
                            View Full Schedule ‚Üí
                        </a>
                    </div>
                `;
                
                // Load availability for the next match
                loadMyAvailabilityForNextMatch(nextMatch);
                
                // Get user's availability for all matches
                const user = window.sessionData && window.sessionData.user;
                let availabilityData = [];
                
                if (user && user.id) {
                    try {
                        const availabilityResponse = await fetch('/api/user-availability');
                        const availabilityResult = await availabilityResponse.json();
                        
                        if (availabilityResult.success && availabilityResult.availability) {
                            availabilityData = availabilityResult.availability;
                        }
                    } catch (e) {
                        console.log('Could not fetch availability data for matches:', e);
                    }
                }
                
                // Next 3 Matches (skip the first one since it's shown in Next Match card)
                const next3 = upcomingMatches.slice(1, 4);
                opponentsContent.classList.remove('hidden');
                opponentsContent.innerHTML = '';
                
                next3.forEach(match => {
                    const matchDiv = createMatchElement(match, availabilityData);
                    opponentsContent.appendChild(matchDiv);
                });
                
            } catch (error) {
                console.error('Error loading matches:', error);
                nextMatchLoading.classList.add('hidden');
                opponentsLoading.classList.add('hidden');
                nextMatchEmpty.classList.remove('hidden');
                opponentsEmpty.classList.remove('hidden');
            }
        }
        
        function createMatchElement(match, availabilityData = []) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-6 p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition';
            
            const homeTeam = match.home_team || '';
            const awayTeam = match.away_team || '';
            const isHome = homeTeam.includes('{{ session_data.user.club | replace("'", "\\'") }}') || homeTeam.includes('{{ session_data.user.team_name | replace("'", "\\'") }}');
            const opponentName = isHome ? awayTeam : homeTeam;
            
            // Use the logo filename directly from the database
            const logoFilename = match.opponent_logo_filename;
            const logoPath = logoFilename ? `/static/images/clubs/${logoFilename}?v=${Date.now()}` : null;
            
            // Debug logging for logo issue
            console.log(`üîç Match Debug - ${opponentName}:`, {
                logoFilename: logoFilename,
                logoPath: logoPath,
                homeTeam: homeTeam,
                awayTeam: awayTeam,
                isHome: isHome,
                opponentName: opponentName
            });
            
            
            const matchDate = new Date(match.date);
            const dateStr = matchDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = match.time || 'TBD';
            const location = match.location || '';
            
            // Get availability status for this match by matching date
            let availabilityStatus = null;
            let statusColor = 'gray';
            let statusText = 'Not Set';
            let statusIcon = 'fas fa-question-circle';
            
            // Find availability for this specific match date
            const matchDateStr = match.date; // Format: YYYY-MM-DD
            const matchingAvailability = availabilityData.find(avail => {
                // Convert both dates to YYYY-MM-DD format for comparison
                const matchDate = new Date(matchDateStr);
                const availDate = new Date(avail.match_date);
                
                // Convert both to YYYY-MM-DD format
                const matchDateFormatted = matchDate.toISOString().split('T')[0];
                const availDateFormatted = availDate.toISOString().split('T')[0];
                
                return availDateFormatted === matchDateFormatted;
            });
            
            if (matchingAvailability) {
                const status = matchingAvailability.availability_status;
                if (status === 1) { // 1 = available
                    availabilityStatus = 'available';
                    statusColor = 'green';
                    statusText = 'Available';
                    statusIcon = 'fas fa-check-circle';
                } else if (status === 2) { // 2 = unavailable
                    availabilityStatus = 'unavailable';
                    statusColor = 'red';
                    statusText = 'Unavailable';
                    statusIcon = 'fas fa-times-circle';
                } else if (status === 3) { // 3 = not_sure
                    availabilityStatus = 'not_sure';
                    statusColor = 'yellow';
                    statusText = 'Not Sure';
                    statusIcon = 'fas fa-question-circle';
                }
            }
            
            div.innerHTML = `
        <div class="w-20 h-18 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
            <img src="${logoPath || '/static/images/clubs/default_club_logo.png'}" 
                 alt="${opponentName} Logo" 
                 class="w-18 h-18 rounded-lg"
                 style="display: block;"
                 id="logo-${Date.now()}-${Math.random().toString(36).substr(2, 9)}"
                 data-opponent="${opponentName}"
                 data-logo-filename="${logoFilename}"
                 onload="console.log('üñºÔ∏è Image loaded for ${opponentName}:', this.src, 'ID:', this.id); this.nextElementSibling.style.display='none';"
                 onerror="console.log('‚ùå Image failed for ${opponentName}:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-18 h-18 bg-gradient-to-br from-rally-green to-rally-green-light text-white flex items-center justify-center font-bold text-xl rounded-lg" style="display: none;">
                ${opponentName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase()}
            </div>
        </div>
                <div class="flex-1 min-w-0">
                    <div class="text-base font-semibold text-[#045454]">vs ${opponentName}</div>
                    <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                    ${location ? `<div class="text-xs text-gray-500">üìç ${location}</div>` : ''}
                </div>
                <div class="flex flex-col items-center justify-center gap-1 w-20">
                    <i class="${statusIcon} text-3xl text-${statusColor}-500"></i>
                    <span class="text-sm font-medium text-${statusColor}-600 text-center leading-tight">${statusText}</span>
                </div>
            `;
            
            return div;
        }
        
        // ============================================
        // MY AVAILABILITY FOR NEXT MATCH
        // ============================================
        async function loadMyAvailabilityForNextMatch(nextMatch) {
            const loading = document.getElementById('my-availability-loading');
            const content = document.getElementById('my-availability-content');
            const empty = document.getElementById('my-availability-empty');
            
            try {
                loading.classList.remove('hidden');
                content.classList.add('hidden');
                empty.classList.add('hidden');
                
                // Get user's availability data
                const user = window.sessionData && window.sessionData.user;
                let availabilityData = [];
                
                if (user && user.id) {
                    try {
                        const availabilityResponse = await fetch('/api/user-availability');
                        const availabilityResult = await availabilityResponse.json();
                        
                        if (availabilityResult.success && availabilityResult.availability) {
                            availabilityData = availabilityResult.availability;
                        }
                    } catch (e) {
                        console.log('Could not fetch availability data:', e);
                    }
                }
                
                // Find availability for the next match
                let availabilityStatus = null;
                let statusColor = 'gray';
                let statusText = 'Not Set';
                let statusIcon = 'fas fa-question-circle';
                let notes = '';
                
                const matchDateStr = nextMatch.date; // Format: YYYY-MM-DD
                const matchingAvailability = availabilityData.find(avail => {
                    // Convert both dates to YYYY-MM-DD format for comparison
                    const matchDate = new Date(matchDateStr);
                    const availDate = new Date(avail.match_date);
                    
                    // Convert both to YYYY-MM-DD format
                    const matchDateFormatted = matchDate.toISOString().split('T')[0];
                    const availDateFormatted = availDate.toISOString().split('T')[0];
                    
                    return availDateFormatted === matchDateFormatted;
                });
                
                if (matchingAvailability) {
                    const status = matchingAvailability.availability_status;
                    notes = matchingAvailability.notes || '';
                    
                    if (status === 1) { // 1 = available
                        availabilityStatus = 'available';
                        statusColor = '#bff863'; // Light green
                        statusText = 'Available';
                        statusIcon = 'fas fa-check-circle';
                    } else if (status === 2) { // 2 = unavailable
                        availabilityStatus = 'unavailable';
                        statusColor = 'red';
                        statusText = 'Unavailable';
                        statusIcon = 'fas fa-times-circle';
                    } else if (status === 3) { // 3 = not_sure
                        availabilityStatus = 'not_sure';
                        statusColor = 'yellow';
                        statusText = 'Not Sure';
                        statusIcon = 'fas fa-question-circle';
                    }
                }
                
                // Format the match date for display
                const matchDate = new Date(nextMatch.date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'long', 
                    day: 'numeric' 
                });
                
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                
                content.innerHTML = `
                    <div class="flex items-center justify-between p-4 rounded-xl" style="background-color: rgba(255,255,255,0.1);">
                        <div class="flex-1">
                            <div class="text-lg font-semibold text-white">${dateStr}</div>
                            <div class="text-sm text-white/80">vs ${nextMatch.away_team}</div>
                            ${notes ? `<div class="text-xs text-white/70 mt-1">üìù ${notes}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-center justify-center gap-1 w-20">
                            <i class="${statusIcon} text-3xl" style="color: ${statusColor};"></i>
                            <span class="text-sm font-medium text-white text-center leading-tight">${statusText}</span>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading my availability:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // PRACTICES LOADING
        // ============================================
        async function loadPractices() {
            const loading = document.getElementById('practices-loading');
            const content = document.getElementById('practices-content');
            const empty = document.getElementById('practices-empty');
            
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                const now = new Date();
                const practices = data.matches
                    .filter(match => {
                        try {
                            const matchDate = new Date(match.date);
                            return matchDate >= now && match.type === 'practice';
                        } catch (e) {
                            return false;
                        }
                    })
                    .slice(0, 3);
                
                if (practices.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                // Get user's availability for all practices
                const user = window.sessionData && window.sessionData.user;
                let availabilityData = [];
                
                if (user && user.id) {
                    try {
                        const availabilityResponse = await fetch('/api/user-availability');
                        const availabilityResult = await availabilityResponse.json();
                        if (availabilityResult.success && availabilityResult.availability) {
                            availabilityData = availabilityResult.availability;
                            console.log('Fetched availability data:', availabilityData);
                        } else {
                            console.log('No availability data found:', availabilityResult);
                        }
                    } catch (e) {
                        console.log('Could not fetch availability data:', e);
                    }
                } else {
                    console.log('No user or user_id found for availability fetch');
                }
                
                practices.forEach((practice, index) => {
                    const practiceDate = new Date(practice.date);
                    const dateStr = practiceDate.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const timeStr = practice.time || 'TBD';
                    const location = practice.location || 'TBD';
                    
                    // Get availability status for this practice by matching date
                    let availabilityStatus = null;
                    let statusColor = 'gray';
                    let statusText = 'Not Set';
                    let statusIcon = 'fas fa-question-circle';
                    
                    // Find availability for this specific practice date
                    const practiceDateStr = practice.date; // Format: YYYY-MM-DD
                    const matchingAvailability = availabilityData.find(avail => {
                        // Convert both dates to YYYY-MM-DD format for comparison
                        const practiceDate = new Date(practiceDateStr);
                        const availDate = new Date(avail.match_date);
                        
                        // Convert both to YYYY-MM-DD format
                        const practiceDateFormatted = practiceDate.toISOString().split('T')[0];
                        const availDateFormatted = availDate.toISOString().split('T')[0];
                        
                        console.log('Date matching:', {
                            practiceDate: practiceDateStr,
                            practiceDateFormatted: practiceDateFormatted,
                            availDate: avail.match_date,
                            availDateFormatted: availDateFormatted,
                            match: availDateFormatted === practiceDateFormatted
                        });
                        
                        return availDateFormatted === practiceDateFormatted;
                    });
                    
                    if (matchingAvailability) {
                        const status = matchingAvailability.availability_status;
                        if (status === 1) { // 1 = available
                            availabilityStatus = 'available';
                            statusColor = 'green';
                            statusText = 'Available';
                            statusIcon = 'fas fa-check-circle';
                        } else if (status === 2) { // 2 = unavailable
                            availabilityStatus = 'unavailable';
                            statusColor = 'red';
                            statusText = 'Unavailable';
                            statusIcon = 'fas fa-times-circle';
                        } else if (status === 3) { // 3 = not_sure
                            availabilityStatus = 'not_sure';
                            statusColor = 'yellow';
                            statusText = 'Not Sure';
                            statusIcon = 'fas fa-question-circle';
                        }
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-6 p-6 bg-gray-50 rounded-xl';
                    div.innerHTML = `
                        <div class="w-18 h-18 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-3xl flex-shrink-0">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-base font-semibold text-[#045454]">${practice.description || 'Practice'}</div>
                            <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                            <div class="text-xs text-gray-500">üìç ${location}</div>
                        </div>
                        <div class="flex flex-col items-center justify-center gap-1 w-20">
                            <i class="${statusIcon} text-3xl text-${statusColor}-500"></i>
                            <span class="text-sm font-medium text-${statusColor}-600 text-center leading-tight">${statusText}</span>
                        </div>
                    `;
                    content.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading practices:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // MY LESSONS LOADING
        // ============================================
        async function loadMyLessons() {
            const loading = document.getElementById('lessons-loading');
            const content = document.getElementById('lessons-content');
            const empty = document.getElementById('lessons-empty');
            
            try {
                const response = await fetch('/api/my-lessons');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (data.error || !data.success || !data.lessons || data.lessons.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                data.lessons.forEach(lesson => {
                    const lessonDate = new Date(lesson.lesson_date);
                    const dateStr = lessonDate.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const timeStr = lesson.lesson_time || 'TBD';
                    const status = lesson.status || 'requested';
                    
                    // Status styling
                    let statusColor = 'gray';
                    let statusText = status.charAt(0).toUpperCase() + status.slice(1);
                    let statusIcon = 'fas fa-clock';
                    
                    if (status === 'confirmed') {
                        statusColor = 'green';
                        statusIcon = 'fas fa-check-circle';
                    } else if (status === 'declined') {
                        statusColor = 'red';
                        statusIcon = 'fas fa-times-circle';
                    } else if (status === 'pending') {
                        statusColor = 'yellow';
                        statusIcon = 'fas fa-hourglass-half';
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-6 p-6 bg-gray-50 rounded-xl';
                    div.innerHTML = `
                        <div class="w-14 h-14 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-2xl flex-shrink-0">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-[#045454]">${lesson.pro_name || 'Pro Lesson'}</div>
                            <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                            ${lesson.focus_areas ? `<div class="text-xs text-gray-500">Focus: ${lesson.focus_areas}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-center gap-1">
                            <i class="${statusIcon} text-2xl text-${statusColor}-500"></i>
                            <span class="text-xs font-medium text-${statusColor}-600">${statusText}</span>
                        </div>
                    `;
                    content.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading lessons:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // TOP PLAYERS LOADING - OPTIMIZED
        // ============================================
        async function loadTopPlayers() {
            const loading = document.getElementById('players-loading');
            const carousel = document.getElementById('players-carousel');
            const empty = document.getElementById('players-empty');
            
            try {
                // OPTIMIZED: Use cached fetch for better performance
                const data = await fetchWithCache('/api/club-standings', 'club-standings');
                
                console.log('üîç loadTopPlayers - API response:', data);
                console.log('üîç loadTopPlayers - player_streaks:', data.player_streaks);
                
                loading.classList.add('hidden');
                
                if (!data.success || !data.player_streaks || data.player_streaks.length === 0) {
                    console.log('üîç loadTopPlayers - No player streaks data, showing empty state');
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Filter players with 3+ wins in a row
                const allHotPlayers = data.player_streaks
                    .filter(player => player.current_streak >= 3)
                    .sort((a, b) => b.current_streak - a.current_streak); // Sort by streak length
                
                if (allHotPlayers.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Helper function to extract series number from series name (e.g., "Series 7" -> 7)
                function getSeriesNumber(seriesName) {
                    const match = seriesName.match(/Series (\d+)/);
                    return match ? parseInt(match[1], 10) : 999; // Default to 999 if no number found
                }
                
                // En fuego: Show all players with the highest win streak
                const highestStreak = allHotPlayers.length > 0 ? allHotPlayers[0].current_streak : 0;
                const enFuegoPlayers = allHotPlayers.filter(player => player.current_streak === highestStreak)
                    .sort((a, b) => getSeriesNumber(a.series_name) - getSeriesNumber(b.series_name)); // Sort by series number (lowest to highest)
                
                // Who's Hot: Show all players with 3+ win streaks EXCEPT those already in En fuego
                const regularHotPlayers = allHotPlayers.filter(player => player.current_streak !== highestStreak)
                    .sort((a, b) => getSeriesNumber(a.series_name) - getSeriesNumber(b.series_name)); // Sort by series number (lowest to highest)
                
                carousel.classList.remove('hidden');
                carousel.innerHTML = '';
                
                // Add "En fuego!" section if there are top performers
                if (enFuegoPlayers.length > 0) {
                    const enFuegoHeader = document.createElement('div');
                    enFuegoHeader.className = 'flex items-center justify-between p-3 bg-orange-500 rounded-lg font-semibold text-sm text-white border-b-2 border-orange-600 mb-2';
                    enFuegoHeader.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-fire text-white text-sm mr-2"></i>
                            <div class="text-orange-100 font-bold text-base">Who's En fuego!</div>
                        </div>
                        <div class="text-right text-orange-100">${highestStreak} Win Streak</div>
                    `;
                    carousel.appendChild(enFuegoHeader);
                    
                    enFuegoPlayers.forEach(player => {
                        const playerDiv = createPlayerElement(player, true); // true for en fuego styling
                        carousel.appendChild(playerDiv);
                    });
                }
                
                // Add regular "Who's Hot" section if there are other players
                if (regularHotPlayers.length > 0) {
                    const regularHeader = document.createElement('div');
                    regularHeader.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg font-semibold text-sm text-gray-700 border-b-2 border-gray-200 mt-6';
                    regularHeader.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-fire text-orange-500 text-xs mr-2"></i>
                            <div>Who's Hot</div>
                        </div>
                        <div class="text-right">Win Streaks</div>
                    `;
                    carousel.appendChild(regularHeader);
                    
                    regularHotPlayers.forEach(player => {
                        const playerDiv = createPlayerElement(player, false); // false for regular styling
                        carousel.appendChild(playerDiv);
                    });
                }
                
                // Helper function to create player elements
                function createPlayerElement(player, isEnFuego) {
                    const fullName = player.player_name || 'Unknown Player';
                    const streak = player.current_streak || 0;
                    const seriesName = player.series_name || 'No Series';
                    
                    // Create magnifying glass link to player detail page with correct URL format
                    const playerDetailLink = player.tenniscores_player_id && player.team_id ? 
                        `/mobile/player-detail/${player.tenniscores_player_id}_team_${player.team_id}` :
                        `/mobile/player-detail/${player.player_id}`;
                    const magnifyingGlassIcon = ` <a href="${playerDetailLink}" class="ml-1" style="color: ${isEnFuego ? '#fff' : '#045454'};" onmouseover="this.style.color='${isEnFuego ? '#f0f0f0' : '#033d3d'}'" onmouseout="this.style.color='${isEnFuego ? '#fff' : '#045454'}'" title="View Player Details"><i class="fas fa-search text-xs"></i></a>`;
                    
                    // Create series chip with different styling for En fuego
                    const seriesChip = seriesName !== 'No Series' ? 
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: ${isEnFuego ? '#fff' : '#045454'}; color: ${isEnFuego ? '#f97316' : '#bff863'};">${seriesName}</span>` : 
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${isEnFuego ? 'bg-orange-200 text-orange-800' : 'bg-gray-100 text-gray-600'}">No Series</span>`;
                    
                    const div = document.createElement('div');
                    div.className = `flex items-center justify-between p-3 rounded-lg transition ${isEnFuego ? 'bg-orange-400 hover:bg-orange-500' : 'bg-gray-50 hover:bg-gray-100'}`;
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <i class="fas fa-fire ${isEnFuego ? 'text-white text-sm' : 'text-orange-500 text-xs'} mr-2"></i>
                                <div class="font-semibold text-sm ${isEnFuego ? 'text-white' : 'text-[#045454]'}">${fullName}</div>
                                ${magnifyingGlassIcon}
                            </div>
                            <div class="flex items-center">
                                ${seriesChip}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold ${isEnFuego ? 'text-white' : 'text-orange-500'}">${streak}</div>
                            <div class="text-xs ${isEnFuego ? 'text-orange-100' : 'text-gray-500'}">Win Streak</div>
                        </div>
                    `;
                    return div;
                }
                
                
                // Load 1st place teams count using same logic as my-club page
                loadFirstPlaceTeams();
                
                // Load rising stars data
                loadRisingStars();
                
            } catch (error) {
                console.error('Error loading top players:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // FIRST PLACE TEAMS LOADING - OPTIMIZED
        // ============================================
        async function loadFirstPlaceTeams() {
            const loading = document.getElementById('first-place-loading');
            const content = document.getElementById('first-place-content');
            const empty = document.getElementById('first-place-empty');
            const tableBody = document.getElementById('first-place-teams-table');
            
            try {
                // OPTIMIZED: Use cached fetch for better performance - force refresh to get latest data
                const data = await fetchWithCache('/api/club-standings', 'club-standings', 0);
                
                console.log('üîç loadFirstPlaceTeams - API response:', data);
                console.log('üîç loadFirstPlaceTeams - tennaqua_standings:', data.tennaqua_standings);
                
                loading.classList.add('hidden');
                
                if (data.success && data.tennaqua_standings && data.tennaqua_standings.length > 0) {
                    // Find all 1st place teams - use same logic as Club Standings section
                    // Teams in 1st place have place = 1 (not tied) or place contains "1/" (tied for first)
                    const firstPlaceTeams = data.tennaqua_standings.filter(team => {
                        const place = String(team.place || '');
                        console.log(`üîç Team ${team.team}: place="${place}", starts with 1/: ${place.startsWith('1/')}`);
                        // Check if place starts with "1/" (first place in series)
                        return place.startsWith('1/');
                    });
                    
                    console.log(`üîç Filtered first place teams: ${firstPlaceTeams.length} teams`);
                    
                    if (firstPlaceTeams.length > 0) {
                        // Sort teams by total points (descending)
                        firstPlaceTeams.sort((a, b) => (b.total_points || 0) - (a.total_points || 0));
                        
                        // Show table with team details
                        content.classList.remove('hidden');
                        tableBody.innerHTML = '';
                        
                        firstPlaceTeams.forEach((team, index) => {
                            const row = document.createElement('tr');
                            row.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100`;
                            
                            // Create magnifying glass link to teams-players page
                            const teamDetailLink = team.team_id ? 
                                `/mobile/teams-players?team_id=${team.team_id}` :
                                `/mobile/teams-players`;
                            const magnifyingGlassIcon = `<a href="${teamDetailLink}" class="ml-1" style="color: #045454;" onmouseover="this.style.color='#033d3d'" onmouseout="this.style.color='#045454'" title="View Team Details"><i class="fas fa-search text-xs"></i></a>`;
                            
                            row.innerHTML = `
                                <td class="py-1 px-2">
                                    <div class="flex items-center">
                                        <div class="font-medium text-xs text-gray-900">${team.team}&nbsp;&nbsp;</div>
                                        ${team.team_id ? magnifyingGlassIcon : ''}
                                    </div>
                                </td>
                                <td class="py-1 px-2 text-center">
                                    <span class="font-medium text-xs text-green-600">${team.place}</span>
                                </td>
                                <td class="py-1 px-2 text-center">
                                    <span class="font-medium text-xs text-gray-900">${team.avg_points}</span>
                                </td>
                                <td class="py-1 px-2 text-center">
                                    <span class="font-medium text-xs text-gray-900">${team.total_points}</span>
                                </td>
                            `;
                            
                            tableBody.appendChild(row);
                        });
                    } else {
                        empty.classList.remove('hidden');
                    }
                } else {
                    empty.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading first place teams:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // PTI MOVERS & SHAKERS LOADING - OPTIMIZED
        // ============================================
        async function loadRisingStars() {
            const moversList = document.getElementById('pti-movers-list');
            const ptiMoversCard = document.querySelector('#pti-movers-list').closest('.bg-white.rounded-2xl');
            
            try {
                // OPTIMIZED: Use cached fetch for better performance
                const data = await fetchWithCache('/api/rising-stars', 'rising-stars');
                
                console.log('üîç loadRisingStars - API response:', data);
                console.log('üîç loadRisingStars - rising_stars:', data.rising_stars);
                
                if (data.success && data.rising_stars && data.rising_stars.length > 0) {
                    // Get top 10 movers by absolute PTI change
                    const topMovers = data.rising_stars
                        .sort((a, b) => Math.abs(b.pti_delta) - Math.abs(a.pti_delta)) // Sort by absolute PTI change
                        .slice(0, 10); // Show top 10
                    
                    if (topMovers.length > 0) {
                        // Check if any of the movers have actual PTI data (not all zeros)
                        const hasValidPTIData = topMovers.some(player => 
                            player.pti_delta !== 0 && player.pti_delta !== null && !isNaN(player.pti_delta)
                        );
                        
                        if (!hasValidPTIData) {
                            // Hide PTI Movers card if no valid PTI delta data
                            if (ptiMoversCard) {
                                ptiMoversCard.classList.add('hidden');
                            }
                            return;
                        }
                        
                        moversList.innerHTML = topMovers.map(player => {
                            // Create magnifying glass link to player detail page with correct URL format
                            const playerDetailLink = player.tenniscores_player_id && player.team_id ? 
                                `/mobile/player-detail/${player.tenniscores_player_id}_team_${player.team_id}` :
                                `/mobile/player-detail/${player.player_id}`;
                            const magnifyingGlassIcon = ` <a href="${playerDetailLink}" class="ml-1" style="color: #045454;" onmouseover="this.style.color='#033d3d'" onmouseout="this.style.color='#045454'" title="View Player Details"><i class="fas fa-search text-xs"></i></a>`;
                            
                            // Create series chip
                            const seriesChip = player.series_name ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: #045454; color: #bff863;">${player.series_name}</span>` : 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">No Series</span>`;
                            
                            // Determine color and label based on positive or negative change
                            const isPositive = player.pti_delta > 0;
                            const deltaClass = isPositive ? 'text-green-600' : 'text-green-600';  // Both positive and negative changes are green
                            const deltaLabel = isPositive ? 'PTI Gain' : 'PTI Drop';
                            const deltaSign = isPositive ? '+' : '';
                            
                            return `
                                <div class="flex items-center p-2 bg-gray-50 rounded-lg">
                                    <div class="flex-1 min-w-0 pr-2">
                                        <div class="flex items-center mb-1">
                                            <div class="font-semibold text-sm text-[#045454] truncate">${player.first_name} ${player.last_name}</div>
                                            ${magnifyingGlassIcon}
                                        </div>
                                        <div class="flex items-center">
                                            ${seriesChip}
                                        </div>
                                    </div>
                                    <div class="flex-1 text-center px-2">
                                        <div class="text-sm font-medium text-gray-700 whitespace-nowrap">${player.starting_pti.toFixed(1)} ‚Üí ${player.current_pti.toFixed(1)}</div>
                                    </div>
                                    <div class="flex-1 text-right pl-2">
                                        <div class="text-sm font-bold ${deltaClass}">${deltaSign}${player.pti_delta.toFixed(1)}</div>
                                        <div class="text-xs text-gray-500">${deltaLabel}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        moversList.innerHTML = '<div class="text-center text-gray-500 py-4">No PTI movers found</div>';
                    }
                } else {
                    // Hide PTI Movers card if no PTI data available
                    if (ptiMoversCard) {
                        ptiMoversCard.classList.add('hidden');
                    }
                }
                
            } catch (error) {
                console.error('Error loading PTI movers:', error);
                // Hide PTI Movers card if error occurs
                if (ptiMoversCard) {
                    ptiMoversCard.classList.add('hidden');
                }
            }
        }
        
        // ============================================
        // NOTIFICATIONS LOADING
        // ============================================
        async function loadNotifications() {
            try {
                const response = await fetch('/api/home/notifications');
                const data = await response.json();
                
                if (data.error || !data.notifications) {
                    return;
                }
                
                const notifications = data.notifications || [];
                
                // Captain's Message
                const captainMessages = notifications.filter(n => n.type === 'captain');
                if (captainMessages.length > 0) {
                    const section = document.getElementById('captain-message-section');
                    const content = document.getElementById('captain-message-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700">${captainMessages[0].message}</p>`;
                }
                
                // Team Polls
                const polls = notifications.filter(n => n.type === 'poll');
                if (polls.length > 0) {
                    const section = document.getElementById('team-polls-section');
                    const activeContent = document.getElementById('active-polls-content');
                    const pastContent = document.getElementById('past-polls-content');
                    section.classList.remove('hidden');
                    
                    // Separate active and past polls based on date
                    const now = new Date();
                    const fiveDaysAgo = new Date(now.getTime() - (5 * 24 * 60 * 60 * 1000)); // 5 days ago
                    
                    console.log('Current time:', now);
                    console.log('Five days ago:', fiveDaysAgo);
                    console.log('All polls:', polls);
                    
                    const activePolls = [];
                    const pastPolls = [];
                    
                    // Process each poll individually
                    polls.forEach(poll => {
                        console.log('Processing poll:', poll);
                        
                        if (poll.created_at) {
                            const createdDate = new Date(poll.created_at);
                            const isActive = createdDate >= fiveDaysAgo;
                            console.log('Poll created at:', poll.created_at, 'Created date:', createdDate, 'Is active (>= fiveDaysAgo)?', isActive);
                            
                            if (isActive) {
                                activePolls.push(poll);
                            } else {
                                pastPolls.push(poll);
                            }
                        } else {
                            console.log('Poll has no created_at, treating as past poll');
                            pastPolls.push(poll); // Treat polls without created_at as past polls
                        }
                    });
                    
                    // Display active polls
                    if (activePolls.length > 0) {
                        activeContent.innerHTML = activePolls.map(poll => `
                            <div class="p-1.5 bg-green-50 border border-green-200 rounded">
                                <div class="flex items-center justify-between">
                                    <div class="text-xs font-medium text-[#045454] truncate flex-1 mr-1">${poll.title}</div>
                                    <span class="text-xs bg-green-100 text-green-700 px-1 py-0.5 rounded text-xs">Active</span>
                                </div>
                                <p class="text-xs text-gray-600 line-clamp-1 mt-0.5">${poll.message}</p>
                            </div>
                        `).join('');
                    } else {
                        activeContent.innerHTML = '<div class="text-center py-1 text-gray-500 text-xs">No active polls</div>';
                    }
                    
                    // Display past polls
                    if (pastPolls.length > 0) {
                        pastContent.innerHTML = pastPolls.map(poll => `
                            <div class="p-1.5 bg-gray-50 border border-gray-200 rounded">
                                <div class="flex items-center justify-between">
                                    <div class="text-xs font-medium text-gray-700 truncate flex-1 mr-1">${poll.title}</div>
                                    <span class="text-xs bg-gray-100 text-gray-600 px-1 py-0.5 rounded text-xs">Closed</span>
                                </div>
                                <p class="text-xs text-gray-600 line-clamp-1 mt-0.5">${poll.message}</p>
                            </div>
                        `).join('');
                    } else {
                        pastContent.innerHTML = '<div class="text-center py-1 text-gray-500 text-xs">No past polls</div>';
                    }
                }
                
                // Food notifications
                const foodNotifs = notifications.filter(n => n.type === 'food');
                if (foodNotifs.length > 0) {
                    const section = document.getElementById('food-section');
                    const content = document.getElementById('food-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700 pl-4">${foodNotifs[0].message}</p>`;
                }
                
                // Beer notifications
                const beerNotifs = notifications.filter(n => n.type === 'beer');
                if (beerNotifs.length > 0) {
                    const section = document.getElementById('beer-section');
                    const content = document.getElementById('beer-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700 pl-4">${beerNotifs[0].message}</p>`;
                }
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        // ============================================
        // TEAM DATA LOADING
        // ============================================
        async function loadTeamData() {
            try {
                // Get team stats from the team stats API (same as my-team page)
                const response = await fetch('/api/team-stats');
                
                if (!response.ok) {
                    console.error('Team stats API error:', response.status, response.statusText);
                    // Show placeholder data
                    document.getElementById('team-points').textContent = '--';
                    document.getElementById('avg-points').textContent = '--';
                    document.getElementById('points-behind').textContent = '--';
                    document.getElementById('team-record').textContent = '-- - --';
                    document.getElementById('team-win-rate').textContent = '--%';
                    return;
                }
                
                const data = await response.json();
                
                if (data.error || !data.success) {
                    console.error('Error loading team stats:', data.error);
                    // Show placeholder data
                    document.getElementById('team-points').textContent = '--';
                    document.getElementById('avg-points').textContent = '--';
                    document.getElementById('points-behind').textContent = '--';
                    document.getElementById('team-record').textContent = '-- - --';
                    document.getElementById('team-win-rate').textContent = '--%';
                    return;
                }
                
                // Use the team stats data (same as my-team page)
                const points = data.points || 0;
                const matchesWon = data.matches_won || 0;
                const matchesLost = data.matches_lost || 0;
                const winRate = data.win_rate || 0;
                
                // Update team points
                document.getElementById('team-points').textContent = points;
                
                // Calculate and update average points per match
                const totalMatches = matchesWon + matchesLost;
                const avgPoints = totalMatches > 0 ? (points / totalMatches).toFixed(1) : '0.0';
                document.getElementById('avg-points').textContent = avgPoints;
                
                // Calculate points behind first place using series standings
                await loadPointsBehindFirst();
                
                // Update team record
                document.getElementById('team-record').textContent = `${matchesWon} - ${matchesLost}`;
                
                // Update win rate
                document.getElementById('team-win-rate').textContent = `${Math.round(winRate)}%`;
                
            } catch (error) {
                console.error('Error loading team data:', error);
                // Show placeholder data on error
                document.getElementById('team-points').textContent = '--';
                document.getElementById('points-behind').textContent = '--';
                document.getElementById('team-record').textContent = '-- - --';
                document.getElementById('team-win-rate').textContent = '--%';
            }
        }
        
        // ============================================
        // POINTS BEHIND FIRST PLACE LOADING
        // ============================================
        async function loadPointsBehindFirst() {
            try {
                // Use the same API as my-series page to get standings data
                const response = await fetch(`/api/series-stats?t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const statsData = await response.json();
                const stats = statsData.teams || statsData;
                
                if (!Array.isArray(stats) || stats.length === 0) {
                    document.getElementById('points-behind').textContent = '--';
                    return;
                }

                // Sort teams by points (highest first) - same logic as my-series page
                stats.sort((a, b) => b.points - a.points);
                
                // Get first place points
                const firstPlacePoints = stats.length > 0 ? stats[0].points : 0;
                
                // Find user's team in the standings
                const user = window.sessionData && window.sessionData.user;
                const userTeam = user ? (user.team || user.club) : null;
                const userTeamId = user ? user.team_id : null;
                
                console.log('Debug - User team info:', { userTeam, userTeamId, teamName: user?.team_name, club: user?.club });
                console.log('Debug - Available teams in stats:', stats.map(t => ({ team: t.team, team_id: t.team_id, points: t.points })));
                
                // Enhanced team matching - try multiple strategies
                let userTeamData = null;
                
                // Strategy 1: Match by team_id if available
                if (userTeamId) {
                    userTeamData = stats.find(team => team.team_id == userTeamId);
                    console.log('Debug - Team ID match result:', userTeamData);
                }
                
                // Strategy 2: Match by team name if team_id didn't work
                if (!userTeamData && userTeam) {
                    userTeamData = stats.find(team => {
                        if (!team.team) return false;
                        const teamName = team.team || '';
                        const clubName = team.club || '';
                        return (
                            teamName.toLowerCase().includes(userTeam.toLowerCase()) ||
                            clubName.toLowerCase().includes(userTeam.toLowerCase()) ||
                            userTeam.toLowerCase().includes(teamName.toLowerCase()) ||
                            userTeam.toLowerCase().includes(clubName.toLowerCase())
                        );
                    });
                    console.log('Debug - Team name match result:', userTeamData);
                }
                
                // Strategy 3: Match by team_name from session if available
                if (!userTeamData && user?.team_name) {
                    userTeamData = stats.find(team => {
                        if (!team.team) return false;
                        const teamName = team.team || '';
                        return teamName.toLowerCase().includes(user.team_name.toLowerCase()) ||
                               user.team_name.toLowerCase().includes(teamName.toLowerCase());
                    });
                    console.log('Debug - Team name from session match result:', userTeamData);
                }
                
                if (userTeamData) {
                    // Calculate points behind first place (same logic as my-series page)
                    const pointsBehind = firstPlacePoints - userTeamData.points;
                    console.log('Debug - Points calculation:', { firstPlacePoints, userPoints: userTeamData.points, pointsBehind });
                    document.getElementById('points-behind').textContent = pointsBehind;
                } else {
                    // If user's team not found in standings, show placeholder
                    console.log('Debug - No team match found, showing --');
                    document.getElementById('points-behind').textContent = '--';
                }
                
            } catch (error) {
                console.error('Error loading points behind first:', error);
                document.getElementById('points-behind').textContent = '--';
            }
        }
        
        // ============================================
        // BEST PARTNER LOADING
        // ============================================
        async function loadBestPartner() {
            console.log('üîç loadBestPartner: Starting to load best partner data');
            try {
                // Use the same API as analyze-me page to get partner analysis
                console.log('üîç loadBestPartner: Fetching /api/current-season-partner-analysis');
                const response = await fetch('/api/current-season-partner-analysis');
                console.log('üîç loadBestPartner: Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üîç loadBestPartner: Response data:', data);
                
                if (data.success && data.partner_analysis && data.partner_analysis.length > 0) {
                    // Filter partners with wins > 0 (same logic as analyze-me page)
                    const qualifiedPartners = data.partner_analysis.filter(partner => partner.wins > 0);
                    
                    console.log('üîç loadBestPartner: Found', data.partner_analysis.length, 'total partners,', qualifiedPartners.length, 'qualified partners');
                    
                    if (qualifiedPartners.length > 0) {
                        // Get the best partner (highest win rate, then most wins)
                        const bestPartner = qualifiedPartners.sort((a, b) => {
                            if (b.winRate !== a.winRate) {
                                return b.winRate - a.winRate;
                            }
                            return b.wins - a.wins;
                        })[0];
                        
                        // Create detailed partner display
                        const partnerContent = document.getElementById('best-partner-content');
                        partnerContent.innerHTML = `
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full font-bold text-white text-sm" 
                                         style="background-color: #045454;">
                                        1
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">${bestPartner.name}</h3>
                                        <p class="text-sm text-gray-600">${bestPartner.record} record</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-bold 
                                        ${bestPartner.winRate >= 60 ? 'text-green-500' : 
                                          bestPartner.winRate >= 45 ? 'text-yellow-500' : 'text-red-500'}">
                                        ${Math.round(bestPartner.winRate)}%
                                    </div>
                                    <p class="text-xs text-gray-500 uppercase">Win Rate</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-gray-900">${bestPartner.matches}</div>
                                        <div class="text-xs text-gray-500">Match${bestPartner.matches !== 1 ? 'es' : ''}</div>
                                    </div>
                                    <div class="w-px h-6 bg-gray-200"></div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-green-600">${bestPartner.wins}</div>
                                        <div class="text-xs text-gray-500">Wins</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-red-600">${bestPartner.losses}</div>
                                        <div class="text-xs text-gray-500">Losses</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-gray-600 font-medium">Courts:</span>
                                    ${bestPartner.courts ? bestPartner.courts.map(court => 
                                        `<span class="inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-white" 
                                               style="background-color: #045454;">
                                            ${court}
                                        </span>`
                                    ).join('') : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('best-partner-content').innerHTML = `
                            <div class="text-center py-4">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm">No qualifying partnerships yet.<br>Need 2+ matches with a partner to see them here!</p>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('best-partner-content').innerHTML = `
                        <div class="text-center py-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                            </div>
                            <p class="text-gray-500 text-sm">No qualifying partnerships yet.<br>Need 2+ matches with a partner to see them here!</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading best partner:', error);
                document.getElementById('best-partner-content').innerHTML = `
                    <div class="text-center py-4">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                        </div>
                        <p class="text-gray-500 text-sm">No qualifying partnerships yet.<br>Need 2+ matches with a partner to see them here!</p>
                    </div>
                `;
            }
        }
        
        // ============================================
        // SERIES STANDINGS LOADING
        // ============================================
        async function loadSeriesStandings() {
            const loading = document.getElementById('series-loading');
            const content = document.getElementById('series-content');
            const table = document.getElementById('seriesTable');
            
            try {
                // Use the same API as my-series page
                const response = await fetch(`/api/series-stats?t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const statsData = await response.json();
                const stats = statsData.teams || statsData;
                
                loading.classList.add('hidden');
                
                if (!Array.isArray(stats) || stats.length === 0) {
                    table.innerHTML = '<div class="text-center text-gray-500 p-8"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-chart-bar text-gray-400 text-2xl"></i></div><h3 class="text-lg font-semibold text-[#045454] mb-2">No Series Data</h3><p class="text-gray-500">Series statistics will appear here once matches are played.</p></div>';
                    content.classList.remove('hidden');
                    return;
                }

                // Sort teams by points (same as my-series)
                stats.sort((a, b) => b.points - a.points);

                // Get user's team for highlighting
                const user = window.sessionData && window.sessionData.user;
                const userTeam = user ? (user.team || user.club) : null;
                const playoffCutoff = 8;
                const firstPlacePoints = stats.length > 0 ? stats[0].points : 0;
                
                // Check if any team has PTI data to conditionally show Avg PTI column
                const hasPtiData = stats.some(team => team.avg_pti && team.avg_pti !== 'N/A' && team.avg_pti !== null);
                
                let html = `<thead><tr>
                  <th class="text-left py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Team</th>
                  <th class="text-center py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Scout</th>
                  <th class="text-right py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Record</th>
                  <th class="text-right py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Pts</th>
                  <th class="text-right py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Avg Pts</th>
                  <th class="text-right py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Pts Back</th>`;
                if (hasPtiData) {
                  html += `<th class="text-right py-4 px-6 font-semibold text-gray-700 whitespace-nowrap">Avg PTI</th>`;
                }
                html += `</tr></thead><tbody>`;
                
                stats.forEach((team, idx) => {
                    // More robust team matching - check both team name and club name
                    const teamName = team.team || '';
                    const clubName = team.club || '';
                    const isUserTeam = userTeam && (
                        teamName.toLowerCase().includes(userTeam.toLowerCase()) ||
                        clubName.toLowerCase().includes(userTeam.toLowerCase()) ||
                        userTeam.toLowerCase().includes(teamName.toLowerCase()) ||
                        userTeam.toLowerCase().includes(clubName.toLowerCase())
                    );
                    let playoffIcon = '';
                    const isPlayoffTeam = idx < playoffCutoff;
                    let rowClass = 'border-b border-gray-50';
                    
                    if (isUserTeam) {
                        rowClass += ' bg-green-50 border-l-4 border-green-400 font-semibold';
                    } else if (isPlayoffTeam) {
                        rowClass += ' bg-white border-l-4 border-green-500';
                        playoffIcon = '<span title="Playoff Contender" class="mr-1 text-green-600"><i class="fas fa-trophy"></i></span>';
                    } else if (idx % 2 === 0) {
                        rowClass += ' bg-white';
                    } else {
                        rowClass += ' bg-gray-50';
                    }
                    
                    const totalMatches = team.matches.won + team.matches.lost + (team.matches.tied || 0);
                    const avgPoints = totalMatches > 0 ? (team.points / totalMatches).toFixed(1) : '0.0';
                    
                    // Create team link
                    const teamId = team.team_id || team.id || '';
                    const teamDisplayName = team.team;
                    
                    // Always show magnifying glass for all teams
                    let teamNameHtml;
                    let magnifyingGlassHtml;
                    if (teamId) {
                        // If we have a team_id, make both team name and magnifying glass clickable
                        teamNameHtml = `<a href="/mobile/teams-players?team_id=${teamId}" class="hover:text-blue-600 hover:underline">${teamDisplayName}</a>`;
                        magnifyingGlassHtml = `<a href="/mobile/teams-players?team_id=${teamId}" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" style="background-color: #045454; color: #bff863;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'" title="View Team Details"><i class="fas fa-search mr-1"></i>Scout</a>`;
                    } else {
                        // If no team_id, show team name as text but still show magnifying glass (could link to search or club page)
                        teamNameHtml = `${teamDisplayName}`;
                        magnifyingGlassHtml = `<a href="/mobile/teams-players" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" style="background-color: #045454; color: #bff863;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'" title="View Teams"><i class="fas fa-search mr-1"></i>Scout</a>`;
                    }
                    
                    html += `<tr class="${rowClass}">
                      <td class="py-4 px-6 font-medium ${isUserTeam ? 'text-green-800' : 'text-[#045454]'}">
                        <div class="whitespace-nowrap">${playoffIcon}${teamNameHtml}</div>
                      </td>
                      <td class="py-4 px-6 text-center">
                        ${magnifyingGlassHtml}
                      </td>
                        <td class="py-4 px-6 text-right ${isUserTeam ? 'text-green-700' : 'text-gray-700'} whitespace-nowrap">${team.matches.won}-${team.matches.lost}</td>
                        <td class="py-4 px-6 text-right font-semibold ${isUserTeam ? 'text-green-800' : 'text-[#045454]'} whitespace-nowrap">${team.points}</td>
                        <td class="py-4 px-6 text-right ${isUserTeam ? 'text-green-700' : 'text-gray-700'} whitespace-nowrap">${avgPoints}</td>
                        <td class="py-4 px-6 text-right ${isUserTeam ? 'text-green-600' : 'text-gray-600'} whitespace-nowrap">${firstPlacePoints - team.points}</td>`;
                    
                    // Add Avg PTI column last (if PTI data exists)
                    if (hasPtiData) {
                        const avgPti = team.avg_pti && team.avg_pti !== 'N/A' ? team.avg_pti : 'N/A';
                        html += `<td class="py-4 px-6 text-right font-semibold ${isUserTeam ? 'text-green-800' : 'text-[#045454]'} whitespace-nowrap">${avgPti}</td>`;
                    }
                    
                    html += `</tr>`;
                });
                html += '</tbody>';
                table.innerHTML = html;
                content.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading series standings:', error);
                loading.classList.add('hidden');
                table.innerHTML = '<div class="text-center text-gray-500 p-8"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i></div><h3 class="text-lg font-semibold text-[#045454] mb-2">Error Loading Standings</h3><p class="text-gray-500">Unable to load series standings data.</p></div>';
                content.classList.remove('hidden');
            }
        }
        
        
        // ============================================
        // CLUB STANDINGS LOADING
        // ============================================
        async function loadClubStandings() {
            try {
                const response = await fetch('/api/club-standings');
                const data = await response.json();
                
                if (data.success && data.tennaqua_standings) {
                    const standings = data.tennaqua_standings;
                    
                    // Find teams in 1st place
                    const firstPlaceTeams = standings.filter(team => {
                        const place = String(team.place || '');
                        return place.includes('1/') || place.startsWith('1/');
                    });
                    
                    // Update the 1st place teams display
                    const firstPlaceElement = document.getElementById('first-place-teams');
                    if (firstPlaceTeams.length > 0) {
                        firstPlaceElement.innerHTML = firstPlaceTeams.map(team => `
                            <div class="text-sm font-semibold text-[#045454] mb-1">
                                ${team.team} - ${team.place}
                            </div>
                        `).join('');
                    } else {
                        firstPlaceElement.textContent = '0';
                    }
                }
                
            } catch (error) {
                console.error('Error loading club standings:', error);
                // Keep the default "--" display on error
            }
        }

        // ============================================
        // WIN STREAK LOADING
        // ============================================
        async function loadWinStreakData() {
            console.log('üîç loadWinStreakData: Starting to load win streak data');
            
            try {
                // Define random messages for no streak
                const noStreakMessages = [
                    'No streak yet. Time to start one! üéæ',
                    'Every champion started with zero wins.',
                    'Still streakless. Maybe bribe your partner with bagels next time. ü•Ø',
                    'Technically, not losing is a streak‚Ä¶ right?'
                ];
                
                // Function to get random message
                const getRandomNoStreakMessage = () => {
                    const randomIndex = Math.floor(Math.random() * noStreakMessages.length);
                    return `<span class="text-lg text-gray-600 leading-tight">${noStreakMessages[randomIndex]}</span>`;
                };
                
                // Use the new robust win streak API endpoint
                console.log('üîç loadWinStreakData: Fetching /api/user-win-streak');
                const response = await fetch('/api/user-win-streak');
                console.log('üîç loadWinStreakData: Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üîç loadWinStreakData: Response data:', data);
                    
                    const currentStreak = data.current_streak || 0;
                    const lastMatchDate = data.last_match_date;
                    
                    console.log('üîç Win Streak Debug - Current streak:', currentStreak);
                    console.log('üîç Win Streak Debug - Last match date:', lastMatchDate);
                    
                    // Update the win streak display with personalized message
                    if (currentStreak > 0) {
                        const firstName = window.sessionData && window.sessionData.user && window.sessionData.user.first_name;
                        const displayName = firstName || 'Champion';
                        document.getElementById('win-streak').innerHTML = `<span style="font-size: 14px;">üî• You are on a ${currentStreak} match win streak. Way to go ${displayName}!</span>`;
                    } else {
                        document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                    }
                } else {
                    console.log('üîç loadWinStreakData: API call failed');
                    document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                }
            } catch (error) {
                console.error('üîç loadWinStreakData: Error loading win streak data:', error);
                document.getElementById('win-streak').innerHTML = '<span class="text-lg text-gray-600">Error loading streak</span>';
            }
        }

        // ============================================
        // LAST MATCH LOADING
        // ============================================
        async function loadLastMatchData() {
            console.log('üîç loadLastMatchData: Starting to load last match data');
            const loading = document.getElementById('last-match-loading');
            const content = document.getElementById('last-match-content');
            const empty = document.getElementById('last-match-empty');
            
            // Check if elements exist
            if (!loading || !content || !empty) {
                console.error('Last match HTML elements not found');
                return;
            }
            
            try {
                // Use the same API as analyze-me page
                console.log('üîç loadLastMatchData: Fetching /api/last-3-matches');
                const response = await fetch('/api/last-3-matches');
                console.log('üîç loadLastMatchData: Response status:', response.status);
                
                if (response.status === 404) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                const data = await response.json();
                console.log('üîç loadLastMatchData: Response data:', data);
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Get the most recent match (first in the array)
                const lastMatch = data.matches[0];
                
                // Parse match data using same field names as analyze-me page
                const matchDate = new Date(lastMatch.date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const timeStr = 'TBD'; // Time not available in this API
                
                // Parse scores to determine winner (same logic as analyze-me page)
                const scores = lastMatch.scores ? lastMatch.scores.split(", ") : [];
                const team1_sets = [];  // First team in database (away team)
                const team2_sets = [];  // Second team in database (home team)
                let team1_sets_won = 0;
                let team2_sets_won = 0;
                
                scores.forEach(set_score => {
                    if (set_score && set_score.includes("-")) {
                        const [score1, score2] = set_score.split("-");
                        team1_sets.push(score1);
                        team2_sets.push(score2);
                        
                        if (parseInt(score2) > parseInt(score1)) {
                            team2_sets_won++;
                        } else {
                            team1_sets_won++;
                        }
                    }
                });
                
                // Determine which team won based on sets won
                const team1_won = team1_sets_won > team2_sets_won;
                
                // Determine which team the current player is on
                const current_player_on_team1 = lastMatch.player_was_home === false; // If player was away, they're on team1
                
                // Assign sets to current team and opponent team (EXACT same logic as analyze-me page)
                let current_team_sets, opponent_team_sets, current_team_won;
                if (current_player_on_team1) {
                    // Current player is on team1 (away team in database)
                    current_team_sets = team1_sets;
                    opponent_team_sets = team2_sets;
                    current_team_won = team1_won;
                } else {
                    // Current player is on team2 (home team in database)
                    current_team_sets = team2_sets;
                    opponent_team_sets = team1_sets;
                    current_team_won = team2_sets_won > team1_sets_won;
                }
                
                // Get opponent team name
                const opponentTeam = current_player_on_team1 ? lastMatch.home_team : lastMatch.away_team;
                
                // Format score
                const scoreStr = scores.length > 0 ? scores.join(', ') : '--';
                
                // Use current_team_won for winner determination (same as analyze-me page)
                const won = current_team_won;
                
                // Update the last match display using analyze-me modal format
                content.innerHTML = `
                    <div class="border border-gray-200 rounded-lg overflow-hidden w-full">
                        <!-- Match Header -->
                        <div class="px-3 py-2" style="background-color: #045454;">
                            <span class="text-sm font-bold" style="color: #bff863;">${dateStr}</span>
                        </div>
                        
                        <!-- Team Matchup -->
                        <div class="px-3 py-2" style="background-color: #045454;">
                            <span class="text-base font-semibold" style="color: #bff863;">
                                ${lastMatch.home_team || 'Your Team'} vs.<br>
                                ${lastMatch.away_team || opponentTeam || 'Opponent Team'}
                            </span>
                        </div>
                        
                        <!-- Court Header -->
                        <div class="px-3 py-2" style="background-color: #045454;">
                            <span class="text-sm font-bold" style="color: #bff863;">${lastMatch.court_number || 'Court 1'}</span>
                        </div>
                        
                        <!-- Match Table -->
                        <table class="w-full border-collapse">
                            <tbody>
                                <!-- Your Team Row -->
                                <tr class="${won ? 'bg-green-100' : 'bg-gray-50'}">
                                    <td class="w-40 px-3 py-4 text-left">
                                        <div class="text-xs text-gray-500 mb-3">${current_player_on_team1 ? lastMatch.away_team : lastMatch.home_team}</div>
                                        <div class="text-sm font-medium text-black">
                                            <div class="mb-1">${lastMatch.partner_name || 'Partner'}</div>
                                            <div>${lastMatch.player_name || 'You'}</div>
                                        </div>
                                    </td>
                                    <td class="w-12 px-2 py-3 text-center">
                                        ${won ? '<i class="fas fa-trophy text-yellow-500 text-sm"></i>' : ''}
                                    </td>
                                    <td class="w-12 px-2 py-3 text-center"><span class="text-sm font-medium text-gray-700">${current_team_sets[0] || ''}</span></td>
                                    <td class="w-12 px-2 py-3 text-center"><span class="text-sm font-medium text-gray-700">${current_team_sets[1] || ''}</span></td>
                                    <td class="w-12 px-2 py-3 text-center"><span class="text-sm font-medium text-gray-700">${current_team_sets[2] || ''}</span></td>
                                </tr>
                                <!-- Opponent Team Row -->
                                <tr class="${won ? 'bg-white' : 'bg-green-100'}">
                                    <td class="w-40 px-3 py-4 text-left">
                                        <div class="text-xs text-gray-500 mb-3">${current_player_on_team1 ? lastMatch.home_team : lastMatch.away_team}</div>
                                        <div class="text-sm font-medium text-black">
                                            <div class="mb-1">${lastMatch.opponent1_name || 'Opponent 1'}</div>
                                            <div>${lastMatch.opponent2_name || 'Opponent 2'}</div>
                                        </div>
                                    </td>
                                    <td class="w-12 px-2 py-3 text-center">
                                        ${!won ? '<i class="fas fa-trophy text-yellow-500 text-sm"></i>' : ''}
                                    </td>
                                    <td class="w-12 px-2 py-3 text-center"><span class="text-sm font-medium text-gray-700">${opponent_team_sets[0] || ''}</span></td>
                                    <td class="w-12 px-2 py-3 text-center"><span class="text-sm font-medium text-gray-700">${opponent_team_sets[1] || ''}</span></td>
                                    <td class="w-12 px-2 py-3 text-center"><span class="text-sm font-medium text-gray-700">${opponent_team_sets[2] || ''}</span></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <!-- View More Matches Button -->
                        <div class="px-3 py-3 bg-gray-50 border-t border-gray-200">
                            <button onclick="viewMoreMatches()" class="w-full bg-[#045454] text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-[#033d3d] transition-colors">
                                <i class="fas fa-eye mr-2"></i>View more matches ‚Üí
                            </button>
                        </div>
                    </div>
                `;
                
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                empty.classList.add('hidden');
                
            } catch (error) {
                console.error('Error loading last match data:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        // ============================================
        // VIEW MORE MATCHES FUNCTION
        // ============================================
        function viewMoreMatches() {
            // Navigate to analyze-me page with hash for auto-scroll
            window.location.href = '/mobile/analyze-me#last-3-matches';
        }

        // ============================================
        // VIEW ALL CLUB TEAMS FUNCTION
        // ============================================
        function viewAllClubTeams() {
            // Navigate to my-club page
            window.location.href = '/mobile/my-club';
        }

        // ============================================
        // PICKUP GAMES LOADING
        // ============================================
        async function loadPickupGames() {
            const loading = document.getElementById('pickup-loading');
            const content = document.getElementById('pickup-content');
            const empty = document.getElementById('pickup-empty');
            
            try {
                const response = await fetch('/api/pickup-games?type=public');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                loading.classList.add('hidden');
                
                if (data.error || !data.upcoming_games || data.upcoming_games.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Show only the next 3 upcoming games
                const upcomingGames = data.upcoming_games.slice(0, 3);
                
                if (upcomingGames.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                upcomingGames.forEach(game => {
                    const gameDiv = createPickupGameElement(game);
                    content.appendChild(gameDiv);
                });
                
            } catch (error) {
                console.error('Error loading pickup games:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function createPickupGameElement(game) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-6 p-6 bg-gray-50 rounded-xl hover:bg-gray-100 transition';
            
            // Use the formatted_date and formatted_time from the API response
            const dateStr = game.formatted_date || 'Invalid Date';
            const timeStr = game.formatted_time || 'TBD';
            const description = game.description || 'Pickup Game';
            const participants = game.players_committed || 0;
            const requested = game.players_requested || 4;
            
            div.innerHTML = `
                <div class="w-14 h-14 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-2xl flex-shrink-0">
                    <i class="fas fa-users"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-[#045454]">${description}</div>
                    <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                    <div class="text-xs text-gray-500">${participants}/${requested} players</div>
                </div>
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold">
                        ${participants}
                    </div>
                    <span class="text-xs text-gray-500">joined</span>
                </div>
            `;
            
            return div;
        }

        // ============================================
        // PADDLE TIP LOADING
        // ============================================
        async function loadPaddleTip() {
            const loading = document.getElementById('paddle-tip-loading');
            const content = document.getElementById('paddle-tip-content');
            const empty = document.getElementById('paddle-tip-empty');
            
            try {
                const response = await fetch('/api/paddle-tips');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                loading.classList.add('hidden');
                
                if (data.error || !data.paddle_tips || data.paddle_tips.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Get a random paddle tip
                const paddleTips = data.paddle_tips;
                const randomIndex = Math.floor(Math.random() * paddleTips.length);
                const tip = paddleTips[randomIndex];
                
                // Display the tip
                content.classList.remove('hidden');
                
                // Format the description (truncate if too long for mobile)
                let description = tip.description || '';
                if (description.length > 200) {
                    description = description.substring(0, 200) + '...';
                }
                
                // Format description with basic HTML support
                const formattedDescription = formatTipDescription(description);
                
                content.innerHTML = `
                    <div class="mb-2">
                        <span class="text-sm text-white/70">Tip #${tip.number || '?'}</span>
                        <span class="text-sm text-white/70 ml-2">‚Ä¢</span>
                        <span class="text-sm text-white/70 ml-2">${tip.date || ''}</span>
                    </div>
                    <h4 class="text-xl font-semibold mb-3">${tip.name || 'Paddle Tip'}</h4>
                    <div class="text-white/90 leading-relaxed">${formattedDescription}</div>
                `;
                
            } catch (error) {
                console.error('Error loading paddle tip:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function formatTipDescription(description) {
            // Basic HTML formatting for paddle tips
            return description
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic text
                .replace(/\n\n/g, '</p><p>') // Paragraph breaks
                .replace(/\n/g, '<br>') // Line breaks
                .replace(/^(.*)$/, '<p>$1</p>'); // Wrap in paragraph
        }

        // ============================================
        // STICKY NAVIGATION
        // ============================================
        function initStickyNavigation() {
            console.log('initStickyNavigation function called');
            const navContainer = document.getElementById('sticky-nav-container');
            const nav = document.getElementById('main-nav');
            const placeholder = document.getElementById('sticky-nav-placeholder');
            console.log('Navigation container:', navContainer);
            console.log('Navigation element:', nav);
            console.log('Placeholder element:', placeholder);
            
            if (!nav || !navContainer) {
                console.error('Navigation elements not found');
                return;
            }
            
            const navButtons = nav.querySelectorAll('.nav-button');
            console.log('Found nav buttons:', navButtons.length);
            console.log('Nav buttons:', navButtons);
            
            // Debug: Check if buttons have href attributes
            navButtons.forEach((btn, index) => {
                console.log(`Button ${index + 1}:`, btn.textContent, 'href:', btn.getAttribute('href'));
            });
            
            // Get the initial position of the navigation
            const navOffsetTop = navContainer.offsetTop;
            console.log('Navigation offset top:', navOffsetTop);
            
            let isFixed = false;
            
            function handleScroll() {
                console.log('üìú HANDLE SCROLL FUNCTION CALLED');
                const scrollTop = document.body.scrollTop || document.documentElement.scrollTop || window.pageYOffset;
                console.log('üìú Scroll position:', scrollTop, 'Nav offset:', navOffsetTop, 'Threshold:', navOffsetTop - 51);
                
                // Check if we've scrolled past the navigation's initial position
                if (scrollTop > navOffsetTop - 51) { // Account for header height
                    console.log('üìú Should be fixed - scroll past threshold');
                    if (!isFixed) {
                        console.log('üìå Making navigation fixed');
                        navContainer.classList.add('fixed');
                        // Show placeholder to prevent layout shift
                        if (placeholder) {
                            placeholder.classList.add('active');
                        }
                        isFixed = true;
                    }
                    
                    if (!nav.classList.contains('scrolled')) {
                        console.log('üìå Adding scrolled class');
                        nav.classList.add('scrolled');
                        navButtons.forEach(button => {
                            button.classList.add('scrolled');
                        });
                    }
                } else {
                    console.log('üìú Should NOT be fixed - scroll before threshold');
                    if (isFixed) {
                        console.log('üìå Removing fixed positioning');
                        navContainer.classList.remove('fixed');
                        // Hide placeholder
                        if (placeholder) {
                            placeholder.classList.remove('active');
                        }
                        isFixed = false;
                    }
                    
                    if (nav.classList.contains('scrolled')) {
                        console.log('üìå Removing scrolled class');
                        nav.classList.remove('scrolled');
                        navButtons.forEach(button => {
                            button.classList.remove('scrolled');
                        });
                    }
                }
                
                // Determine which section is currently in view and set active state
                updateActiveNavigation(scrollTop);
            }
            
            function updateActiveNavigation(scrollTop) {
                // Define sections and their scroll positions
                const sections = [
                    { id: 'schedule', element: document.querySelector('#schedule') },
                    { id: 'dashboard', element: document.querySelector('#dashboard') },
                    { id: 'team', element: document.querySelector('#team') },
                    { id: 'club', element: document.querySelector('#club') },
                    { id: 'play', element: document.querySelector('#play') },
                    { id: 'improve', element: document.querySelector('#improve') }
                ];
                
                // Remove active class from all buttons
                navButtons.forEach(button => button.classList.remove('active'));
                
                // Find the section that's currently in view
                let activeSection = null;
                const offset = -35; // Same offset as autoscroll + 10px higher (reduced by another 100px)
                
                for (let i = sections.length - 1; i >= 0; i--) {
                    const section = sections[i];
                    if (section.element) {
                        const sectionTop = section.element.offsetTop - offset;
                        if (scrollTop >= sectionTop) {
                            activeSection = section.id;
                            break;
                        }
                    }
                }
                
                // Set active state for the current section
                if (activeSection) {
                    const activeButton = document.querySelector(`a[href="#${activeSection}"]`);
                    if (activeButton) {
                        activeButton.classList.add('active');
                        console.log(`Setting active state for: ${activeSection}`);
                    }
                }
            }
            
            // Throttle scroll events for better performance
            let ticking = false;
            function requestTick() {
                console.log('üìú REQUEST TICK CALLED, ticking:', ticking);
                if (!ticking) {
                    console.log('üìú Calling requestAnimationFrame');
                    requestAnimationFrame(handleScroll);
                    ticking = true;
                    setTimeout(() => { 
                        console.log('üìú Resetting ticking to false');
                        ticking = false; 
                    }, 16); // ~60fps
                } else {
                    console.log('üìú Skipping - already ticking');
                }
            }
            
            // Add scroll event listener
            console.log('Adding scroll event listener');
            
            // Test scroll events first - try multiple approaches
            window.addEventListener('scroll', function() {
                console.log('üìú WINDOW SCROLL EVENT DETECTED!');
            }, { passive: true });
            
            document.addEventListener('scroll', function() {
                console.log('üìú DOCUMENT SCROLL EVENT DETECTED!');
            }, { passive: true });
            
            document.body.addEventListener('scroll', function() {
                console.log('üìú BODY SCROLL EVENT DETECTED!');
            }, { passive: true });
            
            // Use document.body scroll for the main handler - try both throttled and direct
            document.body.addEventListener('scroll', requestTick, { passive: true });
            
            // Also try a direct handler without throttling
            document.body.addEventListener('scroll', function() {
                console.log('üìú DIRECT SCROLL HANDLER CALLED');
                handleScroll();
            }, { passive: true });
            
            console.log('Scroll event listener added');
            
            // Handle smooth scrolling for anchor links
            console.log('üîó Setting up click handlers for', navButtons.length, 'navigation buttons');
            navButtons.forEach((button, index) => {
                console.log(`üîó Setting up handler for button ${index + 1}:`, button.textContent, 'href:', button.getAttribute('href'));
                button.addEventListener('click', function(e) {
                    console.log('üñ±Ô∏è NAV BUTTON CLICKED:', this.textContent, 'href:', this.getAttribute('href'));
                    const href = this.getAttribute('href');
                    if (href.startsWith('#')) {
                        e.preventDefault();
                        console.log('üéØ Preventing default, scrolling to:', href);
                        
                        // Remove active class from all buttons
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        const target = document.querySelector(href);
                        console.log('üéØ Target found:', target);
                        if (target) {
                            // Simple scroll to anchor - let the browser handle positioning
                            target.scrollIntoView({
                                behavior: 'smooth',
                                block: 'start'
                            });
                            console.log(`‚úÖ Scroll to anchor completed for:`, href);
                        } else {
                            console.error(`‚ùå Target element not found for:`, href);
                        }
                    }
                });
            });
            console.log('‚úÖ All navigation click handlers set up');
            
            // Initial call to set correct state
            console.log('Setting initial scroll state');
            handleScroll();
            console.log('Initial scroll state set');
            
            // Load featured training video
            loadFeaturedTrainingVideo();
            
            // Initialize quick search functionality
            initializeQuickSearch();
            
            // Backup: Ensure navigation handlers are attached after a delay
            setTimeout(() => {
                console.log('üîÑ Backup: Checking navigation handlers...');
                const backupButtons = document.querySelectorAll('.nav-button');
                console.log('üîÑ Found', backupButtons.length, 'buttons in backup check');
                
                backupButtons.forEach((button, index) => {
                    // Check if this button already has our click handler by testing for a data attribute
                    if (!button.hasAttribute('data-nav-handler-attached')) {
                        console.log(`üîÑ Adding backup handler to button ${index + 1}:`, button.textContent);
                        button.setAttribute('data-nav-handler-attached', 'true');
                        button.addEventListener('click', function(e) {
                            console.log('üñ±Ô∏è BACKUP NAV BUTTON CLICKED:', this.textContent, 'href:', this.getAttribute('href'));
                            const href = this.getAttribute('href');
                            if (href.startsWith('#')) {
                                e.preventDefault();
                                console.log('üéØ Backup preventing default, scrolling to:', href);
                                
                                // Remove active class from all buttons
                                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                                
                                // Add active class to clicked button
                                this.classList.add('active');
                                
                                const target = document.querySelector(href);
                                console.log('üéØ Backup target found:', target);
                                if (target) {
                                    let offset = 155;
                                    const targetOffsetTop = target.offsetTop - offset;
                                    console.log('üéØ Backup scrolling to position:', targetOffsetTop);
                                    
                                    // Use scrollIntoView - more reliable
                                    target.scrollIntoView({ 
                                        behavior: 'smooth', 
                                        block: 'start',
                                        inline: 'nearest'
                                    });
                                    console.log('‚úÖ Backup scrollIntoView command sent');
                                } else {
                                    console.error('‚ùå Backup target not found:', href);
                                }
                            }
                        });
                    }
                });
            }, 2000);
        }
        
        // Function to initialize quick search functionality
        function initializeQuickSearch() {
            const quickSearchBtn = document.getElementById('quickSearchBtn');
            const quickFirstName = document.getElementById('quickFirstName');
            const quickLastName = document.getElementById('quickLastName');
            
            // Search button functionality
            if (quickSearchBtn) {
                quickSearchBtn.addEventListener('click', function() {
                    performQuickSearch();
                });
            }
            
            // Enter key functionality
            [quickFirstName, quickLastName].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            performQuickSearch();
                        }
                    });
                }
            });
        }
        
        // Function to perform quick search
        function performQuickSearch() {
            const firstName = document.getElementById('quickFirstName')?.value.trim();
            const lastName = document.getElementById('quickLastName')?.value.trim();
            
            // Build search parameters
            const params = new URLSearchParams();
            if (firstName) params.append('first_name', firstName);
            if (lastName) params.append('last_name', lastName);
            
            // Redirect to find-people-to-play page with parameters
            const searchUrl = `/mobile/find-people-to-play?${params.toString()}`;
            window.location.href = searchUrl;
        }
        
        // Function to reset quick search form
        function resetQuickSearch() {
            const firstName = document.getElementById('quickFirstName');
            const lastName = document.getElementById('quickLastName');
            
            if (firstName) firstName.value = '';
            if (lastName) lastName.value = '';
        }
        
        // Function to load a random training video
        async function loadFeaturedTrainingVideo() {
            try {
                console.log('Loading featured training video...');
                const response = await fetch('/api/training-videos');
                if (!response.ok) {
                    throw new Error('Failed to fetch training videos');
                }
                
                const videos = await response.json();
                if (videos && videos.length > 0) {
                    // Get a random video
                    const randomIndex = Math.floor(Math.random() * videos.length);
                    const featuredVideo = videos[randomIndex];
                    
                    // Update the training video content
                    const videoContent = document.getElementById('training-video-content');
                    if (videoContent) {
                        // Extract YouTube video ID
                        const videoId = extractYouTubeVideoId(featuredVideo.url);
                        
                        videoContent.innerHTML = `
                            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                <div class="relative aspect-video bg-gray-200 video-container" 
                                     data-video-url="${featuredVideo.url}"
                                     data-video-id="${videoId}">
                                    
                                    <!-- Thumbnail View -->
                                    <div class="thumbnail-view" style="position: absolute; inset: 0; background: #1a1a1a;">
                                        ${videoId ? `
                                        <img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" 
                                             alt="${featuredVideo.title}" 
                                             loading="eager"
                                             style="position: absolute !important; 
                                                    top: 0 !important; 
                                                    left: 0 !important; 
                                                    width: 100% !important; 
                                                    height: 100% !important; 
                                                    object-fit: cover !important; 
                                                    display: block !important;
                                                    z-index: 1 !important;
                                                    opacity: 1 !important;
                                                    visibility: visible !important;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        ` : ''}
                                        
                                        <!-- Fallback if no thumbnail -->
                                        <div class="flex items-center justify-center text-center" style="position: absolute; inset: 0; z-index: 1; display: none;">
                                            <div>
                                                <i class="fas fa-play-circle text-4xl text-rally-green mb-2"></i>
                                                <p class="text-gray-600 font-medium">${featuredVideo.title}</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Slight overlay for better play button visibility -->
                                        <div style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.15); pointer-events: none; z-index: 2;"></div>
                                        
                                        <!-- Duration Badge (simulated) -->
                                        <div class="absolute bottom-4 right-4 bg-black bg-opacity-80 text-white text-xs px-2 py-1 rounded-md backdrop-blur-sm font-medium" style="z-index: 3;">
                                            ${Math.floor(Math.random() * 13) + 3}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}
                                        </div>
                                        
                                        <!-- Modern Play Button Overlay -->
                                        <button class="play-btn" style="position: absolute; 
                                                                         inset: 0; 
                                                                         z-index: 10;
                                                                         display: flex;
                                                                         align-items: center;
                                                                         justify-content: center;
                                                                         background: transparent;
                                                                         border: none;
                                                                         cursor: pointer;
                                                                         transition: all 0.3s ease;">
                                            <!-- Outer glow ring -->
                                            <div style="position: absolute;
                                                        width: 5rem;
                                                        height: 5rem;
                                                        border-radius: 50%;
                                                        background: rgba(255, 255, 255, 0.2);
                                                        transition: all 0.3s ease;"></div>
                                            
                                            <!-- Main button -->
                                            <div style="position: relative;
                                                        width: 3.5rem;
                                                        height: 3.5rem;
                                                        border-radius: 50%;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        background: #bff863;
                                                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                                                        border: 2px solid rgba(255, 255, 255, 0.6);
                                                        transition: all 0.3s ease;">
                                                <!-- Play triangle -->
                                                <div style="position: relative;
                                                            display: flex;
                                                            align-items: center;
                                                            justify-content: center;
                                                            margin-left: 0.25rem;">
                                                    <svg style="width: 1.5rem; height: 1.5rem; color: white; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 5v14l11-7z"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- Video Player (hidden initially) -->
                                    <div class="video-player hidden absolute inset-0">
                                        <iframe class="w-full h-full" 
                                                src="" 
                                                title="${featuredVideo.title}"
                                                frameborder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowfullscreen>
                                        </iframe>
                                        <!-- Close Button -->
                                        <button class="close-video absolute top-2 right-2 w-8 h-8 bg-black bg-opacity-70 hover:bg-opacity-90 rounded-full flex items-center justify-center text-white transition-all duration-200 z-10">
                                            <i class="fas fa-times text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h4 class="font-semibold text-[#045454] mb-2">${featuredVideo.title}</h4>
                                    <p class="text-sm text-gray-600 mb-3">${featuredVideo.summary}</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${featuredVideo.keywords.slice(0, 3).map(keyword => 
                                            `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Initialize video player for the featured video
                        initializeFeaturedVideoPlayer();
                    }
                } else {
                    // Show fallback if no videos available
                    const videoContent = document.getElementById('training-video-content');
                    if (videoContent) {
                        videoContent.innerHTML = `
                            <div class="bg-gray-100 rounded-xl p-6 text-center">
                                <i class="fas fa-video text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">Training videos coming soon!</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading featured training video:', error);
                // Show error fallback
                const videoContent = document.getElementById('training-video-content');
                if (videoContent) {
                    videoContent.innerHTML = `
                        <div class="bg-gray-100 rounded-xl p-6 text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600">Unable to load video</p>
                        </div>
                    `;
                }
            }
        }
        
        // Function to initialize video player for featured video
        function initializeFeaturedVideoPlayer() {
            const playBtn = document.querySelector('#training-video-content .play-btn');
            const closeBtn = document.querySelector('#training-video-content .close-video');
            
            if (playBtn) {
                playBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const videoContainer = this.closest('.video-container');
                    const thumbnailView = videoContainer.querySelector('.thumbnail-view');
                    const videoPlayer = videoContainer.querySelector('.video-player');
                    const iframe = videoPlayer.querySelector('iframe');
                    
                    // Get video URL and extract video ID
                    const videoUrl = videoContainer.dataset.videoUrl;
                    const videoId = extractYouTubeVideoId(videoUrl);
                    
                    if (videoId) {
                        // Set iframe source to YouTube embed URL with autoplay
                        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
                        
                        // Hide thumbnail and show player
                        thumbnailView.classList.add('hidden');
                        videoPlayer.classList.remove('hidden');
                        
                        // Scroll video into view
                        videoContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const videoContainer = this.closest('.video-container');
                    const thumbnailView = videoContainer.querySelector('.thumbnail-view');
                    const videoPlayer = videoContainer.querySelector('.video-player');
                    const iframe = videoPlayer.querySelector('iframe');
                    
                    // Stop video by clearing iframe source
                    iframe.src = '';
                    
                    // Show thumbnail and hide player
                    videoPlayer.classList.add('hidden');
                    thumbnailView.classList.remove('hidden');
                });
            }
        }
        
        // Function to extract YouTube video ID from URL
        function extractYouTubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // ============================================
        // LEAGUE SWITCHER FUNCTIONALITY
        // ============================================
        
        async function checkMultipleLeagues() {
            try {
                console.log('üîç Checking for multiple leagues...');
                // Check if this specific user has multiple leagues (including all associations)
                const response = await fetch('/api/get-user-leagues');
                const data = await response.json();
                
                console.log('üìä League check response:', data);
                
                if (data.success && data.has_multiple_leagues) {
                    const leagueButton = document.getElementById('leagueSwitcherTrigger');
                    if (leagueButton) {
                        leagueButton.classList.remove('hidden');
                        console.log(`‚úÖ League selector shown - user has ${data.league_count} leagues`);
                    } else {
                        console.log('‚ùå League button element not found');
                    }
                } else {
                    console.log(`‚ùå League selector hidden - user has ${data.league_count || 0} leagues`);
                }
            } catch (error) {
                console.error('‚ùå Error checking multiple leagues:', error);
            }
        }

        async function checkMultipleClubs() {
            try {
                console.log('üîç Checking for multiple clubs/teams...');
                // Check if this specific user has multiple teams in current league
                const response = await fetch('/api/get-user-teams-in-current-league');
                const data = await response.json();
                
                console.log('üìä Club check response:', data);
                
                if (data.success && data.has_multiple_teams) {
                    const leagueButton = document.getElementById('leagueSwitcherTrigger');
                    if (leagueButton) {
                        leagueButton.classList.remove('hidden');
                        console.log(`‚úÖ League selector shown - user has ${data.teams.length} teams in current league`);
                    } else {
                        console.log('‚ùå League button element not found');
                    }
                } else {
                    console.log(`‚ùå League selector hidden - user has ${data.teams ? data.teams.length : 0} teams in current league`);
                }
            } catch (error) {
                console.error('‚ùå Error checking multiple clubs:', error);
            }
        }

        function showLeagueSwitcher() {
            const modal = document.getElementById('leagueSwitcherModal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                loadLeagueSwitcherOptions();
            }
        }

        function closeLeagueSwitcher() {
            const modal = document.getElementById('leagueSwitcherModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        async function loadLeagueSwitcherOptions() {
            try {
                // Load both league and team options
                const [leaguesResponse, teamsResponse] = await Promise.all([
                    fetch('/api/get-user-leagues'),
                    fetch('/api/get-user-teams-in-current-league')
                ]);
                
                const leaguesData = await leaguesResponse.json();
                const teamsData = await teamsResponse.json();
                
                const optionsContainer = document.querySelector('#leagueSwitcherModal .league-options');
                if (optionsContainer) {
                    let html = '';
                    
                    // Add league options if user has multiple leagues
                    if (leaguesData.success && leaguesData.leagues && leaguesData.leagues.length > 1) {
                        html += '<div class="text-sm font-bold text-gray-800 mb-3 uppercase tracking-wide">Switch to Different League</div>';
                        html += leaguesData.leagues.map(league => {
                            return `
                            <button onclick="switchLeague('${league.league_string_id}', '${league.league_name}')" 
                                    class="league-switch-btn w-full flex items-center justify-between p-4 rounded-lg bg-gray-800 hover:bg-rally-dark-green hover:bg-opacity-80 transition-all duration-200 border-2 border-gray-600 hover:border-rally-bright-green hover:shadow-md group mb-2
                                           ${league.is_current ? 'bg-rally-dark-green border-rally-bright-green' : ''}">
                                <div class="text-left">
                                    <div class="font-bold text-white group-hover:text-rally-bright-green">${league.league_name}</div>
                                    <div class="text-sm text-gray-300 group-hover:text-rally-bright-green">${league.player_count} players</div>
                                </div>
                                <div class="text-sm ${league.is_current ? 'bg-gray-500 text-white px-3 py-1 rounded' : 'bg-rally-bright-green group-hover:bg-rally-bright-green group-hover:bg-opacity-90 text-rally-dark-green px-3 py-1 rounded'}" style="${league.is_current ? 'background-color: #797979 !important;' : 'background-color: #bff863 !important; color: #045454 !important;'}">
                                    ${league.is_current ? 'Current' : 'Switch'}
                                </div>
                            </button>
                        `;
                        }).join('');
                    }
                    
                    // Add team options if user has multiple teams in current league
                    if (teamsData.success && teamsData.teams && teamsData.teams.length > 1) {
                        if (html) html += '<div class="mt-6"></div>';
                        html += '<div class="text-sm font-bold text-gray-800 mb-3 uppercase tracking-wide">Switch to Different Team (Same League)</div>';
                        html += teamsData.teams.map(team => `
                            <button onclick="switchTeamInLeague(${team.team_id}, '${team.team_name}', '${team.club_name}', '${team.series_name}')" 
                                    class="team-switch-btn w-full flex items-center justify-between p-4 rounded-lg bg-white hover:bg-rally-bright-green hover:bg-opacity-10 transition-all duration-200 border-2 border-gray-300 hover:border-rally-dark-green hover:shadow-md group mb-2
                                           ${team.is_current ? 'bg-rally-bright-green bg-opacity-20 border-rally-dark-green' : ''}">
                                <div class="text-left">
                                    <div class="font-bold text-gray-900 group-hover:text-rally-dark-green">${team.club_name}</div>
                                    <div class="text-sm text-gray-600 group-hover:text-rally-dark-green">${team.series_name} ‚Ä¢ ${team.match_count} matches</div>
                                </div>
                                <div class="text-sm ${team.is_current ? 'bg-gray-500 text-white px-3 py-1 rounded' : 'bg-rally-dark-green group-hover:bg-opacity-90 text-white px-3 py-1 rounded'}" style="${team.is_current ? 'background-color: #797979 !important;' : 'background-color: #045454 !important;'}">
                                    ${team.is_current ? 'Current' : 'Switch'}
                                </div>
                            </button>
                        `).join('');
                    }
                    
                    // If no options available, show message
                    if (!html) {
                        html = '<div class="text-center py-4 text-gray-500">No switching options available</div>';
                    }
                    
                    optionsContainer.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading league switcher options:', error);
            }
        }

        async function switchLeague(leagueId, leagueName) {
            console.log('switchLeague called with:', { leagueId, leagueName });
            try {
                // Close modal first
                const modal = document.getElementById('leagueSwitcherModal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
                
                // Show loading
                const leagueButton = document.getElementById('leagueSwitcherTrigger');
                if (leagueButton) {
                    leagueButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
                    leagueButton.disabled = true;
                }
                
                const response = await fetch('/api/switch-league', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        league_id: leagueId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success briefly then reload
                    if (leagueButton) {
                        leagueButton.innerHTML = '<i class="fas fa-check text-xs"></i>';
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'League switch failed');
                }
            } catch (error) {
                console.error('League switch error:', error);
                alert(`Failed to switch leagues: ${error.message}`);
                
                // Reset button
                const leagueButton = document.getElementById('leagueSwitcherTrigger');
                if (leagueButton) {
                    leagueButton.innerHTML = 'Switch League/Team';
                    leagueButton.disabled = false;
                }
            }
        }

        async function switchTeamInLeague(teamId, teamName, clubName, seriesName) {
            try {
                // Close modal first
                const modal = document.getElementById('leagueSwitcherModal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
                
                // Show loading
                const leagueButton = document.getElementById('leagueSwitcherTrigger');
                if (leagueButton) {
                    leagueButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
                    leagueButton.disabled = true;
                }
                
                const response = await fetch('/api/switch-team-in-league', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        team_id: teamId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success briefly then reload
                    if (leagueButton) {
                        leagueButton.innerHTML = '<i class="fas fa-check text-xs"></i>';
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Team switch failed');
                }
            } catch (error) {
                console.error('Team switch error:', error);
                alert(`Failed to switch teams: ${error.message}`);
                
                // Reset button
                const leagueButton = document.getElementById('leagueSwitcherTrigger');
                if (leagueButton) {
                    leagueButton.innerHTML = 'Switch League/Team';
                    leagueButton.disabled = false;
                }
            }
        }

    </script>

<!-- League Switching Modal -->
<div id="leagueSwitcherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-sm w-full max-h-[40rem] overflow-hidden flex flex-col" style="max-height: 40rem !important; height: auto !important;">
        <!-- Modal Header -->
        <div class="px-6 py-4 bg-black border-b border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white" style="color: white !important;">
                Switch League or Team
            </h3>
            <button id="closeLeagueModal" class="text-gray-300 hover:text-white transition-colors text-xl font-bold" onclick="closeLeagueSwitcher()">
                √ó
            </button>
        </div>
        
        <!-- Current League Display -->
        <div class="px-6 py-4" style="background: #045454; border-bottom: 2px solid #045454;">
            <div class="flex items-center gap-3 mb-3">
                <span class="bg-white text-rally-dark-green px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                    CURRENT
                </span>
                <span class="text-white font-bold text-sm uppercase tracking-wide">ACTIVE LEAGUE</span>
            </div>
            <div class="font-bold text-white text-lg mb-1" style="color: white !important;">{{ session_data.user.league_name }}</div>
            <div class="text-white text-sm">{{ session_data.user.club }} ‚Ä¢ {{ session_data.user.series }}</div>
        </div>
        
        <!-- Available League Options -->
        <div class="p-4 bg-gray-50 flex-1 overflow-y-auto">
            <div class="text-sm font-bold text-gray-800 mb-3 uppercase tracking-wide">
                Switch to Different League
            </div>
            <div class="space-y-2 league-options min-h-[300px]" style="min-height: 300px !important;">
                <!-- Options will be loaded dynamically -->
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i> Loading leagues...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// League Switcher Modal Event Handlers
function closeLeagueSwitcher() {
    const modal = document.getElementById('leagueSwitcherModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

// Initialize modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const leagueSwitcherModal = document.getElementById('leagueSwitcherModal');
    
    if (leagueSwitcherModal) {
        // Close modal when clicking outside
        leagueSwitcherModal.addEventListener('click', function(e) {
            if (e.target === leagueSwitcherModal) {
                closeLeagueSwitcher();
            }
        });
    }
    
    // Close on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (leagueSwitcherModal && !leagueSwitcherModal.classList.contains('hidden')) {
                closeLeagueSwitcher();
            }
        }
    });
});
</script>

<!-- Weather Modal -->
<div id="weatherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl max-w-md w-full max-h-[80vh] overflow-hidden">
            <!-- Modal Header with Rally dark green background -->
            <div class="flex items-center justify-between p-6" style="background-color: #045454;">
                <h3 class="text-xl font-bold text-white">Weather Forecast</h3>
                <button onclick="closeWeatherModal()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6">
                <!-- Loading State -->
                <div id="weatherLoading" class="text-center py-8">
                    <div class="w-8 h-8 border-4 border-gray-300 border-t-blue-500 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading weather data...</p>
                </div>
                
                <!-- Weather Content -->
                <div id="weatherContent" class="hidden">
                    <div class="text-center mb-6">
                        <div id="weatherIcon" class="text-6xl mb-4"></div>
                        <div id="weatherCondition" class="text-2xl font-semibold text-gray-800 mb-2"></div>
                        <div id="weatherTemperature" class="text-4xl font-bold text-blue-600 mb-2"></div>
                        <div id="weatherLocation" class="text-lg text-gray-600 mb-4"></div>
                        <div id="weatherDate" class="text-sm text-gray-500"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <div class="text-sm text-gray-600 mb-1">Precipitation</div>
                            <div id="weatherPrecipitation" class="text-lg font-semibold text-gray-800"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <div class="text-sm text-gray-600 mb-1">Wind Speed</div>
                            <div id="weatherWind" class="text-lg font-semibold text-gray-800"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <div class="text-sm text-gray-600 mb-1">Humidity</div>
                            <div id="weatherHumidity" class="text-lg font-semibold text-gray-800"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <div class="text-sm text-gray-600 mb-1">High / Low</div>
                            <div id="weatherHighLow" class="text-lg font-semibold text-gray-800"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Error State -->
                <div id="weatherError" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                    <p class="text-gray-600 mb-4">Unable to load weather data</p>
                    <p class="text-sm text-gray-500">Please try again later</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Weather Modal Functions
function showWeatherModal(location, date) {
    const modal = document.getElementById('weatherModal');
    const loading = document.getElementById('weatherLoading');
    const content = document.getElementById('weatherContent');
    const error = document.getElementById('weatherError');
    
    // Show modal and loading state
    modal.classList.remove('hidden');
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    error.classList.add('hidden');
    document.body.style.overflow = 'hidden';
    
    // Fetch weather data
    fetchWeatherData(location, date);
}

function closeWeatherModal() {
    const modal = document.getElementById('weatherModal');
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

function fetchWeatherData(location, date) {
    const loading = document.getElementById('weatherLoading');
    const content = document.getElementById('weatherContent');
    const error = document.getElementById('weatherError');
    
    // Format date for API (YYYY-MM-DD)
    const formattedDate = new Date(date).toISOString().split('T')[0];
    
    // Check if date is within 5 days (OpenWeatherMap API limitation)
    const today = new Date();
    const targetDate = new Date(date);
    const daysDiff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
    
    if (daysDiff > 5) {
        loading.classList.add('hidden');
        error.classList.remove('hidden');
        document.getElementById('weatherError').innerHTML = `
            <i class="fas fa-calendar-alt text-4xl text-yellow-500 mb-4"></i>
            <p class="text-gray-600 mb-4">Weather forecast not available</p>
            <p class="text-sm text-gray-500">Forecasts are only available for the next 5 days</p>
        `;
        return;
    }
    
    fetch(`/api/weather?location=${encodeURIComponent(location)}&date=${formattedDate}`)
        .then(response => response.json())
        .then(data => {
            loading.classList.add('hidden');
            
            if (data.success && data.weather) {
                displayWeatherData(data.weather, location, date);
                content.classList.remove('hidden');
            } else {
                error.classList.remove('hidden');
                document.getElementById('weatherError').innerHTML = `
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                    <p class="text-gray-600 mb-4">Unable to load weather data</p>
                    <p class="text-sm text-gray-500">Please try again later</p>
                `;
            }
        })
        .catch(err => {
            console.error('Weather fetch error:', err);
            loading.classList.add('hidden');
            error.classList.remove('hidden');
            document.getElementById('weatherError').innerHTML = `
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                <p class="text-gray-600 mb-4">Unable to load weather data</p>
                <p class="text-sm text-gray-500">Please try again later</p>
            `;
        });
}

function displayWeatherData(weather, location, date) {
    // Update weather icon
    const weatherIcon = document.getElementById('weatherIcon');
    if (weather.icon_url) {
        // Apply yellow filter only to sun/clear weather icons
        let iconStyle = '';
        if (weather.icon && (weather.icon.includes('01d') || weather.icon.includes('01n') || 
            weather.condition.toLowerCase().includes('clear') || 
            weather.condition.toLowerCase().includes('sun'))) {
            iconStyle = 'filter: brightness(0) saturate(100%) invert(84%) sepia(100%) saturate(1000%) hue-rotate(0deg) brightness(100%) contrast(100%);';
        }
        weatherIcon.innerHTML = `<img src="${weather.icon_url}" alt="${weather.condition}" class="mx-auto" style="${iconStyle}">`;
    } else {
        weatherIcon.innerHTML = `<i class="fas fa-cloud text-blue-500"></i>`;
    }
    
    // Update weather details
    document.getElementById('weatherCondition').textContent = weather.condition;
    document.getElementById('weatherTemperature').textContent = `${Math.round(weather.temperature_high)}¬∞F`;
    document.getElementById('weatherLocation').textContent = location;
    document.getElementById('weatherDate').textContent = new Date(date).toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Update weather stats
    document.getElementById('weatherPrecipitation').textContent = `${Math.round(weather.precipitation_chance)}%`;
    document.getElementById('weatherWind').textContent = `${Math.round(weather.wind_speed)} mph`;
    document.getElementById('weatherHumidity').textContent = `${Math.round(weather.humidity)}%`;
    document.getElementById('weatherHighLow').textContent = `${Math.round(weather.temperature_high)}¬∞/${Math.round(weather.temperature_low)}¬∞`;
}

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const weatherModal = document.getElementById('weatherModal');
    
    if (weatherModal) {
        weatherModal.addEventListener('click', function(e) {
            if (e.target === weatherModal) {
                closeWeatherModal();
            }
        });
    }
    
    // Close on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (weatherModal && !weatherModal.classList.contains('hidden')) {
                closeWeatherModal();
            }
        }
    });
});
</script>

{% endblock %}

