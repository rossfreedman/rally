{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                <i class="fas fa-table-tennis text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">View Pickup Games</h1>
                <p class="text-sm text-gray-500">Find pickup games to join</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">

        <!-- Action Buttons -->
        <div class="flex gap-3">
            <a href="/mobile/create-pickup-game" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 shadow-sm">
                <i class="fas fa-plus"></i>
                <span>Create new game</span>
            </a>
            <button id="notificationToggle" class="flex-1 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 shadow-sm" style="background-color: #2563eb !important;" data-state="disabled">
                <i class="fas fa-bell-slash" id="notificationIcon"></i>
                <span id="notificationText">Get notified about games</span>
            </button>
        </div>

        <!-- Upcoming Pickup Games Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                    Upcoming Pickup Games
                </h2>
                <p class="text-sm text-gray-600 mt-2">Players who meet the criteria set by the organizer will be notified by text about upcoming games and can choose to join.</p>
            </div>
            
            <div id="upcomingGamesContainer" class="p-4">
                <!-- Loading state -->
                <div id="upcomingGamesLoading" class="text-center py-8">
                    <div class="loading-spinner loading-lg mx-auto mb-4"></div>
                    <p class="text-gray-500">Loading upcoming games...</p>
                </div>
                
                <!-- Empty state -->
                <div id="upcomingGamesEmpty" class="text-center py-8 hidden">
                    <i class="fas fa-calendar-plus text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500 mb-4">No upcoming pickup games found</p>
                    <a href="/mobile/create-pickup-game" class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create the First Game
                    </a>
                </div>
                
                <!-- Games will be populated here -->
                <div id="upcomingGamesList" class="space-y-4 hidden"></div>
            </div>
        </div>

        <!-- Past Pickup Games Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-history text-blue-500 mr-2"></i>
                    Past Pickup Games
                </h2>
                <p class="text-sm text-gray-600 mt-2">View previous pickup games and their results.</p>
            </div>
            
            <div id="pastGamesContainer" class="p-4">
                <!-- Loading state -->
                <div id="pastGamesLoading" class="text-center py-8">
                    <div class="loading-spinner loading-lg mx-auto mb-4"></div>
                    <p class="text-gray-500">Loading past games...</p>
                </div>
                
                <!-- Empty state -->
                <div id="pastGamesEmpty" class="text-center py-8 hidden">
                    <i class="fas fa-calendar-times text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500">No past pickup games found</p>
                </div>
                
                <!-- Games will be populated here -->
                <div id="pastGamesList" class="space-y-4 hidden"></div>
            </div>
        </div>



    </div>
</div>

<!-- Join Game Button -->
<div id="joinGameContainer" class="fixed bottom-0 left-0 right-0 w-full p-4 bg-white border-t border-gray-200 shadow-lg z-50" style="display: none;">
    <div class="flex justify-center">
        <button id="joinGameBtn" class="px-6 py-3 rounded-lg shadow-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200 flex items-center gap-2 text-sm font-semibold" 
                style="background-color: #16a34a !important; color: white !important; border: none !important;"
                onmouseover="this.style.backgroundColor='#15803d !important'"
                onmouseout="this.style.backgroundColor='#16a34a !important'">
            <i class="fas fa-plus text-lg"></i>
            <span>Join Selected Game</span>
        </button>
    </div>
</div>

<!-- Modal for Game Details -->
<div id="gameDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden shadow-xl">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Game Details</h3>
                <button id="closeGameModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 overflow-y-auto max-h-96">
            <div id="gameDetailsContent">
                <!-- Game details will be populated here -->
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div id="gameActionsContainer" class="text-center">
                <!-- Game action buttons will be populated here -->
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Grid responsive */
@media (max-width: 640px) {
    .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .sm\:grid-cols-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

@media (min-width: 640px) {
    .sm\:grid-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    .sm\:inline {
        display: inline;
    }
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.shadow-xl {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-blue-100 { border-color: #dbeafe; }
.border-yellow-200 { border-color: #fde047; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-white { background-color: #ffffff; }
.bg-green-100 { background-color: #dcfce7; }
.bg-yellow-100 { background-color: #fef3c7; }
.bg-red-100 { background-color: #fee2e2; }
.bg-blue-50 { background-color: #eff6ff; }
.bg-blue-100 { background-color: #dbeafe; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-green-600 { background-color: #16a34a !important; }
.bg-indigo-600 { background-color: #4f46e5 !important; }

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-gray-400 { color: #9ca3af; }
.text-green-500 { color: #10b981; }
.text-green-600 { color: #059669; }
.text-green-700 { color: #047857; }
.text-yellow-600 { color: #d97706; }
.text-yellow-700 { color: #b45309; }
.text-yellow-800 { color: #92400e; }
.text-red-700 { color: #b91c1c; }
.text-blue-500 { color: #3b82f6; }
.text-blue-600 { color: #2563eb; }
.text-blue-700 { color: #1d4ed8; }
.text-white { color: #ffffff; }

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-4 > * + * { margin-top: 1rem; }
.space-y-3 > * + * { margin-top: 0.75rem; }

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }

/* Text utilities */
.uppercase { text-transform: uppercase; }
.tracking-wide { letter-spacing: 0.025em; }
.truncate { 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }
.min-w-0 { min-width: 0px; }

/* Hover utilities */
.hover\:bg-green-700:hover { background-color: #15803d !important; }
.hover\:bg-blue-700:hover { background-color: #1d4ed8 !important; }
.hover\:bg-gray-200:hover { background-color: #e5e7eb !important; }

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.duration-150 {
    transition-duration: 150ms;
}

.duration-200 {
    transition-duration: 200ms;
}

/* Custom slider styles */
.slider {
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    background: #e5e7eb;
    outline: none;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.slider:hover {
    background: #d1d5db;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3b82f6;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3b82f6;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-moz-range-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

/* Loading spinner */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
}

.loading-lg {
    width: 2.5rem;
    height: 2.5rem;
}

.loading-spinner {
    animation: spin 1s linear infinite;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Hide elements */
.hidden {
    display: none;
}

/* Date and time input styling */
input[type="date"], input[type="time"] {
    /* Allow native date/time picker appearance */
    background-color: white;
}

input[type="date"]::-webkit-calendar-picker-indicator,
input[type="time"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
    /* Allow native calendar icon to show */
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Game selection UI Elements
    const joinGameContainer = document.getElementById('joinGameContainer');
    const joinGameBtn = document.getElementById('joinGameBtn');
    const gameDetailsModal = document.getElementById('gameDetailsModal');
    const closeGameModal = document.getElementById('closeGameModal');
    const gameDetailsContent = document.getElementById('gameDetailsContent');
    const gameActionsContainer = document.getElementById('gameActionsContainer');
    
    // Get current user ID for creator comparison
    const currentUserId = {{ session_data.user.id if session_data and session_data.user and session_data.user.id else 'null' }};

    // Initialize notification toggle
    function initializeNotificationToggle() {
        const toggle = document.getElementById('notificationToggle');
        const icon = document.getElementById('notificationIcon');
        const text = document.getElementById('notificationText');
        
        if (toggle) {
            // Always start with disabled state (red button) - ignore localStorage for now
            const isEnabled = false;
            localStorage.setItem('pickupGameNotifications', 'false');
            
            // Set initial button state
            updateToggleAppearance(isEnabled);
            
            // Add event listener for button clicks
            toggle.addEventListener('click', handleNotificationToggle);
            
            // Add hover effects
            toggle.addEventListener('mouseenter', handleToggleHover);
            toggle.addEventListener('mouseleave', handleToggleHoverOut);
        }
    }

    // Update toggle button appearance based on state
    function updateToggleAppearance(isEnabled) {
        const toggle = document.getElementById('notificationToggle');
        const icon = document.getElementById('notificationIcon');
        const text = document.getElementById('notificationText');
        
        console.log('updateToggleAppearance called with isEnabled:', isEnabled);
        
        if (isEnabled) {
            // Enabled state - GREEN button
            toggle.className = 'flex-1 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 shadow-sm';
            toggle.style.setProperty('background-color', '#16a34a', 'important');
            toggle.style.setProperty('background', '#16a34a', 'important');
            toggle.dataset.state = 'enabled';
            icon.className = 'fas fa-bell';
            text.textContent = 'Notifications: ON';
            console.log('Set to GREEN - Notifications: ON');
        } else {
            // Disabled state - BLUE button
            toggle.className = 'flex-1 text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 shadow-sm';
            toggle.style.setProperty('background-color', '#2563eb', 'important');
            toggle.style.setProperty('background', '#2563eb', 'important');
            toggle.dataset.state = 'disabled';
            icon.className = 'fas fa-bell-slash';
            text.textContent = 'Get notified about games';
            console.log('Set to BLUE - Get notified about games');
        }
    }

    // Handle hover effects
    function handleToggleHover(event) {
        const toggle = event.target;
        const state = toggle.dataset.state;
        
        if (state === 'enabled') {
            toggle.style.backgroundColor = '#15803d !important'; // darker green
        } else {
            toggle.style.backgroundColor = '#1d4ed8 !important'; // darker blue
        }
    }

    function handleToggleHoverOut(event) {
        const toggle = event.target;
        const state = toggle.dataset.state;
        
        if (state === 'enabled') {
            toggle.style.backgroundColor = '#16a34a !important'; // green
        } else {
            toggle.style.backgroundColor = '#2563eb !important'; // blue
        }
    }

    // Handle notification toggle changes
    function handleNotificationToggle(event) {
        event.preventDefault();
        
        // Get current state and flip it
        const currentState = localStorage.getItem('pickupGameNotifications');
        const isEnabled = currentState !== 'true'; // Flip the state
        
        // Save new state to localStorage
        localStorage.setItem('pickupGameNotifications', isEnabled.toString());
        
        // Update button appearance
        updateToggleAppearance(isEnabled);
        
        // Show user feedback
        showNotificationFeedback(isEnabled);
        
        console.log('Pickup game notifications:', isEnabled ? 'enabled' : 'disabled');
    }

    // Show user feedback for toggle changes
    function showNotificationFeedback(isEnabled) {
        // Create feedback message
        const message = isEnabled ? 
            'Game notifications enabled! You\'ll be notified about new pickup games.' : 
            'Game notifications disabled. You won\'t receive notifications about new games.';
        
        // Create temporary feedback element
        const feedback = document.createElement('div');
        feedback.className = `fixed top-4 left-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${
            isEnabled ? 'bg-green-500 text-white' : 'bg-blue-600 text-white'
        }`;
        feedback.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas fa-${isEnabled ? 'bell' : 'bell-slash'}"></i>
                <span class="text-sm font-medium">${message}</span>
            </div>
        `;
        
        document.body.appendChild(feedback);
        
        // Remove feedback after 3 seconds
        setTimeout(() => {
            feedback.style.opacity = '0';
            feedback.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 300);
        }, 3000);
    }

    // Load pickup games from API
    async function loadPickupGames() {
        try {
            const response = await fetch('/api/pickup-games');
            if (response.ok) {
                const data = await response.json();
                renderUpcomingGames(data.upcoming_games || []);
                renderPastGames(data.past_games || []);
            } else {
                showError('Failed to load pickup games');
            }
        } catch (error) {
            console.error('Error loading pickup games:', error);
            showError('Network error loading pickup games');
        }
    }
    
    // Render upcoming games
    function renderUpcomingGames(games) {
        const loadingEl = document.getElementById('upcomingGamesLoading');
        const emptyEl = document.getElementById('upcomingGamesEmpty');
        const listEl = document.getElementById('upcomingGamesList');
        
        // Hide loading
        loadingEl.classList.add('hidden');
        
        if (games.length === 0) {
            emptyEl.classList.remove('hidden');
            listEl.classList.add('hidden');
        } else {
            emptyEl.classList.add('hidden');
            listEl.classList.remove('hidden');
            
            listEl.innerHTML = games.map(game => createGameHTML(game, false)).join('');
        }
    }
    
    // Render past games
    function renderPastGames(games) {
        const loadingEl = document.getElementById('pastGamesLoading');
        const emptyEl = document.getElementById('pastGamesEmpty');
        const listEl = document.getElementById('pastGamesList');
        
        // Hide loading
        loadingEl.classList.add('hidden');
        
        if (games.length === 0) {
            emptyEl.classList.remove('hidden');
            listEl.classList.add('hidden');
        } else {
            emptyEl.classList.add('hidden');
            listEl.classList.remove('hidden');
            
            listEl.innerHTML = games.map(game => createGameHTML(game, true)).join('');
        }
    }
    
    // Create HTML for a single game
    function createGameHTML(game, isPast = false) {
        const statusColors = {
            'Open': { bg: 'bg-blue-100', text: 'text-blue-800' },
            'Nearly Full': { bg: 'bg-orange-100', text: 'text-orange-800' },
            'Closed': { bg: 'bg-red-100', text: 'text-red-800' }
        };
        
        const statusColor = statusColors[game.status] || statusColors['Open'];
        
        // Check if current user is the creator
        const isCreator = currentUserId && game.creator_user_id && currentUserId === game.creator_user_id;
        
        // Determine button text and action based on user participation
        let buttonText, buttonAction, buttonClass, buttonIcon, buttonDisabled;
        
        if (isPast) {
            buttonText = 'View Results';
            buttonAction = 'view';
            buttonClass = 'bg-gray-400 cursor-not-allowed';
            buttonIcon = 'eye';
            buttonDisabled = true;
        } else if (game.status === 'Closed') {
            buttonText = 'Game Full';
            buttonAction = 'join';
            buttonClass = 'bg-gray-400 cursor-not-allowed';
            buttonIcon = 'ban';
            buttonDisabled = true;
        } else if (game.user_has_joined) {
            buttonText = 'Leave Game';
            buttonAction = 'leave';
            buttonClass = 'bg-red-600 hover:bg-red-700';
            buttonIcon = '';
            buttonDisabled = false;
        } else {
            buttonText = 'Join Game';
            buttonAction = 'join';
            buttonClass = 'bg-green-600 hover:bg-green-700';
            buttonIcon = '';
            buttonDisabled = false;
        }
        
        // Format criteria on multiple lines
        const criteriaLines = [
            `PTI Range: ${game.pti_range}`,
            `Series: ${game.series_criteria}`,
            game.club_only ? `${game.club_name} only` : 'All clubs'
        ];
        
        const criteriaHTML = criteriaLines.map(line => 
            `<div class="text-sm text-gray-700">${line}</div>`
        ).join('');
        
        // Create creator buttons HTML if user is creator
        const creatorButtonsHTML = isCreator && !isPast ? `
            <div class="grid grid-cols-2 gap-2 mb-3">
                <button class="game-edit-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" 
                        data-game-id="${game.id}">
                    <i class="fas fa-edit mr-2"></i>Edit Game
                </button>
                <button class="game-delete-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" 
                        data-game-id="${game.id}" data-game-description="${game.description}" data-game-date="${game.formatted_date}" data-game-time="${game.formatted_time}">
                    <i class="fas fa-trash mr-2"></i>Delete Game
                </button>
            </div>
        ` : '';
        
        return `
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200" data-game-id="${game.id}">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900">${game.description}</h3>
                        <p class="text-sm text-gray-600">${game.formatted_date} at ${game.formatted_time}</p>
                        ${isCreator ? '<p class="text-xs text-blue-600 font-medium mt-1"><i class="fas fa-crown mr-1"></i>Your Game</p>' : ''}
                    </div>
                    <span class="text-xs ${statusColor.bg} ${statusColor.text} px-2 py-1 rounded-full">${game.status}</span>
                </div>
                
                <div class="mb-3">
                    <div class="text-sm font-bold text-gray-900 mb-1">Criteria:</div>
                    ${criteriaHTML}
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div class="text-center">
                        <div class="text-xl font-bold text-gray-900">${game.players_requested}</div>
                        <div class="text-xs text-gray-500">Players Requested</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xl font-bold ${game.status === 'Open' ? 'text-blue-600' : game.status === 'Nearly Full' ? 'text-orange-600' : 'text-red-600'}">${game.players_committed}</div>
                        <div class="text-xs text-gray-500">Committed Players</div>
                    </div>
                </div>
                
                <!-- Participants and Available Slots Section -->
                <div class="mb-4">
                    <div class="text-sm font-medium text-gray-900 mb-2">
                        Players (${game.slots_filled}/${game.players_requested})
                    </div>
                    
                    <!-- Visual slot representation -->
                    <div class="grid grid-cols-4 gap-1 mb-3">
                        ${Array.from({ length: game.players_requested }, (_, i) => {
                            const slotNumber = i + 1;
                            const isOccupied = i < game.slots_filled;
                            const participant = isOccupied ? game.participants[i] : null;
                            
                            if (isOccupied && participant) {
                                const joinDateTime = new Date(participant.joined_at);
                                const joinDate = joinDateTime.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
                                const joinTime = joinDateTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                                return `<div class="bg-green-100 text-green-800 rounded-lg text-xs font-medium border border-green-200 flex items-center p-2 gap-2" title="Slot ${slotNumber}: ${participant.name} - Joined ${joinDate} at ${joinTime}">
                                    <div class="bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs flex-shrink-0">${slotNumber}</div>
                                    <div class="flex-1 min-w-0">
                                        <div class="truncate font-medium text-green-800">${participant.name}</div>
                                        <div class="text-green-600 opacity-75 text-xs">Joined ${joinDate} at ${joinTime}</div>
                                    </div>
                                </div>`;
                            } else {
                                return `<div class="bg-gray-100 text-gray-500 rounded-lg text-xs border border-gray-200 flex items-center p-2 gap-2" title="Slot ${slotNumber}: Available">
                                    <div class="bg-gray-400 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-xs flex-shrink-0">${slotNumber}</div>
                                    <div class="flex-1">
                                        <div class="font-medium">Open</div>
                                    </div>
                                </div>`;
                            }
                        }).join('')}
                    </div>
                    
                    ${game.available_slots > 0 ? `
                        <div class="text-xs text-blue-600 font-medium mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            ${game.available_slots} slot${game.available_slots === 1 ? '' : 's'} still available
                        </div>
                    ` : game.is_full ? `
                        <div class="text-xs text-red-600 font-medium mt-2">
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            Game is full
                        </div>
                    ` : ''}
                </div>
                
                <!-- Join/Leave Game Button -->
                <button class="game-action-btn w-full ${buttonClass} text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors mb-3" 
                        data-game-id="${game.id}" 
                        data-action="${buttonAction}"
                        ${buttonDisabled ? 'disabled' : ''}>
                    ${buttonIcon ? `<i class="fas fa-${buttonIcon} mr-1"></i>` : ''}${buttonText}
                </button>
                
                <!-- Creator Action Buttons (Edit & Delete) -->
                ${creatorButtonsHTML}
            </div>
        `;
    }
    
    // Handle game edit
    async function handleGameEdit(gameId) {
        try {
            showInfo('Loading game details for editing...');
            
            // Redirect to create page with edit parameter
            window.location.href = `/mobile/create-pickup-game?edit=${gameId}`;
            
        } catch (error) {
            console.error('Error handling game edit:', error);
            showError('Failed to load game for editing');
        }
    }
    
    // Handle game delete
    async function handleGameDelete(gameId, gameDescription, gameDate, gameTime) {
        try {
            // Create confirmation dialog
            const confirmed = await showConfirmDialog(
                'Delete Pickup Game',
                `Are you sure you want to delete "${gameDescription}" scheduled for ${gameDate} at ${gameTime}?`,
                'This action cannot be undone and will remove all participants from the game.',
                'Delete Game',
                'Cancel'
            );
            
            if (!confirmed) {
                return; // User canceled
            }
            
            // Show loading state
            showInfo('Deleting pickup game...');
            
            const response = await fetch(`/api/pickup-games/${gameId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showDeleteSuccess(result.message);
                // Reload games to remove the deleted game
                setTimeout(() => loadPickupGames(), 1000);
            } else {
                showError(result.error || 'Failed to delete pickup game');
            }
        } catch (error) {
            console.error('Error deleting pickup game:', error);
            showError('Network error. Please try again.');
        }
    }
    
    // Show confirmation dialog
    function showConfirmDialog(title, message, warning, confirmText, cancelText) {
        return new Promise((resolve) => {
            // Create modal backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            backdrop.style.zIndex = '10000';
            
            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl max-w-md w-full transform transition-all duration-300';
            modal.style.transform = 'scale(0.9)';
            modal.style.opacity = '0';
            
            modal.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-exclamation-triangle text-red-600 text-lg"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">${title}</h3>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-gray-700 mb-2">${message}</p>
                        ${warning ? `<p class="text-sm text-red-600 font-medium">${warning}</p>` : ''}
                    </div>
                    
                    <div class="flex gap-3 justify-end">
                        <button id="confirmCancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                            ${cancelText}
                        </button>
                        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium">
                            <i class="fas fa-trash mr-2"></i>${confirmText}
                        </button>
                    </div>
                </div>
            `;
            
            backdrop.appendChild(modal);
            document.body.appendChild(backdrop);
            
            // Animate in
            setTimeout(() => {
                modal.style.transform = 'scale(1)';
                modal.style.opacity = '1';
            }, 10);
            
            // Handle button clicks
            const cancelBtn = modal.querySelector('#confirmCancel');
            const deleteBtn = modal.querySelector('#confirmDelete');
            
            function cleanup(result) {
                modal.style.transform = 'scale(0.9)';
                modal.style.opacity = '0';
                setTimeout(() => {
                    if (backdrop.parentNode) {
                        backdrop.parentNode.removeChild(backdrop);
                    }
                }, 300);
                resolve(result);
            }
            
            cancelBtn.addEventListener('click', () => cleanup(false));
            deleteBtn.addEventListener('click', () => cleanup(true));
            
            // Close on backdrop click
            backdrop.addEventListener('click', (e) => {
                if (e.target === backdrop) {
                    cleanup(false);
                }
            });
            
            // Close on escape key
            const escapeHandler = (e) => {
                if (e.key === 'Escape') {
                    document.removeEventListener('keydown', escapeHandler);
                    cleanup(false);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        });
    }
    
    // Handle game action (join/leave)
    async function handleGameAction(gameId, action) {
        if (action === 'view') {
            // TODO: Implement view past game functionality
            showInfo('View past game functionality coming soon!');
            return;
        }
        
        // Get game details from the DOM for personalized message
        const gameElement = document.querySelector(`[data-game-id="${gameId}"]`);
        let gameDescription = 'pickup game';
        let gameDate = '';
        let gameTime = '';
        
        if (gameElement) {
            const titleElement = gameElement.querySelector('h3');
            const dateTimeElement = gameElement.querySelector('.text-sm.text-gray-600');
            
            if (titleElement) {
                gameDescription = titleElement.textContent.trim();
            }
            
            if (dateTimeElement) {
                const dateTimeText = dateTimeElement.textContent.trim();
                // Extract date and time from "Monday, Jan 15 at 6:30 PM" format
                const parts = dateTimeText.split(' at ');
                if (parts.length === 2) {
                    gameDate = parts[0];
                    gameTime = parts[1];
                }
            }
        }
        
        try {
            let url, method, successMessage;
            
            if (action === 'join') {
                url = `/api/pickup-games/${gameId}/join`;
                method = 'POST';
                successMessage = `You just joined "${gameDescription}" at ${gameDate} ${gameTime}`;
            } else if (action === 'leave') {
                url = `/api/pickup-games/${gameId}/leave`;
                method = 'DELETE';
                successMessage = `You just left "${gameDescription}" at ${gameDate} ${gameTime}`;
            } else {
                showError('Invalid action');
                return;
            }
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                if (action === 'leave') {
                    showLeaveSuccess(successMessage);
                } else {
                    showSuccess(successMessage);
                }
                // Reload games to update counts and button states
                setTimeout(() => loadPickupGames(), 1000);
            } else {
                showError(result.error || `Failed to ${action} pickup game`);
            }
        } catch (error) {
            console.error(`Error ${action}ing pickup game:`, error);
            showError('Network error. Please try again.');
        }
    }
    
    // Show error message
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 left-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
        errorDiv.style.zIndex = '1000';
        errorDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="font-medium">${message}</span>
                <button onclick="this.parentNode.parentNode.remove()" class="ml-auto">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add entrance animation
        errorDiv.style.transform = 'translateY(-20px)';
        errorDiv.style.opacity = '0';
        
        document.body.appendChild(errorDiv);
        
        // Trigger entrance animation
        setTimeout(() => {
            errorDiv.style.transform = 'translateY(0)';
            errorDiv.style.opacity = '1';
        }, 10);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.style.transform = 'translateY(-20px)';
                errorDiv.style.opacity = '0';
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.parentNode.removeChild(errorDiv);
                    }
                }, 300);
            }
        }, 5000);
    }
    
    // Show success message
    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 left-4 right-4 bg-green-500 text-white p-6 rounded-lg shadow-xl z-50 transform transition-all duration-300';
        successDiv.style.zIndex = '9999';  // Much higher z-index
        successDiv.style.position = 'fixed';
        successDiv.style.top = '1rem';
        successDiv.style.left = '1rem';
        successDiv.style.right = '1rem';
        successDiv.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
        successDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas fa-check-circle text-2xl text-green-200"></i>
                <span class="font-semibold text-lg flex-1">${message}</span>
                <button onclick="this.parentNode.parentNode.remove()" class="ml-2 text-green-200 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        `;
        
        // Add entrance animation
        successDiv.style.transform = 'translateY(-50px) scale(0.9)';
        successDiv.style.opacity = '0';
        
        document.body.appendChild(successDiv);
        
        // Trigger entrance animation
        setTimeout(() => {
            successDiv.style.transform = 'translateY(0) scale(1)';
            successDiv.style.opacity = '1';
        }, 10);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.style.transform = 'translateY(-50px) scale(0.9)';
                successDiv.style.opacity = '0';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }
        }, 4000);
    }
    
    // Show info message
    function showInfo(message) {
        const infoDiv = document.createElement('div');
        infoDiv.className = 'fixed top-4 left-4 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300';
        infoDiv.style.zIndex = '1000';
        infoDiv.innerHTML = `
            <div class="flex items-center gap-2">
                <i class="fas fa-info-circle"></i>
                <span class="font-medium">${message}</span>
                <button onclick="this.parentNode.parentNode.remove()" class="ml-auto">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        // Add entrance animation
        infoDiv.style.transform = 'translateY(-20px)';
        infoDiv.style.opacity = '0';
        
        document.body.appendChild(infoDiv);
        
        // Trigger entrance animation
        setTimeout(() => {
            infoDiv.style.transform = 'translateY(0)';
            infoDiv.style.opacity = '1';
        }, 10);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (infoDiv.parentNode) {
                infoDiv.style.transform = 'translateY(-20px)';
                infoDiv.style.opacity = '0';
                setTimeout(() => {
                    if (infoDiv.parentNode) {
                        infoDiv.parentNode.removeChild(infoDiv);
                    }
                }, 300);
            }
        }, 3000);
    }

    // Show success message for leaving games (red background) - mirrors showSuccess exactly
    function showLeaveSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 left-4 right-4 bg-red-500 text-white p-6 rounded-lg shadow-xl z-50 transform transition-all duration-300';
        successDiv.style.zIndex = '9999';  // Same high z-index as join message
        successDiv.style.position = 'fixed';
        successDiv.style.top = '1rem';
        successDiv.style.left = '1rem';
        successDiv.style.right = '1rem';
        successDiv.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
        successDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas fa-check-circle text-2xl text-red-200"></i>
                <span class="font-semibold text-lg flex-1">${message}</span>
                <button onclick="this.parentNode.parentNode.remove()" class="ml-2 text-red-200 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        `;
        
        // Add entrance animation - same as join message
        successDiv.style.transform = 'translateY(-50px) scale(0.9)';
        successDiv.style.opacity = '0';
        
        document.body.appendChild(successDiv);
        
        // Trigger entrance animation
        setTimeout(() => {
            successDiv.style.transform = 'translateY(0) scale(1)';
            successDiv.style.opacity = '1';
        }, 10);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.style.transform = 'translateY(-50px) scale(0.9)';
                successDiv.style.opacity = '0';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }
        }, 4000);
    }

    // Show success message for deleting games (orange background)
    function showDeleteSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 left-4 right-4 bg-orange-500 text-white p-6 rounded-lg shadow-xl z-50 transform transition-all duration-300';
        successDiv.style.zIndex = '9999';
        successDiv.style.position = 'fixed';
        successDiv.style.top = '1rem';
        successDiv.style.left = '1rem';
        successDiv.style.right = '1rem';
        successDiv.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
        successDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas fa-trash text-2xl text-orange-200"></i>
                <span class="font-semibold text-lg flex-1">${message}</span>
                <button onclick="this.parentNode.parentNode.remove()" class="ml-2 text-orange-200 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        `;
        
        // Add entrance animation
        successDiv.style.transform = 'translateY(-50px) scale(0.9)';
        successDiv.style.opacity = '0';
        
        document.body.appendChild(successDiv);
        
        // Trigger entrance animation
        setTimeout(() => {
            successDiv.style.transform = 'translateY(0) scale(1)';
            successDiv.style.opacity = '1';
        }, 10);
        
        // Auto-remove after 4 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.style.transform = 'translateY(-50px) scale(0.9)';
                successDiv.style.opacity = '0';
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                    }
                }, 300);
            }
        }, 4000);
    }

    // Initialize page
    function initializePage() {
        setupEventListeners();
        initializeNotificationToggle();
        loadPickupGames();
        console.log('Pickup games page initialized');
    }

    // Setup event listeners
    function setupEventListeners() {
        // Modal listeners
        if (closeGameModal) {
            closeGameModal.addEventListener('click', () => {
                gameDetailsModal.classList.add('hidden');
            });
        }
        
        // Close modal when clicking outside
        if (gameDetailsModal) {
            gameDetailsModal.addEventListener('click', (e) => {
                if (e.target === gameDetailsModal) {
                    gameDetailsModal.classList.add('hidden');
                }
            });
        }
        
        // Game action buttons (join/view) - use event delegation for dynamically created content
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('game-action-btn') || e.target.closest('.game-action-btn')) {
                const button = e.target.classList.contains('game-action-btn') ? e.target : e.target.closest('.game-action-btn');
                const gameId = parseInt(button.dataset.gameId);
                const action = button.dataset.action;
                
                if (gameId && action && !button.disabled) {
                    handleGameAction(gameId, action);
                }
            }
        });
        
        // Game edit buttons - use event delegation for dynamically created content
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('game-edit-btn') || e.target.closest('.game-edit-btn')) {
                const button = e.target.classList.contains('game-edit-btn') ? e.target : e.target.closest('.game-edit-btn');
                const gameId = parseInt(button.dataset.gameId);
                
                if (gameId) {
                    handleGameEdit(gameId);
                }
            }
        });
        
        // Game delete buttons - use event delegation for dynamically created content
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('game-delete-btn') || e.target.closest('.game-delete-btn')) {
                const button = e.target.classList.contains('game-delete-btn') ? e.target : e.target.closest('.game-delete-btn');
                const gameId = parseInt(button.dataset.gameId);
                const gameDescription = button.dataset.gameDescription;
                const gameDate = button.dataset.gameDate;
                const gameTime = button.dataset.gameTime;
                
                if (gameId && gameDescription) {
                    handleGameDelete(gameId, gameDescription, gameDate, gameTime);
                }
            }
        });
    }

    // Initialize the page
    initializePage();
    
    // Add global test functions for easy console testing
    window.testSuccess = function() {
        showSuccess('✅ Test Success: You just joined "Saturday Morning Game" at Saturday, Jul 13 8:00 AM');
    };
    
    window.testError = function() {
        showError('❌ Test Error: Game is full - you cannot join this game');
    };
    
    window.testInfo = function() {
        showInfo('ℹ️ Test Info: View past game functionality coming soon!');
    };
    
    window.testLeave = function() {
        showLeaveSuccess('🔴 Test Leave: You just left "Saturday Morning Game" at Saturday, Jul 13 8:00 AM');
    };
    
    window.testDelete = function() {
        showDeleteSuccess('🗑️ Test Delete: Successfully deleted pickup game "Saturday Morning Game" and removed 3 participant(s)');
    };
    
    console.log('🔧 Global test functions available:');
    console.log('   testSuccess() - Test green join message');
    console.log('   testLeave() - Test red leave message');
    console.log('   testDelete() - Test orange delete message');
    console.log('   testError() - Test error message');
    console.log('   testInfo() - Test info message');
});
</script>
{% endblock %} 