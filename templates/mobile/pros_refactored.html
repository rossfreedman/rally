{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center shadow-lg" style="background: #10645c !important;">
                <i class="fas fa-users-cog text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">Pros Dashboard</h1>
                <p class="text-sm text-gray-500">Manage team practices and player availability</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">
        
        <!-- League, Club and Team Selection Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-filter text-green-500 mr-2"></i>
                    Select League, Club & Team
                </h2>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label for="leagueSelect" class="block text-sm font-medium text-gray-700 mb-2">League</label>
                    <select class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition appearance-none" id="leagueSelect">
                        <option value="">Choose a league...</option>
                    </select>
                </div>
                
                <div>
                    <label for="clubSelect" class="block text-sm font-medium text-gray-700 mb-2">Club</label>
                    <select class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition appearance-none" id="clubSelect" disabled>
                        <option value="">Choose a club...</option>
                    </select>
                </div>
                
                <div>
                    <label for="teamSelect" class="block text-sm font-medium text-gray-700 mb-2">Team</label>
                    <select class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition appearance-none" id="teamSelect" disabled>
                        <option value="">Choose a team...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Team Practices Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                    Team Practices
                </h2>
            </div>
            
            <div class="p-6">
                <!-- Loading Spinner -->
                <div class="loading-spinner" id="practicesLoading" style="display: none;">
                    <div class="flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                        <span class="ml-3 text-gray-600">Loading...</span>
                    </div>
                </div>
                
                <!-- Practice Date Selection -->
                <div id="practiceDateSection" style="display: none;" class="mb-6">
                    <label for="practiceDateSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Practice Date</label>
                    <select class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition appearance-none" id="practiceDateSelect">
                        <option value="">Choose a practice date...</option>
                    </select>
                </div>
                
                <!-- Practices Content -->
                <div id="practicesContent">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-4"></i>
                        <p>Select a team to view practices</p>
                    </div>
                </div>
                
                <!-- Player Availability Section -->
                <div id="playerAvailabilitySection" style="display: none;" class="mt-6">
                    <div class="loading-spinner" id="playerAvailabilityLoading" style="display: none;">
                        <div class="flex justify-center items-center py-4">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                            <span class="ml-2 text-gray-600">Loading availability...</span>
                        </div>
                    </div>
                    <div id="playerAvailabilityContent">
                        <!-- Player availability will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let currentLeagueId = null;
    let currentClubId = null;
    let currentTeamId = null;
    let leaguesData = [];
    let clubsData = [];
    let teamsData = [];
    let teamDetailsData = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Pros Dashboard initialized');
        loadLeagues();
    });

    // Load leagues for the picklist
    async function loadLeagues() {
        try {
            console.log('Loading leagues...');
            const response = await fetch('/api/pros-leagues');
            const data = await response.json();
            
            if (data.success) {
                leaguesData = data.leagues;
                populateLeagueSelect();
                console.log('Leagues loaded:', leaguesData);
            } else {
                console.error('Failed to load leagues:', data.error);
                showError('Failed to load leagues');
            }
        } catch (error) {
            console.error('Error loading leagues:', error);
            showError('Error loading leagues');
        }
    }

    // Populate league select dropdown
    function populateLeagueSelect() {
        const leagueSelect = document.getElementById('leagueSelect');
        leagueSelect.innerHTML = '<option value="">Choose a league...</option>';
        
        leaguesData.forEach(league => {
            const option = document.createElement('option');
            option.value = league.id;
            option.textContent = league.name;
            leagueSelect.appendChild(option);
        });
    }

    // Load clubs for the selected league
    async function loadClubs() {
        if (!currentLeagueId) {
            console.log('No league selected, cannot load clubs');
            return;
        }
        
        try {
            console.log('Loading clubs for league:', currentLeagueId);
            const response = await fetch(`/api/pros-clubs?league_id=${currentLeagueId}`);
            const data = await response.json();
            
            if (data.success) {
                clubsData = data.clubs;
                populateClubSelect();
                console.log('Clubs loaded:', clubsData);
            } else {
                console.error('Failed to load clubs:', data.error);
                showError('Failed to load clubs');
            }
        } catch (error) {
            console.error('Error loading clubs:', error);
            showError('Error loading clubs');
        }
    }

    // Populate club select dropdown
    function populateClubSelect() {
        const clubSelect = document.getElementById('clubSelect');
        clubSelect.innerHTML = '<option value="">Choose a club...</option>';
        
        clubsData.forEach(club => {
            const option = document.createElement('option');
            option.value = club.id;
            option.textContent = club.name;
            clubSelect.appendChild(option);
        });
    }

    // Handle league selection change
    document.getElementById('leagueSelect').addEventListener('change', function() {
        const leagueId = this.value;
        if (leagueId) {
            currentLeagueId = leagueId;
            loadClubs();
            // Reset club and team selections
            document.getElementById('clubSelect').disabled = false;
            document.getElementById('clubSelect').innerHTML = '<option value="">Choose a club...</option>';
            document.getElementById('teamSelect').disabled = true;
            document.getElementById('teamSelect').innerHTML = '<option value="">Choose a team...</option>';
            // Clear team details
            clearTeamDetails();
        } else {
            currentLeagueId = null;
            document.getElementById('clubSelect').disabled = true;
            document.getElementById('clubSelect').innerHTML = '<option value="">Choose a club...</option>';
            document.getElementById('teamSelect').disabled = true;
            document.getElementById('teamSelect').innerHTML = '<option value="">Choose a team...</option>';
            clearTeamDetails();
        }
    });

    // Handle club selection change
    document.getElementById('clubSelect').addEventListener('change', function() {
        const clubId = this.value;
        if (clubId) {
            currentClubId = clubId;
            loadTeamsByClub(clubId);
            // Reset team selection
            document.getElementById('teamSelect').disabled = false;
            document.getElementById('teamSelect').innerHTML = '<option value="">Choose a team...</option>';
            // Clear team details
            clearTeamDetails();
        } else {
            currentClubId = null;
            document.getElementById('teamSelect').disabled = true;
            document.getElementById('teamSelect').innerHTML = '<option value="">Choose a team...</option>';
            clearTeamDetails();
        }
    });

    // Load teams for selected club
    async function loadTeamsByClub(clubId) {
        if (!currentLeagueId) {
            console.log('No league selected, cannot load teams');
            return;
        }
        
        try {
            console.log('Loading teams for club:', clubId, 'league:', currentLeagueId);
            const response = await fetch(`/api/pros-teams-by-club?club_id=${clubId}&league_id=${currentLeagueId}`);
            const data = await response.json();
            
            if (data.success) {
                teamsData = data.teams;
                populateTeamSelect();
                console.log('Teams loaded:', teamsData);
            } else {
                console.error('Failed to load teams:', data.error);
                showError('Failed to load teams');
            }
        } catch (error) {
            console.error('Error loading teams:', error);
            showError('Error loading teams');
        }
    }

    // Populate team select dropdown
    function populateTeamSelect() {
        const teamSelect = document.getElementById('teamSelect');
        teamSelect.innerHTML = '<option value="">Choose a team...</option>';
        
        teamsData.forEach(team => {
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.display_name;
            teamSelect.appendChild(option);
        });
    }

    // Handle team selection change
    document.getElementById('teamSelect').addEventListener('change', function() {
        const teamId = this.value;
        if (teamId) {
            currentTeamId = teamId;
            loadTeamDetails(teamId);
        } else {
            currentTeamId = null;
            clearTeamDetails();
        }
    });

    // Load team details (practices and players)
    async function loadTeamDetails(teamId) {
        if (!currentLeagueId) {
            console.log('No league selected, cannot load team details');
            return;
        }
        
        try {
            console.log('Loading team details for team:', teamId, 'league:', currentLeagueId);
            showLoading('practicesLoading');
            
            const response = await fetch(`/api/pros-team-details?team_id=${teamId}&league_id=${currentLeagueId}`);
            const data = await response.json();
            
            if (data.success) {
                teamDetailsData = data;
                displayTeamDetails(data);
                console.log('Team details loaded:', data);
            } else {
                console.error('Failed to load team details:', data.error);
                showError('Failed to load team details');
            }
        } catch (error) {
            console.error('Error loading team details:', error);
            showError('Error loading team details');
        } finally {
            hideLoading('practicesLoading');
        }
    }

    // Display team details (practices and players)
    function displayTeamDetails(data) {
        const practicesContent = document.getElementById('practicesContent');
        const practiceDateSection = document.getElementById('practiceDateSection');
        const playerAvailabilitySection = document.getElementById('playerAvailabilitySection');
        
        // Always show practice date section if there are practices
        if (data.practices.length > 0) {
            practiceDateSection.style.display = 'block';
            populatePracticeDateSelect(data.practices);
        } else {
            practiceDateSection.style.display = 'none';
        }
        
        // Show team players info
        let practicesHtml = `
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-calendar-alt text-green-500 mr-2"></i>
                    Practices for ${data.team.display_name}
                </h3>
                ${data.practices.length === 0 ? 
                    '<p class="text-red-500 mt-2">No practices scheduled</p>' : 
                    ''
                }
            </div>
        `;

        // Add players section
        if (data.players.length > 0) {
            practicesHtml += `
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-4">
                        <i class="fas fa-users text-green-500 mr-2"></i>
                        Team Players (${data.players.length})
                    </h3>
                </div>
            `;

            data.players.forEach(player => {
                practicesHtml += `
                    <div class="bg-gray-50 rounded-lg p-4 mb-3 border border-gray-200" id="player-${player.tenniscores_player_id}">
                        <div class="flex justify-between items-center">
                            <div>
                                <h6 class="font-medium text-gray-900">${player.full_name}</h6>
                            </div>
                            <div id="availability-${player.tenniscores_player_id}" class="availability-status">
                                <!-- Availability will be shown here when practice date is selected -->
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        practicesContent.innerHTML = practicesHtml;
    }

    // Populate practice date select dropdown
    function populatePracticeDateSelect(practices) {
        const practiceDateSelect = document.getElementById('practiceDateSelect');
        practiceDateSelect.innerHTML = '<option value="">Choose a practice date...</option>';

        // Get unique practice dates
        const uniqueDates = [...new Set(practices.map(practice => practice.date))];
        
        uniqueDates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            
            // Parse the date string directly to avoid timezone issues
            const [year, month, day] = date.split('-');
            const practiceDate = new Date(year, month - 1, day); // month is 0-indexed
            const formattedDate = practiceDate.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
            
            option.textContent = formattedDate;
            practiceDateSelect.appendChild(option);
        });
    }

    // Handle practice date selection change
    document.getElementById('practiceDateSelect').addEventListener('change', function() {
        const practiceDate = this.value;
        if (practiceDate && currentTeamId) {
            loadPlayerAvailability(currentTeamId, practiceDate);
        } else {
            hidePlayerAvailability();
        }
    });

    // Load player availability for selected practice date
    async function loadPlayerAvailability(teamId, practiceDate) {
        if (!currentLeagueId) {
            console.log('No league selected, cannot load player availability');
            return;
        }
        
        try {
            console.log('Loading player availability for team:', teamId, 'date:', practiceDate, 'league:', currentLeagueId);
            showLoading('playerAvailabilityLoading');
            
            const response = await fetch(`/api/pros-player-availability?team_id=${teamId}&practice_date=${practiceDate}&league_id=${currentLeagueId}`);
            const data = await response.json();
            
            if (data.success) {
                displayPlayerAvailability(data.availability, practiceDate);
                console.log('Player availability loaded:', data.availability);
            } else {
                console.error('Failed to load player availability:', data.error);
                showError('Failed to load player availability');
            }
        } catch (error) {
            console.error('Error loading player availability:', error);
            showError('Error loading player availability');
        } finally {
            hideLoading('playerAvailabilityLoading');
        }
    }

    // Display player availability
    function displayPlayerAvailability(availability, practiceDate) {
        // Clear all existing availability status
        const allAvailabilityElements = document.querySelectorAll('.availability-status');
        allAvailabilityElements.forEach(element => {
            element.innerHTML = '';
        });
        
        if (availability.length === 0) {
            // Show "No availability data" message in the practices content
            const practicesContent = document.getElementById('practicesContent');
            const noDataMessage = document.createElement('div');
            noDataMessage.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
            noDataMessage.innerHTML = '<div class="flex items-center"><i class="fas fa-info-circle text-blue-500 mr-2"></i><span class="text-blue-700">No availability data found for this practice date</span></div>';
            practicesContent.appendChild(noDataMessage);
            return;
        }

        // Parse the date string directly to avoid timezone issues
        const [year, month, day] = practiceDate.split('-');
        const practiceDateObj = new Date(year, month - 1, day); // month is 0-indexed
        const formattedDate = practiceDateObj.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });

        // Create a map of availability data for quick lookup
        const availabilityMap = {};
        availability.forEach(player => {
            availabilityMap[player.tenniscores_player_id] = player;
        });
        
        // Update each player's availability status (including those without data)
        const allPlayerCards = document.querySelectorAll('[id^="player-"]');
        allPlayerCards.forEach(playerCard => {
            const playerId = playerCard.id.replace('player-', '');
            const availabilityElement = document.getElementById(`availability-${playerId}`);
            
            if (availabilityElement) {
                const playerData = availabilityMap[playerId];
                if (playerData) {
                    // Player has availability data
                    const statusClass = getAvailabilityStatusClass(playerData.availability_status);
                    const statusText = getAvailabilityStatusText(playerData.availability_status);
                    const statusIcon = getAvailabilityStatusIcon(playerData.availability_status);
                    
                    availabilityElement.innerHTML = `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                            <i class="${statusIcon} mr-1"></i>${statusText}
                        </span>
                        ${playerData.notes ? `<div class="mt-2 text-xs text-gray-600"><i class="fas fa-sticky-note mr-1"></i>${playerData.notes}</div>` : ''}
                    `;
                } else {
                    // Player has no availability data - show "Not entered"
                    const statusClass = getAvailabilityStatusClass(null);
                    const statusText = getAvailabilityStatusText(null);
                    const statusIcon = getAvailabilityStatusIcon(null);
                    
                    availabilityElement.innerHTML = `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusClass}">
                            <i class="${statusIcon} mr-1"></i>${statusText}
                        </span>
                    `;
                }
            }
        });

        // Show a header for the selected practice date just below team players
        const existingHeader = document.getElementById('practice-date-header');
        if (existingHeader) {
            existingHeader.remove();
        }
        
        // Find the team players section by looking for the text "Team Players"
        const allSectionLabels = document.querySelectorAll('h3');
        let teamPlayersSection = null;
        for (let section of allSectionLabels) {
            if (section.textContent.includes('Team Players')) {
                teamPlayersSection = section;
                break;
            }
        }
        
        if (teamPlayersSection) {
            const header = document.createElement('div');
            header.id = 'practice-date-header';
            header.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
            header.innerHTML = `<div class="flex items-center"><i class="fas fa-calendar-check text-blue-500 mr-2"></i><span class="text-blue-700 font-medium">Availability for ${formattedDate}</span></div>`;
            
            // Insert after the team players section
            teamPlayersSection.parentNode.insertBefore(header, teamPlayersSection.nextSibling);
        }
    }

    // Get availability status CSS class
    function getAvailabilityStatusClass(status) {
        const statusClasses = {
            1: 'bg-green-100 text-green-800',      // Available
            2: 'bg-red-100 text-red-800',          // Unavailable
            3: 'bg-yellow-100 text-yellow-800',    // Not sure
            null: 'bg-gray-100 text-gray-800',      // Not entered
            undefined: 'bg-gray-100 text-gray-800'  // Not entered
        };
        return statusClasses[status] || 'bg-gray-100 text-gray-800';
    }

    // Get availability status text
    function getAvailabilityStatusText(status) {
        const statusTexts = {
            1: 'Available',
            2: 'Unavailable', 
            3: 'Not Sure',
            null: 'Not entered',
            undefined: 'Not entered'
        };
        return statusTexts[status] || 'Not entered';
    }

    // Get availability status icon
    function getAvailabilityStatusIcon(status) {
        const statusIcons = {
            1: 'fas fa-check',
            2: 'fas fa-times',
            3: 'fas fa-question',
            null: 'fas fa-minus',
            undefined: 'fas fa-minus'
        };
        return statusIcons[status] || 'fas fa-minus';
    }

    // Hide player availability section
    function hidePlayerAvailability() {
        const playerAvailabilitySection = document.getElementById('playerAvailabilitySection');
        playerAvailabilitySection.style.display = 'none';
    }

    // Clear team details
    function clearTeamDetails() {
        const practicesContent = document.getElementById('practicesContent');
        const practiceDateSection = document.getElementById('practiceDateSection');
        const playerAvailabilitySection = document.getElementById('playerAvailabilitySection');
        
        practicesContent.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-4"></i>
                <p>Select a team to view practices</p>
            </div>
        `;
        practiceDateSection.style.display = 'none';
        playerAvailabilitySection.style.display = 'none';
        teamDetailsData = null;
    }

    // Show loading spinner
    function showLoading(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = 'block';
        }
    }

    // Hide loading spinner
    function hideLoading(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = 'none';
        }
    }

    // Show error message
    function showError(message) {
        console.error(message);
        // You can add a toast notification here if needed
    }
</script>
{% endblock %}