{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-amber-600 rounded-full flex items-center justify-center shadow-sm" style="background-color: #d97706 !important;">
                <i class="fas fa-clipboard-list text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">Create Lineup</h1>
                <p class="text-sm text-gray-500">Step-by-step lineup creation wizard</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">

        <!-- Lineup Method Choice -->
        <div id="choice-page" class="wizard-page">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-route text-blue-500 mr-2"></i>
                        Choose Lineup Method
                    </h2>
                </div>
                
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-6">How would you like to create your lineup?</p>
                    
                    <div class="space-y-4">
                        <!-- AI Option -->
                        <button id="choose-ai" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 text-left">
                            <div class="flex items-center">
                                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-magic text-white text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">AI-Generated Lineup</h3>
                                    <p class="text-white/90 text-sm">Let AI create the optimal lineup based on player stats, court preferences, and your custom instructions.</p>
                                    <p class="text-white/80 text-xs mt-2">‚ú® Recommended for strategic optimization</p>
                                </div>
                            </div>
                        </button>

                        <!-- Manual Option -->
                        <button id="choose-manual" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 text-left">
                            <div class="flex items-center">
                                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-hand-paper text-white text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">Manual Drag & Drop</h3>
                                    <p class="text-white/90 text-sm">Build your lineup manually by dragging players onto courts. Full control over court assignments.</p>
                                    <p class="text-white/80 text-xs mt-2">üéØ Perfect for specific strategy needs</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Lineup Builder -->
        <div id="manual-page" class="wizard-page hidden">
            <div class="flex justify-between mb-4">
                <button id="manual-back" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-semibold">
                    ‚Üê Back to Choice
                </button>
                <button id="manual-send" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Send Lineup ‚Üí
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-hand-paper text-green-500 mr-2"></i>
                        Manual Lineup Builder
                    </h2>
                </div>
                
                <div class="p-6">
                    <!-- Available Players Pool -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-3 text-gray-900">Available Players</h3>
                        <p class="text-sm text-gray-600 mb-3">Drag players from here to the courts below:</p>
                        <div id="available-players-pool" class="min-h-24 bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg p-4">
                            <div class="text-gray-400 text-center" id="loading-players">Loading players...</div>
                        </div>
                    </div>

                    <!-- Courts -->
                    <div class="space-y-4">
                        <h3 class="font-semibold text-gray-900">Courts</h3>
                        
                        <!-- Court 1 -->
                        <div class="court-container bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-volleyball-ball text-blue-500 mr-2"></i>
                                Court 1
                            </h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="court-position bg-white border-2 border-dashed border-blue-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="1" data-position="1">
                                    Drop Player 1 Here
                                </div>
                                <div class="court-position bg-white border-2 border-dashed border-blue-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="1" data-position="2">
                                    Drop Player 2 Here
                                </div>
                            </div>
                        </div>

                        <!-- Court 2 -->
                        <div class="court-container bg-green-50 border-2 border-green-200 rounded-lg p-4">
                            <h4 class="font-medium text-green-800 mb-3 flex items-center">
                                <i class="fas fa-volleyball-ball text-green-500 mr-2"></i>
                                Court 2
                            </h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="court-position bg-white border-2 border-dashed border-green-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="2" data-position="1">
                                    Drop Player 1 Here
                                </div>
                                <div class="court-position bg-white border-2 border-dashed border-green-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="2" data-position="2">
                                    Drop Player 2 Here
                                </div>
                            </div>
                        </div>

                        <!-- Court 3 -->
                        <div class="court-container bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                            <h4 class="font-medium text-yellow-800 mb-3 flex items-center">
                                <i class="fas fa-volleyball-ball text-yellow-500 mr-2"></i>
                                Court 3
                            </h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="court-position bg-white border-2 border-dashed border-yellow-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="3" data-position="1">
                                    Drop Player 1 Here
                                </div>
                                <div class="court-position bg-white border-2 border-dashed border-yellow-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="3" data-position="2">
                                    Drop Player 2 Here
                                </div>
                            </div>
                        </div>

                        <!-- Court 4 -->
                        <div class="court-container bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                            <h4 class="font-medium text-purple-800 mb-3 flex items-center">
                                <i class="fas fa-volleyball-ball text-purple-500 mr-2"></i>
                                Court 4
                            </h4>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="court-position bg-white border-2 border-dashed border-purple-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="4" data-position="1">
                                    Drop Player 1 Here
                                </div>
                                <div class="court-position bg-white border-2 border-dashed border-purple-300 rounded-lg p-3 min-h-16 flex items-center justify-center text-gray-400 text-sm" data-court="4" data-position="2">
                                    Drop Player 2 Here
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lineup Summary -->
                    <div id="manual-lineup-summary" class="mt-6 bg-gray-50 rounded-lg p-4 hidden">
                        <h4 class="font-semibold text-gray-900 mb-3">Lineup Summary</h4>
                        <div id="manual-lineup-text" class="text-sm text-gray-700 whitespace-pre-line font-mono"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Progress Flow (for AI mode) -->
        <div id="ai-progress" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-route text-blue-500 mr-2"></i>
                    AI Lineup Progress
                </h2>
            </div>
            
            <div class="p-6">
                <div class="flex items-center justify-between">
    <!-- Step 1 -->
    <div class="flex flex-col items-center flex-1">
      <div class="bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold text-blue-600 shadow-md mb-2 border-2 border-blue-300">1</div>
      <div id="step1-card" class="bg-blue-500 rounded-xl p-4 shadow-lg transform transition-all duration-300 scale-105 border-2 border-blue-300 w-16 h-16 flex items-center justify-center">
        <i class="fas fa-users text-white text-2xl"></i>
      </div>
      <div class="text-xs text-center mt-2 font-semibold text-blue-600 max-w-20">
        <div>Select</div>
        <div>Players</div>
      </div>
    </div>
    
    <!-- Arrow 1 -->
    <div class="flex-shrink-0 mx-2">
      <i class="fas fa-chevron-right text-blue-400 text-lg"></i>
    </div>
    
    <!-- Step 2 -->
    <div class="flex flex-col items-center flex-1">
      <div class="bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold text-gray-600 shadow-md mb-2 border-2 border-gray-300">2</div>
      <div id="step2-card" class="bg-gray-200 rounded-xl p-4 shadow-lg transform transition-all duration-300 w-16 h-16 flex items-center justify-center">
        <i class="fas fa-clipboard-check text-gray-600 text-2xl"></i>
      </div>
      <div class="text-xs text-center mt-2 font-semibold text-gray-500 max-w-20">
        <div>Add</div>
        <div>Instructions</div>
      </div>
    </div>
    
    <!-- Arrow 2 -->
    <div class="flex-shrink-0 mx-2">
      <i class="fas fa-chevron-right text-gray-300 text-lg"></i>
    </div>
    
    <!-- Step 3 -->
    <div class="flex flex-col items-center flex-1">
      <div class="bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold text-gray-600 shadow-md mb-2 border-2 border-gray-300">3</div>
      <div id="step3-card" class="bg-gray-200 rounded-xl p-4 shadow-lg transform transition-all duration-300 w-16 h-16 flex items-center justify-center">
        <i class="fas fa-magic text-gray-600 text-2xl"></i>
      </div>
      <div class="text-xs text-center mt-2 font-semibold text-gray-500 max-w-20">
        <div>Generate</div>
        <div>Lineup</div>
      </div>
    </div>
    
    <!-- Arrow 3 -->
    <div class="flex-shrink-0 mx-2">
      <i class="fas fa-chevron-right text-gray-300 text-lg"></i>
    </div>
    
    <!-- Step 4 -->
    <div class="flex flex-col items-center flex-1">
      <div class="bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold text-gray-600 shadow-md mb-2 border-2 border-gray-300">4</div>
      <div id="step4-card" class="bg-gray-200 rounded-xl p-4 shadow-lg transform transition-all duration-300 w-16 h-16 flex items-center justify-center">
        <i class="fas fa-paper-plane text-gray-600 text-2xl"></i>
      </div>
      <div class="text-xs text-center mt-2 font-semibold text-gray-500 max-w-20">
        <div>Send to</div>
        <div>Team</div>
      </div>
                </div>
            </div>
        </div>

        <!-- Page 1: Select Available Players -->
        <div id="page1" class="wizard-page">
            <!-- Navigation Buttons at Top -->
            <div class="flex justify-end mb-4">
                <button id="page1-next" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-semibold">
                    Next ‚Üí
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-users text-green-500 mr-2"></i>
                        Select Available Players
                    </h2>
                </div>
                
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-4">Choose which players are available for the lineup:</p>
                    <div id="players-list" class="space-y-3">
                        <!-- Player checkboxes will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Lineup Instructions -->
        <div id="page2" class="wizard-page hidden">
            <!-- Navigation Buttons at Top -->
            <div class="flex justify-between mb-4">
                <button id="page2-prev" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-semibold">
                    ‚Üê Previous
                </button>
                <button id="page2-next" class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-semibold">
                    Next ‚Üí
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-clipboard-check text-purple-500 mr-2"></i>
                        Update Saved Lineup Instructions
                    </h2>
                </div>
                
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-4">Add any specific instructions for the AI to consider:</p>
                    
                    <ul id="instructions-list" class="mb-4 space-y-3">
                        <!-- Instructions will be loaded here -->
                    </ul>
                    
                    <div class="flex gap-3">
                        <input 
                            id="new-instruction" 
                            type="text" 
                            class="flex-1 px-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Add new instruction..." 
                        />
                        <button 
                            id="add-instruction-btn" 
                            class="bg-green-600 text-white px-4 py-3 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors font-semibold"
                        >
                            Add
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 3: Generate Lineup -->
        <div id="page3" class="wizard-page hidden">
            <!-- Navigation Buttons at Top -->
            <div class="flex justify-between mb-4">
                <button id="page3-prev" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-semibold">
                    ‚Üê Previous
                </button>
                <button id="generate-lineup-btn" class="bg-orange-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors font-semibold">
                    Generate Lineup ‚Üí
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-magic text-orange-500 mr-2"></i>
                        Generate Lineup
                    </h2>
                </div>
                
                <div class="p-6">
                    <div id="generation-controls" class="mb-4">
                        <p class="text-sm text-gray-600 mb-4">Ready to generate your optimal lineup!</p>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                            <h3 class="font-semibold mb-3 text-gray-900">Summary:</h3>
                            
                            <!-- Selected Players Section -->
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-users text-blue-500 mr-2"></i>
                                    <span class="font-medium text-gray-800">Selected Players (<span id="summary-players-count">0</span>):</span>
                                </div>
                                <div id="summary-players-list" class="text-sm text-gray-700 ml-6">
                                    <div class="text-gray-500 italic">No players selected</div>
                                </div>
                            </div>

                            <!-- Instructions Section -->
                            <div>
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-clipboard-check text-purple-500 mr-2"></i>
                                    <span class="font-medium text-gray-800">Instructions (<span id="summary-instructions-count">0</span>):</span>
                                </div>
                                <div id="summary-instructions-list" class="text-sm text-gray-700 ml-6">
                                    <div class="text-gray-500 italic">No instructions added</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="loading-indicator" class="hidden text-center py-8">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-orange-500 mx-auto mb-4"></div>
                        <p class="text-gray-600">Generating optimal lineup...</p>
                    </div>
                    
                    <div id="generated-lineup-container" class="hidden">
                        <h3 class="font-semibold mb-3 text-lg text-green-800">üèì Your Generated Lineup</h3>
                        <div class="bg-green-50 border-2 border-green-200 p-6 rounded-lg shadow-sm">
                            <pre id="generated-lineup" class="whitespace-pre-wrap text-sm leading-relaxed text-gray-800"></pre>
                        </div>
                        <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                            <p class="text-sm text-green-700 font-medium">‚úÖ Lineup successfully generated! Click "Send to Team" to share with your players.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Send Lineup -->
        <div id="page4" class="wizard-page hidden">
            <!-- Navigation Buttons at Top -->
            <div class="flex justify-between mb-4">
                <button id="page4-prev" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-semibold">
                    ‚Üê Previous
                </button>
                <button id="send-to-team" class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors font-semibold">
                    Send to Team ‚Üí
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-paper-plane text-blue-500 mr-2"></i>
                        Send Lineup to Team
                    </h2>
                </div>
                
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-6">Choose how to share the lineup with your team:</p>
                    
                    <!-- Message Preview -->
                    <div class="mb-6">
                        <h3 class="font-semibold mb-3 text-gray-900">Message Preview:</h3>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="text-sm text-gray-700">
                                <div class="font-semibold mb-2 text-gray-900">Subject: Lineup for [Match Date]</div>
                                <div id="message-preview" class="whitespace-pre-wrap"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Send Options -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <button id="send-email" class="flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-semibold">
                            <i class="fas fa-envelope"></i>
                            Send via Email
                        </button>
                        <button id="send-text" class="flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-3 rounded-lg shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors font-semibold">
                            <i class="fas fa-sms"></i>
                            Send via Text
                        </button>
                    </div>
                    
                    <!-- Additional Options -->
                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="font-semibold mb-3 text-gray-900">Additional Options:</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <button id="copy-lineup" class="flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-semibold">
                                <i class="fas fa-copy"></i>
                                Copy to Clipboard
                            </button>
                            <button id="save-lineup" class="flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-3 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-semibold">
                                <i class="fas fa-save"></i>
                                Save as Draft
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const user = window.sessionData?.user || {};
const series = user.series;
const club = user.club;
const teamId = club && series ? `${club} - ${series.split(' ').pop()}` : '';

// Wizard state
let currentPage = 0; // Start at choice page
let isAIMode = false;
let players = [];
let selectedPlayers = new Set();
let instructions = [];
let generatedLineup = '';
let manualLineup = {};

// Player position determination
function getPlayerPosition(playerName, rating) {
  // This would ideally come from the database, but for now we'll use some logic
  // Higher rated players tend to play Ad side (left side, more responsibility)
  // Lower rated players tend to play Deuce side (right side)
  
  if (rating >= 55) {
    return 'Either'; // High-rated players can play both sides
  } else if (rating >= 50) {
    return 'Ad'; // Mid-high rated players typically play Ad
  } else if (rating >= 45) {
    return 'Deuce'; // Mid-rated players typically play Deuce
  } else if (rating >= 40) {
    return 'Either'; // Lower rated players might need flexibility
  } else {
    return 'Unknown'; // Very new or unrated players
  }
}

// Enhanced wizard navigation with animations
function showPage(pageNumber) {
  // Hide all pages with fade out
  document.querySelectorAll('.wizard-page').forEach(page => {
    page.classList.add('hidden');
  });
  
  // Show appropriate page
  if (pageNumber === 0) {
    // Choice page
    document.getElementById('choice-page').classList.remove('hidden');
    document.getElementById('ai-progress').classList.add('hidden');
  } else if (pageNumber === 'manual') {
    // Manual drag-and-drop page
    document.getElementById('manual-page').classList.remove('hidden');
    document.getElementById('ai-progress').classList.add('hidden');
    loadPlayersForManual();
  } else {
    // AI pages (1-4)
    const currentPageElement = document.getElementById(`page${pageNumber}`);
    currentPageElement.classList.remove('hidden');
    document.getElementById('ai-progress').classList.remove('hidden');
    
    // Update progress indicators for AI mode
    updateProgressIndicators(pageNumber);
  }
  
  currentPage = pageNumber;
}

function updateProgressIndicators(pageNumber) {
  // Update step cards with enhanced styling
  for (let i = 1; i <= 4; i++) {
    const card = document.getElementById(`step${i}-card`);
    const labels = card.parentElement.querySelector('.text-xs');
    const numberBadge = card.parentElement.querySelector('.bg-white.rounded-full');
    const arrow = document.querySelector(`.mx-2:nth-of-type(${i})`);
    
    if (i < pageNumber) {
      // Completed steps - green with checkmark
      card.className = 'bg-green-500 rounded-xl p-4 shadow-lg transform transition-all duration-300 scale-105 border-2 border-green-300 w-16 h-16 flex items-center justify-center';
      card.innerHTML = '<i class="fas fa-check text-white text-2xl"></i>';
      numberBadge.className = 'bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold text-green-600 shadow-md mb-2 border-2 border-green-300';
      numberBadge.textContent = '‚úì';
      labels.className = 'text-xs text-center mt-2 font-semibold text-green-600 max-w-20';
      // Update arrow color to show completion
      if (arrow && i < 4) {
        const chevron = arrow.querySelector('i');
        if (chevron) chevron.className = 'fas fa-chevron-right text-green-400 text-lg';
      }
    } else if (i === pageNumber) {
      // Current step - solid colors with pulse and scale
      const solidColors = [
        'bg-blue-500 border-blue-300',
        'bg-purple-500 border-purple-300', 
        'bg-pink-500 border-pink-300',
        'bg-orange-500 border-orange-300'
      ];
      const colors = ['text-blue-600', 'text-purple-600', 'text-pink-600', 'text-orange-600'];
      const borderColors = ['border-blue-300', 'border-purple-300', 'border-pink-300', 'border-orange-300'];
      const arrowColors = ['text-blue-400', 'text-purple-400', 'text-pink-400', 'text-orange-400'];
      
      card.className = `${solidColors[i-1]} rounded-xl p-4 shadow-lg transform transition-all duration-300 scale-105 border-2 animate-pulse w-16 h-16 flex items-center justify-center`;
      numberBadge.className = `bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold ${colors[i-1]} shadow-md mb-2 border-2 ${borderColors[i-1]}`;
      numberBadge.textContent = i;
      
      const iconColors = ['text-blue-900', 'text-purple-900', 'text-pink-900', 'text-orange-900'];
      
      switch(i) {
        case 1: card.innerHTML = `<i class="fas fa-users ${iconColors[i-1]} text-2xl"></i>`; break;
        case 2: card.innerHTML = `<i class="fas fa-clipboard-check ${iconColors[i-1]} text-2xl"></i>`; break;
        case 3: card.innerHTML = `<i class="fas fa-magic ${iconColors[i-1]} text-2xl"></i>`; break;
        case 4: card.innerHTML = `<i class="fas fa-paper-plane ${iconColors[i-1]} text-2xl"></i>`; break;
      }
      labels.className = `text-xs text-center mt-2 font-semibold ${colors[i-1]} max-w-20`;
      
      // Update current arrow color
      if (arrow && i < 4) {
        const chevron = arrow.querySelector('i');
        if (chevron) chevron.className = `fas fa-chevron-right ${arrowColors[i-1]} text-lg`;
      }
    } else {
      // Future steps - gray
      card.className = 'bg-gray-200 rounded-xl p-4 shadow-lg transform transition-all duration-300 w-16 h-16 flex items-center justify-center';
      numberBadge.className = 'bg-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold text-gray-600 shadow-md mb-2 border-2 border-gray-300';
      numberBadge.textContent = i;
      
      switch(i) {
        case 1: card.innerHTML = '<i class="fas fa-users text-gray-600 text-2xl"></i>'; break;
        case 2: card.innerHTML = '<i class="fas fa-clipboard-check text-gray-600 text-2xl"></i>'; break;
        case 3: card.innerHTML = '<i class="fas fa-magic text-gray-600 text-2xl"></i>'; break;
        case 4: card.innerHTML = '<i class="fas fa-paper-plane text-gray-600 text-2xl"></i>'; break;
      }
      labels.className = 'text-xs text-center mt-2 font-semibold text-gray-500 max-w-20';
      
      // Reset arrow color
      if (arrow && i < 4) {
        const chevron = arrow.querySelector('i');
        if (chevron) chevron.className = 'fas fa-chevron-right text-gray-300 text-lg';
      }
    }
  }
}

// Page 1: Load and render players with position info
function loadPlayers() {
  fetch(`/api/players?series=${encodeURIComponent(series)}&team_id=${encodeURIComponent(teamId)}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Server error: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      players = data;
      // Select all players by default
      selectedPlayers = new Set(players.map(p => p.name));
      renderPlayers();
    })
    .catch(error => {
      console.error('Error loading players:', error);
      document.getElementById('players-list').innerHTML = `<span class="text-error">Failed to load players: ${error.message}</span>`;
    });
}

function renderPlayers() {
  const list = document.getElementById('players-list');
  list.innerHTML = '';
  players.forEach(player => {
    const id = `player-${player.name.replace(/\s+/g, '-')}`;
    const checked = selectedPlayers.has(player.name);
    const position = getPlayerPosition(player.name, player.rating);
    const positionColor = {
      'Ad': 'text-blue-600 bg-blue-100',
      'Deuce': 'text-orange-600 bg-orange-100', 
      'Either': 'text-green-600 bg-green-100',
      'Unknown': 'text-gray-600 bg-gray-100'
    }[position];
    
    const div = document.createElement('div');
    div.className = 'grid grid-cols-4 gap-4 items-center p-4 bg-white rounded-lg hover:bg-gray-50 transition-colors border border-gray-200 shadow-sm';
    div.innerHTML = `
      <div class="flex justify-center">
        <input type="checkbox" id="${id}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2" ${checked ? 'checked' : ''} />
      </div>
      <div>
        <label for="${id}" class="cursor-pointer font-medium text-base text-gray-900">${player.name}</label>
      </div>
      <div class="text-center font-semibold text-sm text-gray-900">
        ${player.rating}
      </div>
      <div class="flex justify-center">
        <div class="px-2 py-1 rounded-full text-xs font-medium ${positionColor}">
          ${position}
        </div>
      </div>
    `;
    const checkbox = div.querySelector('input');
    checkbox.checked = checked;
    checkbox.addEventListener('change', e => {
      if (e.target.checked) selectedPlayers.add(player.name);
      else selectedPlayers.delete(player.name);
      updateSummary();
    });
    list.appendChild(div);
  });
  updateSummary();
}

// Page 2: Instructions management
function loadInstructions() {
  fetch(`/api/lineup-instructions?team_id=${encodeURIComponent(teamId)}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Server error: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      instructions = data.instructions || [];
      renderInstructions();
    })
    .catch(error => {
      console.error('Error loading instructions:', error);
      document.getElementById('instructions-list').innerHTML = `<li class="text-error">Failed to load instructions: ${error.message}</li>`;
    });
}

function renderInstructions() {
  const list = document.getElementById('instructions-list');
  list.innerHTML = '';
  instructions.forEach(instr => {
    const li = document.createElement('li');
    li.className = 'flex items-center justify-between bg-gray-50 rounded-lg px-4 py-3 border border-gray-200';
    li.innerHTML = `
      <span class="flex-1 text-sm text-gray-700">${instr}</span>
      <button class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors ml-3">
        <i class="fas fa-trash"></i>
      </button>
    `;
    li.querySelector('button').onclick = () => deleteInstruction(instr);
    list.appendChild(li);
  });
  updateSummary();
}

function addInstruction() {
  const input = document.getElementById('new-instruction');
  const value = input.value.trim();
  if (!value) return;
  
  fetch(`/api/lineup-instructions`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ instruction: value, team_id: teamId })
  })
    .then(res => {
      if (!res.ok) {
        throw new Error(`Server error: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      input.value = '';
      loadInstructions();
    })
    .catch(error => {
      console.error('Error adding instruction:', error);
      alert(`Failed to add instruction: ${error.message}`);
    });
}

function deleteInstruction(instr) {
  fetch(`/api/lineup-instructions`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ instruction: instr, team_id: teamId })
  })
    .then(res => {
      if (!res.ok) {
        throw new Error(`Server error: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      loadInstructions();
    })
    .catch(error => {
      console.error('Error deleting instruction:', error);
      alert(`Failed to delete instruction: ${error.message}`);
    });
}

// Page 3: Generate lineup
function generateLineup() {
  const selected = Array.from(selectedPlayers);
  if (selected.length === 0) {
    alert('Please select at least one player.');
    return;
  }
  
  document.getElementById('generation-controls').classList.add('hidden');
  document.getElementById('loading-indicator').classList.remove('hidden');
  document.getElementById('generated-lineup-container').classList.add('hidden');
  
  fetch('/api/generate-lineup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ players: selected, instructions })
  })
    .then(res => res.json())
    .then(data => {
      document.getElementById('loading-indicator').classList.add('hidden');
      
      if (data.suggestion) {
        generatedLineup = data.suggestion;
        document.getElementById('generated-lineup').textContent = data.suggestion;
        document.getElementById('generated-lineup-container').classList.remove('hidden');
        
        // Hide the generation controls permanently after successful generation
        document.getElementById('generation-controls').classList.add('hidden');
        
        // Change the button to "Send to Team" after successful generation
        document.getElementById('generate-lineup-btn').textContent = 'Send to Team ‚Üí';
        document.getElementById('generate-lineup-btn').onclick = () => {
          updateMessagePreview();
          showPage(4);
        };
      } else {
        // Handle case where API responds but without a successful lineup
        document.getElementById('generation-controls').classList.remove('hidden');
        const container = document.getElementById('generated-lineup-container');
        container.innerHTML = `
          <h3 class="font-semibold mb-3 text-lg text-red-600">‚ùå Lineup Generation Failed</h3>
          <div class="bg-red-50 border-2 border-red-300 p-6 rounded-lg shadow-sm">
            <p class="text-red-700 text-base">${data.error || 'No lineup generated.'}</p>
          </div>
          <div class="mt-4 p-3 bg-red-50 rounded-lg border border-red-200">
            <p class="text-sm text-red-700 font-medium">‚ùå Please check your selections and try generating the lineup again.</p>
          </div>
        `;
        container.classList.remove('hidden');
      }
    })
    .catch((error) => {
      document.getElementById('loading-indicator').classList.add('hidden');
      document.getElementById('generation-controls').classList.remove('hidden');
      // Show error message without the success container styling
      document.getElementById('generated-lineup').textContent = 'Error generating lineup.';
      document.getElementById('generated-lineup-container').classList.remove('hidden');
      
      // Remove the success styling and show error styling instead
      const container = document.getElementById('generated-lineup-container');
      container.innerHTML = `
        <h3 class="font-semibold mb-3 text-lg text-red-600">‚ùå Lineup Generation Failed</h3>
        <div class="bg-red-50 border-2 border-red-300 p-6 rounded-lg shadow-sm">
          <p class="text-red-700 text-base">Error generating lineup. Please try again.</p>
        </div>
        <div class="mt-4 p-3 bg-red-50 rounded-lg border border-red-200">
          <p class="text-sm text-red-700 font-medium">‚ùå Please check your selections and try generating the lineup again.</p>
        </div>
      `;
      
      console.error('Error generating lineup:', error);
    });
}

// Page 4: Message preview and sending
function updateMessagePreview() {
  const preview = document.getElementById('message-preview');
  const message = `Hi Team!

Here's our lineup for the upcoming match:

${generatedLineup}

Please confirm your availability and let me know if you have any questions.

Thanks!
${user.first_name || 'Captain'}`;
  
  preview.textContent = message;
}

// Manual lineup functions
function loadPlayersForManual() {
  fetch(`/api/players?series=${encodeURIComponent(series)}&team_id=${encodeURIComponent(teamId)}`)
    .then(res => {
      if (!res.ok) {
        throw new Error(`Server error: ${res.status} ${res.statusText}`);
      }
      return res.json();
    })
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      players = data;
      renderPlayersForManual();
    })
    .catch(error => {
      console.error('Error loading players:', error);
      document.getElementById('available-players-pool').innerHTML = `<div class="text-red-500 text-center">Failed to load players: ${error.message}</div>`;
    });
}

function renderPlayersForManual() {
  const pool = document.getElementById('available-players-pool');
  pool.innerHTML = '';
  
  players.forEach(player => {
    const playerDiv = document.createElement('div');
    playerDiv.className = 'player-card bg-white border border-gray-200 rounded-lg p-3 m-2 inline-block cursor-move shadow-sm hover:shadow-md transition-shadow';
    playerDiv.draggable = true;
    playerDiv.dataset.playerName = player.name;
    playerDiv.dataset.playerRating = player.rating;
    
    playerDiv.innerHTML = `
      <div class="text-center">
        <div class="font-medium text-gray-900">${player.name}</div>
      </div>
    `;
    
    // Add drag event listeners
    playerDiv.addEventListener('dragstart', handleDragStart);
    playerDiv.addEventListener('dragend', handleDragEnd);
    
    // Add touch event listeners for mobile
    playerDiv.addEventListener('touchstart', handleTouchStart, { passive: false });
    playerDiv.addEventListener('touchmove', handleTouchMove, { passive: false });
    playerDiv.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    pool.appendChild(playerDiv);
  });
}

function handleDragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.dataset.playerName);
  e.target.classList.add('opacity-50');
}

function handleDragEnd(e) {
  e.target.classList.remove('opacity-50');
}

// Touch event handlers for mobile support
let touchedPlayer = null;
let touchOffset = { x: 0, y: 0 };

function handleTouchStart(e) {
  e.preventDefault();
  touchedPlayer = e.target.closest('.player-card');
  if (touchedPlayer) {
    const touch = e.touches[0];
    const rect = touchedPlayer.getBoundingClientRect();
    touchOffset.x = touch.clientX - rect.left;
    touchOffset.y = touch.clientY - rect.top;
    
    touchedPlayer.classList.add('opacity-50', 'dragging');
    
    // Create a visual feedback element
    touchedPlayer.style.position = 'fixed';
    touchedPlayer.style.zIndex = '1000';
    touchedPlayer.style.pointerEvents = 'none';
  }
}

function handleTouchMove(e) {
  if (!touchedPlayer) return;
  e.preventDefault();
  
  const touch = e.touches[0];
  touchedPlayer.style.left = (touch.clientX - touchOffset.x) + 'px';
  touchedPlayer.style.top = (touch.clientY - touchOffset.y) + 'px';
  
  // Find element under touch point
  const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  const dropZone = elementBelow?.closest('.court-position') || elementBelow?.closest('#available-players-pool');
  
  // Remove previous highlights
  document.querySelectorAll('.drop-zone-active').forEach(el => {
    el.classList.remove('drop-zone-active');
  });
  
  // Highlight current drop zone
  if (dropZone) {
    dropZone.classList.add('drop-zone-active');
  }
}

function handleTouchEnd(e) {
  if (!touchedPlayer) return;
  e.preventDefault();
  
  const touch = e.changedTouches[0];
  const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
  const dropZone = elementBelow?.closest('.court-position') || elementBelow?.closest('#available-players-pool');
  
  // Remove visual feedback
  touchedPlayer.classList.remove('opacity-50', 'dragging');
  touchedPlayer.style.position = '';
  touchedPlayer.style.left = '';
  touchedPlayer.style.top = '';
  touchedPlayer.style.zIndex = '';
  touchedPlayer.style.pointerEvents = '';
  
  // Remove highlights
  document.querySelectorAll('.drop-zone-active').forEach(el => {
    el.classList.remove('drop-zone-active');
  });
  
  // Handle drop
  if (dropZone) {
    const playerName = touchedPlayer.dataset.playerName;
    
    if (dropZone.id === 'available-players-pool') {
      // Dropping back to pool
      if (touchedPlayer.parentElement.classList.contains('court-position')) {
        movePlayerToPool(touchedPlayer);
      }
    } else if (dropZone.classList.contains('court-position')) {
      // Dropping to court position
      const court = dropZone.dataset.court;
      const position = dropZone.dataset.position;
      
      // Check if position is already occupied
      if (dropZone.querySelector('.player-card')) {
        const existingPlayer = dropZone.querySelector('.player-card');
        movePlayerToPool(existingPlayer);
      }
      
      // Move player to court position
      touchedPlayer.remove();
      touchedPlayer.className = 'player-card bg-white border border-gray-300 rounded-lg p-2 text-center cursor-move';
      dropZone.innerHTML = '';
      dropZone.appendChild(touchedPlayer);
      
      // Update manual lineup data
      if (!manualLineup[court]) manualLineup[court] = {};
      manualLineup[court][position] = {
        name: playerName,
        rating: touchedPlayer.dataset.playerRating
      };
      
      updateManualLineupSummary();
    }
  }
  
  touchedPlayer = null;
}

function setupDropZones() {
  const courtPositions = document.querySelectorAll('.court-position');
  
  courtPositions.forEach(position => {
    position.addEventListener('dragover', handleDragOver);
    position.addEventListener('drop', handleDrop);
    position.addEventListener('dragleave', handleDragLeave);
  });
  
  // Also set up the available players pool as a drop zone
  const pool = document.getElementById('available-players-pool');
  pool.addEventListener('dragover', handleDragOver);
  pool.addEventListener('drop', handleDropToPool);
}

function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('border-blue-400', 'bg-blue-50');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
  
  const playerName = e.dataTransfer.getData('text/plain');
  const courtPosition = e.currentTarget;
  const court = courtPosition.dataset.court;
  const position = courtPosition.dataset.position;
  
  // Check if position is already occupied
  if (courtPosition.querySelector('.player-card')) {
    // Move existing player back to pool
    const existingPlayer = courtPosition.querySelector('.player-card');
    movePlayerToPool(existingPlayer);
  }
  
  // Find and move the dragged player
  const draggedPlayer = document.querySelector(`[data-player-name="${playerName}"]`);
  if (draggedPlayer) {
    // Remove from current location
    draggedPlayer.remove();
    
    // Add to court position
    draggedPlayer.className = 'player-card bg-white border border-gray-300 rounded-lg p-2 text-center cursor-move';
    courtPosition.innerHTML = '';
    courtPosition.appendChild(draggedPlayer);
    
    // Update manual lineup data
    if (!manualLineup[court]) manualLineup[court] = {};
    manualLineup[court][position] = {
      name: playerName,
      rating: draggedPlayer.dataset.playerRating
    };
    
    updateManualLineupSummary();
  }
}

function handleDropToPool(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('border-blue-400', 'bg-blue-50');
  
  const playerName = e.dataTransfer.getData('text/plain');
  const draggedPlayer = document.querySelector(`[data-player-name="${playerName}"]`);
  
  if (draggedPlayer && draggedPlayer.parentElement.classList.contains('court-position')) {
    movePlayerToPool(draggedPlayer);
  }
}

function movePlayerToPool(playerElement) {
  const court = playerElement.parentElement.dataset.court;
  const position = playerElement.parentElement.dataset.position;
  
  // Remove from lineup data
  if (manualLineup[court] && manualLineup[court][position]) {
    delete manualLineup[court][position];
    if (Object.keys(manualLineup[court]).length === 0) {
      delete manualLineup[court];
    }
  }
  
  // Move back to pool
  playerElement.className = 'player-card bg-white border border-gray-200 rounded-lg p-3 m-2 inline-block cursor-move shadow-sm hover:shadow-md transition-shadow';
  playerElement.parentElement.innerHTML = playerElement.parentElement.textContent; // Reset drop zone text
  document.getElementById('available-players-pool').appendChild(playerElement);
  
  updateManualLineupSummary();
}

function updateManualLineupSummary() {
  const summary = document.getElementById('manual-lineup-summary');
  const summaryText = document.getElementById('manual-lineup-text');
  const sendButton = document.getElementById('manual-send');
  
  if (Object.keys(manualLineup).length === 0) {
    summary.classList.add('hidden');
    sendButton.disabled = true;
    return;
  }
  
  let lineupText = 'LINEUP:\n\n';
  
  // Sort courts numerically
  const sortedCourts = Object.keys(manualLineup).sort((a, b) => parseInt(a) - parseInt(b));
  
  sortedCourts.forEach(court => {
    const courtData = manualLineup[court];
    const player1 = courtData['1'];
    const player2 = courtData['2'];
    
    lineupText += `Court ${court}: `;
    
    if (player1 && player2) {
      lineupText += `${player1.name} & ${player2.name}\n`;
    } else if (player1) {
      lineupText += `${player1.name} & [Need Partner]\n`;
    } else if (player2) {
      lineupText += `[Need Partner] & ${player2.name}\n`;
    }
  });
  
  summaryText.textContent = lineupText;
  summary.classList.remove('hidden');
  
  // Enable send button if we have at least one complete court
  const hasCompleteCourt = sortedCourts.some(court => {
    const courtData = manualLineup[court];
    return courtData['1'] && courtData['2'];
  });
  
  sendButton.disabled = !hasCompleteCourt;
}

function sendManualLineup() {
  if (Object.keys(manualLineup).length === 0) {
    alert('Please assign players to courts before sending.');
    return;
  }
  
  // Create lineup text from manual assignments
  generatedLineup = document.getElementById('manual-lineup-text').textContent;
  
  // Update message preview and show page 4
  updateMessagePreview();
  showPage(4);
}

function updateSummary() {
  // Update player count and list
  const playersCount = document.getElementById('summary-players-count');
  const playersList = document.getElementById('summary-players-list');
  
  playersCount.textContent = selectedPlayers.size;
  
  if (selectedPlayers.size === 0) {
    playersList.innerHTML = '<div class="text-gray-500 italic">No players selected</div>';
  } else {
    const selectedPlayerNames = Array.from(selectedPlayers).sort();
    playersList.innerHTML = selectedPlayerNames.map(name => {
      return `<div class="flex items-center py-1">
        <i class="fas fa-user text-blue-400 mr-2 text-xs"></i>
        <span class="text-gray-800">${name}</span>
      </div>`;
    }).join('');
  }
  
  // Update instructions count and list
  const instructionsCount = document.getElementById('summary-instructions-count');
  const instructionsList = document.getElementById('summary-instructions-list');
  
  instructionsCount.textContent = instructions.length;
  
  if (instructions.length === 0) {
    instructionsList.innerHTML = '<div class="text-gray-500 italic">No instructions added</div>';
  } else {
    instructionsList.innerHTML = instructions.map((instruction, index) => {
      return `<div class="flex items-start py-1">
        <i class="fas fa-arrow-right text-purple-400 mr-2 text-xs mt-1"></i>
        <span class="text-gray-800">${instruction}</span>
      </div>`;
    }).join('');
  }
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Setup drop zones for manual mode
  setupDropZones();
  
  // Choice page buttons
  document.getElementById('choose-ai').onclick = () => {
    isAIMode = true;
    // Load data for AI mode
    loadPlayers();
    loadInstructions();
    showPage(1);
  };
  
  document.getElementById('choose-manual').onclick = () => {
    isAIMode = false;
    showPage('manual');
  };
  
  // Manual mode navigation
  document.getElementById('manual-back').onclick = () => showPage(0);
  document.getElementById('manual-send').onclick = sendManualLineup;
  
  // AI mode page navigation
  document.getElementById('page1-next').onclick = () => {
    if (selectedPlayers.size === 0) {
      alert('Please select at least one player.');
      return;
    }
    showPage(2);
  };
  
  document.getElementById('page2-prev').onclick = () => showPage(1);
  document.getElementById('page2-next').onclick = () => {
    updateSummary();
    showPage(3);
  };
  
  document.getElementById('page3-prev').onclick = () => showPage(2);
  
  document.getElementById('page4-prev').onclick = () => {
    if (isAIMode) {
      showPage(3);
    } else {
      showPage('manual');
    }
  };
  
  // Instructions
  document.getElementById('add-instruction-btn').onclick = addInstruction;
  document.getElementById('new-instruction').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addInstruction();
  });
  
  // Generate lineup
  document.getElementById('generate-lineup-btn').onclick = generateLineup;
  
  // Page 4 actions
  document.getElementById('send-email').onclick = () => {
    // TODO: Implement email sending
    alert('Email functionality coming soon!');
  };
  
  document.getElementById('send-text').onclick = () => {
    // TODO: Implement SMS sending
    alert('Text messaging functionality coming soon!');
  };
  
  document.getElementById('copy-lineup').onclick = () => {
    navigator.clipboard.writeText(document.getElementById('message-preview').textContent);
    alert('Lineup copied to clipboard!');
  };
  
  document.getElementById('save-lineup').onclick = () => {
    // TODO: Implement save functionality
    alert('Save functionality coming soon!');
  };
  
  document.getElementById('send-to-team').onclick = () => {
    // For now, show the email option since it's the main sending method
    // This could be enhanced to show a menu of sending options
    document.getElementById('send-email').click();
  };
  
  // Initialize wizard at choice page
  showPage(0);
});
</script>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Drag and Drop Styles */
.player-card {
    transition: all 0.2s ease;
    touch-action: manipulation;
    user-select: none;
}

.player-card:hover {
    transform: translateY(-2px);
}

.player-card.dragging {
    transform: rotate(5deg);
    z-index: 1000;
}

.court-position {
    transition: all 0.2s ease;
    min-height: 4rem;
}

.court-position.drag-over {
    transform: scale(1.02);
    border-style: solid !important;
}

.court-container {
    transition: all 0.2s ease;
}

#available-players-pool {
    transition: all 0.2s ease;
}

/* Mobile touch improvements */
@media (max-width: 768px) {
    .player-card {
        min-width: 120px;
        margin: 0.25rem;
    }
    
    .court-position {
        min-height: 5rem;
        padding: 1rem;
    }
    
    .court-container {
        margin-bottom: 1rem;
    }
}

/* Visual feedback for drag operations */
.drop-zone-active {
    background-color: rgba(59, 130, 246, 0.1) !important;
    border-color: rgb(59, 130, 246) !important;
    border-width: 2px !important;
    border-style: dashed !important;
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-200 { border-color: #e5e7eb; }
.border-gray-300 { border-color: #d1d5db; }
.border-green-200 { border-color: #bbf7d0; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-white { background-color: #ffffff; }
.bg-blue-600 { background-color: #2563eb; }
.bg-gray-600 { background-color: #4b5563; }
.bg-orange-600 { background-color: #ea580c; }
.bg-green-600 { background-color: #16a34a; }
.bg-purple-600 { background-color: #9333ea; }
.bg-red-600 { background-color: #dc2626; }
.bg-green-50 { background-color: #f0fdf4; }

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-800 { color: #1f2937; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-blue-500 { color: #3b82f6; }
.text-blue-600 { color: #2563eb; }
.text-green-500 { color: #10b981; }
.text-green-700 { color: #047857; }
.text-green-800 { color: #065f46; }
.text-purple-500 { color: #8b5cf6; }
.text-purple-600 { color: #9333ea; }
.text-orange-500 { color: #f97316; }
.text-white { color: #ffffff; }

/* Hover colors */
.hover\:bg-blue-700:hover { background-color: #1d4ed8; }
.hover\:bg-gray-700:hover { background-color: #374151; }
.hover\:bg-orange-700:hover { background-color: #c2410c; }
.hover\:bg-green-700:hover { background-color: #15803d; }
.hover\:bg-purple-700:hover { background-color: #7c2d12; }
.hover\:bg-red-700:hover { background-color: #b91c1c; }
.hover\:bg-gray-50:hover { background-color: #f9fafb; }

/* Focus utilities */
.focus\:border-blue-500:focus { border-color: #3b82f6; }
.focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }
.focus\:ring-gray-500:focus { --tw-ring-color: #6b7280; }
.focus\:ring-orange-500:focus { --tw-ring-color: #f97316; }
.focus\:ring-green-500:focus { --tw-ring-color: #10b981; }
.focus\:ring-purple-500:focus { --tw-ring-color: #8b5cf6; }
.focus\:ring-red-500:focus { --tw-ring-color: #ef4444; }

.focus\:ring-2:focus {
    --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
    --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
    box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus\:ring-offset-2:focus {
    --tw-ring-offset-width: 2px;
}

/* Gradient backgrounds */
.bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}
.from-purple-500 {
    --tw-gradient-from: #8b5cf6;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(139, 92, 246, 0));
}
.to-purple-600 {
    --tw-gradient-to: #7c3aed;
}

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-3 > * + * { margin-top: 0.75rem; }
.space-y-1 > * + * { margin-top: 0.25rem; }

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }
.rounded { border-radius: 0.25rem; }

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

/* Utility classes */
.flex-shrink-0 { flex-shrink: 0; }

/* Grid utilities */
.grid { display: grid; }
.grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
.grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
.gap-4 { gap: 1rem; }
.items-center { align-items: center; }
@media (min-width: 640px) {
    .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
}

/* Animation utilities */
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive design */
@media (max-width: 640px) {
    .px-6 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
}
</style>

{% endblock %} 