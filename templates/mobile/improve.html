{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-emerald-600 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                <i class="fas fa-chart-line text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900 whitespace-nowrap">Improve My Game</h1>
                <p class="text-sm text-gray-500">Training resources and performance analysis</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">

        <!-- Modal Backdrop -->
        <div id="coach-rally-modal" class="fixed inset-0 z-[9999] hidden transition-all duration-300 ease-out">
            <!-- Dark overlay -->
            <div class="absolute inset-0 bg-black bg-opacity-80 transition-opacity duration-300"></div>
            
            <!-- Modal Content -->
            <div class="relative h-full flex items-center justify-center p-4 py-16">
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-md h-auto flex flex-col overflow-hidden transform transition-all duration-300 ease-out scale-100">
                    <!-- Modal Header -->
                    <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-white flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <div class="bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center h-10 w-10">
                                <i class="fas fa-user-graduate text-white text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">Coach Rally</h3>
                                <p class="text-xs text-gray-600">Your AI-powered coach</p>
                            </div>
                        </div>
                        <button id="close-modal" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
                            <i class="fas fa-times text-gray-500 text-lg"></i>
                        </button>
                    </div>

                    <!-- Chat Messages Container -->
                    <div id="paddle-coach-messages" class="overflow-y-auto p-4 space-y-3 bg-gray-50" style="height: 435px;">
                        <!-- Messages will be inserted here -->
                    </div>

                    <!-- Chat Input Form -->
                    <div class="p-4 border-t border-gray-200 bg-white flex-shrink-0">
                        <form id="modal-coach-form" class="flex gap-2">
                            <input type="text" 
                                   id="modal-coach-input" 
                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-gray-900" 
                                   placeholder=""
                                   value="How do I improve my serve?"
                                   autocomplete="off" 
                                   required>
                            <button type="submit" 
                                    class="bg-gradient-to-br from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg transition-all duration-200 flex items-center justify-center">
                                <i class="fas fa-paper-plane text-sm"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paddle Tips Section -->
        {% if paddle_tips %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 text-white" style="background: linear-gradient(to bottom right, #045454, #067a7a);">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-lightbulb text-2xl mr-3" style="color: #bff863;"></i>
                        <h3 class="text-xl font-bold" id="tipHeader">Loading tip...</h3>
                    </div>
                    <button id="refreshTip" class="bg-white bg-opacity-90 hover:bg-opacity-100 rounded-lg px-3 py-2 transition-all duration-200 shadow-md text-sm font-medium" style="color: #045454;">
                        View Next Tip
                    </button>
                </div>
                
                <div id="tipContainer" class="min-h-[200px]">
                    <div class="tip-content">
                        <!-- Tip Image -->
                        <div class="mb-3">
                            <img id="tipImage" src="" alt="Paddle Tip" class="w-full h-48 object-cover rounded-lg border-2 border-white border-opacity-20 hidden">
                        </div>
                        
                        <h4 class="text-lg font-semibold mb-2" id="tipTitle">Loading tip...</h4>
                        <p class="text-sm mb-3" id="tipMeta" style="color: #bff863;">Tip #</p>
                        <p class="text-white leading-relaxed mb-3" id="tipDescription">Loading...</p>
                        
                        <div id="tipActions" class="flex justify-between items-center mb-3">
                            <span class="text-xs text-white text-opacity-80" id="tipDate"></span>
                            <a id="tipVideoLink" href="#" target="_blank" class="bg-white bg-opacity-90 hover:bg-opacity-100 px-3 py-2 rounded-lg text-sm font-medium transition-all duration-200 hidden shadow-md" style="color: #045454;">
                                <i class="fas fa-play mr-1"></i> Watch Video
                            </a>
                        </div>
                        
                        <!-- View More Link -->
                        <div class="border-t border-white border-opacity-20 pt-3">
                            <button id="viewMoreTip" class="w-full bg-white bg-opacity-90 hover:bg-opacity-100 rounded-lg py-2 px-4 font-medium transition-all duration-200 flex items-center justify-center shadow-md" style="color: #045454;">
                                <i class="fas fa-external-link-alt mr-2"></i> View Full Tip
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Training Resources Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden relative z-1">
            <div class="px-6 py-4 border-b border-rally-yellow bg-rally-gray">
                <h2 class="text-lg font-semibold text-rally-teal flex items-center">
                    <i class="fas fa-graduation-cap text-rally-teal mr-2"></i>
                    Training Resources
                </h2>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- Video Library Card -->
                <a href="/mobile/training-videos" class="block bg-white rounded-lg border-2 border-rally-yellow p-4 relative hover:shadow-lg hover:border-rally-teal transition-all duration-300 transform hover:scale-105">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <i class="fas fa-video text-rally-teal text-xl mr-2"></i>
                            <span class="text-lg font-semibold text-gray-900">Training Video Library</span>
                        </div>
                        <div class="bg-rally-yellow text-rally-black text-xs px-3 py-1 rounded-full font-bold flex items-center shadow-sm">
                            <i class="fas fa-check mr-1"></i>
                            Available
                        </div>
                    </div>
                    <p class="text-gray-700 mb-4">Access our curated collection of training videos and tutorials to master your platform tennis game.</p>
                    <div class="bg-rally-teal text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center shadow-md hover:bg-rally-teal-dark transition-colors duration-200">
                        <i class="fas fa-play mr-2"></i>
                        Browse Videos
                        <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>
                
                <!-- Drills & Exercises Card -->
                <div class="bg-gray-50 rounded-lg border border-gray-200 p-4 relative">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <i class="fas fa-dumbbell text-gray-400 text-xl mr-2"></i>
                            <span class="text-lg font-semibold text-gray-700">Drills & Exercises</span>
                        </div>
                        <span class="bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded-full font-medium">Coming Soon</span>
                    </div>
                    <p class="text-gray-700 mb-4">Practice routines and exercises to enhance your skills.</p>
                    <div class="text-gray-700 font-semibold flex items-center cursor-not-allowed">
                        View Drills <i class="fas fa-lock ml-2"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coach Rally Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-400 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <div class="flex items-center gap-3">
                    <div class="bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center h-10 w-10">
                        <i class="fas fa-user-graduate text-white text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Coach Rally</h3>
                        <p class="text-sm text-gray-500">Your AI-powered coach</p>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Chat Preview -->
                <div id="chat-preview" class="bg-gray-50 rounded-xl p-3 mb-4 min-h-[100px] max-h-[150px] overflow-y-auto cursor-pointer hover:bg-gray-100 transition-colors duration-200">
                    <div class="text-sm text-gray-500 italic">Ask me anything about paddle tennis to improve your game...</div>
                </div>
                
                <!-- Chat Input Form -->
                <form id="paddle-coach-form" class="flex gap-2 mb-4">
                    <input type="text" 
                           id="paddle-coach-input" 
                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-gray-900" 
                           placeholder=""
                           value="How do I improve my serve?"
                           autocomplete="off" 
                           required>
                    <button type="button" 
                            id="paddle-coach-send-btn"
                            class="bg-gradient-to-br from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg transition-all duration-200">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                
                <div class="text-xs text-gray-500">
                    <i class="fas fa-lightbulb mr-1"></i>
                    Try:<br>
                    - "How do I improve my volley"<br>
                    - "What are effective blitzing strategies"
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Paddle Tips Data -->
<script id="paddle-tips-data" type="application/json">{{ paddle_tips | tojson | safe if paddle_tips else '[]' }}</script>

<script>
let coachThreadId = null;

document.addEventListener('DOMContentLoaded', function() {
    const paddleTipsScript = document.getElementById('paddle-tips-data');
    const paddleTips = paddleTipsScript ? JSON.parse(paddleTipsScript.textContent) : [];
    let currentTipIndex = -1;
    
    // Debug logging
    console.log('Paddle tips script element:', paddleTipsScript);
    console.log('Paddle tips data:', paddleTips);
    console.log('Number of tips:', paddleTips.length);
    console.log('Raw script content:', paddleTipsScript ? paddleTipsScript.textContent : 'No script element');
    
    // Check if we have valid paddle tips data
    if (paddleTips && paddleTips.length > 0) {
        console.log('✅ Paddle tips loaded successfully:', paddleTips[0]);
    } else {
        console.log('❌ No paddle tips data available');
    }
    
    // Set up input field behavior
    const paddleCoachInput = document.getElementById('paddle-coach-input');
    const modalCoachInput = document.getElementById('modal-coach-input');
    if (paddleCoachInput) {
        // Select all text when user focuses on input so they can easily replace it
        paddleCoachInput.addEventListener('focus', function() {
            this.select();
        });
    }
    if (modalCoachInput) {
        // Select all text when user focuses on input so they can easily replace it
        modalCoachInput.addEventListener('focus', function() {
            this.select();
        });
    }
    
    function getRandomTip() {
        console.log('getRandomTip called, paddleTips.length:', paddleTips.length);
        if (paddleTips.length === 0) {
            console.log('No paddle tips available');
            // Show a fallback message
            displayFallbackTip();
            return null;
        }
        
        let newIndex;
        do {
            newIndex = Math.floor(Math.random() * paddleTips.length);
        } while (newIndex === currentTipIndex && paddleTips.length > 1);
        
        currentTipIndex = newIndex;
        console.log('Selected tip index:', newIndex, 'Tip:', paddleTips[newIndex]);
        return paddleTips[newIndex];
    }
    
    function displayFallbackTip() {
        console.log('Displaying fallback tip message');
        const tipContainer = document.getElementById('tipContainer');
        const tipHeader = document.getElementById('tipHeader');
        const tipTitle = document.getElementById('tipTitle');
        const tipMeta = document.getElementById('tipMeta');
        const tipDescription = document.getElementById('tipDescription');
        const tipDate = document.getElementById('tipDate');
        const tipVideoLink = document.getElementById('tipVideoLink');
        const tipImage = document.getElementById('tipImage');
        const viewMoreTip = document.getElementById('viewMoreTip');
        
        if (tipHeader) tipHeader.textContent = 'Paddle Tips Coming Soon';
        if (tipTitle) tipTitle.textContent = 'Training content is being prepared';
        if (tipMeta) {
            tipMeta.textContent = '';
            tipMeta.style.display = 'none';
        }
        if (tipDescription) tipDescription.textContent = 'We\'re working on bringing you the best paddle tennis tips and techniques. Check back soon for expert advice to improve your game!';
        if (tipDate) tipDate.textContent = '';
        if (tipVideoLink) tipVideoLink.classList.add('hidden');
        if (tipImage) tipImage.classList.add('hidden');
        if (viewMoreTip) viewMoreTip.classList.add('hidden');
    }

    function displayTip(tip) {
        console.log('displayTip called with tip:', tip);
        if (!tip) {
            console.log('No tip provided to displayTip');
            return;
        }
        
        const tipContainer = document.getElementById('tipContainer');
        const tipHeader = document.getElementById('tipHeader');
        const tipTitle = document.getElementById('tipTitle');
        const tipMeta = document.getElementById('tipMeta');
        const tipDescription = document.getElementById('tipDescription');
        const tipDate = document.getElementById('tipDate');
        const tipVideoLink = document.getElementById('tipVideoLink');
        const tipImage = document.getElementById('tipImage');
        const viewMoreTip = document.getElementById('viewMoreTip');
        
        console.log('Tip elements found:', {
            tipContainer: !!tipContainer,
            tipHeader: !!tipHeader,
            tipTitle: !!tipTitle,
            tipMeta: !!tipMeta,
            tipDescription: !!tipDescription,
            tipDate: !!tipDate,
            tipVideoLink: !!tipVideoLink,
            tipImage: !!tipImage,
            viewMoreTip: !!viewMoreTip
        });
        
        if (!tipContainer || !tipTitle || !tipMeta || !tipDescription || !tipDate || !tipVideoLink) {
            console.log('Missing required tip elements');
            return;
        }
        
        // Add fade out effect
        tipContainer.style.opacity = '0.7';
        
        setTimeout(function() {
            // Update header with tip number
            if (tipHeader) {
                tipHeader.textContent = `Paddle Tip #${tip.number || '?'}`;
            }
            
            // Update content
            tipTitle.textContent = tip.name || 'Untitled Tip';
            tipMeta.textContent = '';
            tipMeta.style.display = 'none';
            
            // Process description for YouTube videos and format properly
            let description = tip.description || '';
            
            // Truncate description if too long for mobile (shorter now due to image)
            if (description.length > 200) {
                description = description.substring(0, 200) + '...';
            }
            
            // Format the description with basic HTML support
            const formattedDescription = formatTipDescription(description);
            tipDescription.innerHTML = formattedDescription;
            
            tipDate.textContent = tip.date || '';
            
            // Handle tip image - hide if doesn't exist
            if (tipImage && tip.image) {
                tipImage.src = '/static/images/tip_images/' + tip.image;
                tipImage.classList.remove('hidden');
                
                // Simple error handling - just hide if image doesn't exist
                tipImage.onerror = function() {
                    this.classList.add('hidden');
                };
            } else if (tipImage) {
                tipImage.classList.add('hidden');
            }
            
            // Handle video link
            if (tip.url) {
                tipVideoLink.href = tip.url;
                tipVideoLink.classList.remove('hidden');
            } else {
                tipVideoLink.classList.add('hidden');
            }
            
            // Store current tip data for view more functionality
            if (viewMoreTip) {
                viewMoreTip.setAttribute('data-tip-number', tip.number || '');
                viewMoreTip.setAttribute('data-tip-name', tip.name || '');
            }
            
            // Fade back in
            tipContainer.style.opacity = '1';
        }, 150);
    }
    
    // Format tip descriptions with basic HTML and YouTube video support
    function formatTipDescription(text) {
        if (!text) return '';
        
        // Convert line breaks
        let formatted = text.replace(/\n/g, '<br>');
        
        // Convert URLs to clickable links, with special handling for YouTube
        formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, function(url) {
            // Check if it's a YouTube URL
            const youtubeRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            
            if (youtubeMatch) {
                return `<a href="${url}" target="_blank" class="hover:underline font-medium" style="color: #bff863;">
                    <i class="fas fa-play mr-1"></i>Watch Video
                </a>`;
            } else {
                return `<a href="${url}" target="_blank" class="hover:underline" style="color: #bff863;">${url}</a>`;
            }
        });
        
        return formatted;
    }
    
    function rotateToNextTip() {
        const nextTip = getRandomTip();
        displayTip(nextTip);
    }
    
    function showTipModal(tip) {
        if (!tip) return;
        
        // Format the full description with YouTube video embeds
        const formattedDescription = formatTipDescriptionWithEmbeds(tip.description || '');
        
        // Create modal backdrop
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[9998] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
                <div class="p-4 border-b border-gray-200 flex justify-between items-center" style="background-color: #045454;">
                    <div>
                        <h3 class="text-lg font-bold text-white">${tip.name || 'Untitled Tip'}</h3>
                        <p class="text-sm" style="color: #bff863;">Tip #${tip.number || ''} • ${tip.date || ''}</p>
                    </div>
                    <button class="close-modal text-white hover:text-gray-200 text-2xl">×</button>
                </div>
                <div class="p-4">
                    ${tip.image ? `<img src="/static/images/tip_images/${tip.image}" alt="Paddle Tip" class="w-full h-64 object-cover rounded-lg mb-4" onerror="this.style.display='none'">` : ''}
                    <div class="text-gray-700 leading-relaxed mb-4">${formattedDescription}</div>
                    ${tip.url ? `
                        <div class="mt-4">
                            <a href="${tip.url}" target="_blank" class="inline-flex items-center px-4 py-2 text-white rounded-lg transition-colors" style="background-color: #045454;">
                                <i class="fas fa-play mr-2"></i> Watch Video
                            </a>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(modal);
        
        // Set up close handlers
        const closeButton = modal.querySelector('.close-modal');
        closeButton.addEventListener('click', function() {
            document.body.removeChild(modal);
        });
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        
        // Restore body scroll when modal closes
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.removedNodes.forEach(function(node) {
                    if (node === modal) {
                        document.body.style.overflow = '';
                        observer.disconnect();
                    }
                });
            });
        });
        observer.observe(document.body, { childList: true });
    }
    
    // Enhanced formatting for modal with YouTube embeds
    function formatTipDescriptionWithEmbeds(text) {
        if (!text) return '';
        
        // FIRST: Convert URLs to embeds or links, with special handling for YouTube
        let formatted = text.replace(/(https?:\/\/[^\s]+)/g, function(url) {
            // Check if it's a YouTube URL
            const youtubeRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            
            if (youtubeMatch) {
                const videoId = youtubeMatch[1];
                return `__YOUTUBE_EMBED_START__
                    <div class="mt-4 mb-4">
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                            <h4 class="font-medium text-gray-800 mb-3">${title}</h4>
                            <div class="w-full" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                                <iframe 
                                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                                    src="https://www.youtube.com/embed/${videoId}" 
                                    title="${title}"
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen>
                                </iframe>
                            </div>
                            <div class="text-xs text-gray-600 mt-2 text-center">
                                <a href="${url}" target="_blank" class="text-blue-600 hover:underline">
                                    Watch on YouTube →
                                </a>
                            </div>
                        </div>
                    </div>
                __YOUTUBE_EMBED_END__`;
            } else {
                return `<a href="${url}" target="_blank" class="text-blue-600 hover:underline">${url}</a>`;
            }
        });
        
        // THEN: Convert line breaks (only for remaining text, not within HTML blocks)
        // Split by HTML blocks to avoid breaking them
        const htmlBlockRegex = /<div[^>]*>[\s\S]*?<\/div>/g;
        const htmlBlocks = [];
        let blockIndex = 0;
        
        // Replace HTML blocks with placeholders
        formatted = formatted.replace(htmlBlockRegex, function(match) {
            const placeholder = `__HTML_BLOCK_${blockIndex}__`;
            htmlBlocks[blockIndex] = match;
            blockIndex++;
            return placeholder;
        });
        
        // Now safely convert line breaks in the remaining text
        formatted = formatted.replace(/\n/g, '<br>');
        
        // Restore HTML blocks
        for (let i = 0; i < htmlBlocks.length; i++) {
            formatted = formatted.replace(`__HTML_BLOCK_${i}__`, htmlBlocks[i]);
        }
        
        // Format follow-up questions at the end with simple styling
        formatted = formatted.replace(/(?:<\/div>|<br>|^)([^<]*\?[^<]*)$/gm, function(match, question) {
            const trimmedQuestion = question.trim();
            if (trimmedQuestion.length > 10) { // Only format substantial questions
                return `<div class="mt-4 mb-2 text-gray-800 font-medium">${trimmedQuestion}</div>`;
            }
            return match;
        });
        
        // Finally, restore YouTube embeds (remove the protective markers)
        formatted = formatted.replace(/__YOUTUBE_EMBED_START__([\s\S]*?)__YOUTUBE_EMBED_END__/g, '$1');
        
        return formatted;
    }
    
    // Initialize with first tip only if paddle tips are available
    // Add a small delay to ensure all DOM elements are ready
    setTimeout(() => {
        if (paddleTips.length > 0) {
            console.log('Initializing with paddle tips...');
            rotateToNextTip();
        } else {
            console.log('No paddle tips available, showing fallback...');
            displayFallbackTip();
        }
    }, 100);
    
    // Set up refresh button
    const refreshButton = document.getElementById('refreshTip');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            if (paddleTips.length > 0) {
                rotateToNextTip();
            } else {
                displayFallbackTip();
            }
        });
    }
    
    // Set up view more button
    const viewMoreButton = document.getElementById('viewMoreTip');
    if (viewMoreButton) {
        viewMoreButton.addEventListener('click', function() {
            if (paddleTips.length > 0) {
                const tipNumber = this.getAttribute('data-tip-number');
                const tipName = this.getAttribute('data-tip-name');
                
                // Create modal or expanded view
                showTipModal(paddleTips.find(tip => tip.number == tipNumber));
            }
        });
    }
    
    // Coach Rally Modal Functionality
    const coachRallyModal = document.getElementById('coach-rally-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const chatPreview = document.getElementById('chat-preview');
    const paddleCoachForm = document.getElementById('paddle-coach-form');
    const modalCoachForm = document.getElementById('modal-coach-form');
    // paddleCoachInput and modalCoachInput already declared above
    const paddleCoachMessages = document.getElementById('paddle-coach-messages');

    // Show modal when clicking the chat preview or submitting the main form
    chatPreview.addEventListener('click', () => {
        coachRallyModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        document.body.style.height = '100%';
    });

    // Handle main form button click
    const paddleCoachSendBtn = document.getElementById('paddle-coach-send-btn');
    if (paddleCoachSendBtn) {
        paddleCoachSendBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const message = paddleCoachInput.value.trim();
            if (message) {
                coachRallyModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
                modalCoachInput.value = message;
                handleCoachMessage(message);
                
                // Always clear input fields after sending
                paddleCoachInput.value = '';
                modalCoachInput.value = '';
            }
        });
    }
    
    // Also handle Enter key in the input field
    if (paddleCoachInput) {
        paddleCoachInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                paddleCoachSendBtn.click();
            }
        });
    }

    // Close modal
    closeModalBtn.addEventListener('click', () => {
        coachRallyModal.classList.add('hidden');
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.body.style.height = '';
    });

    // Allow closing modal by clicking the overlay
    coachRallyModal.addEventListener('click', function(e) {
        // Close if clicking on the overlay (backdrop) or the outer modal container
        if (e.target === coachRallyModal || e.target.classList.contains('bg-black')) {
            coachRallyModal.classList.add('hidden');
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.height = '';
        }
    });

    // Allow closing modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (!coachRallyModal.classList.contains('hidden') && (e.key === 'Escape' || e.key === 'Esc')) {
            coachRallyModal.classList.add('hidden');
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.height = '';
        }
    });

    // Handle modal form submission
    modalCoachForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const message = modalCoachInput.value.trim();
        if (message) {
            handleCoachMessage(message);
            
            // Always clear input fields after sending
            modalCoachInput.value = '';
            paddleCoachInput.value = '';
        }
    });
    
    // Also handle Enter key in modal input
    if (modalCoachInput) {
        modalCoachInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                modalCoachForm.dispatchEvent(new Event('submit'));
            }
        });
    }

    // Update chat preview with latest message
    function updateChatPreview(message) {
        const previewText = document.createElement('div');
        previewText.className = 'text-sm text-gray-700';
        previewText.textContent = message;
        chatPreview.innerHTML = '';
        chatPreview.appendChild(previewText);
    }

    // Handle coach messages
    function handleCoachMessage(message) {
        // Add user message
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'flex justify-end mb-3';
        userMessageDiv.innerHTML = `
            <div class="bg-blue-500 text-white rounded-2xl py-3 px-4 max-w-[75%] shadow-sm imessage-user-bubble">
                <div class="text-sm leading-relaxed">${escapeHtml(message)}</div>
            </div>
        `;
        paddleCoachMessages.appendChild(userMessageDiv);
        
        // Don't scroll here - wait for final response scroll
        
        // Update preview
        updateChatPreview(message);
        
        // Show loading state
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex justify-start mb-3';
        loadingDiv.innerHTML = `
            <div class="bg-gray-200 rounded-2xl py-3 px-4 shadow-sm imessage-loading-bubble" style="display: flex; flex-direction: column; align-items: flex-start;">
                <div class="text-sm text-gray-600 font-medium mb-1">
                    Coach Rally is thinking...
                </div>
                <div class="imessage-typing flex items-center gap-1 mt-1">
                    <span class="imessage-dot bg-gray-400"></span>
                    <span class="imessage-dot bg-gray-500"></span>
                    <span class="imessage-dot bg-gray-600"></span>
                </div>
            </div>
        `;
        paddleCoachMessages.appendChild(loadingDiv);
        
        // First scroll: Show the "Coach Rally is thinking..." message
        setTimeout(() => {
            const loadingBubble = loadingDiv.querySelector('.imessage-loading-bubble');
            if (loadingBubble) {
                loadingBubble.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Adjust scroll position to show some space above
                setTimeout(() => {
                    paddleCoachMessages.scrollTop = paddleCoachMessages.scrollTop - 15;
                }, 300);
            }
        }, 100);
        
        // Make API call to get response
        fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                thread_id: coachThreadId
            })
        })
        .then(response => response.json())
        .then(data => {
            // Handle thinking delay if present
            const thinkingDelay = data.thinking_delay || 0;
            
            setTimeout(() => {
                // Remove loading state
                paddleCoachMessages.removeChild(loadingDiv);
                
                if (data.error) {
                    // Show error in chat
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'flex justify-start mb-3';
                    errorDiv.innerHTML = `
                        <div class="bg-red-100 text-red-700 rounded-2xl py-3 px-4 max-w-[80%] shadow-sm">
                            <div class="text-sm">${escapeHtml(data.error)}</div>
                        </div>
                    `;
                    paddleCoachMessages.appendChild(errorDiv);
                    return;
                }
            // Format the response and extract follow-up question
            const formattedResponse = formatCoachResponse(data.response);
            const followupQuestion = extractFollowupQuestion(data.response);
            
            // Debug logging
            console.log('Original response:', data.response);
            console.log('Extracted followup question:', followupQuestion);
            
            // Add main coach response (without follow-up question)
            const coachMessageDiv = document.createElement('div');
            coachMessageDiv.className = 'flex justify-start mb-3';
            coachMessageDiv.innerHTML = `
                <div class="bg-gray-200 text-gray-900 rounded-2xl py-3 px-4 max-w-[85%] shadow-sm imessage-coach-bubble">
                    ${formattedResponse}
                </div>
            `;
            
            paddleCoachMessages.appendChild(coachMessageDiv);
            
            // Always add follow-up question if it exists, regardless of video search
            if (followupQuestion) {
                setTimeout(() => {
                    const followupDiv = document.createElement('div');
                    followupDiv.className = 'flex justify-start mb-3';
                    followupDiv.innerHTML = `
                        <div class="bg-gray-200 text-gray-900 rounded-2xl py-3 px-4 max-w-[75%] shadow-sm imessage-followup-bubble">
                            <div class="flex items-start space-x-2">
                                <div class="text-sm leading-relaxed">
                                    <span class="font-medium text-green-700 text-xs">Coach Rally</span><br>
                                    <span class="text-gray-900">${escapeHtml(followupQuestion)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    paddleCoachMessages.appendChild(followupDiv);
                    
                    // Don't scroll here - final scroll will handle positioning
                }, 500); // Small delay to separate from main response
            }
            
            // Second scroll: Show the top of the coach response
            // Wait for all content (including follow-up questions) to load
            setTimeout(() => {
                const coachBubble = coachMessageDiv.querySelector('.imessage-coach-bubble');
                if (coachBubble) {
                    coachBubble.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Adjust scroll position to show more space above the response
                    setTimeout(() => {
                        paddleCoachMessages.scrollTop = paddleCoachMessages.scrollTop - 30;
                    }, 300);
                }
            }, 1200); // Wait for all content including follow-up questions to load
            
            // Check if response already contains training data/videos to avoid duplication
            const responseText = data.response || '';
            const hasTrainingVideo = responseText.includes('Training Video') || 
                                   responseText.includes('youtube.com') || 
                                   responseText.includes('youtu.be') ||
                                   responseText.includes('### Training Video') ||
                                   responseText.includes('Training Videos');
            
            // Only search for additional videos if the response doesn't already contain them
            if (!hasTrainingVideo) {
                searchAndAddTrainingVideo(message, followupQuestion, userMessagePosition);
            } else {
                // Response already has training data, just add follow-up question if it exists
                if (followupQuestion) {
                    setTimeout(() => {
                        const followupDiv = document.createElement('div');
                        followupDiv.className = 'flex justify-start mb-3';
                        followupDiv.innerHTML = `
                            <div class="bg-gray-200 text-gray-900 rounded-2xl py-3 px-4 max-w-[75%] shadow-sm imessage-followup-bubble">
                                <div class="flex items-start gap-3">
                                    <div class="bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center h-5 w-5 flex-shrink-0 mt-1">
                                        <i class="fas fa-user-graduate text-white text-xs"></i>
                                    </div>
                                    <div class="text-sm leading-relaxed">
                                        <span class="font-medium text-green-700 text-xs">Coach Rally</span><br>
                                        <span class="text-gray-900">${escapeHtml(followupQuestion)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        paddleCoachMessages.appendChild(followupDiv);
                        
                        // Don't override the main response scroll - let it handle positioning
                    }, 800);
                }
            }
            
            // Update thread ID
            if (data.thread_id) {
                coachThreadId = data.thread_id;
            }
            }, thinkingDelay * 1000); // Convert seconds to milliseconds
        })
        .catch(error => {
            console.error('Error:', error);
            // Remove loading state
            paddleCoachMessages.removeChild(loadingDiv);
            
            // Show error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'flex justify-start mb-3';
            errorDiv.innerHTML = `
                <div class="bg-red-100 text-red-700 rounded-2xl py-3 px-4 max-w-[80%] shadow-sm">
                    <div class="text-sm">Sorry, there was an error processing your request. Please try again.</div>
                </div>
            `;
            paddleCoachMessages.appendChild(errorDiv);
        });
    }

    // Helper: Escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/[&<>"']/g, function (c) {
            return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c];
        });
    }

    // Helper: Format coach response with sections and inline video
    function formatCoachResponse(response) {
        if (!response) return '';
        
        // Remove the "working on detailed response" text and variations
        response = response.replace(/Hey there! I'm working on a detailed response for you, but I want to get back to you quickly!\s*/g, '');
        response = response.replace(/I'm working on a detailed response for you, but I want to get back to you quickly!\s*/g, '');
        response = response.replace(/Hey there! I'm working on.*?quickly!\s*/g, '');
        
        // Remove follow-up question from the response since it will be displayed separately
        const followupQuestion = extractFollowupQuestion(response);
        if (followupQuestion) {
            // Remove the follow-up question from the response
            response = response.replace(new RegExp(followupQuestion.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*$'), '').trim();
        }
        
        // Check if response contains HTML content (from paddle insights)
        const containsHTML = /<div[^>]*style=/.test(response) || /<strong>/.test(response) || /<div[^>]*class=/.test(response);
        
        let html;
        
        if (containsHTML) {
            // This is HTML content from paddle insights - sanitize but preserve structure
            html = sanitizeHTML(response);
        } else {
            // This is regular text - escape and format as before
            html = escapeHtml(response);
            
            // Convert **text** to bold
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert numbered sections (1., 2., 3., etc.) to have proper spacing and bold headers
            html = html.replace(/(\n|^)(\d+\.)([^\n]+)/g, function(match, prefix, number, content) {
                // Check if the content after the number looks like a header (short and descriptive)
                if (content.length < 50 && !content.includes('•')) {
                    return `<div class="coach-section-header"><strong>${number}${content}</strong></div>`;
                } else {
                    return `<div class="coach-numbered-item">${number}${content}</div>`;
                }
            });
            
            // Convert bullet points with proper spacing
            html = html.replace(/\n\s*•\s*/g, '<br><div class="coach-bullet-item"><span class="coach-bullet">•</span> ');
            
            // Close bullet point divs (find bullet items and wrap them properly)
            html = html.replace(/(<div class="coach-bullet-item"><span class="coach-bullet">•<\/span> [^<]*?)(<br>|<div|$)/g, '$1</div>$2');
            
            // Add paragraph breaks for regular content (double newlines)
            html = html.replace(/\n\s*\n/g, '<div class="coach-paragraph-break"></div>');
            
            // Convert markdown links to clickable links
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, function(_, text, url) {
                // If YouTube, embed below
                if (/youtube\.com|youtu\.be/.test(url)) {
                    return `<a href="${url}" target="_blank" class="coach-link">${escapeHtml(text)}</a> <span class="coach-video-embed" data-url="${url}"></span>`;
                } else {
                    return `<a href="${url}" target="_blank" class="coach-link">${escapeHtml(text)}</a>`;
                }
            });
            
            // Convert remaining single newlines to <br>
            html = html.replace(/\n/g, '<br>');
        }
        
        // After rendering, insert YouTube iframes for .coach-video-embed
        setTimeout(() => {
            document.querySelectorAll('.coach-video-embed').forEach(function(el) {
                const url = el.getAttribute('data-url');
                const videoId = extractYouTubeId(url);
                if (videoId) {
                    el.innerHTML = `<div class="coach-video-container"><iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe></div>`;
                }
            });
        }, 0);
        
        return html;
    }

    // Helper: Sanitize HTML content while preserving safe formatting
    function sanitizeHTML(html) {
        // Create a temporary div to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Define allowed tags and attributes
        const allowedTags = ['div', 'strong', 'b', 'i', 'em', 'br', 'span', 'p'];
        const allowedAttributes = ['style', 'class'];
        const allowedStyles = ['font-size', 'font-weight', 'margin-bottom', 'margin-left', 'color', 'margin-top'];
        const allowedClasses = [
            'technique-title', 'section-header', 'section-content', 'bullet-item', 
            'sub-item', 'mistake-item', 'why-item', 'fix-item', 'cue-item',
            'coach-paragraph-break'
        ];
        
        // Function to sanitize a single element
        function sanitizeElement(element) {
            if (element.nodeType === Node.TEXT_NODE) {
                return element.textContent;
            }
            
            if (element.nodeType !== Node.ELEMENT_NODE) {
                return '';
            }
            
            const tagName = element.tagName.toLowerCase();
            
            // Remove disallowed tags but keep their content
            if (!allowedTags.includes(tagName)) {
                return Array.from(element.childNodes).map(sanitizeElement).join('');
            }
            
            // Create new element
            const newElement = document.createElement(tagName);
            
            // Copy allowed attributes
            for (const attr of element.attributes) {
                if (allowedAttributes.includes(attr.name.toLowerCase())) {
                    if (attr.name.toLowerCase() === 'style') {
                        // Sanitize style attribute
                        const styles = attr.value.split(';').filter(style => {
                            const [property] = style.split(':').map(s => s.trim());
                            return allowedStyles.includes(property);
                        });
                        if (styles.length > 0) {
                            newElement.setAttribute('style', styles.join('; '));
                        }
                    } else if (attr.name.toLowerCase() === 'class') {
                        // Sanitize class attribute
                        const classes = attr.value.split(' ').filter(cls => 
                            allowedClasses.includes(cls.trim())
                        );
                        if (classes.length > 0) {
                            newElement.setAttribute('class', classes.join(' '));
                        }
                    } else {
                        newElement.setAttribute(attr.name, attr.value);
                    }
                }
            }
            
            // Recursively sanitize children
            for (const child of element.childNodes) {
                const sanitizedChild = sanitizeElement(child);
                if (typeof sanitizedChild === 'string') {
                    newElement.appendChild(document.createTextNode(sanitizedChild));
                } else if (sanitizedChild instanceof Node) {
                    newElement.appendChild(sanitizedChild);
                }
            }
            
            return newElement;
        }
        
        // Sanitize all elements
        const sanitizedElements = Array.from(tempDiv.childNodes).map(sanitizeElement);
        
        // Convert back to HTML string
        const resultDiv = document.createElement('div');
        sanitizedElements.forEach(element => {
            if (typeof element === 'string') {
                resultDiv.appendChild(document.createTextNode(element));
            } else if (element instanceof Node) {
                resultDiv.appendChild(element);
            }
        });
        
        return resultDiv.innerHTML;
    }

    // Helper: Extract YouTube video ID from URL
    function extractYouTubeId(url) {
        if (!url) return null;
        // Support both youtu.be and youtube.com
        let match = url.match(/youtu\.be\/([\w-]{11})/);
        if (match) return match[1];
        match = url.match(/[?&]v=([\w-]{11})/);
        if (match) return match[1];
        match = url.match(/embed\/([\w-]{11})/);
        if (match) return match[1];
        return null;
    }

    // Helper: Extract follow-up question from response
    function extractFollowupQuestion(response) {
        if (!response) return null;
        
        // First try to find questions in multi-line responses
        const lines = response.split('\n');
        for (let i = lines.length - 1; i >= 0; i--) {
            const line = lines[i].trim();
            if (line.endsWith('?')) {
                return line;
            }
        }
        
        // If no line breaks, look for the last sentence ending with a question mark
        const sentences = response.split(/[.!]/);
        for (let i = sentences.length - 1; i >= 0; i--) {
            const sentence = sentences[i].trim();
            if (sentence.endsWith('?')) {
                return sentence;
            }
        }
        
        // If still no question found, look for any question mark in the response
        const questionMatch = response.match(/[^.!]*\?/g);
        if (questionMatch && questionMatch.length > 0) {
            return questionMatch[questionMatch.length - 1].trim();
        }
        
        return null;
    }

    // Helper: Search for relevant training video and add video bubble if found
    function searchAndAddTrainingVideo(message, followupQuestion, userMessagePosition) {
        // Call API to find relevant training video
        fetch('/api/find-training-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.video) {
                // Add video bubble with delay for natural feel
                setTimeout(() => {
                    const videoBubble = document.createElement('div');
                    videoBubble.className = 'flex justify-start mb-3';
                    
                    // Extract YouTube video ID for embedding
                    const videoId = extractYouTubeId(data.video.url);
                    
                    videoBubble.innerHTML = `
                        <div class="bg-gradient-to-br from-red-50 to-red-100 border border-red-200 rounded-2xl py-3 px-4 max-w-[90%] shadow-sm imessage-video-bubble">
                            <div class="flex items-start gap-3 mb-3">
                                <div class="bg-red-500 rounded-full flex items-center justify-center h-6 w-6 flex-shrink-0 mt-1">
                                    <i class="fas fa-play text-white text-xs"></i>
                                </div>
                                <div class="text-sm leading-relaxed">
                                    <span class="font-medium text-red-700 text-xs">Training Video</span><br>
                                    <span class="text-gray-900 font-medium">${escapeHtml(data.video.title)}</span><br>
                                    <span class="text-gray-600 text-xs">Related to: ${escapeHtml(data.video.topic)}</span>
                                </div>
                            </div>
                            ${videoId ? `
                                <div class="coach-video-container mb-3">
                                    <iframe src="https://www.youtube.com/embed/${videoId}" 
                                            frameborder="0" 
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                            allowfullscreen>
                                    </iframe>
                                </div>
                            ` : ''}
                            <div class="text-center">
                                <a href="${data.video.url}" target="_blank" 
                                   class="inline-flex items-center px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium">
                                    <i class="fas fa-external-link-alt mr-2"></i> Watch on YouTube
                                </a>
                            </div>
                        </div>
                    `;
                    paddleCoachMessages.appendChild(videoBubble);
                    
                    // Don't override the main response scroll - let it handle positioning
                    
                    // Add follow-up question after video if it exists
                    if (followupQuestion) {
                        setTimeout(() => {
                            const followupDiv = document.createElement('div');
                            followupDiv.className = 'flex justify-start mb-3';
                            followupDiv.innerHTML = `
                                <div class="bg-gray-200 text-gray-900 rounded-2xl py-3 px-4 max-w-[75%] shadow-sm imessage-followup-bubble">
                                    <div class="flex items-start gap-3">
                                        <div class="bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center h-5 w-5 flex-shrink-0 mt-1">
                                            <i class="fas fa-user-graduate text-white text-xs"></i>
                                        </div>
                                        <div class="text-sm leading-relaxed">
                                            <span class="font-medium text-green-700 text-xs">Coach Rally</span><br>
                                            <span class="text-gray-900">${escapeHtml(followupQuestion)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            paddleCoachMessages.appendChild(followupDiv);
                            
                            // Don't scroll here - final scroll will handle positioning
                        }, 600);
                    }
                }, 400);
            } else {
                // No video found, just add follow-up question if it exists
                if (followupQuestion) {
                    setTimeout(() => {
                        const followupDiv = document.createElement('div');
                        followupDiv.className = 'flex justify-start mb-3';
                        followupDiv.innerHTML = `
                            <div class="bg-gray-200 text-gray-900 rounded-2xl py-3 px-4 max-w-[75%] shadow-sm imessage-followup-bubble">
                                <div class="flex items-start gap-3">
                                    <div class="bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center h-5 w-5 flex-shrink-0 mt-1">
                                        <i class="fas fa-user-graduate text-white text-xs"></i>
                                    </div>
                                    <div class="text-sm leading-relaxed">
                                        <span class="font-medium text-green-700 text-xs">Coach Rally</span><br>
                                        <span class="text-gray-900">${escapeHtml(followupQuestion)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        paddleCoachMessages.appendChild(followupDiv);
                        
                        // Don't override the main response scroll - let it handle positioning
                    }, 800);
                }
            }
        })
        .catch(error => {
            console.error('Error finding training video:', error);
            // Still add follow-up question if it exists
            if (followupQuestion) {
                setTimeout(() => {
                    const followupDiv = document.createElement('div');
                    followupDiv.className = 'flex justify-start mb-3';
                    followupDiv.innerHTML = `
                        <div class="bg-gray-200 text-gray-900 rounded-2xl py-3 px-4 max-w-[75%] shadow-sm imessage-followup-bubble">
                            <div class="flex items-start gap-3">
                                <div class="bg-gradient-to-br from-green-500 to-blue-600 rounded-full flex items-center justify-center h-5 w-5 flex-shrink-0 mt-1">
                                    <i class="fas fa-user-graduate text-white text-xs"></i>
                                </div>
                                <div class="text-sm leading-relaxed">
                                    <span class="font-medium text-green-700 text-xs">Coach Rally</span><br>
                                    <span class="text-gray-900">${escapeHtml(followupQuestion)}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    paddleCoachMessages.appendChild(followupDiv);
                    
                    // Don't override the main response scroll - let it handle positioning
                }, 800);
            }
        });
    }
});
</script>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-200 { border-color: #e5e7eb; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-white { background-color: #ffffff; }
.bg-emerald-600 { background-color: #059669 !important; }

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-blue-500 { color: #3b82f6; }
.text-purple-500 { color: #8b5cf6; }
.text-orange-500 { color: #f97316; }
.text-white { color: #ffffff; }

/* Gradient backgrounds */
.bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}
.from-orange-500 {
    --tw-gradient-from: #f97316;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(249, 115, 22, 0));
}
.to-orange-600 {
    --tw-gradient-to: #ea580c;
}
.from-green-500 {
    --tw-gradient-from: #10b981;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(16, 185, 129, 0));
}
.to-blue-600 {
    --tw-gradient-to: #2563eb;
}
.from-blue-500 {
    --tw-gradient-from: #3b82f6;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0));
}
.to-purple-600 {
    --tw-gradient-to: #7c3aed;
}

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-4 > * + * { margin-top: 1rem; }

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.duration-200 {
    transition-duration: 200ms;
}

/* Responsive design */
@media (max-width: 640px) {
    .px-6 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
}

/* Original tip container and refresh styles */
#tipContainer {
    transition: opacity 0.3s ease-in-out;
}

#refreshTip {
    transition: transform 0.3s ease-in-out;
}

.tip-content {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Enhanced Coach Rally chat styles */
#paddle-coach-messages {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

#paddle-coach-messages::-webkit-scrollbar {
    width: 4px;
}

#paddle-coach-messages::-webkit-scrollbar-track {
    background: transparent;
}

#paddle-coach-messages::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

#paddle-coach-messages::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Message bubble styles for modal */
.imessage-user-bubble,
.imessage-coach-bubble,
.imessage-followup-bubble,
.imessage-video-bubble,
.imessage-loading-bubble {
    animation: messageSlideIn 0.3s ease-out;
    position: relative;
    font-size: 0.875rem;
}

.imessage-user-bubble {
    background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
    border-bottom-right-radius: 6px;
}

.imessage-coach-bubble {
    background: #F3F4F6;
    color: #1F2937;
    border-bottom-left-radius: 6px;
}

.imessage-followup-bubble {
    background: #F3F4F6;
    color: #1F2937;
    border-bottom-left-radius: 6px;
}

.imessage-video-bubble {
    border-bottom-left-radius: 6px;
    animation: messageSlideIn 0.4s ease-out;
}

.imessage-loading-bubble {
    background: #F3F4F6;
    border-bottom-left-radius: 6px;
}

/* Bubble hover effects */
.imessage-user-bubble:hover,
.imessage-coach-bubble:hover,
.imessage-followup-bubble:hover,
.imessage-video-bubble:hover {
    transform: scale(1.02);
    transition: transform 0.1s ease-out;
}

/* Content styling within bubbles */
.imessage-coach-bubble .coach-section-header strong {
    color: #007AFF;
    font-weight: 600;
}

.imessage-coach-bubble .coach-bullet {
    color: #007AFF;
    font-weight: bold;
}

.imessage-coach-bubble .coach-link {
    color: #007AFF;
    text-decoration: underline;
}

/* iMessage-style typing dots */
.imessage-typing {
    min-height: 18px;
    margin-top: 0.25rem;
    margin-bottom: 0.1rem;
    justify-content: flex-start;
}
.imessage-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    margin: 0 1px;
    background: #8E8E93;
    border-radius: 50%;
    opacity: 0.6;
    animation: imessage-bounce 1.4s infinite both;
}
.imessage-dot:nth-child(1) { animation-delay: 0s; }
.imessage-dot:nth-child(2) { animation-delay: 0.2s; }
.imessage-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes imessage-bounce {
    0%, 80%, 100% { 
        transform: translateY(0); 
        opacity: 0.6; 
    }
    40% { 
        transform: translateY(-4px); 
        opacity: 1; 
    }
}

.coach-response-bubble {
    border-left: 4px solid #3b82f6;
    background: #f8fafc;
    margin-top: 2px;
    margin-bottom: 2px;
}

/* New formatting styles for better readability */
.coach-section-break {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
}

.coach-section-header {
    margin-top: 1.2em;
    margin-bottom: 0.1em;
    font-size: 1.05em;
}

.coach-section-header:first-child {
    margin-top: 0;
}

.coach-section-header strong {
    color: #1e40af;
    font-weight: 600;
}

.coach-numbered-item {
    margin-bottom: 0.5em;
    font-weight: 500;
}

.coach-paragraph-break {
    margin-top: 1em;
    margin-bottom: 0.5em;
}

.coach-bullet-item {
    margin-bottom: 0.4em;
    margin-left: 0.5em;
    line-height: 1.4;
}

.coach-bullet {
    color: #3b82f6;
    font-weight: bold;
    margin-right: 0.5em;
}

.coach-link {
    color: #2563eb;
    text-decoration: underline;
    font-weight: 500;
}
.coach-video-container {
    margin: 0.5em 0;
    width: 100%;
    max-width: 280px;
    aspect-ratio: 16/9;
    background: #e5e7eb;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.coach-video-container iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
}
.coach-followup {
    margin-top: 1em;
    background: linear-gradient(90deg, #dbeafe 0%, #f0f9ff 100%);
    color: #1e293b;
    font-weight: 500;
    border-radius: 8px;
    padding: 0.7em 1em;
    font-size: 1em;
    box-shadow: 0 1px 4px rgba(59,130,246,0.07);
    display: inline-block;
}
.coach-followup-bubble {
    animation: messageSlideIn 0.4s ease-out;
    transition: all 0.2s ease;
}
.coach-followup-bubble:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
}
.animate-fade-in {
    animation: fadeIn 0.5s ease-in-out;
}

/* Essential animations */
@keyframes messageSlideIn {
    from { 
        opacity: 0; 
        transform: translateY(15px) scale(0.95); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
    }
}

/* Paddle Insights specific formatting in chat bubbles */
.imessage-coach-bubble div[style*="font-size: 1.1em"] {
    font-size: 1.05em !important;
    font-weight: 600 !important;
    color: #1e40af !important;
    margin-bottom: 8px !important;
    line-height: 1.3;
}

.imessage-coach-bubble div[style*="font-weight: bold"] {
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    margin-top: 8px;
}

.imessage-coach-bubble div[style*="margin-left: 12px"] {
    margin-left: 8px;
    margin-bottom: 4px;
    line-height: 1.4;
}

.imessage-coach-bubble div[style*="margin-left: 24px"] {
    margin-left: 16px;
    margin-bottom: 3px;
    font-size: 0.9em;
    line-height: 1.4;
}

.imessage-coach-bubble div[style*="color: #6b7280"] {
    color: #6b7280;
}

.imessage-coach-bubble div[style*="color: #059669"] {
    color: #059669;
    font-weight: 500;
}

.imessage-coach-bubble div[style*="color: #7c3aed"] {
    color: #7c3aed;
    font-weight: 500;
}

.imessage-coach-bubble strong {
    font-weight: 600;
    color: #1f2937;
}

/* Improve spacing for paddle insights content */
.imessage-coach-bubble > div {
    line-height: 1.5;
}

.imessage-coach-bubble div + div {
    margin-top: 2px;
}

/* Override inline styles for better mobile display */
.imessage-coach-bubble [style*="margin-bottom: 12px"] {
    margin-bottom: 8px;
}

.imessage-coach-bubble [style*="margin-bottom: 8px"] {
    margin-bottom: 6px;
}

.imessage-coach-bubble [style*="margin-bottom: 6px"] {
    margin-bottom: 4px;
}

.imessage-coach-bubble [style*="margin-bottom: 3px"] {
    margin-bottom: 2px;
}

/* New structured paddle insights styles */
.imessage-coach-bubble .technique-title {
    font-size: 1.05em;
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 12px;
    line-height: 1.3;
}

.imessage-coach-bubble .section-header {
    font-weight: 600;
    color: #374151;
    margin-bottom: 6px;
    margin-top: 12px;
}

.imessage-coach-bubble .section-header:first-child {
    margin-top: 0;
}

.imessage-coach-bubble .section-content {
    margin-bottom: 8px;
}

.imessage-coach-bubble .bullet-item {
    margin-left: 8px;
    margin-bottom: 4px;
    line-height: 1.4;
}

.imessage-coach-bubble .sub-item {
    margin-left: 16px;
    margin-bottom: 2px;
    font-size: 0.9em;
    line-height: 1.4;
    color: #6b7280;
}

.imessage-coach-bubble .mistake-item {
    margin-left: 8px;
    margin-bottom: 4px;
    line-height: 1.4;
}

.imessage-coach-bubble .why-item {
    margin-left: 16px;
    margin-bottom: 2px;
    font-size: 0.9em;
    line-height: 1.4;
    color: #6b7280;
}

.imessage-coach-bubble .fix-item {
    margin-left: 16px;
    margin-bottom: 2px;
    font-size: 0.9em;
    line-height: 1.4;
    color: #059669;
    font-weight: 500;
}

.imessage-coach-bubble .cue-item {
    margin-left: 8px;
    margin-bottom: 3px;
    line-height: 1.4;
    color: #7c3aed;
    font-weight: 500;
}
</style>

{% endblock %} 