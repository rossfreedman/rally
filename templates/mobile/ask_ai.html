{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}
{% block content %}
<!-- iMessage-style chat CSS -->
<style>
#ai-chat-messages {
  min-height: 300px;
  max-height: 400px;
  overflow-y: auto;
  background: #f5f5f7;
  border-radius: 1.5rem;
  padding: 1rem 0.5rem;
  margin-bottom: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.imessage-bubble {
  display: inline-block;
  padding: 0.6em 1em;
  border-radius: 1.25em;
  max-width: 80%;
  word-break: break-word;
  font-size: 1rem;
  margin-bottom: 2px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
  line-height: 1.4;
}
.imessage-bubble ul {
  margin: 0.5em 0;
  padding-left: 1em;
}
.imessage-bubble li {
  margin: 0.2em 0;
}
.imessage-user {
  align-self: flex-end;
  background: #007aff;
  color: #fff;
  border-bottom-right-radius: 0.4em;
  border-bottom-left-radius: 1.25em;
  border-top-left-radius: 1.25em;
  border-top-right-radius: 1.25em;
}
.imessage-ai {
  align-self: flex-start;
  background: #e5e5ea;
  color: #222;
  border-bottom-left-radius: 0.4em;
  border-bottom-right-radius: 1.25em;
  border-top-left-radius: 1.25em;
  border-top-right-radius: 1.25em;
}
#ai-chat-form {
  background: #fff;
  border-radius: 2em;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  padding: 0.5em 0.75em;
  display: flex;
  align-items: center;
  gap: 0.5em;
  position: sticky;
  bottom: 0;
  z-index: 10;
}
#ai-chat-input {
  border: none;
  outline: none;
  background: transparent;
  font-size: 1rem;
  flex: 1;
  padding: 0.5em 0.2em;
}
#ai-chat-input::placeholder {
  color: #aaa;
}
#ai-chat-form button {
  background: #007aff;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 2.5em;
  height: 2.5em;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
  transition: background 0.2s;
}
#ai-chat-form button:hover {
  background: #005ecb;
}
</style>

<!-- Consistent mobile header -->
<div class="flex items-center gap-3 mt-4 mb-2 px-4">
  <div class="bg-white rounded-md flex items-center justify-center h-12 w-12">
    <i class="fas fa-robot text-black text-3xl"></i>
  </div>
  <div>
    <div class="text-2xl font-bold leading-tight">Rally AI Assistant</div>
    <div class="text-base text-gray-500 mt-1">Ask anything about paddle tennis, lineups, stats, or your team.</div>
  </div>
</div>

<div class="max-w-lg mx-auto">
    <div class="bg-white rounded-xl shadow p-4 mt-2 mb-6">
        <div id="ai-chat-messages" class="mb-3 space-y-2" style="min-height:180px; background:#f5f5f7; border-radius:1.5rem; padding:1rem 0.5rem; display:flex; flex-direction:column; gap:0.5rem; align-items:stretch;"></div>
        <form id="ai-chat-form" class="flex gap-2">
            <input type="text" id="ai-chat-input" class="flex-1 border rounded px-3 py-2" placeholder="Ask me anything about paddle tennis..." autocomplete="off" required>
            <button type="submit" class="bg-[#007aff] hover:bg-[#005ecb] text-white px-4 py-2 rounded-full">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>
<script>
// iMessage-style chat rendering with improved formatting
const messages = document.getElementById('ai-chat-messages');

function formatAIResponse(text) {
    // Clean up the text first
    let formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold text
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic text
    
    // Format lists - convert bullet points to proper HTML lists
    if (formatted.includes('‚Ä¢') || formatted.includes('-') || /^\d+\./.test(formatted)) {
        const lines = formatted.split('\n');
        let inList = false;
        let listHtml = '';
        let regularText = '';
        
        lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed.startsWith('‚Ä¢') || trimmed.startsWith('-') || /^\d+\./.test(trimmed)) {
                if (!inList) {
                    if (regularText) {
                        listHtml += `<div class="mb-2">${regularText}</div>`;
                        regularText = '';
                    }
                    listHtml += '<ul class="list-disc list-inside space-y-1 my-2">';
                    inList = true;
                }
                const content = trimmed.replace(/^[‚Ä¢\-\d+\.]\s*/, '');
                listHtml += `<li class="text-sm">${content}</li>`;
            } else if (trimmed) {
                if (inList) {
                    listHtml += '</ul>';
                    inList = false;
                }
                regularText += (regularText ? '<br>' : '') + trimmed;
            }
        });
        
        if (inList) listHtml += '</ul>';
        if (regularText) listHtml += `<div>${regularText}</div>`;
        
        formatted = listHtml;
    } else {
        // Just handle line breaks for regular text
        formatted = formatted.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
    }
    
    // Format player stats if present
    if (formatted.includes('PTI') || formatted.includes('win percentage') || formatted.includes('wins and') || formatted.includes('losses')) {
        formatted = formatted.replace(/(PTI[:\s]*[\d.]+)/gi, '<span class="font-semibold text-blue-600">$1</span>');
        formatted = formatted.replace(/(win percentage[:\s]*[\d.]+%)/gi, '<span class="font-semibold text-green-600">$1</span>');
        formatted = formatted.replace(/(\d+ wins? and \d+ losses?)/gi, '<span class="font-semibold">$1</span>');
    }
    
    // Format section headers (lines that end with colon)
    formatted = formatted.replace(/^([^:]+:)(?=<br>|$)/gm, '<div class="font-semibold text-gray-800 mt-2 mb-1">$1</div>');
    
    return formatted;
}

function appendMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'imessage-bubble ' + (sender === 'user' ? 'imessage-user' : 'imessage-ai');
    
    if (sender === 'ai' && !text.includes('<b>Rally AI:</b>')) {
        // This is an AI response that needs formatting
        div.innerHTML = formatAIResponse(text);
    } else {
        // User message or already formatted text
        div.innerHTML = text;
    }
    
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}
// On page load, show the AI intro as conversation bubbles
window.addEventListener('DOMContentLoaded', function() {
    appendMessage("üëã Hello! I'm your Rally Assistant.", 'ai');
    appendMessage("Ask me about a specific player", 'ai');
    appendMessage("Request stats on a team", 'ai');
    appendMessage("Ask me anything about league rules", 'ai');
});
// Track conversation thread
let threadId = null;

document.getElementById('ai-chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const input = document.getElementById('ai-chat-input');
    const userMsg = input.value.trim();
    if (!userMsg) return;
    appendMessage(`<strong class="text-white">You:</strong> ${userMsg}`, 'user');
    input.value = '';
    appendMessage('One moment. Rally AI is thinking...', 'ai');
    
    // Minimal debug info (only in development)
    if (window.location.hostname === 'localhost') {
        console.log(`Chat: "${userMsg}" (${userMsg.length} chars, thread: ${threadId || 'new'})`);
    }
    
    try {
        const resp = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: userMsg,
                thread_id: threadId
            })
        });
        const data = await resp.json();
        
        // Minimal response logging
        if (window.location.hostname === 'localhost') {
            console.log(`Response: ${data.response ? data.response.length : 0} chars, ${data.debug?.context_percentage?.toFixed(1) || 0}% context used`);
        }
        
        // Store thread ID for conversation continuity
        if (data.thread_id) {
            threadId = data.thread_id;
        }
        
        // Remove the typing indicator (last AI message)
        const last = messages.lastChild;
        if (last && last.classList.contains('imessage-ai') && last.innerText === 'One moment. Rally AI is thinking...') {
            messages.removeChild(last);
        }
        if (data.response) {
            // Display AI response with improved formatting
            const formattedResponse = formatAIResponse(data.response);
            appendMessage(`<div class="mb-1"><strong class="text-blue-700">Rally AI:</strong></div>${formattedResponse}`, 'ai');
            
            // Show debug info if available (only in development)
            if (data.debug && window.location.hostname === 'localhost') {
                const contextWarning = data.debug.approaching_limit ? ' ‚ö†Ô∏è' : '';
                const debugInfo = `<small style="color: #666; font-size: 0.8em; opacity: 0.7;">
                    [${data.debug.message_count} msgs, ${data.debug.context_size} chars (${data.debug.context_percentage.toFixed(1)}%)${contextWarning}]
                </small>`;
                appendMessage(debugInfo, 'ai');
                
                // Warn if approaching context limit
                if (data.debug.approaching_limit) {
                    appendMessage('<small style="color: #ff6b35; font-size: 0.8em;">‚ö†Ô∏è Conversation is getting long. Consider refreshing to start fresh.</small>', 'ai');
                }
            }
        } else {
            appendMessage('<div><strong class="text-red-600">Rally AI:</strong> Sorry, something went wrong.</div>', 'ai');
        }
    } catch (error) {
        console.error('Chat error:', error);
        const last = messages.lastChild;
        if (last && last.classList.contains('imessage-ai') && last.innerText === 'One moment. Rally AI is thinking...') {
            messages.removeChild(last);
        }
        appendMessage('<div><strong class="text-red-600">Rally AI:</strong> Sorry, something went wrong.</div>', 'ai');
    }
});


</script>
{% endblock %} 