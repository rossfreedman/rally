{% extends "mobile/layout.html" %}
{% set cache_buster = range(100000, 999999) | random %}
{% set timestamp = range(1000000000, 9999999999) | random %}

{% block content %}
<!-- Force no cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- Custom CSS for main-alt page -->
<style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
        }
        
        .section-hero {
            background: #045454;
        }
        
        .pti-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
            border: 8px solid #bff863;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(191, 248, 99, 0.3);
        }
        
        .hover-lift {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }
        
        .carousel {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .carousel::-webkit-scrollbar {
            display: none;
        }

        /* Sticky Navigation Styles */
        .sticky-nav {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: #045454;
        }

        .sticky-nav.scrolled {
            background: rgba(4, 84, 84, 0.98);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
        }

        .nav-button.scrolled {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-button.scrolled:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        /* Active state styling */
        .nav-button.active {
            background: #bff863 !important;
            color: #045454 !important;
        }

        .nav-button.active:hover {
            background: #bff863 !important;
            color: #045454 !important;
        }

        /* Smooth scroll behavior */
        html {
            scroll-behavior: smooth;
        }

        /* Add padding to account for sticky nav */
        .main-content {
            padding-top: 0;
        }

        /* Persistence styles */
        .persistent-card {
            transition: all 0.3s ease;
        }
        
        .persistent-card.loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .persistent-card.loaded {
            opacity: 1;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Video aspect ratio */
        .aspect-video {
            aspect-ratio: 16 / 9;
            position: relative;
            width: 100%;
        }

        /* Fallback for browsers that don't support aspect-ratio */
        @supports not (aspect-ratio: 16 / 9) {
            .aspect-video {
                padding-bottom: 56.25%; /* 16:9 aspect ratio */
                height: 0;
                position: relative;
            }
            .aspect-video > * {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        }
    </style>

<!-- Main content starts here -->

    <!-- ============================================
         HEADER (Fixed at top, below navbar)
         ============================================ -->
    <header class="section-hero text-white shadow-lg rounded-2xl" style="margin-top: 11px;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                {% if session_data and session_data.user and session_data.user.club_logo %}
                <img src="/{{ session_data.user.club_logo }}" 
                     alt="{{ session_data.user.club }} Logo" 
                     class="w-20 h-20 object-contain rounded-xl"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                {% endif %}
                <div class="w-20 h-20 text-white flex items-center justify-center font-bold text-lg rounded-xl" 
                     style="{% if session_data and session_data.user and session_data.user.club_logo %}display: none;{% endif %}background-color: #bff863; color: #045454;">
                    {{ session_data.user.club[0:2] if session_data and session_data.user and session_data.user.club else 'CL' }}
                </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h1 class="text-3xl font-bold tracking-tight">Welcome back, {{ session_data.user.first_name }}</h1>
                {% if session_data and session_data.user and session_data.user.league_name %}
                <!-- League Information -->
                <div class="text-sm space-y-1 mt-1">
                    <div class="flex items-center">
                        <span class="font-medium text-white/90">{{ session_data.user.league_name }}</span>
                    </div>
                    
                    <div class="flex items-center">
                        <span class="font-medium text-white/80">{{ session_data.user.series }} @ {{ session_data.user.club }}</span>
                        <button id="leagueSwitcherTrigger" class="ml-2 text-blue-300 text-xs underline hidden hover:text-blue-200" aria-label="Change League" style="font-size: 10px;" onclick="showLeagueSwitcher()">
                            (change)
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
            
        </div>
    </header>

    <!-- Sticky Navigation Tabs (Persistent below header) -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4" style="position: sticky; top: 56px; z-index: 50;">
        <nav id="main-nav" class="sticky-nav rounded-3xl px-6 py-4 shadow-xl">
            <div class="flex gap-1.5 justify-center">
                <a href="#schedule" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Schedule</a>
                <a href="#team" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Team</a>
                <a href="#club" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Club</a>
                <a href="#play" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Play</a>
                <a href="#improve" class="nav-button px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-xs font-medium whitespace-nowrap hover:bg-white/20 transition text-white">Improve</a>
            </div>
        </nav>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">

        <!-- ============================================
             1. DASHBOARD SECTION
             ============================================ -->
        <section id="dashboard" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Dashboard</h2>
            </div>
            
            <!-- PTI Hero Card -->
            <div class="section-hero rounded-3xl p-8 sm:p-12 text-center text-white shadow-xl hover-lift persistent-card" id="pti-card">
                <div id="pti-loading" class="py-8">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="pti-content" class="hidden">
                    <h3 class="text-xl font-semibold mb-6 text-white/90">My PTI</h3>
                    <div class="pti-circle mx-auto mb-6">
                        <div id="pti-value" class="text-6xl font-bold">--</div>
                    </div>
                    <p id="pti-message" class="text-lg text-white/90 max-w-2xl mx-auto"></p>
                <a href="/mobile/analyze-me" class="inline-block mt-6 px-8 py-3 rounded-full font-semibold transition shadow-lg" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                    Tell me more
                </a>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="space-y-4">
                <!-- First Row: My Record and Win Rate -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift persistent-card" id="record-card">
                        <div class="text-2xl font-bold text-[#045454] mb-4">My Record</div>
                        <div id="my-record" class="text-3xl font-bold text-[#045454]">-- - --</div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift persistent-card" id="winrate-card">
                        <div class="text-2xl font-bold text-[#045454] mb-4">Win Rate</div>
                        <div id="win-rate" class="text-3xl font-bold text-[#045454]">--%</div>
                    </div>
                </div>
                
                <!-- Second Row: Win Streak -->
                <div class="grid grid-cols-1">
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                        <div class="text-2xl font-bold text-[#045454] mb-4">Win Streak</div>
                        <div id="win-streak" class="text-3xl font-bold text-rally-green">üî• --</div>
                    </div>
                </div>
                
                <!-- Third Row: Best Partner -->
                <div class="grid grid-cols-1">
                    <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                        <div class="text-2xl font-bold text-[#045454] mb-4">Best Partner</div>
                        <div id="best-partner-content">
                            <div class="text-center py-4">
                                <div class="w-8 h-8 border-4 border-gray-200 border-t-[#045454] rounded-full animate-spin mx-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Last Match Results -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-[#045454] mb-4">My Last Match</h3>
                <div id="last-match-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                <div id="last-match-content" class="hidden"></div>
                <div id="last-match-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-times text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No recent matches found</p>
                </div>
            </div>
        </section>

        <!-- ============================================
             2. SCHEDULE SECTION
             ============================================ -->
        <section id="schedule" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Schedule</h2>
            </div>
            
            <!-- Next Match Hero -->
            <div class="rounded-3xl p-8 text-white shadow-xl hover-lift" style="background-color: #045454;">
                <div id="next-match-loading" class="text-center py-8">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="next-match-content" class="hidden">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-calendar-star text-2xl"></i>
                        <h3 class="text-2xl font-bold">Next Match</h3>
                    </div>
                    <div id="next-match-details"></div>
                </div>
                
                <div id="next-match-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-alt text-4xl mb-4 opacity-50"></i>
                    <p class="text-white/80">No upcoming matches scheduled</p>
                </div>
            </div>
            

            <!-- Upcoming Matches & Practices -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Future Matches -->
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-trophy" style="color: #bff863;"></i>
                            Future Matches
                        </h3>
                    </div>
                    
                    <div id="opponents-loading" class="text-center py-8">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                    
                    <div id="opponents-content" class="hidden space-y-3"></div>
                    
                    <div id="opponents-empty" class="hidden text-center py-8">
                        <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No upcoming matches</p>
                    </div>
                    
                    <a href="/mobile/availability" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        Update Match Availability
                    </a>
                </div>
                
                <!-- Next 3 Practices -->
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-dumbbell" style="color: #bff863;"></i>
                            Next 3 Practices
                        </h3>
                    </div>
                    
                    <div id="practices-loading" class="text-center py-8">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                    
                    <div id="practices-content" class="hidden space-y-3"></div>
                    
                    <div id="practices-empty" class="hidden text-center py-8">
                        <i class="fas fa-dumbbell text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No upcoming practices</p>
                    </div>
                    
                    <a href="/mobile/availability" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        Update Practice Availability
                    </a>
                </div>
            </div>
        </section>

        <!-- ============================================
             3. TEAM SECTION
             ============================================ -->
        <section id="team" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">My Team</h2>
            </div>
            
            <!-- Captain's Message -->
            <div id="captain-message-section" class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 shadow-md border-l-4 border-rally-green hidden">
                <h3 class="text-xl font-bold text-[#045454] mb-3 flex items-center gap-2">
                    <i class="fas fa-bullhorn text-rally-green"></i>
                    Captain's Message
                </h3>
                <div id="captain-message-content"></div>
            </div>
            
            <!-- How Are We Doing? -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-6" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0" style="color: #bff863;">How Are We Doing?</h3>
                </div>
                
                <div class="space-y-4">
                    <!-- First Row: Total Points, Avg Pts, and Behind 1st -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Total Points</div>
                            <div id="team-points" class="text-3xl font-bold text-rally-green">--</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Avg Pts</div>
                            <div id="avg-points" class="text-3xl font-bold text-blue-500">--</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Behind 1st</div>
                            <div id="points-behind" class="text-3xl font-bold text-orange-500">--</div>
                        </div>
                    </div>
                    
                    <!-- Second Row: Team Record and Win Rate -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Team Record</div>
                            <div id="team-record" class="text-2xl font-bold text-[#045454]">-- - --</div>
                        </div>
                        
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div class="text-sm text-gray-500 mb-1">Win Rate</div>
                            <div id="team-win-rate" class="text-3xl font-bold text-[#045454]">--%</div>
                        </div>
                    </div>
                </div>
                
                <a href="/mobile/my-team" class="block mt-6 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    My Team Page ‚Üí
                </a>
            </div>
            
            <!-- Series Overview -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0" style="color: #bff863;">Series Standings</h3>
                </div>
                
                <div id="series-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="series-content" class="hidden">
                    <div class="overflow-x-auto">
                        <table id="seriesTable" class="w-full text-sm text-left" style="table-layout: fixed;">
                            <!-- Table will be populated by JS -->
                        </table>
                    </div>
                </div>
                
                <a href="/mobile/my-series" class="block mt-6 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    View Full Standings ‚Üí
                </a>
            </div>
            
            <!-- Team Polls -->
            <div id="team-polls-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-poll" style="color: #bff863;"></i>
                        Team Polls
                    </h3>
                </div>
                
                <!-- Active Polls -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-[#045454] mb-3 flex items-center gap-2">
                        <i class="fas fa-clock text-green-500"></i>
                        Active Polls
                    </h4>
                    <div id="active-polls-content" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">Loading active polls...</div>
                    </div>
                </div>
                
                <!-- Past Polls -->
                <div class="mb-4">
                    <h4 class="text-lg font-semibold text-[#045454] mb-3 flex items-center gap-2">
                        <i class="fas fa-history text-gray-500"></i>
                        Past Polls
                    </h4>
                    <div id="past-polls-content" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">Loading past polls...</div>
                    </div>
                </div>
                
                <a href="/mobile/polls" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    View All Polls ‚Üí
                </a>
            </div>
        </section>

        <!-- ============================================
             4. CLUB SECTION
             ============================================ -->
        <section id="club" class="space-y-6">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">My Club</h2>
            </div>
            
            
            <!-- Club Highlights Grid -->
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Teams in 1st Place -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-trophy" style="color: #bff863;"></i>
                            {{ session_data.user.club or 'Club' }} Teams in 1st Place
                        </h3>
                    </div>
                    
                    <!-- Loading state -->
                    <div id="first-place-loading" class="text-center py-4">
                        <div class="w-6 h-6 border-2 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-2">Loading teams...</p>
                    </div>
                    
                    <!-- Table content -->
                    <div id="first-place-content" class="hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="py-1 px-2 text-left text-xs font-medium text-gray-700">Team</th>
                                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700">Place</th>
                                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700">Avg Pts</th>
                                        <th class="py-1 px-2 text-center text-xs font-medium text-gray-700">Total Pts</th>
                                    </tr>
                                </thead>
                                <tbody id="first-place-teams-table">
                                    <!-- Teams will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Empty state -->
                    <div id="first-place-empty" class="hidden text-center py-4">
                        <i class="fas fa-trophy text-2xl text-gray-300 mb-2"></i>
                        <p class="text-sm text-gray-500">No teams in 1st place</p>
                    </div>
                </div>
                
                
                <!-- PTI Movers & Shakers -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-chart-line" style="color: #bff863;"></i>
                            PTI Movers & Shakers
                        </h3>
                    </div>
                    <div id="pti-movers-list" class="space-y-2 mb-4">
                        <div class="text-center text-gray-500 py-4">Loading...</div>
                    </div>
                    <a href="/mobile/pti-movers" class="block w-full text-center py-2 px-4 text-white rounded-lg font-medium transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        View More ‚Üí
                    </a>
                </div>
            </div>
            
            <!-- Who's Hot at Club -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-fire" style="color: #bff863;"></i>
                        Who's Hot at {{ session_data.user.club }}
                    </h3>
                </div>
                
                <div id="players-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="players-carousel" class="hidden space-y-2"></div>
                
                <div id="players-empty" class="hidden text-center py-8">
                    <i class="fas fa-users text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No player data available</p>
                </div>
            </div>
            
            <!-- Club Events -->
            <div id="club-events-section" class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6 shadow-md hidden">
                <h3 class="text-2xl font-bold text-[#045454] mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-star text-purple-600"></i>
                    Club Events
                </h3>
                <div id="club-events-content"></div>
            </div>
            
            <!-- Food & Beer -->
            <div class="grid md:grid-cols-2 gap-6">
                <div id="food-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-utensils" style="color: #bff863;"></i>
                            Food Menu
                        </h3>
                    </div>
                    <div id="food-content"></div>
                </div>
                
                <div id="beer-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                    <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                        <h3 class="text-xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                            <i class="fas fa-beer" style="color: #bff863;"></i>
                            Beer Menu
                        </h3>
                    </div>
                    <div id="beer-content"></div>
                </div>
            </div>
            
            <a href="/mobile/improve" class="block text-center py-4 text-white rounded-2xl font-semibold transition text-lg shadow-md" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                More Club Info ‚Üí
            </a>
        </section>

        <!-- ============================================
             5. PLAY SECTION
             ============================================ -->
        <section id="play" class="space-y-6 pb-12">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Play</h2>
            </div>
            
            <!-- Pickup Games -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-users" style="color: #bff863;"></i>
                        Pickup Games
                    </h3>
                </div>
                
                <div id="pickup-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="pickup-content" class="hidden space-y-3"></div>
                
                <div id="pickup-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No pickup games available</p>
                </div>
                
                <div class="flex gap-3 mt-4">
                    <a href="/mobile/pickup-games" class="flex-1 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                        View All Pickup Games ‚Üí
                    </a>
                    <a href="/mobile/create-pickup-game?type=public" class="flex-1 text-center py-3 rounded-xl font-semibold transition" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                        Create Pickup Game
                    </a>
                </div>
            </div>
            
            <!-- Find People to Play -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-user-friends" style="color: #bff863;"></i>
                        Find People to Play
                    </h3>
                </div>
                
                <div class="space-y-4">
                    <!-- Quick Search Form -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                            <input type="text" id="quickFirstName" placeholder="Enter first name" 
                                   class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-rally-green focus:border-rally-green">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                            <input type="text" id="quickLastName" placeholder="Enter last name" 
                                   class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-rally-green focus:border-rally-green">
                        </div>
                    </div>
                    
                    <!-- Search Buttons -->
                    <div class="pt-2">
                        <button id="quickSearchBtn" class="w-full px-4 py-3 text-white rounded-lg focus:outline-none focus:ring-2 transition-colors duration-200 font-medium" style="background-color: #045454; border-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                            <i class="fas fa-search mr-2"></i>Search Players
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================
             6. IMPROVE SECTION
             ============================================ -->
        <section id="improve" class="space-y-6 pb-12">
            <!-- Option 4: Rally Branded with Logo Watermark -->
            <div class="bg-gradient-to-r from-[#045454] to-[#067373] rounded-2xl px-8 py-6 shadow-lg mb-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-5">
                    <img src="/static/images/rally_favicon.png" alt="Rally" class="w-48 h-48 filter brightness-0 invert">
                </div>
                <h2 class="text-4xl font-bold text-white tracking-tight text-center relative z-10">Improve</h2>
            </div>
            
            <!-- Latest Paddle Tip -->
            <div class="rounded-3xl p-8 text-white shadow-xl hover-lift" style="background-color: #045454;">
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-3xl"></i>
                    Latest Paddle Tip
                </h3>
                
                <div id="paddle-tip-loading" class="text-center py-8">
                    <div class="w-8 h-8 border-4 border-white/30 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="paddle-tip-content" class="hidden text-lg mb-6 text-white/90">
                    <!-- Dynamic content will be loaded here -->
                </div>
                
                <div id="paddle-tip-empty" class="hidden text-center py-8">
                    <i class="fas fa-lightbulb text-4xl text-white/50 mb-2"></i>
                    <p class="text-white/70">Paddle tips coming soon!</p>
                </div>
                
                <a href="/mobile/improve" class="inline-block px-8 py-3 bg-white rounded-full font-semibold hover:bg-gray-100 transition shadow-lg" style="color: #045454;">
                    Improve My Game ‚Üí
                </a>
            </div>
            
            <!-- Featured Training Video -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-play-circle" style="color: #bff863;"></i>
                        Featured Training Video
                    </h3>
                </div>
                
                <div id="training-video-content" class="space-y-4">
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <i class="fas fa-video text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 mb-4">Loading featured video...</p>
                        <div class="w-8 h-8 border-4 border-gray-300 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                </div>
                
                <a href="/mobile/training-videos" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    Browse All Videos ‚Üí
                </a>
            </div>
            
            <!-- My Lessons -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <div class="rounded-xl p-4 mb-4" style="background-color: #045454;">
                    <h3 class="text-2xl font-bold mb-0 flex items-center gap-2" style="color: #bff863;">
                        <i class="fas fa-graduation-cap" style="color: #bff863;"></i>
                        My Lessons
                    </h3>
                </div>
                
                <div id="lessons-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="lessons-content" class="hidden space-y-3"></div>
                
                <div id="lessons-empty" class="hidden text-center py-8">
                    <i class="fas fa-graduation-cap text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No lessons scheduled</p>
                </div>
                
                <a href="/mobile/schedule-lesson" class="block mt-4 text-center py-3 text-white rounded-xl font-semibold transition" style="background-color: #045454;" onmouseover="this.style.backgroundColor='#033d3d'" onmouseout="this.style.backgroundColor='#045454'">
                    Schedule Lesson
                </a>
            </div>
        </section>

    </main>


    <!-- ============================================
         JAVASCRIPT - DATA LOADING
         ============================================ -->
    <script id="main-alt-script-{{ cache_buster }}-{{ timestamp }}">
        // Cache buster: {{ cache_buster }} - Timestamp: {{ timestamp }}
        console.log('Main Alt JavaScript loaded - Cache buster: {{ cache_buster }} - Timestamp: {{ timestamp }}');
        console.log('Testing if our script is working...');
        
        // Force immediate execution to prevent caching issues
        (function() {
            console.log('Immediate execution function called - Script ID: main-alt-script-{{ cache_buster }}-{{ timestamp }}');
            console.log('JavaScript syntax check passed');
        })();
        
        // Set session data for JavaScript access
        try {
            // Temporarily disable session data to isolate syntax error
            window.sessionData = {};
            console.log('Session data set successfully (simplified)');
        } catch (error) {
            console.error('Error setting session data:', error);
            window.sessionData = {};
        }
        
        // Add a visible test to make sure our script is running
        window.testStickyNav = function() {
            console.log('Test function called');
            const nav = document.getElementById('main-nav');
            if (nav) {
                nav.style.border = '5px solid red';
                console.log('Navigation element found and styled');
            } else {
                console.log('Navigation element NOT found');
            }
        };
        
        // Test if we can find the navigation element right away
        setTimeout(function() {
            const nav = document.getElementById('main-nav');
            console.log('Navigation element found:', nav);
            if (nav) {
                console.log('Navigation classes:', nav.className);
                console.log('Navigation position:', nav.offsetTop);
            }
        }, 100);
        
        // Initialize all data on page load - OPTIMIZED
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting OPTIMIZED initialization');
            
            // Initialize persistence system
            initPersistence();
            
            // OPTIMIZED: Load data in parallel for better performance
            loadAllDataInParallel();
            
            console.log('About to initialize sticky navigation');
            initStickyNavigation();
            console.log('Sticky navigation initialization complete');
            
            // Check for multiple leagues and show league switcher if needed
            checkMultipleLeagues();
        });
        
        // OPTIMIZED: Load all data in parallel instead of sequentially
        async function loadAllDataInParallel() {
            console.log('üîÑ Starting parallel data loading...');
            
            try {
                // Load all data simultaneously using Promise.allSettled for better error handling
                await Promise.allSettled([
                    loadPTIData(),
                    loadUpcomingMatches(),
                    loadPractices(),
                    loadTopPlayers(),
                    loadNotifications(),
                    loadTeamData(),
                    loadSeriesStandings(),
                    loadPickupGames(),
                    loadMyLessons(),
                    loadPaddleTip()
                ]);
                
                console.log('‚úÖ All data loaded in parallel');
            } catch (error) {
                console.error('‚ùå Error during parallel loading:', error);
            }
        }
        
        // OPTIMIZED: Add simple caching to avoid repeated API calls
        const apiCache = new Map();
        const CACHE_DURATION = 30000; // 30 seconds
        
        function getCachedData(key) {
            const cached = apiCache.get(key);
            if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
                console.log(`üì¶ Using cached data for ${key}`);
                return cached.data;
            }
            return null;
        }
        
        function setCachedData(key, data) {
            apiCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
            console.log(`üíæ Cached data for ${key}`);
        }
        
        // OPTIMIZED: Enhanced fetch with caching
        async function fetchWithCache(url, cacheKey) {
            // Check cache first
            const cachedData = getCachedData(cacheKey);
            if (cachedData) {
                return cachedData;
            }
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                // Cache the data
                setCachedData(cacheKey, data);
                return data;
            } catch (error) {
                console.error(`‚ùå Error fetching ${cacheKey}:`, error);
                throw error;
            }
        }

        // ============================================
        // PERSISTENCE SYSTEM
        // ============================================
        function initPersistence() {
            console.log('Initializing persistence system...');
            
            // Restore persisted data immediately
            restorePersistedData();
            
            // Set up periodic saving
            setInterval(savePersistedData, 30000); // Save every 30 seconds
            
            // Save on page unload
            window.addEventListener('beforeunload', savePersistedData);
            
            console.log('Persistence system initialized');
        }

        function savePersistedData() {
            try {
                const dashboardData = {
                    pti: {
                        value: document.getElementById('pti-value')?.textContent || '--',
                        message: document.getElementById('pti-message')?.textContent || '',
                        timestamp: Date.now()
                    },
                    record: {
                        value: document.getElementById('my-record')?.textContent || '-- - --',
                        className: document.getElementById('my-record')?.className || '',
                        timestamp: Date.now()
                    },
                    winRate: {
                        value: document.getElementById('win-rate')?.textContent || '--%',
                        className: document.getElementById('win-rate')?.className || '',
                        timestamp: Date.now()
                    }
                };
                
                localStorage.setItem('rally_dashboard_data', JSON.stringify(dashboardData));
                console.log('Dashboard data persisted to localStorage');
            } catch (error) {
                console.error('Error saving persisted data:', error);
            }
        }

        function restorePersistedData() {
            try {
                const savedData = localStorage.getItem('rally_dashboard_data');
                if (!savedData) {
                    console.log('No persisted data found');
                    return;
                }
                
                const dashboardData = JSON.parse(savedData);
                const now = Date.now();
                const maxAge = 5 * 60 * 1000; // 5 minutes
                
                // Restore PTI data if recent and valid
                if (dashboardData.pti && (now - dashboardData.pti.timestamp) < maxAge) {
                    const ptiCard = document.getElementById('pti-card');
                    if (ptiCard) {
                        // Only restore if we had valid PTI data (not "--")
                        if (dashboardData.pti.value && dashboardData.pti.value !== '--' && parseFloat(dashboardData.pti.value) > 0) {
                            ptiCard.classList.add('loaded');
                            document.getElementById('pti-value').textContent = dashboardData.pti.value;
                            document.getElementById('pti-message').textContent = dashboardData.pti.message;
                            document.getElementById('pti-loading').classList.add('hidden');
                            document.getElementById('pti-content').classList.remove('hidden');
                            console.log('PTI data restored from cache');
                        } else {
                            // Hide PTI card if cached data was invalid
                            ptiCard.classList.add('hidden');
                        }
                    }
                }
                
                // Restore record data if recent
                if (dashboardData.record && (now - dashboardData.record.timestamp) < maxAge) {
                    const recordCard = document.getElementById('record-card');
                    if (recordCard) {
                        recordCard.classList.add('loaded');
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = dashboardData.record.value;
                        if (dashboardData.record.className) {
                            recordElement.className = dashboardData.record.className;
                        }
                        console.log('Record data restored from cache');
                    }
                }
                
                // Restore win rate data if recent
                if (dashboardData.winRate && (now - dashboardData.winRate.timestamp) < maxAge) {
                    const winrateCard = document.getElementById('winrate-card');
                    if (winrateCard) {
                        winrateCard.classList.add('loaded');
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = dashboardData.winRate.value;
                        if (dashboardData.winRate.className) {
                            winRateElement.className = dashboardData.winRate.className;
                        }
                        console.log('Win rate data restored from cache');
                    }
                }
                
                console.log('Persisted data restored successfully');
            } catch (error) {
                console.error('Error restoring persisted data:', error);
            }
        }
        
        // ============================================
        // PTI DATA LOADING
        // ============================================
        async function loadPTIData() {
            const loading = document.getElementById('pti-loading');
            const content = document.getElementById('pti-content');
            const ptiCard = document.getElementById('pti-card');
            
            try {
                // Use the same API as analyze-me page for consistent PTI data
                const response = await fetch('/api/player-analysis');
                
                loading.classList.add('hidden');
                
                if (!response.ok) {
                    // Hide PTI card if no data available
                    ptiCard.classList.add('hidden');
                    return;
                }
                
                const data = await response.json();
                
                if (data.error || !data.success) {
                    // Hide PTI card if no data available
                    ptiCard.classList.add('hidden');
                    return;
                }
                
                // Check if user has valid PTI data
                const currentPTI = data.current_pti || 0;
                if (currentPTI <= 0) {
                    // Hide PTI card if no valid PTI data
                    ptiCard.classList.add('hidden');
                    return;
                }
                
                // Show PTI card if we have valid data
                content.classList.remove('hidden');
                
                document.getElementById('pti-value').textContent = currentPTI.toFixed(1);
                
                // Calculate PTI delta since start of season (same logic as analyze-me)
                let deltaDisplay = '';
                if (data.delta_available && data.pti_delta !== null) {
                    const ptiDelta = data.pti_delta;
                    if (ptiDelta > 0) {
                        deltaDisplay = `<div class="text-lg text-white/90 mt-2 font-semibold">+${ptiDelta.toFixed(1)} since start of season</div>`;
                    } else if (ptiDelta < 0) {
                        deltaDisplay = `<div class="text-lg text-white/90 mt-2 font-semibold">${ptiDelta.toFixed(1)} since start of season</div>`;
                    } else {
                        deltaDisplay = `<div class="text-lg text-white/90 mt-2 font-semibold">No change since start of season</div>`;
                    }
                }
                
                // Get current season stats from the same API as analyze-me page
                const seasonStatsResponse = await fetch('/api/current-season-stats');
                if (seasonStatsResponse.ok) {
                    const seasonStatsData = await seasonStatsResponse.json();
                    if (seasonStatsData.success && seasonStatsData.matches > 0) {
                        // Use the actual current season data from analyze-me
                        const wins = seasonStatsData.wins || 0;
                        const losses = seasonStatsData.losses || 0;
                        const winRate = Math.round(seasonStatsData.win_rate || 0);
                        
                        // Apply color coding based on win rate
                        let recordColor = '';
                        let winRateColor = '';
                        
                        if (winRate > 50) {
                            recordColor = 'text-green-500';
                            winRateColor = 'text-green-500';
                        } else if (winRate >= 34 && winRate <= 50) {
                            recordColor = 'text-yellow-500';
                            winRateColor = 'text-yellow-500';
                        } else {
                            recordColor = 'text-red-500';
                            winRateColor = 'text-red-500';
                        }
                        
                        // Set record with color
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = `${wins} - ${losses}`;
                        recordElement.className = `text-3xl font-bold ${recordColor}`;
                        
                        // Set win rate with color
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = `${winRate}%`;
                        winRateElement.className = `text-3xl font-bold ${winRateColor}`;
                        
                        // Mark cards as loaded and save to persistence
                        document.getElementById('record-card').classList.add('loaded');
                        document.getElementById('winrate-card').classList.add('loaded');
                        savePersistedData();
                        
                        // Random "no streak" messages
                        const noStreakMessages = [
                            'No streak yet‚Ä¶ but the fuse is lit. üî•',
                            'Win streak? Not yet ‚Äî but you\'re due.',
                            'Still warming up‚Ä¶ streak coming soon.',
                            'No streak yet, but every rally starts somewhere.',
                            'You\'re one win away from bragging rights.',
                            'No streak yet ‚Äî time to flip the script.',
                            'Keep grindin\'‚Ä¶ that streak\'s loading. ‚è≥',
                            'Not streakin\' yet‚Ä¶ but it\'s comin\'.',
                            'Still searching for that hot hand‚Ä¶ stay with it.',
                            'No streak yet ‚Äî gotta start the fire before it burns.',
                            'No win streak yet...keep work\'in at it...you\'ll get there.',
                            'No streak yet‚Ä¶ but hey, Rome wasn\'t built in one set.',
                            'No streak yet ‚Äî maybe your paddle\'s still in warm-up mode.',
                            'No streak? Must be saving it for the playoffs.',
                            'Still streakless. Maybe bribe your partner with bagels next time. ü•Ø',
                            'Technically, not losing is a streak‚Ä¶ right?'
                        ];
                        
                        // Function to get random message
                        const getRandomNoStreakMessage = () => {
                            const randomIndex = Math.floor(Math.random() * noStreakMessages.length);
                            return `<span class="text-lg text-gray-600">${noStreakMessages[randomIndex]}</span>`;
                        };
                        
                        // Calculate win streak from last-3-matches (for streak only)
                        const lastMatchesResponse = await fetch('/api/last-3-matches');
                        if (lastMatchesResponse.ok) {
                            const lastMatchesData = await lastMatchesResponse.json();
                            if (lastMatchesData.matches && lastMatchesData.matches.length > 0) {
                                let currentStreak = 0;
                                const matches = lastMatchesData.matches.reverse();
                                
                                for (const match of matches) {
                                    const isHome = match['Home Team'] && match['Home Team'].includes('{{ session_data.user.club | replace("'", "\\'") }}');
                                    const won = (isHome && match.Winner === 'home') || (!isHome && match.Winner === 'away');
                                    
                                    if (won) {
                                        currentStreak++;
                                    } else {
                                        break; // Stop counting streak after first loss
                                    }
                                }
                                
                                document.getElementById('win-streak').innerHTML = currentStreak > 0 ? `üî• ${currentStreak}` : getRandomNoStreakMessage();
                            } else {
                                document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                            }
                        } else {
                            document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                        }
                    } else {
                        // No current season data available
                        const recordElement = document.getElementById('my-record');
                        recordElement.textContent = '0 - 0';
                        recordElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                        
                        const winRateElement = document.getElementById('win-rate');
                        winRateElement.textContent = '0%';
                        winRateElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                        
                        document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                        // Mark cards as loaded and save to persistence
                        document.getElementById('record-card').classList.add('loaded');
                        document.getElementById('winrate-card').classList.add('loaded');
                        savePersistedData();
                    }
                } else {
                    // Fallback if current-season-stats fails
                    const recordElement = document.getElementById('my-record');
                    recordElement.textContent = '0 - 0';
                    recordElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                    
                    const winRateElement = document.getElementById('win-rate');
                    winRateElement.textContent = '0%';
                    winRateElement.className = 'text-3xl font-bold text-red-500'; // 0% win rate = red
                    
                    document.getElementById('win-streak').innerHTML = getRandomNoStreakMessage();
                    // Mark cards as loaded and save to persistence
                    document.getElementById('record-card').classList.add('loaded');
                    document.getElementById('winrate-card').classList.add('loaded');
                    savePersistedData();
                }
                
                // Display only the delta information (PTI value is already shown in the circle)
                let message = '';
                
                document.getElementById('pti-message').innerHTML = message + deltaDisplay;
                
                // Mark card as loaded and save to persistence
                document.getElementById('pti-card').classList.add('loaded');
                savePersistedData();
                
                // Load best partner data using the same API as analyze-me page
                await loadBestPartner();
                
                // Load last match data using the same API as analyze-me page
                await loadLastMatchData();
                
            } catch (error) {
                console.error('Error loading PTI data:', error);
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                document.getElementById('pti-value').textContent = '--';
                document.getElementById('pti-message').innerHTML = 'Unable to load stats';
                // Mark card as loaded and save to persistence
                document.getElementById('pti-card').classList.add('loaded');
                savePersistedData();
            }
        }
        
        // ============================================
        // UPCOMING MATCHES LOADING
        // ============================================
        async function loadUpcomingMatches() {
            const nextMatchLoading = document.getElementById('next-match-loading');
            const nextMatchContent = document.getElementById('next-match-content');
            const nextMatchEmpty = document.getElementById('next-match-empty');
            const opponentsLoading = document.getElementById('opponents-loading');
            const opponentsContent = document.getElementById('opponents-content');
            const opponentsEmpty = document.getElementById('opponents-empty');
            
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                
                nextMatchLoading.classList.add('hidden');
                opponentsLoading.classList.add('hidden');
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    nextMatchEmpty.classList.remove('hidden');
                    opponentsEmpty.classList.remove('hidden');
                    return;
                }
                
                // Filter for upcoming matches only (not practices)
                const now = new Date();
                const upcomingMatches = data.matches
                    .filter(match => {
                        try {
                            const matchDate = new Date(match.date);
                            const isUpcoming = matchDate >= now;
                            const isNotPractice = match.type === 'match' && match.away_team && match.away_team !== 'Practice';
                            return isUpcoming && isNotPractice;
                        } catch (e) {
                            return false;
                        }
                    });
                
                if (upcomingMatches.length === 0) {
                    nextMatchEmpty.classList.remove('hidden');
                    opponentsEmpty.classList.remove('hidden');
                    return;
                }
                
                // Next Match (first one)
                const nextMatch = upcomingMatches[0];
                nextMatchContent.classList.remove('hidden');
                const homeTeam = nextMatch.home_team || '';
                const awayTeam = nextMatch.away_team || '';
                const isHome = homeTeam.includes('{{ session_data.user.club | replace("'", "\\'") }}') || homeTeam.includes('{{ session_data.user.team_name | replace("'", "\\'") }}');
                const opponentName = isHome ? awayTeam : homeTeam;
                
                const matchDate = new Date(nextMatch.date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = nextMatch.time || 'TBD';
                const location = nextMatch.location || 'TBD';
                
                document.getElementById('next-match-details').innerHTML = `
                    <div class="text-5xl font-bold mb-4">vs ${opponentName}</div>
                    <div class="flex items-center gap-6 text-lg flex-wrap">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar"></i>
                            ${dateStr}
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clock"></i>
                            ${timeStr}
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt"></i>
                            ${location}
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <a href="/mobile/teams-players?team_id=59782" class="flex items-center gap-2 px-4 py-2 rounded-full transition" style="background-color: #bff863; color: #045454;" onmouseover="this.style.backgroundColor='#a8e64a'" onmouseout="this.style.backgroundColor='#bff863'">
                            <i class="fas fa-search"></i>
                            Scout Competition
                        </a>
                        <a href="https://maps.google.com/?q=${encodeURIComponent(location)}" target="_blank" class="px-6 py-2 bg-white rounded-full font-semibold hover:bg-gray-100 transition" style="color: #045454;">Get Directions ‚Üí</a>
                    </div>
                `;
                
                // Get user's availability for all matches
                const user = window.sessionData && window.sessionData.user;
                let availabilityData = [];
                
                if (user && user.id) {
                    try {
                        const availabilityResponse = await fetch('/api/user-availability');
                        const availabilityResult = await availabilityResponse.json();
                        if (availabilityResult.success && availabilityResult.availability) {
                            availabilityData = availabilityResult.availability;
                            console.log('Fetched availability data for matches:', availabilityData);
                        } else {
                            console.log('No availability data found for matches:', availabilityResult);
                        }
                    } catch (e) {
                        console.log('Could not fetch availability data for matches:', e);
                    }
                } else {
                    console.log('No user or user_id found for availability fetch in matches');
                }
                
                // Next 3 Matches (skip the first one since it's shown in Next Match card)
                const next3 = upcomingMatches.slice(1, 4);
                opponentsContent.classList.remove('hidden');
                opponentsContent.innerHTML = '';
                
                next3.forEach(match => {
                    const matchDiv = createMatchElement(match, availabilityData);
                    opponentsContent.appendChild(matchDiv);
                });
                
            } catch (error) {
                console.error('Error loading matches:', error);
                nextMatchLoading.classList.add('hidden');
                opponentsLoading.classList.add('hidden');
                nextMatchEmpty.classList.remove('hidden');
                opponentsEmpty.classList.remove('hidden');
            }
        }
        
        function createMatchElement(match, availabilityData = []) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition';
            
            const homeTeam = match.home_team || '';
            const awayTeam = match.away_team || '';
            const isHome = homeTeam.includes('{{ session_data.user.club | replace("'", "\\'") }}') || homeTeam.includes('{{ session_data.user.team_name | replace("'", "\\'") }}');
            const opponentName = isHome ? awayTeam : homeTeam;
            
            // Extract club name from opponent team name and normalize for logo lookup
            let clubName = opponentName.replace(/\s+\d+$/, '').toLowerCase();
            
            // Handle specific club name mappings for logo files
            const clubMappings = {
                'valley lo': 'valley_lo',
                'michigan shores': 'michigan_shores',
                'glenbrook rc': 'glenbrook_rc',
                'midtown chicago': 'midtownchicago',
                'midt bannockburn': 'midtbannockburn',
                'life sport': 'lifesport',
                'life sport lshire': 'lifesportlshire',
                'river forest': 'riverforest',
                'sunset ridge': 'sunsetridge',
                'winter club': 'winterclub',
                'north shore': 'northshore',
                'lake bluff': 'lakebluff',
                'westmoreland': 'westmoreland',
                'wilmette': 'wilmette',
                'winnetka': 'winnetka',
                'knollwood': 'knollwood',
                'briarwood': 'briarwood',
                'evanston': 'evanston',
                'tennaqua': 'tennaqua'
            };
            
            // Apply mapping if exists, otherwise use the original club name
            clubName = clubMappings[clubName] || clubName.replace(/\s+/g, '_');
            
            const matchDate = new Date(match.date);
            const dateStr = matchDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = match.time || 'TBD';
            const location = match.location || '';
            
            // Get availability status for this match by matching date
            let availabilityStatus = null;
            let statusColor = 'gray';
            let statusText = 'Not Set';
            let statusIcon = 'fas fa-question-circle';
            
            // Find availability for this specific match date
            const matchDateStr = match.date; // Format: YYYY-MM-DD
            const matchingAvailability = availabilityData.find(avail => {
                // Convert both dates to YYYY-MM-DD format for comparison
                const matchDate = new Date(matchDateStr);
                const availDate = new Date(avail.match_date);
                
                // Convert both to YYYY-MM-DD format
                const matchDateFormatted = matchDate.toISOString().split('T')[0];
                const availDateFormatted = availDate.toISOString().split('T')[0];
                
                return availDateFormatted === matchDateFormatted;
            });
            
            if (matchingAvailability) {
                const status = matchingAvailability.availability_status;
                if (status === 1) { // 1 = available
                    availabilityStatus = 'available';
                    statusColor = 'green';
                    statusText = 'Available';
                    statusIcon = 'fas fa-check-circle';
                } else if (status === 2) { // 2 = unavailable
                    availabilityStatus = 'unavailable';
                    statusColor = 'red';
                    statusText = 'Unavailable';
                    statusIcon = 'fas fa-times-circle';
                } else if (status === 3) { // 3 = not_sure
                    availabilityStatus = 'not_sure';
                    statusColor = 'yellow';
                    statusText = 'Not Sure';
                    statusIcon = 'fas fa-question-circle';
                }
            }
            
            div.innerHTML = `
                <div class="w-14 h-14 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
                    <img src="/static/images/clubs/${clubName}_logo.png" 
                         alt="${opponentName} Logo" 
                         class="w-12 h-12 object-contain rounded-lg"
                         onerror="console.log('Logo not found for:', '${clubName}_logo.png'); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 bg-gradient-to-br from-rally-green to-rally-green-light text-white flex items-center justify-center font-bold text-lg rounded-lg" style="display: none;">
                        ${opponentName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase()}
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-[#045454]">vs ${opponentName}</div>
                    <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                    ${location ? `<div class="text-xs text-gray-500">üìç ${location}</div>` : ''}
                </div>
                <div class="flex flex-col items-center justify-center gap-1 w-20">
                    <i class="${statusIcon} text-2xl text-${statusColor}-500"></i>
                    <span class="text-xs font-medium text-${statusColor}-600 text-center leading-tight">${statusText}</span>
                </div>
            `;
            
            return div;
        }
        
        // ============================================
        // PRACTICES LOADING
        // ============================================
        async function loadPractices() {
            const loading = document.getElementById('practices-loading');
            const content = document.getElementById('practices-content');
            const empty = document.getElementById('practices-empty');
            
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                const now = new Date();
                const practices = data.matches
                    .filter(match => {
                        try {
                            const matchDate = new Date(match.date);
                            return matchDate >= now && match.type === 'practice';
                        } catch (e) {
                            return false;
                        }
                    })
                    .slice(0, 3);
                
                if (practices.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                // Get user's availability for all practices
                const user = window.sessionData && window.sessionData.user;
                let availabilityData = [];
                
                if (user && user.id) {
                    try {
                        const availabilityResponse = await fetch('/api/user-availability');
                        const availabilityResult = await availabilityResponse.json();
                        if (availabilityResult.success && availabilityResult.availability) {
                            availabilityData = availabilityResult.availability;
                            console.log('Fetched availability data:', availabilityData);
                        } else {
                            console.log('No availability data found:', availabilityResult);
                        }
                    } catch (e) {
                        console.log('Could not fetch availability data:', e);
                    }
                } else {
                    console.log('No user or user_id found for availability fetch');
                }
                
                practices.forEach((practice, index) => {
                    const practiceDate = new Date(practice.date);
                    const dateStr = practiceDate.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const timeStr = practice.time || 'TBD';
                    const location = practice.location || 'TBD';
                    
                    // Get availability status for this practice by matching date
                    let availabilityStatus = null;
                    let statusColor = 'gray';
                    let statusText = 'Not Set';
                    let statusIcon = 'fas fa-question-circle';
                    
                    // Find availability for this specific practice date
                    const practiceDateStr = practice.date; // Format: YYYY-MM-DD
                    const matchingAvailability = availabilityData.find(avail => {
                        // Convert both dates to YYYY-MM-DD format for comparison
                        const practiceDate = new Date(practiceDateStr);
                        const availDate = new Date(avail.match_date);
                        
                        // Convert both to YYYY-MM-DD format
                        const practiceDateFormatted = practiceDate.toISOString().split('T')[0];
                        const availDateFormatted = availDate.toISOString().split('T')[0];
                        
                        console.log('Date matching:', {
                            practiceDate: practiceDateStr,
                            practiceDateFormatted: practiceDateFormatted,
                            availDate: avail.match_date,
                            availDateFormatted: availDateFormatted,
                            match: availDateFormatted === practiceDateFormatted
                        });
                        
                        return availDateFormatted === practiceDateFormatted;
                    });
                    
                    if (matchingAvailability) {
                        const status = matchingAvailability.availability_status;
                        if (status === 1) { // 1 = available
                            availabilityStatus = 'available';
                            statusColor = 'green';
                            statusText = 'Available';
                            statusIcon = 'fas fa-check-circle';
                        } else if (status === 2) { // 2 = unavailable
                            availabilityStatus = 'unavailable';
                            statusColor = 'red';
                            statusText = 'Unavailable';
                            statusIcon = 'fas fa-times-circle';
                        } else if (status === 3) { // 3 = not_sure
                            availabilityStatus = 'not_sure';
                            statusColor = 'yellow';
                            statusText = 'Not Sure';
                            statusIcon = 'fas fa-question-circle';
                        }
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-xl';
                    div.innerHTML = `
                        <div class="w-14 h-14 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-2xl flex-shrink-0">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-[#045454]">${practice.description || 'Practice'}</div>
                            <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                            <div class="text-xs text-gray-500">üìç ${location}</div>
                        </div>
                        <div class="flex flex-col items-center justify-center gap-1 w-20">
                            <i class="${statusIcon} text-2xl text-${statusColor}-500"></i>
                            <span class="text-xs font-medium text-${statusColor}-600 text-center leading-tight">${statusText}</span>
                        </div>
                    `;
                    content.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading practices:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // MY LESSONS LOADING
        // ============================================
        async function loadMyLessons() {
            const loading = document.getElementById('lessons-loading');
            const content = document.getElementById('lessons-content');
            const empty = document.getElementById('lessons-empty');
            
            try {
                const response = await fetch('/api/my-lessons');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (data.error || !data.success || !data.lessons || data.lessons.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                data.lessons.forEach(lesson => {
                    const lessonDate = new Date(lesson.lesson_date);
                    const dateStr = lessonDate.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const timeStr = lesson.lesson_time || 'TBD';
                    const status = lesson.status || 'requested';
                    
                    // Status styling
                    let statusColor = 'gray';
                    let statusText = status.charAt(0).toUpperCase() + status.slice(1);
                    let statusIcon = 'fas fa-clock';
                    
                    if (status === 'confirmed') {
                        statusColor = 'green';
                        statusIcon = 'fas fa-check-circle';
                    } else if (status === 'declined') {
                        statusColor = 'red';
                        statusIcon = 'fas fa-times-circle';
                    } else if (status === 'pending') {
                        statusColor = 'yellow';
                        statusIcon = 'fas fa-hourglass-half';
                    }
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-xl';
                    div.innerHTML = `
                        <div class="w-14 h-14 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-2xl flex-shrink-0">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-[#045454]">${lesson.pro_name || 'Pro Lesson'}</div>
                            <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                            ${lesson.focus_areas ? `<div class="text-xs text-gray-500">Focus: ${lesson.focus_areas}</div>` : ''}
                        </div>
                        <div class="flex flex-col items-center gap-1">
                            <i class="${statusIcon} text-2xl text-${statusColor}-500"></i>
                            <span class="text-xs font-medium text-${statusColor}-600">${statusText}</span>
                        </div>
                    `;
                    content.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading lessons:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // TOP PLAYERS LOADING - OPTIMIZED
        // ============================================
        async function loadTopPlayers() {
            const loading = document.getElementById('players-loading');
            const carousel = document.getElementById('players-carousel');
            const empty = document.getElementById('players-empty');
            
            try {
                // OPTIMIZED: Use cached fetch for better performance
                const data = await fetchWithCache('/api/club-standings', 'club-standings');
                
                console.log('üîç loadTopPlayers - API response:', data);
                console.log('üîç loadTopPlayers - player_streaks:', data.player_streaks);
                
                loading.classList.add('hidden');
                
                if (!data.success || !data.player_streaks || data.player_streaks.length === 0) {
                    console.log('üîç loadTopPlayers - No player streaks data, showing empty state');
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Filter players with 3+ wins in a row (same logic as my-club page)
                const hotPlayers = data.player_streaks
                    .filter(player => player.current_streak >= 3)
                    .sort((a, b) => b.current_streak - a.current_streak) // Sort by streak length
                    .slice(0, 10); // Show top 10
                
                if (hotPlayers.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                carousel.classList.remove('hidden');
                carousel.innerHTML = '';
                
                // Add table header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between p-3 bg-gray-100 rounded-lg font-semibold text-sm text-gray-700 border-b-2 border-gray-200';
                headerDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-5"></div> <!-- Spacer to align with fire icon -->
                        <div>Player name</div>
                    </div>
                    <div class="text-right">Win Streaks</div>
                `;
                carousel.appendChild(headerDiv);
                
                hotPlayers.forEach(player => {
                    const fullName = player.player_name || 'Unknown Player';
                    const streak = player.current_streak || 0;
                    const seriesName = player.series_name || 'No Series';
                    
                    // Create magnifying glass link to player detail page with correct URL format
                    const playerDetailLink = player.tenniscores_player_id && player.team_id ? 
                        `/mobile/player-detail/${player.tenniscores_player_id}_team_${player.team_id}` :
                        `/mobile/player-detail/${player.player_id}`;
                    const magnifyingGlassIcon = ` <a href="${playerDetailLink}" class="text-blue-600 hover:text-blue-800 ml-1" title="View Player Details"><i class="fas fa-search text-xs"></i></a>`;
                    
                    // Create series chip
                    const seriesChip = seriesName !== 'No Series' ? 
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: #045454; color: #bff863;">${seriesName}</span>` : 
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">No Series</span>`;
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition';
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center mb-1">
                                <div class="font-semibold text-sm text-[#045454]">${fullName}</div>
                                ${magnifyingGlassIcon}
                            </div>
                            <div class="flex items-center">
                                ${seriesChip}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold text-orange-500">${streak}</div>
                            <div class="text-xs text-gray-500">Win Streak</div>
                        </div>
                    `;
                    carousel.appendChild(div);
                });
                
                
                // Load 1st place teams count using same logic as my-club page
                loadFirstPlaceTeams();
                
                // Load rising stars data
                loadRisingStars();
                
            } catch (error) {
                console.error('Error loading top players:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // FIRST PLACE TEAMS LOADING - OPTIMIZED
        // ============================================
        async function loadFirstPlaceTeams() {
            const loading = document.getElementById('first-place-loading');
            const content = document.getElementById('first-place-content');
            const empty = document.getElementById('first-place-empty');
            const tableBody = document.getElementById('first-place-teams-table');
            
            try {
                // OPTIMIZED: Use cached fetch for better performance - force refresh to get latest data
                const data = await fetchWithCache('/api/club-standings', 'club-standings', 0);
                
                console.log('üîç loadFirstPlaceTeams - API response:', data);
                console.log('üîç loadFirstPlaceTeams - tennaqua_standings:', data.tennaqua_standings);
                
                loading.classList.add('hidden');
                
                if (data.success && data.tennaqua_standings && data.tennaqua_standings.length > 0) {
                    // Find all 1st place teams - use same logic as Club Standings section
                    // Teams in 1st place have place = 1 (not tied) or place contains "1/" (tied for first)
                    const firstPlaceTeams = data.tennaqua_standings.filter(team => {
                        const place = String(team.place || '');
                        console.log(`üîç Team ${team.team}: place="${place}", starts with 1/: ${place.startsWith('1/')}`);
                        // Check if place starts with "1/" (first place in series)
                        return place.startsWith('1/');
                    });
                    
                    console.log(`üîç Filtered first place teams: ${firstPlaceTeams.length} teams`);
                    
                    if (firstPlaceTeams.length > 0) {
                        // Sort teams by total points (descending)
                        firstPlaceTeams.sort((a, b) => (b.total_points || 0) - (a.total_points || 0));
                        
                        // Show table with team details
                        content.classList.remove('hidden');
                        tableBody.innerHTML = '';
                        
                        firstPlaceTeams.forEach((team, index) => {
                            const row = document.createElement('tr');
                            row.className = `${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100`;
                            
                            // Create magnifying glass link to teams-players page
                            const teamDetailLink = team.team_id ? 
                                `/mobile/teams-players?team_id=${team.team_id}` :
                                `/mobile/teams-players`;
                            const magnifyingGlassIcon = `<a href="${teamDetailLink}" class="text-blue-600 hover:text-blue-800 ml-1" title="View Team Details"><i class="fas fa-search text-xs"></i></a>`;
                            
                            row.innerHTML = `
                                <td class="py-1 px-2">
                                    <div class="flex items-center">
                                        <div class="font-medium text-xs text-gray-900">${team.team}&nbsp;&nbsp;</div>
                                        ${team.team_id ? magnifyingGlassIcon : ''}
                                    </div>
                                </td>
                                <td class="py-1 px-2 text-center">
                                    <span class="font-medium text-xs text-green-600">${team.place}</span>
                                </td>
                                <td class="py-1 px-2 text-center">
                                    <span class="font-medium text-xs text-gray-900">${team.avg_points}</span>
                                </td>
                                <td class="py-1 px-2 text-center">
                                    <span class="font-medium text-xs text-gray-900">${team.total_points}</span>
                                </td>
                            `;
                            
                            tableBody.appendChild(row);
                        });
                    } else {
                        empty.classList.remove('hidden');
                    }
                } else {
                    empty.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error loading first place teams:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // PTI MOVERS & SHAKERS LOADING - OPTIMIZED
        // ============================================
        async function loadRisingStars() {
            const moversList = document.getElementById('pti-movers-list');
            const ptiMoversCard = document.querySelector('#pti-movers-list').closest('.bg-white.rounded-2xl');
            
            try {
                // OPTIMIZED: Use cached fetch for better performance
                const data = await fetchWithCache('/api/rising-stars', 'rising-stars');
                
                console.log('üîç loadRisingStars - API response:', data);
                console.log('üîç loadRisingStars - rising_stars:', data.rising_stars);
                
                if (data.success && data.rising_stars && data.rising_stars.length > 0) {
                    // Get top 10 movers by absolute PTI change
                    const topMovers = data.rising_stars
                        .sort((a, b) => Math.abs(b.pti_delta) - Math.abs(a.pti_delta)) // Sort by absolute PTI change
                        .slice(0, 10); // Show top 10
                    
                    if (topMovers.length > 0) {
                        // Check if any of the movers have actual PTI data (not all zeros)
                        const hasValidPTIData = topMovers.some(player => 
                            player.pti_delta !== 0 && player.pti_delta !== null && !isNaN(player.pti_delta)
                        );
                        
                        if (!hasValidPTIData) {
                            // Hide PTI Movers card if no valid PTI delta data
                            if (ptiMoversCard) {
                                ptiMoversCard.classList.add('hidden');
                            }
                            return;
                        }
                        
                        moversList.innerHTML = topMovers.map(player => {
                            // Create magnifying glass link to player detail page with correct URL format
                            const playerDetailLink = player.tenniscores_player_id && player.team_id ? 
                                `/mobile/player-detail/${player.tenniscores_player_id}_team_${player.team_id}` :
                                `/mobile/player-detail/${player.player_id}`;
                            const magnifyingGlassIcon = ` <a href="${playerDetailLink}" class="text-blue-600 hover:text-blue-800 ml-1" title="View Player Details"><i class="fas fa-search text-xs"></i></a>`;
                            
                            // Create series chip
                            const seriesChip = player.series_name ? 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: #045454; color: #bff863;">${player.series_name}</span>` : 
                                `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">No Series</span>`;
                            
                            // Determine color and label based on positive or negative change
                            const isPositive = player.pti_delta > 0;
                            const deltaClass = isPositive ? 'text-green-600' : 'text-green-600';  // Both positive and negative changes are green
                            const deltaLabel = isPositive ? 'PTI Gain' : 'PTI Drop';
                            const deltaSign = isPositive ? '+' : '';
                            
                            return `
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex-1">
                                        <div class="flex items-center mb-1">
                                            <div class="font-semibold text-sm text-[#045454]">${player.first_name} ${player.last_name}</div>
                                            ${magnifyingGlassIcon}
                                        </div>
                                        <div class="flex items-center">
                                            ${seriesChip}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-bold ${deltaClass}">${deltaSign}${player.pti_delta.toFixed(1)}</div>
                                        <div class="text-xs text-gray-500">${deltaLabel}</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        moversList.innerHTML = '<div class="text-center text-gray-500 py-4">No PTI movers found</div>';
                    }
                } else {
                    // Hide PTI Movers card if no PTI data available
                    if (ptiMoversCard) {
                        ptiMoversCard.classList.add('hidden');
                    }
                }
                
            } catch (error) {
                console.error('Error loading PTI movers:', error);
                // Hide PTI Movers card if error occurs
                if (ptiMoversCard) {
                    ptiMoversCard.classList.add('hidden');
                }
            }
        }
        
        // ============================================
        // NOTIFICATIONS LOADING
        // ============================================
        async function loadNotifications() {
            try {
                const response = await fetch('/api/home/notifications');
                const data = await response.json();
                
                if (data.error || !data.notifications) {
                    return;
                }
                
                const notifications = data.notifications || [];
                
                // Captain's Message
                const captainMessages = notifications.filter(n => n.type === 'captain');
                if (captainMessages.length > 0) {
                    const section = document.getElementById('captain-message-section');
                    const content = document.getElementById('captain-message-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700">${captainMessages[0].message}</p>`;
                }
                
                // Team Polls
                const polls = notifications.filter(n => n.type === 'poll');
                if (polls.length > 0) {
                    const section = document.getElementById('team-polls-section');
                    const activeContent = document.getElementById('active-polls-content');
                    const pastContent = document.getElementById('past-polls-content');
                    section.classList.remove('hidden');
                    
                    // Separate active and past polls based on date or status
                    const now = new Date();
                    const fiveDaysAgo = new Date(now.getTime() - (5 * 24 * 60 * 60 * 1000)); // 5 days ago
                    
                    console.log('Current time:', now);
                    console.log('Five days ago:', fiveDaysAgo);
                    console.log('All polls:', polls);
                    
                    const activePolls = polls.filter(poll => {
                        console.log('Checking poll for active status:', poll);
                        
                        // Check if poll has an end date and it's in the past
                        if (poll.end_date) {
                            const endDate = new Date(poll.end_date);
                            console.log('Poll has end date:', poll.end_date, 'End date <= now?', endDate <= now);
                            if (endDate <= now) return false;
                        }
                        
                        // Check if poll is older than 5 days based on created_at
                        if (poll.created_at) {
                            const createdDate = new Date(poll.created_at);
                            console.log('Poll created at:', poll.created_at, 'Created at <= fiveDaysAgo?', createdDate <= fiveDaysAgo);
                            if (createdDate <= fiveDaysAgo) return false;
                        } else {
                            console.log('Poll has no created_at, treating as past poll');
                            return false; // Treat polls without created_at as past polls
                        }
                        
                        console.log('Poll is active');
                        // Poll is active if it passes both checks
                        return true;
                    });
                    
                    const pastPolls = polls.filter(poll => {
                        console.log('Checking poll for past status:', poll);
                        
                        // Consider polls past if they have an end date and it's in the past
                        if (poll.end_date) {
                            const endDate = new Date(poll.end_date);
                            console.log('Poll has end date:', poll.end_date, 'End date <= now?', endDate <= now);
                            if (endDate <= now) return true;
                        }
                        
                        // Consider polls past if they're older than 5 days
                        if (poll.created_at) {
                            const createdDate = new Date(poll.created_at);
                            console.log('Poll created at:', poll.created_at, 'Created at <= fiveDaysAgo?', createdDate <= fiveDaysAgo);
                            if (createdDate <= fiveDaysAgo) return true;
                        } else {
                            console.log('Poll has no created_at, treating as past poll');
                            return true; // Treat polls without created_at as past polls
                        }
                        
                        console.log('Poll is not past');
                        return false;
                    });
                    
                    // Display active polls
                    if (activePolls.length > 0) {
                        activeContent.innerHTML = activePolls.map(poll => `
                            <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold text-[#045454]">${poll.title}</div>
                                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">Active</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${poll.message}</p>
                                ${poll.end_date ? `<div class="text-xs text-gray-500">Ends: ${new Date(poll.end_date).toLocaleDateString()}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        activeContent.innerHTML = '<div class="text-center py-4 text-gray-500">No active polls</div>';
                    }
                    
                    // Display past polls
                    if (pastPolls.length > 0) {
                        pastContent.innerHTML = pastPolls.map(poll => `
                            <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-semibold text-gray-700">${poll.title}</div>
                                    <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">Closed</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${poll.message}</p>
                                <div class="text-xs text-gray-500">
                                    ${poll.end_date ? `Ended: ${new Date(poll.end_date).toLocaleDateString()}` : 
                                      poll.created_date ? `Created: ${new Date(poll.created_date).toLocaleDateString()}` : ''}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        pastContent.innerHTML = '<div class="text-center py-4 text-gray-500">No past polls</div>';
                    }
                }
                
                // Food notifications
                const foodNotifs = notifications.filter(n => n.type === 'food');
                if (foodNotifs.length > 0) {
                    const section = document.getElementById('food-section');
                    const content = document.getElementById('food-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700 pl-4">${foodNotifs[0].message}</p>`;
                }
                
                // Beer notifications
                const beerNotifs = notifications.filter(n => n.type === 'beer');
                if (beerNotifs.length > 0) {
                    const section = document.getElementById('beer-section');
                    const content = document.getElementById('beer-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700 pl-4">${beerNotifs[0].message}</p>`;
                }
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        // ============================================
        // TEAM DATA LOADING
        // ============================================
        async function loadTeamData() {
            try {
                // Get team stats from the team stats API (same as my-team page)
                const response = await fetch('/api/team-stats');
                
                if (!response.ok) {
                    console.error('Team stats API error:', response.status, response.statusText);
                    // Show placeholder data
                    document.getElementById('team-points').textContent = '--';
                    document.getElementById('avg-points').textContent = '--';
                    document.getElementById('points-behind').textContent = '--';
                    document.getElementById('team-record').textContent = '-- - --';
                    document.getElementById('team-win-rate').textContent = '--%';
                    return;
                }
                
                const data = await response.json();
                
                if (data.error || !data.success) {
                    console.error('Error loading team stats:', data.error);
                    // Show placeholder data
                    document.getElementById('team-points').textContent = '--';
                    document.getElementById('avg-points').textContent = '--';
                    document.getElementById('points-behind').textContent = '--';
                    document.getElementById('team-record').textContent = '-- - --';
                    document.getElementById('team-win-rate').textContent = '--%';
                    return;
                }
                
                // Use the team stats data (same as my-team page)
                const points = data.points || 0;
                const matchesWon = data.matches_won || 0;
                const matchesLost = data.matches_lost || 0;
                const winRate = data.win_rate || 0;
                
                // Update team points
                document.getElementById('team-points').textContent = points;
                
                // Calculate and update average points per match
                const totalMatches = matchesWon + matchesLost;
                const avgPoints = totalMatches > 0 ? (points / totalMatches).toFixed(1) : '0.0';
                document.getElementById('avg-points').textContent = avgPoints;
                
                // Calculate points behind first place using series standings
                await loadPointsBehindFirst();
                
                // Update team record
                document.getElementById('team-record').textContent = `${matchesWon} - ${matchesLost}`;
                
                // Update win rate
                document.getElementById('team-win-rate').textContent = `${Math.round(winRate)}%`;
                
            } catch (error) {
                console.error('Error loading team data:', error);
                // Show placeholder data on error
                document.getElementById('team-points').textContent = '--';
                document.getElementById('points-behind').textContent = '--';
                document.getElementById('team-record').textContent = '-- - --';
                document.getElementById('team-win-rate').textContent = '--%';
            }
        }
        
        // ============================================
        // POINTS BEHIND FIRST PLACE LOADING
        // ============================================
        async function loadPointsBehindFirst() {
            try {
                // Use the same API as my-series page to get standings data
                const response = await fetch(`/api/series-stats?t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const statsData = await response.json();
                const stats = statsData.teams || statsData;
                
                if (!Array.isArray(stats) || stats.length === 0) {
                    document.getElementById('points-behind').textContent = '--';
                    return;
                }

                // Sort teams by points (highest first) - same logic as my-series page
                stats.sort((a, b) => b.points - a.points);
                
                // Get first place points
                const firstPlacePoints = stats.length > 0 ? stats[0].points : 0;
                
                // Find user's team in the standings
                const user = window.sessionData && window.sessionData.user;
                const userTeam = user ? (user.team || user.club) : null;
                const userTeamId = user ? user.team_id : null;
                
                console.log('Debug - User team info:', { userTeam, userTeamId, teamName: user?.team_name, club: user?.club });
                console.log('Debug - Available teams in stats:', stats.map(t => ({ team: t.team, team_id: t.team_id, points: t.points })));
                
                // Enhanced team matching - try multiple strategies
                let userTeamData = null;
                
                // Strategy 1: Match by team_id if available
                if (userTeamId) {
                    userTeamData = stats.find(team => team.team_id == userTeamId);
                    console.log('Debug - Team ID match result:', userTeamData);
                }
                
                // Strategy 2: Match by team name if team_id didn't work
                if (!userTeamData && userTeam) {
                    userTeamData = stats.find(team => {
                        if (!team.team) return false;
                        const teamName = team.team || '';
                        const clubName = team.club || '';
                        return (
                            teamName.toLowerCase().includes(userTeam.toLowerCase()) ||
                            clubName.toLowerCase().includes(userTeam.toLowerCase()) ||
                            userTeam.toLowerCase().includes(teamName.toLowerCase()) ||
                            userTeam.toLowerCase().includes(clubName.toLowerCase())
                        );
                    });
                    console.log('Debug - Team name match result:', userTeamData);
                }
                
                // Strategy 3: Match by team_name from session if available
                if (!userTeamData && user?.team_name) {
                    userTeamData = stats.find(team => {
                        if (!team.team) return false;
                        const teamName = team.team || '';
                        return teamName.toLowerCase().includes(user.team_name.toLowerCase()) ||
                               user.team_name.toLowerCase().includes(teamName.toLowerCase());
                    });
                    console.log('Debug - Team name from session match result:', userTeamData);
                }
                
                if (userTeamData) {
                    // Calculate points behind first place (same logic as my-series page)
                    const pointsBehind = firstPlacePoints - userTeamData.points;
                    console.log('Debug - Points calculation:', { firstPlacePoints, userPoints: userTeamData.points, pointsBehind });
                    document.getElementById('points-behind').textContent = pointsBehind;
                } else {
                    // If user's team not found in standings, show placeholder
                    console.log('Debug - No team match found, showing --');
                    document.getElementById('points-behind').textContent = '--';
                }
                
            } catch (error) {
                console.error('Error loading points behind first:', error);
                document.getElementById('points-behind').textContent = '--';
            }
        }
        
        // ============================================
        // BEST PARTNER LOADING
        // ============================================
        async function loadBestPartner() {
            try {
                // Use the same API as analyze-me page to get partner analysis
                const response = await fetch('/api/current-season-partner-analysis');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.partner_analysis && data.partner_analysis.length > 0) {
                    // Filter partners with wins > 0 (same logic as analyze-me page)
                    const qualifiedPartners = data.partner_analysis.filter(partner => partner.wins > 0);
                    
                    if (qualifiedPartners.length > 0) {
                        // Get the best partner (highest win rate, then most wins)
                        const bestPartner = qualifiedPartners.sort((a, b) => {
                            if (b.winRate !== a.winRate) {
                                return b.winRate - a.winRate;
                            }
                            return b.wins - a.wins;
                        })[0];
                        
                        // Create detailed partner display
                        const partnerContent = document.getElementById('best-partner-content');
                        partnerContent.innerHTML = `
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center justify-center w-8 h-8 rounded-full font-bold text-white text-sm" 
                                         style="background-color: #045454;">
                                        1
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">${bestPartner.name}</h3>
                                        <p class="text-sm text-gray-600">${bestPartner.record} record</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-bold 
                                        ${bestPartner.winRate >= 60 ? 'text-green-500' : 
                                          bestPartner.winRate >= 45 ? 'text-yellow-500' : 'text-red-500'}">
                                        ${Math.round(bestPartner.winRate)}%
                                    </div>
                                    <p class="text-xs text-gray-500 uppercase">Win Rate</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-gray-900">${bestPartner.matches}</div>
                                        <div class="text-xs text-gray-500">Match${bestPartner.matches !== 1 ? 'es' : ''}</div>
                                    </div>
                                    <div class="w-px h-6 bg-gray-200"></div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-green-600">${bestPartner.wins}</div>
                                        <div class="text-xs text-gray-500">Wins</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-red-600">${bestPartner.losses}</div>
                                        <div class="text-xs text-gray-500">Losses</div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-1">
                                    <span class="text-xs text-gray-600 font-medium">Courts:</span>
                                    ${bestPartner.courts ? bestPartner.courts.map(court => 
                                        `<span class="inline-flex items-center justify-center w-5 h-5 rounded text-xs font-bold text-white" 
                                               style="background-color: #045454;">
                                            ${court}
                                        </span>`
                                    ).join('') : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        document.getElementById('best-partner-content').innerHTML = `
                            <div class="text-center py-4">
                                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                                </div>
                                <p class="text-gray-500 text-sm">No qualifying partnerships yet.<br>Win at least 1 match with a partner to see them here!</p>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('best-partner-content').innerHTML = `
                        <div class="text-center py-4">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                            </div>
                            <p class="text-gray-500 text-sm">No qualifying partnerships yet.<br>Win at least 1 match with a partner to see them here!</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading best partner:', error);
                document.getElementById('best-partner-content').innerHTML = `
                    <div class="text-center py-4">
                        <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-user-friends text-gray-400 text-xl"></i>
                        </div>
                        <p class="text-gray-500 text-sm">No qualifying partnerships yet.<br>Win at least 1 match with a partner to see them here!</p>
                    </div>
                `;
            }
        }
        
        // ============================================
        // SERIES STANDINGS LOADING
        // ============================================
        async function loadSeriesStandings() {
            const loading = document.getElementById('series-loading');
            const content = document.getElementById('series-content');
            const table = document.getElementById('seriesTable');
            
            try {
                // Use the same API as my-series page
                const response = await fetch(`/api/series-stats?t=${Date.now()}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const statsData = await response.json();
                const stats = statsData.teams || statsData;
                
                loading.classList.add('hidden');
                
                if (!Array.isArray(stats) || stats.length === 0) {
                    table.innerHTML = '<div class="text-center text-gray-500 p-8"><div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-chart-bar text-gray-400 text-2xl"></i></div><h3 class="text-lg font-semibold text-[#045454] mb-2">No Series Data</h3><p class="text-gray-500">Series statistics will appear here once matches are played.</p></div>';
                    content.classList.remove('hidden');
                    return;
                }

                // Sort teams by points (same as my-series)
                stats.sort((a, b) => b.points - a.points);

                // Get user's team for highlighting
                const user = window.sessionData && window.sessionData.user;
                const userTeam = user ? (user.team || user.club) : null;
                const playoffCutoff = 8;
                const firstPlacePoints = stats.length > 0 ? stats[0].points : 0;
                
                // Check if any team has PTI data to conditionally show Avg PTI column
                const hasPtiData = stats.some(team => team.avg_pti && team.avg_pti !== 'N/A' && team.avg_pti !== null);
                
                let html = `<thead><tr>
                  <th class="text-left py-3 px-2 font-semibold text-gray-700" style="width: 30%; white-space: nowrap;">Team</th>`;
                if (hasPtiData) {
                  html += `<th class="text-right py-3 px-2 font-semibold text-gray-700" style="width: 14%;">Avg PTI</th>`;
                }
                html += `<th class="text-right py-3 px-2 font-semibold text-gray-700" style="width: 14%;">Record</th>
                  <th class="text-right py-3 px-2 font-semibold text-gray-700" style="width: 14%;">Pts</th>
                  <th class="text-right py-3 px-2 font-semibold text-gray-700" style="width: 14%;">Avg Pts</th>
                  <th class="text-right py-3 px-2 font-semibold text-gray-700" style="width: 14%;">Pts Back</th>
                </tr></thead><tbody>`;
                
                stats.forEach((team, idx) => {
                    // More robust team matching - check both team name and club name
                    const teamName = team.team || '';
                    const clubName = team.club || '';
                    const isUserTeam = userTeam && (
                        teamName.toLowerCase().includes(userTeam.toLowerCase()) ||
                        clubName.toLowerCase().includes(userTeam.toLowerCase()) ||
                        userTeam.toLowerCase().includes(teamName.toLowerCase()) ||
                        userTeam.toLowerCase().includes(clubName.toLowerCase())
                    );
                    let playoffIcon = '';
                    const isPlayoffTeam = idx < playoffCutoff;
                    let rowClass = 'border-b border-gray-50';
                    
                    if (isUserTeam) {
                        rowClass += ' bg-green-50 border-l-4 border-green-400 font-semibold';
                    } else if (isPlayoffTeam) {
                        rowClass += ' bg-white border-l-4 border-green-500';
                        playoffIcon = '<span title="Playoff Contender" class="mr-1 text-green-600"><i class="fas fa-trophy"></i></span>';
                    } else if (idx % 2 === 0) {
                        rowClass += ' bg-white';
                    } else {
                        rowClass += ' bg-gray-50';
                    }
                    
                    const totalMatches = team.matches.won + team.matches.lost + (team.matches.tied || 0);
                    const avgPoints = totalMatches > 0 ? (team.points / totalMatches).toFixed(1) : '0.0';
                    
                    // Create team link
                    const teamId = team.team_id || team.id || '';
                    const teamDisplayName = team.team;
                    
                    // Always show magnifying glass for all teams
                    let teamNameHtml;
                    let magnifyingGlassHtml;
                    if (teamId) {
                        // If we have a team_id, make both team name and magnifying glass clickable
                        teamNameHtml = `<a href="/mobile/teams-players?team_id=${teamId}" class="hover:text-blue-600 hover:underline">${teamDisplayName}</a>`;
                        magnifyingGlassHtml = `<a href="/mobile/teams-players?team_id=${teamId}" class="text-blue-600 hover:text-blue-800 ml-1" title="View Team Details"><i class="fas fa-search"></i></a>`;
                    } else {
                        // If no team_id, show team name as text but still show magnifying glass (could link to search or club page)
                        teamNameHtml = `${teamDisplayName}`;
                        magnifyingGlassHtml = `<a href="/mobile/teams-players" class="text-blue-600 hover:text-blue-800 ml-1" title="View Teams"><i class="fas fa-search"></i></a>`;
                    }
                    
                    html += `<tr class="${rowClass}">
                      <td class="py-3 px-2 font-medium ${isUserTeam ? 'text-green-800' : 'text-[#045454]'}" style="width: 25%;">
                        <div class="flex items-center">
                          <div class="flex-1 truncate">${playoffIcon}${teamNameHtml}</div>
                          <div class="flex-shrink-0 ml-2">${magnifyingGlassHtml}</div>
                        </div>
                      </td>`;
                    
                    // Add Avg PTI column (if PTI data exists)
                    if (hasPtiData) {
                        const avgPti = team.avg_pti && team.avg_pti !== 'N/A' ? team.avg_pti : 'N/A';
                        html += `<td class="py-3 px-2 text-right font-semibold ${isUserTeam ? 'text-green-800' : 'text-[#045454]'}" style="width: 14%;">${avgPti}</td>`;
                    }
                    
                    html += `
                        <td class="py-3 px-2 text-right ${isUserTeam ? 'text-green-700' : 'text-gray-700'}" style="width: 14%;">${team.matches.won}-${team.matches.lost}</td>
                        <td class="py-3 px-2 text-right font-semibold ${isUserTeam ? 'text-green-800' : 'text-[#045454]'}" style="width: 14%;">${team.points}</td>
                        <td class="py-3 px-2 text-right ${isUserTeam ? 'text-green-700' : 'text-gray-700'}" style="width: 14%;">${avgPoints}</td>
                        <td class="py-3 px-2 text-right ${isUserTeam ? 'text-green-600' : 'text-gray-600'}" style="width: 14%;">${firstPlacePoints - team.points}</td>
                      </tr>`;
                });
                html += '</tbody>';
                table.innerHTML = html;
                content.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading series standings:', error);
                loading.classList.add('hidden');
                table.innerHTML = '<div class="text-center text-gray-500 p-8"><div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i></div><h3 class="text-lg font-semibold text-[#045454] mb-2">Error Loading Standings</h3><p class="text-gray-500">Unable to load series standings data.</p></div>';
                content.classList.remove('hidden');
            }
        }
        
        
        // ============================================
        // CLUB STANDINGS LOADING
        // ============================================
        async function loadClubStandings() {
            try {
                const response = await fetch('/api/club-standings');
                const data = await response.json();
                
                if (data.success && data.tennaqua_standings) {
                    const standings = data.tennaqua_standings;
                    
                    // Find teams in 1st place
                    const firstPlaceTeams = standings.filter(team => {
                        const place = String(team.place || '');
                        return place.includes('1/') || place.startsWith('1/');
                    });
                    
                    // Update the 1st place teams display
                    const firstPlaceElement = document.getElementById('first-place-teams');
                    if (firstPlaceTeams.length > 0) {
                        firstPlaceElement.innerHTML = firstPlaceTeams.map(team => `
                            <div class="text-sm font-semibold text-[#045454] mb-1">
                                ${team.team} - ${team.place}
                            </div>
                        `).join('');
                    } else {
                        firstPlaceElement.textContent = '0';
                    }
                }
                
            } catch (error) {
                console.error('Error loading club standings:', error);
                // Keep the default "--" display on error
            }
        }

        // ============================================
        // LAST MATCH LOADING
        // ============================================
        async function loadLastMatchData() {
            const loading = document.getElementById('last-match-loading');
            const content = document.getElementById('last-match-content');
            const empty = document.getElementById('last-match-empty');
            
            // Check if elements exist
            if (!loading || !content || !empty) {
                console.error('Last match HTML elements not found');
                return;
            }
            
            try {
                // Use the same API as analyze-me page
                const response = await fetch('/api/last-3-matches');
                
                if (response.status === 404) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                const data = await response.json();
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Get the most recent match (first in the array)
                const lastMatch = data.matches[0];
                
                // Parse match data using same field names as analyze-me page
                const matchDate = new Date(lastMatch.date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const timeStr = 'TBD'; // Time not available in this API
                
                // Parse scores to determine winner (same logic as analyze-me page)
                const scores = lastMatch.scores ? lastMatch.scores.split(", ") : [];
                const team1_sets = [];  // First team in database (away team)
                const team2_sets = [];  // Second team in database (home team)
                let team1_sets_won = 0;
                let team2_sets_won = 0;
                
                scores.forEach(set_score => {
                    if (set_score && set_score.includes("-")) {
                        const [score1, score2] = set_score.split("-");
                        team1_sets.push(score1);
                        team2_sets.push(score2);
                        
                        if (parseInt(score2) > parseInt(score1)) {
                            team2_sets_won++;
                        } else {
                            team1_sets_won++;
                        }
                    }
                });
                
                // Determine which team won based on sets won
                const team1_won = team1_sets_won > team2_sets_won;
                
                // Determine which team the current player is on
                const current_player_on_team1 = lastMatch.player_was_home === false; // If player was away, they're on team1
                
                // Determine if current player won
                const won = current_player_on_team1 ? team1_won : !team1_won;
                
                // Get opponent team name
                const opponentTeam = current_player_on_team1 ? lastMatch.home_team : lastMatch.away_team;
                
                // Format score
                const scoreStr = scores.length > 0 ? scores.join(', ') : '--';
                
                // Update the last match display
                content.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full ${won ? 'bg-green-100' : 'bg-red-100'} flex items-center justify-center">
                            <i class="fas fa-${won ? 'trophy' : 'times'} text-2xl ${won ? 'text-green-600' : 'text-red-600'}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-lg ${won ? 'text-green-600' : 'text-red-600'}">${won ? 'Won' : 'Lost'}</div>
                            <div class="text-gray-600">vs ${opponentTeam || 'Unknown'}</div>
                            <div class="text-sm text-gray-500">${dateStr}</div>
                            <div class="text-xs text-gray-400">${scoreStr}</div>
                        </div>
                    </div>
                `;
                
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                empty.classList.add('hidden');
                
            } catch (error) {
                console.error('Error loading last match data:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        // ============================================
        // PICKUP GAMES LOADING
        // ============================================
        async function loadPickupGames() {
            const loading = document.getElementById('pickup-loading');
            const content = document.getElementById('pickup-content');
            const empty = document.getElementById('pickup-empty');
            
            try {
                const response = await fetch('/api/pickup-games?type=public');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                loading.classList.add('hidden');
                
                if (data.error || !data.upcoming_games || data.upcoming_games.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Show only the next 3 upcoming games
                const upcomingGames = data.upcoming_games.slice(0, 3);
                
                if (upcomingGames.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                upcomingGames.forEach(game => {
                    const gameDiv = createPickupGameElement(game);
                    content.appendChild(gameDiv);
                });
                
            } catch (error) {
                console.error('Error loading pickup games:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function createPickupGameElement(game) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition';
            
            const gameDate = new Date(game.game_date);
            const dateStr = gameDate.toLocaleDateString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = game.game_time || 'TBD';
            const description = game.description || 'Pickup Game';
            const participants = game.actual_participants || 0;
            const requested = game.players_requested || 4;
            
            div.innerHTML = `
                <div class="w-14 h-14 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-2xl flex-shrink-0">
                    <i class="fas fa-users"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-[#045454]">${description}</div>
                    <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                    <div class="text-xs text-gray-500">${participants}/${requested} players</div>
                </div>
                <div class="flex flex-col items-center gap-1">
                    <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-bold">
                        ${participants}
                    </div>
                    <span class="text-xs text-gray-500">joined</span>
                </div>
            `;
            
            return div;
        }

        // ============================================
        // PADDLE TIP LOADING
        // ============================================
        async function loadPaddleTip() {
            const loading = document.getElementById('paddle-tip-loading');
            const content = document.getElementById('paddle-tip-content');
            const empty = document.getElementById('paddle-tip-empty');
            
            try {
                const response = await fetch('/api/paddle-tips');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                loading.classList.add('hidden');
                
                if (data.error || !data.paddle_tips || data.paddle_tips.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Get a random paddle tip
                const paddleTips = data.paddle_tips;
                const randomIndex = Math.floor(Math.random() * paddleTips.length);
                const tip = paddleTips[randomIndex];
                
                // Display the tip
                content.classList.remove('hidden');
                
                // Format the description (truncate if too long for mobile)
                let description = tip.description || '';
                if (description.length > 200) {
                    description = description.substring(0, 200) + '...';
                }
                
                // Format description with basic HTML support
                const formattedDescription = formatTipDescription(description);
                
                content.innerHTML = `
                    <div class="mb-2">
                        <span class="text-sm text-white/70">Tip #${tip.number || '?'}</span>
                        <span class="text-sm text-white/70 ml-2">‚Ä¢</span>
                        <span class="text-sm text-white/70 ml-2">${tip.date || ''}</span>
                    </div>
                    <h4 class="text-xl font-semibold mb-3">${tip.name || 'Paddle Tip'}</h4>
                    <div class="text-white/90 leading-relaxed">${formattedDescription}</div>
                `;
                
            } catch (error) {
                console.error('Error loading paddle tip:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function formatTipDescription(description) {
            // Basic HTML formatting for paddle tips
            return description
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic text
                .replace(/\n\n/g, '</p><p>') // Paragraph breaks
                .replace(/\n/g, '<br>') // Line breaks
                .replace(/^(.*)$/, '<p>$1</p>'); // Wrap in paragraph
        }

        // ============================================
        // STICKY NAVIGATION
        // ============================================
        function initStickyNavigation() {
            console.log('initStickyNavigation function called');
            const nav = document.getElementById('main-nav');
            console.log('Navigation element:', nav);
            
            if (!nav) {
                console.error('Navigation element not found');
                return;
            }
            
            const navButtons = nav.querySelectorAll('.nav-button');
            console.log('Found nav buttons:', navButtons.length);
            console.log('Sticky navigation initialized');
            
            // Get the initial position of the navigation
            const navOffsetTop = nav.offsetTop;
            console.log('Navigation offset top:', navOffsetTop);
            
            function handleScroll() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                console.log('Scroll position:', scrollTop, 'Nav offset:', navOffsetTop);
                
                // Check if we've scrolled past the navigation's initial position
                if (scrollTop > navOffsetTop - 0) { // Add some threshold for better UX
                    if (!nav.classList.contains('scrolled')) {
                        console.log('Adding scrolled class');
                        nav.classList.add('scrolled');
                        navButtons.forEach(button => {
                            button.classList.add('scrolled');
                        });
                    }
                } else {
                    if (nav.classList.contains('scrolled')) {
                        console.log('Removing scrolled class');
                        nav.classList.remove('scrolled');
                        navButtons.forEach(button => {
                            button.classList.remove('scrolled');
                        });
                    }
                }
                
                // Determine which section is currently in view and set active state
                updateActiveNavigation(scrollTop);
            }
            
            function updateActiveNavigation(scrollTop) {
                // Define sections and their scroll positions
                const sections = [
                    { id: 'schedule', element: document.querySelector('#schedule') },
                    { id: 'team', element: document.querySelector('#team') },
                    { id: 'club', element: document.querySelector('#club') },
                    { id: 'play', element: document.querySelector('#play') },
                    { id: 'improve', element: document.querySelector('#improve') }
                ];
                
                // Remove active class from all buttons
                navButtons.forEach(button => button.classList.remove('active'));
                
                // Find the section that's currently in view
                let activeSection = null;
                const offset = 165; // Same offset as autoscroll + 10px higher
                
                for (let i = sections.length - 1; i >= 0; i--) {
                    const section = sections[i];
                    if (section.element) {
                        const sectionTop = section.element.offsetTop - offset;
                        if (scrollTop >= sectionTop) {
                            activeSection = section.id;
                            break;
                        }
                    }
                }
                
                // Set active state for the current section
                if (activeSection) {
                    const activeButton = document.querySelector(`a[href="#${activeSection}"]`);
                    if (activeButton) {
                        activeButton.classList.add('active');
                        console.log(`Setting active state for: ${activeSection}`);
                    }
                }
            }
            
            // Throttle scroll events for better performance
            let ticking = false;
            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(handleScroll);
                    ticking = true;
                    setTimeout(() => { ticking = false; }, 16); // ~60fps
                }
            }
            
            // Add scroll event listener
            console.log('Adding scroll event listener');
            window.addEventListener('scroll', requestTick, { passive: true });
            console.log('Scroll event listener added');
            
            // Handle smooth scrolling for anchor links
            navButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    if (href.startsWith('#')) {
                        e.preventDefault();
                        
                        // Remove active class from all buttons
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        const target = document.querySelector(href);
                        if (target) {
                            // Consistent offset for all navigation sections
                            let offset = 155; // Standard offset for all sections
                            const targetOffsetTop = target.offsetTop - offset;
                            window.scrollTo({
                                top: targetOffsetTop,
                                behavior: 'smooth'
                            });
                        }
                    }
                });
            });
            
            // Initial call to set correct state
            console.log('Setting initial scroll state');
            handleScroll();
            console.log('Initial scroll state set');
            
            // Load featured training video
            loadFeaturedTrainingVideo();
            
            // Initialize quick search functionality
            initializeQuickSearch();
        }
        
        // Function to initialize quick search functionality
        function initializeQuickSearch() {
            const quickSearchBtn = document.getElementById('quickSearchBtn');
            const quickFirstName = document.getElementById('quickFirstName');
            const quickLastName = document.getElementById('quickLastName');
            
            // Search button functionality
            if (quickSearchBtn) {
                quickSearchBtn.addEventListener('click', function() {
                    performQuickSearch();
                });
            }
            
            // Enter key functionality
            [quickFirstName, quickLastName].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            performQuickSearch();
                        }
                    });
                }
            });
        }
        
        // Function to perform quick search
        function performQuickSearch() {
            const firstName = document.getElementById('quickFirstName')?.value.trim();
            const lastName = document.getElementById('quickLastName')?.value.trim();
            
            // Build search parameters
            const params = new URLSearchParams();
            if (firstName) params.append('first_name', firstName);
            if (lastName) params.append('last_name', lastName);
            
            // Redirect to find-people-to-play page with parameters
            const searchUrl = `/mobile/find-people-to-play?${params.toString()}`;
            window.location.href = searchUrl;
        }
        
        // Function to reset quick search form
        function resetQuickSearch() {
            const firstName = document.getElementById('quickFirstName');
            const lastName = document.getElementById('quickLastName');
            
            if (firstName) firstName.value = '';
            if (lastName) lastName.value = '';
        }
        
        // Function to load a random training video
        async function loadFeaturedTrainingVideo() {
            try {
                console.log('Loading featured training video...');
                const response = await fetch('/api/training-videos');
                if (!response.ok) {
                    throw new Error('Failed to fetch training videos');
                }
                
                const videos = await response.json();
                if (videos && videos.length > 0) {
                    // Get a random video
                    const randomIndex = Math.floor(Math.random() * videos.length);
                    const featuredVideo = videos[randomIndex];
                    
                    // Update the training video content
                    const videoContent = document.getElementById('training-video-content');
                    if (videoContent) {
                        // Extract YouTube video ID
                        const videoId = extractYouTubeVideoId(featuredVideo.url);
                        
                        videoContent.innerHTML = `
                            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                                <div class="relative aspect-video bg-gray-200 video-container" 
                                     data-video-url="${featuredVideo.url}"
                                     data-video-id="${videoId}">
                                    
                                    <!-- Thumbnail View -->
                                    <div class="thumbnail-view" style="position: absolute; inset: 0; background: #1a1a1a;">
                                        ${videoId ? `
                                        <img src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" 
                                             alt="${featuredVideo.title}" 
                                             loading="eager"
                                             style="position: absolute !important; 
                                                    top: 0 !important; 
                                                    left: 0 !important; 
                                                    width: 100% !important; 
                                                    height: 100% !important; 
                                                    object-fit: cover !important; 
                                                    display: block !important;
                                                    z-index: 1 !important;
                                                    opacity: 1 !important;
                                                    visibility: visible !important;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        ` : ''}
                                        
                                        <!-- Fallback if no thumbnail -->
                                        <div class="flex items-center justify-center text-center" style="position: absolute; inset: 0; z-index: 1; display: none;">
                                            <div>
                                                <i class="fas fa-play-circle text-4xl text-rally-green mb-2"></i>
                                                <p class="text-gray-600 font-medium">${featuredVideo.title}</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Slight overlay for better play button visibility -->
                                        <div style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.15); pointer-events: none; z-index: 2;"></div>
                                        
                                        <!-- Duration Badge (simulated) -->
                                        <div class="absolute bottom-4 right-4 bg-black bg-opacity-80 text-white text-xs px-2 py-1 rounded-md backdrop-blur-sm font-medium" style="z-index: 3;">
                                            ${Math.floor(Math.random() * 13) + 3}:${String(Math.floor(Math.random() * 60)).padStart(2, '0')}
                                        </div>
                                        
                                        <!-- Modern Play Button Overlay -->
                                        <button class="play-btn" style="position: absolute; 
                                                                         inset: 0; 
                                                                         z-index: 10;
                                                                         display: flex;
                                                                         align-items: center;
                                                                         justify-content: center;
                                                                         background: transparent;
                                                                         border: none;
                                                                         cursor: pointer;
                                                                         transition: all 0.3s ease;">
                                            <!-- Outer glow ring -->
                                            <div style="position: absolute;
                                                        width: 5rem;
                                                        height: 5rem;
                                                        border-radius: 50%;
                                                        background: rgba(255, 255, 255, 0.2);
                                                        transition: all 0.3s ease;"></div>
                                            
                                            <!-- Main button -->
                                            <div style="position: relative;
                                                        width: 3.5rem;
                                                        height: 3.5rem;
                                                        border-radius: 50%;
                                                        display: flex;
                                                        align-items: center;
                                                        justify-content: center;
                                                        background: #bff863;
                                                        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                                                        border: 2px solid rgba(255, 255, 255, 0.6);
                                                        transition: all 0.3s ease;">
                                                <!-- Play triangle -->
                                                <div style="position: relative;
                                                            display: flex;
                                                            align-items: center;
                                                            justify-content: center;
                                                            margin-left: 0.25rem;">
                                                    <svg style="width: 1.5rem; height: 1.5rem; color: white; filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M8 5v14l11-7z"/>
                                                    </svg>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                    
                                    <!-- Video Player (hidden initially) -->
                                    <div class="video-player hidden absolute inset-0">
                                        <iframe class="w-full h-full" 
                                                src="" 
                                                title="${featuredVideo.title}"
                                                frameborder="0" 
                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                allowfullscreen>
                                        </iframe>
                                        <!-- Close Button -->
                                        <button class="close-video absolute top-2 right-2 w-8 h-8 bg-black bg-opacity-70 hover:bg-opacity-90 rounded-full flex items-center justify-center text-white transition-all duration-200 z-10">
                                            <i class="fas fa-times text-sm"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-4">
                                    <h4 class="font-semibold text-[#045454] mb-2">${featuredVideo.title}</h4>
                                    <p class="text-sm text-gray-600 mb-3">${featuredVideo.summary}</p>
                                    <div class="flex flex-wrap gap-2">
                                        ${featuredVideo.keywords.slice(0, 3).map(keyword => 
                                            `<span class="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full">${keyword}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Initialize video player for the featured video
                        initializeFeaturedVideoPlayer();
                    }
                } else {
                    // Show fallback if no videos available
                    const videoContent = document.getElementById('training-video-content');
                    if (videoContent) {
                        videoContent.innerHTML = `
                            <div class="bg-gray-100 rounded-xl p-6 text-center">
                                <i class="fas fa-video text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-600">Training videos coming soon!</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading featured training video:', error);
                // Show error fallback
                const videoContent = document.getElementById('training-video-content');
                if (videoContent) {
                    videoContent.innerHTML = `
                        <div class="bg-gray-100 rounded-xl p-6 text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600">Unable to load video</p>
                        </div>
                    `;
                }
            }
        }
        
        // Function to initialize video player for featured video
        function initializeFeaturedVideoPlayer() {
            const playBtn = document.querySelector('#training-video-content .play-btn');
            const closeBtn = document.querySelector('#training-video-content .close-video');
            
            if (playBtn) {
                playBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const videoContainer = this.closest('.video-container');
                    const thumbnailView = videoContainer.querySelector('.thumbnail-view');
                    const videoPlayer = videoContainer.querySelector('.video-player');
                    const iframe = videoPlayer.querySelector('iframe');
                    
                    // Get video URL and extract video ID
                    const videoUrl = videoContainer.dataset.videoUrl;
                    const videoId = extractYouTubeVideoId(videoUrl);
                    
                    if (videoId) {
                        // Set iframe source to YouTube embed URL with autoplay
                        iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
                        
                        // Hide thumbnail and show player
                        thumbnailView.classList.add('hidden');
                        videoPlayer.classList.remove('hidden');
                        
                        // Scroll video into view
                        videoContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const videoContainer = this.closest('.video-container');
                    const thumbnailView = videoContainer.querySelector('.thumbnail-view');
                    const videoPlayer = videoContainer.querySelector('.video-player');
                    const iframe = videoPlayer.querySelector('iframe');
                    
                    // Stop video by clearing iframe source
                    iframe.src = '';
                    
                    // Show thumbnail and hide player
                    videoPlayer.classList.add('hidden');
                    thumbnailView.classList.remove('hidden');
                });
            }
        }
        
        // Function to extract YouTube video ID from URL
        function extractYouTubeVideoId(url) {
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        // ============================================
        // LEAGUE SWITCHER FUNCTIONALITY
        // ============================================
        
        async function checkMultipleLeagues() {
            try {
                console.log('üîç Checking for multiple leagues...');
                // Check if this specific user has multiple leagues (including all associations)
                const response = await fetch('/api/get-user-leagues');
                const data = await response.json();
                
                console.log('üìä League check response:', data);
                
                if (data.success && data.has_multiple_leagues) {
                    const leagueButton = document.getElementById('leagueSwitcherTrigger');
                    if (leagueButton) {
                        leagueButton.classList.remove('hidden');
                        console.log(`‚úÖ League selector shown - user has ${data.league_count} leagues`);
                    } else {
                        console.log('‚ùå League button element not found');
                    }
                } else {
                    console.log(`‚ùå League selector hidden - user has ${data.league_count || 0} leagues`);
                }
            } catch (error) {
                console.error('‚ùå Error checking multiple leagues:', error);
            }
        }

        function showLeagueSwitcher() {
            const modal = document.getElementById('leagueSwitcherModal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                loadLeagueSwitcherOptions();
            }
        }

        function closeLeagueSwitcher() {
            const modal = document.getElementById('leagueSwitcherModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        async function loadLeagueSwitcherOptions() {
            try {
                const response = await fetch('/api/get-user-leagues');
                const data = await response.json();
                
                if (data.success && data.leagues) {
                    const optionsContainer = document.querySelector('#leagueSwitcherModal .league-options');
                    if (optionsContainer) {
                        console.log('League data received:', data.leagues);
                        optionsContainer.innerHTML = data.leagues.map(league => {
                            console.log('Processing league:', league);
                            console.log('league.league_string_id:', league.league_string_id);
                            console.log('league.league_name:', league.league_name);
                            return `
                            <button onclick="switchLeague('${league.league_string_id}', '${league.league_name}')" 
                                    class="league-switch-btn w-full flex items-center justify-between p-4 rounded-lg bg-gray-800 hover:bg-gray-700 transition-all duration-200 border-2 border-gray-600 hover:border-blue-400 hover:shadow-md group
                                           ${league.is_current ? 'bg-blue-900 border-blue-400' : ''}">
                                <div class="text-left">
                                    <div class="font-bold text-white group-hover:text-blue-200">${league.league_name}</div>
                                    <div class="text-sm text-gray-300 group-hover:text-blue-300">${league.player_count} players</div>
                                </div>
                                <div class="text-sm ${league.is_current ? 'bg-gray-500 text-white px-3 py-1 rounded' : 'bg-green-700 group-hover:bg-green-800 text-white px-3 py-1 rounded'}" style="${league.is_current ? 'background-color: #797979 !important;' : 'background-color: #045454 !important;'}">
                                    ${league.is_current ? 'Current' : 'Switch'}
                                </div>
                            </button>
                        `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading league switcher options:', error);
            }
        }

        async function switchLeague(leagueId, leagueName) {
            console.log('switchLeague called with:', { leagueId, leagueName });
            try {
                // Close modal first
                const modal = document.getElementById('leagueSwitcherModal');
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                }
                
                // Show loading
                const leagueButton = document.getElementById('leagueSwitcherTrigger');
                if (leagueButton) {
                    leagueButton.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
                    leagueButton.disabled = true;
                }
                
                const response = await fetch('/api/switch-league', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        league_id: leagueId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success briefly then reload
                    if (leagueButton) {
                        leagueButton.innerHTML = '<i class="fas fa-check text-xs"></i>';
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'League switch failed');
                }
            } catch (error) {
                console.error('League switch error:', error);
                alert(`Failed to switch leagues: ${error.message}`);
                
                // Reset button
                const leagueButton = document.getElementById('leagueSwitcherTrigger');
                if (leagueButton) {
                    leagueButton.innerHTML = '(change)';
                    leagueButton.disabled = false;
                }
            }
        }

    </script>

<!-- League Switching Modal -->
<div id="leagueSwitcherModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-sm w-full max-h-[40rem] overflow-hidden flex flex-col" style="max-height: 40rem !important; height: auto !important;">
        <!-- Modal Header -->
        <div class="px-6 py-4 bg-black border-b border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white" style="color: white !important;">
                Switch League or Team
            </h3>
            <button id="closeLeagueModal" class="text-gray-300 hover:text-white transition-colors text-xl font-bold" onclick="closeLeagueSwitcher()">
                √ó
            </button>
        </div>
        
        <!-- Current League Display -->
        <div class="px-6 py-4" style="background: #045454; border-bottom: 2px solid #045454;">
            <div class="flex items-center gap-3 mb-3">
                <span class="bg-white text-rally-dark-green px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                    CURRENT
                </span>
                <span class="text-white font-bold text-sm uppercase tracking-wide">ACTIVE LEAGUE</span>
            </div>
            <div class="font-bold text-white text-lg mb-1" style="color: white !important;">{{ session_data.user.league_name }}</div>
            <div class="text-white text-sm">{{ session_data.user.club }} ‚Ä¢ {{ session_data.user.series }}</div>
        </div>
        
        <!-- Available League Options -->
        <div class="p-4 bg-gray-50 flex-1 overflow-y-auto">
            <div class="text-sm font-bold text-gray-800 mb-3 uppercase tracking-wide">
                Switch to Different League
            </div>
            <div class="space-y-2 league-options min-h-[300px]" style="min-height: 300px !important;">
                <!-- Options will be loaded dynamically -->
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-spinner fa-spin"></i> Loading leagues...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// League Switcher Modal Event Handlers
function closeLeagueSwitcher() {
    const modal = document.getElementById('leagueSwitcherModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

// Initialize modal functionality
document.addEventListener('DOMContentLoaded', function() {
    const leagueSwitcherModal = document.getElementById('leagueSwitcherModal');
    
    if (leagueSwitcherModal) {
        // Close modal when clicking outside
        leagueSwitcherModal.addEventListener('click', function(e) {
            if (e.target === leagueSwitcherModal) {
                closeLeagueSwitcher();
            }
        });
    }
    
    // Close on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (leagueSwitcherModal && !leagueSwitcherModal.classList.contains('hidden')) {
                closeLeagueSwitcher();
            }
        }
    });
});
</script>

{% endblock %}

