{% extends "mobile/layout.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rally-green': '#045454',
                        'rally-green-light': '#056565',
                        'rally-green-dark': '#033333',
                    }
                }
            }
        }
    </script>
    
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
        }
        
        .section-hero {
            background: linear-gradient(135deg, #045454 0%, #067676 100%);
        }
        
        .pti-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 100%);
            border: 8px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .hover-lift {
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.12);
        }
        
        .carousel {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        
        .carousel::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen">

    <!-- ============================================
         HEADER
         ============================================ -->
    <header class="section-hero text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                {% if session_data and session_data.user and session_data.user.club_logo %}
                <img src="/{{ session_data.user.club_logo }}" 
                     alt="{{ session_data.user.club }} Logo" 
                     class="w-20 h-20 object-contain rounded-xl"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                {% endif %}
                <div class="w-20 h-20 bg-gradient-to-br from-rally-green to-rally-green-light text-white flex items-center justify-center font-bold text-lg rounded-xl" 
                     style="{% if session_data and session_data.user and session_data.user.club_logo %}display: none;{% endif %}">
                    {{ session_data.user.club[0:2] if session_data and session_data.user and session_data.user.club else 'CL' }}
                </div>
                </div>
            </div>
            
            <div class="mb-6">
                <h1 class="text-3xl font-bold tracking-tight">Welcome back, {{ session_data.user.first_name }}</h1>
                {% if session_data and session_data.user and session_data.user.team_name %}
                <p class="text-white/80 text-sm mt-1">{{ session_data.user.team_name }}</p>
                {% endif %}
            </div>
            
            <!-- Navigation Tabs -->
            <nav class="flex gap-2 overflow-x-auto pb-2 scrollbar-none">
                <a href="#schedule" class="px-5 py-2.5 bg-white/20 backdrop-blur-sm rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/30 transition">Schedule</a>
                <a href="#team" class="px-5 py-2.5 bg-white/10 backdrop-blur-sm rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition">Team</a>
                <a href="#club" class="px-5 py-2.5 bg-white/10 backdrop-blur-sm rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition">Club</a>
                <a href="#play" class="px-5 py-2.5 bg-white/10 backdrop-blur-sm rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition">Play</a>
                <a href="#improve" class="px-5 py-2.5 bg-white/10 backdrop-blur-sm rounded-full text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition">Improve</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">

        <!-- ============================================
             1. DASHBOARD SECTION
             ============================================ -->
        <section id="dashboard" class="space-y-6">
            <h2 class="text-4xl font-bold text-gray-900 tracking-tight">Dashboard</h2>
            
            <!-- PTI Hero Card -->
            <div class="section-hero rounded-3xl p-8 sm:p-12 text-center text-white shadow-xl hover-lift">
                <div id="pti-loading" class="py-8">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="pti-content" class="hidden">
                    <h3 class="text-xl font-semibold mb-6 text-white/90">My PTI</h3>
                    <div class="pti-circle mx-auto mb-6">
                        <div id="pti-value" class="text-6xl font-bold">--</div>
                    </div>
                    <p id="pti-message" class="text-lg text-white/90 max-w-2xl mx-auto"></p>
                <a href="/mobile/analyze-me" class="inline-block mt-6 px-8 py-3 bg-white text-rally-green rounded-full font-semibold hover:bg-gray-100 transition shadow-lg">
                    Tell me more
                </a>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="text-sm text-gray-500 mb-2">My Record</div>
                    <div id="my-record" class="text-3xl font-bold text-gray-900">-- - --</div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="text-sm text-gray-500 mb-2">Win Rate</div>
                    <div id="win-rate" class="text-3xl font-bold text-gray-900">--%</div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="text-sm text-gray-500 mb-2">Best Partner</div>
                    <div id="best-partner" class="text-xl font-semibold text-gray-900">Loading...</div>
                </div>
                
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="text-sm text-gray-500 mb-2">Win Streak</div>
                    <div id="win-streak" class="text-3xl font-bold text-rally-green">🔥 --</div>
                </div>
            </div>
            
            <!-- Last Match Results -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">My Last Match</h3>
                <div id="last-match-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                <div id="last-match-content" class="hidden"></div>
                <div id="last-match-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-times text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No recent matches found</p>
                </div>
            </div>
        </section>

        <!-- ============================================
             2. SCHEDULE SECTION
             ============================================ -->
        <section id="schedule" class="space-y-6">
            <h2 class="text-4xl font-bold text-gray-900 tracking-tight">Schedule</h2>
            
            <!-- Next Match Hero -->
            <div class="bg-gradient-to-br from-rally-green to-rally-green-light rounded-3xl p-8 text-white shadow-xl hover-lift">
                <div id="next-match-loading" class="text-center py-8">
                    <div class="w-12 h-12 border-4 border-white/20 border-t-white rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="next-match-content" class="hidden">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-calendar-star text-2xl"></i>
                        <h3 class="text-2xl font-bold">Next Match</h3>
                    </div>
                    <div id="next-match-details"></div>
                </div>
                
                <div id="next-match-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-alt text-4xl mb-4 opacity-50"></i>
                    <p class="text-white/80">No upcoming matches scheduled</p>
                </div>
            </div>
            
            <!-- Club Overview -->
            <div class="bg-white rounded-2xl p-6 shadow-md mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-rally-green"></i>
                    {{ session_data.user.club }} Overview
                </h3>
                
                <div id="club-overview-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="club-overview-content" class="hidden">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div id="club-record" class="text-2xl font-bold text-gray-900">-- - --</div>
                            <div class="text-sm text-gray-600">Record</div>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-xl">
                            <div id="club-win-rate" class="text-2xl font-bold text-gray-900">--%</div>
                            <div class="text-sm text-gray-600">Win Rate</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Top Players</h4>
                            <div id="club-top-players" class="space-y-2">
                                <div class="text-center py-4 text-gray-500">Loading...</div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Top Courts</h4>
                            <div id="club-top-courts" class="space-y-2">
                                <div class="text-center py-4 text-gray-500">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="club-overview-empty" class="hidden text-center py-8">
                    <i class="fas fa-chart-bar text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No club data available</p>
                </div>
            </div>

            <!-- Upcoming Matches & Practices -->
            <div class="grid lg:grid-cols-2 gap-6">
                <!-- Future Matches -->
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-trophy text-rally-green"></i>
                        Future Matches
                    </h3>
                    
                    <div id="opponents-loading" class="text-center py-8">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                    
                    <div id="opponents-content" class="hidden space-y-3"></div>
                    
                    <div id="opponents-empty" class="hidden text-center py-8">
                        <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No upcoming matches</p>
                    </div>
                    
                    <a href="/mobile/availability" class="block mt-4 text-center py-3 bg-rally-green text-white rounded-xl font-semibold hover:bg-rally-green-dark transition">
                        Update Availability
                    </a>
                </div>
                
                <!-- Next 3 Practices -->
                <div class="bg-white rounded-2xl p-6 shadow-md">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-dumbbell text-rally-green"></i>
                        Next 3 Practices
                    </h3>
                    
                    <div id="practices-loading" class="text-center py-8">
                        <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                    </div>
                    
                    <div id="practices-content" class="hidden space-y-3"></div>
                    
                    <div id="practices-empty" class="hidden text-center py-8">
                        <i class="fas fa-dumbbell text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">No upcoming practices</p>
                    </div>
                    
                    <a href="/mobile/availability" class="block mt-4 text-center py-3 bg-rally-green text-white rounded-xl font-semibold hover:bg-rally-green-dark transition">
                        Update Availability
                    </a>
                </div>
            </div>
        </section>

        <!-- ============================================
             3. TEAM SECTION
             ============================================ -->
        <section id="team" class="space-y-6">
            <h2 class="text-4xl font-bold text-gray-900 tracking-tight">My Team</h2>
            
            <!-- Captain's Message -->
            <div id="captain-message-section" class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 shadow-md border-l-4 border-rally-green hidden">
                <h3 class="text-xl font-bold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="fas fa-bullhorn text-rally-green"></i>
                    Captain's Message
                </h3>
                <div id="captain-message-content"></div>
            </div>
            
            <!-- How Are We Doing? -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">How Are We Doing?</h3>
                
                <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-xl">
                        <div class="text-sm text-gray-500 mb-1">Total Points</div>
                        <div id="team-points" class="text-3xl font-bold text-rally-green">--</div>
                    </div>
                    
                    <div class="text-center p-4 bg-gray-50 rounded-xl">
                        <div class="text-sm text-gray-500 mb-1">Behind 1st</div>
                        <div id="points-behind" class="text-3xl font-bold text-orange-500">--</div>
                    </div>
                    
                    <div class="text-center p-4 bg-gray-50 rounded-xl">
                        <div class="text-sm text-gray-500 mb-1">Team Record</div>
                        <div id="team-record" class="text-2xl font-bold text-gray-900">-- - --</div>
                    </div>
                    
                    <div class="text-center p-4 bg-gray-50 rounded-xl">
                        <div class="text-sm text-gray-500 mb-1">Win Rate</div>
                        <div id="team-win-rate" class="text-3xl font-bold text-gray-900">--%</div>
                    </div>
                </div>
                
                <a href="/mobile/my-team" class="block mt-6 text-center py-3 bg-rally-green text-white rounded-xl font-semibold hover:bg-rally-green-dark transition">
                    My Team Page →
                </a>
            </div>
            
            <!-- Who's Doing Well? -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-fire text-orange-500"></i>
                    Who's Doing Well?
                </h3>
                
                <div id="team-streaks-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="team-streaks-content" class="hidden carousel pb-4"></div>
                
                <div id="team-streaks-empty" class="hidden text-center py-8 text-gray-500">
                    No current win streaks
                </div>
            </div>
            
            <!-- Series Overview -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Series Standings</h3>
                
                <div id="series-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="series-content" class="hidden space-y-3"></div>
                
                <a href="/mobile/series" class="block mt-6 text-center py-3 bg-gray-100 text-gray-900 rounded-xl font-semibold hover:bg-gray-200 transition">
                    View Full Standings →
                </a>
            </div>
            
            <!-- Team Polls -->
            <div id="team-polls-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-poll text-rally-green"></i>
                    Team Polls
                </h3>
                <div id="team-polls-content"></div>
                <a href="/mobile/polls" class="block mt-4 text-center py-3 bg-rally-green text-white rounded-xl font-semibold hover:bg-rally-green-dark transition">
                    View All Polls →
                </a>
            </div>
        </section>

        <!-- ============================================
             4. CLUB SECTION
             ============================================ -->
        <section id="club" class="space-y-6">
            <h2 class="text-4xl font-bold text-gray-900 tracking-tight">My Club</h2>
            
            <!-- Club Highlights Grid -->
            <div class="grid md:grid-cols-3 gap-6">
                <!-- Teams in 1st Place -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-trophy text-3xl text-yellow-500"></i>
                        <h3 class="text-lg font-bold text-gray-900">1st Place Teams</h3>
                    </div>
                    <div id="first-place-teams" class="text-2xl font-bold text-rally-green">--</div>
                    <p class="text-sm text-gray-500 mt-1">at this club</p>
                </div>
                
                <!-- Players with Win Streaks -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-fire text-3xl text-orange-500"></i>
                        <h3 class="text-lg font-bold text-gray-900">Hot Streaks</h3>
                    </div>
                    <div id="hot-streak-players" class="text-2xl font-bold text-orange-500">--</div>
                    <p class="text-sm text-gray-500 mt-1">players with 3+ wins</p>
                </div>
                
                <!-- PTI Changes -->
                <div class="bg-white rounded-2xl p-6 shadow-md hover-lift">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fas fa-chart-line text-3xl text-blue-500"></i>
                        <h3 class="text-lg font-bold text-gray-900">Rising Stars</h3>
                    </div>
                    <div id="pti-climbers" class="text-2xl font-bold text-blue-500">--</div>
                    <p class="text-sm text-gray-500 mt-1">biggest PTI gains</p>
                </div>
            </div>
            
            <!-- Who's Hot at Club -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">Who's Hot at {{ session_data.user.club }}</h3>
                
                <div id="players-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="players-carousel" class="hidden carousel pb-4"></div>
                
                <div id="players-empty" class="hidden text-center py-8">
                    <i class="fas fa-users text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No player data available</p>
                </div>
            </div>
            
            <!-- Club Events -->
            <div id="club-events-section" class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6 shadow-md hidden">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-star text-purple-600"></i>
                    Club Events
                </h3>
                <div id="club-events-content"></div>
            </div>
            
            <!-- Food & Beer -->
            <div class="grid md:grid-cols-2 gap-6">
                <div id="food-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-utensils text-rally-green"></i>
                        Food Menu
                    </h3>
                    <div id="food-content"></div>
                </div>
                
                <div id="beer-section" class="bg-white rounded-2xl p-6 shadow-md hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class="fas fa-beer text-amber-600"></i>
                        Beer Menu
                    </h3>
                    <div id="beer-content"></div>
                </div>
            </div>
            
            <a href="/mobile/improve" class="block text-center py-4 bg-rally-green text-white rounded-2xl font-semibold hover:bg-rally-green-dark transition text-lg shadow-md">
                More Club Info →
            </a>
        </section>

        <!-- ============================================
             5. IMPROVE SECTION
             ============================================ -->
        <section id="improve" class="space-y-6 pb-12">
            <h2 class="text-4xl font-bold text-gray-900 tracking-tight">Improve</h2>
            
            <!-- Pickup Games -->
            <div class="bg-white rounded-2xl p-6 shadow-md">
                <h3 class="text-2xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-users text-rally-green"></i>
                    Pickup Games
                </h3>
                
                <div id="pickup-loading" class="text-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-200 border-t-rally-green rounded-full animate-spin mx-auto"></div>
                </div>
                
                <div id="pickup-content" class="hidden space-y-3"></div>
                
                <div id="pickup-empty" class="hidden text-center py-8">
                    <i class="fas fa-calendar-alt text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">No pickup games available</p>
                </div>
                
                <a href="/mobile/pickup-games" class="block mt-4 text-center py-3 bg-rally-green text-white rounded-xl font-semibold hover:bg-rally-green-dark transition">
                    View All Pickup Games →
                </a>
            </div>
            
            <!-- Latest Paddle Tip -->
            <div class="bg-gradient-to-br from-rally-green to-rally-green-light rounded-3xl p-8 text-white shadow-xl hover-lift">
                <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-3xl"></i>
                    Latest Paddle Tip
                </h3>
                <div id="paddle-tip-content" class="text-lg mb-6 text-white/90">
                    <p><strong>Master the Lob:</strong> When your opponents are at the net, use a high, deep lob to push them back. Aim for their backhand side for maximum effect.</p>
                </div>
                <a href="/mobile/improve" class="inline-block px-8 py-3 bg-white text-rally-green rounded-full font-semibold hover:bg-gray-100 transition shadow-lg">
                    Improve My Game →
                </a>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-6">
                <a href="/mobile" class="text-gray-500 hover:text-rally-green transition text-sm font-medium">
                    ← Back to Classic View
                </a>
            </div>
            <div class="text-center">
                <p class="text-gray-500 text-sm">Powered by Rally</p>
            </div>
        </div>
    </footer>

    <!-- ============================================
         JAVASCRIPT - DATA LOADING
         ============================================ -->
    <script>
        // Initialize all data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPTIData();
            loadUpcomingMatches();
            loadPractices();
            loadTopPlayers();
            loadNotifications();
            loadTeamData();
            loadSeriesStandings();
            loadClubOverview();
            loadPickupGames();
        });
        
        // ============================================
        // PTI DATA LOADING
        // ============================================
        async function loadPTIData() {
            const loading = document.getElementById('pti-loading');
            const content = document.getElementById('pti-content');
            
            try {
                // Use the same API as analyze-me page for consistent data
                const chartResponse = await fetch('/api/player-history-chart');
                
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                
                if (chartResponse.status === 404) {
                    document.getElementById('pti-value').textContent = '--';
                    document.getElementById('pti-message').innerHTML = 'Keep playing to build your stats! 🎾';
                    return;
                }
                
                const chartData = await chartResponse.json();
                
                if (chartData.error || !chartData.matches || chartData.matches.length === 0) {
                    document.getElementById('pti-value').textContent = '--';
                    document.getElementById('pti-message').innerHTML = 'Keep playing to build your stats! 🎾';
                    return;
                }
                
                // Get current PTI from the most recent match
                const matches = chartData.matches || [];
                const currentPTI = matches.length > 0 ? matches[matches.length - 1].end_pti : 0;
                
                document.getElementById('pti-value').textContent = currentPTI.toFixed(1);
                
                // Calculate PTI delta since start of season
                let deltaDisplay = '';
                if (matches.length > 1) {
                    const startingPTI = matches[0].end_pti;
                    const ptiDelta = currentPTI - startingPTI;
                    if (ptiDelta > 0) {
                        deltaDisplay = `<div class="text-sm text-white/80 mt-2">+${ptiDelta.toFixed(1)} since start of season</div>`;
                    } else if (ptiDelta < 0) {
                        deltaDisplay = `<div class="text-sm text-white/80 mt-2">${ptiDelta.toFixed(1)} since start of season</div>`;
                    } else {
                        deltaDisplay = `<div class="text-sm text-white/80 mt-2">No change since start of season</div>`;
                    }
                }
                
                // Get current season stats from the same API as analyze-me page
                const seasonStatsResponse = await fetch('/api/current-season-stats');
                if (seasonStatsResponse.ok) {
                    const seasonStatsData = await seasonStatsResponse.json();
                    if (seasonStatsData.success && seasonStatsData.matches > 0) {
                        // Use the actual current season data from analyze-me
                        const wins = seasonStatsData.wins || 0;
                        const losses = seasonStatsData.losses || 0;
                        const winRate = Math.round(seasonStatsData.win_rate || 0);
                        
                        document.getElementById('my-record').textContent = `${wins} - ${losses}`;
                        document.getElementById('win-rate').textContent = `${winRate}%`;
                        
                        // Calculate win streak from last-3-matches (for streak only)
                        const lastMatchesResponse = await fetch('/api/last-3-matches');
                        if (lastMatchesResponse.ok) {
                            const lastMatchesData = await lastMatchesResponse.json();
                            if (lastMatchesData.matches && lastMatchesData.matches.length > 0) {
                                let currentStreak = 0;
                                const matches = lastMatchesData.matches.reverse();
                                
                                for (const match of matches) {
                                    const isHome = match['Home Team'] && match['Home Team'].includes('{{ session_data.user.club }}');
                                    const won = (isHome && match.Winner === 'home') || (!isHome && match.Winner === 'away');
                                    
                                    if (won) {
                                        currentStreak++;
                                    } else {
                                        break; // Stop counting streak after first loss
                                    }
                                }
                                
                                document.getElementById('win-streak').textContent = currentStreak > 0 ? `🔥 ${currentStreak}` : '--';
                            } else {
                                document.getElementById('win-streak').textContent = '--';
                            }
                        } else {
                            document.getElementById('win-streak').textContent = '--';
                        }
                    } else {
                        // No current season data available
                        document.getElementById('my-record').textContent = '0 - 0';
                        document.getElementById('win-rate').textContent = '0%';
                        document.getElementById('win-streak').textContent = '--';
                    }
                } else {
                    // Fallback if current-season-stats fails
                    document.getElementById('my-record').textContent = '0 - 0';
                    document.getElementById('win-rate').textContent = '0%';
                    document.getElementById('win-streak').textContent = '--';
                }
                
                // Calculate trend and build message
                let message = `Current PTI: <strong>${currentPTI.toFixed(1)}</strong>`;
                
                if (matches.length > 1) {
                    const recentMatches = matches.slice(-5);
                    const firstPTI = recentMatches[0].end_pti;
                    const lastPTI = recentMatches[recentMatches.length - 1].end_pti;
                    const trend = lastPTI - firstPTI;
                    
                    if (trend > 0) {
                        message += `<br>You're trending <strong>+${trend.toFixed(1)} PTI</strong> over your last ${recentMatches.length} matches.`;
                    }
                }
                
                document.getElementById('pti-message').innerHTML = message + deltaDisplay;
                
                // Find best partner from current season data (same as analyze-me page)
                // For now, we'll use a simplified approach since we don't have partner analysis API
                // In the future, we could add a partner analysis API endpoint
                document.getElementById('best-partner').textContent = 'None';
                
                // Load last match data using the same API as analyze-me page
                await loadLastMatchData();
                
            } catch (error) {
                console.error('Error loading PTI data:', error);
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                document.getElementById('pti-value').textContent = '--';
                document.getElementById('pti-message').innerHTML = 'Unable to load stats';
            }
        }
        
        // ============================================
        // UPCOMING MATCHES LOADING
        // ============================================
        async function loadUpcomingMatches() {
            const nextMatchLoading = document.getElementById('next-match-loading');
            const nextMatchContent = document.getElementById('next-match-content');
            const nextMatchEmpty = document.getElementById('next-match-empty');
            const opponentsLoading = document.getElementById('opponents-loading');
            const opponentsContent = document.getElementById('opponents-content');
            const opponentsEmpty = document.getElementById('opponents-empty');
            
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                
                nextMatchLoading.classList.add('hidden');
                opponentsLoading.classList.add('hidden');
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    nextMatchEmpty.classList.remove('hidden');
                    opponentsEmpty.classList.remove('hidden');
                    return;
                }
                
                // Filter for upcoming matches only (not practices)
                const now = new Date();
                const upcomingMatches = data.matches
                    .filter(match => {
                        try {
                            const matchDate = new Date(match.date);
                            const isUpcoming = matchDate >= now;
                            const isNotPractice = match.type === 'match' && match.away_team && match.away_team !== 'Practice';
                            return isUpcoming && isNotPractice;
                        } catch (e) {
                            return false;
                        }
                    });
                
                if (upcomingMatches.length === 0) {
                    nextMatchEmpty.classList.remove('hidden');
                    opponentsEmpty.classList.remove('hidden');
                    return;
                }
                
                // Next Match (first one)
                const nextMatch = upcomingMatches[0];
                nextMatchContent.classList.remove('hidden');
                const homeTeam = nextMatch.home_team || '';
                const awayTeam = nextMatch.away_team || '';
                const isHome = homeTeam.includes('{{session_data.user.club}}') || homeTeam.includes('{{session_data.user.team_name}}');
                const opponentName = isHome ? awayTeam : homeTeam;
                
                const matchDate = new Date(nextMatch.date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    weekday: 'long',
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = nextMatch.time || 'TBD';
                const location = nextMatch.location || 'TBD';
                
                document.getElementById('next-match-details').innerHTML = `
                    <div class="text-5xl font-bold mb-4">vs ${opponentName}</div>
                    <div class="flex items-center gap-6 text-lg flex-wrap">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-calendar"></i>
                            ${dateStr}
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-clock"></i>
                            ${timeStr}
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-map-marker-alt"></i>
                            ${location}
                        </div>
                        <div class="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full">
                            ${isHome ? '🏠 Home' : '✈️ Away'}
                        </div>
                    </div>
                    <a href="https://maps.google.com/?q=${encodeURIComponent(location)}" target="_blank" class="inline-block mt-6 px-6 py-2 bg-white text-rally-green rounded-full font-semibold hover:bg-gray-100 transition">Get Directions →</a>
                `;
                
                // Next 3 Matches
                const next3 = upcomingMatches.slice(0, 3);
                opponentsContent.classList.remove('hidden');
                opponentsContent.innerHTML = '';
                
                next3.forEach(match => {
                    const matchDiv = createMatchElement(match);
                    opponentsContent.appendChild(matchDiv);
                });
                
            } catch (error) {
                console.error('Error loading matches:', error);
                nextMatchLoading.classList.add('hidden');
                opponentsLoading.classList.add('hidden');
                nextMatchEmpty.classList.remove('hidden');
                opponentsEmpty.classList.remove('hidden');
            }
        }
        
        function createMatchElement(match) {
            const div = document.createElement('div');
            div.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition';
            
            const homeTeam = match.home_team || '';
            const awayTeam = match.away_team || '';
            const isHome = homeTeam.includes('{{session_data.user.club}}') || homeTeam.includes('{{session_data.user.team_name}}');
            const opponentName = isHome ? awayTeam : homeTeam;
            
            // Extract club name from opponent team name (e.g., "Exmoor 20" -> "Exmoor")
            const clubName = opponentName.replace(/\s+\d+$/, '').toLowerCase();
            
            const matchDate = new Date(match.date);
            const dateStr = matchDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = match.time || 'TBD';
            const location = match.location || '';
            
            div.innerHTML = `
                <div class="w-14 h-14 rounded-xl bg-gray-100 flex items-center justify-center flex-shrink-0">
                    <img src="/static/images/clubs/${clubName}_logo.png" 
                         alt="${opponentName} Logo" 
                         class="w-12 h-12 object-contain rounded-lg"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-12 h-12 bg-gradient-to-br from-rally-green to-rally-green-light text-white flex items-center justify-center font-bold text-lg rounded-lg" style="display: none;">
                        ${opponentName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase()}
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-gray-900">vs ${opponentName}</div>
                    <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                    ${location ? `<div class="text-xs text-gray-500">📍 ${location}</div>` : ''}
                </div>
            `;
            
            return div;
        }
        
        // ============================================
        // PRACTICES LOADING
        // ============================================
        async function loadPractices() {
            const loading = document.getElementById('practices-loading');
            const content = document.getElementById('practices-content');
            const empty = document.getElementById('practices-empty');
            
            try {
                const response = await fetch('/api/schedule');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                const now = new Date();
                const practices = data.matches
                    .filter(match => {
                        try {
                            const matchDate = new Date(match.date);
                            return matchDate >= now && match.type === 'practice';
                        } catch (e) {
                            return false;
                        }
                    })
                    .slice(0, 3);
                
                if (practices.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                content.innerHTML = '';
                
                practices.forEach(practice => {
                    const practiceDate = new Date(practice.date);
                    const dateStr = practiceDate.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        month: 'short', 
                        day: 'numeric' 
                    });
                    const timeStr = practice.time || 'TBD';
                    const location = practice.location || 'TBD';
                    
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-xl';
                    div.innerHTML = `
                        <div class="w-14 h-14 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-2xl flex-shrink-0">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-900">${practice.description || 'Practice'}</div>
                            <div class="text-sm text-gray-600">${dateStr} at ${timeStr}</div>
                            <div class="text-xs text-gray-500">📍 ${location}</div>
                        </div>
                    `;
                    content.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error loading practices:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // TOP PLAYERS LOADING
        // ============================================
        async function loadTopPlayers() {
            const loading = document.getElementById('players-loading');
            const carousel = document.getElementById('players-carousel');
            const empty = document.getElementById('players-empty');
            
            try {
                const response = await fetch('/api/pti-analysis/players');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (!data || data.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                const topPlayers = data
                    .filter(p => {
                        const pti = typeof p.PTI === 'number' ? p.PTI : parseFloat(p.PTI);
                        return pti && pti > 0;
                    })
                    .sort((a, b) => {
                        const aPTI = typeof a.PTI === 'number' ? a.PTI : parseFloat(a.PTI) || 0;
                        const bPTI = typeof b.PTI === 'number' ? b.PTI : parseFloat(b.PTI) || 0;
                        return bPTI - aPTI;
                    })
                    .slice(0, 10);
                
                if (topPlayers.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                carousel.classList.remove('hidden');
                carousel.innerHTML = '';
                
                topPlayers.forEach(player => {
                    const firstName = player['First Name'] || '';
                    const lastName = player['Last Name'] || '';
                    const fullName = `${firstName} ${lastName}`.trim();
                    const initials = `${firstName[0] || ''}${lastName[0] || ''}`.toUpperCase();
                    const ptiValue = typeof player.PTI === 'number' ? player.PTI : parseFloat(player.PTI) || 0;
                    const pti = ptiValue.toFixed(1);
                    
                    const div = document.createElement('div');
                    div.className = 'flex-shrink-0 w-40 bg-gray-50 rounded-2xl p-5 text-center hover:bg-gray-100 transition';
                    div.innerHTML = `
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-rally-green to-rally-green-light text-white flex items-center justify-center font-bold text-xl mx-auto mb-3">
                            ${initials}
                        </div>
                        <div class="font-semibold text-gray-900 text-sm mb-1">${fullName}</div>
                        <div class="text-2xl font-bold text-rally-green">${pti}</div>
                        <div class="text-xs text-gray-500 mt-1">PTI</div>
                    `;
                    carousel.appendChild(div);
                });
                
                // Update club stats
                document.getElementById('hot-streak-players').textContent = topPlayers.filter(p => p['Win Streak'] >= 3).length;
                
            } catch (error) {
                console.error('Error loading top players:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        // ============================================
        // NOTIFICATIONS LOADING
        // ============================================
        async function loadNotifications() {
            try {
                const response = await fetch('/api/home/notifications');
                const data = await response.json();
                
                if (data.error || !data.notifications) {
                    return;
                }
                
                const notifications = data.notifications || [];
                
                // Captain's Message
                const captainMessages = notifications.filter(n => n.type === 'captain');
                if (captainMessages.length > 0) {
                    const section = document.getElementById('captain-message-section');
                    const content = document.getElementById('captain-message-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700">${captainMessages[0].message}</p>`;
                }
                
                // Team Polls
                const polls = notifications.filter(n => n.type === 'poll');
                if (polls.length > 0) {
                    const section = document.getElementById('team-polls-section');
                    const content = document.getElementById('team-polls-content');
                    section.classList.remove('hidden');
                    content.innerHTML = polls.map(poll => `
                        <div class="p-4 bg-gray-50 rounded-xl mb-2">
                            <div class="font-semibold text-gray-900">${poll.title}</div>
                            <p class="text-sm text-gray-600 mt-1">${poll.message}</p>
                        </div>
                    `).join('');
                }
                
                // Food notifications
                const foodNotifs = notifications.filter(n => n.type === 'food');
                if (foodNotifs.length > 0) {
                    const section = document.getElementById('food-section');
                    const content = document.getElementById('food-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700">${foodNotifs[0].message}</p>`;
                }
                
                // Beer notifications
                const beerNotifs = notifications.filter(n => n.type === 'beer');
                if (beerNotifs.length > 0) {
                    const section = document.getElementById('beer-section');
                    const content = document.getElementById('beer-content');
                    section.classList.remove('hidden');
                    content.innerHTML = `<p class="text-gray-700">${beerNotifs[0].message}</p>`;
                }
                
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        // ============================================
        // TEAM DATA LOADING
        // ============================================
        async function loadTeamData() {
            try {
                // Get team stats from the team stats API (same as my-team page)
                const response = await fetch('/api/team-stats');
                
                if (!response.ok) {
                    console.error('Team stats API error:', response.status, response.statusText);
                    // Show placeholder data
                    document.getElementById('team-points').textContent = '--';
                    document.getElementById('points-behind').textContent = '--';
                    document.getElementById('team-record').textContent = '-- - --';
                    document.getElementById('team-win-rate').textContent = '--%';
                    return;
                }
                
                const data = await response.json();
                
                if (data.error || !data.success) {
                    console.error('Error loading team stats:', data.error);
                    // Show placeholder data
                    document.getElementById('team-points').textContent = '--';
                    document.getElementById('points-behind').textContent = '--';
                    document.getElementById('team-record').textContent = '-- - --';
                    document.getElementById('team-win-rate').textContent = '--%';
                    return;
                }
                
                // Use the team stats data (same as my-team page)
                const points = data.points || 0;
                const matchesWon = data.matches_won || 0;
                const matchesLost = data.matches_lost || 0;
                const winRate = data.win_rate || 0;
                
                // Update team points
                document.getElementById('team-points').textContent = points;
                
                // For now, show placeholder for points behind (would need series standings API)
                document.getElementById('points-behind').textContent = '--';
                
                // Update team record
                document.getElementById('team-record').textContent = `${matchesWon} - ${matchesLost}`;
                
                // Update win rate
                document.getElementById('team-win-rate').textContent = `${Math.round(winRate)}%`;
                
            } catch (error) {
                console.error('Error loading team data:', error);
                // Show placeholder data on error
                document.getElementById('team-points').textContent = '--';
                document.getElementById('points-behind').textContent = '--';
                document.getElementById('team-record').textContent = '-- - --';
                document.getElementById('team-win-rate').textContent = '--%';
            }
        }
        
        // ============================================
        // SERIES STANDINGS LOADING
        // ============================================
        async function loadSeriesStandings() {
            // Placeholder - would connect to actual series standings API
            const content = document.getElementById('series-content');
            content.classList.remove('hidden');
            content.innerHTML = '<p class="text-gray-500 text-center py-4">Standings data loading...</p>';
        }
        
        // ============================================
        // CLUB OVERVIEW LOADING
        // ============================================
        async function loadClubOverview() {
            const loading = document.getElementById('club-overview-loading');
            const content = document.getElementById('club-overview-content');
            const empty = document.getElementById('club-overview-empty');
            
            try {
                // Get club players data for stats
                const response = await fetch('/api/club-players');
                const data = await response.json();
                
                loading.classList.add('hidden');
                
                if (data.error || !data.players || data.players.length === 0) {
                    empty.classList.remove('hidden');
                    return;
                }
                
                content.classList.remove('hidden');
                
                // Calculate club stats
                const players = data.players || [];
                let totalWins = 0;
                let totalLosses = 0;
                let totalMatches = 0;
                
                players.forEach(player => {
                    const wins = player.wins || 0;
                    const losses = player.losses || 0;
                    totalWins += wins;
                    totalLosses += losses;
                    totalMatches += wins + losses;
                });
                
                // Update record and win rate
                document.getElementById('club-record').textContent = `${totalWins} - ${totalLosses}`;
                const winRate = totalMatches > 0 ? Math.round((totalWins / totalMatches) * 100) : 0;
                document.getElementById('club-win-rate').textContent = `${winRate}%`;
                
                // Get top players by PTI
                const topPlayers = players
                    .filter(p => p.PTI && !isNaN(parseFloat(p.PTI)))
                    .sort((a, b) => parseFloat(b.PTI) - parseFloat(a.PTI))
                    .slice(0, 3);
                
                const topPlayersContainer = document.getElementById('club-top-players');
                if (topPlayers.length > 0) {
                    topPlayersContainer.innerHTML = topPlayers.map(player => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-rally-green text-white rounded-full flex items-center justify-center text-sm font-bold">
                                    ${player.first_name ? player.first_name[0] : '?'}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">${player.first_name} ${player.last_name}</div>
                                    <div class="text-sm text-gray-600">${player.wins || 0}-${player.losses || 0}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-rally-green">${parseFloat(player.PTI).toFixed(1)}</div>
                                <div class="text-xs text-gray-500">PTI</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    topPlayersContainer.innerHTML = '<div class="text-center py-4 text-gray-500">No player data available</div>';
                }
                
                // Get top courts (placeholder - would need court-specific data)
                const topCourtsContainer = document.getElementById('club-top-courts');
                topCourtsContainer.innerHTML = `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-rally-green text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
                            <div class="font-medium text-gray-900">Court 1</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-rally-green">${winRate}%</div>
                            <div class="text-xs text-gray-500">Win Rate</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-rally-green text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
                            <div class="font-medium text-gray-900">Court 2</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-rally-green">${Math.max(0, winRate - 5)}%</div>
                            <div class="text-xs text-gray-500">Win Rate</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading club overview:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        // ============================================
        // LAST MATCH LOADING
        // ============================================
        async function loadLastMatchData() {
            const loading = document.getElementById('last-match-loading');
            const content = document.getElementById('last-match-content');
            const empty = document.getElementById('last-match-empty');
            
            // Check if elements exist
            if (!loading || !content || !empty) {
                console.error('Last match HTML elements not found');
                return;
            }
            
            try {
                // Use the same API as analyze-me page
                const response = await fetch('/api/last-3-matches');
                
                if (response.status === 404) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                const data = await response.json();
                
                if (data.error || !data.matches || data.matches.length === 0) {
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                    return;
                }
                
                // Get the most recent match (first in the array)
                const lastMatch = data.matches[0];
                
                // Parse match data - use correct field names from /api/last-3-matches response
                const matchDate = new Date(lastMatch.Date);
                const dateStr = matchDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const timeStr = 'TBD'; // Time not available in this API
                
                // Determine if our team won
                const isHome = lastMatch['Home Team'] && lastMatch['Home Team'].includes('{{ session_data.user.club }}');
                const won = (isHome && lastMatch.Winner === 'home') || (!isHome && lastMatch.Winner === 'away');
                
                // Get opponent team name
                const opponentTeam = isHome ? lastMatch['Away Team'] : lastMatch['Home Team'];
                
                // Get opponent players - these are player IDs, not names
                const opponent1 = isHome ? lastMatch['Away Player 1'] : lastMatch['Home Player 1'];
                const opponent2 = isHome ? lastMatch['Away Player 2'] : lastMatch['Home Player 2'];
                const opponentNames = opponentTeam || 'Unknown'; // Use team name instead of player IDs
                
                // Format score
                const scores = lastMatch.Scores ? lastMatch.Scores.split(', ') : [];
                const scoreStr = scores.length > 0 ? scores.join(', ') : '--';
                
                // Update the last match display
                content.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-full ${won ? 'bg-green-100' : 'bg-red-100'} flex items-center justify-center">
                            <i class="fas fa-${won ? 'trophy' : 'times'} text-2xl ${won ? 'text-green-600' : 'text-red-600'}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-lg ${won ? 'text-green-600' : 'text-red-600'}">${won ? 'Won' : 'Lost'}</div>
                            <div class="text-gray-600">vs ${opponentNames}</div>
                            <div class="text-sm text-gray-500">${dateStr} at ${timeStr}</div>
                            <div class="text-xs text-gray-400">${scoreStr}</div>
                        </div>
                    </div>
                `;
                
                loading.classList.add('hidden');
                content.classList.remove('hidden');
                empty.classList.add('hidden');
                
            } catch (error) {
                console.error('Error loading last match data:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        // ============================================
        // PICKUP GAMES LOADING
        // ============================================
        async function loadPickupGames() {
            // Placeholder - would connect to actual pickup games API
            const loading = document.getElementById('pickup-loading');
            const empty = document.getElementById('pickup-empty');
            loading.classList.add('hidden');
            empty.classList.remove('hidden');
        }
    </script>
    
</body>
</html>
{% endblock %}

