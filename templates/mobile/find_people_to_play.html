{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="flex items-center gap-3 mt-4 mb-2 px-4">
  <div class="bg-white rounded-md flex items-center justify-center h-12 w-12">
    <i class="fas fa-user-friends text-black text-3xl"></i>
  </div>
  <div>
    <div class="text-2xl font-bold leading-tight">Find People to Play</div>
    <div class="text-base text-gray-500 mt-1">Find players at {{ session_data.user.club }} to play.</div>
  </div>
</div>

<!-- Filter Section -->
<div class="px-4 mb-6 space-y-4">
  <div class="bg-white rounded-lg shadow-md p-4">
    <h3 class="text-lg font-semibold mb-4 text-gray-800">Filter Players</h3>
    
    <!-- Series Filter -->
    <div class="mb-4">
      <label for="seriesFilter" class="block text-sm font-medium text-gray-700 mb-1">Series</label>
      <select id="seriesFilter" class="w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <option value="">All Series</option>
      </select>
    </div>

    <!-- PTI Range Filter -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">PTI Filters</label>
      <div class="space-y-3">
        <div>
          <label for="ptiMinSlider" class="block text-xs font-medium text-gray-600 mb-1">Minimum PTI</label>
          <input type="range" id="ptiMinSlider" class="slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                 min="0" max="100" value="0" step="0.1">
          <div class="text-xs text-gray-500 mt-1">Min: <span id="ptiMinValue">0</span></div>
        </div>
        <div>
          <label for="ptiMaxSlider" class="block text-xs font-medium text-gray-600 mb-1">Maximum PTI</label>
          <input type="range" id="ptiMaxSlider" class="slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                 min="0" max="100" value="100" step="0.1">
          <div class="text-xs text-gray-500 mt-1">Max: <span id="ptiMaxValue">100</span></div>
        </div>
      </div>
      <div class="text-xs text-gray-500 mt-1">
        Available Range: <span id="ptiRangeDisplay">0 - 100</span>
      </div>
    </div>

    <!-- Name Filters -->
    <div class="grid grid-cols-2 gap-3 mb-4">
      <div>
        <label for="firstNameFilter" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
        <input type="text" id="firstNameFilter" placeholder="Enter first name" 
               class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <div>
        <label for="lastNameFilter" class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
        <input type="text" id="lastNameFilter" placeholder="Enter last name" 
               class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="flex gap-2">
      <button id="applyFilters" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
        <i class="fas fa-search mr-2"></i>Apply Filters
      </button>
      <button id="resetFilters" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors duration-200">
        <i class="fas fa-undo-alt mr-1"></i>Reset
      </button>
    </div>
  </div>
</div>

<!-- Loading Indicator -->
<div id="playersLoading" class="flex justify-center items-center py-8">
    <span class="loading loading-spinner loading-lg"></span>
</div>

<!-- Results Section -->
<div id="playersList" class="space-y-4 px-4"></div>

<!-- Message Selected Players Button (moved here for better visibility) -->
<div id="messageButtonContainer" class="sticky bottom-0 w-full p-4 bg-white border-t border-gray-200 shadow-lg" style="display: none;">
  <div class="flex justify-center">
    <button id="messageSelectedBtn" class="px-8 py-4 bg-green-600 text-white rounded-lg shadow-xl hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200 flex items-center gap-3 text-lg font-semibold">
      <i class="fas fa-sms text-xl"></i>
      <span>Message <span id="selectedCount">0</span> Selected Players</span>
    </button>
  </div>
</div>

<!-- Modal for Selected Players -->
<div id="selectedPlayersModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div class="bg-white rounded-lg max-w-md w-full max-h-[80vh] overflow-hidden">
    <!-- Modal Header -->
    <div class="p-4 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800">Selected Players</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="p-4 overflow-y-auto max-h-96">
      <div id="selectedPlayersList" class="space-y-3">
        <!-- Selected players will be populated here -->
      </div>
    </div>
    
    <!-- Modal Footer -->
    <div class="p-4 border-t border-gray-200 space-y-3">
      <div id="smsLinkContainer" class="text-center">
        <!-- SMS link will be populated here -->
      </div>
      <div class="flex gap-2">
        <button id="selectAllBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200">
          Select All
        </button>
        <button id="clearSelectionsBtn" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors duration-200">
          Clear All
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Custom Slider Styles -->
<style>
.slider {
  -webkit-appearance: none;
  appearance: none;
  height: 8px;
  background: #e5e7eb;
  outline: none;
  border-radius: 4px;
  transition: background 0.3s ease;
}

.slider:hover {
  background: #d1d5db;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: #3b82f6;
  cursor: pointer;
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
  background: #2563eb;
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: #3b82f6;
  cursor: pointer;
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}

.slider::-moz-range-thumb:hover {
  background: #2563eb;
  transform: scale(1.1);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let allPlayers = [];
    let availableSeries = [];
    let ptiRange = { min: 0, max: 100 };
    let selectedPlayers = new Set(); // Track selected player names
    
    // UI Elements
    const loadingDiv = document.getElementById('playersLoading');
    const playersList = document.getElementById('playersList');
    const seriesFilter = document.getElementById('seriesFilter');
    const firstNameFilter = document.getElementById('firstNameFilter');
    const lastNameFilter = document.getElementById('lastNameFilter');
    const ptiMinSlider = document.getElementById('ptiMinSlider');
    const ptiMaxSlider = document.getElementById('ptiMaxSlider');
    const ptiMinValue = document.getElementById('ptiMinValue');
    const ptiMaxValue = document.getElementById('ptiMaxValue');
    const ptiRangeDisplay = document.getElementById('ptiRangeDisplay');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    // Selection UI Elements
    const messageButtonContainer = document.getElementById('messageButtonContainer');
    const messageSelectedBtn = document.getElementById('messageSelectedBtn');
    const selectedCount = document.getElementById('selectedCount');
    const selectedPlayersModal = document.getElementById('selectedPlayersModal');
    const closeModal = document.getElementById('closeModal');
    const selectedPlayersList = document.getElementById('selectedPlayersList');
    const smsLinkContainer = document.getElementById('smsLinkContainer');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const clearSelectionsBtn = document.getElementById('clearSelectionsBtn');

    // Initialize page
    async function initializePage() {
        try {
            showLoading(true);
            await loadInitialData();
            setupEventListeners();
            loadPlayers();
        } catch (error) {
            console.error('Error initializing page:', error);
            showError('Failed to load page data');
        }
    }

    // Load initial data (available series and PTI range)
    async function loadInitialData() {
        const response = await fetch('/api/club-players');
        if (!response.ok) throw new Error('Failed to fetch initial data');
        
        const data = await response.json();
        availableSeries = data.available_series || [];
        ptiRange = data.pti_range || { min: 0, max: 100 };
        
        // Populate series dropdown
        seriesFilter.innerHTML = '<option value="">All Series</option>';
        availableSeries.forEach(series => {
            const option = document.createElement('option');
            option.value = series;
            option.textContent = series;
            seriesFilter.appendChild(option);
        });
        
        // Set up PTI sliders
        setupPTISliders();
    }

    // Setup PTI slider fields
    function setupPTISliders() {
        ptiMinSlider.value = ptiRange.min;
        ptiMaxSlider.value = ptiRange.max;
        ptiMinSlider.min = ptiRange.min;
        ptiMinSlider.max = ptiRange.max;
        ptiMaxSlider.min = ptiRange.min;
        ptiMaxSlider.max = ptiRange.max;
        ptiMinValue.textContent = ptiRange.min;
        ptiMaxValue.textContent = ptiRange.max;
        ptiRangeDisplay.textContent = `${ptiRange.min} - ${ptiRange.max}`;
    }

    // Setup event listeners
    function setupEventListeners() {
        // Filter events
        applyFiltersBtn.addEventListener('click', loadPlayers);
        resetFiltersBtn.addEventListener('click', resetFilters);
        
        // Auto-apply on Enter key for text inputs
        firstNameFilter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loadPlayers();
        });
        lastNameFilter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loadPlayers();
        });
        
        // PTI slider events with real-time value updates
        ptiMinSlider.addEventListener('input', function() {
            let minVal = parseFloat(this.value);
            let maxVal = parseFloat(ptiMaxSlider.value);
            
            // Ensure min doesn't exceed max
            if (minVal > maxVal) {
                minVal = maxVal;
                this.value = minVal;
            }
            
            ptiMinValue.textContent = minVal.toFixed(1);
        });
        
        ptiMaxSlider.addEventListener('input', function() {
            let maxVal = parseFloat(this.value);
            let minVal = parseFloat(ptiMinSlider.value);
            
            // Ensure max doesn't go below min
            if (maxVal < minVal) {
                maxVal = minVal;
                this.value = maxVal;
            }
            
            ptiMaxValue.textContent = maxVal.toFixed(1);
        });
        
        // Selection events
        messageSelectedBtn.addEventListener('click', showSelectedPlayersModal);
        closeModal.addEventListener('click', hideSelectedPlayersModal);
        selectAllBtn.addEventListener('click', selectAllPlayers);
        clearSelectionsBtn.addEventListener('click', clearAllSelections);
        
        // Close modal when clicking outside
        selectedPlayersModal.addEventListener('click', function(e) {
            if (e.target === selectedPlayersModal) {
                hideSelectedPlayersModal();
            }
        });
    }

    // Generate a mock phone number for demonstration
    function generatePhoneNumber(playerName) {
        // Generate a consistent phone number based on the player's name
        let hash = 0;
        for (let i = 0; i < playerName.length; i++) {
            const char = playerName.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        
        // Generate a phone number in format +1XXX-XXX-XXXX
        const areaCode = 200 + Math.abs(hash % 800); // 200-999
        const exchange = 200 + Math.abs((hash >> 8) % 800); // 200-999  
        const number = 1000 + Math.abs((hash >> 16) % 9000); // 1000-9999
        
        return `+1${areaCode}${exchange}${number}`;
    }

    // Load and display players
    async function loadPlayers() {
        try {
            showLoading(true);
            
            // Build query parameters
            const params = new URLSearchParams();
            
            if (seriesFilter.value) params.append('series', seriesFilter.value);
            if (firstNameFilter.value.trim()) params.append('first_name', firstNameFilter.value.trim());
            if (lastNameFilter.value.trim()) params.append('last_name', lastNameFilter.value.trim());
            
            const ptiMin = parseFloat(ptiMinSlider.value);
            const ptiMax = parseFloat(ptiMaxSlider.value);
            if (!isNaN(ptiMin) && ptiMin >= ptiRange.min) params.append('pti_min', ptiMin);
            if (!isNaN(ptiMax) && ptiMax <= ptiRange.max) params.append('pti_max', ptiMax);
            
            const response = await fetch('/api/club-players?' + params.toString());
            if (!response.ok) throw new Error('Failed to fetch players');
            
            const data = await response.json();
            allPlayers = data.players || [];
            
            // Add phone numbers to players for demo
            allPlayers.forEach(player => {
                player.phoneNumber = generatePhoneNumber(player.name);
            });
            
            displayPlayers(allPlayers);
            showLoading(false);
            
        } catch (error) {
            console.error('Error loading players:', error);
            showError('Failed to load players');
        }
    }

    // Display players
    function displayPlayers(players) {
        playersList.innerHTML = '';
        
        if (players.length === 0) {
            playersList.innerHTML = '<div class="text-center text-gray-500 py-8">No players found matching your criteria.</div>';
            return;
        }
        
        players.forEach(player => {
            const card = createPlayerCard(player);
            playersList.appendChild(card);
        });
        
        updateSelectionUI();
    }

    // Create player card with checkbox
    function createPlayerCard(player) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow p-4';
        
        const isSelected = selectedPlayers.has(player.name);
        
        card.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="flex items-center pt-1">
                    <input type="checkbox" id="player-${player.name.replace(/\s+/g, '-')}" 
                           class="player-checkbox w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2" 
                           data-player-name="${player.name}" ${isSelected ? 'checked' : ''}>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="font-bold text-lg text-gray-800">${player.name}</div>
                            <div class="text-sm text-gray-500">${player.series}</div>
                        </div>
                        <button class="btn btn-success btn-sm contact-btn" 
                                data-first="${player.firstName}" 
                                data-last="${player.lastName}">
                            <i class="fas fa-envelope"></i> Contact
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="space-y-1">
                            <div><span class="font-semibold text-gray-600">PTI:</span> <span class="text-blue-600 font-medium">${player.pti}</span></div>
                            <div><span class="font-semibold text-gray-600">Wins:</span> ${player.wins}</div>
                        </div>
                        <div class="space-y-1">
                            <div><span class="font-semibold text-gray-600">Win Rate:</span> <span class="text-green-600 font-medium">${player.winRate}</span></div>
                            <div><span class="font-semibold text-gray-600">Losses:</span> ${player.losses}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add contact button functionality
        const contactBtn = card.querySelector('.contact-btn');
        contactBtn.addEventListener('click', function() {
            const firstName = this.dataset.first;
            const lastName = this.dataset.last;
            window.location.href = `/contact-sub?first=${encodeURIComponent(firstName)}&last=${encodeURIComponent(lastName)}`;
        });
        
        // Add checkbox functionality
        const checkbox = card.querySelector('.player-checkbox');
        checkbox.addEventListener('change', function() {
            const playerName = this.dataset.playerName;
            if (this.checked) {
                selectedPlayers.add(playerName);
            } else {
                selectedPlayers.delete(playerName);
            }
            updateSelectionUI();
        });
        
        return card;
    }

    // Update selection UI
    function updateSelectionUI() {
        const count = selectedPlayers.size;
        selectedCount.textContent = count;
        
        if (count > 0) {
            messageButtonContainer.style.display = 'block';
        } else {
            messageButtonContainer.style.display = 'none';
        }
    }

    // Show selected players modal
    function showSelectedPlayersModal() {
        const selectedPlayersData = allPlayers.filter(player => selectedPlayers.has(player.name));
        
        // Populate selected players list
        selectedPlayersList.innerHTML = '';
        selectedPlayersData.forEach(player => {
            const playerElement = document.createElement('div');
            playerElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
            playerElement.innerHTML = `
                <div>
                    <div class="font-semibold text-gray-800">${player.name}</div>
                    <div class="text-sm text-gray-600">${player.series}</div>
                </div>
                <div class="text-sm text-blue-600 font-mono">${player.phoneNumber}</div>
            `;
            selectedPlayersList.appendChild(playerElement);
        });
        
        // Create SMS link
        if (selectedPlayersData.length > 0) {
            const phoneNumbers = selectedPlayersData.map(player => player.phoneNumber).join(',');
            smsLinkContainer.innerHTML = `
                <a href="sms:${phoneNumbers}" 
                   class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200">
                    <i class="fas fa-sms"></i>
                    Text the Team (${selectedPlayersData.length} players)
                </a>
            `;
        } else {
            smsLinkContainer.innerHTML = '<p class="text-gray-500">No players selected</p>';
        }
        
        selectedPlayersModal.classList.remove('hidden');
    }

    // Hide selected players modal
    function hideSelectedPlayersModal() {
        selectedPlayersModal.classList.add('hidden');
    }

    // Select all players
    function selectAllPlayers() {
        allPlayers.forEach(player => {
            selectedPlayers.add(player.name);
        });
        
        // Update all checkboxes
        document.querySelectorAll('.player-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        
        updateSelectionUI();
        hideSelectedPlayersModal();
    }

    // Clear all selections
    function clearAllSelections() {
        selectedPlayers.clear();
        
        // Update all checkboxes
        document.querySelectorAll('.player-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        updateSelectionUI();
        hideSelectedPlayersModal();
    }

    // Reset filters
    function resetFilters() {
        seriesFilter.value = '';
        firstNameFilter.value = '';
        lastNameFilter.value = '';
        
        ptiMinSlider.value = ptiRange.min;
        ptiMaxSlider.value = ptiRange.max;
        ptiMinValue.textContent = ptiRange.min;
        ptiMaxValue.textContent = ptiRange.max;
        ptiRangeDisplay.textContent = `${ptiRange.min} - ${ptiRange.max}`;
        
        // Clear selections when resetting filters
        selectedPlayers.clear();
        updateSelectionUI();
        
        loadPlayers();
    }

    // Show/hide loading indicator
    function showLoading(show) {
        if (show) {
            loadingDiv.style.display = 'flex';
            playersList.innerHTML = '';
        } else {
            loadingDiv.style.display = 'none';
        }
    }

    // Show error message
    function showError(message) {
        showLoading(false);
        playersList.innerHTML = `<div class="text-center text-red-500 py-8">${message}</div>`;
    }

    // Initialize the page
    initializePage();
});
</script>
{% endblock %} 