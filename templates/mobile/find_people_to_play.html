{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="container">
        <!-- Header -->
        <div class="bg-white border-b border-gray-100">
            <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                <i class="fas fa-user-friends text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">Search Players</h1>
                <p class="text-sm text-gray-500">Find players in {{ session_data.user.league_name if session_data and session_data.user and session_data.user.league_name else 'your league' }}</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">

        <!-- Filter Section -->
        <div id="filtersCard" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 space-y-4">
    
                <!-- Name Filters (First) -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="firstNameFilter" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                        <input type="text" id="firstNameFilter" placeholder="Enter first name" 
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="lastNameFilter" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                        <input type="text" id="lastNameFilter" placeholder="Enter last name" 
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <!-- Advanced Search Toggle -->
                <div class="flex justify-center">
                    <button id="advancedSearchToggle" class="px-4 py-2 text-blue-600 border border-blue-300 rounded-lg hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200 font-medium text-sm flex items-center">
                        <i class="fas fa-cog mr-2"></i>
                        <span id="advancedSearchText">Advanced Search</span>
                        <i id="advancedSearchIcon" class="fas fa-chevron-down ml-2"></i>
                    </button>
                </div>

                <!-- Advanced Filters Section (Hidden by default) -->
                <div id="advancedFiltersSection" style="display: none;" class="space-y-4 border-t border-gray-200 pt-4">
                    
                    <!-- Series Filter -->
                    <div>
                        <label for="seriesFilter" class="block text-sm font-medium text-gray-700 mb-2">Series</label>
                        <select id="seriesFilter" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Series</option>
                        </select>
                    </div>

                    <!-- PTI Range Filter -->
                    <div id="ptiFiltersSection">
                        <label class="block text-sm font-medium text-gray-700 mb-3">PTI Range</label>
                        <div class="bg-gray-50 rounded-lg p-4 space-y-4">
                            <div>
                                <label for="ptiMinSlider" class="block text-xs font-medium text-gray-600 mb-2">Minimum PTI</label>
                                <input type="range" id="ptiMinSlider" class="slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                       min="-30" max="100" value="-30" step="0.1">
                                <div class="text-xs text-gray-500 mt-1">Min: <span id="ptiMinValue">-30</span></div>
                            </div>
                            <div>
                                <label for="ptiMaxSlider" class="block text-xs font-medium text-gray-600 mb-2">Maximum PTI</label>
                                <input type="range" id="ptiMaxSlider" class="slider w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" 
                                       min="0" max="100" value="100" step="0.1">
                                <div class="text-xs text-gray-500 mt-1">Max: <span id="ptiMaxValue">100</span></div>
                            </div>
                            <div class="text-xs text-gray-500 text-center">
                                Available Range: <span id="ptiRangeDisplay">-30 - 100</span>
                            </div>
                        </div>
                    </div>

                    <!-- Club Filter Checkbox -->
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-building text-blue-600 text-lg"></i>
                                </div>
                                <div>
                                    <label for="clubOnlyFilter" class="text-base font-bold text-gray-900 cursor-pointer flex items-center">
                                        <span id="clubOnlyLabel">My Club</span>&nbsp;only
                                        <i class="fas fa-filter text-blue-600 ml-2"></i>
                                    </label>
                                    <p class="text-sm text-gray-600 font-medium">Show only players from your club</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <!-- Checkbox (unchecked by default) -->
                                <input type="checkbox" id="clubOnlyFilter" 
                                       class="w-6 h-6 text-blue-600 bg-white border-2 border-blue-300 rounded focus:ring-blue-500 focus:ring-2 shadow-sm">
                            </div>
                        </div>
                        <!-- Status Indicator -->
                        <div id="clubFilterStatus" class="mt-3 flex items-center" style="display: none;">
                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                            <span class="text-sm font-semibold text-green-700">Club filter is ON</span>
                        </div>
                    </div>

                </div>

                <!-- Filter Buttons -->
                <div class="flex gap-3 pt-2">
                    <button id="applyFilters" class="flex-1 px-4 py-3 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200 font-medium" style="background-color: #085454;">
                        <i class="fas fa-search mr-2"></i>Search Players
                    </button>
                    <button id="resetFilters" class="px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors duration-200 font-medium">
                        <i class="fas fa-undo-alt mr-2"></i>Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Scroll Anchor -->
        <div id="scrollAnchor"></div>

        

        <!-- Players List Section (Hidden initially) -->
        <div id="playersCard" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" style="display: none;">
            <div class="px-6 py-4 border-b border-gray-50" style="background-color: #045454;">
                <h2 class="text-lg font-semibold flex items-center" style="color: #bff863;">
                    <i class="fas fa-users mr-2" style="color: #bff863;"></i>
                    Players
                </h2>
            </div>
            
            <!-- Loading State -->
            <div id="playersLoading" class="flex flex-col items-center justify-center py-12">
                <div class="loading loading-spinner loading-lg text-blue-500 mb-3"></div>
                <p class="text-gray-500 text-sm">Loading players...</p>
            </div>

            <!-- Players List -->
            <div id="playersList" class="grid grid-cols-1 gap-3 p-4">
                <!-- Players will be populated here -->
            </div>
        </div>

    </div>
</div>

<!-- Message Selected Players Button -->
<div id="messageButtonContainer" class="fixed bottom-0 left-0 right-0 w-full p-4 bg-white border-t border-gray-200 shadow-lg z-50" style="display: none;">
    <div class="flex justify-center">
        <button id="messageSelectedBtn" class="px-6 py-3 rounded-lg shadow-xl focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200 flex items-center gap-2 text-sm font-semibold" 
                style="background-color: #16a34a !important; color: white !important; border: none !important;"
                onmouseover="this.style.backgroundColor='#15803d !important'"
                onmouseout="this.style.backgroundColor='#16a34a !important'">
            <i class="fas fa-sms text-lg"></i>
            <span>Message <span id="selectedCount">0</span> Selected Players</span>
        </button>
    </div>
</div>

<!-- Modal for Selected Players -->
<div id="selectedPlayersModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden shadow-xl">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-100">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Message Selected Players</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6 overflow-y-auto max-h-96">
            <div id="selectedPlayersList" class="space-y-3">
                <!-- Selected players will be populated here -->
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div id="smsLinkContainer" class="text-center">
                <!-- SMS link will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Add to Group Modal -->
<div id="addToGroupModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-md w-full max-h-[80vh] overflow-hidden shadow-xl">
        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-100" style="background-color: #085454;">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold text-white">Add to Pickup Game</h3>
                <button id="closeGroupModal" class="text-white hover:text-gray-300 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Modal Body -->
        <div class="p-6">
            <div id="selectedPlayerInfo" class="mb-4 p-3 bg-gray-50 rounded-lg">
                <!-- Selected player info will be populated here -->
            </div>
            
            <div id="groupsLoading" class="text-center py-4 hidden">
                <div class="loading loading-spinner loading-md text-blue-500 mb-2"></div>
                <p class="text-gray-500 text-sm">Loading your pickup games...</p>
            </div>
            
            <div id="groupsList" class="space-y-3">
                <!-- User's groups will be populated here -->
            </div>
            
            <div id="noGroupsMessage" class="text-center py-6 hidden">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-calendar text-gray-400 text-2xl"></i>
                </div>
                <p class="text-gray-600 text-sm mb-4">No pickup games available at the moment.</p>
                <a href="/mobile/pickup-games" class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    <i class="fas fa-plus"></i>
                    Create Pickup Game
                </a>
            </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="px-6 py-4 border-t border-gray-100 bg-gray-50">
            <div class="text-center">
                <a href="/mobile/pickup-games" class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">
                    <i class="fas fa-calendar-alt"></i>
                    View Pickup Games
                </a>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Custom button styling */
#applyFilters:hover {
    background-color: #064040 !important;
}

/* Grid responsive */
@media (max-width: 640px) {
    .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .sm\:grid-cols-4 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

@media (min-width: 640px) {
    .sm\:grid-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    .sm\:inline {
        display: inline;
    }
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.shadow-xl {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-600 { border-color: #4b5563; }
.border-blue-100 { border-color: #dbeafe; }
.border-yellow-200 { border-color: #fde047; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-white { background-color: #ffffff; }
.bg-green-100 { background-color: #dcfce7; }
.bg-yellow-100 { background-color: #fef3c7; }
.bg-red-100 { background-color: #fee2e2; }
.bg-blue-50 { background-color: #eff6ff; }
.bg-blue-100 { background-color: #dbeafe; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-gray-500 { background-color: #6b7280; }
.bg-purple-600 { background-color: #9333ea !important; }

/* Blue color utilities */
.text-blue-600 { color: #2563eb; }
.border-blue-300 { border-color: #93c5fd; }

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-gray-400 { color: #9ca3af; }
.text-green-500 { color: #10b981; }
.text-green-600 { color: #059669; }
.text-green-700 { color: #047857; }
.text-yellow-600 { color: #d97706; }
.text-yellow-700 { color: #b45309; }
.text-yellow-800 { color: #92400e; }
.text-red-700 { color: #b91c1c; }
.text-blue-500 { color: #3b82f6; }
.text-blue-600 { color: #2563eb; }
.text-blue-700 { color: #1d4ed8; }
.text-white { color: #ffffff; }

/* Gradient backgrounds */
.bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}
.from-green-500 {
    --tw-gradient-from: #10b981;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(16, 185, 129, 0));
}
.to-green-600 {
    --tw-gradient-to: #059669;
}

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-4 > * + * { margin-top: 1rem; }
.space-y-3 > * + * { margin-top: 0.75rem; }

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }

/* Text utilities */
.uppercase { text-transform: uppercase; }
.tracking-wide { letter-spacing: 0.025em; }
.truncate { 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }
.min-w-0 { min-width: 0px; }

/* Divide utilities */
.divide-y > :not([hidden]) ~ :not([hidden]) {
    border-top-width: 1px;
    border-color: #f9fafb;
}

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.duration-150 {
    transition-duration: 150ms;
}

.duration-200 {
    transition-duration: 200ms;
}

/* Custom slider styles */
.slider {
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    background: #e5e7eb;
    outline: none;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.slider:hover {
    background: #d1d5db;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3b82f6;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3b82f6;
    cursor: pointer;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-moz-range-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

/* Responsive design */
@media (max-width: 640px) {
    .px-6 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
}

/* Loading spinner */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
}

.loading-lg {
    width: 2.5rem;
    height: 2.5rem;
}

.loading-spinner {
    animation: spin 1s linear infinite;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Hide elements */
.hidden {
    display: none;
}

/* Checkbox styles */
input[type="checkbox"]:checked {
    background-color: #2563eb;
    border-color: #2563eb;
}

/* Additional gradient backgrounds */
.from-green-50 {
    --tw-gradient-from: #f0fdf4;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(240, 253, 244, 0));
}

.to-emerald-50 {
    --tw-gradient-to: #ecfdf5;
}

/* Custom extra small text for player stats */
.text-xxs {
    font-size: 11px;
    line-height: 1.3;
}

/* Player card styling for consistent grid layout */
.player-card {
    display: flex;
    flex-direction: column;
}

/* Better responsive grid */
@media (min-width: 768px) {
    #playersList {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

@media (min-width: 1024px) {
    #playersList {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
}

@media (min-width: 1280px) {
    #playersList {
        grid-template-columns: repeat(4, minmax(0, 1fr));
    }
}

/* Animate pulse utility */
@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
    }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Global variables
    let allPlayers = [];
    let availableSeries = [];
    let ptiRange = { min: -30, max: 100 };  // Default minimum PTI set to -30
    let selectedPlayers = new Set(); // Track selected player names
    
    // UI Elements
    const loadingDiv = document.getElementById('playersLoading');
    const playersList = document.getElementById('playersList');
    const seriesFilter = document.getElementById('seriesFilter');
    const firstNameFilter = document.getElementById('firstNameFilter');
    const lastNameFilter = document.getElementById('lastNameFilter');
    const ptiMinSlider = document.getElementById('ptiMinSlider');
    const ptiMaxSlider = document.getElementById('ptiMaxSlider');
    const ptiMinValue = document.getElementById('ptiMinValue');
    const ptiMaxValue = document.getElementById('ptiMaxValue');
    const ptiRangeDisplay = document.getElementById('ptiRangeDisplay');
    const clubOnlyFilter = document.getElementById('clubOnlyFilter');
    const clubOnlyLabel = document.getElementById('clubOnlyLabel');
    const clubFilterStatus = document.getElementById('clubFilterStatus');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    // Advanced Search Elements
    const advancedSearchToggle = document.getElementById('advancedSearchToggle');
    const advancedFiltersSection = document.getElementById('advancedFiltersSection');
    const advancedSearchText = document.getElementById('advancedSearchText');
    const advancedSearchIcon = document.getElementById('advancedSearchIcon');
    
    // Selection UI Elements
    const messageButtonContainer = document.getElementById('messageButtonContainer');
    const messageSelectedBtn = document.getElementById('messageSelectedBtn');
    const selectedCount = document.getElementById('selectedCount');
    const selectedPlayersModal = document.getElementById('selectedPlayersModal');
    const closeModal = document.getElementById('closeModal');
    const selectedPlayersList = document.getElementById('selectedPlayersList');
    const smsLinkContainer = document.getElementById('smsLinkContainer');

    // Initialize page
    async function initializePage() {
        try {
            await loadInitialData();
            setupEventListeners();
            
            // Check for URL parameters and auto-populate form
            handleURLParameters();
            
            // Don't load players initially - wait for user to search/filter
            showLoading(false);
        } catch (error) {
            console.error('Error initializing page:', error);
            showError('Failed to load page data');
        }
    }
    
    // Handle URL parameters for auto-search
    function handleURLParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const firstName = urlParams.get('first_name');
        const lastName = urlParams.get('last_name');
        const series = urlParams.get('series');
        const clubOnly = urlParams.get('club_only');
        
        // Populate form fields if parameters exist
        if (firstName) {
            firstNameFilter.value = firstName;
        }
        if (lastName) {
            lastNameFilter.value = lastName;
        }
        if (series) {
            seriesFilter.value = series;
        }
        if (clubOnly === 'true') {
            clubOnlyFilter.checked = true;
            clubFilterStatus.style.display = 'flex';
        }
        
        // Auto-execute search if any parameters are provided
        if (firstName || lastName || series || clubOnly === 'true') {
            console.log('Auto-executing search with URL parameters');
            loadPlayers();
        }
    }

    // Load initial data (available series and PTI range) - no filter criteria required
    async function loadInitialData() {
        const response = await fetch('/api/club-players-metadata');
        if (!response.ok) throw new Error('Failed to fetch initial data');
        
        const data = await response.json();
        availableSeries = data.available_series || [];

        // Sort series numerically by their number (not lexicographically),
        // e.g., Chicago 1, Chicago 2, ..., Chicago 10, Chicago 11, ...
        try {
            const parseSeries = (s) => {
                const match = String(s).match(/(\d+)/);
                const num = match ? parseInt(match[1], 10) : Number.MAX_SAFE_INTEGER;
                const isSW = /\bSW\b/i.test(String(s));
                return { num, isSW, label: String(s) };
            };
            availableSeries.sort((a, b) => {
                const pa = parseSeries(a);
                const pb = parseSeries(b);
                if (pa.num !== pb.num) return pa.num - pb.num;
                // Place base series before SW variant for the same number
                if (pa.isSW !== pb.isSW) return pa.isSW ? 1 : -1;
                return String(pa.label).localeCompare(String(pb.label));
            });
        } catch (e) {
            console.warn('Series sort failed, keeping original order', e);
        }
        ptiRange = data.pti_range || { min: -30, max: 100 };
        const ptiFiltersAvailable = data.pti_filters_available || false;
        const userClub = data.user_club || 'My Club';
        
        console.log('PTI filters available:', ptiFiltersAvailable);
        console.log('PTI range:', ptiRange);
        
        // Populate series dropdown
        seriesFilter.innerHTML = '<option value="">All Series</option>';
        availableSeries.forEach(series => {
            const option = document.createElement('option');
            option.value = series;
            option.textContent = series;
            seriesFilter.appendChild(option);
        });
        
        // Update club name in checkbox label
        clubOnlyLabel.textContent = userClub;
        
        // Show/hide PTI filters based on availability
        const ptiFiltersSection = document.getElementById('ptiFiltersSection');
        if (ptiFiltersAvailable) {
            ptiFiltersSection.style.display = 'block';
            // Set up PTI sliders
            setupPTISliders();
            console.log('PTI sliders set up');
        } else {
            ptiFiltersSection.style.display = 'none';
            console.log('PTI filters hidden - no valid PTI data available for this league');
        }
    }

    // Setup PTI slider fields
    function setupPTISliders() {
        // Always use -30 as minimum PTI regardless of database values
        const minPTI = -30;
        const maxPTI = ptiRange.max;
        
        ptiMinSlider.value = minPTI;
        ptiMaxSlider.value = maxPTI;
        ptiMinSlider.min = minPTI;
        ptiMinSlider.max = maxPTI;
        ptiMaxSlider.min = minPTI;
        ptiMaxSlider.max = maxPTI;
        ptiMinValue.textContent = minPTI;
        ptiMaxValue.textContent = maxPTI;
        ptiRangeDisplay.textContent = `${minPTI} - ${maxPTI}`;
        
        // Update ptiRange to reflect the override
        ptiRange.min = minPTI;
    }

    // Setup event listeners
    function setupEventListeners() {
        // Filter events
        applyFiltersBtn.addEventListener('click', loadPlayers);
        resetFiltersBtn.addEventListener('click', resetFilters);
        
        // Club filter toggle event
        clubOnlyFilter.addEventListener('change', updateClubFilterStatus);
        
        // Auto-apply on Enter key for text inputs
        firstNameFilter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loadPlayers();
        });
        lastNameFilter.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') loadPlayers();
        });
        
        // FIXED: Always set up PTI slider events regardless of visibility
        // PTI slider events with real-time value updates
        if (ptiMinSlider && ptiMaxSlider) {
            console.log('Setting up PTI slider event listeners');
            ptiMinSlider.addEventListener('input', function() {
                let minVal = parseFloat(this.value);
                let maxVal = parseFloat(ptiMaxSlider.value);
                
                // Ensure min doesn't exceed max
                if (minVal > maxVal) {
                    minVal = maxVal;
                    this.value = minVal;
                }
                
                ptiMinValue.textContent = minVal.toFixed(1);
                // FIXED: Update the range display
                ptiRangeDisplay.textContent = `${minVal.toFixed(1)} - ${maxVal.toFixed(1)}`;
                console.log('PTI min slider changed to:', minVal);
            });
            
            ptiMaxSlider.addEventListener('input', function() {
                let maxVal = parseFloat(this.value);
                let minVal = parseFloat(ptiMinSlider.value);
                
                // Ensure max doesn't go below min
                if (maxVal < minVal) {
                    maxVal = minVal;
                    this.value = maxVal;
                }
                
                ptiMaxValue.textContent = maxVal.toFixed(1);
                // FIXED: Update the range display
                ptiRangeDisplay.textContent = `${minVal.toFixed(1)} - ${maxVal.toFixed(1)}`;
                console.log('PTI max slider changed to:', maxVal);
            });
            
            console.log('PTI slider event listeners attached successfully');
        } else {
            console.error('PTI slider elements not found');
        }
        
        // Advanced Search Toggle
        advancedSearchToggle.addEventListener('click', function() {
            const isVisible = advancedFiltersSection.style.display !== 'none';
            
            if (isVisible) {
                // Hide advanced filters
                advancedFiltersSection.style.display = 'none';
                advancedSearchText.textContent = 'Advanced Search';
                advancedSearchIcon.className = 'fas fa-chevron-down ml-2';
            } else {
                // Show advanced filters
                advancedFiltersSection.style.display = 'block';
                advancedSearchText.textContent = 'Hide Advanced';
                advancedSearchIcon.className = 'fas fa-chevron-up ml-2';
            }
        });
        
        // Club filter status toggle
        clubOnlyFilter.addEventListener('change', function() {
            if (this.checked) {
                clubFilterStatus.style.display = 'flex';
            } else {
                clubFilterStatus.style.display = 'none';
            }
        });

        // Selection events
        messageSelectedBtn.addEventListener('click', showSelectedPlayersModal);
        closeModal.addEventListener('click', hideSelectedPlayersModal);
        
        // Group modal events
        const closeGroupModal = document.getElementById('closeGroupModal');
        const addToGroupModal = document.getElementById('addToGroupModal');
        
        closeGroupModal.addEventListener('click', hideAddToGroupModal);
        
        // Close modal when clicking outside
        selectedPlayersModal.addEventListener('click', function(e) {
            if (e.target === selectedPlayersModal) {
                hideSelectedPlayersModal();
            }
        });
        
        // Close group modal when clicking outside
        addToGroupModal.addEventListener('click', function(e) {
            if (e.target === addToGroupModal) {
                hideAddToGroupModal();
            }
        });
    }

    // Load and display players
    async function loadPlayers() {
        try {
            showLoading(true);
            
            // Validate that at least one filter criteria is provided
            const hasNameFilter = firstNameFilter.value.trim() || lastNameFilter.value.trim();
            const hasSeriesFilter = seriesFilter.value;
            
            // Check if advanced filters are visible and PTI filter is applied
            const advancedVisible = advancedFiltersSection.style.display !== 'none';
            const hasPtiFilter = advancedVisible && 
                                (parseFloat(ptiMinSlider.value) > ptiRange.min || parseFloat(ptiMaxSlider.value) < ptiRange.max);
            
            if (!hasNameFilter && !hasSeriesFilter && !hasPtiFilter) {
                showError('Please enter at least one search criteria (name, series, or PTI range)');
                // Don't show Players section for validation errors
                return;
            }
            
            // Show the Players section when search begins
            const playersCard = document.getElementById('playersCard');
            playersCard.style.display = 'block';
            
            // Build query parameters
            const params = new URLSearchParams();
            
            if (seriesFilter.value) params.append('series', seriesFilter.value);
            if (firstNameFilter.value.trim()) params.append('first_name', firstNameFilter.value.trim());
            if (lastNameFilter.value.trim()) params.append('last_name', lastNameFilter.value.trim());
            
            // Add club filter parameter
            params.append('club_only', clubOnlyFilter.checked);
            
            // Only add PTI filters if advanced filters are visible and values are changed from defaults
            if (advancedVisible) {
                const ptiMin = parseFloat(ptiMinSlider.value);
                const ptiMax = parseFloat(ptiMaxSlider.value);
                if (!isNaN(ptiMin) && ptiMin > ptiRange.min) params.append('pti_min', ptiMin);
                if (!isNaN(ptiMax) && ptiMax < ptiRange.max) params.append('pti_max', ptiMax);
            }
            
            const response = await fetch('/api/club-players?' + params.toString());
            if (!response.ok) throw new Error('Failed to fetch players');
            
            const data = await response.json();
            
            // Handle the case where backend requires filter criteria
            if (data.message) {
                showError(data.message);
                return;
            }
            
            allPlayers = data.players || [];

            // Render and then scroll to the correct position (below filters)
            displayPlayers(allPlayers, true);
            showLoading(false);
            
        } catch (error) {
            console.error('Error loading players:', error);
            showError('Failed to load players');
        }
    }

    // Display players
    function displayPlayers(players, shouldScroll = false) {
        playersList.innerHTML = '';
        
        if (players.length === 0) {
            playersList.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-12 px-6">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-friends text-gray-400 text-2xl"></i>
                    </div>
                    <p class="text-gray-500 text-center text-sm">
                        No players found matching your criteria
                    </p>
                </div>
            `;
            updateSelectionUI();
            return;
        }
        
        players.forEach(player => {
            const card = createPlayerCard(player);
            playersList.appendChild(card);
        });
        
        updateSelectionUI();

        if (shouldScroll) {
            robustScrollToResults();
        }
    }

    // Robust scroll that waits for layout to settle, then scrolls below filters
    function robustScrollToResults() {
        const doScroll = () => {
            const filters = document.getElementById('filtersCard');
            const card = document.getElementById('playersCard');
            let targetY = 0;
            if (filters) {
                const rect = filters.getBoundingClientRect();
                targetY = rect.bottom + window.pageYOffset - 23; // 15px less than previous (-8 -> -23)
            } else if (card) {
                const rect2 = card.getBoundingClientRect();
                targetY = rect2.top + window.pageYOffset - 43; // 15px less than previous (-28 -> -43)
            } else {
                return; // nothing to do
            }
            window.scrollTo({ top: targetY, behavior: 'smooth' });
            // Safety adjust after animation starts (handles async image/fonts/layout shifts)
            setTimeout(() => {
                window.scrollTo({ top: targetY, behavior: 'smooth' });
            }, 350);
        };
        // Two RAFs ensure DOM updates and styles are flushed
        requestAnimationFrame(() => requestAnimationFrame(doScroll));
    }

    // Handle contact button click
    window.handleContactClick = function(playerName) {
        console.log('Contact button clicked for player:', playerName);
        const nameParts = playerName.split(' ');
        const firstName = nameParts[0] || 'Unknown';
        const lastName = nameParts.slice(1).join(' ') || 'Unknown';
        console.log('Parsed name:', firstName, lastName);
        window.location.href = `/contact-sub?first=${encodeURIComponent(firstName)}&last=${encodeURIComponent(lastName)}`;
    };

    // Handle Add to Text Group button click - Updated with Modal functionality v2.0
    window.handleAddToGroupClick = function(playerName) {
        console.log('Add to Text Group button clicked for player (MODAL VERSION):', playerName);
        const nameParts = playerName.split(' ');
        const firstName = nameParts[0] || 'Unknown';
        const lastName = nameParts.slice(1).join(' ') || 'Unknown';
        console.log('Parsed name:', firstName, lastName);
        
        // Show the group selection modal (NEW FUNCTIONALITY)
        showAddToGroupModal(playerName, firstName, lastName);
    };

    // Show Add to Group Modal
    async function showAddToGroupModal(playerName, firstName, lastName) {
        const modal = document.getElementById('addToGroupModal');
        const selectedPlayerInfo = document.getElementById('selectedPlayerInfo');
        const groupsLoading = document.getElementById('groupsLoading');
        const groupsList = document.getElementById('groupsList');
        const noGroupsMessage = document.getElementById('noGroupsMessage');
        
        // Store player info for later use
        window.currentSelectedPlayer = { name: playerName, firstName, lastName };
        window.selectedGroupForAdding = null;
        
        // Show player info
        selectedPlayerInfo.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-blue-600"></i>
                </div>
                <div>
                    <div class="font-semibold text-gray-900">${playerName}</div>
                    <div class="text-sm text-gray-600">Select a pickup game to add ${firstName} ${lastName}</div>
                </div>
            </div>
        `;
        
        // Show modal and loading state
        modal.classList.remove('hidden');
        groupsLoading.classList.remove('hidden');
        groupsList.innerHTML = '';
        noGroupsMessage.classList.add('hidden');
        

        
        try {
            // Load user's pickup games (both public and private) and groups
            const [publicResponse, privateResponse, groupsResponse] = await Promise.all([
                fetch('/api/pickup-games?type=public'),
                fetch('/api/pickup-games?type=private'),
                fetch('/api/groups')
            ]);
            
            if (!publicResponse.ok || !privateResponse.ok || !groupsResponse.ok) {
                throw new Error('Failed to fetch data');
            }
            
            const publicData = await publicResponse.json();
            const privateData = await privateResponse.json();
            const groupsData = await groupsResponse.json();
            
            const publicGames = [...(publicData.upcoming_games || []), ...(publicData.past_games || [])];
            const privateGames = [...(privateData.upcoming_games || []), ...(privateData.past_games || [])];
            const groups = groupsData.groups || [];
            
            groupsLoading.classList.add('hidden');
            
            if (publicGames.length === 0 && privateGames.length === 0 && groups.length === 0) {
                noGroupsMessage.classList.remove('hidden');
                return;
            }
            
            // Create sections for public games, private games, and groups
            let sectionsHTML = '';
            
            if (publicGames.length > 0) {
                sectionsHTML += `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-globe mr-2 text-blue-500"></i>
                            Public Pickup Games
                        </h4>
                        <div class="space-y-2">
                `;
                
                publicGames.forEach(game => {
                    const gameDate = new Date(game.date).toLocaleDateString();
                    const gameTime = game.formatted_time || game.time;
                    
                    sectionsHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-300 hover:shadow-sm transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${game.description}</div>
                                    <div class="text-sm text-gray-600">${gameDate} at ${gameTime}</div>
                                    <div class="text-xs text-gray-500">${game.slots_filled}/${game.players_requested} players</div>
                                </div>
                                <button class="add-to-pickup-btn px-4 py-2 text-white rounded-lg font-semibold text-sm hover:opacity-90 transition-colors duration-200" 
                                        style="background-color: #085454;"
                                        data-game-id="${game.id}" data-game-name="${game.description}" data-type="pickup">
                                    Add
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                sectionsHTML += `
                        </div>
                    </div>
                `;
            }
            
            if (privateGames.length > 0) {
                sectionsHTML += `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-lock mr-2 text-green-500"></i>
                            Private Pickup Games
                        </h4>
                        <div class="space-y-2">
                `;
                
                privateGames.forEach(game => {
                    const gameDate = new Date(game.date).toLocaleDateString();
                    const gameTime = game.formatted_time || game.time;
                    
                    sectionsHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-300 hover:shadow-sm transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${game.description}</div>
                                    <div class="text-sm text-gray-600">${gameDate} at ${gameTime}</div>
                                    <div class="text-xs text-gray-500">${game.slots_filled}/${game.players_requested} players</div>
                                </div>
                                <button class="add-to-pickup-btn px-4 py-2 text-white rounded-lg font-semibold text-sm hover:opacity-90 transition-colors duration-200" 
                                        style="background-color: #085454;"
                                        data-game-id="${game.id}" data-game-name="${game.description}" data-type="pickup">
                                    Add
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                sectionsHTML += `
                        </div>
                    </div>
                `;
            }
            
            if (groups.length > 0) {
                sectionsHTML += `
                    <div class="mb-4">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-users mr-2" style="color: #085454;"></i>
                            My Private Groups
                        </h4>
                        <div class="space-y-2">
                `;
                
                groups.forEach(group => {
                    sectionsHTML += `
                        <div class="bg-white border border-gray-200 rounded-lg p-3 hover:border-blue-300 hover:shadow-sm transition-all duration-200">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-900">${group.name}</div>
                                    <div class="text-sm text-gray-600">${group.member_count} members</div>
                                    ${group.description ? `<div class="text-xs text-gray-500 mt-1">${group.description}</div>` : ''}
                                </div>
                                <button class="add-to-group-btn px-4 py-2 text-white rounded-lg font-semibold text-sm hover:opacity-90 transition-colors duration-200" 
                                        style="background-color: #085454;"
                                        data-group-id="${group.id}" data-group-name="${group.name}" data-type="group">
                                    Add
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                sectionsHTML += `
                        </div>
                    </div>
                `;
            }
            
            groupsList.innerHTML = sectionsHTML;
            
            // Add click handlers to all Add buttons
            document.querySelectorAll('.add-to-pickup-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const gameId = button.dataset.gameId;
                    const gameName = button.dataset.gameName;
                    await addPlayerToPickupGame(gameId, gameName, button);
                });
            });
            
            document.querySelectorAll('.add-to-group-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const groupId = button.dataset.groupId;
                    const groupName = button.dataset.groupName;
                    await addPlayerToGroup(groupId, groupName, button);
                });
            });
            
        } catch (error) {
            console.error('Error loading pickup games:', error);
            groupsLoading.classList.add('hidden');
            groupsList.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-red-600 mb-2">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <p class="text-red-600 text-sm">Failed to load pickup games. Please try again.</p>
                </div>
            `;
        }
    }
    

    
    // Add player to pickup game
    async function addPlayerToPickupGame(gameId, gameName, buttonElement) {
        const { name: playerName, firstName, lastName } = window.currentSelectedPlayer;
        
        try {
            // Show loading state on button
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
            buttonElement.disabled = true;
            
            // Make API call to add player to pickup game
            const response = await fetch(`/api/pickup-games/${gameId}/add-player`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    player_name: playerName,
                    first_name: firstName,
                    last_name: lastName
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Show success state on button
                buttonElement.innerHTML = '<i class="fas fa-check mr-1"></i>Added!';
                buttonElement.style.backgroundColor = '#16a34a';
                
                showGroupSuccessMessage(`${playerName} has been added to<br>"${gameName}"!`);
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                    buttonElement.style.backgroundColor = '#085454';
                    buttonElement.disabled = false;
                }, 2000);
            } else {
                // Handle error from API
                const errorMessage = data.error || 'Failed to add player to pickup game';
                console.error('API Error:', errorMessage);
                buttonElement.innerHTML = originalText;
                buttonElement.disabled = false;
                showGroupErrorMessage(errorMessage);
            }
            
        } catch (error) {
            console.error('Error adding player to pickup game:', error);
            buttonElement.innerHTML = originalText;
            buttonElement.disabled = false;
            showGroupErrorMessage('Failed to add player to pickup game. Please try again.');
        }
    }

    // Add player to selected group
    async function addPlayerToGroup(groupId, groupName, buttonElement) {
        const { name: playerName, firstName, lastName } = window.currentSelectedPlayer;
        
        try {
            // Show loading state on button
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Adding...';
            buttonElement.disabled = true;
            
            // Find the player by name to get their user ID
            const searchResponse = await fetch(`/api/groups/search-players?q=${encodeURIComponent(playerName)}`);
            if (!searchResponse.ok) throw new Error('Failed to search for player');
            
            const searchData = await searchResponse.json();
            const matchedPlayers = searchData.players || [];
            
            // Find exact match
            const exactMatch = matchedPlayers.find(player => 
                player.full_name.toLowerCase() === playerName.toLowerCase()
            );
            
            if (!exactMatch) {
                throw new Error('Player not found in the system');
            }
            
            // Prepare request data based on whether player has an account
            let requestData;
            if (exactMatch.user_id) {
                // Player has a registered account
                requestData = {
                    user_id: exactMatch.user_id
                };
            } else {
                // Player exists but no account - use no_account flow
                requestData = {
                    tenniscores_player_id: exactMatch.tenniscores_player_id,
                    first_name: exactMatch.first_name,
                    last_name: exactMatch.last_name,
                    no_account: true
                };
            }
            
            // Add player to group
            const addResponse = await fetch(`/api/groups/${groupId}/members`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            if (!addResponse.ok) {
                const errorData = await addResponse.json();
                throw new Error(errorData.error || 'Failed to add player to group');
            }
            
            const result = await addResponse.json();
            
            // Show success state on button
            buttonElement.innerHTML = '<i class="fas fa-check mr-1"></i>Added!';
            buttonElement.style.backgroundColor = '#16a34a';
            
            // Show success message - customize based on whether player has account
            let successMessage;
            if (exactMatch.user_id) {
                successMessage = `${playerName} has been added to ${groupName}!`;
            } else {
                successMessage = `${playerName} has been added to ${groupName}! They'll be able to receive group messages when they create a Rally account.`;
            }
            showGroupSuccessMessage(successMessage);
            
            // Reset button after 2 seconds
            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.style.backgroundColor = '#085454';
                buttonElement.disabled = false;
            }, 2000);
            
        } catch (error) {
            console.error('Error adding player to group:', error);
            buttonElement.innerHTML = originalText;
            buttonElement.disabled = false;
            showGroupErrorMessage(error.message);
        }
    }
    
    // Hide Add to Group Modal
    function hideAddToGroupModal() {
        const modal = document.getElementById('addToGroupModal');
        modal.classList.add('hidden');
        window.currentSelectedPlayer = null;
        window.selectedGroupForAdding = null;
    }
    
    // Show success message in group modal
    function showGroupSuccessMessage(message) {
        const groupsList = document.getElementById('groupsList');
        groupsList.innerHTML = `
            <div class="text-center py-6">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-green-600 text-2xl"></i>
                </div>
                <p class="text-green-600 text-sm font-medium">${message}</p>
            </div>
        `;
    }
    
    // Show error message in group modal
    function showGroupErrorMessage(message) {
        const groupsList = document.getElementById('groupsList');
        groupsList.innerHTML = `
            <div class="text-center py-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
                <p class="text-red-600 text-sm font-medium">${message}</p>
            </div>
        `;
    }

    // Create player card with checkbox
    function createPlayerCard(player) {
        console.log('Creating player card for:', player); // Debug log
        console.log(`PTI value for ${player.name}: "${player.pti}" (type: ${typeof player.pti})`);
        
        const card = document.createElement('div');
        card.className = 'player-card bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:shadow-md transition-shadow duration-200';
        
        const isSelected = selectedPlayers.has(player.name);
        
        // Determine win rate color
        const winRateNum = parseFloat(player.winRate.replace('%', ''));
        let winRateColor = 'text-gray-600';
        if (winRateNum >= 60) {
            winRateColor = 'text-green-600';
        } else if (winRateNum >= 45) {
            winRateColor = 'text-yellow-600';
        } else if (winRateNum > 0) {
            winRateColor = 'text-red-600';
        }
        
        card.innerHTML = `
            <!-- Header with Player Name -->
            <div style="background-color: #045454;" class="px-4 py-2 border-b border-gray-600 flex items-center gap-3 rounded-t-lg">
                <!-- Checkbox (Hidden) -->
                <input type="checkbox" id="player-${player.name.replace(/\s+/g, '-')}" 
                       class="player-checkbox w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2" 
                       data-player-name="${player.name}" ${isSelected ? 'checked' : ''}
                       style="display: none;">
                
                <!-- Player Name -->
                <h3 class="font-bold text-base leading-tight" style="color: #bff863;">${player.name}</h3>
            </div>
            
            <!-- Body with Player Info -->
            <div class="p-4 flex gap-4">
                <!-- Left Column: Player Details -->
                <div class="flex-1 min-w-0">
                    <!-- PTI (most prominent) -->
                    ${(player.pti !== null && player.pti !== undefined && player.pti !== 'N/A' && player.pti !== '' && !isNaN(parseFloat(player.pti))) ? `
                        <div class="font-bold text-base mb-2" style="color: #045454;">PTI: ${player.pti}</div>
                    ` : ''}
                    
                    <!-- Club and Series -->
                    <p class="text-sm text-gray-600 mb-2">${player.club || 'Unknown Club'}</p>
                    <span class="text-sm font-semibold mb-3 inline-block" style="background-color: #045454; color: #bff863; padding: 4px 12px; border-radius: 16px;">${player.series ? player.series.replace(/^Chicago\\s+(\\d+.*)$/i, 'Series $1') : player.series}</span>
                    
                    <!-- Stats -->
                    <div class="text-sm space-y-1">
                        <div>
                            <span class="text-gray-600">Record:</span> 
                            <span class="text-gray-900 font-medium">${player.wins}W-${player.losses}L</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Win Rate:</span> 
                            <span class="font-medium ${winRateColor}">${player.winRate}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Action Buttons -->
                <div class="flex flex-col justify-center space-y-3" style="width: 138px;">
                    <button class="details-btn w-full" 
                            onclick="handleViewStatsClick('${player.playerId}')"
                            style="
                                background-color: #045454 !important; 
                                color: #bff863 !important; 
                                padding: 12px 16px !important; 
                                border-radius: 8px !important; 
                                font-size: 14px !important; 
                                font-weight: 600 !important; 
                                border: none !important; 
                                cursor: pointer !important;
                                display: block !important;
                                visibility: visible !important;
                                min-height: 44px !important;
                            ">
                        View Stats
                    </button>
                    <button class="contact-btn w-full" 
                            onclick="handleContactClick('${player.name}')"
                            style="
                                background-color: #bff863 !important; 
                                color: #045454 !important; 
                                padding: 12px 16px !important; 
                                border-radius: 8px !important; 
                                font-size: 14px !important; 
                                font-weight: 600 !important; 
                                border: none !important; 
                                cursor: pointer !important;
                                display: block !important;
                                visibility: visible !important;
                                min-height: 44px !important;
                            ">
                        Contact
                    </button>
                    <button class="add-to-group-btn w-full" 
                            onclick="handleAddToGroupClick('${player.name}')"
                            style="
                                background-color: #15803d !important; 
                                color: white !important; 
                                padding: 12px 16px !important; 
                                border-radius: 8px !important; 
                                font-size: 14px !important; 
                                font-weight: 600 !important; 
                                border: none !important; 
                                cursor: pointer !important;
                                display: none !important;
                                visibility: hidden !important;
                                min-height: 44px !important;
                            ">
                        Add to Pickup Game
                    </button>
                </div>
            </div>
        `;
        
        // Contact button functionality is handled inline
        
        // Add checkbox functionality
        const checkbox = card.querySelector('.player-checkbox');
        checkbox.addEventListener('change', function() {
            const playerName = this.dataset.playerName;
            if (this.checked) {
                selectedPlayers.add(playerName);
            } else {
                selectedPlayers.delete(playerName);
            }
            updateSelectionUI();
        });
        
        return card;
    }

    // Update selection UI
    function updateSelectionUI() {
        const count = selectedPlayers.size;
        selectedCount.textContent = count;
        
        console.log(`Updating selection UI: ${count} players selected`);
        
        if (count > 0) {
            messageButtonContainer.style.display = 'block';
            console.log('Message button container should be visible');
        } else {
            messageButtonContainer.style.display = 'none';
            console.log('Message button container should be hidden');
        }
        
        // Force a reflow to ensure styles are applied
        messageButtonContainer.offsetHeight;
    }

    // Show selected players modal
    function showSelectedPlayersModal() {
        const selectedPlayersData = allPlayers.filter(player => selectedPlayers.has(player.name));
        
        // Populate selected players list
        selectedPlayersList.innerHTML = '';
        selectedPlayersData.forEach(player => {
            const playerElement = document.createElement('div');
            playerElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
            playerElement.innerHTML = `
                <div>
                    <div class="font-semibold text-gray-800">${player.name}</div>
                    <div class="text-sm text-gray-600 font-medium">${player.club || 'Unknown Club'}</div>
                    <div class="text-sm text-gray-500">${player.series ? player.series.replace(/^Chicago\\s+(\\d+.*)$/i, 'Series $1') : player.series}</div>
                </div>
                <div class="text-sm text-blue-600 font-mono">${player.phone || 'No phone available'}</div>
            `;
            selectedPlayersList.appendChild(playerElement);
        });
        
        // Create messaging options based on number of players with phones
        const playersWithPhones = selectedPlayersData.filter(player => player.phone && player.phone.trim());
        
        if (playersWithPhones.length === 0) {
            smsLinkContainer.innerHTML = '<p class="text-gray-500">No phone numbers available for selected players</p>';
        } else if (playersWithPhones.length === 1) {
            // Single player - use direct SMS link
            const player = playersWithPhones[0];
            let cleanNumber = player.phone.replace(/[^\d+]/g, '');
            if (!cleanNumber.startsWith('+')) {
                cleanNumber = '+1' + cleanNumber;
            }
            
            smsLinkContainer.innerHTML = `
                <a href="sms:${cleanNumber}" 
                   class="inline-flex items-center justify-center gap-2 w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">
                    <i class="fas fa-sms"></i>
                    Text ${player.name}
                </a>
            `;
        } else {
            // Multiple players - provide options for different platforms
            const cleanedNumbers = playersWithPhones.map(player => {
                let cleanNumber = player.phone.replace(/[^\d+]/g, '');
                if (!cleanNumber.startsWith('+')) {
                    cleanNumber = '+1' + cleanNumber;
                }
                return cleanNumber;
            });
            
            const phoneNumbers = cleanedNumbers.join(',');
            // Format for iOS - use line breaks instead of commas for better iOS compatibility
            const displayNumbers = playersWithPhones.map(p => p.phone).join('\n');
            
            console.log('SMS numbers:', phoneNumbers); // Debug log
            
            smsLinkContainer.innerHTML = `
                <div class="text-center">
                    <button id="copyPhoneBtn" data-phone-numbers="${displayNumbers.replace(/"/g, '&quot;')}" 
                            class="inline-flex items-center justify-center gap-2 w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">
                        <i class="fas fa-copy"></i>
                        Copy phone numbers to text message
                    </button>
                </div>
            `;
            
            // Add event listener for copy button after adding to DOM
            const copyBtn = smsLinkContainer.querySelector('#copyPhoneBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const phoneNumbers = this.getAttribute('data-phone-numbers');
                    copyPhoneNumbers(phoneNumbers);
                });
            }
        }
        
        selectedPlayersModal.classList.remove('hidden');
    }

    // Function to copy phone numbers to clipboard (iOS fallback)
    window.copyPhoneNumbers = function(phoneNumbers) {
        console.log('copyPhoneNumbers called with:', phoneNumbers);
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            console.log('Using modern clipboard API');
            navigator.clipboard.writeText(phoneNumbers).then(function() {
                console.log('Clipboard write successful');
                showCopyFeedback('Phone numbers copied! Open Messages, paste, then add each number manually.');
            }).catch(function(err) {
                console.error('Clipboard API failed:', err);
                fallbackCopyToClipboard(phoneNumbers);
            });
        } else {
            console.log('Using fallback clipboard method');
            // Fallback for older browsers
            fallbackCopyToClipboard(phoneNumbers);
        }
    };

    // Fallback copy method for older browsers or when clipboard API fails
    function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopyFeedback('Phone numbers copied! Open Messages, paste, then add each number manually.');
            } else {
                showCopyFeedback('Copy failed. Please manually copy the numbers.', true);
            }
        } catch (err) {
            console.error('Fallback copy failed:', err);
            showCopyFeedback('Copy failed. Please manually copy the numbers.', true);
        } finally {
            document.body.removeChild(textArea);
        }
    }

    // Show feedback message for copy operations
    function showCopyFeedback(message, isError = false) {
        console.log('showCopyFeedback called with:', message);
        
        // Remove any existing feedback
        const existingFeedback = document.getElementById('copy-feedback');
        if (existingFeedback) {
            existingFeedback.remove();
        }
        
        // Create feedback element
        const feedback = document.createElement('div');
        feedback.id = 'copy-feedback';
        feedback.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg text-sm font-medium transition-all duration-300 ${
            isError ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-green-100 text-green-800 border border-green-200'
        }`;
        feedback.style.zIndex = '9999';
        feedback.textContent = message;
        feedback.style.opacity = '0';
        feedback.style.transform = 'translate(-50%, -20px)';
        
        // Append to modal instead of body to ensure visibility
        const modal = document.getElementById('selectedPlayersModal');
        modal.appendChild(feedback);
        
        console.log('Feedback element added to modal');
        
        // Animate in
        setTimeout(() => {
            feedback.style.opacity = '1';
            feedback.style.transform = 'translate(-50%, 0)';
        }, 10);
        
        // Hide after 3 seconds
        setTimeout(() => {
            feedback.style.opacity = '0';
            feedback.style.transform = 'translate(-50%, -20px)';
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 300);
        }, 3000);
    }

    // Hide selected players modal
    function hideSelectedPlayersModal() {
        selectedPlayersModal.classList.add('hidden');
    }

    // Update club filter status indicator
    function updateClubFilterStatus() {
        const statusDiv = document.getElementById('clubFilterStatus');
        const statusText = statusDiv.querySelector('span');
        const statusDot = statusDiv.querySelector('div');
        
        if (clubOnlyFilter.checked) {
            statusText.textContent = 'Club filter is ON';
            statusText.className = 'text-sm font-semibold text-green-700';
            statusDot.className = 'w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse';
        } else {
            statusText.textContent = 'Club filter is OFF - showing all players';
            statusText.className = 'text-sm font-semibold text-blue-700';
            statusDot.className = 'w-3 h-3 bg-blue-500 rounded-full mr-2 animate-pulse';
        }
    }

    // Reset all filters
    function resetFilters() {
        seriesFilter.value = '';
        firstNameFilter.value = '';
        lastNameFilter.value = '';
        clubOnlyFilter.checked = false; // Reset to default unchecked state
        updateClubFilterStatus(); // Update status after reset
        
        // Only reset PTI filters if they are visible
        const ptiFiltersSection = document.getElementById('ptiFiltersSection');
        if (ptiFiltersSection.style.display !== 'none') {
            const minPTI = -30;  // Always reset to -30 minimum
            ptiMinSlider.value = minPTI;
            ptiMaxSlider.value = ptiRange.max;
            ptiMinValue.textContent = minPTI;
            ptiMaxValue.textContent = ptiRange.max;
        }
        
        // Hide the Players section
        const playersCard = document.getElementById('playersCard');
        playersCard.style.display = 'none';
        
        // Clear results
        playersList.innerHTML = '';
        updateSelectionUI();
    }

    // Show/hide loading indicator
    function showLoading(show) {
        if (show) {
            loadingDiv.style.display = 'flex';
            playersList.innerHTML = '';
        } else {
            loadingDiv.style.display = 'none';
        }
    }

    // Show error message
    function showError(message) {
        showLoading(false);
        playersList.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-12 px-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                </div>
                <p class="text-red-600 text-center text-sm font-medium">
                    ${message}
                </p>
            </div>
        `;
    }

    // Initialize the page
    initializePage();
    
    /**
     * Handle View Stats click with loading indicator
     */
    window.handleViewStatsClick = function(playerId) {
        // Show loading indicator
        if (typeof showLoadingIndicator === 'function') {
            showLoadingIndicator('Loading Player Stats...');
        }
        
        // Navigate to player detail page
        window.location.href = '/mobile/player-detail/' + encodeURIComponent(playerId);
    };
    
    // Debug function for testing button visibility (can be called from console)
    window.testMessageButton = function() {
        console.log('Testing message button...');
        console.log('Button container element:', messageButtonContainer);
        console.log('Current display style:', messageButtonContainer.style.display);
        console.log('Current computed style:', window.getComputedStyle(messageButtonContainer).display);
        console.log('Selected players count:', selectedPlayers.size);
        
        // Force show the button for testing
        messageButtonContainer.style.display = 'block';
        messageButtonContainer.style.zIndex = '9999';
        console.log('Button forced to show with z-index 9999');
    };
    
    // Debug function for testing PTI sliders (can be called from console)
    window.testPTISliders = function() {
        console.log('Testing PTI sliders...');
        console.log('PTI min slider element:', ptiMinSlider);
        console.log('PTI max slider element:', ptiMaxSlider);
        console.log('PTI min value element:', ptiMinValue);
        console.log('PTI max value element:', ptiMaxValue);
        console.log('PTI range display element:', ptiRangeDisplay);
        console.log('Current min value:', ptiMinSlider?.value);
        console.log('Current max value:', ptiMaxSlider?.value);
        console.log('Current range display:', ptiRangeDisplay?.textContent);
        console.log('PTI range:', ptiRange);
        
        // Test setting values
        if (ptiMinSlider && ptiMaxSlider) {
            console.log('Testing slider value changes...');
            ptiMinSlider.value = 20;
            ptiMaxSlider.value = 80;
            ptiMinSlider.dispatchEvent(new Event('input'));
            ptiMaxSlider.dispatchEvent(new Event('input'));
            console.log('Slider values changed to min: 20, max: 80');
            console.log('Range display should now show: 20.0 - 80.0');
            console.log('Actual range display:', ptiRangeDisplay?.textContent);
        } else {
            console.error('Slider elements not found!');
        }
    };
});
</script>
    </div>
</div>
{% endblock %} 