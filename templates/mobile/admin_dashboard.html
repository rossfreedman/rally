{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block title %}Activity Dashboard | Rally{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4 md:py-6 max-w-7xl">
  <!-- Header Section -->
  <div class="header-section mb-6 md:mb-8">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Activity Dashboard</h1>
        <p class="text-sm md:text-base text-gray-600 mt-1">Real-time monitoring of Rally app activities</p>
      </div>
      <div class="flex items-center space-x-2">
        <div class="status-indicator bg-green-500 w-3 h-3 rounded-full animate-pulse"></div>
        <span class="text-sm font-medium text-gray-700">Live</span>
      </div>
    </div>
  </div>

  <!-- Stats Overview Cards -->
  <div class="stats-section mb-6 md:mb-8">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
      <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
        <div class="flex items-center">
          <div class="p-2 bg-blue-100 rounded-lg">
            <i class="fas fa-chart-line text-blue-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-600">Total Activities</p>
            <p class="text-xl font-bold text-gray-900" id="total-activities">-</p>
          </div>
        </div>
      </div>
      
      <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
        <div class="flex items-center">
          <div class="p-2 bg-green-100 rounded-lg">
            <i class="fas fa-calendar-day text-green-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-600">Today</p>
            <p class="text-xl font-bold text-gray-900" id="today-activities">-</p>
          </div>
        </div>
      </div>
      
      <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
        <div class="flex items-center">
          <div class="p-2 bg-purple-100 rounded-lg">
            <i class="fas fa-users text-purple-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-600">Active Users</p>
            <p class="text-xl font-bold text-gray-900" id="active-users">-</p>
          </div>
        </div>
      </div>
      
      <div class="stat-card bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow">
        <div class="flex items-center">
          <div class="p-2 bg-orange-100 rounded-lg">
            <i class="fas fa-bolt text-orange-600 text-xl"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm font-medium text-gray-600">Activity Rate</p>
            <p class="text-lg font-bold text-gray-900" id="activity-rate">-</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Content -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
    
    <!-- Activity Timeline - Left Column (2/3 width on large screens) -->
    <div class="lg:col-span-2">
      <!-- Filters Section -->
      <div class="filters-section bg-white p-4 md:p-6 rounded-lg shadow mb-4 md:mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="filter-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
            <div class="space-y-2">
              <input type="date" id="date-from" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
              <input type="date" id="date-to" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>
          </div>
          
          <div class="filter-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Action Type</label>
            <select id="action-type-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
              <option value="">All Actions</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Team</label>
            <select id="team-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
              <option value="">All Teams</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Exclusions</label>
            <div class="space-y-3">
              <label class="flex items-center">
                <input type="checkbox" id="exclude-impersonated" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">Hide impersonated activities</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" id="exclude-admin" checked class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                <span class="text-sm text-gray-700">Hide admin activities</span>
              </label>
            </div>
          </div>
          
          <div class="filter-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">Actions</label>
            <div class="space-y-2">
              <button id="apply-filters" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium">
                <i class="fas fa-filter mr-2"></i>Apply Filters
              </button>
              <button id="clear-filters" class="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm font-medium">
                <i class="fas fa-times mr-2"></i>Clear
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Timeline -->
      <div class="timeline-section bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">
              <i class="fas fa-clock mr-2 text-blue-600"></i>Activity Timeline
            </h2>
            <div class="flex items-center space-x-2">
              <button id="refresh-timeline" class="text-gray-500 hover:text-blue-600 transition-colors">
                <i class="fas fa-sync-alt"></i>
              </button>
              <span class="text-sm text-gray-500" id="timeline-status">Updated just now</span>
            </div>
          </div>
        </div>
        
        <div class="timeline-container p-4" style="max-height: 600px; overflow-y: auto;">
          <div id="timeline-content">
            <!-- Timeline items will be loaded here -->
            <div class="flex items-center justify-center py-8">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
              <span class="ml-2 text-gray-600">Loading activities...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="space-y-4 md:space-y-6">
      
      <!-- Activity Heatmap -->
      <div class="heatmap-section bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-calendar-alt mr-2 text-green-600"></i>Activity Heatmap
          </h2>
          <p class="text-sm text-gray-600 mt-1">Last 30 days</p>
        </div>
        <div class="p-4">
          <div id="heatmap-container">
            <div class="flex items-center justify-center py-4">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600"></div>
              <span class="ml-2 text-gray-600 text-sm">Loading heatmap...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Active Players -->
      <div class="top-players-section bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-star mr-2 text-yellow-600"></i>Most Active Users
          </h2>
          <p class="text-sm text-gray-600 mt-1">Top performers this period</p>
        </div>
        <div class="p-4">
          <div id="top-players-content">
            <div class="flex items-center justify-center py-4">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-yellow-600"></div>
              <span class="ml-2 text-gray-600 text-sm">Loading users...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Types Breakdown -->
      <div class="action-types-section bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-chart-pie mr-2 text-purple-600"></i>Action Types
          </h2>
          <p class="text-sm text-gray-600 mt-1">Activity breakdown</p>
        </div>
        <div class="p-4">
          <div id="action-types-content">
            <div class="flex items-center justify-center py-4">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
              <span class="ml-2 text-gray-600 text-sm">Loading breakdown...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Player Detail Modal -->
<div id="player-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closePlayerModal()"></div>
    
    <div class="relative inline-block w-full max-w-4xl p-6 my-8 text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900" id="player-modal-title">Player Activity History</h3>
        <button onclick="closePlayerModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div id="player-modal-content" class="max-h-96 overflow-y-auto">
        <!-- Player activity content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- Team Detail Modal -->
<div id="team-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
    <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" onclick="closeTeamModal()"></div>
    
    <div class="relative inline-block w-full max-w-4xl p-6 my-8 text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900" id="team-modal-title">Team Activity History</h3>
        <button onclick="closeTeamModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div id="team-modal-content" class="max-h-96 overflow-y-auto">
        <!-- Team activity content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<style>
/* Custom styles for the dashboard */
.stat-card {
  transition: transform 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.timeline-item {
  border-left: 3px solid #e5e7eb;
  padding-left: 1rem;
  margin-bottom: 1.5rem;
  position: relative;
}

.timeline-item:before {
  content: '';
  position: absolute;
  left: -6px;
  top: 0.5rem;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background-color: #6b7280;
}

.timeline-item.login:before { background-color: #10b981; }
.timeline-item.match_created:before { background-color: #f59e0b; }
.timeline-item.poll_response:before { background-color: #8b5cf6; }
.timeline-item.availability_update:before { background-color: #06b6d4; }
.timeline-item.dashboard_access:before { background-color: #3b82f6; }

/* Calendar-style Heatmap Styles */
.heatmap-day-labels {
  display: flex;
  justify-content: space-around;
  margin-bottom: 8px;
  padding: 0 2px;
}

.heatmap-day-label {
  font-size: 11px;
  font-weight: 500;
  color: #6b7280;
  text-align: center;
  width: 28px;
}

.heatmap-calendar-grid {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-bottom: 1rem;
}

.heatmap-week {
  display: flex;
  gap: 2px;
  justify-content: space-around;
}

.heatmap-square {
  width: 28px;
  height: 28px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  font-size: 10px;
  font-weight: 600;
  border: 1px solid rgba(0, 0, 0, 0.1);
  flex-shrink: 0;
}

.heatmap-clickable {
  cursor: pointer;
}

.heatmap-clickable:hover {
  transform: scale(1.15);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  z-index: 10;
  position: relative;
}



.heatmap-today {
  border: 2px solid #3b82f6 !important;
  box-shadow: 0 0 0 1px #3b82f6;
}

/* Activity level colors - GitHub inspired */
.heatmap-level-0 { 
  background-color: #ebedf0; 
  color: #6b7280;
}
.heatmap-level-1 { 
  background-color: #9be9a8; 
  color: #166534;
}
.heatmap-level-2 { 
  background-color: #40c463; 
  color: #14532d;
}
.heatmap-level-3 { 
  background-color: #30a14e; 
  color: white;
}
.heatmap-level-4 { 
  background-color: #216e39; 
  color: white;
}

.heatmap-day-num {
  font-size: 8px;
  line-height: 1;
  font-weight: 600;
}

/* Legend squares */
.heatmap-legend-square {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

/* Responsive adjustments for heatmap */
@media (max-width: 640px) {
  .heatmap-day-label {
    font-size: 10px;
    width: 24px;
  }
  
  .heatmap-calendar-grid {
    gap: 1px;
  }
  
  .heatmap-week {
    gap: 1px;
  }
  
  .heatmap-square {
    width: 24px;
    height: 24px;
    font-size: 9px;
  }
  
  .heatmap-day-num {
    font-size: 8px;
  }
  
  .heatmap-legend-square {
    width: 10px;
    height: 10px;
  }
}

@media (max-width: 480px) {
  .heatmap-day-label {
    font-size: 9px;
    width: 20px;
  }
  
  .heatmap-square {
    width: 20px;
    height: 20px;
    font-size: 8px;
  }
  
  .heatmap-day-num {
    font-size: 7px;
  }
}

.player-rank {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem;
  border-bottom: 1px solid #f3f4f6;
  transition: background-color 0.2s ease;
  cursor: pointer;
}

.player-rank:hover {
  background-color: #f9fafb;
}

.player-rank:last-child {
  border-bottom: none;
}

.action-type-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid #f3f4f6;
}

.action-type-bar:last-child {
  border-bottom: none;
}

.action-bar {
  height: 4px;
  border-radius: 2px;
  margin-top: 0.25rem;
  transition: width 0.5s ease;
}

/* Loading states */
.loading {
  opacity: 0.6;
  pointer-events: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .container {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .stats-section .grid {
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }
  
  .stat-card {
    padding: 0.75rem;
  }
  
  .stat-card .text-xl {
    font-size: 1.125rem;
  }
  
  .filters-section .grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .header-section h1 {
    font-size: 1.5rem;
  }
  
  .header-section p {
    font-size: 0.875rem;
  }
}

@media (max-width: 640px) {
  .stats-section .grid {
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }
  
  .stat-card {
    padding: 1rem;
  }
}
</style>

<script>
// Dashboard JavaScript
let dashboardData = {
  activities: [],
  stats: {},
  heatmapData: [],
  topPlayers: [],
  filterOptions: {}
};

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
  initializeDashboard();
  setupEventListeners();
  startAutoRefresh();
});

function initializeDashboard() {
  loadDashboardStats();
  loadFilterOptions();
  loadTimelineActivities();
  loadHeatmapData();
  loadTopPlayers();
}

function setupEventListeners() {
  // Filter controls
  document.getElementById('apply-filters').addEventListener('click', applyFilters);
  document.getElementById('clear-filters').addEventListener('click', clearFilters);
  document.getElementById('refresh-timeline').addEventListener('click', refreshTimeline);
  
  // Set default date range (last 7 days)
  const today = new Date();
  const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById('date-to').value = today.toISOString().split('T')[0];
  document.getElementById('date-from').value = lastWeek.toISOString().split('T')[0];
}

function startAutoRefresh() {
  // Refresh timeline every 30 seconds
  setInterval(() => {
    refreshTimeline();
    updateTimestamp();
  }, 30000);
}

async function loadDashboardStats() {
  try {
    const response = await fetch('/api/admin/dashboard/stats');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.stats = data.stats;
      updateStatsDisplay();
      updateActionTypesDisplay();
    }
  } catch (error) {
    console.error('Error loading dashboard stats:', error);
  }
}

async function loadDashboardStatsWithFilters(filters = {}) {
  try {
    const params = new URLSearchParams();
    if (filters.exclude_impersonated !== undefined) {
      params.append('exclude_impersonated', filters.exclude_impersonated);
    }
    
    const response = await fetch(`/api/admin/dashboard/stats?${params}`);
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.stats = data.stats;
      updateStatsDisplay();
      updateActionTypesDisplay();
    }
  } catch (error) {
    console.error('Error loading dashboard stats with filters:', error);
  }
}

async function loadFilterOptions() {
  try {
    const response = await fetch('/api/admin/dashboard/filters');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.filterOptions = data.filters;
      populateFilterDropdowns();
    }
  } catch (error) {
    console.error('Error loading filter options:', error);
  }
}

async function loadTimelineActivities(filters = {}) {
  try {
    showTimelineLoading();
    
    const params = new URLSearchParams({
      limit: '50',
      ...filters
    });
    
    const response = await fetch(`/api/admin/dashboard/activities?${params}`);
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.activities = data.activities;
      renderTimeline();
    }
  } catch (error) {
    console.error('Error loading timeline activities:', error);
    showTimelineError();
  }
}

async function loadHeatmapData() {
  try {
    const response = await fetch('/api/admin/dashboard/heatmap?days=30');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.heatmapData = data.heatmap_data;
      renderHeatmap();
    }
  } catch (error) {
    console.error('Error loading heatmap data:', error);
  }
}

async function loadTopPlayers() {
  try {
    const response = await fetch('/api/admin/dashboard/top-players?limit=10');
    const data = await response.json();
    
    if (data.status === 'success') {
      dashboardData.topPlayers = data.top_players;
      renderTopPlayers();
    }
  } catch (error) {
    console.error('Error loading top users:', error);
  }
}

function updateStatsDisplay() {
  const stats = dashboardData.stats;
  
  document.getElementById('total-activities').textContent = formatNumber(stats.total_activities || 0);
  document.getElementById('today-activities').textContent = formatNumber(stats.today_activities || 0);
  document.getElementById('active-users').textContent = formatNumber(stats.active_users_today || 0);
  
  // Calculate activity rate (activities per hour today)
  const currentHour = new Date().getHours();
  const rate = currentHour > 0 ? Math.round((stats.today_activities || 0) / currentHour) : (stats.today_activities || 0);
  document.getElementById('activity-rate').textContent = `${rate}/hr`;
}

function updateActionTypesDisplay() {
  const container = document.getElementById('action-types-content');
  const actionTypes = dashboardData.stats.activity_types || [];
  
  if (actionTypes.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No activity data available</p>';
    return;
  }
  
  const maxCount = Math.max(...actionTypes.map(type => type.count));
  
  const html = actionTypes.slice(0, 8).map(type => {
    const percentage = (type.count / maxCount) * 100;
    const actionIcon = getActionTypeIcon(type.type);
    const actionColor = getActionTypeColor(type.type);
    
    return `
      <div class="action-type-bar">
        <div class="flex items-center space-x-2">
          <i class="${actionIcon} text-${actionColor}-600"></i>
          <span class="text-sm font-medium text-gray-700">${formatActionType(type.type)}</span>
        </div>
        <span class="text-sm font-bold text-gray-900">${formatNumber(type.count)}</span>
      </div>
      <div class="action-bar bg-${actionColor}-200" style="width: ${percentage}%"></div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function populateFilterDropdowns() {
  const actionTypeSelect = document.getElementById('action-type-filter');
  const teamSelect = document.getElementById('team-filter');
  
  // Populate action types
  dashboardData.filterOptions.action_types?.forEach(actionType => {
    const option = document.createElement('option');
    option.value = actionType;
    option.textContent = formatActionType(actionType);
    actionTypeSelect.appendChild(option);
  });
  
  // Populate teams
  dashboardData.filterOptions.teams?.forEach(team => {
    const option = document.createElement('option');
    option.value = team.id;
    option.textContent = `${team.name} (${team.club_name})`;
    teamSelect.appendChild(option);
  });
}

function renderTimeline() {
  const container = document.getElementById('timeline-content');
  const activities = dashboardData.activities;
  
  if (activities.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8">
        <i class="fas fa-clock text-gray-400 text-3xl mb-3"></i>
        <p class="text-gray-500">No activities found for the selected filters.</p>
        <button onclick="clearFilters()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm">Clear filters to see all activities</button>
      </div>
    `;
    return;
  }
  
  const html = activities.map(activity => {
    const timeAgo = getTimeAgo(activity.timestamp);
    const actionIcon = getActionTypeIcon(activity.action_type);
    const actionColor = getActionTypeColor(activity.action_type);
    
    return `
      <div class="timeline-item ${activity.action_type}" data-activity-id="${activity.id}">
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-${actionColor}-100 rounded-full flex items-center justify-center">
              <i class="${actionIcon} text-${actionColor}-600 text-sm"></i>
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
              <p class="text-sm font-medium text-gray-900">
                ${activity.action_description}
              </p>
              <p class="text-xs text-gray-500">${timeAgo}</p>
            </div>
            
            ${activity.user ? `
              <p class="text-xs text-gray-600 mt-1">
                <i class="fas fa-user mr-1"></i>
                ${activity.user.first_name} ${activity.user.last_name}
                ${activity.user.email ? `(${activity.user.email})` : ''}
              </p>
            ` : ''}
            
            ${activity.player_name ? `
              <p class="text-xs text-indigo-600 mt-1">
                <i class="fas fa-user-circle mr-1"></i>
                Player: ${activity.player_name}
              </p>
            ` : ''}
            ${activity.team_name ? `
              <p class="text-xs text-orange-600 mt-1">
                <i class="fas fa-users mr-1"></i>
                Team: ${activity.team_name}
              </p>
            ` : ''}
            ${activity.club_name ? `
              <p class="text-xs text-green-600 mt-1">
                <i class="fas fa-building mr-1"></i>
                Club: ${activity.club_name}
              </p>
            ` : ''}
            ${activity.extra_data ? `
              <details class="cursor-pointer mt-1">
                <summary class="text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center">
                  <i class="fas fa-code text-xs mr-2"></i>
                  View Extra Data
                </summary>
                <pre class="structured-data-display">${JSON.stringify(activity.extra_data, null, 2)}</pre>
              </details>
            ` : ''}
            
            ${activity.player ? `
              <p class="text-xs text-gray-600 mt-1">
                <i class="fas fa-user-circle mr-1"></i>
                <a href="#" onclick="showPlayerDetails(${activity.player.id || 0})" class="text-blue-600 hover:text-blue-800">
                  ${activity.player.first_name} ${activity.player.last_name}
                </a>
              </p>
            ` : ''}
            
            ${activity.team ? `
              <p class="text-xs text-gray-600 mt-1">
                <i class="fas fa-users mr-1"></i>
                <a href="#" onclick="showTeamDetails(${activity.team.id || 0})" class="text-blue-600 hover:text-blue-800">
                  ${activity.team.name}
                </a>
                ${activity.team.club_name ? `<span class="text-gray-500"> - ${activity.team.club_name}</span>` : ''}
              </p>
            ` : ''}
            
            ${activity.related_type && activity.related_id ? `
              <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-link mr-1"></i>
                Related ${activity.related_type}: ${activity.related_id}
              </p>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function renderHeatmap() {
  const container = document.getElementById('heatmap-container');
  const data = dashboardData.heatmapData;
  
  if (data.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No heatmap data available</p>';
    return;
  }
  
  // Create a map of dates to counts
  const dateMap = {};
  data.forEach(item => {
    dateMap[item.date] = item.count;
  });
  
  // Generate last 30 days
  const today = new Date();
  const thirtyDaysAgo = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
  const maxCount = Math.max(...data.map(item => item.count), 1);
  
  // Generate days array - start from Sunday of the week containing thirty days ago
  const days = [];
  let startDate = new Date(thirtyDaysAgo);
  
  // Go back to the most recent Sunday
  while (startDate.getDay() !== 0) {
    startDate.setDate(startDate.getDate() - 1);
  }
  
  // Generate 6 weeks (42 days) to ensure we cover the full 30-day period
  for (let i = 0; i < 42; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    
    const dateStr = currentDate.toISOString().split('T')[0];
    const count = dateMap[dateStr] || 0;
    const level = getHeatmapLevel(count, maxCount);
    const isToday = dateStr === today.toISOString().split('T')[0];
    const isInRange = currentDate >= thirtyDaysAgo && currentDate <= today;
    
    days.push({
      date: dateStr,
      count,
      level,
      isToday,
      isInRange,
      dayName: currentDate.toLocaleDateString('en-US', { weekday: 'short' }),
      dayNumber: currentDate.getDate(),
      monthName: currentDate.toLocaleDateString('en-US', { month: 'short' })
    });
  }
  
  const totalActivities = data.reduce((sum, item) => sum + item.count, 0);
  
  const html = `
    <div class="heatmap-container">
      <!-- Summary Stats -->
      <div class="heatmap-summary mb-4 p-3 bg-gray-50 rounded-lg">
        <div class="grid grid-cols-3 gap-4 text-center">
          <div>
            <div class="text-lg font-bold text-gray-900">${totalActivities}</div>
            <div class="text-xs text-gray-600">Total Activities</div>
          </div>
          <div>
            <div class="text-lg font-bold text-gray-900">${Math.round(totalActivities / 30)}</div>
            <div class="text-xs text-gray-600">Daily Average</div>
          </div>
          <div>
            <div class="text-lg font-bold text-gray-900">${maxCount}</div>
            <div class="text-xs text-gray-600">Busiest Day</div>
          </div>
        </div>
      </div>
      
      <!-- Calendar-style Heatmap Grid -->
      <div class="heatmap-grid">
        <!-- Day labels -->
        <div class="heatmap-day-labels">
          <div class="heatmap-day-label">S</div>
          <div class="heatmap-day-label">M</div>
          <div class="heatmap-day-label">T</div>
          <div class="heatmap-day-label">W</div>
          <div class="heatmap-day-label">T</div>
          <div class="heatmap-day-label">F</div>
          <div class="heatmap-day-label">S</div>
        </div>
        
        <!-- Calendar grid -->
        <div class="heatmap-calendar-grid">
          ${Array.from({length: 6}, (_, weekIndex) => {
             const weekDays = days.slice(weekIndex * 7, (weekIndex + 1) * 7);
             return `
               <div class="heatmap-week">
                 ${weekDays.map(day => {
                   const tooltipText = `${day.monthName} ${day.dayNumber}: ${day.count} activities`;
                   const opacity = day.isInRange ? '1' : '0.3';
                   const clickable = day.isInRange ? 'heatmap-clickable' : '';
                   
                   return `
                     <div class="heatmap-square ${day.isToday ? 'heatmap-today' : ''} heatmap-level-${day.level} ${clickable}"
                          title="${tooltipText}"
                          data-count="${day.count}"
                          data-date="${day.date}"
                          style="opacity: ${opacity}">
                       <span class="heatmap-day-num">${day.dayNumber}</span>
                     </div>
                   `;
                 }).join('')}
               </div>
             `;
           }).join('')}
         </div>
        </div>
      </div>
      
      <!-- Legend -->
      <div class="heatmap-legend">
        <div class="flex items-center justify-between text-xs text-gray-600 mb-2">
          <span>Activity Intensity</span>
          <span class="text-gray-500">Last 30 days</span>
        </div>
        <div class="flex items-center justify-center space-x-2">
          <span class="text-xs text-gray-500">Less</span>
          <div class="heatmap-legend-square heatmap-level-0"></div>
          <div class="heatmap-legend-square heatmap-level-1"></div>
          <div class="heatmap-legend-square heatmap-level-2"></div>
          <div class="heatmap-legend-square heatmap-level-3"></div>
          <div class="heatmap-legend-square heatmap-level-4"></div>
          <span class="text-xs text-gray-500">More</span>
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
  
  // Add click handlers for day details (only for clickable squares)
  container.querySelectorAll('.heatmap-clickable[data-count]').forEach(square => {
    square.addEventListener('click', (e) => {
      const date = e.currentTarget.dataset.date;
      const count = e.currentTarget.dataset.count;
      showDayActivityDetail(date, count);
    });
  });
}

function renderTopPlayers() {
  const container = document.getElementById('top-players-content');
  const players = dashboardData.topPlayers;
  
  if (players.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No player activity data available</p>';
    return;
  }
  
  const html = players.map((player, index) => {
    const rankIcon = index < 3 ? ['🥇', '🥈', '🥉'][index] : `#${index + 1}`;
    
    return `
      <div class="player-rank" onclick="showPlayerDetails(${player.id})">
        <div class="flex items-center space-x-3">
          <span class="text-sm font-bold" style="min-width: 30px;">${rankIcon}</span>
          <div>
            <p class="text-sm font-medium text-gray-900">
              ${player.first_name} ${player.last_name}
            </p>
            <p class="text-xs text-gray-600">
              ${player.club_name}${player.series_name ? ` • ${player.series_name}` : ''}
            </p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-sm font-bold text-gray-900">${formatNumber(player.activity_count)}</p>
          <p class="text-xs text-gray-600">activities</p>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

// Filter and utility functions
function applyFilters() {
  const filters = {
    date_from: document.getElementById('date-from').value,
    date_to: document.getElementById('date-to').value,
    action_type: document.getElementById('action-type-filter').value,
    team_id: document.getElementById('team-filter').value,
    exclude_impersonated: document.getElementById('exclude-impersonated').checked,
    exclude_admin: document.getElementById('exclude-admin').checked
  };
  
  // Remove empty filters
  Object.keys(filters).forEach(key => {
    if (filters[key] === '' || filters[key] === null) {
      delete filters[key];
    }
  });
  
  loadTimelineActivities(filters);
  // Also reload stats with the same filters
  loadDashboardStatsWithFilters(filters);
}

function clearFilters() {
  document.getElementById('date-from').value = '';
  document.getElementById('date-to').value = '';
  document.getElementById('action-type-filter').value = '';
  document.getElementById('team-filter').value = '';
  document.getElementById('exclude-impersonated').checked = false;
  document.getElementById('exclude-admin').checked = true; // Keep admin exclusion as default
  
  loadTimelineActivities();
  loadDashboardStats(); // Reload stats with default settings
}

function refreshTimeline() {
  const refreshButton = document.getElementById('refresh-timeline');
  refreshButton.classList.add('animate-spin');
  
  applyFilters();
  
  setTimeout(() => {
    refreshButton.classList.remove('animate-spin');
    updateTimestamp();
  }, 1000);
}

function showTimelineLoading() {
  document.getElementById('timeline-content').innerHTML = `
    <div class="flex items-center justify-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <span class="ml-2 text-gray-600">Loading activities...</span>
    </div>
  `;
}

function showTimelineError() {
  document.getElementById('timeline-content').innerHTML = `
    <div class="text-center py-8">
      <i class="fas fa-exclamation-triangle text-red-400 text-3xl mb-3"></i>
      <p class="text-gray-500">Error loading activities. Please try again.</p>
      <button onclick="refreshTimeline()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">
        Retry
      </button>
    </div>
  `;
}

// Player and team detail modals
async function showPlayerDetails(playerId) {
  const modal = document.getElementById('player-modal');
  const content = document.getElementById('player-modal-content');
  const title = document.getElementById('player-modal-title');
  
  modal.classList.remove('hidden');
  content.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div></div>';
  
  try {
    const response = await fetch(`/api/admin/dashboard/player/${playerId}/activities`);
    const data = await response.json();
    
    if (data.status === 'success') {
      const activities = data.activities;
      const player = dashboardData.topPlayers.find(p => p.id === playerId);
      
      title.textContent = player ? `${player.first_name} ${player.last_name} - Activity History` : 'Player Activity History';
      
      if (activities.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-4">No activities found for this player.</p>';
        return;
      }
      
      const html = activities.map(activity => {
        const timeAgo = getTimeAgo(activity.timestamp);
        const actionIcon = getActionTypeIcon(activity.action_type);
        const actionColor = getActionTypeColor(activity.action_type);
        
        return `
          <div class="border-l-3 border-${actionColor}-300 pl-4 py-2 mb-3">
            <div class="flex items-center space-x-2 mb-1">
              <i class="${actionIcon} text-${actionColor}-600"></i>
              <span class="text-sm font-medium">${activity.action_description}</span>
              <span class="text-xs text-gray-500">${timeAgo}</span>
            </div>
            ${activity.team ? `
              <p class="text-xs text-gray-600">
                <i class="fas fa-users mr-1"></i>
                ${activity.team.name} - ${activity.team.club_name}
              </p>
            ` : ''}
          </div>
        `;
      }).join('');
      
      content.innerHTML = html;
    }
  } catch (error) {
    content.innerHTML = '<p class="text-red-500 text-center py-4">Error loading player activities.</p>';
  }
}

async function showTeamDetails(teamId) {
  const modal = document.getElementById('team-modal');
  const content = document.getElementById('team-modal-content');
  const title = document.getElementById('team-modal-title');
  
  modal.classList.remove('hidden');
  content.innerHTML = '<div class="text-center py-4"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div></div>';
  
  try {
    const response = await fetch(`/api/admin/dashboard/team/${teamId}/activities`);
    const data = await response.json();
    
    if (data.status === 'success') {
      const activities = data.activities;
      const team = dashboardData.filterOptions.teams?.find(t => t.id === teamId);
      
      title.textContent = team ? `${team.name} - Activity History` : 'Team Activity History';
      
      if (activities.length === 0) {
        content.innerHTML = '<p class="text-gray-500 text-center py-4">No activities found for this team.</p>';
        return;
      }
      
      const html = activities.map(activity => {
        const timeAgo = getTimeAgo(activity.timestamp);
        const actionIcon = getActionTypeIcon(activity.action_type);
        const actionColor = getActionTypeColor(activity.action_type);
        
        return `
          <div class="border-l-3 border-${actionColor}-300 pl-4 py-2 mb-3">
            <div class="flex items-center space-x-2 mb-1">
              <i class="${actionIcon} text-${actionColor}-600"></i>
              <span class="text-sm font-medium">${activity.action_description}</span>
              <span class="text-xs text-gray-500">${timeAgo}</span>
            </div>
            ${activity.user ? `
              <p class="text-xs text-gray-600">
                <i class="fas fa-user mr-1"></i>
                ${activity.user.first_name} ${activity.user.last_name}
              </p>
            ` : ''}
            ${activity.player ? `
              <p class="text-xs text-gray-600">
                <i class="fas fa-user-circle mr-1"></i>
                ${activity.player.first_name} ${activity.player.last_name}
              </p>
            ` : ''}
          </div>
        `;
      }).join('');
      
      content.innerHTML = html;
    }
  } catch (error) {
    content.innerHTML = '<p class="text-red-500 text-center py-4">Error loading team activities.</p>';
  }
}

function closePlayerModal() {
  document.getElementById('player-modal').classList.add('hidden');
}

function closeTeamModal() {
  document.getElementById('team-modal').classList.add('hidden');
}

// Utility functions
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1) + 'M';
  } else if (num >= 1000) {
    return (num / 1000).toFixed(1) + 'K';
  }
  return num.toString();
}

function getTimeAgo(timestamp) {
  const now = new Date();
  const time = new Date(timestamp);
  const diffMs = now - time;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return time.toLocaleDateString();
}

function getActionTypeIcon(actionType) {
  const icons = {
    'login': 'fas fa-sign-in-alt',
    'logout': 'fas fa-sign-out-alt',
    'auth': 'fas fa-key',
    'match_created': 'fas fa-trophy',
    'score_submitted': 'fas fa-tennis-ball',
    'poll_response': 'fas fa-vote-yea',
    'poll_voted': 'fas fa-check-circle',
    'poll_created': 'fas fa-poll',
    'availability_update': 'fas fa-calendar-check',
    'dashboard_access': 'fas fa-chart-line',
    'page_visit': 'fas fa-eye',
    'admin_action': 'fas fa-user-cog',
    'data_update': 'fas fa-database',
    'data_sync': 'fas fa-sync',
    'player_search': 'fas fa-search',
    'simulation_run': 'fas fa-calculator',
    'ai_chat': 'fas fa-robot',
    'user_registration': 'fas fa-user-plus',
    'lineup_update': 'fas fa-users',
    'lineup_escrow': 'fas fa-lock',
    'court_reservation': 'fas fa-map-marker-alt',
    'team_email': 'fas fa-envelope',
    'system_maintenance': 'fas fa-tools',
    'default': 'fas fa-circle'
  };
  return icons[actionType] || icons.default;
}

function getActionTypeColor(actionType) {
  const colors = {
    'login': 'green',
    'logout': 'red',
    'auth': 'blue',
    'match_created': 'yellow',
    'score_submitted': 'amber',
    'poll_response': 'purple',
    'poll_voted': 'purple',
    'poll_created': 'violet',
    'availability_update': 'blue',
    'dashboard_access': 'indigo',
    'page_visit': 'gray',
    'admin_action': 'orange',
    'data_update': 'teal',
    'data_sync': 'cyan',
    'player_search': 'slate',
    'simulation_run': 'pink',
    'ai_chat': 'emerald',
    'user_registration': 'lime',
    'lineup_update': 'sky',
    'lineup_escrow': 'red',
    'court_reservation': 'green',
    'team_email': 'blue',
    'system_maintenance': 'gray',
    'default': 'gray'
  };
  return colors[actionType] || colors.default;
}

function formatActionType(actionType) {
  return actionType.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

function getHeatmapLevel(count, maxCount) {
  if (count === 0) return 0;
  const percentage = (count / maxCount) * 100;
  if (percentage <= 25) return 1;
  if (percentage <= 50) return 2;
  if (percentage <= 75) return 3;
  return 4;
}

function updateTimestamp() {
  document.getElementById('timeline-status').textContent = 'Updated just now';
}

function showDayActivityDetail(date, count) {
  // Create a simple alert for now - could be enhanced with a modal
  const formattedDate = new Date(date).toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
  
  const message = count > 0 
    ? `${formattedDate}\n\n${count} activities recorded on this day.\n\nClick OK to see detailed timeline for this date.`
    : `${formattedDate}\n\nNo activities recorded on this day.`;
    
  if (confirm(message) && count > 0) {
    // Set date filter and apply
    document.getElementById('date-from').value = date;
    document.getElementById('date-to').value = date;
    applyFilters();
  }
}
</script>
{% endblock %} 