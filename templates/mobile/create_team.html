{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block title %}Rally - Create Team{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Desktop Only Alert -->
    <div class="bg-amber-50 border border-amber-200 rounded-xl mb-4 p-4 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                <i class="fas fa-desktop text-amber-600 text-lg"></i>
            </div>
            <div class="flex-1">
                <p class="text-sm font-medium text-amber-800">
                    <span class="font-semibold">3-Column Layout:</span> This page displays three columns side-by-side on desktop and tablet screens (medium and larger). On mobile, columns will stack vertically for better usability.
                </p>
            </div>
            <div class="flex-shrink-0">
                <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" class="text-amber-600 hover:text-amber-800 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Page Header -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-4">
        <div class="flex items-center gap-4 p-4">
            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-sm">
                <i class="fas fa-users-cog text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-900">Create Team</h1>
                <p class="text-sm text-gray-600">PTI-based team assignment with expert guidance</p>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="py-12 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 text-lg text-gray-600">Loading player data...</p>
        <div class="mt-6 space-y-2">
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="window.debugPageState()" class="text-blue-600 hover:text-blue-800 text-sm px-3 py-1 rounded border border-blue-300 hover:bg-blue-50 transition-colors">
                    <i class="fas fa-bug mr-1"></i>
                    Debug Info
                </button>
                <button onclick="window.testAPIEndpoints()" class="text-green-600 hover:text-green-800 text-sm px-3 py-1 rounded border border-green-300 hover:bg-green-50 transition-colors">
                    <i class="fas fa-flask mr-1"></i>
                    Test APIs
                </button>
                <button onclick="window.inspectDOM()" class="text-purple-600 hover:text-purple-800 text-sm px-3 py-1 rounded border border-purple-300 hover:bg-purple-50 transition-colors">
                    <i class="fas fa-search mr-1"></i>
                    Inspect DOM
                </button>
                <button onclick="window.debugViewport()" class="text-indigo-600 hover:text-indigo-800 text-sm px-3 py-1 rounded border border-indigo-300 hover:bg-indigo-50 transition-colors">
                    <i class="fas fa-desktop mr-1"></i>
                    Viewport
                </button>
            </div>
        </div>
        <p class="mt-2 text-xs text-gray-500">If loading takes too long, use debug tools above</p>
    </div>

    <!-- Main Content Container (Always Visible) -->
    <div id="main-content" class="grid grid-cols-1 md:grid-cols-3 gap-4 min-h-screen">
        
        <!-- Column 1: Interactive PTI Range Control -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col">
            <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-sliders-h text-blue-600 mr-2"></i>
                            PTI Range Control
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">Adjust PTI ranges for each series with real-time validation</p>
                    </div>
                    <button id="reset-ranges" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-blue-600 bg-white border border-blue-200 rounded-lg hover:bg-blue-50 hover:text-blue-700 transition-colors">
                        <i class="fas fa-undo text-xs"></i>
                        Reset
                    </button>
                </div>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="series-recommendations" class="space-y-4">
                    <!-- Series recommendations will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Column 2: Available Players -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col">
            <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-green-50 to-emerald-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-users text-green-600 mr-2"></i>
                            Available Players
                            <span id="player-count" class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full"></span>
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">Tap players to assign to series ranges. Tennaqua players only.</p>
                        <div class="mt-2 p-2 bg-gray-50 rounded-lg">
                            <p class="text-xs font-medium text-gray-700 mb-1">PTI Color Guide:</p>
                            <div class="flex flex-wrap gap-1 text-xs">
                                <span class="bg-emerald-200 border border-emerald-400 text-emerald-900 px-1 py-0.5 rounded font-medium">0-9</span>
                                <span class="bg-green-200 border border-green-400 text-green-900 px-1 py-0.5 rounded font-medium">10-19</span>
                                <span class="bg-lime-200 border border-lime-400 text-lime-900 px-1 py-0.5 rounded font-medium">20-29</span>
                                <span class="bg-yellow-200 border border-yellow-400 text-yellow-900 px-1 py-0.5 rounded font-medium">30-39</span>
                                <span class="bg-amber-200 border border-amber-400 text-amber-900 px-1 py-0.5 rounded font-medium">40-49</span>
                                <span class="bg-orange-200 border border-orange-400 text-orange-900 px-1 py-0.5 rounded font-medium">50-59</span>
                                <span class="bg-red-200 border border-red-400 text-red-900 px-1 py-0.5 rounded font-medium">60-69</span>
                                <span class="bg-rose-200 border border-rose-400 text-rose-900 px-1 py-0.5 rounded font-medium">70-79</span>
                                <span class="bg-purple-200 border border-purple-400 text-purple-900 px-1 py-0.5 rounded font-medium">80+</span>
                            </div>
                        </div>
                    </div>
                    <button id="reset-players" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-green-600 bg-white border border-green-200 rounded-lg hover:bg-green-50 hover:text-green-700 transition-colors">
                        <i class="fas fa-undo text-xs"></i>
                        Reset
                    </button>
                </div>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="available-players-pool" class="min-h-24 bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-4">
                    <div class="text-gray-400 text-center text-sm" id="loading-players">Loading players...</div>
                </div>
            </div>
        </div>

        <!-- Column 3: Series Teams Display -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col">
            <div class="px-4 py-3 border-b border-gray-100 bg-gradient-to-r from-purple-50 to-pink-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-users-cog text-purple-600 mr-2"></i>
                            Team Assignments
                        </h2>
                        <p class="text-sm text-gray-600 mt-1">Tap series to assign selected players</p>
                        <p class="text-xs text-blue-600 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>Target Team PTI</strong> shows total team PTI range (individual PTI √ó team size).
                        </p>
                    </div>
                    <button id="reset-assignments" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-purple-600 bg-white border border-purple-200 rounded-lg hover:bg-purple-50 hover:text-purple-700 transition-colors">
                        <i class="fas fa-undo text-xs"></i>
                        Reset
                    </button>
                </div>
            </div>
            <div class="p-4 flex-1 overflow-y-auto">
                <div id="series-teams" class="space-y-4">
                    <!-- Series containers will be dynamically created here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Selected Player Indicator (for tap mode) -->
    <div id="selected-player-indicator" class="bg-yellow-100 border border-yellow-300 rounded-lg p-4 mt-4 hidden">
        <div class="flex items-center justify-between">
            <div>
                <span class="text-sm font-medium text-yellow-800">Selected: </span>
                <span id="selected-player-name" class="text-sm text-yellow-900 font-semibold"></span>
                <span id="selected-player-pti" class="text-xs text-yellow-700 ml-2"></span>
            </div>
            <button id="clear-selection" class="text-yellow-600 hover:text-yellow-800 text-sm px-3 py-1 rounded">
                Clear Selection
            </button>
        </div>
        <p class="text-xs text-yellow-700 mt-2">Tap a series range to assign this player</p>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 pt-6 justify-center">
        <button id="save-teams" class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed">
            <i class="fas fa-save mr-2"></i>
            Save Teams
        </button>
        <button id="reset-teams" class="bg-gray-600 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all font-semibold">
            <i class="fas fa-undo mr-2"></i>
            Reset
        </button>
    </div>
</div>

<style>
/* Mobile-specific styles for create team */
.player-card {
    transition: all 0.2s ease;
    cursor: pointer;
    user-select: none;
    min-height: 44px;
    padding: 0.75rem !important;
    margin: 0.5rem !important;
    width: 140px !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    text-align: center !important;
    border-radius: 8px !important;
}

.player-card:hover, .player-card:active {
    transform: scale(0.98);
    background-color: rgba(59, 130, 246, 0.1);
}

.player-card.selected {
    background-color: rgba(59, 130, 246, 0.2) !important;
    border: 2px solid #3b82f6 !important;
}

/* Player pool container styling */
#available-players-pool {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: flex-start;
    gap: 0.5rem;
}

/* Drop zones for mobile */
.drop-zone {
    transition: all 0.2s ease;
    min-height: 60px;
    border: 2px dashed #d1d5db;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.5rem 0;
    cursor: pointer;
}

.drop-zone.drop-zone-active {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
    border-style: solid !important;
}

.drop-zone.drop-zone-hover {
    border-color: #10b981 !important;
    background-color: #ecfdf5 !important;
    border-style: solid !important;
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
}

/* Drag and Drop Styling */
.player-card.dragging {
    opacity: 0.5 !important;
    transform: rotate(5deg) scale(0.95);
    z-index: 1000;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.player-card[draggable="true"] {
    position: relative;
    cursor: grab;
}

.player-card[draggable="true"]:active {
    cursor: grabbing;
}

.player-card .drag-handle {
    position: absolute;
    top: 2px;
    right: 2px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.player-card:hover .drag-handle {
    opacity: 1;
}

/* Drag feedback for touch devices */
@media (hover: none) {
    .player-card .drag-handle {
        opacity: 0.7;
    }
    
    .player-card:active .drag-handle {
        opacity: 1;
    }
}

/* PTI Color Coding */
.pti-0 { background-color: #dcfce7; border-color: #16a34a; color: #15803d; }
.pti-10 { background-color: #dcfce7; border-color: #16a34a; color: #15803d; }
.pti-20 { background-color: #ecfdf5; border-color: #10b981; color: #047857; }
.pti-30 { background-color: #fef3c7; border-color: #f59e0b; color: #92400e; }
.pti-40 { background-color: #fde68a; border-color: #f59e0b; color: #92400e; }
.pti-50 { background-color: #fed7aa; border-color: #ea580c; color: #9a3412; }
.pti-60 { background-color: #fecaca; border-color: #ef4444; color: #b91c1c; }
.pti-70 { background-color: #fce7f3; border-color: #ec4899; color: #be185d; }
.pti-80 { background-color: #e9d5ff; border-color: #a855f7; color: #7c2d12; }

/* PTI Range Sliders Styling */
.slider {
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: #e5e7eb;
    outline: none;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-webkit-slider-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
}

.slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #3b82f6;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.2s ease;
}

.slider::-moz-range-thumb:hover {
    background: #2563eb;
    transform: scale(1.1);
}

/* Series Control Animations */
.series-control {
    transition: all 0.3s ease;
}

.series-control:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* 3-Column Layout Styling */
#main-content {
    height: calc(100vh - 200px); /* Account for header and footer space */
}

/* Ensure equal column heights */
@media (min-width: 768px) {
    #main-content > div {
        min-height: 600px;
    }
    
    .player-card {
        width: 100px !important;
        font-size: 0.75rem !important;
    }
}

/* Responsive grid for mobile */
@media (max-width: 768px) {
    .candy-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
    }
    
    .player-card {
        width: 120px !important;
        min-height: 50px !important;
        padding: 0.5rem !important;
        margin: 0.25rem !important;
    }
    
    #main-content {
        height: auto;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize session data
    window.sessionData = {{ session_data | tojson | safe }};

    // Global variables
    let allPlayers = [];
    let seriesRanges = [];
    let teamAssignments = {};
    let selectedPlayerForTap = null;

    // PTI Color Coding Function
    function getPTIColorClass(pti) {
        const segment = Math.floor(pti / 10);
        const colorClasses = [
            'bg-emerald-200 border-emerald-400 text-emerald-900',
            'bg-green-200 border-green-400 text-green-900',
            'bg-lime-200 border-lime-400 text-lime-900',
            'bg-yellow-200 border-yellow-400 text-yellow-900',
            'bg-amber-200 border-amber-400 text-amber-900',
            'bg-orange-200 border-orange-400 text-orange-900',
            'bg-red-200 border-red-400 text-red-900',
            'bg-rose-200 border-rose-400 text-rose-900',
            'bg-purple-200 border-purple-400 text-purple-900'
        ];
        return colorClasses[segment] || colorClasses[colorClasses.length - 1];
    }

    // Initialize page with mobile-optimized functionality
    async function initializePage() {
        try {
            console.log('üîç Starting page initialization...');
            console.log('üîç Session data:', window.sessionData);
            
            console.log('üîç Step 1: Loading players...');
            await loadPlayers();
            console.log('üîç ‚úÖ Players loaded successfully');
            
            console.log('üîç Step 2: Loading series ranges...');
            await loadSeriesRanges();
            console.log('üîç ‚úÖ Series ranges loaded successfully');
            
            console.log('üîç Step 3: Setting up event listeners...');
            setupEventListeners();
            console.log('üîç ‚úÖ Event listeners set up');
            
            console.log('üîç Step 4: Hiding loading state...');
            showContent();
            console.log('üîç ‚úÖ Page initialization complete');
        } catch (error) {
            console.error('üîç ‚ùå Error initializing page:', error);
            showError(`Failed to load data: ${error.message}. Please refresh the page or contact support.`);
        }
    }

    // Load players from API
    async function loadPlayers() {
        try {
            console.log('üîç Loading players from /api/create-team/players...');
            const response = await fetch('/api/create-team/players');
            console.log('üîç Players API response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('üîç Players API error response:', errorText);
                throw new Error(`Failed to fetch players: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            console.log('üîç Players API response data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load players');
            }
            
            // Filter to only Tennaqua players
            allPlayers = data.players.filter(player => 
                player.club && player.club.toLowerCase().includes('tennaqua')
            );
            console.log(`üîç Loaded ${allPlayers.length} Tennaqua players (filtered from ${data.players.length} total)`);
            console.log('üîç Sample players:', allPlayers.slice(0, 3));
            
            displayPlayers();
            updatePlayerCount();
        } catch (error) {
            console.error('üîç Error loading players:', error);
            throw error;
        }
    }

    // Load series ranges from API
    async function loadSeriesRanges() {
        try {
            console.log('üîç Loading series from /api/create-team/analyze-series...');
            const response = await fetch('/api/create-team/analyze-series');
            console.log('üîç Series API response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('üîç Series API error response:', errorText);
                throw new Error(`Failed to fetch series: ${response.status} - ${errorText}`);
            }
            
            const data = await response.json();
            console.log('üîç Series API response data:', data);
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to analyze series');
            }
            
            seriesRanges = data.series_ranges || [];
            console.log(`üîç Loaded ${seriesRanges.length} series`);
            console.log('üîç Sample series:', seriesRanges.slice(0, 2));
            
            displaySeriesControls();
            displaySeriesTeams();
        } catch (error) {
            console.error('üîç Error loading series:', error);
            throw error;
        }
    }

    // Display players in the pool
    function displayPlayers() {
        console.log('üîç displayPlayers() called, players count:', allPlayers.length);
        const container = document.getElementById('available-players-pool');
        console.log('üîç Players container element:', container);
        
        if (!container) {
            console.log('üîç ‚ùå Players container not found');
            return;
        }

        if (allPlayers.length === 0) {
            container.innerHTML = '<div class="text-gray-400 text-center text-sm">No players available</div>';
            console.log('üîç ‚ö†Ô∏è No players available, showing empty message');
            return;
        }

        const playersHtml = allPlayers.map(player => {
            const ptiColorClass = getPTIColorClass(player.pti || 50);
            return `
                <div class="player-card ${ptiColorClass} border rounded-lg cursor-pointer" 
                     data-player-id="${player.id}"
                     draggable="true"
                     ondragstart="handleDragStart(event, '${player.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="selectPlayer('${player.id}')">
                    <div class="text-sm font-semibold">${player.name || `${player.first_name} ${player.last_name}`}</div>
                    <div class="text-xs">PTI: ${player.pti ? player.pti.toFixed(1) : 'N/A'}</div>
                    <div class="text-xs text-gray-600">${player.club || ''}</div>
                    <div class="drag-handle">
                        <i class="fas fa-grip-vertical text-gray-400 text-xs"></i>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = playersHtml;
        console.log('üîç ‚úÖ Players HTML set, length:', playersHtml.length);
    }

    // Handle player selection for mobile tap interface
    function selectPlayer(playerId) {
        const player = allPlayers.find(p => p.id === playerId);
        if (!player) return;

        // Clear previous selection
        document.querySelectorAll('.player-card').forEach(card => {
            card.classList.remove('selected');
        });

        // Select current player
        selectedPlayerForTap = player;
        const playerCard = document.querySelector(`[data-player-id="${playerId}"]`);
        if (playerCard) {
            playerCard.classList.add('selected');
        }

        // Show selected player indicator
        const indicator = document.getElementById('selected-player-indicator');
        const nameSpan = document.getElementById('selected-player-name');
        const ptiSpan = document.getElementById('selected-player-pti');
        
        if (indicator && nameSpan && ptiSpan) {
            nameSpan.textContent = player.name || `${player.first_name} ${player.last_name}`;
            ptiSpan.textContent = `PTI: ${player.pti ? player.pti.toFixed(1) : 'N/A'}`;
            indicator.classList.remove('hidden');
        }
    }

    // Display series controls with interactive PTI sliders
    function displaySeriesControls() {
        console.log('üîç displaySeriesControls() called, series count:', seriesRanges.length);
        const container = document.getElementById('series-recommendations');
        console.log('üîç Series controls container element:', container);
        
        if (!container) {
            console.log('üîç ‚ùå Series controls container not found');
            return;
        }

        const seriesHtml = seriesRanges.map((series, index) => `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 series-control" data-series-id="${series.series_id}">
                <h3 class="font-semibold text-gray-900 mb-3">${series.series_name}</h3>
                
                <!-- Current PTI Information -->
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div class="bg-white p-2 rounded border">
                        <div class="text-xs text-gray-500 mb-1">Current Range</div>
                        <div class="font-medium text-gray-900">${series.current_range.min} - ${series.current_range.max}</div>
                    </div>
                    <div class="bg-blue-50 p-2 rounded border border-blue-200">
                        <div class="text-xs text-blue-600 mb-1">Recommended</div>
                        <div class="font-medium text-blue-900">${series.recommended_range.min} - ${series.recommended_range.max}</div>
                    </div>
                </div>

                <!-- Interactive PTI Range Sliders -->
                <div class="bg-white p-3 rounded border">
                    <div class="text-sm font-medium text-gray-700 mb-3">Adjust PTI Range</div>
                    
                    <!-- Min PTI Slider -->
                    <div class="mb-4">
                        <label class="text-xs text-gray-600 block mb-1">Minimum PTI: <span id="min-pti-value-${index}" class="font-medium text-blue-600">${series.recommended_range.min}</span></label>
                        <input type="range" 
                               id="min-pti-slider-${index}"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                               min="10" 
                               max="80" 
                               step="0.5"
                               value="${series.recommended_range.min}"
                               data-series-index="${index}"
                               data-type="min"
                               oninput="updatePTIRange(${index}, 'min', this.value)">
                    </div>

                    <!-- Max PTI Slider -->
                    <div class="mb-3">
                        <label class="text-xs text-gray-600 block mb-1">Maximum PTI: <span id="max-pti-value-${index}" class="font-medium text-blue-600">${series.recommended_range.max}</span></label>
                        <input type="range" 
                               id="max-pti-slider-${index}"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                               min="10" 
                               max="80" 
                               step="0.5"
                               value="${series.recommended_range.max}"
                               data-series-index="${index}"
                               data-type="max"
                               oninput="updatePTIRange(${index}, 'max', this.value)">
                    </div>

                    <!-- Apply/Reset Buttons -->
                    <div class="flex gap-2 mt-3">
                        <button onclick="applyPTIRange(${index})" 
                                class="flex-1 bg-blue-600 text-white text-xs px-3 py-2 rounded hover:bg-blue-700 transition-colors">
                            <i class="fas fa-check mr-1"></i>
                            Apply Range
                        </button>
                        <button onclick="resetPTIRange(${index})" 
                                class="bg-gray-500 text-white text-xs px-3 py-2 rounded hover:bg-gray-600 transition-colors">
                            <i class="fas fa-undo mr-1"></i>
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Series Statistics -->
                <div class="mt-3 p-2 bg-gray-100 rounded text-xs">
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div>
                            <div class="text-gray-500">Players</div>
                            <div class="font-medium">${series.player_count}</div>
                        </div>
                        <div>
                            <div class="text-gray-500">Avg PTI</div>
                            <div class="font-medium">${series.statistics.avg}</div>
                        </div>
                        <div>
                            <div class="text-gray-500">Std Dev</div>
                            <div class="font-medium">${series.statistics.std_dev}</div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = seriesHtml;
        console.log('üîç ‚úÖ Series controls HTML set with interactive sliders, length:', seriesHtml.length);
    }

    // Update PTI range value and validate
    function updatePTIRange(seriesIndex, type, value) {
        const series = seriesRanges[seriesIndex];
        if (!series) return;

        const numValue = parseFloat(value);
        const valueDisplay = document.getElementById(`${type}-pti-value-${seriesIndex}`);
        
        if (valueDisplay) {
            valueDisplay.textContent = numValue.toFixed(1);
        }

        // Validate range logic
        const minSlider = document.getElementById(`min-pti-slider-${seriesIndex}`);
        const maxSlider = document.getElementById(`max-pti-slider-${seriesIndex}`);
        
        if (minSlider && maxSlider) {
            const minValue = parseFloat(minSlider.value);
            const maxValue = parseFloat(maxSlider.value);
            
            // Ensure min doesn't exceed max
            if (type === 'min' && numValue >= maxValue) {
                maxSlider.value = numValue + 0.5;
                document.getElementById(`max-pti-value-${seriesIndex}`).textContent = (numValue + 0.5).toFixed(1);
            }
            
            // Ensure max doesn't go below min
            if (type === 'max' && numValue <= minValue) {
                minSlider.value = numValue - 0.5;
                document.getElementById(`min-pti-value-${seriesIndex}`).textContent = (numValue - 0.5).toFixed(1);
            }
        }

        // Visual feedback for changes
        const seriesControl = document.querySelector(`[data-series-id="${series.series_id}"]`);
        if (seriesControl) {
            seriesControl.style.borderColor = '#3b82f6';
            seriesControl.style.borderWidth = '2px';
        }
    }

    // Apply PTI range changes
    async function applyPTIRange(seriesIndex) {
        const series = seriesRanges[seriesIndex];
        if (!series) return;

        const minSlider = document.getElementById(`min-pti-slider-${seriesIndex}`);
        const maxSlider = document.getElementById(`max-pti-slider-${seriesIndex}`);
        
        if (!minSlider || !maxSlider) return;

        const newMin = parseFloat(minSlider.value);
        const newMax = parseFloat(maxSlider.value);

        // Validate range
        if (newMin >= newMax) {
            alert('Minimum PTI must be less than maximum PTI');
            return;
        }

        if (newMin < 10 || newMax > 80) {
            alert('PTI values must be between 10 and 80');
            return;
        }

        try {
            // Call API to update range
            const response = await fetch('/api/create-team/update-range', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    series_id: series.series_id,
                    series_name: series.series_name,
                    recommended_range: {
                        min: newMin,
                        max: newMax
                    }
                })
            });

            const result = await response.json();
            
            if (result.success) {
                // Update local data
                seriesRanges[seriesIndex].recommended_range = {
                    min: newMin,
                    max: newMax
                };

                // Visual feedback for success
                const seriesControl = document.querySelector(`[data-series-id="${series.series_id}"]`);
                if (seriesControl) {
                    seriesControl.style.borderColor = '#10b981';
                    seriesControl.style.borderWidth = '2px';
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'bg-green-100 border border-green-300 text-green-700 px-3 py-2 rounded text-sm mt-2';
                    successMsg.innerHTML = '<i class="fas fa-check mr-1"></i>Range updated successfully!';
                    seriesControl.appendChild(successMsg);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                        seriesControl.style.borderColor = '';
                        seriesControl.style.borderWidth = '';
                    }, 3000);
                }
            } else {
                alert('Failed to update PTI range: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating PTI range:', error);
            alert('Failed to update PTI range. Please try again.');
        }
    }

    // Reset PTI range to recommended values
    function resetPTIRange(seriesIndex) {
        const series = seriesRanges[seriesIndex];
        if (!series) return;

        const minSlider = document.getElementById(`min-pti-slider-${seriesIndex}`);
        const maxSlider = document.getElementById(`max-pti-slider-${seriesIndex}`);
        const minValue = document.getElementById(`min-pti-value-${seriesIndex}`);
        const maxValue = document.getElementById(`max-pti-value-${seriesIndex}`);
        
        if (minSlider && maxSlider && minValue && maxValue) {
            minSlider.value = series.recommended_range.min;
            maxSlider.value = series.recommended_range.max;
            minValue.textContent = series.recommended_range.min;
            maxValue.textContent = series.recommended_range.max;
            
            // Reset visual styling
            const seriesControl = document.querySelector(`[data-series-id="${series.series_id}"]`);
            if (seriesControl) {
                seriesControl.style.borderColor = '';
                seriesControl.style.borderWidth = '';
            }
        }
    }

    // Display series teams
    function displaySeriesTeams() {
        console.log('üîç displaySeriesTeams() called, series count:', seriesRanges.length);
        const container = document.getElementById('series-teams');
        console.log('üîç Series teams container element:', container);
        
        if (!container) {
            console.log('üîç ‚ùå Series teams container not found');
            return;
        }

        const teamsHtml = seriesRanges.map(series => `
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900">${series.series_name}</h3>
                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                        ${teamAssignments[series.series_name]?.length || 0}/${Math.ceil(series.player_count / 4)} teams possible
                    </span>
                </div>
                <div class="drop-zone min-h-16 border-2 border-dashed border-gray-300 rounded-lg p-3" 
                     data-series="${series.series_name}"
                     ondrop="handleDrop(event, '${series.series_name}')"
                     ondragover="handleDragOver(event)"
                     ondragenter="handleDragEnter(event)"
                     ondragleave="handleDragLeave(event)"
                     onclick="assignPlayerToSeries('${series.series_name}')">
                    <div id="team-${series.series_name}" class="flex flex-wrap gap-2">
                        ${teamAssignments[series.series_name] ? teamAssignments[series.series_name].map(player => `
                            <div class="player-card ${getPTIColorClass(player.pti)} border rounded px-2 py-1 text-xs">
                                ${player.name || `${player.first_name} ${player.last_name}`}
                                <div>PTI: ${player.pti ? player.pti.toFixed(1) : 'N/A'}</div>
                            </div>
                        `).join('') : '<div class="text-gray-400 text-sm">Tap to assign selected player</div>'}
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = teamsHtml;
        console.log('üîç ‚úÖ Series teams HTML set, length:', teamsHtml.length);
    }

    // Assign player to series (mobile tap interface)
    function assignPlayerToSeries(seriesName) {
        if (!selectedPlayerForTap) {
            alert('Please select a player first');
            return;
        }

        // Initialize team assignments if needed
        if (!teamAssignments[seriesName]) {
            teamAssignments[seriesName] = [];
        }

        // Check if player already assigned
        const existingIndex = teamAssignments[seriesName].findIndex(p => p.id === selectedPlayerForTap.id);
        if (existingIndex !== -1) {
            alert('Player already assigned to this series');
            return;
        }

        // Add player to series
        teamAssignments[seriesName].push(selectedPlayerForTap);

        // Remove player from available pool
        allPlayers = allPlayers.filter(p => p.id !== selectedPlayerForTap.id);

        // Clear selection
        clearSelection();

        // Refresh displays
        displayPlayers();
        displaySeriesTeams();
        updatePlayerCount();
    }

    // Clear player selection
    function clearSelection() {
        selectedPlayerForTap = null;
        document.querySelectorAll('.player-card').forEach(card => {
            card.classList.remove('selected');
        });
        document.getElementById('selected-player-indicator').classList.add('hidden');
    }

    // Update player count
    function updatePlayerCount() {
        const countElement = document.getElementById('player-count');
        if (countElement) {
            countElement.textContent = allPlayers.length;
        }
    }

    // This function is no longer needed since we're not using team size sliders
    // Keeping for backwards compatibility
    function updateTeamSize(seriesName, size) {
        console.log(`Team size update for ${seriesName}: ${size} (feature not implemented)`);
    }

    // Setup event listeners
    function setupEventListeners() {
        // Clear selection button
        document.getElementById('clear-selection')?.addEventListener('click', clearSelection);

        // Reset buttons
        document.getElementById('reset-players')?.addEventListener('click', () => {
            location.reload();
        });

        document.getElementById('reset-assignments')?.addEventListener('click', () => {
            teamAssignments = {};
            displaySeriesTeams();
        });

        document.getElementById('reset-teams')?.addEventListener('click', () => {
            location.reload();
        });

        // Save teams button
        document.getElementById('save-teams')?.addEventListener('click', saveTeams);
    }

    // Save teams functionality
    async function saveTeams() {
        try {
            // Transform team assignments to match API expectations
            const formattedTeams = {};
            for (const seriesName in teamAssignments) {
                const players = teamAssignments[seriesName];
                const totalPti = players.reduce((sum, player) => sum + (player.pti || 0), 0);
                
                formattedTeams[seriesName] = {
                    players: players,
                    total_pti: totalPti,
                    avg_pti: players.length > 0 ? totalPti / players.length : 0
                };
            }
            
            const response = await fetch('/api/create-team/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    teams: formattedTeams,
                    series_data: seriesRanges
                })
            });

            const data = await response.json();
            
            if (data.success) {
                alert('Teams saved successfully!');
            } else {
                throw new Error(data.error || 'Failed to save teams');
            }
        } catch (error) {
            console.error('Error saving teams:', error);
            alert('Failed to save teams. Please try again.');
        }
    }

    // Show content and hide loading (simplified)
    function showContent() {
        console.log('üîç showContent() called - hiding loading state');
        const loadingState = document.getElementById('loading-state');
        
        if (loadingState) {
            loadingState.style.display = 'none';
            console.log('üîç ‚úÖ Loading state hidden');
        }
        
        console.log('üîç showContent() complete - main content should now be visible');
    }

    // Show error message
    function showError(message) {
        console.log('üîç Showing error:', message);
        const loadingState = document.getElementById('loading-state');
        loadingState.innerHTML = `
            <div class="text-red-600 text-center max-w-md mx-auto">
                <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                <h3 class="text-lg font-semibold mb-2">Create Team Page Error</h3>
                <p class="text-sm mb-4">${message}</p>
                <div class="space-y-2">
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="location.reload()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-refresh mr-2"></i>
                            Refresh Page
                        </button>
                        <button onclick="window.forceShowContent()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-eye mr-2"></i>
                            Show Anyway
                        </button>
                        <button onclick="window.inspectDOM()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>
                            Inspect DOM
                        </button>
                        <button onclick="window.debugViewport()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            <i class="fas fa-desktop mr-2"></i>
                            Viewport
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-xs text-gray-500">
                    <p>Debug Info: Check browser console (F12) for detailed error logs</p>
                    <p>If this persists, please contact support with the error details</p>
                </div>
            </div>
        `;
    }

    // Drag and Drop Event Handlers
    let draggedPlayerId = null;

    function handleDragStart(event, playerId) {
        draggedPlayerId = playerId;
        const playerCard = event.target;
        
        // Add visual feedback for dragging
        playerCard.style.opacity = '0.5';
        playerCard.classList.add('dragging');
        
        // Set drag data
        event.dataTransfer.setData('text/plain', playerId);
        event.dataTransfer.effectAllowed = 'move';
        
        console.log('üîç Drag started for player:', playerId);
    }

    function handleDragEnd(event) {
        const playerCard = event.target;
        
        // Reset visual feedback
        playerCard.style.opacity = '';
        playerCard.classList.remove('dragging');
        
        // Reset all drop zones
        document.querySelectorAll('.drop-zone').forEach(zone => {
            zone.classList.remove('drop-zone-active', 'drop-zone-hover');
        });
        
        draggedPlayerId = null;
        console.log('üîç Drag ended');
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(event) {
        event.preventDefault();
        const dropZone = event.currentTarget;
        dropZone.classList.add('drop-zone-hover');
    }

    function handleDragLeave(event) {
        const dropZone = event.currentTarget;
        // Only remove hover if we're actually leaving the drop zone
        if (!dropZone.contains(event.relatedTarget)) {
            dropZone.classList.remove('drop-zone-hover');
        }
    }

    function handleDrop(event, seriesName) {
        event.preventDefault();
        const dropZone = event.currentTarget;
        dropZone.classList.remove('drop-zone-hover', 'drop-zone-active');
        
        const playerId = event.dataTransfer.getData('text/plain') || draggedPlayerId;
        if (!playerId) {
            console.log('üîç ‚ùå No player ID found in drop event');
            return;
        }

        console.log(`üîç Dropped player ${playerId} into series ${seriesName}`);
        
        // Find the player data
        const player = allPlayers.find(p => p.id === playerId);
        if (!player) {
            console.log('üîç ‚ùå Player not found for drag and drop');
            return;
        }

        // Use existing assignment logic
        assignPlayerToSeriesViaDrop(seriesName, player);
    }

    // Modified assignment function for drag and drop
    function assignPlayerToSeriesViaDrop(seriesName, player) {
        // Initialize team assignments if needed
        if (!teamAssignments[seriesName]) {
            teamAssignments[seriesName] = [];
        }

        // Check if player already assigned
        const existingIndex = teamAssignments[seriesName].findIndex(p => p.id === player.id);
        if (existingIndex !== -1) {
            // Show visual feedback for already assigned
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-100 border border-yellow-300 text-yellow-700 px-4 py-2 rounded-lg shadow-lg z-50';
            notification.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Player already assigned to this series';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
            return;
        }

        // Add player to series
        teamAssignments[seriesName].push(player);

        // Remove player from available pool
        allPlayers = allPlayers.filter(p => p.id !== player.id);

        // Clear any existing selection
        clearSelection();

        // Show success notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-100 border border-green-300 text-green-700 px-4 py-2 rounded-lg shadow-lg z-50';
        notification.innerHTML = `<i class="fas fa-check mr-2"></i>Assigned ${player.name} to ${seriesName}`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);

        // Refresh displays
        displayPlayers();
        displaySeriesTeams();
        updatePlayerCount();
        
        console.log(`üîç ‚úÖ Successfully assigned ${player.name} to ${seriesName} via drag and drop`);
    }

    // Make functions globally available
    window.selectPlayer = selectPlayer;
    window.assignPlayerToSeries = assignPlayerToSeries;
    window.updateTeamSize = updateTeamSize;
    window.handleDragStart = handleDragStart;
    window.handleDragEnd = handleDragEnd;
    window.handleDragOver = handleDragOver;
    window.handleDragEnter = handleDragEnter;
    window.handleDragLeave = handleDragLeave;
    window.handleDrop = handleDrop;

    // Debug functions
    window.forceShowContent = function() {
        console.log('üîç Force showing content...');
        showContent();
    };

    window.debugPageState = function() {
        console.log('üîç === PAGE DEBUG INFO ===');
        console.log('üîç Session data:', window.sessionData);
        console.log('üîç Players loaded:', allPlayers.length);
        console.log('üîç Sample players:', allPlayers.slice(0, 3));
        console.log('üîç Series loaded:', seriesRanges.length);
        console.log('üîç Sample series:', seriesRanges.slice(0, 2));
        console.log('üîç Team assignments:', teamAssignments);
        console.log('üîç Page elements:');
        console.log('  - loading-state:', document.getElementById('loading-state'));
        console.log('  - main-content:', document.getElementById('main-content'));
        console.log('  - available-players-pool:', document.getElementById('available-players-pool'));
        console.log('  - series-teams:', document.getElementById('series-teams'));
        console.log('üîç === END DEBUG INFO ===');
    };

    window.testAPIEndpoints = async function() {
        console.log('üîç === TESTING API ENDPOINTS ===');
        
        // Test players endpoint
        try {
            console.log('üîç Testing /api/create-team/players...');
            const playersResponse = await fetch('/api/create-team/players');
            console.log('üîç Players response status:', playersResponse.status);
            if (playersResponse.ok) {
                const playersData = await playersResponse.json();
                console.log('üîç Players data success:', playersData.success);
                console.log('üîç Players count:', playersData.players?.length || 0);
            } else {
                const errorText = await playersResponse.text();
                console.log('üîç Players error:', errorText);
            }
        } catch (error) {
            console.log('üîç Players fetch error:', error);
        }

        // Test series endpoint
        try {
            console.log('üîç Testing /api/create-team/analyze-series...');
            const seriesResponse = await fetch('/api/create-team/analyze-series');
            console.log('üîç Series response status:', seriesResponse.status);
            if (seriesResponse.ok) {
                const seriesData = await seriesResponse.json();
                console.log('üîç Series data success:', seriesData.success);
                console.log('üîç Series count:', seriesData.series_ranges?.length || 0);
            } else {
                const errorText = await seriesResponse.text();
                console.log('üîç Series error:', errorText);
            }
        } catch (error) {
            console.log('üîç Series fetch error:', error);
        }

        console.log('üîç === END API TESTS ===');
    };

    window.inspectDOM = function() {
        console.log('üîç === DOM INSPECTION ===');
        
        const elements = {
            'loading-state': document.getElementById('loading-state'),
            'main-content': document.getElementById('main-content'),
            'available-players-pool': document.getElementById('available-players-pool'),
            'series-recommendations': document.getElementById('series-recommendations'),
            'series-teams': document.getElementById('series-teams')
        };
        
        for (const [name, element] of Object.entries(elements)) {
            if (element) {
                const rect = element.getBoundingClientRect();
                const styles = window.getComputedStyle(element);
                console.log(`üîç ${name}:`, {
                    exists: true,
                    visible: styles.display !== 'none' && styles.visibility !== 'hidden',
                    display: styles.display,
                    visibility: styles.visibility,
                    opacity: styles.opacity,
                    classes: element.className,
                    rect: { width: rect.width, height: rect.height, top: rect.top, left: rect.left },
                    innerHTML_length: element.innerHTML.length
                });
            } else {
                console.log(`üîç ${name}: NOT FOUND`);
            }
        }
        
        console.log('üîç === END DOM INSPECTION ===');
    };

    window.debugViewport = function() {
        console.log('üîç === VIEWPORT DEBUG ===');
        
        console.log('üîç Window dimensions:', {
            innerWidth: window.innerWidth,
            innerHeight: window.innerHeight,
            scrollX: window.scrollX,
            scrollY: window.scrollY
        });
        
        console.log('üîç Document dimensions:', {
            documentHeight: document.documentElement.scrollHeight,
            documentWidth: document.documentElement.scrollWidth,
            bodyHeight: document.body.scrollHeight,
            bodyWidth: document.body.scrollWidth
        });
        
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            const rect = mainContent.getBoundingClientRect();
            console.log('üîç Main content position:', {
                top: rect.top,
                left: rect.left,
                bottom: rect.bottom,
                right: rect.right,
                width: rect.width,
                height: rect.height,
                isInViewport: rect.top >= 0 && rect.left >= 0 && rect.bottom <= window.innerHeight && rect.right <= window.innerWidth
            });
        }
        
        console.log('üîç === END VIEWPORT DEBUG ===');
    };

    // Comprehensive diagnostic function
    window.diagnose = function() {
        console.log('üîç === COMPREHENSIVE DIAGNOSTIC ===');
        console.log('üîç Starting full page diagnosis...');
        
        // Run all diagnostic functions
        console.log('\n1. Page State Check:');
        window.debugPageState();
        
        console.log('\n2. DOM Inspection:');
        window.inspectDOM();
        
        console.log('\n3. Viewport Check:');
        window.debugViewport();
        
        console.log('üîç === DIAGNOSTIC COMPLETE ===');
        console.log('üîç If content is still not visible, there may be a CSS or layout issue.');
        console.log('üîç Check the Network tab for any failed resource loads.');
    };

    // Simple fix function - makes content visible
    window.fixCreateTeamPage = function() {
        console.log('üîç === MAKING CONTENT VISIBLE ===');
        
        // Hide loading state
        const loadingState = document.getElementById('loading-state');
        if (loadingState) {
            loadingState.style.display = 'none';
            console.log('üîç ‚úÖ Loading state hidden');
        }
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Re-populate content if needed
        if (allPlayers.length > 0) {
            displayPlayers();
            console.log('üîç ‚úÖ Players re-displayed');
        }
        
        if (seriesRanges.length > 0) {
            displaySeriesControls();
            displaySeriesTeams();
            console.log('üîç ‚úÖ Series re-displayed');
        }
        
        console.log('üîç === CONTENT SHOULD NOW BE VISIBLE ===');
    };

    // Initialize page
    initializePage();
});
</script>
{% endblock %} 