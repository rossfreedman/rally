<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Rally{% endblock %}</title>
    <link rel="icon" type="image/png" href="/static/images/rally_favicon.png">
    
    <!-- Tailwind CSS (compiled) & DaisyUI -->
    <link href="/static/css/output.css" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    
    <!-- Plotly.js for graphs -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    
    <!-- App CSS and JS -->
    <link href="/static/mobile/css/style.css" rel="stylesheet">
    <script src="/static/js/activity-tracker.js" defer></script>
    <script src="/static/mobile/js/main.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Modern Navigation Drawer Styles */
        .nav-drawer {
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .nav-drawer.open {
            transform: translateX(0);
        }
        
        /* Apple-style blur and transparency */
        #navDrawer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Smooth hover effects for navigation links */
        .nav-link {
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 6px 8px;
            margin: -6px -8px;
            display: block;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.04);
            transform: translateX(2px);
        }
        
        /* Candy Box Item Styles */
        .candy-box-item {
            min-height: 85px;
            width: 100%;
            max-width: none;
            flex-shrink: 0;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            padding: 16px 12px !important;
            border-radius: 14px !important;
            transition: all 0.2s ease !important;
            text-decoration: none !important;
            position: relative;
        }
        
        .candy-box-item:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15) !important;
            text-decoration: none !important;
        }
        
        .candy-box-item i {
            font-size: 24px !important;
            margin-bottom: 8px !important;
            display: block !important;
        }
        
        .candy-box-item span {
            font-size: 12px !important;
            font-weight: 600 !important;
            line-height: 1.3 !important;
            display: block !important;
            color: #374151 !important;
        }
        
        /* Grid container styling */
        .candy-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 12px !important;
            width: 100% !important;
        }
        
        /* Section headers with subtle styling */
        h2 {
            letter-spacing: -0.02em;
        }
        
        /* Responsive adjustments - Keep 2 columns on mobile */
        @media (max-width: 768px) {
            .candy-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .candy-box-item {
                min-height: 80px !important;
                padding: 14px 10px !important;
            }
            
            .candy-box-item i {
                font-size: 22px !important;
                margin-bottom: 6px !important;
            }
            
            .candy-box-item span {
                font-size: 11px !important;
            }
            
            #navDrawer .max-w-lg {
                max-width: none;
                padding: 0 8px;
            }
        }
    </style>
    
    <!-- Session data will be injected here -->
    {% if session_data %}
    <script>
        window.sessionData = JSON.parse('{{ session_data|tojson|safe }}');
    </script>
    {% endif %}
</head>
<body class="min-h-screen bg-base-100 text-base-content">

    <!-- Top Bar -->
    <nav class="navbar bg-black shadow-md px-4 py-2 relative flex items-center" style="position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; height: 56px; box-shadow: 0 2px 8px rgba(0,0,0,0.08)">
        <!-- Left side -->
        <div class="flex items-center" style="flex: 1;">
            {% if show_back_arrow %}
                <a href="javascript:history.back()" class="back-arrow mr-3" aria-label="<">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
            {% endif %}
        </div>
        
        <!-- Center logo -->
        <div class="flex justify-center" style="flex: 1;">
            <a href="/mobile" class="navbar-logo">
                <img src="/static/images/rallylogo.png" alt="Rally Logo" class="h-10 w-auto">
            </a>
        </div>
        
        <!-- Right side -->
        <div class="flex items-center justify-end" style="flex: 1;">
            <button class="hamburger-btn" id="hamburgerToggle" aria-label="Open menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
        </div>
    </nav>

    <!-- Full-Width Modern Nav Drawer -->
    <div id="navDrawer" class="fixed top-0 right-0 h-full w-full bg-white z-50 transform translate-x-full transition-transform duration-300 drawer-right" style="transform: translateX(100%) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="flex flex-col h-full">
            <!-- Nav Drawer Top Bar -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100" style="background: rgba(255, 255, 255, 0.9);">
                <img src="/static/images/rallylogo.png" alt="Rally Logo" class="h-8">
                <button class="drawer-close w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center" aria-label="Close menu">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- Navigation Content -->
            <div class="flex-1 overflow-y-auto">
                <div class="px-4 py-6">
                    <!-- Candy Box Grid Layout -->
                    <div class="max-w-lg mx-auto">
                        
                        <!-- Act Section -->
                        <div class="mb-6">
                            <h2 class="text-lg font-bold mb-3 text-gray-800 text-center" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">Act</h2>
                            <div class="candy-grid">
                                <!-- Row 1 -->
                                <a href="/mobile/availability" class="candy-box-item bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-calendar text-blue-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">View Schedule</span>
                                </a>
                                <a href="/mobile/availability-calendar" class="candy-box-item bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-calendar-check text-blue-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Update Availability</span>
                                </a>
                                <a href="/mobile/track-byes-courts" class="candy-box-item bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-clipboard-check text-blue-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Track Assignments</span>
                                </a>
                                <!-- Row 2 -->
                                <a href="/mobile/polls" class="candy-box-item bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-poll text-blue-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Respond to Polls</span>
                                </a>
                                <a href="/mobile/reserve-court" class="candy-box-item bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-table-tennis text-blue-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Reserve Court</span>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Connect & Prepare Section (Combined for better layout) -->
                        <div class="mb-6">
                            <h2 class="text-lg font-bold mb-3 text-gray-800 text-center" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">Connect & Prepare</h2>
                            <div class="candy-grid">
                                <!-- Row 1 -->
                                <a href="/mobile/find-people-to-play" class="candy-box-item bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-user-friends text-purple-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Search Players</span>
                                </a>
                                <a href="/mobile/pickup-games" class="candy-box-item bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-calendar-plus text-purple-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Pickup Games</span>
                                </a>
                                <a href="/mobile/player-search" class="candy-box-item bg-gradient-to-br from-pink-50 to-pink-100 border border-pink-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-search text-pink-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Scout Players</span>
                                </a>
                                <!-- Row 2 -->
                                <a href="/mobile/teams-players" class="candy-box-item bg-gradient-to-br from-pink-50 to-pink-100 border border-pink-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-users text-pink-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Research Teams</span>
                                </a>
                                <a href="/mobile/matchup-simulator" class="candy-box-item bg-gradient-to-br from-pink-50 to-pink-100 border border-pink-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-chart-line text-pink-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Simulator</span>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Analyze Section -->
                        <div class="mb-6">
                            <h2 class="text-lg font-bold mb-3 text-gray-800 text-center" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">Analyze</h2>
                            <div class="candy-grid">
                                <!-- Row 1 -->
                                <a href="/mobile/analyze-me" class="candy-box-item bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-user text-indigo-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Me</span>
                                </a>
                                <a href="/mobile/myteam" class="candy-box-item bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-users text-indigo-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">My Team</span>
                                </a>
                                <a href="/mobile/myseries" class="candy-box-item bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-trophy text-indigo-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">My Series</span>
                                </a>
                                <!-- Row 2 -->
                                <a href="/mobile/my-club" class="candy-box-item bg-gradient-to-br from-indigo-50 to-indigo-100 border border-indigo-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-building text-indigo-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">My Club</span>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Improve Section -->
                        <div class="mb-6">
                            <h2 class="text-lg font-bold mb-3 text-gray-800 text-center" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">Improve</h2>
                            <div class="candy-grid">
                                <a href="/mobile/improve" class="candy-box-item bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-chart-bar text-green-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">My Game</span>
                                </a>
                                <a href="/mobile/schedule-lesson" class="candy-box-item bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-graduation-cap text-green-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Schedule Lesson</span>
                                </a>
                            </div>
                        </div>
                        
                        <!-- Settings Section -->
                        <div class="mb-6">
                            <h2 class="text-lg font-bold mb-3 text-gray-800 text-center" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;">Settings</h2>
                            <div class="candy-grid">
                                <a href="/mobile/settings" class="candy-box-item bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-cog text-gray-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Profile</span>
                                </a>
                                <a href="/admin" class="candy-box-item bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105">
                                    <i class="fas fa-shield-alt text-gray-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Admin</span>
                                </a>
                                <button onclick="logout()" class="candy-box-item bg-gradient-to-br from-red-50 to-red-100 border border-red-200 rounded-xl p-3 flex flex-col items-center text-center hover:shadow-md transition-all duration-200 hover:scale-105 w-full border-0">
                                    <i class="fas fa-sign-out-alt text-red-600 text-xl mb-2"></i>
                                    <span class="text-xs font-medium text-gray-700">Logout</span>
                                </button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay for nav drawer -->
    <div id="drawerOverlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>



    <!-- Global Impersonation Banner (shown on all pages when impersonating) -->
    <div id="global-impersonation-banner" class="hidden fixed top-14 left-0 right-0 bg-orange-500 text-white p-2 z-50 shadow-lg">
        <div class="flex items-center justify-center text-sm">
            <i class="fas fa-user-secret mr-2"></i>
            <span>Admin Mode: Impersonating <span id="global-impersonated-user-name" class="font-semibold"></span></span>
            <button onclick="stopGlobalImpersonation()" class="ml-4 bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 text-xs rounded transition-colors">
                Stop
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="container mx-auto px-2 py-6" id="main-content" style="padding-top: 72px; padding-bottom: 84px;">
        <!-- Player ID Missing Alert -->
        {% if session_data and session_data.user and session_data.authenticated and not session_data.user.tenniscores_player_id %}
        <div class="mb-4 p-3 rounded-lg shadow-sm" style="background-color: #F5C842; border: 1px solid #E5B332;">
            <div class="flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-amber-800"></i>
                <span class="text-sm text-gray-800">
                    <span class="font-bold">Alert:</span> <a href="/mobile/settings" class="link link-hover underline font-medium text-gray-900">click here</a> to update your profile with your correct club and/or series.
                </span>
            </div>
        </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom Navigation Dock -->
    <nav class="bottom-dock fixed bottom-0 left-0 right-0 bg-black border-t border-gray-700 z-40" style="height: 72px; box-shadow: 0 -2px 8px rgba(0,0,0,0.08);">
        <div class="flex items-center justify-around h-full px-2">
            <!-- Home -->
            <a href="/mobile" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-home text-xl mb-1 text-gray-400"></i>
                <span class="text-xs font-medium text-gray-400">Home</span>
            </a>
            
            <!-- Search -->
            <a href="/mobile/find-people-to-play" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-search text-xl mb-1 text-gray-400"></i>
                <span class="text-xs font-medium text-gray-400">Search</span>
            </a>
            
            <!-- Availability -->
            <a href="/mobile/availability-calendar" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-calendar text-xl mb-1 text-gray-400"></i>
                <span class="text-xs font-medium text-gray-400">Availability</span>
            </a>
            
            <!-- Profile -->
            <a href="/mobile/settings" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-user text-xl mb-1 text-gray-400"></i>
                <span class="text-xs font-medium text-gray-400">Profile</span>
            </a>
        </div>
    </nav>

    <script>
        // Initialize dock active state
        function updateDockActiveState() {
            const currentPath = window.location.pathname;
            const dockItems = document.querySelectorAll('.dock-item');
            
            // Remove active class from all items
            dockItems.forEach(item => item.classList.remove('active'));
            
            // Add active class to current page
            dockItems.forEach(item => {
                const itemPath = new URL(item.href).pathname;
                const icon = item.querySelector('i');
                
                // Handle specific routing logic
                if (currentPath === '/mobile' && itemPath === '/mobile') {
                    // Home page
                    item.classList.add('active');
                } else if (currentPath === '/mobile/availability-calendar' && itemPath === '/mobile/availability-calendar') {
                    // Availability calendar page
                    item.classList.add('active');
                } else if (currentPath === '/mobile/find-people-to-play' && itemPath === '/mobile/find-people-to-play') {
                    // Search page
                    item.classList.add('active');
                } else if (currentPath === '/mobile/settings' && itemPath === '/mobile/settings') {
                    // Profile/Settings page
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/settings') && itemPath === '/mobile/settings') {
                    // Profile/Settings related pages
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/find-people-to-play') && itemPath === '/mobile/find-people-to-play') {
                    // Find people to play related pages
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/pickup-games') && itemPath === '/mobile/find-people-to-play') {
                    // Pickup games page should also highlight search dock item
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/availability') && itemPath === '/mobile/availability-calendar') {
                    // Availability related pages
                    item.classList.add('active');
                }
            });
        }

        // Global impersonation status checking
        async function checkGlobalImpersonationStatus() {
            try {
                const response = await fetch('/api/admin/impersonation-status');
                const status = await response.json();
                
                if (status.is_impersonating) {
                    const banner = document.getElementById('global-impersonation-banner');
                    const userName = document.getElementById('global-impersonated-user-name');
                    const mainContent = document.getElementById('main-content');
                    
                    if (banner && userName && mainContent) {
                        const playerContext = status.impersonated_user.player_context;
                        const displayText = playerContext && playerContext.club && playerContext.series 
                            ? `${status.impersonated_user.first_name} ${status.impersonated_user.last_name} (${status.impersonated_user.email}) as ${playerContext.club.name}, ${playerContext.series.name}`
                            : `${status.impersonated_user.first_name} ${status.impersonated_user.last_name} (${status.impersonated_user.email})`;
                        userName.textContent = displayText;
                        banner.classList.remove('hidden');
                        // Adjust main content padding to account for banner
                        mainContent.style.paddingTop = '104px'; // 72px (nav) + 32px (banner)
                    }
                } else {
                    const banner = document.getElementById('global-impersonation-banner');
                    const mainContent = document.getElementById('main-content');
                    
                    if (banner && mainContent) {
                        banner.classList.add('hidden');
                        mainContent.style.paddingTop = '72px'; // Just nav padding
                    }
                }
            } catch (error) {
                console.error('Error checking global impersonation status:', error);
            }
        }

        // Stop impersonation from global banner
        async function stopGlobalImpersonation() {
            if (!confirm('Stop impersonation and return to your admin session?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/stop-impersonation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Impersonation stopped. Returning to admin session.');
                    window.location.reload();
                } else {
                    alert(`Failed to stop impersonation: ${result.error}`);
                }
            } catch (error) {
                console.error('Error stopping impersonation:', error);
                alert('Error stopping impersonation');
            }
        }

        // Global league switching function (available on all pages)
        function switchLeague(leagueId) {
            console.log(`ðŸ”„ Switching to league: ${leagueId}`);
            
            // Close the modal first (if it exists)
            const modal = document.getElementById('leagueSwitcherModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // Disable all league buttons during switch
            const leagueButtons = document.querySelectorAll('.league-switch-btn');
            leagueButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
            
            // Update trigger button to show loading (if it exists on this page)
            const trigger = document.getElementById('leagueSwitcherTrigger');
            if (trigger) {
                trigger.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
                trigger.disabled = true;
            }
            
            fetch('/api/switch-league', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    league_id: leagueId
                })
            })
            .then(response => {
                console.log(`ðŸ“¡ API Response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log(`ðŸ“Š API Response data:`, data);
                
                if (data.success) {
                    console.log(`âœ… Successfully switched to ${data.user.league_name}`);
                    
                    // Show success message on trigger (if it exists)
                    if (trigger) {
                        trigger.innerHTML = '<i class="fas fa-check text-xs text-green-400"></i>';
                    }
                    
                    // Reload the page after brief delay to show success
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    console.error('âŒ League switch failed:', data.error);
                    alert(`Failed to switch leagues: ${data.error || 'Unknown error'}`);
                    
                    // Reset buttons and trigger
                    leagueButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                    if (trigger) {
                        trigger.disabled = false;
                        trigger.innerHTML = '<i class="fas fa-edit text-sm"></i>';
                    }
                }
            })
            .catch(error => {
                console.error('âŒ League switch network error:', error);
                alert('Failed to switch leagues. Please check your connection and try again.');
                
                // Reset buttons and trigger
                leagueButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                if (trigger) {
                    trigger.disabled = false;
                    trigger.innerHTML = '<i class="fas fa-edit text-sm"></i>';
                }
            });
        }

        // Initialize drawer functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Set up dock active state
            updateDockActiveState();
            
            // Check impersonation status on page load
            checkGlobalImpersonationStatus();
            

            
            // Update dock state on navigation (for SPA-like behavior)
            window.addEventListener('popstate', updateDockActiveState);
            
            // Handle auto-scroll to bottom if scroll parameter is present
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('scroll') === 'bottom') {
                setTimeout(() => {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
            const drawer = document.getElementById('navDrawer');
            const overlay = document.getElementById('drawerOverlay');
            const hamburger = document.getElementById('hamburgerToggle');

            // EXPLICITLY ensure drawer is closed on page load
            if (drawer && overlay && hamburger) {
                drawer.style.transform = 'translateX(100%)';
                overlay.classList.add('hidden');
                hamburger.classList.remove('open');
                console.log('Drawer explicitly closed on page load with inline style');
                
                // Also do this after a short delay to ensure it overrides any other scripts
                setTimeout(() => {
                    drawer.style.transform = 'translateX(100%)';
                    overlay.classList.add('hidden');
                    hamburger.classList.remove('open');
                    console.log('Drawer ensured closed after delay with inline style');
                }, 100);
            }

            // Track drawer state
            let isDrawerTransitioning = false;
            let intentionalChange = false;

            // Watch for unwanted changes to the drawer
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && 
                        mutation.attributeName === 'style' && 
                        !intentionalChange &&
                        drawer.style.transform !== 'translateX(100%)') {
                        console.log('Unwanted drawer state change detected, forcing close');
                        drawer.style.transform = 'translateX(100%)';
                        overlay.classList.add('hidden');
                        hamburger.classList.remove('open');
                    }
                });
            });
            
            if (drawer) {
                observer.observe(drawer, { attributes: true, attributeFilter: ['style', 'class'] });
            }

            // Handle drawer toggle with debounce
            const toggleDrawer = debounce(function() {
                if (isDrawerTransitioning) return;
                isDrawerTransitioning = true;
                intentionalChange = true;

                const isOpen = drawer.style.transform === 'translateX(0px)' || drawer.style.transform === 'translateX(0%)';
                if (isOpen) {
                    drawer.style.transform = 'translateX(100%)';
                    overlay.classList.add('hidden');
                    hamburger.classList.remove('open');
                } else {
                    drawer.style.transform = 'translateX(0%)';
                    overlay.classList.remove('hidden');
                    hamburger.classList.add('open');
                }

                // Reset transition state after animation completes
                setTimeout(() => {
                    isDrawerTransitioning = false;
                    intentionalChange = false;
                }, 300); // Match transition duration
            }, 100);

            // Debounce function for handlers
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Event delegation for drawer controls
            document.addEventListener('click', function(e) {
                // Stop if drawer is transitioning
                if (isDrawerTransitioning) {
                    e.preventDefault();
                    return;
                }

                const target = e.target;

                // Handle hamburger button
                if (target.closest('#hamburgerToggle')) {
                    e.preventDefault();
                    toggleDrawer();
                    return;
                }

                // Handle drawer close button
                if (target.closest('.drawer-close')) {
                    e.preventDefault();
                    toggleDrawer();
                    return;
                }

                // Handle overlay click
                if (target.matches('#drawerOverlay')) {
                    e.preventDefault();
                    toggleDrawer();
                    return;
                }

                // Handle navigation links ONLY inside the drawer
                const navLink = target.closest('.nav-link, .candy-box-item');
                if (navLink && navLink.closest('#navDrawer')) {
                    // Let activity-tracker.js handle the click tracking
                    // Just close the drawer and let the navigation happen naturally
                    intentionalChange = true;
                    drawer.style.transform = 'translateX(100%)';
                    overlay.classList.add('hidden');
                    hamburger.classList.remove('open');
                    setTimeout(() => { intentionalChange = false; }, 300);
                    return;
                }
            });
        });
    </script>

    <script src="/static/js/navbar.js"></script>
    <script src="/static/js/league-context-manager.js"></script>

</body>
</html> 