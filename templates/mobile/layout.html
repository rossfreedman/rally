<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>{% block title %}Rally{% endblock %}</title>
    
    <!-- Theme Color - set to teal so it blends with our header -->
    <meta name="theme-color" content="#045454">
    <meta name="msapplication-navbutton-color" content="#045454">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/images/rally_favicon.png?v=2025">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon-green-small.png') }}?v=2025">
    
    <!-- Cache Control Meta Tags -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Basic Meta Tags -->
    <meta name="description" content="{% block meta_description %}One app to run your season. Built by players, for players.{% endblock %}">
    <meta name="author" content="Rally">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="{% block og_title %}Rally{% endblock %}">
    <meta property="og:description" content="{% block og_description %}One app to run your season. Built by players, for players.{% endblock %}">
    <meta property="og:image" content="https://www.lovetorally.com/preview.png?v=3">
    <meta property="og:image:secure_url" content="https://www.lovetorally.com/preview.png?v=3">
    <meta property="og:image:alt" content="Rally - Platform Tennis Management">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:site_name" content="Rally">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}Rally{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}One app to run your season. Built by players, for players.{% endblock %}">
    <meta name="twitter:image" content="https://www.lovetorally.com/preview.png?v=3">
    <meta name="twitter:image:alt" content="Rally - Platform Tennis Management">
    <meta name="twitter:site" content="@rally">
    <meta name="twitter:creator" content="@rally">
    
    <!-- Additional Social Media Tags -->
    <meta property="fb:app_id" content="">
    <meta name="application-name" content="Rally">
    <meta name="apple-mobile-web-app-title" content="Rally">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    
    <!-- iOS Icon Cache Control -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://lovetorally.com{{ request.path }}">
    
    <!-- Tailwind CSS (compiled) & DaisyUI -->
    <link href="/static/css/output.css" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    
    <!-- Plotly.js for graphs -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    
    <!-- App CSS and JS -->
    <link href="/static/mobile/css/style.css?v=2025" rel="stylesheet">
    <!-- Additive responsive layer -->
    <link href="/static/css/responsive.css?v=2025" rel="stylesheet">
    
    <!-- Tailwind CSS for main-alt page -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rally-dark-green': '#045454',
                        'rally-bright-green': '#bff863',
                    }
                }
            }
        }
    </script>
    <script src="/static/js/activity-tracker.js?v=2025" defer></script>
    <script src="/static/mobile/js/main.js?v=2025" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Database Switching Script -->
    <script>
        function switchDatabase() {
            const currentMode = '{{ get_database_mode() }}';
            const newMode = currentMode === 'test' ? 'main' : 'test';
            
            // Show confirmation dialog
            const confirmMessage = `Switch from ${currentMode.toUpperCase()} to ${newMode.toUpperCase()} database?\n\nThis will restart the server.`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '⏳ Switching...';
            button.disabled = true;
            button.style.opacity = '0.7';
            
            // Make API call to switch database
            fetch('/api/switch-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    database_mode: newMode
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    button.innerHTML = '✅ Switched!';
                    button.style.backgroundColor = newMode === 'test' ? '#fbbf24' : '#10b981';
                    
                    // Reload page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Failed to switch database');
                }
            })
            .catch(error => {
                console.error('Database switch error:', error);
                button.innerHTML = '❌ Failed';
                button.style.backgroundColor = '#ef4444';
                
                // Reset button after error
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.backgroundColor = currentMode === 'test' ? '#fbbf24' : '#10b981';
                }, 2000);
            });
        }
    </script>

    <style>
        /* Modern Navigation Drawer Styles */
        .nav-drawer {
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }
        .nav-drawer.open {
            transform: translateX(0);
        }
        
        /* Apple-style blur and transparency */
        #navDrawer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        
        /* Smooth hover effects for navigation links */
        .nav-link {
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 6px 8px;
            margin: -6px -8px;
            display: block;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-link:hover {
            background-color: rgba(0, 0, 0, 0.04);
            transform: translateX(2px);
        }
        
        /* Candy Box Item Styles */
        .candy-box-item {
            min-height: 95px;
            width: 100%;
            max-width: none;
            flex-shrink: 0;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            padding: 18px 12px !important;
            border-radius: 14px !important;
            transition: all 0.2s ease !important;
            text-decoration: none !important;
            position: relative;
        }
        
        .candy-box-item:hover {
            transform: scale(1.05) !important;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15) !important;
            text-decoration: none !important;
        }
        
        .candy-box-item i {
            font-size: 31px !important;
            margin-bottom: 8px !important;
            display: block !important;
        }
        
        .candy-box-item span {
            font-size: 16px !important;
            font-weight: 600 !important;
            line-height: 1.3 !important;
            display: block !important;
            color: #374151 !important;
        }
        
        /* Grid container styling */
        .candy-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 12px !important;
            width: 100% !important;
        }
        
        /* Scroll Indicator Styles */
        .scroll-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 60;
            opacity: 0;
            visibility: hidden;
        }
        
        .scroll-indicator.show {
            opacity: 1;
            visibility: visible;
        }
        
        .scroll-indicator:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateX(-50%) scale(1.05);
        }
        
        .scroll-indicator-content {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .scroll-indicator i {
            font-size: 10px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-2px);
            }
        }
        
        /* Section headers with subtle styling */
        h2 {
            letter-spacing: -0.02em;
        }
        
        /* Rally logo styling - removed color filter to show original colors */
        .rally-logo {
            transform: translateY(3px);
        }
        
        /* Bottom dock icons and text styling */
        .dock-item i,
        .dock-item span {
            color: #000000 !important;
        }
        
        /* Mobile Footer Positioning - Alternative Approach */
        .bottom-dock {
            position: fixed !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 99999 !important;
            transform: none !important;
            -webkit-transform: none !important;
            contain: layout style paint !important;
            isolation: isolate !important;
            -webkit-backface-visibility: hidden !important;
            backface-visibility: hidden !important;
            -webkit-perspective: 1000px !important;
            perspective: 1000px !important;
            will-change: auto !important;
        }
        
        /* Force footer to stay in place with absolute positioning fallback */
        @media (max-width: 768px) {
            html {
                height: 100% !important;
                overflow-x: hidden !important;
                position: relative !important;
            }
            
            body {
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow-x: hidden !important;
                position: relative !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            /* Main content area with bottom padding to prevent overlap */
        main {
            padding-bottom: 80px !important;
            min-height: calc(100dvh - 80px) !important;
            position: relative !important;
            z-index: 1 !important;
        }
            
            /* Ensure footer is completely isolated from document flow */
            .bottom-dock {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 72px !important;
                z-index: 99999 !important;
                transform: none !important;
                -webkit-transform: none !important;
                contain: layout style paint !important;
                isolation: isolate !important;
                -webkit-backface-visibility: hidden !important;
                backface-visibility: hidden !important;
                -webkit-perspective: 1000px !important;
                perspective: 1000px !important;
                will-change: auto !important;
                /* Force hardware acceleration without transforms */
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
                /* Remove any margin/padding that might affect positioning */
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
            }
            
            /* Prevent any parent elements from affecting positioning */
            .bottom-dock * {
                position: relative !important;
                z-index: inherit !important;
            }
        }
        
        /* iOS Safari specific containment */
        @supports (-webkit-touch-callout: none) {
            .bottom-dock {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                transform: none !important;
                -webkit-transform: none !important;
                contain: layout style paint !important;
                isolation: isolate !important;
                -webkit-backface-visibility: hidden !important;
                backface-visibility: hidden !important;
            }
        }
        
        /* Active state for dock items */
        .dock-item.active i,
        .dock-item.active span {
            color: #000000 !important;
        }
        
        /* Hamburger Menu Styles (matching home_submenu) - COMPACT VERSION - ONLY FOR DRAWER */
        #navDrawer .category-section {
            width: 100% !important;
            max-width: 100% !important;
            margin-bottom: 0 !important;
            position: relative !important;
            z-index: 15 !important;
            overflow: visible !important;
            isolation: isolate !important;
        }
        
        #navDrawer .space-y-2 > * + * {
            margin-top: 0.75rem !important;
        }
        
        /* Ensure consistent spacing for all buttons */
        #navDrawer .space-y-2 > .category-section {
            margin-bottom: 0.75rem !important;
        }
        
        #navDrawer .space-y-2 > .category-section:last-child {
            margin-bottom: 0 !important;
        }
        
        #navDrawer .category-button {
            background: #fff !important;
            border-radius: 0.75rem !important;
            border: 1px solid #E0E0E0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
            color: #045454 !important;
            font-weight: 500 !important;
            transition: all 0.3s ease;
            padding: 0.75rem 1rem !important;
            width: 100%;
            text-align: left;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            z-index: 10 !important;
            min-height: 48px !important;
            gap: 0.75rem;
            cursor: pointer !important;
        }
        
        #navDrawer .category-button svg {
            flex-shrink: 0;
            width: 1.5rem !important;
            height: 1.5rem !important;
            margin: 0 !important;
        }
        
        #navDrawer .category-button div {
            flex: 1;
            margin: 0 !important;
        }
        #navDrawer .category-button * { color: #045454 !important; font-weight: 500 !important; }
        #navDrawer .category-button:active { transform: scale(0.97); background: #f2f2f7 !important; box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important; }
        #navDrawer .category-button:hover { background: #f2f2f7 !important; box-shadow: 0 6px 20px rgba(0,0,0,0.12) !important; color: #045454 !important; border-color: #E0E0E0 !important; }
        #navDrawer .category-button:hover * { color: #045454 !important; }
        
        /* Ensure all category buttons are fully clickable */
        #navDrawer .category-button {
            pointer-events: auto !important;
            position: relative !important;
            z-index: 20 !important;
            cursor: pointer !important;
        }
        
        /* Make sure child elements don't interfere with clicks - ONLY for button elements */
        #navDrawer button.category-button svg,
        #navDrawer button.category-button div,
        #navDrawer button.category-button span {
            pointer-events: none !important;
            user-select: none !important;
        }
        
        /* For anchor tags, allow all pointer events */
        #navDrawer a.category-button,
        #navDrawer a.category-button *  {
            pointer-events: auto !important;
        }
        
        /* Ensure the button area is fully clickable - DISABLED FOR TESTING */
        /*
        #navDrawer .category-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            pointer-events: none;
        }
        */
        
        /* Force Availability button to be fully clickable - DISABLED FOR TESTING */
        /*
        #navDrawer .category-button[href*="availability-calendar"]::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 50;
            pointer-events: auto;
            background: transparent;
        }
        */
        
        /* Ensure direct-link buttons are fully clickable */
        #navDrawer .category-button[onclick*="window.location.href"] {
            height: auto !important;
            min-height: 48px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: flex-start !important;
            width: 100% !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 25 !important;
        }
        
        /* Specific fix for Availability button */
        #navDrawer .category-button[href*="availability-calendar"] {
            z-index: 30 !important;
            pointer-events: auto !important;
            position: relative !important;
            overflow: visible !important;
        }
        
        /* Ensure no overlapping elements interfere */
        #navDrawer .category-section:nth-child(2) {
            z-index: 100 !important;
            position: relative !important;
        }
        
        #navDrawer .category-section:nth-child(2) .category-button {
            z-index: 100 !important;
            pointer-events: auto !important;
            position: relative !important;
        }
        
        #navDrawer .category-section:nth-child(3) {
            z-index: 20 !important;
            position: relative !important;
        }
        
        #navDrawer .category-section:nth-child(3) .category-button {
            z-index: 35 !important;
            pointer-events: auto !important;
        }
        
        /* Force Home button to match other buttons exactly - COMPACT VERSION - ONLY FOR DRAWER */
        #navDrawer .category-section:first-child {
            overflow: hidden !important;
            max-height: 48px !important;
        }
        
        #navDrawer .category-section:first-child .category-button {
            background: #fff !important;
            color: #045454 !important;
            border-color: #E0E0E0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
            padding: 0.75rem 1rem !important;
            width: 100% !important;
            min-height: 48px !important;
            height: auto !important;
            text-align: left !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            border-radius: 0.75rem !important;
            border: 1px solid #E0E0E0 !important;
            margin: 0 !important;
            max-width: 100% !important;
            font-size: inherit !important;
            line-height: inherit !important;
            gap: 0.75rem !important;
        }
        #navDrawer .category-section:first-child .category-button * {
            color: #045454 !important;
        }
        #navDrawer .category-section:first-child .category-button svg {
            color: #045454 !important;
        }
        #navDrawer .category-section:first-child .category-button:hover {
            background: #f2f2f7 !important;
            color: #045454 !important;
            border-color: #E0E0E0 !important;
        }
        #navDrawer .category-section:first-child .category-button:hover * {
            color: #045454 !important;
        }
        
        /* Active category button styling when submenu is open - Reversed colors - COMPACT - ONLY FOR DRAWER */
        #navDrawer .category-button.active {
            background: #045454 !important;
            border-color: #045454 !important;
            color: #bff863 !important;
            box-shadow: 0 3px 12px rgba(4, 84, 84, 0.3) !important;
            /* Ensure consistent sizing for active state - COMPACT */
            padding: 0.75rem 1rem !important;
            width: 100% !important;
            text-align: left !important;
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            justify-content: flex-start !important;
            gap: 0.75rem !important;
            min-height: 48px !important;
            /* Animation effects */
            transform: translateX(4px) !important;
            transition: all 0.3s ease !important;
        }
        #navDrawer .category-button.active:not([onclick*="'/mobile'"]) * { 
            color: #bff863 !important; 
        }
        #navDrawer .category-button.active:not([onclick*="'/mobile'"]) svg { 
            color: #bff863 !important; 
        }
        
          /* Captain's Corner button off state - very light green background - ONLY FOR DRAWER */
  #navDrawer .category-button[onclick*="captain"] {
    background: #f0f9f0 !important;
    border-color: #d4edda !important;
  }
        
        /* Captain's Corner button active state - dark green background - ONLY FOR DRAWER */
        #navDrawer .category-button[onclick*="captain"].active {
            background: #045454 !important;
            border-color: #045454 !important;
            color: #bff863 !important;
        }
        #navDrawer .category-button[onclick*="captain"].active * {
            color: #bff863 !important;
        }
        #navDrawer .category-button[onclick*="captain"].active svg {
            color: #bff863 !important;
        }
        #navDrawer .submenu { 
            display: block !important; 
            background: transparent; 
            margin-top: 5px !important; 
            overflow: hidden !important;
            visibility: visible !important;
            opacity: 0 !important;
            height: 0 !important;
            max-height: 0 !important;
            transform: translateY(-20px) scale(0.95) !important;
            transition: max-height 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55), 
                        opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            -webkit-transform: translateY(-20px) scale(0.95) !important;
            -webkit-transition: max-height 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55), 
                        opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                        -webkit-transform 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            z-index: 5 !important;
            position: relative;
            pointer-events: none !important;
        }
        #navDrawer .submenu.active { 
            display: block !important; 
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            max-height: 800px !important;
            transform: translateY(0) scale(1) !important;
            -webkit-transform: translateY(0) scale(1) !important;
            pointer-events: auto !important;
        }
        #navDrawer .submenu-item { 
            display: flex; 
            flex-direction: row; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 0.75rem 1rem; 
            margin-bottom: 0.375rem;
            border-radius: 0.75rem;
            border: 1px solid #E0E0E0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            text-decoration: none; 
            color: white !important; 
            transition: all 0.3s ease !important;
            text-align: left;
            min-height: 48px;
            background: #797979 !important;
            transform: translateY(-10px) !important;
            opacity: 0 !important;
            position: relative;
            gap: 0.75rem;
        }
        #navDrawer .submenu-item:last-child { margin-bottom: 0; }
        
        /* Active state for submenu items - ONLY FOR DRAWER */
        #navDrawer .submenu.active .submenu-item {
            transform: translateY(0) scale(1) !important;
            opacity: 1 !important;
        }
        
        /* Staggered animation delays for submenu items - ONLY FOR DRAWER */
        #navDrawer .submenu.active .submenu-item:nth-child(1) { 
            transition-delay: 0.1s !important; 
        }
        #navDrawer .submenu.active .submenu-item:nth-child(2) { 
            transition-delay: 0.2s !important; 
        }
        #navDrawer .submenu.active .submenu-item:nth-child(3) { 
            transition-delay: 0.3s !important; 
        }
        #navDrawer .submenu.active .submenu-item:nth-child(4) { 
            transition-delay: 0.4s !important; 
        }
        #navDrawer .submenu.active .submenu-item:nth-child(5) { 
            transition-delay: 0.5s !important; 
        }
        #navDrawer .submenu.active .submenu-item:nth-child(6) { 
            transition-delay: 0.6s !important; 
        }
        #navDrawer .submenu-item:hover { 
            background-color: #f2f2f7; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            transform: scale(1.02);
        }
        #navDrawer .submenu-item:active { 
            transform: scale(0.97); 
            background: #f2f2f7; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        #navDrawer .submenu-item .icon { 
            width: 1.5rem; 
            height: 1.5rem; 
            margin-bottom: 0; 
            flex-shrink: 0;
            display: block;
            color: white !important;
        }
        #navDrawer .submenu-item .text { 
            font-weight: 500; 
            text-align: left;
            line-height: 1.3;
            color: white !important;
            flex: 1;
        }
        #navDrawer .submenu-item .arrow { 
            display: block;
            font-size: 1rem;
            color: white !important;
            margin-left: auto;
        }
        
        /* Submenu item styling when submenu is active - ONLY FOR DRAWER */
        body.submenu-active #navDrawer .submenu-item {
            background-color: #797979 !important;
            color: white !important;
            border-color: #E0E0E0 !important;
        }
        
        body.submenu-active #navDrawer .submenu-item:hover {
            background-color: #6b6b6b !important;
            border-color: #E0E0E0 !important;
        }
        
        body.submenu-active #navDrawer .submenu-item svg {
            color: white !important;
        }
        
        body.submenu-active #navDrawer .submenu-item .text {
            color: white !important;
        }
        
        /* Responsive adjustments - Keep 2 columns on mobile */
        @media (max-width: 768px) {
            .candy-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
            
            .candy-box-item {
                min-height: 90px !important;
                padding: 16px 10px !important;
            }
            
            .candy-box-item i {
                font-size: 29px !important;
                margin-bottom: 6px !important;
            }
            
            .candy-box-item span {
                font-size: 14px !important;
            }
            
            #navDrawer .max-w-lg {
                max-width: none;
                padding: 0 8px;
            }
        }
        
        /* Desktop-specific fix for second button clickability */
        @media (min-width: 768px) {
            #navDrawer .category-section:nth-child(2) {
                margin-top: 0.75rem !important;
                margin-bottom: 0.75rem !important;
                position: relative !important;
                z-index: 100 !important;
                overflow: visible !important;
            }
            
            #navDrawer .category-section:nth-child(2) .category-button {
                position: relative !important;
                z-index: 100 !important;
                pointer-events: auto !important;
            }
        }
        
        /* Desktop responsive constraints for hamburger menu - keep mobile button sizes - ONLY FOR DRAWER */
        @media (min-width: 768px) {
            #navDrawer .space-y-4 {
                max-width: 500px !important;
                margin: 0 auto !important;
            }
            
            #navDrawer .category-section {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #navDrawer .category-button {
                max-width: 100% !important;
                margin: 0 !important;
            }
            
            /* Force Home button to match other buttons on desktop - COMPACT - ONLY FOR DRAWER */
            #navDrawer .category-section:first-child .category-button {
                background: #fff !important;
                color: #045454 !important;
                border-color: #E0E0E0 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
                padding: 0.75rem 1rem !important;
                width: 100% !important;
                min-height: 48px !important;
                height: auto !important;
                text-align: left !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-start !important;
                border-radius: 0.75rem !important;
                border: 1px solid #E0E0E0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                font-size: inherit !important;
                line-height: inherit !important;
                gap: 0.75rem !important;
            }
            #navDrawer .category-section:first-child .category-button * {
                color: #045454 !important;
            }
            #navDrawer .category-section:first-child .category-button svg {
                color: #045454 !important;
            }
            #navDrawer .category-section:first-child .category-button:hover {
                background: #f2f2f7 !important;
                color: #045454 !important;
                border-color: #E0E0E0 !important;
            }
            #navDrawer .category-section:first-child .category-button:hover * {
                color: #045454 !important;
            }
            
            #navDrawer .submenu-item {
                max-width: 100% !important;
                margin: 0 0 0.5rem 0 !important;
            }
            
            #navDrawer .px-4 {
                padding-left: 2rem !important;
                padding-right: 2rem !important;
            }
        }
        
        /* Large desktop constraints for hamburger menu - keep mobile button sizes - ONLY FOR DRAWER */
        @media (min-width: 1024px) {
            #navDrawer .space-y-4 {
                max-width: 500px !important;
                margin: 0 auto !important;
            }
            
            #navDrawer .category-section {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #navDrawer .category-button {
                max-width: 100% !important;
            }
            
            /* Force Home button to match other buttons on large desktop - COMPACT - ONLY FOR DRAWER */
            #navDrawer .category-section:first-child .category-button {
                background: #fff !important;
                color: #045454 !important;
                border-color: #E0E0E0 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
                padding: 0.75rem 1rem !important;
                width: 100% !important;
                min-height: 48px !important;
                height: auto !important;
                text-align: left !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-start !important;
                border-radius: 0.75rem !important;
                border: 1px solid #E0E0E0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                font-size: inherit !important;
                line-height: inherit !important;
                gap: 0.75rem !important;
            }
            #navDrawer .category-section:first-child .category-button * {
                color: #045454 !important;
            }
            #navDrawer .category-section:first-child .category-button svg {
                color: #045454 !important;
            }
            #navDrawer .category-section:first-child .category-button:hover {
                background: #f2f2f7 !important;
                color: #045454 !important;
                border-color: #E0E0E0 !important;
            }
            #navDrawer .category-section:first-child .category-button:hover * {
                color: #045454 !important;
            }
            
            #navDrawer .submenu-item {
                max-width: 100% !important;
            }
        }
        
        /* Extra large desktop constraints for hamburger menu - keep mobile button sizes - ONLY FOR DRAWER */
        @media (min-width: 1280px) {
            #navDrawer .space-y-4 {
                max-width: 500px !important;
                margin: 0 auto !important;
            }
            
            #navDrawer .category-section {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            #navDrawer .category-button {
                max-width: 100% !important;
            }
            
            /* Force Home button to match other buttons on extra large desktop - COMPACT - ONLY FOR DRAWER */
            #navDrawer .category-section:first-child .category-button {
                background: #fff !important;
                color: #045454 !important;
                border-color: #E0E0E0 !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06) !important;
                padding: 0.75rem 1rem !important;
                width: 100% !important;
                min-height: 48px !important;
                height: auto !important;
                text-align: left !important;
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-start !important;
                border-radius: 0.75rem !important;
                border: 1px solid #E0E0E0 !important;
                margin: 0 !important;
                max-width: 100% !important;
                font-size: inherit !important;
                line-height: inherit !important;
                gap: 0.75rem !important;
            }
            #navDrawer .category-section:first-child .category-button * {
                color: #045454 !important;
            }
            #navDrawer .category-section:first-child .category-button svg {
                color: #045454 !important;
            }
            #navDrawer .category-section:first-child .category-button:hover {
                background: #f2f2f7 !important;
                color: #045454 !important;
                border-color: #E0E0E0 !important;
            }
            #navDrawer .category-section:first-child .category-button:hover * {
                color: #045454 !important;
            }
            
            #navDrawer .submenu-item {
                max-width: 100% !important;
            }
        }
    </style>
    
    <!-- Session data will be injected here -->
    {% if session_data %}
    <script>
        window.sessionData = JSON.parse('{{ session_data|tojson|safe }}');
    </script>
    {% endif %}
</head>
<body class="min-h-screen bg-base-100 text-base-content">

    <!-- Top Bar -->
    <header class="navbar shadow-md px-4 py-2 relative flex items-center" style="position: fixed; top: 0; left: 0; width: 100%; z-index: 100000; padding-top: max(0.5rem, env(safe-area-inset-top)); padding-left: max(1rem, env(safe-area-inset-left)); padding-right: max(1rem, env(safe-area-inset-right)); min-height: 56px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); background-color: #045454;">
        <!-- Left side -->
        <div class="flex items-center" style="flex: 1;">
            {% if show_back_arrow %}
                <a href="javascript:history.back()" class="back-arrow mr-3" aria-label="<">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </a>
            {% endif %}
        </div>
        
        <!-- Center logo -->
        <div class="flex justify-center" style="flex: 1;">
            <a href="/mobile" class="navbar-logo">
                                        <img src="/static/rallylogo.png" alt="Rally Logo" class="w-auto rally-logo" style="height: 78px;">
            </a>
        </div>
        
        <!-- Right side -->
        <div class="flex items-center justify-end" style="flex: 1;">
            <!-- Database Indicator (Local Development Only - show only when in TEST mode) -->
            {% if config.get('ENV') == 'development' or request.host.startswith('localhost') or request.host.startswith('127.0.0.1') %}
                {% set db_mode = get_database_mode() %}
                {% if db_mode == 'test' %}
                <button onclick="switchDatabase()" 
                        class="database-indicator mr-3 px-2 py-1 rounded-full text-xs font-semibold bg-yellow-500 text-black hover:bg-yellow-400 transition-colors duration-200 cursor-pointer" 
                        title="Click to switch database (currently: TEST)">
                    🧪 TEST
                </button>
                {% endif %}
            {% endif %}
            
            <button class="hamburger-btn relative" id="hamburgerToggle" aria-label="Open menu" style="z-index: 100001; padding: 12px; margin: -12px; position: relative; touch-action: manipulation;">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
        </div>
    </header>


    <!-- Status Banner (below navigation) -->
    <div id="statusBanner" class="hidden fixed left-0 right-0 z-40" style="top: calc(56px + env(safe-area-inset-top, 0px)); background-color: #bff863; color: #045454; margin-bottom: 30px;">
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; gap: 16px;">
            <span id="statusBannerText" class="text-sm font-medium" style="line-height: 1.4; text-align: left; flex: 1;"></span>
            <a id="statusBannerButton" class="hidden" style="background-color: #045454; color: #bff863; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; white-space: nowrap; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Try it</a>
        </div>
    </div>

    <!-- Full-Width Modern Nav Drawer -->
    <div id="navDrawer" class="fixed top-0 right-0 h-full w-full bg-white z-50 transform translate-x-full transition-transform duration-300 drawer-right" style="transform: translateX(100%) !important; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="flex flex-col h-full">
            <!-- Nav Drawer Top Bar -->
            <div class="px-6 py-4 border-b border-gray-100" style="background: rgba(255, 255, 255, 0.9); margin-top: 60px;">
                <!-- Top bar without logout button -->
            </div>
            
            <!-- Navigation Content -->
            <div class="flex-1 overflow-y-auto" id="navContent">
                <div class="px-4 py-6">
                  <!-- Menu Separator -->
                  <div class="flex items-center justify-center mb-6" style="margin-top: -18px;">
                    <div class="flex-grow border-t-2 border-gray-400"></div>
                    <div class="section-header text-xl font-bold px-4 text-center">
                      Menu
                    </div>
                    <div class="flex-grow border-t-2 border-gray-400"></div>
                  </div>

                  
                  <!-- Single Column Navigation (COMPACT VERSION) -->
                  <div class="space-y-2" style="padding-bottom: 600px;">
                    <!-- Home Category -->
                    <div class="category-section">
                      <button class="category-button" onclick="window.location.href='/mobile'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" fill="none"/><polyline points="9,22 9,12 15,12 15,22" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Home</div>
                      </button>
                    </div>
                    
                    <!-- Schedule -->
                    <div class="category-section">
                      <button class="category-button" onclick="navigateWithLoading('/mobile/availability', 'Loading Schedule...')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="2"/></svg>
                        <div class="font-semibold text-base">Schedule</div>
                      </button>
                    </div>
                    
                    <!-- Availability -->
                    <div class="category-section">
                      <button class="category-button" onclick="navigateWithLoading('/mobile/availability-calendar', 'Loading Availability...')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="2"/><path d="M9 16l2 2 4-4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Availability</div>
                      </button>
                    </div>
                    
                    <!-- Polls -->
                    <div class="category-section">
                      <button class="category-button" onclick="window.location.href='/mobile/polls'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M8 12h8M8 16h8" stroke="currentColor" stroke-width="2"/><circle cx="8" cy="8" r="1" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="8" r="1" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="16" cy="8" r="1" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Polls</div>
                      </button>
                    </div>
                    <!-- Analyze Category -->
                    <div class="category-section">
                      <button class="category-button" onclick="toggleDrawerSubmenu('drawer-analyze-submenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18" stroke="currentColor" stroke-width="2" fill="none"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Analyze</div>
                      </button>
                      <div id="drawer-analyze-submenu" class="submenu">
                        <a href="/mobile/analyze-me" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2" fill="none"/><path d="M4 20v-2a4 4 0 014-4h8a4 4 0 014 4v2" stroke="currentColor" stroke-width="2"/></svg>
                          <span class="text">Me</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/myteam" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="4" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="16" cy="8" r="4" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 20v-2a4 4 0 014-4h2m8 0h2a4 4 0 014 4v2" stroke="currentColor" stroke-width="2"/></svg>
                          <span class="text">My Team</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/myseries" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 17l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">My Series</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/my-club" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z" stroke="currentColor" stroke-width="2" fill="none"/><polyline points="9,22 9,12 15,12 15,22" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">My Club</span><span class="arrow">→</span>
                        </a>
                      </div>
                    </div>
                    <!-- Prepare Category -->
                    <div class="category-section">
                      <button class="category-button" onclick="toggleDrawerSubmenu('drawer-prepare-submenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 17l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Prepare</div>
                      </button>
                      <div id="drawer-prepare-submenu" class="submenu">
                        <a href="/mobile/teams-players" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="12" r="2" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Scout Competition</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/matchup-simulator" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M16 3h5v5" stroke="currentColor" stroke-width="2" fill="none"/><path d="M4 20l16-16" stroke="currentColor" stroke-width="2" fill="none"/><path d="M21 16v5h-5" stroke="currentColor" stroke-width="2" fill="none"/><path d="M15 15l6 6" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Matchup Simulator</span><span class="arrow">→</span>
                        </a>
                        <!-- PTI Calculator button hidden -->
                      </div>
                    </div>
                    <!-- Play Category -->
                    <div class="category-section">
                      <button class="category-button" onclick="toggleDrawerSubmenu('drawer-play-submenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Play</div>
                      </button>
                      <div id="drawer-play-submenu" class="submenu">
                        <a href="/mobile/find-people-to-play" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/><path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Find Players</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/pickup-games" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="12" y1="4" x2="12" y2="20" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="8" x2="20" y2="8" stroke="currentColor" stroke-width="1.2"/><line x1="4" y1="16" x2="20" y2="16" stroke="currentColor" stroke-width="1.2"/><line x1="8" y1="4" x2="8" y2="20" stroke="currentColor" stroke-width="1"/><line x1="16" y1="4" x2="16" y2="20" stroke="currentColor" stroke-width="1"/></svg>
                          <span class="text">Pickup Games</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/create-sub-request" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Create Sub Request</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/active-sub-requests" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Active Sub Requests</span><span class="arrow">→</span>
                        </a>
                      </div>
                    </div>
                    <!-- Improve Category -->
                    <div class="category-section">
                      <button class="category-button" onclick="toggleDrawerSubmenu('drawer-improve-submenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18" stroke="currentColor" stroke-width="2" fill="none"/><path d="M6 16l3-3 3 3 6-6" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="6" cy="16" r="1" fill="currentColor"/><circle cx="9" cy="13" r="1" fill="currentColor"/><circle cx="12" cy="16" r="1" fill="currentColor"/><circle cx="18" cy="10" r="1" fill="currentColor"/></svg>
                        <div class="font-semibold text-base">Improve</div>
                      </button>
                      <div id="drawer-improve-submenu" class="submenu">
                        <a href="/mobile/improve" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18" stroke="currentColor" stroke-width="2" fill="none"/><path d="M6 16l3-3 3 3 6-6" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="6" cy="16" r="1" fill="currentColor"/><circle cx="9" cy="13" r="1" fill="currentColor"/><circle cx="12" cy="16" r="1" fill="currentColor"/><circle cx="18" cy="10" r="1" fill="currentColor"/></svg>
                          <span class="text">Improve My Game</span><span class="arrow">→</span>
                        </a>
                        <a href="/mobile/schedule-lesson" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 14l9-5-9-5-9 5 9 5z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 14v7" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 19c0-1.657 2.686-3 6-3s6 1.343 6 3" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Schedule Lesson</span><span class="arrow">→</span>
                        </a>
                      </div>
                    </div>
                    <!-- Support Button -->
                    <div class="category-section">
                      <button class="category-button" onclick="window.location.href='/mobile/support'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/>
                          <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" fill="none"/>
                          <path d="M12 3v3M12 18v3M3 12h3M18 12h3" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        <div class="font-semibold text-base">Support</div>
                      </button>
                    </div>
                    
                    <!-- Rally Merch Button -->
                    <div class="category-section">
                      <button class="category-button" onclick="window.location.href='/mobile/swag'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                        <div class="font-semibold text-base">Rally Merch</div>
                      </button>
                    </div>
                    
                    <!-- Captain's Corner Category -->
                    <div class="category-section">
                      <button class="category-button" onclick="toggleDrawerSubmenu('drawer-captain-submenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/><path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                        <div class="font-semibold text-base">Captain's Corner</div>
                      </button>
                      <div id="drawer-captain-submenu" class="submenu">

                        <a href="/mobile/team-schedule-grid" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="7" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 3v4M8 3v4M3 11h18" stroke="currentColor" stroke-width="2"/></svg>
                          <span class="text">Team Availability</span><span class="arrow">→</span>
                        </a>

                        <a href="/mobile/track-byes-courts" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="2" width="6" height="4" rx="1" stroke="currentColor" stroke-width="2" fill="none"/><rect x="4" y="6" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 10h6M9 14h6M9 18h2" stroke="currentColor" stroke-width="2"/></svg>
                          <span class="text">Track Assignments</span><span class="arrow">→</span>
                        </a>

                        <a href="/mobile/team-notifications" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <!-- Bell shape -->
                            <path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V4a2 2 0 10-4 0v1.341C7.67 7.165 6 9.388 6 12v2.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" stroke="currentColor" stroke-width="2" fill="none"/>
                            <!-- Bell clapper -->
                            <path d="M12 20a2 2 0 002-2H10a2 2 0 002 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                          </svg>
                          <span class="text">Team Notifications</span><span class="arrow">→</span>
                        </a>
                        


                        <a href="/mobile/find-subs" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="2" fill="none"/><path d="M2 18v-2a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3v2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M18 12v6" stroke="currentColor" stroke-width="2" fill="none"/><path d="M21 15h-6" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Find Subs</span><span class="arrow">→</span>
                        </a>
                        
                        <a href="/mobile/create-lineup" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="2" width="6" height="4" rx="1" stroke="currentColor" stroke-width="2" fill="none"/><rect x="4" y="6" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><line x1="8" y1="10" x2="16" y2="10" stroke="currentColor" stroke-width="2"/><line x1="8" y1="14" x2="16" y2="14" stroke="currentColor" stroke-width="2"/><line x1="8" y1="18" x2="12" y2="18" stroke="currentColor" stroke-width="2"/></svg>
                          <span class="text">Create & Send Lineup</span><span class="arrow">→</span>
                        </a>
                        
                        <a href="/mobile/practice-times" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2"/></svg>
                          <span class="text">Practice Times</span><span class="arrow">→</span>
                        </a>

                        <a href="/mobile/pairing-analysis" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none"/>
                            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none"/>
                          </svg>
                          <span class="text">Pairing Analysis</span><span class="arrow">→</span>
                        </a>

                        {% if session_data and session_data.user and session_data.user.is_admin %}
                        <a href="/mobile/admin" class="submenu-item">
                          <svg class="icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                          <span class="text">Admin</span><span class="arrow">→</span>
                        </a>

                        {% endif %}
                      </div>
                    </div>

                  </div>
                </div>
            </div>

            <script>
            // Drawer submenu toggle logic for hamburger menu
            function toggleDrawerSubmenu(submenuId) {
              const submenu = document.getElementById(submenuId);
              const allSubmenus = document.querySelectorAll('.submenu');
              const allCategoryButtons = document.querySelectorAll('.category-button');
              
              // Close all other submenus and remove active class from their buttons
              allSubmenus.forEach(menu => { 
                if (menu.id !== submenuId) { 
                  menu.classList.remove('active'); 
                } 
              });
              
              // Remove active class from all category buttons
              allCategoryButtons.forEach(button => {
                button.classList.remove('active');
              });
              
              // Toggle the current submenu
              const isActive = submenu.classList.toggle('active');
              
              // Add active class to the current category button if submenu is now active
              if (isActive) {
                const categoryButton = submenu.previousElementSibling;
                if (categoryButton && categoryButton.classList.contains('category-button')) {
                  categoryButton.classList.add('active');
                }
                
                // Add class to body to style submit buttons when submenu is active
                document.body.classList.add('submenu-active');
                
                // Enhanced scroll functionality for drawer content
                setTimeout(() => {
                  console.log('🔍 DRAWER SCROLL DEBUG: Submenu opened for', submenuId);
                  
                  // Get the drawer content area
                  const navContent = document.getElementById('navContent');
                  if (!navContent) {
                    console.log('⚠️ DRAWER SCROLL DEBUG: navContent not found');
                    return;
                  }
                  
                  // Find the category button that was clicked
                  const categoryButton = submenu.previousElementSibling;
                  if (categoryButton && categoryButton.classList.contains('category-button')) {
                    console.log('🔍 DRAWER SCROLL DEBUG: Found category button');
                    
                    try {
                      // Get the button's position relative to the drawer content
                      const buttonRect = categoryButton.getBoundingClientRect();
                      const navContentRect = navContent.getBoundingClientRect();
                      
                      // Calculate the button's position relative to the navContent
                      const buttonTopRelativeToNavContent = buttonRect.top - navContentRect.top + navContent.scrollTop;
                      
                      console.log(`📊 DRAWER SCROLL DEBUG: Button position relative to navContent: ${buttonTopRelativeToNavContent}px`);
                      console.log(`📊 DRAWER SCROLL DEBUG: Current navContent scroll: ${navContent.scrollTop}px`);
                      
                      // Calculate scroll position based on which section was clicked
                      let scrollTo;
                      let adjustment = 0;
                      
                      if (submenuId === 'drawer-captain-submenu') {
                        // Captain's Corner: scroll to show the submenu items, especially Practice Times
                        // Use a simple but effective approach - scroll to show the submenu with extra space
                        scrollTo = buttonTopRelativeToNavContent - 100; // Scroll up to show more of the submenu
                        console.log(`📊 DRAWER SCROLL DEBUG: Captain's Corner - scrolling to position ${scrollTo}px to show Practice Times`);
                      } else {
                        // All other submenus: scroll to show the button with some padding
                        scrollTo = buttonTopRelativeToNavContent - 50; // Scroll up to show more content
                        console.log(`📊 DRAWER SCROLL DEBUG: ${submenuId} button - scrolling to position ${scrollTo}px`);
                      }
                      
                      console.log(`📊 DRAWER SCROLL DEBUG: Scrolling navContent to position: ${scrollTo}px`);
                      
                      // Scroll the drawer content area
                      navContent.scrollTo({
                        top: Math.max(0, scrollTo), // Don't scroll above top
                        behavior: 'smooth'
                      });
                      
                      console.log('✅ DRAWER SCROLL DEBUG: Drawer content scroll initiated');
                      
                    } catch (error) {
                      console.error('❌ DRAWER SCROLL DEBUG: Scroll alignment failed:', error);
                      
                      // Fallback: try to scroll the button into view within the drawer
                      try {
                        categoryButton.scrollIntoView({
                          behavior: 'smooth',
                          block: 'center'
                        });
                        console.log('✅ DRAWER SCROLL DEBUG: Fallback scrollIntoView initiated');
                      } catch (fallbackError) {
                        console.error('❌ DRAWER SCROLL DEBUG: Fallback scrollIntoView also failed:', fallbackError);
                      }
                    }
                  } else {
                    console.log('⚠️ DRAWER SCROLL DEBUG: Category button not found');
                  }
                  
                }, 100); // Small delay to ensure submenu is rendered
              } else {
                // Remove class from body when submenu is closed
                document.body.classList.remove('submenu-active');
                console.log('🔍 SCROLL DEBUG: Submenu closed for', submenuId);
              }
            }
            
            // Regular submenu toggle logic for main page content (fallback for pages without their own implementation)
            function toggleSubmenu(submenuId) {
              console.log('🎯 MAIN PAGE TOGGLE SUBMENU:', submenuId);
              const submenu = document.getElementById(submenuId);
              const allSubmenus = document.querySelectorAll('.submenu');
              const allCategoryButtons = document.querySelectorAll('.category-button');
              
              // Close all other submenus and remove active class from their buttons
              allSubmenus.forEach(menu => { 
                if (menu.id !== submenuId) { 
                  menu.classList.remove('active'); 
                } 
              });
              
              // Remove active class from all category buttons
              allCategoryButtons.forEach(button => {
                button.classList.remove('active');
              });
              
              // Toggle the current submenu
              const isActive = submenu.classList.toggle('active');
              
              // Add active class to the current category button if submenu is now active
              if (isActive) {
                const categoryButton = submenu.previousElementSibling;
                if (categoryButton && categoryButton.classList.contains('category-button')) {
                  categoryButton.classList.add('active');
                }
                
                // Add class to body to style submit buttons when submenu is active
                document.body.classList.add('submenu-active');
                
                // Basic scroll functionality for main page content
                setTimeout(() => {
                  console.log('🔍 MAIN PAGE SCROLL DEBUG: Submenu opened for', submenuId);
                  
                  // Find the category button that was clicked
                  const categoryButton = submenu.previousElementSibling;
                  if (categoryButton && categoryButton.classList.contains('category-button')) {
                    try {
                      // Scroll to align the button with the navbar
                      categoryButton.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                      });
                      console.log('✅ MAIN PAGE SCROLL DEBUG: Scroll initiated');
                    } catch (error) {
                      console.error('❌ MAIN PAGE SCROLL DEBUG: Scroll failed:', error);
                    }
                  }
                }, 100);
              } else {
                // Remove class from body when submenu is closed
                document.body.classList.remove('submenu-active');
              }
            }
            </script>
            
            <!-- Scroll Indicator -->
            <!-- <div id="scrollIndicator" class="scroll-indicator">
                <div class="scroll-indicator-content">
                    <i class="fas fa-chevron-down"></i>
                    <span>More options below</span>
                </div>
            </div> -->
        </div>
    </div>

    <!-- Overlay for nav drawer -->
    <div id="drawerOverlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden" style="pointer-events: none;"></div>



    <!-- Global Impersonation Banner (shown on all pages when impersonating) -->
    <div id="global-impersonation-banner" class="hidden fixed top-14 left-0 right-0 bg-orange-500 text-white p-2 z-50 shadow-lg">
        <div class="flex items-center justify-center text-sm">
            <i class="fas fa-user-secret mr-2"></i>
            <span id="global-impersonation-text">Impersonating <span id="global-impersonated-user-name" class="font-semibold"></span></span>
            <button onclick="stopGlobalImpersonation()" class="ml-4 bg-orange-600 hover:bg-orange-700 text-white px-2 py-1 text-xs rounded transition-colors">
                Stop
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <main class="container mx-auto px-2 py-6" id="main-content" style="padding-top: 72px; padding-bottom: 250px;">
        <!-- Player ID Missing Alert -->
        {% if session_data and session_data.user and session_data.authenticated and not session_data.user.tenniscores_player_id %}
        <div class="mb-4 p-3 rounded-lg shadow-sm" style="background-color: #F5C842; border: 1px solid #E5B332;">
            <div class="flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-amber-800"></i>
                <span class="text-sm text-gray-800">
                    <span class="font-bold">Alert:</span> <a href="/mobile/settings" class="link link-hover underline font-medium text-gray-900">click here</a> to update your profile with your correct club and/or series.
                </span>
            </div>
        </div>
        {% endif %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- Get Support Floating Chip - HIDDEN -->
    <!-- <div style="position: fixed; bottom: 130px; left: 16px; z-index: 50;">
        <a href="/mobile/support" style="
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 8px 12px; 
            border-radius: 25px; 
            background: #bff863; 
            color: #045454; 
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
            width: 130px;
            min-width: 130px;
            max-width: 130px;
            height: 32px;
            min-height: 32px;
            max-height: 32px;
            white-space: nowrap;
            overflow: hidden;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fas fa-question-circle" style="margin-right: 6px; font-size: 12px; color: #045454; flex-shrink: 0;"></i>
            <span style="color: #045454; font-size: 10px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Rally Support</span>
        </a>
    </div> -->

    <!-- Share Rally Floating Chip (only shown on home page) -->
    {% if page_id == 'home' %}
    <div id="shareRallyChip" style="position: fixed; bottom: 85px; left: 16px; z-index: 50; transition: opacity 0.3s ease, transform 0.3s ease;">
        <a href="/mobile/share-rally" style="
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 8px 12px; 
            border-radius: 25px; 
            background: #bff863; 
            color: #045454; 
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
            width: 130px;
            min-width: 130px;
            max-width: 130px;
            height: 32px;
            min-height: 32px;
            max-height: 32px;
            white-space: nowrap;
            overflow: hidden;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            <i class="fas fa-share-alt" style="margin-right: 6px; font-size: 12px; color: #045454; flex-shrink: 0;"></i>
            <span style="color: #045454; font-size: 10px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Share Rally</span>
        </a>
    </div>
    {% endif %}

    <!-- Bottom Navigation Dock -->
    <nav class="bottom-dock" style="background-color: #045454; box-shadow: 0 -2px 8px rgba(0,0,0,0.08);">
        <div class="flex items-center justify-around h-full px-2" style="max-width: 600px; margin: 0 auto;">
            <!-- Home -->
            <a href="/mobile" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-xs font-medium">Home</span>
            </a>
            
            <!-- Search -->
            <a href="/mobile/find-people-to-play" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-search text-xl mb-1"></i>
                <span class="text-xs font-medium">Search</span>
            </a>
            
            <!-- Availability -->
            <a href="/mobile/availability-calendar" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-calendar text-xl mb-1"></i>
                <span class="text-xs font-medium">Availability</span>
            </a>
            
            <!-- Profile -->
            <a href="/mobile/settings" class="dock-item flex flex-col items-center justify-center flex-1 py-2 px-1 text-center transition-colors duration-200 hover:bg-gray-800 rounded-lg mx-1">
                <i class="fas fa-user text-xl mb-1"></i>
                <span class="text-xs font-medium">Profile</span>
            </a>
        </div>
    </nav>

    <!-- League Context Manager -->
    <script src="{{ url_for('static', filename='js/league-context-manager.js') }}"></script>
    
    <!-- Enhanced League/Team Context Manager -->
    <script src="{{ url_for('static', filename='js/enhanced-league-team-context-manager.js') }}"></script>

    <script>
        // Logout function
        function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear session data
                fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(() => {
                    // Redirect to login page
                    window.location.href = '/login';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    // Still redirect even if there's an error
                    window.location.href = '/login';
                });
            }
        }



        // Aggressive Mobile Footer Positioning Fix
        let footerPositionCheckInterval;
        let lastScrollY = window.scrollY;
        
        function forceFooterFixed() {
            const footer = document.querySelector('.bottom-dock');
            if (footer) {
                // Remove any existing transforms that might interfere
                footer.style.transform = 'none';
                footer.style.webkitTransform = 'none';
                
                // Force fixed positioning with containment
                footer.style.position = 'fixed';
                footer.style.bottom = '0';
                footer.style.left = '0';
                footer.style.right = '0';
                footer.style.width = '100%';
                footer.style.height = '72px';
                footer.style.zIndex = '99999';
                footer.style.contain = 'layout style paint';
                footer.style.isolation = 'isolate';
                footer.style.webkitBackfaceVisibility = 'hidden';
                footer.style.backfaceVisibility = 'hidden';
                footer.style.webkitPerspective = '1000px';
                footer.style.perspective = '1000px';
                
                // Force hardware acceleration
                footer.style.webkitTransform = 'translateZ(0)';
                footer.style.transform = 'translateZ(0)';
                
                // Ensure it's not affected by parent transforms
                const computedStyle = window.getComputedStyle(footer);
                if (computedStyle.position !== 'fixed') {
                    console.log('Forcing footer to fixed position');
                    footer.style.position = 'fixed';
                }
            }
        }
        
        function monitorFooterPosition() {
            const footer = document.querySelector('.bottom-dock');
            if (footer) {
                const rect = footer.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                
                // Check if footer is not at the bottom
                if (rect.bottom !== viewportHeight) {
                    console.log('Footer position corrected:', rect.bottom, 'vs', viewportHeight);
                    forceFooterFixed();
                }
            }
        }
        
        function handleScroll() {
            const currentScrollY = window.scrollY;
            
            // Only check if scroll direction changed significantly
            if (Math.abs(currentScrollY - lastScrollY) > 10) {
                forceFooterFixed();
                lastScrollY = currentScrollY;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            forceFooterFixed();
            
            // Start monitoring footer position every 100ms
            footerPositionCheckInterval = setInterval(monitorFooterPosition, 100);
        });
        
        // Handle scroll events
        window.addEventListener('scroll', handleScroll, { passive: true });
        window.addEventListener('resize', forceFooterFixed);
        
        // iOS Safari specific handling
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            document.addEventListener('touchstart', forceFooterFixed, { passive: true });
            document.addEventListener('touchmove', forceFooterFixed, { passive: true });
            document.addEventListener('touchend', forceFooterFixed, { passive: true });
        }
        
        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (footerPositionCheckInterval) {
                clearInterval(footerPositionCheckInterval);
            }
        });
        
        // Initialize dock active state
        function updateDockActiveState() {
            const currentPath = window.location.pathname;
            const dockItems = document.querySelectorAll('.dock-item');
            
            // Remove active class from all items
            dockItems.forEach(item => item.classList.remove('active'));
            
            // Add active class to current page
            dockItems.forEach(item => {
                const itemPath = new URL(item.href).pathname;
                const icon = item.querySelector('i');
                
                // Handle specific routing logic
                if (currentPath === '/mobile' && itemPath === '/mobile') {
                    // Home page
                    item.classList.add('active');
                } else if (currentPath === '/mobile/availability-calendar' && itemPath === '/mobile/availability-calendar') {
                    // Availability calendar page
                    item.classList.add('active');
                } else if (currentPath === '/mobile/find-people-to-play' && itemPath === '/mobile/find-people-to-play') {
                    // Search page
                    item.classList.add('active');
                } else if (currentPath === '/mobile/settings' && itemPath === '/mobile/settings') {
                    // Profile/Settings page
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/settings') && itemPath === '/mobile/settings') {
                    // Profile/Settings related pages
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/find-people-to-play') && itemPath === '/mobile/find-people-to-play') {
                    // Find people to play related pages
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/pickup-games') && itemPath === '/mobile/find-people-to-play') {
                    // Pickup games page should also highlight search dock item
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/create-sub-request') && itemPath === '/mobile/find-people-to-play') {
                    // Create sub request page should also highlight search dock item
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/active-sub-requests') && itemPath === '/mobile/find-people-to-play') {
                    // Active sub requests page should also highlight search dock item
                    item.classList.add('active');
                } else if (currentPath.startsWith('/mobile/availability') && itemPath === '/mobile/availability-calendar') {
                    // Availability related pages
                    item.classList.add('active');
                }
            });
        }

        // Global impersonation status checking
        async function checkGlobalImpersonationStatus() {
            try {
                // Check both admin and team impersonation
                const [adminResponse, teamResponse] = await Promise.all([
                    fetch('/api/admin/impersonation-status').catch(() => ({ json: () => ({ is_impersonating: false }) })),
                    fetch('/api/team-impersonation/status').catch(() => ({ json: () => ({ is_impersonating: false }) }))
                ]);
                
                const adminStatus = await adminResponse.json();
                const teamStatus = await teamResponse.json();
                
                const banner = document.getElementById('global-impersonation-banner');
                const userName = document.getElementById('global-impersonated-user-name');
                const impersonationText = document.getElementById('global-impersonation-text');
                const mainContent = document.getElementById('main-content');
                
                if (adminStatus.is_impersonating) {
                    // Admin impersonation
                    if (banner && userName && impersonationText && mainContent) {
                        const playerContext = adminStatus.impersonated_user.player_context;
                        const displayText = playerContext && playerContext.club && playerContext.series 
                            ? `${adminStatus.impersonated_user.first_name} ${adminStatus.impersonated_user.last_name} (${adminStatus.impersonated_user.email}) as ${playerContext.club.name}, ${playerContext.series.name}`
                            : `${adminStatus.impersonated_user.first_name} ${adminStatus.impersonated_user.last_name} (${adminStatus.impersonated_user.email})`;
                        userName.textContent = displayText;
                        impersonationText.textContent = 'Admin Mode: Impersonating ';
                        banner.classList.remove('hidden');
                        mainContent.style.paddingTop = '104px'; // 72px (nav) + 32px (banner)
                    }
                } else if (teamStatus.is_impersonating) {
                    // Team impersonation
                    if (banner && userName && impersonationText && mainContent) {
                        const user = teamStatus.impersonated_user;
                        const displayText = `${user.first_name} ${user.last_name} (${user.email}) - ${user.club_name}, ${user.series_name}`;
                        userName.textContent = displayText;
                        impersonationText.textContent = 'Team Mode: Impersonating ';
                        banner.classList.remove('hidden');
                        mainContent.style.paddingTop = '104px'; // 72px (nav) + 32px (banner)
                    }
                } else {
                    // No impersonation
                    if (banner && mainContent) {
                        banner.classList.add('hidden');
                        mainContent.style.paddingTop = '72px'; // Just nav padding
                    }
                }
            } catch (error) {
                console.error('Error checking global impersonation status:', error);
            }
        }

        // Stop impersonation from global banner
        async function stopGlobalImpersonation() {
            if (!confirm('Stop impersonation and return to your original session?')) {
                return;
            }
            
            try {
                // Try both admin and team impersonation stop endpoints
                const [adminResponse, teamResponse] = await Promise.all([
                    fetch('/api/admin/stop-impersonation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).catch(() => ({ json: () => ({ success: false, error: 'Not admin impersonation' }) })),
                    fetch('/api/team-impersonation/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).catch(() => ({ json: () => ({ success: false, error: 'Not team impersonation' }) }))
                ]);
                
                const adminResult = await adminResponse.json();
                const teamResult = await teamResponse.json();
                
                if (adminResult.success) {
                    alert('Admin impersonation stopped. Returning to admin session.');
                    window.location.reload();
                } else if (teamResult.success) {
                    alert('Team impersonation stopped. Returning to your original session.');
                    window.location.reload();
                } else {
                    alert('No active impersonation found.');
                }
            } catch (error) {
                console.error('Error stopping impersonation:', error);
                alert('Error stopping impersonation');
            }
        }

        // Global league switching function (available on all pages)
        function switchLeague(leagueId) {
            console.log(`🔄 Switching to league: ${leagueId}`);
            
            // Close the modal first (if it exists)
            const modal = document.getElementById('leagueSwitcherModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            // Use enhanced context manager if available, otherwise use simple switching
            if (window.enhancedContextManager) {
                return window.enhancedContextManager.switchLeague(leagueId);
            }
            
            // Fallback to original implementation
            // Disable all league buttons during switch
            const leagueButtons = document.querySelectorAll('.league-switch-btn');
            leagueButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
            });
            
            // Update trigger button to show loading (if it exists on this page)
            const trigger = document.getElementById('leagueSwitcherTrigger');
            if (trigger) {
                trigger.innerHTML = '<i class="fas fa-spinner fa-spin text-xs"></i>';
                trigger.disabled = true;
            }
            
            fetch('/api/switch-league', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    league_id: leagueId
                })
            })
            .then(response => {
                console.log(`📡 API Response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log(`📊 API Response data:`, data);
                
                if (data.success) {
                    console.log(`✅ Successfully switched to ${data.user.league_name}`);
                    
                    // Show success briefly then reload
                    if (trigger) {
                        trigger.innerHTML = '<i class="fas fa-check text-xs text-green-400"></i>';
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    console.error('❌ League switch failed:', data.error);
                    alert(`Failed to switch leagues: ${data.error}`);
                    
                    // Re-enable buttons
                    leagueButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                    });
                    
                    if (trigger) {
                        trigger.innerHTML = '<i class="fas fa-edit text-sm"></i>';
                        trigger.disabled = false;
                    }
                }
            })
            .catch(error => {
                console.error('❌ Network error:', error);
                alert(`Network error: ${error.message}`);
                
                // Re-enable buttons
                leagueButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                
                if (trigger) {
                    trigger.innerHTML = '<i class="fas fa-edit text-sm"></i>';
                    trigger.disabled = false;
                }
            });
        }

                            // Initialize scroll indicator functionality
        function initScrollIndicator() {
            const navContent = document.getElementById('navContent');
            const scrollIndicator = document.getElementById('scrollIndicator');
            
            if (!navContent || !scrollIndicator) return;
            
            // Function to check if there's more content below
            function updateScrollIndicator() {
                const scrollTop = navContent.scrollTop;
                const scrollHeight = navContent.scrollHeight;
                const clientHeight = navContent.clientHeight;
                
                // Show indicator if there's more content below (with 50px threshold)
                const hasMoreContent = scrollTop + clientHeight < scrollHeight - 50;
                
                if (hasMoreContent) {
                    scrollIndicator.classList.add('show');
                } else {
                    scrollIndicator.classList.remove('show');
                }
            }
            
            // Handle scroll indicator click
            scrollIndicator.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                navContent.scrollTo({
                    top: navContent.scrollTop + 400,
                    behavior: 'smooth'
                });
            });
            
            // Listen for scroll events
            navContent.addEventListener('scroll', updateScrollIndicator);
            
            // Initial check after content loads
            setTimeout(updateScrollIndicator, 100);
            
            // Check again when drawer opens
            const drawer = document.getElementById('navDrawer');
            if (drawer) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && 
                            mutation.attributeName === 'style') {
                            const isOpen = drawer.style.transform === 'translateX(0px)' || 
                                         drawer.style.transform === 'translateX(0%)';
                            if (isOpen) {
                                setTimeout(updateScrollIndicator, 200);
                            }
                        }
                    });
                });
                observer.observe(drawer, { attributes: true, attributeFilter: ['style'] });
            }
        }

            // Status Banner Functionality
        async function loadStatusBanner() {
            try {
                // Only show banner on mobile home page
                const currentPath = window.location.pathname;
                if (currentPath !== '/mobile' && currentPath !== '/mobile/') {
                    return; // Exit if not on mobile home page
                }
                
                const response = await fetch('/api/status-message');
                const data = await response.json();
                
                if (data.success && data.message) {
                    const banner = document.getElementById('statusBanner');
                    const bannerText = document.getElementById('statusBannerText');
                    const bannerButton = document.getElementById('statusBannerButton');
                    const mainContent = document.getElementById('main-content');
                    
                    if (banner && bannerText && mainContent) {
                        // Set the message text (just the description)
                        bannerText.textContent = data.message.description;
                        
                        // Show button if there's a URL
                        if (data.message.url && bannerButton) {
                            // Convert absolute URLs to relative URLs to avoid session issues
                            let url = data.message.url;
                            try {
                                const urlObj = new URL(url, window.location.origin);
                                // If it's the same origin, use relative path
                                if (urlObj.origin === window.location.origin) {
                                    url = urlObj.pathname + urlObj.search + urlObj.hash;
                                }
                            } catch (e) {
                                // If URL parsing fails, keep original URL
                                console.log('URL parsing failed, using original URL:', url);
                            }
                            bannerButton.href = url;
                            bannerButton.classList.remove('hidden');
                        }
                        
                        // Show the banner
                        banner.classList.remove('hidden');
                        
                        // Adjust main content padding to account for banner (60px banner + 30px spacing)
                        const currentPadding = parseInt(mainContent.style.paddingTop || '72px');
                        mainContent.style.paddingTop = (currentPadding + 90) + 'px';
                    }
                }
            } catch (error) {
                console.error('Error loading status banner:', error);
            }
        }

            // Initialize drawer functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Load status banner on page load
            loadStatusBanner();
            
            // Set up dock active state
            updateDockActiveState();
            
            // Check impersonation status on page load
            checkGlobalImpersonationStatus();
            

            
            // Update dock state on navigation (for SPA-like behavior)
            window.addEventListener('popstate', updateDockActiveState);
            
            // Handle auto-scroll to bottom if scroll parameter is present
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('scroll') === 'bottom') {
                setTimeout(() => {
                    window.scrollTo({
                        top: document.body.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
            
            // Initialize scroll indicator
            initScrollIndicator();
            
            // Detect iOS and add class for targeted styling
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            if (isIOS) {
                document.body.classList.add('ios-device');
                console.log('🍎 iOS device detected');
            }
            if (isSafari) {
                document.body.classList.add('safari-browser');
                console.log('🧭 Safari browser detected');
            }
            
            const drawer = document.getElementById('navDrawer');
            const overlay = document.getElementById('drawerOverlay');
            const hamburger = document.getElementById('hamburgerToggle');

            // Debug hamburger visibility
            if (hamburger) {
                const rect = hamburger.getBoundingClientRect();
                console.log('🍔 Hamburger position:', {
                    top: rect.top,
                    right: rect.right,
                    bottom: rect.bottom,
                    left: rect.left,
                    width: rect.width,
                    height: rect.height,
                    visible: rect.width > 0 && rect.height > 0
                });
            } else {
                console.error('❌ Hamburger button not found in DOM!');
            }

            // EXPLICITLY ensure drawer is closed on page load
            if (drawer && overlay && hamburger) {
                drawer.style.transform = 'translateX(100%)';
                overlay.classList.add('hidden');
                overlay.style.pointerEvents = 'none';
                hamburger.classList.remove('open');
                console.log('Drawer explicitly closed on page load with inline style');
                
                // Ensure Share Rally chip is visible on page load
                const shareRallyChip = document.getElementById('shareRallyChip');
                if (shareRallyChip) {
                    shareRallyChip.style.opacity = '1';
                    shareRallyChip.style.transform = 'translateY(0)';
                }
                
                // Also do this after a short delay to ensure it overrides any other scripts
                setTimeout(() => {
                    drawer.style.transform = 'translateX(100%)';
                    overlay.classList.add('hidden');
                    overlay.style.pointerEvents = 'none';
                    hamburger.classList.remove('open');
                    console.log('Drawer ensured closed after delay with inline style');
                    
                    // Ensure Share Rally chip is visible after delay
                    if (shareRallyChip) {
                        shareRallyChip.style.opacity = '1';
                        shareRallyChip.style.transform = 'translateY(0)';
                    }
                }, 100);
            }

            // Track drawer state
            let isDrawerTransitioning = false;
            let intentionalChange = false;

            // Watch for unwanted changes to the drawer
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && 
                        mutation.attributeName === 'style' && 
                        !intentionalChange &&
                        drawer.style.transform !== 'translateX(100%)') {
                        console.log('Unwanted drawer state change detected, forcing close');
                        drawer.style.transform = 'translateX(100%)';
                        overlay.classList.add('hidden');
                        overlay.style.pointerEvents = 'none';
                        hamburger.classList.remove('open');
                        
                        // Show persistent navigation when drawer is forced closed
                        const persistentNav = document.getElementById('main-nav');
                        if (persistentNav) {
                            persistentNav.style.display = 'block';
                        }
                        
                        // Show Share Rally chip when drawer is forced closed
                        const shareRallyChip = document.getElementById('shareRallyChip');
                        if (shareRallyChip) {
                            shareRallyChip.style.opacity = '1';
                            shareRallyChip.style.transform = 'translateY(0)';
                        }
                    }
                });
            });
            
            if (drawer) {
                observer.observe(drawer, { attributes: true, attributeFilter: ['style', 'class'] });
            }

            // Handle drawer toggle with debounce
            const toggleDrawer = debounce(function() {
                if (isDrawerTransitioning) return;
                isDrawerTransitioning = true;
                intentionalChange = true;

                const isOpen = drawer.style.transform === 'translateX(0px)' || drawer.style.transform === 'translateX(0%)';
                if (isOpen) {
                    drawer.style.transform = 'translateX(100%)';
                    overlay.classList.add('hidden');
                    overlay.style.pointerEvents = 'none';
                    hamburger.classList.remove('open');
                    
                    // Show persistent navigation when drawer closes
                    const persistentNav = document.getElementById('main-nav');
                    if (persistentNav) {
                        persistentNav.style.display = 'block';
                    }
                    
                    // Show Share Rally chip when drawer closes
                    const shareRallyChip = document.getElementById('shareRallyChip');
                    if (shareRallyChip) {
                        shareRallyChip.style.opacity = '1';
                        shareRallyChip.style.transform = 'translateY(0)';
                    }
                } else {
                    drawer.style.transform = 'translateX(0%)';
                    overlay.classList.remove('hidden');
                    overlay.style.pointerEvents = 'auto';
                    hamburger.classList.add('open');
                    
                    // Hide persistent navigation when drawer opens
                    const persistentNav = document.getElementById('main-nav');
                    if (persistentNav) {
                        persistentNav.style.display = 'none';
                    }
                    
                    // Hide Share Rally chip when drawer opens
                    const shareRallyChip = document.getElementById('shareRallyChip');
                    if (shareRallyChip) {
                        shareRallyChip.style.opacity = '0';
                        shareRallyChip.style.transform = 'translateY(20px)';
                    }
                }

                // Reset transition state after animation completes
                setTimeout(() => {
                    isDrawerTransitioning = false;
                    intentionalChange = false;
                }, 300); // Match transition duration
            }, 100);

            // Debounce function for handlers
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func.apply(this, args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Event delegation for drawer controls
            document.addEventListener('click', function(e) {
                // Stop if drawer is transitioning
                if (isDrawerTransitioning) {
                    e.preventDefault();
                    return;
                }

                const target = e.target;

                // Handle hamburger button
                if (target.closest('#hamburgerToggle')) {
                    e.preventDefault();
                    toggleDrawer();
                    return;
                }

                // Handle drawer close button
                if (target.closest('.drawer-close')) {
                    e.preventDefault();
                    toggleDrawer();
                    return;
                }

                // Handle overlay click
                if (target.matches('#drawerOverlay')) {
                    e.preventDefault();
                    toggleDrawer();
                    return;
                }

                // Handle navigation links ONLY inside the drawer
                const navLink = target.closest('.nav-link, .candy-box-item');
                if (navLink && navLink.closest('#navDrawer')) {
                    // Let activity-tracker.js handle the click tracking
                    // Just close the drawer and let the navigation happen naturally
                    intentionalChange = true;
                    drawer.style.transform = 'translateX(100%)';
                    overlay.classList.add('hidden');
                    overlay.style.pointerEvents = 'none';
                    hamburger.classList.remove('open');
                    
                    // Show persistent navigation when drawer closes
                    const persistentNav = document.getElementById('main-nav');
                    if (persistentNav) {
                        persistentNav.style.display = 'block';
                    }
                    
                    // Show Share Rally chip when drawer closes
                    const shareRallyChip = document.getElementById('shareRallyChip');
                    if (shareRallyChip) {
                        shareRallyChip.style.opacity = '1';
                        shareRallyChip.style.transform = 'translateY(0)';
                    }
                    
                    setTimeout(() => { intentionalChange = false; }, 300);
                    return;
                }
            });
        });
        
        // Navigation with loading indicator function
        function navigateWithLoading(url, loadingText = 'Loading...') {
            // Show loading indicator
            if (typeof showLoadingIndicator === 'function') {
                showLoadingIndicator(loadingText);
            } else {
                // Fallback: create simple loading indicator
                const overlay = document.createElement('div');
                overlay.id = 'loading-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(4, 84, 84, 0.95);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    color: white;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                `;
                overlay.innerHTML = `
                    <div style="text-align: center;">
                        <div style="width: 40px; height: 40px; border: 4px solid rgba(191, 248, 99, 0.3); border-top: 4px solid #bff863; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${loadingText}</div>
                        <div style="font-size: 14px; opacity: 0.8;">Hang tight...</div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(overlay);
            }
            
            // Navigate after delay
            setTimeout(() => {
                window.location.href = url;
            }, 800);
        }
    </script>

</body>
</html> 
</html> 