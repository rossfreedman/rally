{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}
{% block title %}User Settings | Rally{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-sm">
                <i class="fas fa-user-cog text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">User Settings</h1>
                <p class="text-sm text-gray-500">Manage your account preferences</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">
        
        <!-- Main Settings Form -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            
                        <div class="p-6">
                <form id="user-settings-form" class="space-y-6">
                    
                    <!-- Account Information Section -->
                    <div class="form-section" style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 3px solid #007bff;">
                        <h6 class="section-title" style="color: #495057; font-weight: 600; font-size: 0.9rem; margin-bottom: 1rem;">About you</h6>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="firstName">First Name</label>
                                <input type="text" id="firstName" name="firstName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="lastName">Last Name</label>
                                <input type="text" id="lastName" name="lastName" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="email">Email Address</label>
                            <input type="email" id="email" name="email" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>

                    <!-- Organization Settings Section -->
                    <div class="form-section" style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 3px solid #28a745;">
                        <h6 class="section-title" style="color: #495057; font-weight: 600; font-size: 0.9rem; margin-bottom: 1rem;">Where you play</h6>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="league">League</label>
                            <select id="league" name="league" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="club">Club</label>
                            <select id="club" name="club" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="series">Series/Division</label>
                            <select id="series" name="series" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required></select>
                        </div>
                    </div>
                    
                    <!-- Player Preferences Section -->
                    <div class="form-section" id="player-preferences" style="background-color: #f8f9fa; border-radius: 8px; padding: 20px; border-left: 3px solid #ffc107;">
                        <h6 class="section-title" style="color: #495057; font-weight: 600; font-size: 0.9rem; margin-bottom: 1rem;">How you play</h6>
                        
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="adDeuce">Ad/Deuce</label>
                                <select id="adDeuce" name="adDeuce" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select preference...</option>
                                    <option value="Ad">Ad</option>
                                    <option value="Deuce">Deuce</option>
                                    <option value="Either">Either</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" for="dominantHand">Dominant Hand</label>
                                <select id="dominantHand" name="dominantHand" class="w-full p-3 border border-gray-300 rounded-lg bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select hand...</option>
                                    <option value="Righty">Righty</option>
                                    <option value="Lefty">Lefty</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="text-xs text-gray-500">These preferences will be used for match planning and lineups.</div>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors duration-200 font-medium">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                </form>
                
                <!-- Success/Error Messages -->
                <div id="settings-success" class="hidden mt-4 bg-green-50 border border-green-100 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <p class="text-green-700 font-medium">Settings updated successfully!</p>
                    </div>
                </div>
                <div id="settings-error" class="hidden mt-4 bg-red-50 border border-red-100 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-3"></i>
                        <p class="text-red-700 font-medium">Error updating settings</p>
                    </div>
                </div>
            </div>
        </div>
        

        
        <!-- Logout Button -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6">
                <a href="/logout" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors duration-200 font-medium flex items-center justify-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Logout
                </a>
            </div>
        </div>
        
        <!-- Player ID -->
        <div class="text-center py-4">
            <div class="text-xs text-gray-500 font-mono" id="player-id-display">
                Player ID: Loading...
            </div>
        </div>
    </div>
</div>
<script>
// Prefill form with user data
function fillUserSettingsForm(user) {
  document.getElementById('firstName').value = user.first_name || '';
  document.getElementById('lastName').value = user.last_name || '';
  document.getElementById('email').value = user.email || '';
  // League/club/series will be set after dropdowns are loaded
  
  // Player preferences (placeholders for now)
  document.getElementById('adDeuce').value = user.ad_deuce_preference || '';
  document.getElementById('dominantHand').value = user.dominant_hand || '';
}
// Fetch leagues, clubs and series for dropdowns
function loadLeaguesClubsAndSeries(user) {
  // Load leagues first
  fetch('/api/get-leagues').then(r=>r.json()).then(data => {
    const leagueSel = document.getElementById('league');
    leagueSel.innerHTML = '<option value="">Select a league...</option>' + 
      data.leagues.map(l => `<option value="${l.league_id}">${l.league_name}</option>`).join('');
    
    // Set user's current league
    if (user.league_id) {
      leagueSel.value = user.league_id;
    }
    
    // Load clubs and series based on selected league
    loadClubsByLeague(user.league_id, user.club);
    loadSeriesByLeague(user.league_id, user.series);
    
    // Add event listener for league changes
    leagueSel.addEventListener('change', function() {
      const selectedLeague = this.value;
      loadClubsByLeague(selectedLeague);
      loadSeriesByLeague(selectedLeague);
      // Clear club and series selections when league changes
      document.getElementById('club').value = '';
      document.getElementById('series').value = '';
    });
  });
}

// Load clubs filtered by league
function loadClubsByLeague(leagueId, selectedClub = null) {
  const url = leagueId ? `/api/get-clubs-by-league?league_id=${leagueId}` : '/api/get-clubs-by-league';
  
  fetch(url).then(r=>r.json()).then(data => {
    const clubSel = document.getElementById('club');
    clubSel.innerHTML = '<option value="">Select a club...</option>' + 
      data.clubs.map(c => `<option value="${c}">${c}</option>`).join('');
    
    // Set selected club if provided
    if (selectedClub) {
      clubSel.value = selectedClub;
    }
  }).catch(error => {
    console.error('Error loading clubs:', error);
    // Fallback to all clubs
    fetch('/api/get-clubs').then(r=>r.json()).then(data => {
      const clubSel = document.getElementById('club');
      clubSel.innerHTML = data.clubs.map(c => `<option value="${c}">${c}</option>`).join('');
      if (selectedClub) clubSel.value = selectedClub;
    });
  });
}

// Load series filtered by league
function loadSeriesByLeague(leagueId, selectedSeries = null) {
  console.log('🔍 loadSeriesByLeague called with:', { leagueId, selectedSeries });
  
  // PERFORMANCE FIX: If we already have the selectedSeries, populate it immediately
  // This eliminates the 5-second delay on staging by using session data directly
  if (selectedSeries) {
    const seriesSel = document.getElementById('series');
    seriesSel.innerHTML = '<option value="">Select a series...</option>';
    
    // Add the user's current series immediately to prevent blank field
    const option = document.createElement('option');
    option.value = selectedSeries;
    option.textContent = selectedSeries;
    option.selected = true;
    seriesSel.appendChild(option);
    
    console.log('🚀 Series populated immediately from session data:', selectedSeries);
  }
  
  // Use the new API endpoint that returns user-facing series names from database mappings
  const url = leagueId ? `/api/get-user-facing-series-by-league?league_id=${leagueId}` : '/api/get-user-facing-series-by-league';
  console.log('🔍 Fetching series from URL:', url);
  
  fetch(url)
    .then(r => r.json())
    .then(data => {
      console.log('🔍 Series API response:', data);
      
      const seriesSel = document.getElementById('series');
      seriesSel.innerHTML = '<option value="">Select a series...</option>';
      
      if (data.series && Array.isArray(data.series)) {
        console.log('🔍 Processing', data.series.length, 'series options:', data.series);
        
        // Series names are already properly formatted by the database mapping system
        // No need for client-side transformations - just use them directly
        data.series.forEach(series => {
          const option = document.createElement('option');
          option.value = series;  // Use the user-facing name as the value
          option.textContent = series;  // Display the user-facing name
          seriesSel.appendChild(option);
        });
        
        // Set selected series if provided
        if (selectedSeries) {
          seriesSel.value = selectedSeries;
          console.log('✅ Set selected series to:', selectedSeries);
        }
        
        console.log('✅ Series dropdown fully populated from API with', data.series.length, 'options');
      } else {
        console.log('❌ No series data or invalid format:', data);
      }
    })
    .catch(error => {
      console.error('❌ Error loading series:', error);
      // Fallback to original API if new one fails
      const fallbackUrl = leagueId ? `/api/get-series-by-league?league_id=${leagueId}` : '/api/get-series-by-league';
      console.log('🔄 Trying fallback URL:', fallbackUrl);
      
      fetch(fallbackUrl)
        .then(r => r.json())
        .then(data => {
          console.log('🔍 Fallback series API response:', data);
          
          const seriesSel = document.getElementById('series');
          seriesSel.innerHTML = '<option value="">Select a series...</option>';
          if (data.series && Array.isArray(data.series)) {
            data.series.forEach(series => {
              const option = document.createElement('option');
              option.value = series;
              option.textContent = series;
              seriesSel.appendChild(option);
            });
            if (selectedSeries) seriesSel.value = selectedSeries;
          }
        })
        .catch(fallbackError => {
          console.error('❌ Error loading series from fallback:', fallbackError);
        });
    });
}



// On page load, fetch user settings
fetch('/api/get-user-settings').then(r=>r.json()).then(user => {
  console.log('🔍 User settings API response:', user);
  console.log('  - First Name:', user.first_name);
  console.log('  - Last Name:', user.last_name);
  console.log('  - League ID:', user.league_id);
  console.log('  - Club:', user.club);
  console.log('  - Series:', user.series);
  console.log('  - League Context:', user.league_context);
  
  fillUserSettingsForm(user);
  loadLeaguesClubsAndSeries(user);
  
  // Update Player ID display with user's actual Player ID
  const playerIdDisplay = document.getElementById('player-id-display');
  if (user.tenniscores_player_id) {
    playerIdDisplay.textContent = `Player ID: ${user.tenniscores_player_id}`;
  } else {
    playerIdDisplay.textContent = 'Player ID: Not linked';
  }
});



// Handle form submit
const form = document.getElementById('user-settings-form');
form.addEventListener('submit', function(e) {
  e.preventDefault();
  
  const data = {
    firstName: form.firstName.value,
    lastName: form.lastName.value,
    email: form.email.value,
    league_id: form.league.value,
    club: form.club.value,
    series: form.series.value,
    // Player preferences (placeholders for now)
    adDeuce: form.adDeuce.value,
    dominantHand: form.dominantHand.value
  };
  
  // Debug logging to help troubleshoot settings vs registration differences
  console.log('🔍 Settings Update Debug - Form Values:');
  console.log('  First Name:', data.firstName);
  console.log('  Last Name:', data.lastName);
  console.log('  League ID:', data.league_id);
  console.log('  Club:', data.club);
  console.log('  Series:', data.series);
  
  // Check what the selected series option actually contains
  const seriesSelect = document.getElementById('series');
  const selectedOption = seriesSelect.options[seriesSelect.selectedIndex];
  console.log('  Series Display Text:', selectedOption?.textContent);
  console.log('  Series Value (submitted):', selectedOption?.value);
  
  fetch('/api/update-settings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(resp => {
    // Debug logging for the API response
    console.log('🔍 Settings Update API Response:');
    console.log('  Response:', resp);
    
    if (resp.success) {
      console.log('✅ Settings update successful');
      window.app && window.app.showToast && window.app.showToast('Settings updated!', 'success');
      
      // Reload page after a short delay to ensure all components are updated
      setTimeout(() => window.location.reload(), 1000);
    } else {
      console.log('❌ Settings update failed:', resp.message);
      window.app && window.app.showToast && window.app.showToast(resp.message || 'Update failed', 'error');
    }
  })
  .catch(() => {
    window.app && window.app.showToast && window.app.showToast('Update failed', 'error');
  });
});
</script>

<script>
// Handle auto-scroll to anchor on page load
document.addEventListener('DOMContentLoaded', function() {
  // Check if there's a hash in the URL
  if (window.location.hash === '#player-preferences') {
    // Wait a short moment for the page to fully render
    setTimeout(() => {
      const element = document.getElementById('player-preferences');
      if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // Add a subtle highlight effect
        element.style.backgroundColor = '#FEF3C7';
        setTimeout(() => {
          element.style.backgroundColor = '';
        }, 2000);
      }
    }, 500);
  }
});
</script>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Grid responsive */
@media (max-width: 640px) {
    .grid-cols-2 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    
    .form-section {
        padding: 16px !important;
        margin-bottom: 1rem;
    }
    
    .section-title {
        font-size: 0.85rem !important;
    }
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-300 { border-color: #d1d5db; }
.border-green-100 { border-color: #dcfce7; }
.border-red-100 { border-color: #fee2e2; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-white { background-color: #ffffff; }
.bg-green-50 { background-color: #f0fdf4; }
.bg-green-600 { background-color: #16a34a; }
.bg-red-50 { background-color: #fef2f2; }

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-gray-400 { color: #9ca3af; }
.text-blue-500 { color: #3b82f6; }
.text-blue-600 { color: #2563eb; }
.text-green-500 { color: #10b981; }
.text-green-600 { color: #059669; }
.text-green-700 { color: #047857; }
.text-purple-500 { color: #8b5cf6; }
.text-red-500 { color: #ef4444; }
.text-red-700 { color: #b91c1c; }
.text-white { color: #ffffff; }

/* Hover colors */
.hover\:bg-green-700:hover { background-color: #15803d; }
.hover\:bg-gray-200:hover { background-color: #e5e7eb; }
.hover\:text-gray-700:hover { color: #374151; }

/* Focus colors */
.focus\:border-blue-500:focus { border-color: #3b82f6; }
.focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }
.focus\:ring-green-500:focus { --tw-ring-color: #10b981; }
.focus\:ring-gray-500:focus { --tw-ring-color: #6b7280; }

/* Ring utilities */
.focus\:ring-2:focus {
    --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
    --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
    box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

/* Gradient backgrounds */
.bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}
.from-blue-500 {
    --tw-gradient-from: #3b82f6;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0));
}
.to-blue-600 {
    --tw-gradient-to: #2563eb;
}

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-4 > * + * { margin-top: 1rem; }

/* Form sections (matching registration page style) */
.form-section {
    margin-bottom: 1.5rem;
}

.section-title {
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }

/* Transform utilities */
.transform { transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
.-translate-y-1\/2 { --tw-translate-y: -50%; }

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.duration-200 {
    transition-duration: 200ms;
}

/* Utility classes */
.hidden { display: none; }
.grid { display: grid; }
.flex { display: flex; }
.items-center { align-items: center; }
.gap-4 { gap: 1rem; }
.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-mono { font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace; }

/* Responsive design */
@media (max-width: 640px) {
    .px-6 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .gap-4 { gap: 0.75rem; }
}
</style>
{% endblock %} 