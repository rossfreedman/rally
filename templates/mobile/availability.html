{% extends 'mobile/layout.html' %}
{% set show_back_arrow = True %}
{% block title %}View Schedule | Rally{% endblock %}
{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Team Selector (if user has multiple teams) -->
    {% if user_teams and user_teams|length > 1 %}
    <div class="px-4 py-1" style="display: none;">
        <div class="text-right">
            <button id="teamSelectorLink" class="inline-flex items-center text-xs text-gray-600 hover:text-blue-600 transition-colors">
                {% if current_team_info %}
                <span>Viewing: {{ current_team_info.team_name }}</span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
                {% else %}
                <span>Select Team</span>
                <i class="fas fa-chevron-down text-xs ml-1"></i>
                {% endif %}
            </button>
        </div>
    </div>

    <!-- Team Selection Modal (hidden by default) -->
    <div id="teamSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4" style="display: none !important;">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full max-h-96 overflow-hidden">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Switch Team</h3>
                <button id="closeTeamModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Team Options -->
            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                {% for team in user_teams %}
                <a href="{{ url_for('mobile.serve_mobile_availability') }}?team_id={{ team.team_id }}" 
                   class="team-option-link block w-full flex items-center justify-between p-4 rounded-lg hover:bg-gray-50 transition-colors border border-gray-200 hover:border-gray-300 text-left
                          {% if team.team_id == (current_team_info.team_id if current_team_info else None) %}bg-blue-50 border-blue-200{% endif %}"
                   data-team-id="{{ team.team_id }}"
                   data-team-name="{{ team.team_name }}">
                    <div class="flex-1">
                        <div class="font-medium {% if team.team_id == (current_team_info.team_id if current_team_info else None) %}text-blue-700{% else %}text-gray-900{% endif %}">
                            {{ team.team_name }}
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            {{ team.club_name }} • {{ team.series_name }}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            {{ team.league_name }} • {{ team.match_count }} matches
                        </div>
                    </div>
                    <div class="ml-4">
                        {% if team.team_id == (current_team_info.team_id if current_team_info else None) %}
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-check text-white text-xs"></i>
                            </div>
                        {% else %}
                            <div class="w-6 h-6 border-2 border-gray-300 rounded-full flex items-center justify-center hover:border-blue-400 transition-colors">
                                <i class="fas fa-arrow-right text-gray-400 text-xs hover:text-blue-500"></i>
                            </div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                <i class="fas fa-calendar text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">View Schedule</h1>
                <p class="text-sm text-gray-500">Manage your availability for matches & practices</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">

        <!-- Filter Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-filter text-blue-500 mr-2"></i>
                    Filter Events
                </h2>
            </div>
            
            <div class="p-6">
                <div class="schedule-filter-bar flex gap-2">
                    <button class="schedule-filter-btn active flex-1 px-4 py-3 rounded-lg font-medium transition-colors duration-200" data-filter="all" type="button">All</button>
                    <button class="schedule-filter-btn flex-1 px-4 py-3 rounded-lg font-medium transition-colors duration-200" data-filter="matches" type="button">Matches</button>
                    <button class="schedule-filter-btn flex-1 px-4 py-3 rounded-lg font-medium transition-colors duration-200" data-filter="practices" type="button">Practices</button>
                </div>
            </div>
        </div>

        <!-- Match Cards or Empty State -->
        <div class="space-y-6" id="availability-list">
            {% if match_avail_pairs %}
            {% set last_date = None %}
            {% for match, avail in match_avail_pairs %}
                {% if match.date != last_date %}
                    {% if not loop.first %}</div>{% endif %}
                    {% set show_time = match.time|strip_leading_zero if match.time else '' %}
                    {% set is_practice = match.type == 'practice' %}
                    <div class="schedule-date-group" data-date="{{ match.date }}">
                        <div class="schedule-date-header flex justify-between items-center rounded-xl p-4 mb-4 {% if is_practice %}practice-header{% else %}match-header{% endif %}">
                            <div class="flex items-center gap-3">
                                {% if is_practice %}
                                    <i class="fas fa-dumbbell text-white text-lg"></i>
                                    <span class="font-semibold text-lg text-white">Practice</span>
                                {% else %}
                                    <i class="fas fa-trophy text-white text-lg"></i>
                                    <span class="font-semibold text-lg text-white">Match</span>
                                {% endif %}
                            </div>
                        </div>
                    {% set last_date = match.date %}
                {% endif %}
                {% set is_practice = match.type == 'practice' %}
                {% set show_time = match.time|strip_leading_zero if match.time else '' %}
                <div class="schedule-card group relative overflow-hidden mb-4 bg-white rounded-xl shadow-sm border border-gray-100"
                    data-type="{% if is_practice %}practice{% else %}match{% endif %}">
                    
                    <div class="p-6">
                        <!-- Two Column Layout -->
                        <div class="flex flex-row gap-6">
                            <!-- Column 1: Match Info -->
                            <div class="flex flex-col gap-4 flex-1">
                                <div class="flex-shrink-0">
                                    {% if is_practice %}
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-tennis-ball text-orange-500 text-2xl"></i>
                                            <i class="fas fa-table-tennis text-orange-500 text-2xl"></i>
                                        </div>
                                    {% else %}
                                        <i class="fas fa-trophy text-yellow-500 text-2xl"></i>
                                    {% endif %}
                                </div>
                                <!-- Date and Time Section -->
                                <div class="text-lg font-medium">
                                    <div class="font-bold text-gray-900">{{ match.date | pretty_date_with_year }}</div>
                                    <div class="text-base text-gray-600">{{ show_time }}</div>
                                </div>
                                <div>
                                    <div class="text-sm">
                                        {% if is_practice %}
                                            <!-- Practice description removed -->
                                        {% else %}
                                            {% if match.home_team and match.away_team %}
                                                {% set home_team = match.home_team.split(' - ') if match.home_team else [] %}
                                                {% set away_team = match.away_team.split(' - ') if match.away_team else [] %}
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-bold text-gray-900">{{ match.home_team }} vs.</span>
                                                </div>
                                                <div>
                                                    <span class="text-sm font-bold text-gray-900">{{ match.away_team }}</span>
                                                </div>
                                            {% else %}
                                                <span class="font-bold text-sm text-gray-900">Match Details TBD</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 mt-4">
                                        {% if not is_practice %}
                                            <i class="fas fa-map-marker-alt text-red-500 text-sm"></i>
                                            {% set location_text = match.location or match.home_team or session_data.user.club %}
                                            {% set maps_query = match.club_address or location_text %}
                                            {% if location_text != 'All Clubs' %}
                                                <span class="text-gray-600 text-sm font-bold">{{ location_text }}</span>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% if not is_practice and location_text and location_text != 'All Clubs' %}
                                        {% if match.location and match.location != session_data.user.club %}
                                            <div class="mt-3">
                                                <a class="inline-block bg-green-500 text-white text-xs font-medium px-2 py-1.5 rounded-md hover:bg-green-600 transition-colors duration-200" href="https://maps.google.com/?q={{ maps_query | urlencode }}" target="_blank" rel="noopener noreferrer">
                                                    <i class="fas fa-directions mr-1"></i>Get Directions
                                                </a>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                    </div>

                            <!-- Column 2: Availability Buttons -->
                            <div class="availability-column" data-availability-buttons>
                                
                                <!-- Availability Buttons Container -->
                                <div class="availability-container">
                                    <button 
                                        class="availability-button {% if avail.status == 'available' %}selected-available{% endif %}"
                                        onclick="updateAvailability(this, '{{ players[0].name }}', '{{ match.date }}', 'available')"
                                        data-status="available"
                                        data-current-status="{{ avail.status or '' }}"
                                        data-raw-date="{{ match.date }}">
                                        <i class="fas fa-check"></i>Count Me In!
                                    </button>
                                    <button 
                                        class="availability-button {% if avail.status == 'unavailable' %}selected-unavailable{% endif %}"
                                        onclick="updateAvailability(this, '{{ players[0].name }}', '{{ match.date }}', 'unavailable')"
                                        data-status="unavailable"
                                        data-current-status="{{ avail.status or '' }}">
                                        <i class="fas fa-times"></i>Sorry, Can't
                                    </button>
                                    <button 
                                        class="availability-button {% if avail.status == 'not_sure' %}selected-not-sure{% endif %}"
                                        onclick="updateAvailability(this, '{{ players[0].name }}', '{{ match.date }}', 'not_sure')"
                                        data-status="not_sure"
                                        data-current-status="{{ avail.status or '' }}">
                                        <i class="fas fa-question"></i>Not Sure
                                    </button>
                                </div>
                                
                                <!-- Add Note Button -->
                                <div class="availability-container" id="add-note-container-{{ loop.index0 }}" style="{% if avail.notes %}display: none;{% endif %}">
                                    <button type="button" class="add-note-button" onclick="console.log('Button clicked!'); openNoteModal('{{ match.date }}', '{{ players[0].name }}', {{ loop.index0 }})">
                                        <i class="fas fa-pencil-alt"></i>Add a note
                                    </button>
                                </div>
                                
                                <!-- Note Display (shown when note exists) -->
                                <div class="availability-container note-display" id="note-display-{{ loop.index0 }}" style="{% if not avail.notes %}display: none;{% endif %}">
                                    <div class="note-content">
                                        <div class="note-header">
                                            <div class="note-header-left">
                                                <i class="fas fa-sticky-note text-gray-400" style="font-size: 0.625rem;"></i>
                                                <span class="note-label-text">Note</span>
                                            </div>
                                            <button type="button" class="edit-note-button" onclick="openNoteModal('{{ match.date }}', '{{ players[0].name }}', {{ loop.index0 }})">
                                                <i class="fas fa-edit"></i>Edit
                                            </button>
                                        </div>
                                        <div class="note-text" id="note-text-{{ loop.index0 }}">{{ avail.notes or '' }}</div>
                                    </div>
                                </div>
                                
                                <!-- View Team Container -->
                                <div class="availability-container blue-container">
                                    <a href="{{ url_for('mobile.serve_all_team_availability', date=match.date) }}" class="view-team-button">
                                        View Team Availability {{ match.date | date_to_mmdd }}
                                    </a>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
                {% if loop.last %}</div>{% endif %}
            {% endfor %}
            {% else %}
            <!-- Empty State - No Schedule Data -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-8 text-center">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-calendar-times text-gray-400 text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Schedule Available</h3>
                    <p class="text-gray-600 mb-4">
                        {% if current_team_info %}
                        No schedule data is available for {{ current_team_info.team_name }}.
                        {% else %}
                        No schedule data is available for your current team.
                        {% endif %}
                    </p>
                    {% if user_teams and user_teams|length > 1 %}
                    <button id="switchTeamBtn" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-exchange-alt mr-2"></i>
                        Switch to Different Team
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Note Modal -->
<div id="noteModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-pencil-alt"></i>Add a Note
            </h3>
            <button type="button" class="modal-close" onclick="closeNoteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-content">
            <label for="modal-notes-textarea" class="modal-label">
                Add a note (optional):
            </label>
            <textarea 
                id="modal-notes-textarea"
                name="notes"
                rows="4"
                class="modal-textarea"
                placeholder="e.g. May be 10 min late...."></textarea>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-button modal-button-save" onclick="saveNoteFromModal()">
                <i class="fas fa-save"></i>Save Note
            </button>
            <button type="button" class="modal-button modal-button-cancel" onclick="closeNoteModal()">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
// Define note modal functions first to ensure they're available globally
function openNoteModal(matchDate, playerName, noteIndex) {
    console.log('openNoteModal called with:', { matchDate, playerName, noteIndex });
    
    window.currentNoteDate = matchDate;
    window.currentNotePlayerName = playerName;
    window.currentNoteIndex = noteIndex;
    
    // Get existing note text if any
    const existingNoteElement = document.getElementById(`note-text-${noteIndex}`);
    const existingNote = existingNoteElement ? existingNoteElement.textContent.trim() : '';
    
    console.log('Existing note:', existingNote);
    
    // Populate modal with existing note
    const textarea = document.getElementById('modal-notes-textarea');
    if (textarea) {
        textarea.value = existingNote;
    } else {
        console.error('Modal textarea not found');
    }
    
    // Show modal
    const modal = document.getElementById('noteModal');
    if (modal) {
        modal.style.display = 'flex';
        console.log('Modal should be visible now');
    } else {
        console.error('Modal element not found');
    }
    
    // Focus on textarea
    setTimeout(() => {
        if (textarea) {
            textarea.focus();
        }
    }, 100);
}

function closeNoteModal() {
    const modal = document.getElementById('noteModal');
    modal.style.display = 'none';
    
    // Clear form
    document.getElementById('modal-notes-textarea').value = '';
    
    // Reset global variables
    window.currentNoteDate = '';
    window.currentNotePlayerName = '';
    window.currentNoteIndex = -1;
}

// Make functions globally available immediately
window.openNoteModal = openNoteModal;
window.closeNoteModal = closeNoteModal;

console.log('Note modal functions defined and made global');
console.log('openNoteModal type:', typeof window.openNoteModal);

async function updateAvailability(button, playerName, date, status) {
    // DEBUG: Log the actual date received
    console.log(`DEBUG: updateAvailability called with date='${date}', type=${typeof date}`);
    
    const buttonGroup = button.closest('[data-availability-buttons]');
    const allButtons = buttonGroup.querySelectorAll('button');
    
    // Store original button content
    const originalContent = button.innerHTML;
    
    // Show loading state only on clicked button
    allButtons.forEach(btn => btn.disabled = true);
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>' + button.textContent;
    
    try {
        const user = window.sessionData && window.sessionData.user;
        
        if (!user || !user.series) {
            throw new Error('No user or series information available');
        }
        
        const availabilityStatus = {
            'available': 1,
            'unavailable': 2,
            'not_sure': 3
        }[status];
        
        let standardizedDate = date;
        console.log(`DEBUG: Starting conversion with date='${date}'`);
        
        if (date.includes('/')) {
            const [month, day, year] = date.split('/');
            console.log(`DEBUG: Split parts - month='${month}', day='${day}', year='${year}'`);
            
            // Convert 2-digit year to 4-digit year
            const fullYear = year.length === 2 ? `20${year}` : year;
            console.log(`DEBUG: Year conversion - original='${year}', fullYear='${fullYear}'`);
            
            standardizedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            console.log(`DEBUG: Final standardizedDate='${standardizedDate}'`);
        }
        
        // Notes are now handled via modal, so we don't include them in availability updates
        const notes = '';
        
        // Use tenniscores_player_id if available, fallback to player_name for legacy support
        const requestData = {
            'match_date': standardizedDate.trim(),
            'availability_status': availabilityStatus,
            'series': user.series.trim(),
            'notes': notes
        };
        
        // Prefer tenniscores_player_id over player_name
        if (user.tenniscores_player_id) {
            requestData.tenniscores_player_id = user.tenniscores_player_id.trim();
            requestData.player_name = playerName.trim(); // Keep for logging/display purposes
        } else {
            requestData.player_name = playerName.trim(); // Legacy fallback
        }
        
        const response = await fetch('/api/availability', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to save availability');
        }
        
        // Update button states with the new CSS classes
        allButtons.forEach(btn => {
            const btnStatus = btn.getAttribute('data-status');
            btn.disabled = false;
            btn.setAttribute('data-current-status', status);
            
            // Remove all selection classes first
            btn.classList.remove('selected-available', 'selected-unavailable', 'selected-not-sure');
            
            // Add the appropriate selection class based on the new status
            if (status === btnStatus) {
                if (status === 'available') {
                    btn.classList.add('selected-available');
                } else if (status === 'unavailable') {
                    btn.classList.add('selected-unavailable');
                } else if (status === 'not_sure') {
                    btn.classList.add('selected-not-sure');
                }
            }
            
            // Restore original content for clicked button
            if (btn === button) {
                btn.innerHTML = originalContent;
            }
        });
        
        // Show success toast that fades out
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300';
        toast.textContent = 'Availability updated!';
        document.body.appendChild(toast);
        
        // Fade in
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            // Fade out after 2 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        });
        
    } catch (error) {
        console.error('Error saving availability:', error);
        
        // Re-enable buttons and restore original state
        allButtons.forEach(btn => {
            btn.disabled = false;
            // Restore original content for clicked button
            if (btn === button) {
                btn.innerHTML = originalContent;
            }
        });
        
        // Show error toast with fade effect
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300';
        toast.textContent = error.message || 'Error saving availability. Please try again.';
        document.body.appendChild(toast);
        
        // Fade in
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            // Fade out after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        });
    }
}



// Global variables to track current note context (using window object)
// Variables are now stored on window object and accessed in functions above

async function saveNoteFromModal() {
    const textarea = document.getElementById('modal-notes-textarea');
    const notes = textarea.value.trim();
    
    if (window.currentNoteIndex < 0) {
        console.error('No note context available');
        return;
    }
    
    console.log('Saving note for:', { 
        currentNoteDate: window.currentNoteDate, 
        currentNotePlayerName: window.currentNotePlayerName, 
        currentNoteIndex: window.currentNoteIndex, 
        notes 
    });
    
    try {
        const user = window.sessionData && window.sessionData.user;
        if (!user || !user.series) {
            throw new Error('No user information available');
        }
        
        // Find the current availability status for this match
        const noteDisplayElement = document.getElementById(`note-display-${window.currentNoteIndex}`);
        const matchCard = noteDisplayElement ? noteDisplayElement.closest('.schedule-card') : null;
        const selectedButton = matchCard ? matchCard.querySelector('.selected-available, .selected-unavailable, .selected-not-sure') : null;
        
        let availabilityStatus = 3; // Default to "not sure" if no selection
        if (selectedButton) {
            const status = selectedButton.getAttribute('data-status');
            availabilityStatus = {
                'available': 1,
                'unavailable': 2,
                'not_sure': 3
            }[status];
        }
        
        // Convert date to standard format
        let standardizedDate = window.currentNoteDate;
        if (window.currentNoteDate.includes('/')) {
            const [month, day, year] = window.currentNoteDate.split('/');
            const fullYear = year.length === 2 ? `20${year}` : year;
            standardizedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        
        // Use tenniscores_player_id if available, fallback to player_name for legacy support
        const requestData = {
            'match_date': standardizedDate.trim(),
            'availability_status': availabilityStatus,
            'series': user.series.trim(),
            'notes': notes
        };
        
        // Prefer tenniscores_player_id over player_name
        if (user.tenniscores_player_id) {
            requestData.tenniscores_player_id = user.tenniscores_player_id.trim();
            requestData.player_name = window.currentNotePlayerName.trim(); // Keep for logging/display purposes
        } else {
            requestData.player_name = window.currentNotePlayerName.trim(); // Legacy fallback
        }
        
        // Show loading state
        const saveButton = document.querySelector('.modal-button-save');
        const originalContent = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Saving...';
        saveButton.disabled = true;
        
        // Ensure button state is restored after a timeout as backup
        const timeoutId = setTimeout(() => {
            saveButton.innerHTML = originalContent;
            saveButton.disabled = false;
            console.error('Save operation timed out - button state restored');
        }, 10000);
        
        const response = await fetch('/api/availability', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to save note');
        }
        
        // Update the note display and button visibility
        const noteDisplayContainer = document.getElementById(`note-display-${window.currentNoteIndex}`);
        const noteText = document.getElementById(`note-text-${window.currentNoteIndex}`);
        const addNoteContainer = document.getElementById(`add-note-container-${window.currentNoteIndex}`);
        
        if (notes) {
            // Show note if there's content, hide add button
            noteText.textContent = notes;
            noteDisplayContainer.style.display = 'block';
            addNoteContainer.style.display = 'none';
        } else {
            // Hide note if empty, show add button
            noteDisplayContainer.style.display = 'none';
            addNoteContainer.style.display = 'block';
        }
        
        // Clear timeout and restore button state
        clearTimeout(timeoutId);
        saveButton.innerHTML = originalContent;
        saveButton.disabled = false;
        
        // Close modal
        closeNoteModal();
        
        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300';
        toast.textContent = notes ? 'Note saved!' : 'Note removed!';
        document.body.appendChild(toast);
        
        // Fade in toast
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        });
        
    } catch (error) {
        console.error('Error saving note:', error);
        
        // Clear timeout and restore button state
        clearTimeout(timeoutId);
        const saveButton = document.querySelector('.modal-button-save');
        saveButton.innerHTML = originalContent;
        saveButton.disabled = false;
        
        // Show error toast
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity duration-300';
        toast.textContent = error.message || 'Error saving note. Please try again.';
        document.body.appendChild(toast);
        
        // Fade in toast
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        });
    }
}

// Make saveNoteFromModal globally available too
window.saveNoteFromModal = saveNoteFromModal;

// Test function to verify JavaScript is working
window.testModal = function() {
    console.log('Test modal function called');
    const modal = document.getElementById('noteModal');
    if (modal) {
        modal.style.display = 'flex';
        console.log('Test modal opened successfully');
    } else {
        console.error('Modal not found in test');
    }
};

console.log('Note modal JavaScript loaded successfully');
console.log('Available functions:');
console.log('- openNoteModal:', typeof window.openNoteModal);
console.log('- closeNoteModal:', typeof window.closeNoteModal);
console.log('- saveNoteFromModal:', typeof window.saveNoteFromModal);

    // Initialize team selector modal functionality
    const teamSelectorLink = document.getElementById('teamSelectorLink');
    const switchTeamBtn = document.getElementById('switchTeamBtn');
    const teamSelectorModal = document.getElementById('teamSelectorModal');
    const closeTeamModal = document.getElementById('closeTeamModal');

    // Debug logging to understand what's happening
    console.log('[DEBUG] Team modal elements:', {
        teamSelectorLink: !!teamSelectorLink,
        switchTeamBtn: !!switchTeamBtn,
        teamSelectorModal: !!teamSelectorModal,
        closeTeamModal: !!closeTeamModal
    });

    // Ensure modal starts hidden
    if (teamSelectorModal) {
        teamSelectorModal.classList.add('hidden');
        teamSelectorModal.style.display = 'none';
        console.log('[DEBUG] Team modal ensured to be hidden on page load');
        
        // Add a safeguard to prevent any unwanted automatic opening
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const target = mutation.target;
                    // If the modal loses the 'hidden' class without user interaction, add it back
                    if (!target.classList.contains('hidden') && target.style.display !== 'flex') {
                        console.log('[DEBUG] Auto-correcting unwanted modal visibility');
                        target.classList.add('hidden');
                        target.style.display = 'none';
                    }
                }
            });
        });
        
        observer.observe(teamSelectorModal, { attributes: true });
        console.log('[DEBUG] Modal visibility safeguard installed');
    }

    // Function to open team selector modal
    function openTeamSelectorModal(e) {
        e.preventDefault();
        console.log('[DEBUG] openTeamSelectorModal called');
        if (teamSelectorModal) {
            // Remove both the hidden class and the inline style
            teamSelectorModal.classList.remove('hidden');
            teamSelectorModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            console.log('[DEBUG] Team modal shown');
        }
    }

    // Function to close team selector modal
    function closeTeamSelectorModal() {
        console.log('[DEBUG] closeTeamSelectorModal called');
        if (teamSelectorModal) {
            teamSelectorModal.classList.add('hidden');
            teamSelectorModal.style.display = 'none';
            document.body.style.overflow = '';
            console.log('[DEBUG] Team modal hidden');
        }
    }

    // Add event listeners for both buttons (only once)
    if (teamSelectorLink && !teamSelectorLink.hasAttribute('data-listener-added')) {
        teamSelectorLink.addEventListener('click', openTeamSelectorModal);
        teamSelectorLink.setAttribute('data-listener-added', 'true');
        console.log('[DEBUG] Team selector link listener added');
    }
    if (switchTeamBtn && !switchTeamBtn.hasAttribute('data-listener-added')) {
        switchTeamBtn.addEventListener('click', openTeamSelectorModal);
        switchTeamBtn.setAttribute('data-listener-added', 'true');
        console.log('[DEBUG] Switch team button listener added');
    }

    if (teamSelectorModal) {
        // Close modal with X button
        if (closeTeamModal && !closeTeamModal.hasAttribute('data-listener-added')) {
            closeTeamModal.addEventListener('click', function(e) {
                e.preventDefault();
                closeTeamSelectorModal();
            });
            closeTeamModal.setAttribute('data-listener-added', 'true');
            console.log('[DEBUG] Close team modal button listener added');
        }
        
        // Close modal when clicking outside (only add once)
        if (!teamSelectorModal.hasAttribute('data-listener-added')) {
            teamSelectorModal.addEventListener('click', function(e) {
                if (e.target === teamSelectorModal) {
                    closeTeamSelectorModal();
                }
            });
            teamSelectorModal.setAttribute('data-listener-added', 'true');
            console.log('[DEBUG] Team modal outside click listener added');
        }
        
        // Close on escape key (only add once per page)
        if (!document.hasAttribute('data-escape-listener-added')) {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !teamSelectorModal.classList.contains('hidden')) {
                    closeTeamSelectorModal();
                }
            });
            document.setAttribute('data-escape-listener-added', 'true');
            console.log('[DEBUG] Escape key listener added');
        }
    }

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('noteModal');
    if (event.target === modal) {
        closeNoteModal();
    }
});

// Backup event listeners for add note buttons in case onclick doesn't work
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up backup event listeners for add note buttons');
    
    // Add click listeners to all add note buttons
    const addNoteButtons = document.querySelectorAll('.add-note-button');
    console.log('Found', addNoteButtons.length, 'add note buttons');
    
    addNoteButtons.forEach((button, index) => {
        button.addEventListener('click', function(event) {
            console.log('Add note button clicked via event listener:', index);
            
            // Find the match data from the button's context
            const container = button.closest('.schedule-card');
            if (container) {
                // Try to extract data from nearby elements
                const dateElement = container.querySelector('[data-raw-date]');
                const matchDate = dateElement ? dateElement.getAttribute('data-raw-date') : '';
                
                // Get player name from session data if available
                const firstName = window.sessionData?.user?.first_name || '';
                const lastName = window.sessionData?.user?.last_name || '';
                const playerName = firstName && lastName ? `${firstName} ${lastName}` : 'Unknown Player';
                
                console.log('Extracted data:', { matchDate, playerName, index });
                
                if (matchDate) {
                    openNoteModal(matchDate, playerName, index);
                } else {
                    console.error('Could not find match date for note button');
                }
            }
        });
    });
});
</script>

<!-- Availability Filter Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const filterBtns = document.querySelectorAll('.schedule-filter-btn');
    const cards = document.querySelectorAll('.schedule-card');
    const dateGroups = document.querySelectorAll('.schedule-date-group');
    
    filterBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        // Remove active class from all buttons
        filterBtns.forEach(b => b.classList.remove('active'));
        // Add active class to clicked button
        btn.classList.add('active');
        
        const filter = btn.getAttribute('data-filter');
        
        // Filter cards based on selection
        cards.forEach(card => {
          if (filter === 'all') {
            card.style.display = '';
          } else if (filter === 'matches') {
            card.style.display = card.getAttribute('data-type') === 'match' ? '' : 'none';
          } else if (filter === 'practices') {
            card.style.display = card.getAttribute('data-type') === 'practice' ? '' : 'none';
          }
        });
        
        // Hide date groups with no visible cards
        dateGroups.forEach(group => {
          const visibleCards = Array.from(group.querySelectorAll('.schedule-card')).some(card => card.style.display !== 'none');
          group.style.display = visibleCards ? '' : 'none';
        });
      });
    });
    
    // Initial group visibility check
    dateGroups.forEach(group => {
      const visibleCards = Array.from(group.querySelectorAll('.schedule-card')).some(card => card.style.display !== 'none');
      group.style.display = visibleCards ? '' : 'none';
    });
  });
</script>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-200 { border-color: #e5e7eb; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-white { background-color: #ffffff; }
.bg-blue-50 { background-color: #eff6ff; }

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-blue-500 { color: #3b82f6; }
.text-orange-500 { color: #f97316; }
.text-yellow-500 { color: #f59e0b; }
.text-red-500 { color: #ef4444; }
.text-white { color: #ffffff; }

/* Gradient backgrounds */
.bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}
.from-green-500 {
    --tw-gradient-from: #10b981;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(16, 185, 129, 0));
}
.to-green-600 {
    --tw-gradient-to: #059669;
}

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }

/* Filter button styling */
.schedule-filter-btn {
    background-color: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.schedule-filter-btn.active {
    background-color: #3b82f6;
    color: #ffffff;
    border-color: #3b82f6;
}

.schedule-filter-btn:hover {
    background-color: #e5e7eb;
}

.schedule-filter-btn.active:hover {
    background-color: #2563eb;
}

/* Header styling for practices and matches */
.practice-header {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.match-header {
    background: linear-gradient(135deg, #1f2937, #111827);
    color: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.btn {
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: none !important;
}

.btn:focus {
    outline: none;
}

.availability-btn {
    text-transform: none !important;
    transition: all 0.3s ease;
    border: none;
}

/* View team button styling */
.availability-btn.view-team-btn {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 0.5rem !important;
    text-decoration: none !important;
}

.availability-btn.view-team-btn i {
    display: inline-block !important;
    margin-right: 0 !important;
}

/* Focus ring utilities */
.focus\:ring-2:focus {
    --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
    --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
    box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus\:ring-green-500:focus { --tw-ring-color: #10b981; }
.focus\:ring-red-500:focus { --tw-ring-color: #ef4444; }
.focus\:ring-yellow-500:focus { --tw-ring-color: #f59e0b; }
.focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }

/* Add loading spinner animation */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spin {
    animation: spin 1s linear infinite;
}

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.duration-200 {
    transition-duration: 200ms;
}

/* Responsive design */
@media (max-width: 640px) {
    .px-6 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .gap-6 { gap: 1rem; }
    .w-\[200px\] { width: 180px; }
}

/* Utility classes */
.hidden { display: none; }
.flex { display: flex; }
.items-center { align-items: center; }
.justify-center { justify-content: center; }
.font-medium { font-weight: 500; }
.font-semibold { font-weight: 600; }
.font-bold { font-weight: 700; }

/* Clean Availability Section Styles */
.availability-column {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    width: 187px;
    flex-shrink: 0;
}

.availability-container {
    width: 187px;
    box-sizing: border-box;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    background-color: #f9fafb;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
}

.availability-container.blue-container {
    background-color: #eff6ff;
}

.availability-button {
    width: 100%;
    padding: 0.625rem;
    text-align: center;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.2s;
    border: 1px solid #d1d5db;
    cursor: pointer;
    background-color: #f3f4f6;
    color: #374151;
}

.availability-button i {
    margin-right: 0.25rem;
}

.availability-button:hover {
    opacity: 0.9;
}

.availability-button.selected-available {
    background-color: #22c55e;
    color: white;
}

.availability-button.selected-available:hover {
    background-color: #16a34a;
}

.availability-button.selected-unavailable {
    background-color: #ef4444;
    color: white;
}

.availability-button.selected-not-sure {
    background-color: #f59e0b;
    color: white;
}

.notes-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.notes-label i {
    margin-right: 0.25rem;
}

.notes-textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 0.5rem;
    font-size: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    resize: none;
    background-color: white;
    line-height: 1.2;
}

.notes-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.notes-help {
    font-size: 0.75rem;
    color: #6b7280;
}

.add-note-button {
    width: 100%;
    padding: 0.625rem;
    text-align: center;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    background-color: #e5e7eb;
    color: #374151;
    border: 1px solid #d1d5db;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    z-index: 1;
    pointer-events: auto;
}

.add-note-button:hover {
    background-color: #d1d5db;
}

.add-note-button:active {
    background-color: #9ca3af;
    transform: scale(0.98);
}

.add-note-button i {
    margin-right: 0.25rem;
    pointer-events: none;
}

/* Note Display Styles */
.note-display {
    background-color: #f9fafb !important;
    border: 1px solid #e5e7eb !important;
}

.note-content {
    width: 100%;
}

.note-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.note-header-left {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.note-label-text {
    font-size: 0.625rem;
    font-weight: 500;
    color: #6b7280;
}

.note-title {
    font-size: 0.625rem;
    font-weight: 500;
    color: #6b7280;
    margin-left: 0.25rem;
}

.edit-note-button {
    padding: 0.25rem 0.5rem;
    font-size: 0.5rem;
    background-color: #9ca3af;
    color: white;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}

.edit-note-button:hover {
    background-color: #6b7280;
}

.edit-note-button i {
    margin-right: 0.25rem;
}

.note-text {
    font-size: 0.625rem;
    color: #6b7280;
    background-color: white;
    padding: 0.5rem;
    border-radius: 0.375rem;
    border: 1px solid #e5e7eb;
    word-wrap: break-word;
    white-space: pre-wrap;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
}

.modal-container {
    background-color: white;
    border-radius: 0.75rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    width: 100%;
    max-width: 400px;
    max-height: 90vh;
    overflow: hidden;
}

.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.modal-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
}

.modal-title i {
    margin-right: 0.5rem;
    color: #3b82f6;
}

.modal-close {
    width: 2rem;
    height: 2rem;
    border: none;
    background-color: transparent;
    color: #6b7280;
    cursor: pointer;
    border-radius: 0.375rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.modal-close:hover {
    background-color: #f3f4f6;
    color: #374151;
}

.modal-content {
    padding: 1.25rem;
}

.modal-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
}

.modal-textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    resize: vertical;
    background-color: white;
    line-height: 1.5;
    min-height: 100px;
}

.modal-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-footer {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-top: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.modal-button {
    flex: 1;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border-radius: 0.5rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-button-cancel {
    background-color: #f3f4f6;
    color: #374151;
}

.modal-button-cancel:hover {
    background-color: #e5e7eb;
}

.modal-button-save {
    background-color: #10b981;
    color: white;
}

.modal-button-save:hover {
    background-color: #059669;
}

.modal-button-save:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}

.modal-button i {
    margin-right: 0.25rem;
}

.view-team-button {
    width: 100%;
    padding: 0.625rem;
    text-align: center;
    border-radius: 0.5rem;
    font-size: 0.625rem;
    font-weight: 600;
    background-color: #3b82f6;
    color: white;
    text-decoration: none;
    display: block;
    transition: all 0.2s;
}

.view-team-button:hover {
    background-color: #2563eb;
}
</style>
{% endblock %} 