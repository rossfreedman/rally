{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Groups List View -->
    <div id="groupsListView">
        <!-- Header -->
        <div class="bg-white border-b border-gray-100">
            <div class="flex items-center px-4 py-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                    <i class="fas fa-users text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <h1 class="text-xl font-bold text-gray-900">Group Chats</h1>
                    <p class="text-sm text-gray-500">Create groups of your peeps to easily communicate</p>
                </div>
            </div>
        </div>

        <!-- Create Group Action -->
        <div class="bg-white px-4 py-4 border-b border-gray-100">
            <button onclick="showCreateGroupModal()" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg shadow-sm text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                <i class="fas fa-plus mr-2"></i>Create Group Chat
            </button>
        </div>

        <!-- Content -->
        <div class="px-4 py-6 space-y-6">
            <!-- Group Chats Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50">
                    <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-users text-purple-500 mr-2"></i>
                        Group Chats
                    </h2>
                    <p class="text-sm text-gray-600 mt-2">Groups you've created or joined to organize players.</p>
                </div>
                
                <div id="groupsContainer" class="p-4">
                    <!-- Loading state -->
                    <div id="loadingGroups" class="text-center py-8">
                        <div class="loading-spinner loading-lg mx-auto mb-4" style="border-top-color: #9333ea;"></div>
                        <p class="text-gray-500">Loading groups...</p>
                    </div>
                    
                    <!-- Empty state -->
                    <div id="emptyState" class="text-center py-8 hidden">
                        <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">No Groups Yet</h3>
                        <p class="text-gray-500 mb-4">Create your first group to organize players and build connections!</p>
                        <button onclick="showCreateGroupModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors shadow-sm">
                            <i class="fas fa-plus mr-2"></i>Create Your First Group Chat
                        </button>
                    </div>
                    
                    <!-- Error state -->
                    <div id="errorState" class="text-center py-8 hidden">
                        <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Failed to Load Groups</h3>
                        <p class="text-gray-500 mb-4">There was an error loading your groups. Please try again.</p>
                        <button onclick="loadGroups()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                            <i class="fas fa-refresh mr-2"></i>Retry
                        </button>
                    </div>
                    
                    <!-- Groups will be populated here -->
                    <div id="groupsList" class="space-y-4 hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Group Details View -->
    <div id="groupDetailsView" class="hidden">
        <!-- Header -->
        <div class="bg-white border-b border-gray-100">
            <div class="flex items-center px-4 py-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                    <i class="fas fa-users text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <h1 id="groupDetailsTitle" class="text-xl font-bold text-gray-900">Group Details</h1>
                    <p class="text-sm text-gray-500">Manage your group members</p>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="bg-white px-4 py-4 border-b border-gray-100">
            <div class="flex gap-3">
                <button onclick="showTextGroupPage()" id="textGroupButton" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg shadow-sm text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-comments mr-2"></i>
                    <span>Text Group</span>
                </button>
                <button onclick="showEditGroupModal()" id="editGroupButton" class="hidden flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg shadow-sm text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                    <i class="fas fa-edit mr-2"></i>
                    <span>Edit Group</span>
                </button>
            </div>
        </div>
        
        <!-- Content -->
        <div class="px-4 py-6 space-y-6">
            <!-- Group Info Card -->
            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 border border-purple-100">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h3 id="groupDetailsName" class="font-bold text-xl text-gray-900 mb-1"></h3>
                        <p id="groupDetailsDescription" class="text-gray-600 mb-3"></p>
                        <div class="space-y-2 text-sm text-gray-500">
                            <div class="flex items-center">
                                <i class="fas fa-users mr-2 text-purple-500"></i>
                                <span id="groupDetailsMemberCount"></span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-calendar mr-2 text-purple-500"></i>
                                <span id="groupDetailsCreated"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Member Section (Creator Only) -->
            <div id="addMemberSection" class="hidden">
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-user-plus text-green-500 mr-2"></i>
                            Add Members
                        </h4>
                        <div id="searchContextInfo" class="text-xs text-gray-500 mt-1 hidden">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span id="searchContext"></span>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="flex gap-2 mb-3">
                            <input type="text" id="playerSearchInput" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm"
                                   placeholder="Search for players by name...">
                            <button onclick="searchPlayers()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-sm text-sm font-medium">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="searchResults" class="hidden">
                            <div class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg bg-white shadow-sm">
                                <div id="searchResultsList" class="divide-y divide-gray-100">
                                    <!-- Search results will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members List -->
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                    <h4 class="font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-users text-purple-500 mr-2"></i>
                        Members
                    </h4>
                </div>
                <div class="p-4">
                    <div id="groupMembersList" class="space-y-3">
                        <!-- Members will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Group View -->
    <div id="textGroupView" class="hidden">
        <!-- Header -->
        <div class="bg-white border-b border-gray-100">
            <div class="flex items-center px-4 py-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm" style="background-color: #10645c !important;">
                    <i class="fas fa-comments text-white text-lg"></i>
                </div>
                <div class="ml-4">
                    <h1 id="textGroupTitle" class="text-xl font-bold text-gray-900">Text Group</h1>
                    <p class="text-sm text-gray-500">Send a message to all group members</p>
                </div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="px-4 py-6">
            <form id="textGroupForm" class="space-y-6">
                <!-- Group Info -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4 border border-green-100">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center mr-3">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <div>
                            <h3 id="textGroupName" class="font-bold text-lg text-gray-900"></h3>
                            <p id="textGroupMemberCount" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                </div>

                <!-- Message Composition -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                        <h4 class="font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-edit text-blue-500 mr-2"></i>
                            Compose Message
                        </h4>
                    </div>
                    
                    <div class="p-4 space-y-4">
                        <div>
                            <label for="messageBody" class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                            <textarea id="messageBody" name="messageBody" rows="8" required maxlength="800"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                      placeholder="Write your message here..."></textarea>
                            <div class="text-sm text-gray-500 mt-1">
                                <span id="messageCounter">0</span>/800 characters (SMS limit)
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-3">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
                                <div class="text-sm text-blue-700">
                                    <p class="font-medium mb-1">Message will be sent to:</p>
                                    <p id="recipientsList"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <button type="button" onclick="showTextGroupBackNavigation()" 
                            class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200 font-medium">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <button type="submit" id="sendMessageBtn"
                            class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors duration-200 shadow-sm font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>Send Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Group Modal -->
<div id="editGroupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-white rounded-xl max-w-md w-full shadow-xl">
        <div class="px-6 py-4 border-b border-gray-100 bg-purple-600 rounded-t-xl">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Edit Group</h2>
                <button onclick="hideEditGroupModal()" class="text-white hover:text-gray-200 focus:outline-none">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form id="editGroupForm" class="p-6">
            <div class="mb-4">
                <label for="editGroupName" class="block text-sm font-medium text-gray-700 mb-2">Group Name</label>
                <input type="text" id="editGroupName" name="editGroupName" required maxlength="255"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                       placeholder="Enter group name">
            </div>
            
            <div class="mb-6">
                <label for="editGroupDescription" class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                <textarea id="editGroupDescription" name="editGroupDescription" rows="3" maxlength="500"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          placeholder="Describe your group..."></textarea>
                <div class="text-sm text-gray-500 mt-1">
                    <span id="editDescriptionCounter">0</span>/500 characters
                </div>
            </div>
            
            <div class="flex gap-3">
                <button type="button" onclick="hideEditGroupModal()" 
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" id="updateGroupBtn"
                        class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors duration-200 shadow-sm font-medium">
                    Update Group
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
  <div class="bg-white rounded-xl max-w-md w-full shadow-xl">
    <div class="px-6 py-4 border-b border-gray-100 bg-purple-600 rounded-t-xl">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Create New Group Chat</h2>
        <button onclick="hideCreateGroupModal()" class="text-white hover:text-gray-200 focus:outline-none">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>
    
    <form id="createGroupForm" class="p-6">
      <div class="mb-4">
        <label for="groupName" class="block text-sm font-medium text-gray-700 mb-2">Group Name</label>
        <input type="text" id="groupName" name="groupName" required maxlength="255"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
               placeholder="Enter group name">
      </div>
      
      <div class="mb-6">
        <label for="groupDescription" class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
        <textarea id="groupDescription" name="groupDescription" rows="3" maxlength="500"
                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  placeholder="Describe your group..."></textarea>
        <div class="text-sm text-gray-500 mt-1">
          <span id="descriptionCounter">0</span>/500 characters
        </div>
      </div>
      
      <div class="flex gap-3">
        <button type="button" onclick="hideCreateGroupModal()" 
                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">
          Cancel
        </button>
        <button type="submit" id="createGroupBtn"
                class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors duration-200 shadow-sm">
          Create Group Chat
        </button>
      </div>
    </form>
  </div>
</div>



<!-- Toast Notification -->
<div id="toast" class="fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg hidden z-50 transition-all duration-300">
  <span id="toastMessage"></span>
</div>

<script>
let currentGroupId = null;
let searchTimeout = null;

// Get session data for league filtering
const sessionData = {{ session_data | tojson | safe }};
const userLeagueId = sessionData?.user?.league_id || null;
const userClub = sessionData?.user?.club || null;

console.log('User context for search:', { userLeagueId, userClub });

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadGroups();
    
    // Setup form event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Create group form
    document.getElementById('createGroupForm').addEventListener('submit', handleCreateGroup);
    
    // Edit group form
    document.getElementById('editGroupForm').addEventListener('submit', handleEditGroup);
    
    // Text group form
    document.getElementById('textGroupForm').addEventListener('submit', handleTextGroup);
    
    // Description counters
    document.getElementById('groupDescription').addEventListener('input', updateDescriptionCounter);
    document.getElementById('editGroupDescription').addEventListener('input', updateEditDescriptionCounter);
    document.getElementById('messageBody').addEventListener('input', updateMessageCounter);
    
    // Player search with type-ahead functionality
    setupTypeAhead();
}

// Text Group Functions
function showTextGroupPage() {
    if (!window.currentGroup) {
        showToast('Group data not available', 'error');
        return;
    }
    
    const group = window.currentGroup;
    
    // Reset flag to indicate user came from group details page (not card)
    window.textGroupFromCard = false;
    
    // Populate text group page
    document.getElementById('textGroupName').textContent = group.name;
    document.getElementById('textGroupMemberCount').textContent = `${group.member_count} member${group.member_count !== 1 ? 's' : ''}`;
    
    // Show recipients list with phone numbers
    const membersWithPhones = group.members.filter(member => member.phone_number && member.phone_number.trim());
    const membersWithoutPhones = group.members.filter(member => !member.phone_number || !member.phone_number.trim());
    
    let recipientsText = '';
    
    if (membersWithPhones.length > 0) {
        const phoneList = membersWithPhones.map(member => `${member.first_name} ${member.last_name} (${member.phone_number})`);
        recipientsText += `Will receive SMS: ${phoneList.join(', ')}`;
    }
    
    if (membersWithoutPhones.length > 0) {
        const noPhoneList = membersWithoutPhones.map(member => `${member.first_name} ${member.last_name}`);
        if (recipientsText) recipientsText += '. ';
        recipientsText += `No phone numbers: ${noPhoneList.join(', ')}`;
    }
    
    document.getElementById('recipientsList').textContent = recipientsText || 'No members to text';
    
    // Clear form
    document.getElementById('textGroupForm').reset();
    updateMessageCounter();
    
    // Show text group view
    hideElement('groupDetailsView');
    showElement('textGroupView');
}

function showGroupDetailsFromText() {
    hideElement('textGroupView');
    showElement('groupDetailsView');
}

function showTextGroupBackNavigation() {
    // Check where the user came from and navigate accordingly
    if (window.textGroupFromCard) {
        // User came directly from group card, go back to groups list
        hideElement('textGroupView');
        showElement('groupsListView');
        window.textGroupFromCard = false; // Reset flag
    } else {
        // User came from group details page, go back to details
        showGroupDetailsFromText();
    }
}

async function showTextGroupFromCard(groupId) {
    try {
        currentGroupId = groupId;
        
        const response = await fetch(`/api/groups/${groupId}`);
        const data = await response.json();
        
        if (data.success) {
            // Store group data globally
            window.currentGroup = data.group;
            
            // Set flag to indicate user came from group card (not group details)
            window.textGroupFromCard = true;
            
            // Populate text group page
            document.getElementById('textGroupName').textContent = data.group.name;
            document.getElementById('textGroupMemberCount').textContent = `${data.group.member_count} member${data.group.member_count !== 1 ? 's' : ''}`;
            
            // Show recipients list with phone numbers
            const membersWithPhones = data.group.members.filter(member => member.phone_number && member.phone_number.trim());
            const membersWithoutPhones = data.group.members.filter(member => !member.phone_number || !member.phone_number.trim());
            
            let recipientsText = '';
            
            if (membersWithPhones.length > 0) {
                const phoneList = membersWithPhones.map(member => `${member.first_name} ${member.last_name} (${member.phone_number})`);
                recipientsText += `Will receive SMS: ${phoneList.join(', ')}`;
            }
            
            if (membersWithoutPhones.length > 0) {
                const noPhoneList = membersWithoutPhones.map(member => `${member.first_name} ${member.last_name}`);
                if (recipientsText) recipientsText += '. ';
                recipientsText += `No phone numbers: ${noPhoneList.join(', ')}`;
            }
            
            document.getElementById('recipientsList').textContent = recipientsText || 'No members to text';
            
            // Clear form
            document.getElementById('textGroupForm').reset();
            updateMessageCounter();
            
            // Hide groups list and show text group view directly
            hideElement('groupsListView');
            showElement('textGroupView');
        } else {
            showToast(data.error || 'Failed to load group details', 'error');
        }
    } catch (error) {
        console.error('Error loading group for texting:', error);
        showToast('Failed to load group for texting', 'error');
    }
}

async function handleTextGroup(e) {
    e.preventDefault();
    
    const btn = document.getElementById('sendMessageBtn');
    const originalText = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Sending...';
        
        const formData = new FormData(e.target);
        const messageBody = formData.get('messageBody').trim();
        
        // Validate message length
        if (messageBody.length > 800) {
            showToast('Message too long. Please keep under 800 characters for SMS.', 'error');
            return;
        }
        
        const messageData = {
            group_id: currentGroupId,
            subject: 'Group Message', // Default subject for text messages
            message: messageBody
        };
        
        const response = await fetch('/api/groups/send-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(messageData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show detailed success message
            const details = data.details || {};
            let toastMessage = data.message;
            
            // If there were some failures, show detailed info
            if (details.failed_sends > 0) {
                const failedNames = details.failed_recipients?.map(r => r.name).join(', ') || '';
                toastMessage += failedNames ? ` Failed: ${failedNames}` : '';
            }
            
            // If there were members without phone numbers, mention it
            if (details.members_without_phones > 0) {
                const noPhoneNames = details.members_without_phones_list?.join(', ') || '';
                if (noPhoneNames) {
                    toastMessage += ` Note: ${noPhoneNames} ${details.members_without_phones === 1 ? 'has' : 'have'} no phone number set.`;
                }
            }
            
            // Show admin recipients info if in console (not in toast - too long)
            if (details.admin_successful_sends > 0) {
                console.log(`📧 Admin copies sent to ${details.admin_successful_sends} admin(s):`, 
                          details.admin_successful_recipients?.map(r => r.name).join(', '));
            }
            
            showToast(toastMessage, 'success');
            
            // Clear the form and go back
            document.getElementById('textGroupForm').reset();
            updateMessageCounter();
            showTextGroupBackNavigation();
            
        } else {
            // Handle different types of errors
            let errorMessage = data.error || 'Failed to send message';
            
            // If it's a phone number issue, provide helpful guidance
            if (response.status === 422 || errorMessage.includes('phone number')) {
                const details = data.details || {};
                if (details.members_without_phones_list && details.members_without_phones_list.length > 0) {
                    errorMessage += ` Members without phone numbers: ${details.members_without_phones_list.join(', ')}. Ask them to add phone numbers in Settings.`;
                }
            }
            
            showToast(errorMessage, 'error');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Network error while sending message. Please try again.', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Edit Group Functions
function showEditGroupModal() {
    if (!window.currentGroup) {
        showToast('Group data not available', 'error');
        return;
    }
    
    const group = window.currentGroup;
    
    // Populate edit form with current values
    document.getElementById('editGroupName').value = group.name;
    document.getElementById('editGroupDescription').value = group.description || '';
    updateEditDescriptionCounter();
    
    showElement('editGroupModal');
}

function hideEditGroupModal() {
    hideElement('editGroupModal');
}

async function handleEditGroup(e) {
    e.preventDefault();
    
    const btn = document.getElementById('updateGroupBtn');
    const originalText = btn.textContent;
    
    try {
        btn.disabled = true;
        btn.textContent = 'Updating...';
        
        const formData = new FormData(e.target);
        const groupData = {
            name: formData.get('editGroupName').trim(),
            description: formData.get('editGroupDescription').trim()
        };
        
        const response = await fetch(`/api/groups/${currentGroupId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(groupData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            hideEditGroupModal();
            showToast('Group updated successfully!', 'success');
            // Refresh the group details page
            await showGroupDetailsPage(currentGroupId);
            // Also refresh the groups list for when user goes back
            await loadGroups();
        } else {
            showToast(data.error || 'Failed to update group', 'error');
        }
    } catch (error) {
        console.error('Error updating group:', error);
        showToast('Failed to update group', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Counter functions
function updateEditDescriptionCounter() {
    const textarea = document.getElementById('editGroupDescription');
    const counter = document.getElementById('editDescriptionCounter');
    counter.textContent = textarea.value.length;
}

function updateMessageCounter() {
    const textarea = document.getElementById('messageBody');
    const counter = document.getElementById('messageCounter');
    const length = textarea.value.length;
    const maxLength = 800;
    
    counter.textContent = length;
    
    // Add visual feedback based on character count
    if (length > maxLength) {
        counter.classList.add('text-red-600');
        counter.classList.remove('text-gray-500', 'text-yellow-600');
    } else if (length > maxLength * 0.8) { // Warning at 80% (640 chars)
        counter.classList.add('text-yellow-600');
        counter.classList.remove('text-gray-500', 'text-red-600');
    } else {
        counter.classList.add('text-gray-500');
        counter.classList.remove('text-yellow-600', 'text-red-600');
    }
}

function setupTypeAhead() {
    const searchInput = document.getElementById('playerSearchInput');
    let selectedIndex = -1;
    
    // Handle input with debouncing
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        selectedIndex = -1; // Reset selection
        searchTimeout = setTimeout(() => {
            const query = this.value.trim();
            if (query.length >= 2) {
                searchPlayers();
            } else {
                hideElement('searchResults');
                window.currentSearchResults = [];
            }
        }, 300);
    });
    
    // Handle keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
        const resultsVisible = !document.getElementById('searchResults').classList.contains('hidden');
        const currentResults = window.currentSearchResults || [];
        
        if (!resultsVisible || currentResults.length === 0) {
            return;
        }
        
        switch (e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
                updateSelectionHighlight();
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelectionHighlight();
                break;
                
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && selectedIndex < currentResults.length) {
                    selectPlayer(currentResults[selectedIndex]);
                }
                break;
                
            case 'Escape':
                e.preventDefault();
                hideElement('searchResults');
                window.currentSearchResults = [];
                selectedIndex = -1;
                break;
        }
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#addMemberSection')) {
            hideElement('searchResults');
            window.currentSearchResults = [];
            selectedIndex = -1;
        }
    });
    
    function updateSelectionHighlight() {
        const resultItems = document.querySelectorAll('#searchResultsList .search-result-item');
        resultItems.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('bg-purple-50', 'border-purple-200');
                item.classList.remove('hover:bg-gray-50');
            } else {
                item.classList.remove('bg-purple-50', 'border-purple-200');
                item.classList.add('hover:bg-gray-50');
            }
        });
    }
    
    function selectPlayer(player) {
        // Add the selected player to the group
        addMemberToGroup(player);
        
        // Clear the search
        searchInput.value = '';
        hideElement('searchResults');
        window.currentSearchResults = [];
        selectedIndex = -1;
    }
    
    // Store reference to selection function for use in displaySearchResults
    window.typeAheadSelectPlayer = selectPlayer;
}

function updateDescriptionCounter() {
    const textarea = document.getElementById('groupDescription');
    const counter = document.getElementById('descriptionCounter');
    counter.textContent = textarea.value.length;
}

async function loadGroups() {
    try {
        showElement('loadingGroups');
        hideElement('groupsList');
        hideElement('emptyState');
        hideElement('errorState');
        
        const response = await fetch('/api/groups');
        const data = await response.json();
        
        if (data.success) {
            displayGroups(data.groups);
        } else {
            throw new Error(data.error || 'Failed to load groups');
        }
    } catch (error) {
        console.error('Error loading groups:', error);
        showElement('errorState');
        hideElement('loadingGroups');
    }
}

function displayGroups(groups) {
    hideElement('loadingGroups');
    
    if (groups.length === 0) {
        showElement('emptyState');
        hideElement('groupsList');
        return;
    }
    
    const groupsList = document.getElementById('groupsList');
    groupsList.innerHTML = '';
    
    groups.forEach(group => {
        const groupCard = createGroupCard(group);
        groupsList.appendChild(groupCard);
    });
    
    showElement('groupsList');
    hideElement('emptyState');
}

function createGroupCard(group) {
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-xl p-5 hover:shadow-lg hover:border-purple-300 transition-all duration-300 cursor-pointer';
    
    const roleIcon = group.is_creator ? 'fas fa-crown text-yellow-500' : 'fas fa-user text-purple-500';
    const roleText = group.is_creator ? 'Creator' : 'Member';
    const roleBadgeClass = group.is_creator ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800 border border-yellow-300' : 'bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 border border-purple-300';
    
    card.innerHTML = `
        <!-- Header with gradient background -->
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-4 border border-purple-100">
            <div class="flex items-start justify-between mb-2">
                <div class="flex-1 min-w-0">
                    <h3 class="text-xl font-bold text-gray-900 truncate mb-1">${escapeHtml(group.name)}</h3>
                    ${group.description ? `<p class="text-gray-700 text-sm line-clamp-2">${escapeHtml(group.description)}</p>` : '<p class="text-gray-500 text-sm italic">No description</p>'}
                </div>
                <div class="ml-3 flex-shrink-0">
                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold ${roleBadgeClass} shadow-sm">
                        <i class="${roleIcon} mr-1.5"></i>
                        ${roleText}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="mb-4">
            <div class="flex items-center text-gray-600 mb-2">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                    <i class="fas fa-users text-purple-600 text-sm"></i>
                </div>
                <span class="font-medium">${group.member_count} member${group.member_count !== 1 ? 's' : ''}</span>
            </div>
            
            <div class="flex items-center text-gray-600">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                    <i class="fas fa-calendar text-blue-600 text-sm"></i>
                </div>
                <div class="flex-1">
                    <div class="text-sm font-medium">Created ${formatDate(group.created_at)}</div>
                    ${!group.is_creator ? `<div class="text-xs text-gray-500">by ${escapeHtml(group.creator_name)}</div>` : ''}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-3">
            <button onclick="showGroupDetailsPage(${group.id})" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-lg border border-purple-700">
                <i class="fas fa-arrow-right mr-2"></i>View Group Chat
            </button>
            <button onclick="showTextGroupFromCard(${group.id})" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-lg border border-green-700">
                <i class="fas fa-comments mr-2"></i>Text Group
            </button>
        </div>
    `;
    
    return card;
}

async function showGroupDetailsPage(groupId) {
    try {
        currentGroupId = groupId;
        
        const response = await fetch(`/api/groups/${groupId}`);
        const data = await response.json();
        
        if (data.success) {
            populateGroupDetailsPage(data.group);
            hideElement('groupsListView');
            showElement('groupDetailsView');
        } else {
            showToast(data.error || 'Failed to load group details', 'error');
        }
    } catch (error) {
        console.error('Error loading group details:', error);
        showToast('Failed to load group details', 'error');
    }
}

function showGroupsList() {
    hideElement('groupDetailsView');
    hideElement('searchResults');
    showElement('groupsListView');
    
    // Clear search input and results
    document.getElementById('playerSearchInput').value = '';
    window.currentSearchResults = [];
    
    currentGroupId = null;
}

function populateGroupDetailsPage(group) {
    document.getElementById('groupDetailsTitle').textContent = group.name;
    document.getElementById('groupDetailsName').textContent = group.name;
    document.getElementById('groupDetailsDescription').textContent = group.description || 'No description provided';
    document.getElementById('groupDetailsMemberCount').textContent = `${group.member_count} member${group.member_count !== 1 ? 's' : ''}`;
    document.getElementById('groupDetailsCreated').textContent = `Created ${formatDate(group.created_at)} by ${group.creator_name}`;
    
    // Store current group data globally for other functions
    window.currentGroup = group;
    
    // Show/hide creator-only sections
    if (group.is_creator) {
        showElement('addMemberSection');
        showElement('editGroupButton');
        
        // Show search context info
        if (userLeagueId) {
            const contextElement = document.getElementById('searchContext');
            const leagueName = sessionData?.user?.league || 'Unknown League';
        const clubName = sessionData?.user?.club || 'Unknown Club';
        contextElement.textContent = `Searching players in ${leagueName} at ${clubName}`;
            showElement('searchContextInfo');
        }
    } else {
        hideElement('addMemberSection');
        hideElement('editGroupButton');
    }
    
    // Populate members list
    populateMembersList(group.members, group.is_creator);
}

function populateMembersList(members, isCreator) {
    const membersList = document.getElementById('groupMembersList');
    membersList.innerHTML = '';
    
    if (members.length === 0) {
        membersList.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-users text-gray-400 text-2xl"></i>
                </div>
                <p class="text-gray-500 font-medium mb-1">No members yet</p>
                <p class="text-gray-400 text-sm">Add some players to get started!</p>
            </div>
        `;
        return;
    }
    
    members.forEach(member => {
        const memberCard = createMemberCard(member, isCreator);
        membersList.appendChild(memberCard);
    });
}

function createMemberCard(member, isCreator) {
    const card = document.createElement('div');
    card.className = 'bg-white border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow duration-200';
    
    // Filter player info to match current user's league
    const currentUserLeague = sessionData?.user?.league || null;
    const relevantPlayerInfo = member.player_info && member.player_info.length > 0 
        ? member.player_info.filter(info => !currentUserLeague || info.league === currentUserLeague)
        : [];
    
    const hasRelevantInfo = relevantPlayerInfo.length > 0;
    const playerInfo = hasRelevantInfo ? relevantPlayerInfo[0] : null;
    
    card.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
                    <div class="font-bold text-gray-900 text-lg mb-1">${escapeHtml(member.first_name)} ${escapeHtml(member.last_name)}</div>
                    
                    ${hasRelevantInfo ? `
                        <div class="text-sm text-gray-700 mb-2">
                            <div class="flex items-center mb-1">
                                <i class="fas fa-building text-blue-500 mr-2 text-xs"></i>
                                <span class="font-medium">${escapeHtml(playerInfo.club || 'Unknown Club')}</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-600">
                                <i class="fas fa-trophy text-purple-500 mr-2"></i>
                                <span>${escapeHtml(playerInfo.series || 'Unknown Series')}</span>
                                ${playerInfo.pti ? `<span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium">PTI: ${playerInfo.pti}</span>` : ''}
                            </div>
                        </div>
                    ` : `
                        <div class="text-sm text-gray-500 italic mb-2">
                            <i class="fas fa-info-circle mr-2 text-xs"></i>
                            No player information available
                        </div>
                    `}
                    
                    ${member.phone_number ? `
                        <div class="text-sm text-blue-600 font-mono mb-2">
                            <i class="fas fa-phone mr-2 text-xs"></i>
                            ${escapeHtml(member.phone_number)}
                        </div>
                    ` : `
                        <div class="text-sm text-gray-400 italic mb-2">
                            <i class="fas fa-phone-slash mr-2 text-xs"></i>
                            No phone number
                        </div>
                    `}
                    
                    <div class="text-xs text-gray-500 flex items-center">
                        <i class="fas fa-clock mr-1"></i>
                        Added ${formatDate(member.added_at)}
                    </div>
                </div>
            ${isCreator && member.can_remove ? `
                <button onclick="removeMember(${member.user_id})" 
                        class="ml-3 w-8 h-8 rounded-full bg-red-100 text-red-600 hover:bg-red-200 hover:text-red-700 transition-colors duration-200 flex items-center justify-center flex-shrink-0"
                        title="Remove member">
                    <i class="fas fa-times text-sm"></i>
                </button>
            ` : ''}
        </div>
    `;
    
    return card;
}

async function searchPlayers() {
    const query = document.getElementById('playerSearchInput').value.trim();
    
    if (query.length < 2) {
        hideElement('searchResults');
        return;
    }
    
    // Show loading state
    document.getElementById('searchResultsList').innerHTML = `
        <div class="p-4 text-center">
            <div class="loading-spinner loading-lg mx-auto mb-2" style="border-top-color: #9333ea;"></div>
            <p class="text-gray-500 text-sm">Searching...</p>
        </div>
    `;
    showElement('searchResults');
    
    try {
        // Build search URL with league filter
        let searchUrl = `/api/groups/search-players?q=${encodeURIComponent(query)}`;
        if (userLeagueId) {
            searchUrl += `&league_id=${encodeURIComponent(userLeagueId)}`;
        }
        
        console.log('Searching with URL:', searchUrl);
        const response = await fetch(searchUrl);
        const data = await response.json();
        
        console.log('Search response:', data);
        
        if (data.success) {
            // Store results globally for keyboard navigation
            window.currentSearchResults = data.players;
            displaySearchResults(data.players, query);
        } else {
            console.error('Search error:', data.error);
            window.currentSearchResults = [];
            displaySearchError('Search failed. Please try again.');
        }
    } catch (error) {
        console.error('Error searching players:', error);
        window.currentSearchResults = [];
        displaySearchError('Network error. Please check your connection.');
    }
}

function displaySearchError(message) {
    document.getElementById('searchResultsList').innerHTML = `
        <div class="p-3 text-center text-red-500">
            <i class="fas fa-exclamation-triangle mb-2"></i>
            <p class="text-sm">${message}</p>
        </div>
    `;
    showElement('searchResults');
}

function displaySearchResults(players, query = '') {
    const resultsContainer = document.getElementById('searchResultsList');
    
    if (players.length === 0) {
        const noResultsMessage = userLeagueId 
            ? `No players found matching "${query}" in league ${userLeagueId}`
            : `No players found matching "${query}"`;
        resultsContainer.innerHTML = `<div class="p-3 text-gray-500 text-center">${noResultsMessage}</div>`;
        showElement('searchResults');
        return;
    }
    
    resultsContainer.innerHTML = players.map((player, index) => {
        const canAdd = true; // Allow adding all players, including those without accounts
        const playerInfo = player.player_info && player.player_info.length > 0 
            ? player.player_info.map(info => `${info.league} - ${info.club} - ${info.series}`).join(', ')
            : 'No player info';
        
        return `
            <div class="search-result-item p-3 hover:bg-gray-50 cursor-pointer flex items-center justify-between border border-transparent transition-colors duration-150"
                 onclick="selectPlayerByIndex(${index})"
                 data-player-id="${player.user_id || 'none'}"
                 data-index="${index}">
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-900 truncate">
                        ${escapeHtml(player.full_name)}
                        ${player.no_account ? ' <span class="text-xs text-orange-600">(No Account)</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-600 truncate">
                        ${escapeHtml(playerInfo)}
                        ${player.player_info && player.player_info[0] && player.player_info[0].pti ? ` • PTI: ${player.player_info[0].pti}` : ''}
                    </div>
                </div>
                <div class="ml-3 flex-shrink-0">
                    <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center hover:bg-purple-200 transition-colors duration-150">
                        <i class="fas fa-plus text-sm"></i>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    showElement('searchResults');
}

function selectPlayerByIndex(index) {
    const currentResults = window.currentSearchResults || [];
    if (index >= 0 && index < currentResults.length) {
        const player = currentResults[index];
        // Allow selection of all players, including those without accounts
        window.typeAheadSelectPlayer(player);
    }
}

async function addMemberToGroup(player) {
    try {
        // Handle both player objects and legacy user_id calls
        let requestBody;
        if (typeof player === 'object' && player !== null) {
            // New way: pass player object
            requestBody = {
                user_id: player.user_id,
                tenniscores_player_id: player.tenniscores_player_id,
                first_name: player.first_name,
                last_name: player.last_name,
                full_name: player.full_name,
                no_account: player.no_account || false
            };
        } else {
            // Legacy way: just user_id
            requestBody = { user_id: player };
        }

        const response = await fetch(`/api/groups/${currentGroupId}/members`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            // Refresh group details to show the new member
            await showGroupDetailsPage(currentGroupId);
        } else {
            showToast(data.error || 'Failed to add member', 'error');
        }
    } catch (error) {
        console.error('Error adding member:', error);
        showToast('Failed to add member', 'error');
    }
}

async function removeMember(userId) {
    if (!confirm('Are you sure you want to remove this member from the group?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/groups/${currentGroupId}/members/${userId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success');
            await showGroupDetailsPage(currentGroupId);
        } else {
            showToast(data.error || 'Failed to remove member', 'error');
        }
    } catch (error) {
        console.error('Error removing member:', error);
        showToast('Failed to remove member', 'error');
    }
}

// Group creation modal functions
function showCreateGroupModal() {
    document.getElementById('createGroupForm').reset();
    updateDescriptionCounter();
    showElement('createGroupModal');
}

function hideCreateGroupModal() {
    hideElement('createGroupModal');
}



async function handleCreateGroup(e) {
    e.preventDefault();
    
    const btn = document.getElementById('createGroupBtn');
    const originalText = btn.textContent;
    
    try {
        btn.disabled = true;
        btn.textContent = 'Creating...';
        
        const formData = new FormData(e.target);
        const groupData = {
            name: formData.get('groupName').trim(),
            description: formData.get('groupDescription').trim()
        };
        
        const response = await fetch('/api/groups', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(groupData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            hideCreateGroupModal();
            showToast('Group created successfully!', 'success');
            await loadGroups();
        } else {
            showToast(data.error || 'Failed to create group', 'error');
        }
    } catch (error) {
        console.error('Error creating group:', error);
        showToast('Failed to create group', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}



// Utility functions
function showElement(id) {
    document.getElementById(id).classList.remove('hidden');
}

function hideElement(id) {
    document.getElementById(id).classList.add('hidden');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    } catch {
        return 'Unknown';
    }
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const messageEl = document.getElementById('toastMessage');
    
    messageEl.textContent = message;
    
    // Set color based on type
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 ${
        type === 'error' ? 'bg-red-600' : 'bg-green-600'
    } text-white`;
    
    showElement('toast');
    
    setTimeout(() => {
        hideElement('toast');
    }, 3000);
}
</script>

<style>
/* Custom styles for modern mobile design */
.min-h-screen {
    min-height: 100vh;
}

/* Shadow utilities */
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}

.shadow-xl {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Border utilities */
.border-gray-50 { border-color: #f9fafb; }
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-200 { border-color: #e5e7eb; }
.border-purple-200 { border-color: #e9d5ff; }
.border-green-100 { border-color: #dcfce7; }
.border-transparent { border-color: transparent; }

/* Background utilities */
.bg-gray-50 { background-color: #f9fafb; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-gray-200 { background-color: #e5e7eb; }
.bg-gray-600 { background-color: #4b5563; }
.bg-white { background-color: #ffffff; }
.bg-purple-50 { background-color: #faf5ff; }
.bg-purple-100 { background-color: #f3e8ff; }
.bg-purple-200 { background-color: #e9d5ff; }
.bg-purple-600 { background-color: #9333ea; }
.bg-green-50 { background-color: #f0fdf4; }
.bg-green-500 { background-color: #22c55e; }
.bg-green-600 { background-color: #16a34a; }
.bg-blue-50 { background-color: #eff6ff; }
.bg-red-50 { background-color: #fef2f2; }
.bg-red-100 { background-color: #fee2e2; }
.bg-red-200 { background-color: #fecaca; }
.bg-yellow-100 { background-color: #fef3c7; }

/* Hover states */
.hover\:bg-purple-700:hover { background-color: #7c3aed; }
.hover\:bg-gray-700:hover { background-color: #374151; }
.hover\:bg-green-700:hover { background-color: #15803d; }
.hover\:bg-red-200:hover { background-color: #fecaca; }
.hover\:text-red-700:hover { color: #b91c1c; }
.hover\:shadow-sm:hover { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }

/* Gradient utilities */
.bg-gradient-to-r {
    background-image: linear-gradient(to right, var(--tw-gradient-stops));
}

.from-purple-50 {
    --tw-gradient-from: #faf5ff;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(250, 245, 255, 0));
}

.from-green-50 {
    --tw-gradient-from: #f0fdf4;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(240, 253, 244, 0));
}

.to-blue-50 {
    --tw-gradient-to: #eff6ff;
}

.from-purple-400 {
    --tw-gradient-from: #a855f7;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(168, 85, 247, 0));
}

.to-blue-400 {
    --tw-gradient-to: #60a5fa;
}

/* Text colors */
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-gray-400 { color: #9ca3af; }
.text-purple-500 { color: #8b5cf6; }
.text-purple-600 { color: #9333ea; }
.text-purple-700 { color: #7c3aed; }
.text-blue-500 { color: #3b82f6; }
.text-blue-700 { color: #1d4ed8; }
.text-green-500 { color: #22c55e; }
.text-red-500 { color: #ef4444; }
.text-red-600 { color: #dc2626; }
.text-red-700 { color: #b91c1c; }
.text-red-800 { color: #991b1b; }
.text-orange-600 { color: #ea580c; }
.text-yellow-500 { color: #eab308; }
.text-yellow-700 { color: #a16207; }
.text-white { color: #ffffff; }

/* Spacing utilities */
.space-y-6 > * + * { margin-top: 1.5rem; }
.space-y-4 > * + * { margin-top: 1rem; }
.space-y-3 > * + * { margin-top: 0.75rem; }

/* Border radius utilities */
.rounded-xl { border-radius: 0.75rem; }
.rounded-lg { border-radius: 0.5rem; }
.rounded-full { border-radius: 9999px; }

/* Text utilities */
.truncate { 
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Overflow utilities */
.overflow-hidden { overflow: hidden; }
.min-w-0 { min-width: 0px; }

/* Transition utilities */
.transition-colors {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.transition-all {
    transition-property: all;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

.duration-200 {
    transition-duration: 200ms;
}

.duration-300 {
    transition-duration: 300ms;
}

/* Loading spinner */
.loading-spinner {
    animation: spin 1s linear infinite;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
}

.loading-lg {
    width: 2.5rem;
    height: 2.5rem;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Hide elements */
.hidden {
    display: none;
}

/* Badge styles */
.inline-flex {
    display: inline-flex;
}

/* Focus styles */
.focus\:outline-none:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
}

.focus\:ring-2:focus {
    --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
    --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
    box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
}

.focus\:ring-purple-500:focus {
    --tw-ring-color: #8b5cf6;
}

.focus\:ring-green-500:focus {
    --tw-ring-color: #22c55e;
}

.focus\:border-purple-500:focus {
    border-color: #8b5cf6;
}

.focus\:border-green-500:focus {
    border-color: #22c55e;
}

/* Hover utilities */
.hover\:bg-purple-700:hover { background-color: #7c3aed !important; }
.hover\:bg-blue-700:hover { background-color: #1d4ed8 !important; }
.hover\:bg-red-700:hover { background-color: #b91c1c !important; }
.hover\:bg-gray-50:hover { background-color: #f9fafb !important; }
.hover\:text-gray-600:hover { color: #4b5563 !important; }
.hover\:text-red-800:hover { color: #991b1b !important; }
.hover\:text-purple-800:hover { color: #6b21a8 !important; }
.hover\:shadow-md:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Responsive grid */
@media (max-width: 640px) {
    .flex-1 {
        flex: 1 1 0%;
    }
    
    .max-w-md {
        max-width: 28rem;
    }
    
    .max-w-2xl {
        max-width: 42rem;
    }
}
</style>
{% endblock %} 