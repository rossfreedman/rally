{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-sm" style="background-color: #085454 !important;">
                <i class="fas fa-users text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">Private Groups</h1>
                <p class="text-sm text-gray-500">Manage your private playing groups</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">

        <!-- Create Private Group Button -->
        <div class="mb-6">
            <a href="/mobile/create-pickup-game?type=private" class="w-full text-white px-6 py-3 rounded-lg text-sm font-medium transition-colors duration-200 flex items-center justify-center gap-2 shadow-sm" style="background-color: #085454 !important;">
                <i class="fas fa-plus"></i>
                <span>Create Private Group</span>
            </a>
        </div>

        <!-- Private Groups Section -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-users mr-2" style="color: #085454 !important;"></i>
                    My Private Groups
                </h2>
                <p class="text-sm text-gray-600 mt-2">Private groups for communicating with your regular playing partners.</p>
            </div>
            
            <div id="privateGroupsContainer" class="p-4">
                <!-- Loading state -->
                <div id="privateGroupsLoading" class="text-center py-8">
                    <div class="loading-spinner loading-lg mx-auto mb-4" style="border-top-color: #9333ea;"></div>
                    <p class="text-gray-500">Loading private groups...</p>
                </div>
                
                <!-- Empty state -->
                <div id="privateGroupsEmpty" class="text-center py-8 hidden">
                    <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">No Private Groups Yet</h3>
                    <p class="text-gray-500 mb-4">Create your first private group to organize and communicate with your regular playing partners!</p>
                    <div class="flex gap-2 justify-center">
                        <a href="/mobile/create-pickup-game?type=private" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors shadow-sm">
                            <i class="fas fa-plus mr-2"></i>Create Private Group
                        </a>
                    </div>
                </div>
                
                <!-- Private groups will be populated here -->
                <div id="privateGroupsList" class="space-y-4 hidden"></div>
            </div>
        </div>

    </div>
</div>

<!-- Loading Spinner Styles -->
<style>
.loading-spinner {
    width: 32px;
    height: 32px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #085454;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

.loading-lg {
    width: 48px;
    height: 48px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
    let currentUserId = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Get current user ID from session data
        {% if session_data and session_data.user and session_data.user.id %}
            currentUserId = {{ session_data.user.id }};
        {% endif %}
        
        // Load private groups
        loadPrivateGroups();
    });

    // Load private groups from API
    async function loadPrivateGroups() {
        try {
            const groupsResponse = await fetch('/api/groups');
            let groups = [];
            if (groupsResponse.ok) {
                const groupsData = await groupsResponse.json();
                groups = groupsData.groups || [];
            }
            
            renderPrivateGroups(groups);
            
        } catch (error) {
            console.error('Error loading private groups:', error);
            showError('Network error loading private groups');
        }
    }

    // Render private groups
    function renderPrivateGroups(groups) {
        const loadingEl = document.getElementById('privateGroupsLoading');
        const emptyEl = document.getElementById('privateGroupsEmpty');
        const listEl = document.getElementById('privateGroupsList');
        
        // Hide loading
        loadingEl.classList.add('hidden');
        
        if (groups.length === 0) {
            emptyEl.classList.remove('hidden');
            listEl.classList.add('hidden');
        } else {
            emptyEl.classList.add('hidden');
            listEl.classList.remove('hidden');
            
            const groupsHTML = groups.map(group => createGroupHTML(group)).join('');
            listEl.innerHTML = groupsHTML;
        }
    }

    // Create HTML for a group
    function createGroupHTML(group) {
        // Check if current user is the creator for showing delete button
        const isCreator = currentUserId && group.creator_user_id && parseInt(currentUserId) === parseInt(group.creator_user_id);
        
        return `
            <div class="bg-white rounded-lg p-4 border border-gray-200 hover:border-purple-300 hover:shadow-lg transition-all duration-200" data-group-id="${group.id}">
                <div class="flex justify-between items-start">
                    <div class="flex-1 pr-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-users text-purple-500 mr-2"></i>${group.name}
                        </h3>
                        ${group.description ? `<p class="text-sm text-gray-600 mt-1">${group.description}</p>` : ''}
                        <p class="text-xs text-purple-600 font-medium mt-1">Private Group</p>
                        
                        <div class="mt-3">
                            <div class="text-center">
                                <div class="text-xl font-bold text-purple-600">${group.member_count}</div>
                                <div class="text-xs text-gray-500">Members</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 min-w-0" style="width: 120px;">
                        <button onclick="showGroupDetailsModal(${group.id})" 
                                class="w-full px-3 py-2 bg-purple-600 text-white text-xs font-medium rounded-lg hover:bg-purple-700 transition-colors shadow-sm">
                            <i class="fas fa-eye mr-1"></i>View Details
                        </button>
                        
                        <a href="/mobile/text-group/${group.id}" 
                           class="w-full px-3 py-2 bg-green-600 text-white text-xs font-medium rounded-lg hover:bg-green-700 transition-colors text-center shadow-sm">
                            <i class="fas fa-comments mr-1"></i>Text Group
                        </a>
                        
                        ${isCreator ? `
                            <button onclick="deleteGroup(${group.id})" 
                                    class="w-full px-3 py-2 bg-red-600 text-white text-xs font-medium rounded-lg hover:bg-red-700 transition-colors shadow-sm">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    // Show group details modal (placeholder - would need full modal implementation from original file)
    function showGroupDetailsModal(groupId) {
        // For now, just redirect to find people to play with group context
        window.location.href = `/mobile/find-people-to-play?group_id=${groupId}`;
    }

    // Delete group function (placeholder - would need full implementation from original file)
    async function deleteGroup(groupId) {
        if (!confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/groups/${groupId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                showSuccess('Group deleted successfully');
                loadPrivateGroups(); // Reload the list
            } else {
                showError('Failed to delete group');
            }
        } catch (error) {
            console.error('Error deleting group:', error);
            showError('Network error deleting group');
        }
    }

    // Utility functions for notifications
    function showError(message) {
        console.error('Error:', message);
        // You could implement a toast notification system here
        alert('Error: ' + message);
    }
    
    function showSuccess(message) {
        console.log('Success:', message);
        // You could implement a toast notification system here
        alert('Success: ' + message);
    }
</script>

{% endblock %}
