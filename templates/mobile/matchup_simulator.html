{% extends "mobile/layout.html" %}
{% set show_back_arrow = True %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    
    <!-- Header -->
    <div class="bg-white border-b border-gray-100">
        <div class="flex items-center px-4 py-6">
            <div class="w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center shadow-sm" style="background-color: #334155 !important;">
                <i class="fas fa-chart-line text-white text-lg"></i>
            </div>
            <div class="ml-4">
                <h1 class="text-xl font-bold text-gray-900">Matchup Simulator</h1>
                <p class="text-sm text-gray-500">Compare two teams and predict match outcomes</p>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="px-4 py-6 space-y-6">
        
        <!-- Error Display -->
        {% if error %}
        <div class="bg-red-50 border border-red-200 rounded-xl p-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                <span class="text-red-800">{{ error }}</span>
            </div>
        </div>
        {% endif %}

        <!-- Algorithm Explanation Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-50 bg-gradient-to-r from-purple-50 to-purple-100">
                <h3 class="text-lg font-semibold text-purple-800 flex items-center">
                    <i class="fas fa-cogs text-purple-600 mr-2"></i>
                    How the Algorithm Works
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <p class="text-sm text-gray-700 leading-relaxed">
                        Rally's data-driven matchup simulator analyzes <strong>7 key metrics</strong> using real player statistics and performance data to see which team has the advantage.
                    </p>
                    
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-blue-700">1</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">Average PTI (25% weighted)</h4>
                                <p class="text-xs text-gray-600">Team's combined Performance Tracking Index - the strongest predictor</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-green-700">2</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">Individual Win Rates (20% weighted)</h4>
                                <p class="text-xs text-gray-600">Each player's actual win percentage from match records</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-orange-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-orange-700">3</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">Recent Performance (15% weighted)</h4>
                                <p class="text-xs text-gray-600">Performance in each player's last 5 matches</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-yellow-700">4</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">Head-to-Head History (15% weighted)</h4>
                                <p class="text-xs text-gray-600">Direct matchups and performance against common opponents</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-red-700">5</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">Experience Level (15% weighted)</h4>
                                <p class="text-xs text-gray-600">Total number of matches played by each player</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-gray-700">6</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">Consistency Factor (5% weighted)</h4>
                                <p class="text-xs text-gray-600">Individual player PTI stability (low volatility = more predictable)</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                <span class="text-xs font-bold text-purple-700">7</span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-gray-900 mb-1">PTI Skill Gap (5% weighted)</h4>
                                <p class="text-xs text-gray-600">Difference in average PTI between the two teams</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-600 leading-relaxed">
                            <strong>Calculation Process:</strong> Each metric is normalized to a 0-1 scale, weighted by importance, and combined into composite scores. Win probability is calculated using a logistic function that provides realistic predictions between 20-80%, avoiding meaningless 50-50 outcomes.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Selection Form -->
        <div id="teamSelectionForm" class="space-y-6">
            
            <!-- Team A Selection -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50 bg-gradient-to-r from-blue-50 to-blue-100">
                    <h2 class="text-lg font-semibold text-blue-800 flex items-center">
                        <i class="fas fa-users text-blue-600 mr-2"></i>
                        Team A
                    </h2>
                </div>
                
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Team</label>
                        <div class="relative">
                            <select id="teamA_team" class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none">
                                <option value="">Choose Team A...</option>
                                {% for team in available_teams %}
                                <option value="{{ team.id }}">{{ team.display_name }}</option>
                                {% endfor %}
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <div id="teamA_playerSection" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Player 1</label>
                            <div class="relative">
                                <select id="teamA_player1" class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none" disabled>
                                    <option value="">Select Player 1...</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Player 2</label>
                            <div class="relative">
                                <select id="teamA_player2" class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition appearance-none" disabled>
                                    <option value="">Select Player 2...</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VS Divider -->
            <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full text-white font-bold text-xl shadow-lg">
                    VS
                </div>
            </div>

            <!-- Team B Selection -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50 bg-gradient-to-r from-red-50 to-red-100">
                    <h2 class="text-lg font-semibold text-red-800 flex items-center">
                        <i class="fas fa-users text-red-600 mr-2"></i>
                        Team B
                    </h2>
                </div>
                
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Team</label>
                        <div class="relative">
                            <select id="teamB_team" class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 transition appearance-none">
                                <option value="">Choose Team B...</option>
                                {% for team in available_teams %}
                                <option value="{{ team.id }}">{{ team.display_name }}</option>
                                {% endfor %}
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <div id="teamB_playerSection" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Player 1</label>
                            <div class="relative">
                                <select id="teamB_player1" class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 transition appearance-none" disabled>
                                    <option value="">Select Player 1...</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Player 2</label>
                            <div class="relative">
                                <select id="teamB_player2" class="w-full py-3 px-4 text-base border border-gray-300 text-gray-900 bg-white rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 transition appearance-none" disabled>
                                    <option value="">Select Player 2...</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Run Simulation Button -->
            <div class="text-center pt-4">
                <button id="runSimulationBtn" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>
                    <i class="fas fa-play mr-2"></i>
                    <span id="runSimulationText">Run Simulation</span>
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden text-center py-12">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                <i class="fas fa-chart-line text-blue-600 text-2xl animate-bounce"></i>
            </div>
            <p class="text-lg font-medium text-gray-900 mb-2">Analyzing Matchup</p>
            <p class="text-sm text-gray-600">Processing player data and match history...</p>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden space-y-6">
            
            <!-- Overall Prediction -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-50 bg-gradient-to-r from-blue-50 to-blue-100">
                    <h2 class="text-lg font-semibold text-blue-800 flex items-center">
                        <i class="fas fa-trophy text-blue-600 mr-2"></i>
                        Match Prediction
                    </h2>
                </div>
                
                <div class="p-6">
                    <div id="predictionDisplay" class="space-y-6">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Team Comparison Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-50 bg-gradient-to-r from-gray-50 to-gray-100">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center justify-center">
                        <i class="fas fa-chart-bar text-gray-600 mr-2"></i>
                        Team Comparison
                    </h3>
                </div>
                
                <!-- Three Column Layout -->
                <div class="p-4">
                    <!-- Column Headers -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="mb-4 pb-3 border-b border-gray-200">
                        <div class="text-sm font-semibold text-gray-700">Metric</div>
                        <div class="text-center">
                            <h4 class="text-sm font-semibold text-green-800">Favorite</h4>
                        </div>
                        <div class="text-center">
                            <h4 class="text-sm font-semibold text-red-800">Underdog</h4>
                        </div>
                    </div>
                    
                    <!-- Team Names Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="mb-4 pb-3 border-b border-gray-200">
                        <div class="text-xs font-medium text-gray-600">Team</div>
                        <div class="text-center" id="favoriteTeam">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <div class="text-center" id="underdogTeam">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Metrics Data -->
                    <div id="metricsTable">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Run Another Simulation -->
            <div class="text-center pt-4">
                <button id="runAnotherBtn" class="bg-white text-blue-600 border border-blue-200 font-semibold py-3 px-6 rounded-xl shadow-sm hover:shadow-md transform hover:scale-105 transition-all duration-200">
                    <i class="fas fa-refresh mr-2"></i>
                    Run Another Simulation
                </button>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const teamSelectionForm = document.getElementById('teamSelectionForm');
    const loadingState = document.getElementById('loadingState');
    const resultsSection = document.getElementById('resultsSection');
    const runSimulationBtn = document.getElementById('runSimulationBtn');
    const runSimulationText = document.getElementById('runSimulationText');
    const runAnotherBtn = document.getElementById('runAnotherBtn');
    
    // Team and player selection elements
    const teamA_team = document.getElementById('teamA_team');
    const teamA_playerSection = document.getElementById('teamA_playerSection');
    const teamA_player1 = document.getElementById('teamA_player1');
    const teamA_player2 = document.getElementById('teamA_player2');
    
    const teamB_team = document.getElementById('teamB_team');
    const teamB_playerSection = document.getElementById('teamB_playerSection');
    const teamB_player1 = document.getElementById('teamB_player1');
    const teamB_player2 = document.getElementById('teamB_player2');
    
    // Load players when team is selected
    async function loadTeamPlayers(teamId, playerSection, player1Select, player2Select) {
        if (!teamId) {
            playerSection.classList.add('hidden');
            player1Select.disabled = true;
            player2Select.disabled = true;
            player1Select.innerHTML = '<option value="">Select Player 1...</option>';
            player2Select.innerHTML = '<option value="">Select Player 2...</option>';
            return;
        }
        
        try {
            const response = await fetch(`/api/get-team-players/${teamId}`);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Failed to load players');
            }
            
            // Clear and populate player dropdowns
            player1Select.innerHTML = '<option value="">Select Player 1...</option>';
            player2Select.innerHTML = '<option value="">Select Player 2...</option>';
            
            result.players.forEach(player => {
                const option1 = new Option(player.name, player.id);
                const option2 = new Option(player.name, player.id);
                player1Select.add(option1);
                player2Select.add(option2);
            });
            
            // Show player section and enable dropdowns
            playerSection.classList.remove('hidden');
            player1Select.disabled = false;
            player2Select.disabled = false;
            
            checkFormValidity();
            
        } catch (error) {
            console.error('Error loading team players:', error);
            alert('Error loading players: ' + error.message);
        }
    }
    
    // Auto-scroll helper function with progressive doubling
    let scrollAmount = 30;
    function autoScroll() {
        window.scrollBy({
            top: scrollAmount,
            behavior: 'smooth'
        });
        scrollAmount *= 2; // Double for next selection
    }
    
    // Team selection event listeners
    teamA_team.addEventListener('change', function() {
        loadTeamPlayers(this.value, teamA_playerSection, teamA_player1, teamA_player2);
        autoScroll();
    });
    
    teamB_team.addEventListener('change', function() {
        loadTeamPlayers(this.value, teamB_playerSection, teamB_player1, teamB_player2);
        autoScroll();
    });
    
    // Check if all selections are made and valid
    function checkFormValidity() {
        const allSelected = teamA_team.value && teamA_player1.value && teamA_player2.value && 
                           teamB_team.value && teamB_player1.value && teamB_player2.value;
        
        // Check for duplicate player selections within each team
        const teamA_duplicates = teamA_player1.value && teamA_player1.value === teamA_player2.value;
        const teamB_duplicates = teamB_player1.value && teamB_player1.value === teamB_player2.value;
        
        // Check for same team selection
        const sameTeam = teamA_team.value && teamA_team.value === teamB_team.value;
        
        const isValid = allSelected && !teamA_duplicates && !teamB_duplicates && !sameTeam;
        
        runSimulationBtn.disabled = !isValid;
        
        if (teamA_duplicates || teamB_duplicates) {
            runSimulationText.textContent = 'Cannot select same player twice on a team';
        } else if (sameTeam) {
            runSimulationText.textContent = 'Must select different teams';
        } else if (allSelected) {
            runSimulationText.innerHTML = 'Run Simulation';
        } else {
            runSimulationText.innerHTML = 'Select Teams and Players';
        }
    }
    
    // Add event listeners to all player selects
    [teamA_player1, teamA_player2, teamB_player1, teamB_player2].forEach(select => {
        select.addEventListener('change', function() {
            checkFormValidity();
            autoScroll();
        });
    });
    
    // Run simulation
    runSimulationBtn.addEventListener('click', async function() {
        const teamAPlayers = [teamA_player1.value, teamA_player2.value];
        const teamBPlayers = [teamB_player1.value, teamB_player2.value];
        
        // Show loading state
        teamSelectionForm.classList.add('hidden');
        loadingState.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        
        try {
            const response = await fetch('/api/run-simulation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    team_a_players: teamAPlayers,
                    team_b_players: teamBPlayers
                })
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Simulation failed');
            }
            
            displayResults(result);
            
        } catch (error) {
            console.error('Simulation error:', error);
            alert('Error running simulation: ' + error.message);
            
            // Show form again
            teamSelectionForm.classList.remove('hidden');
            loadingState.classList.add('hidden');
            resultsSection.classList.add('hidden');
        }
    });
    
    // Run another simulation
    runAnotherBtn.addEventListener('click', function() {
        teamSelectionForm.classList.remove('hidden');
        loadingState.classList.add('hidden');
        resultsSection.classList.add('hidden');
    });
    
    function displayResults(result) {
        // Hide loading, show results
        loadingState.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        
        // Display overall prediction
        displayPrediction(result.prediction, result.team_a.players, result.team_b.players);
        
        // Determine favorite vs underdog based on prediction
        const teamAName = teamA_team.options[teamA_team.selectedIndex]?.text?.split(' - ')[0] || 'Team A';
        const teamBName = teamB_team.options[teamB_team.selectedIndex]?.text?.split(' - ')[0] || 'Team B';
        
        const teamAIsFavorite = result.prediction.team_a_probability > result.prediction.team_b_probability;
        const favoriteTeamData = teamAIsFavorite ? result.team_a : result.team_b;
        const underdogTeamData = teamAIsFavorite ? result.team_b : result.team_a;
        const favoriteTeamName = teamAIsFavorite ? teamAName : teamBName;
        const underdogTeamName = teamAIsFavorite ? teamBName : teamAName;
        
        // Update team names and players in favorite/underdog order
        document.getElementById('favoriteTeam').innerHTML = `
            <div class="text-xs font-semibold text-green-800">${favoriteTeamName}</div>
            <div class="text-xs text-gray-600 leading-tight mt-1">${favoriteTeamData.players.map(p => p.name).join('<br/>')}</div>
        `;
        document.getElementById('underdogTeam').innerHTML = `
            <div class="text-xs font-semibold text-red-800">${underdogTeamName}</div>
            <div class="text-xs text-gray-600 leading-tight mt-1">${underdogTeamData.players.map(p => p.name).join('<br/>')}</div>
        `;
        
        // Display metrics table with favorite/underdog order
        displayMetricsTable(favoriteTeamData, underdogTeamData);
        
        // Auto-scroll to Match Prediction section with proper timing
        setTimeout(() => {
            // Try multiple methods to ensure scrolling works on all devices
            const matchPredictionSection = resultsSection.querySelector('.bg-white.rounded-2xl');
            
            if (matchPredictionSection) {
                // First try scrolling to the specific Match Prediction card
                matchPredictionSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            } else {
                // Fallback to scrolling to results section
                resultsSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }
            
            // Additional fallback using window.scrollTo for maximum compatibility
            setTimeout(() => {
                const rect = resultsSection.getBoundingClientRect();
                const offset = window.pageYOffset + rect.top - 35; // 35px offset from top (15px less scroll)
                window.scrollTo({
                    top: offset,
                    behavior: 'smooth'
                });
            }, 100);
        }, 500);
    }
    
    function displayPrediction(prediction, teamA, teamB) {
        const display = document.getElementById('predictionDisplay');
        const winnerTeam = prediction.predicted_winner;
        
        // Extract club names from team selections
        const teamAName = teamA_team.options[teamA_team.selectedIndex]?.text?.split(' - ')[0] || 'Team A';
        const teamBName = teamB_team.options[teamB_team.selectedIndex]?.text?.split(' - ')[0] || 'Team B';
        const winnerName = prediction.predicted_winner === 'Team A' ? teamAName : teamBName;
        
        // Generate analysis based on prediction data
        function generateAnalysis(prediction, teamA, teamB) {
            const winnerData = prediction.predicted_winner === 'Team A' ? teamA : teamB;
            const loserData = prediction.predicted_winner === 'Team A' ? teamB : teamA;
            
            let reasons = [];
            
            // Check average PTI difference (lower PTI = stronger player)
            const winnerPTI = winnerData.metrics?.average_pti || 0;
            const loserPTI = loserData.metrics?.average_pti || 0;
            if (winnerPTI < loserPTI - 2) {
                reasons.push(`lower average PTI (${winnerPTI.toFixed(1)} vs ${loserPTI.toFixed(1)})`);
            }
            
            // Check individual win rates
            const winnerWinRate = winnerData.metrics?.individual_win_rates || 0;
            const loserWinRate = loserData.metrics?.individual_win_rates || 0;
            if (winnerWinRate > loserWinRate + 10) {
                reasons.push(`better individual win rates (${winnerWinRate.toFixed(1)}% vs ${loserWinRate.toFixed(1)}%)`);
            }
            
            // Check recent performance
            const winnerRecentForm = winnerData.metrics?.recent_individual_form || 0;
            const loserRecentForm = loserData.metrics?.recent_individual_form || 0;
            if (winnerRecentForm > loserRecentForm + 15) {
                reasons.push(`better recent performance (${winnerRecentForm.toFixed(1)}% vs ${loserRecentForm.toFixed(1)}%)`);
            }
            
            // Check experience level
            const winnerExperience = winnerData.metrics?.experience_level || 0;
            const loserExperience = loserData.metrics?.experience_level || 0;
            if (winnerExperience > loserExperience + 10) {
                reasons.push(`more experienced players (${winnerExperience.toFixed(0)} vs ${loserExperience.toFixed(0)} avg matches)`);
            }
            
            // Default analysis if no clear reasons
            if (reasons.length === 0) {
                return `${winnerTeam} has a slight edge based on overall player metrics and performance analysis. The prediction confidence is ${prediction.confidence} due to the available statistical data.`;
            }
            
            // Construct analysis
            let analysis = `${winnerTeam} is favored due to their `;
            if (reasons.length === 1) {
                analysis += reasons[0] + '.';
            } else if (reasons.length === 2) {
                analysis += reasons[0] + ' and ' + reasons[1] + '.';
            } else {
                analysis += reasons.slice(0, -1).join(', ') + ', and ' + reasons[reasons.length - 1] + '.';
            }
            
            // Add confidence explanation
            analysis += ` The ${prediction.confidence} confidence reflects `;
            if (prediction.confidence === 'high') {
                analysis += 'strong statistical evidence supporting this prediction.';
            } else if (prediction.confidence === 'medium') {
                analysis += 'moderate statistical support with some uncertainty factors.';
            } else {
                analysis += 'limited historical data or close statistical matchup between the teams.';
            }
            
            return analysis;
        }
        
        const analysis = generateAnalysis(prediction, teamA, teamB);
        
        // Get confidence badge color
        function getConfidenceColor(confidence) {
            switch(confidence.toLowerCase()) {
                case 'high': return 'text-green-700 bg-green-100';
                case 'medium': return 'text-yellow-700 bg-yellow-100';
                case 'low': return 'text-red-700 bg-red-100';
                default: return 'text-gray-700 bg-gray-100';
            }
        }
        
        const confidenceColor = getConfidenceColor(prediction.confidence);
        
        // Convert percentages to betting lines
        function convertToBettingLine(probability) {
            if (probability >= 50) {
                // Favorite: negative line
                const line = Math.round((probability / (100 - probability)) * 100);
                return `-${line}`;
            } else {
                // Underdog: positive line
                const line = Math.round(((100 - probability) / probability) * 100);
                return `+${line}`;
            }
        }
        
        // Debug the probabilities
        console.log(`[DEBUG] Probabilities: Team A = ${prediction.team_a_probability}%, Team B = ${prediction.team_b_probability}%`);
        
        const teamALine = convertToBettingLine(prediction.team_a_probability);
        const teamBLine = convertToBettingLine(prediction.team_b_probability);
        
        console.log(`[DEBUG] Betting lines: Team A = ${teamALine}, Team B = ${teamBLine}`);
        
        display.innerHTML = `
            <!-- Winner Announcement -->
            <div class="text-center mb-6">
                <div class="text-2xl font-bold text-gray-900 mb-4">
                    ${winnerName} Predicted to Win
                </div>
                <div class="space-y-2 text-left bg-gray-50 rounded-lg p-4 max-w-md mx-auto">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">${teamAName}:</span>
                        <span class="text-sm text-gray-600">~${prediction.team_a_probability}% chance → <span class="font-bold text-blue-600">${teamALine}</span> ${prediction.team_a_probability < 50 ? '(underdog)' : '(favorite)'}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">${teamBName}:</span>
                        <span class="text-sm text-gray-600">~${prediction.team_b_probability}% chance → <span class="font-bold text-red-600">${teamBLine}</span> ${prediction.team_b_probability < 50 ? '(underdog)' : '(favorite)'}</span>
                    </div>
                </div>
                <div class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium ${confidenceColor}">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Confidence: ${prediction.confidence.charAt(0).toUpperCase() + prediction.confidence.slice(1)}
                </div>
            </div>
            
            <!-- Analysis Section -->
            <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                        <i class="fas fa-lightbulb text-blue-600 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm font-semibold text-blue-900 mb-2">Analysis</h4>
                        <p class="text-sm text-blue-800 leading-relaxed">
                            ${analysis}
                        </p>
                    </div>
                </div>
            </div>
        `;
    }
    
    function displayMetricsTable(favoriteTeam, underdogTeam) {
        const tableDisplay = document.getElementById('metricsTable');
        
        // Helper functions for colors (same as before)
        function getPTIColor(pti) {
            if (pti <= 20) return 'text-green-600';    // Strong players (low PTI)
            if (pti <= 25) return 'text-blue-600';     // Good players
            if (pti <= 30) return 'text-yellow-600';   // Average players
            return 'text-red-600';                     // Weak players (high PTI)
        }
        
        function getWinRateColor(rate) {
            if (rate >= 70) return 'text-green-600';
            if (rate >= 50) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        function getFormColor(form) {
            if (form >= 70) return 'text-green-600';
            if (form >= 50) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        function getExperienceColor(exp) {
            if (exp >= 50) return 'text-green-600';
            if (exp >= 20) return 'text-blue-600';
            if (exp >= 10) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        function getConsistencyColor(cons) {
            if (cons >= 80) return 'text-green-600';
            if (cons >= 60) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        function getComparativeColor(value) {
            if (value > 0) return 'text-green-600';
            if (value === 0) return 'text-gray-600';
            return 'text-red-600';
        }
        
        // Extract metrics
        const favoriteMetrics = favoriteTeam.metrics;
        const underdogMetrics = underdogTeam.metrics;
        
        // Helper function to determine who has advantage and add checkmark
        function getAdvantageIndicator(favoriteValue, underdogValue, higherIsBetter = true) {
            let favoriteAdvantage, underdogAdvantage;
            
            if (higherIsBetter) {
                favoriteAdvantage = favoriteValue > underdogValue;
                underdogAdvantage = underdogValue > favoriteValue;
            } else {
                favoriteAdvantage = favoriteValue < underdogValue;
                underdogAdvantage = underdogValue < favoriteValue;
            }
            
            return {
                favorite: favoriteAdvantage ? ' <i class="fas fa-check text-green-600 ml-1"></i>' : '',
                underdog: underdogAdvantage ? ' <i class="fas fa-check text-green-600 ml-1"></i>' : ''
            };
        }
        
        // Calculate advantages for each metric
        const ptiAdvantage = getAdvantageIndicator(favoriteMetrics.average_pti || 0, underdogMetrics.average_pti || 0, false); // Lower PTI is better
        const winRateAdvantage = getAdvantageIndicator(favoriteMetrics.individual_win_rates || 0, underdogMetrics.individual_win_rates || 0);
        const formAdvantage = getAdvantageIndicator(favoriteMetrics.recent_individual_form || 0, underdogMetrics.recent_individual_form || 0);
        const h2hAdvantage = getAdvantageIndicator(favoriteMetrics.head_to_head_record || 0, underdogMetrics.head_to_head_record || 0);
        const expAdvantage = getAdvantageIndicator(favoriteMetrics.experience_level || 0, underdogMetrics.experience_level || 0);
        const consistencyAdvantage = getAdvantageIndicator(favoriteMetrics.consistency_factor || 0, underdogMetrics.consistency_factor || 0);
        const gapAdvantage = getAdvantageIndicator(favoriteMetrics.pti_advantage || 0, underdogMetrics.pti_advantage || 0);
        
        tableDisplay.innerHTML = `
            <div class="space-y-2">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2 border-b border-gray-100">
                    <div class="text-xs font-medium text-gray-700">Avg PTI</div>
                    <div class="text-center text-sm font-bold ${getPTIColor(favoriteMetrics.average_pti || 0)}">${(favoriteMetrics.average_pti || 0).toFixed(1)}${ptiAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getPTIColor(underdogMetrics.average_pti || 0)}">${(underdogMetrics.average_pti || 0).toFixed(1)}${ptiAdvantage.underdog}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2 border-b border-gray-100">
                    <div class="text-xs font-medium text-gray-700">Win Rate</div>
                    <div class="text-center text-sm font-bold ${getWinRateColor(favoriteMetrics.individual_win_rates || 0)}">${(favoriteMetrics.individual_win_rates || 0).toFixed(1)}%${winRateAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getWinRateColor(underdogMetrics.individual_win_rates || 0)}">${(underdogMetrics.individual_win_rates || 0).toFixed(1)}%${winRateAdvantage.underdog}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2 border-b border-gray-100">
                    <div class="text-xs font-medium text-gray-700">Recent Form</div>
                    <div class="text-center text-sm font-bold ${getFormColor(favoriteMetrics.recent_individual_form || 0)}">${(favoriteMetrics.recent_individual_form || 0).toFixed(1)}%${formAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getFormColor(underdogMetrics.recent_individual_form || 0)}">${(underdogMetrics.recent_individual_form || 0).toFixed(1)}%${formAdvantage.underdog}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2 border-b border-gray-100">
                    <div class="text-xs font-medium text-gray-700">Head-to-Head</div>
                    <div class="text-center text-sm font-bold ${getComparativeColor(favoriteMetrics.head_to_head_record || 0)}">${(favoriteMetrics.head_to_head_record || 0) > 0 ? '+' : ''}${(favoriteMetrics.head_to_head_record || 0).toFixed(1)}${h2hAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getComparativeColor(underdogMetrics.head_to_head_record || 0)}">${(underdogMetrics.head_to_head_record || 0) > 0 ? '+' : ''}${(underdogMetrics.head_to_head_record || 0).toFixed(1)}${h2hAdvantage.underdog}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2 border-b border-gray-100">
                    <div class="text-xs font-medium text-gray-700">Experience</div>
                    <div class="text-center text-sm font-bold ${getExperienceColor(favoriteMetrics.experience_level || 0)}">${(favoriteMetrics.experience_level || 0).toFixed(0)}${expAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getExperienceColor(underdogMetrics.experience_level || 0)}">${(underdogMetrics.experience_level || 0).toFixed(0)}${expAdvantage.underdog}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2 border-b border-gray-100">
                    <div class="text-xs font-medium text-gray-700">Consistency</div>
                    <div class="text-center text-sm font-bold ${getConsistencyColor(favoriteMetrics.consistency_factor || 0)}">${(favoriteMetrics.consistency_factor || 0).toFixed(1)}${consistencyAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getConsistencyColor(underdogMetrics.consistency_factor || 0)}">${(underdogMetrics.consistency_factor || 0).toFixed(1)}${consistencyAdvantage.underdog}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;" class="py-2">
                    <div class="text-xs font-medium text-gray-700">PTI Gap</div>
                    <div class="text-center text-sm font-bold ${getComparativeColor(favoriteMetrics.pti_advantage || 0)}">${(favoriteMetrics.pti_advantage || 0) > 0 ? '+' : ''}${(favoriteMetrics.pti_advantage || 0).toFixed(1)}${gapAdvantage.favorite}</div>
                    <div class="text-center text-sm font-bold ${getComparativeColor(underdogMetrics.pti_advantage || 0)}">${(underdogMetrics.pti_advantage || 0) > 0 ? '+' : ''}${(underdogMetrics.pti_advantage || 0).toFixed(1)}${gapAdvantage.underdog}</div>
                </div>
            </div>
        `;
    }
});
</script>

<style>
/* Modern mobile design styles */
.min-h-screen {
    min-height: 100vh;
}

/* Remove default select arrow */
.appearance-none {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

/* Custom animations */
@keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
        transform: translate3d(0,0,0);
    }
    40%, 43% {
        transform: translate3d(0,-8px,0);
    }
    70% {
        transform: translate3d(0,-4px,0);
    }
    90% {
        transform: translate3d(0,-2px,0);
    }
}

.animate-bounce {
    animation: bounce 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
    }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

/* Backdrop blur utility */
.backdrop-blur-sm {
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
}

/* Hover effects */
.hover\:shadow-md:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.hover\:shadow-xl:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.hover\:scale-105:hover {
    transform: scale(1.05);
}

/* Focus styles */
.focus\:ring-2:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.focus\:ring-blue-500:focus {
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
}

.focus\:ring-red-500:focus {
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5);
}

.focus\:border-blue-500:focus {
    border-color: #3b82f6;
}

.focus\:border-red-500:focus {
    border-color: #ef4444;
}

/* Gradient backgrounds */
.bg-gradient-to-r {
    background-image: linear-gradient(to right, var(--tw-gradient-stops));
}

.bg-gradient-to-br {
    background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
}

.from-blue-50 {
    --tw-gradient-from: #eff6ff;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0));
}

.to-blue-100 {
    --tw-gradient-to: #dbeafe;
}

.from-blue-500 {
    --tw-gradient-from: #3b82f6;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0));
}

.to-blue-600 {
    --tw-gradient-to: #2563eb;
}

.from-blue-600 {
    --tw-gradient-from: #2563eb;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(37, 99, 235, 0));
}

.to-blue-700 {
    --tw-gradient-to: #1d4ed8;
}

.from-red-50 {
    --tw-gradient-from: #fef2f2;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(254, 242, 242, 0));
}

.to-red-100 {
    --tw-gradient-to: #fee2e2;
}

.from-purple-50 {
    --tw-gradient-from: #faf5ff;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(250, 245, 255, 0));
}

.to-purple-100 {
    --tw-gradient-to: #e9d5ff;
}

/* Color utilities */
.text-blue-800 { color: #1e40af; }
.text-red-800 { color: #991b1b; }
.text-blue-600 { color: #2563eb; }
.text-blue-700 { color: #1d4ed8; }
.text-red-600 { color: #dc2626; }
.text-green-600 { color: #16a34a; }
.text-green-700 { color: #15803d; }
.text-yellow-600 { color: #ca8a04; }
.text-purple-600 { color: #9333ea; }
.text-purple-700 { color: #7c3aed; }
.text-purple-800 { color: #6b21a8; }
.text-orange-700 { color: #c2410c; }
.text-gray-900 { color: #111827; }
.text-gray-700 { color: #374151; }
.text-gray-600 { color: #4b5563; }
.text-gray-500 { color: #6b7280; }
.text-gray-400 { color: #9ca3af; }
.text-white { color: #ffffff; }

/* Background utilities */
.bg-white { background-color: #ffffff; }
.bg-gray-50 { background-color: #f9fafb; }
.bg-gray-100 { background-color: #f3f4f6; }
.bg-blue-100 { background-color: #dbeafe; }
.bg-red-50 { background-color: #fef2f2; }
.bg-green-50 { background-color: #f0fdf4; }
.bg-green-100 { background-color: #dcfce7; }
.bg-yellow-50 { background-color: #fefce8; }
.bg-purple-50 { background-color: #faf5ff; }
.bg-purple-100 { background-color: #e9d5ff; }
.bg-orange-100 { background-color: #fed7aa; }

/* Border utilities */
.border-gray-100 { border-color: #f3f4f6; }
.border-gray-200 { border-color: #e5e7eb; }
.border-gray-300 { border-color: #d1d5db; }
.border-blue-200 { border-color: #bfdbfe; }
.border-blue-500 { border-color: #3b82f6; }
.border-red-200 { border-color: #fecaca; }
.border-white { border-color: #ffffff; }

/* Border opacity utilities */
.border-opacity-20 { border-color: rgba(255, 255, 255, 0.2); }
.border-opacity-30 { border-color: rgba(59, 130, 246, 0.3); }

/* Shadow utilities */
.shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
.shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
.shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }

/* Transition utilities */
.transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; }
.transition-all { transition-property: all; }
.duration-200 { transition-duration: 200ms; }

/* Transform utilities */
.transform { transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
.scale-105 { transform: scale(1.05); }
.-translate-y-1\/2 { transform: translateY(-50%); }
.-translate-y-16 { transform: translateY(-4rem); }
.translate-y-12 { transform: translateY(3rem); }
.translate-x-16 { transform: translateX(4rem); }
.-translate-x-12 { transform: translateX(-3rem); }

/* Disabled state */
.disabled\:opacity-50:disabled { opacity: 0.5; }
.disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
.disabled\:transform-none:disabled { transform: none; }

/* Border radius utilities */
.rounded-2xl { border-radius: 1rem; }

/* Leading utilities */
.leading-relaxed { line-height: 1.625; }

/* Flex utilities */
.flex-shrink-0 { flex-shrink: 0; }
.items-start { align-items: flex-start; }

/* Margin utilities */
.mt-0 { margin-top: 0; }
.mt-0\.5 { margin-top: 0.125rem; }

/* Space utilities */
.space-x-3 > * + * { margin-left: 0.75rem; }
.space-x-24 > * + * { margin-left: 6rem; }

/* Responsive utilities */
@media (max-width: 640px) {
    .px-6 { padding-left: 1rem; padding-right: 1rem; }
    .py-4 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
}
</style>
{% endblock %} 