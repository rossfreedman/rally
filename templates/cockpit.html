<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rally Cockpit | Real-Time Dashboard</title>
    <link rel="stylesheet" href="/static/css/output.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Rally colors */
        :root {
            --rally-primary: #10645c;
            --rally-secondary: #0d4f47;
            --rally-accent: #1a7a6b;
            --rally-light: #e6f7f5;
        }
        
        .rally-bg-primary { background-color: var(--rally-primary); }
        .rally-bg-secondary { background-color: var(--rally-secondary); }
        .rally-bg-accent { background-color: var(--rally-accent); }
        .rally-bg-light { background-color: var(--rally-light); }
        .rally-text-primary { color: var(--rally-primary); }
        .rally-text-secondary { color: var(--rally-secondary); }
        
        /* Desktop-only styles */
        @media (max-width: 1024px) {
            .desktop-only {
                display: none !important;
            }
        }
        
        /* Real-time pulse animation */
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Activity timeline styles */
        .activity-item {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        
        .activity-item:hover {
            background-color: #f8fafc;
            border-left-color: var(--rally-primary);
            transform: translateX(4px);
        }
        
        /* Metric cards */
        .metric-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Status indicators */
        .status-online { color: #10b981; }
        .status-offline { color: #6b7280; }
        .status-busy { color: #f59e0b; }
        
        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Pulse animation for live indicator */
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <!-- Desktop-only warning -->
    <div class="lg:hidden fixed inset-0 bg-red-600 text-white flex items-center justify-center z-50">
        <div class="text-center">
            <i class="fas fa-desktop text-6xl mb-4"></i>
            <h1 class="text-2xl font-bold mb-2">Desktop Only</h1>
            <p class="text-lg">This dashboard is optimized for desktop viewing only.</p>
            <p class="text-sm mt-2">Please access from a desktop or laptop computer.</p>
        </div>
    </div>

    <!-- Main Dashboard Container -->
    <div class="desktop-only h-full flex flex-col">
        <!-- Header -->
        <header class="rally-bg-primary text-white shadow-lg" style="height: 80px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="h-full flex items-center px-6">
                <!-- Left Section: Title -->
                <div class="flex items-center" style="flex: 1;">
                    <div class="ml-4">
                        <h1 class="text-2xl font-bold">Rally Cockpit</h1>
                        <p class="text-sm text-green-200">Real-Time Activity Dashboard</p>
                    </div>
                </div>
                
                <!-- Center Logo -->
                <div class="flex justify-center" style="flex: 1;">
                    <a href="/mobile" class="navbar-logo">
                        <img src="/static/rallylogo.png" alt="Rally Logo" class="w-auto rally-logo" style="height: 90px; transform: translateY(3px);">
                    </a>
                </div>
                
                <!-- Right Section: Status and Controls -->
                <div class="flex items-center justify-end space-x-8" style="flex: 1;">
                    <!-- Time Display -->
                    <div class="text-right">
                        <div class="text-sm text-green-200">Last Updated</div>
                        <div id="last-updated" class="text-lg font-mono font-semibold">--:--:--</div>
                    </div>
                    
                    <!-- Refresh Button -->
                    <button onclick="refreshAllData()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-6 py-3 rounded-xl transition-all duration-200 flex items-center space-x-3">
                        <i class="fas fa-sync-alt"></i>
                        <span class="font-medium">Refresh</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6">
            <!-- Dashboard Table Grid System -->
            <div id="main-grid" class="grid gap-6" style="height: calc(100vh - 140px); display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr 1fr 1fr; max-height: calc(100vh - 140px);">
                
                <!-- Column 1, Row 1: Key Metrics (reduced height) -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-full" style="grid-row: 1; grid-column: 1; max-height: calc((100vh - 140px) / 3);">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        Key Metrics
                    </h3>
                    <div class="flex-1 flex flex-col space-y-4">
                        <!-- Today's Activities -->
                        <div class="metric-card p-4 rounded-lg flex-1 flex flex-col justify-between">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Today's Activities</p>
                                    <p id="today-activities" class="text-2xl font-bold text-gray-900">-</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-calendar-day text-green-600 text-lg"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <span id="today-activities-change" class="text-xs text-gray-500">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Active Users -->
                        <div class="metric-card p-4 rounded-lg flex-1 flex flex-col justify-between">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Active Users</p>
                                    <p id="active-users" class="text-2xl font-bold text-gray-900">-</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-purple-600 text-lg"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <span id="active-users-change" class="text-xs text-gray-500">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Column 2, Row 2: Daily New Users Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-full" style="grid-row: 2; grid-column: 2;">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-user-plus text-rally-primary mr-2"></i>
                        Daily New Users
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">New user registrations per day</p>
                    <div class="chart-container flex-1" style="min-height: 200px;">
                        <canvas id="daily-users-chart"></canvas>
                    </div>
                </div>

                <!-- Column 2, Row 1: Total Users Cumulative Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-full" style="grid-row: 1; grid-column: 2;">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-users text-rally-primary mr-2"></i>
                        Total Users (Cumulative)
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Cumulative user count over time</p>
                    <div class="chart-container flex-1" style="min-height: 200px;">
                        <canvas id="cumulative-users-chart"></canvas>
                    </div>
                    <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                        <span id="user-count-total">Total: -</span>
                        <span id="user-count-growth">Growth: -</span>
                    </div>
                </div>

                <!-- Column 2, Row 3: Activity Trends Chart -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-full" style="grid-row: 3; grid-column: 2;">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-line text-rally-primary mr-2"></i>
                        Activity Trends
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Activity patterns over time</p>
                    <div class="chart-container flex-1" style="min-height: 200px;">
                        <canvas id="activity-chart"></canvas>
                    </div>
                </div>

                <!-- Column 1, Row 2-3: Most Active Users (expanded to fill remaining space) -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-full" style="grid-row: 2 / 4; grid-column: 1; max-height: calc((100vh - 140px) * 2 / 3);">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center flex-shrink-0">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                        Most Active Users
                    </h3>
                    <div id="top-users-list" class="flex-1 space-y-3 overflow-y-auto min-h-0" style="max-height: calc((100vh - 140px) * 2 / 3 - 80px);">
                        <!-- Most Active Users content will be loaded here -->
                    </div>
                </div>

                <!-- Column 3, Row 1-3: Recent Activity (full height) -->
                <div class="bg-white rounded-xl shadow-lg flex flex-col h-full" style="grid-row: 1 / 4; grid-column: 3; max-height: calc(100vh - 140px);">
                    <!-- Activity Timeline Header -->
                    <div class="p-6 border-b border-gray-200 flex-shrink-0">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900">Recent Activity</h2>
                                    <p class="text-sm text-gray-600">Real-time activity feed</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <!-- Activity Filter -->
                                <div class="flex space-x-1">
                                    <button onclick="setActivityFilter('realtime')" id="filter-realtime" class="px-3 py-1 text-xs font-medium rounded-lg bg-rally-primary text-white">
                                        Real-time
                                    </button>
                                    <button onclick="setActivityFilter('hour')" id="filter-hour" class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        Hour
                                    </button>
                                    <button onclick="setActivityFilter('day')" id="filter-day" class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        Today
                                    </button>
                                    <button onclick="setActivityFilter('week')" id="filter-week" class="px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">
                                        Week
                                    </button>
                                </div>
                                <button onclick="refreshActivityData()" class="text-gray-500 hover:text-rally-primary transition-colors">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Timeline Content -->
                    <div class="flex-1 overflow-y-auto p-6 min-h-0" style="max-height: calc(100vh - 140px - 120px);">
                        <div id="activity-timeline" class="space-y-4">
                            <!-- Loading skeleton -->
                            <div class="loading-skeleton h-16 rounded-lg mb-4"></div>
                            <div class="loading-skeleton h-16 rounded-lg mb-4"></div>
                            <div class="loading-skeleton h-16 rounded-lg mb-4"></div>
                            <div class="loading-skeleton h-16 rounded-lg mb-4"></div>
                            <div class="loading-skeleton h-16 rounded-lg mb-4"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        // Global state
        let dashboardState = {
            currentFilter: 'realtime',
            lastUpdate: null,
            charts: {},
            refreshInterval: null,
            includeAdmin: false,  // Default to excluding admin activity
            topUsersFilter: 'today'  // Default to today's most active users
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startRealTimeUpdates();
        });

        function initializeDashboard() {
            console.log('Initializing Rally Cockpit Dashboard...');
            initializeFilterButtons();
            loadAllData();
            setupCharts();
        }

        function initializeFilterButtons() {
            // Set the initial active button based on currentFilter
            const currentFilter = dashboardState.currentFilter;
            console.log(`Initializing filter buttons with current filter: ${currentFilter}`);
            
            // Update button states
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300';
            });
            
            const activeBtn = document.getElementById(`filter-${currentFilter}`);
            if (activeBtn) {
                activeBtn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-rally-primary text-white';
                console.log(`Set active button: filter-${currentFilter}`);
            } else {
                console.error(`Button with id 'filter-${currentFilter}' not found`);
            }
        }

        async function loadAllData() {
            try {
                await Promise.all([
                    loadMetrics(),
                    loadActivityData(),
                    loadTopUsers(),
                    loadActivityTrends(),
                    loadUserCountTrends()
                ]);
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadAllDataExceptActivity() {
            try {
                await Promise.all([
                    loadMetrics(),
                    loadTopUsers(),
                    loadActivityTrends()
                ]);
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadMetrics() {
            try {
                const excludeAdmin = !dashboardState.includeAdmin;
                const response = await fetch(`/api/admin/cockpit/real-time-stats?exclude_admin=${excludeAdmin}&exclude_impersonated=false`, {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    console.error(`Metrics API error: ${response.status} ${response.statusText}`);
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateMetricsDisplay(data.stats, data.trends, data.system_health);
                } else {
                    console.error('Metrics API returned error:', data.error);
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        async function loadActivityData() {
            try {
                const filter = dashboardState.currentFilter;
                const excludeAdmin = !dashboardState.includeAdmin;
                const params = new URLSearchParams({
                    limit: '100',
                    exclude_admin: excludeAdmin.toString(),
                    exclude_impersonated: 'false'
                });

                // Add date filters based on current filter
                const { dateFrom, dateTo } = getDateRangeForFilter(filter);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                
                console.log(`Loading activities with filter: ${filter}, dateFrom: ${dateFrom}, dateTo: ${dateTo}`);

                const response = await fetch(`/api/admin/cockpit/detailed-activities?${params}`, {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderActivityTimeline(data.activities);
                }
            } catch (error) {
                console.error('Error loading activity data:', error);
            }
        }

        async function loadTopUsers() {
            try {
                const excludeAdmin = !dashboardState.includeAdmin;
                const filter = dashboardState.topUsersFilter;
                
                // Build date range for the filter
                const { dateFrom, dateTo } = getDateRangeForTopUsersFilter(filter);
                
                let url = `/api/admin/dashboard/top-players?limit=20&exclude_admin=${excludeAdmin}&exclude_impersonated=false`;
                if (dateFrom) url += `&date_from=${dateFrom}`;
                if (dateTo) url += `&date_to=${dateTo}`;
                
                const response = await fetch(url, {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderTopUsers(data.top_players);
                }
            } catch (error) {
                console.error('Error loading top users:', error);
            }
        }


        async function loadActivityTrends() {
            try {
                const response = await fetch('/api/admin/cockpit/activity-trends?hours=24', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    console.error(`Activity trends API error: ${response.status} ${response.statusText}`);
                    return;
                }
                
                const text = await response.text();
                let data;
                
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('Failed to parse activity trends response as JSON:', parseError);
                    console.error('Response text:', text.substring(0, 200));
                    return;
                }
                
                if (data.status === 'success') {
                    updateActivityChart(data.chart_data);
                } else {
                    console.error('Activity trends API returned error:', data.error);
                }
            } catch (error) {
                console.error('Error loading activity trends:', error);
            }
        }


        async function loadUserCountTrends() {
            try {
                const response = await fetch('/api/admin/cockpit/user-count-trends?days=30', {
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    console.error(`User count trends API error: ${response.status} ${response.statusText}`);
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateUserCountChart(data);
                } else {
                    console.error('User count trends API returned error:', data.error);
                }
            } catch (error) {
                console.error('Error loading user count trends:', error);
            }
        }


        function updateMetricsDisplay(stats, trends, systemHealth) {
            // Safely update metrics with null checks
            const todayActivitiesEl = document.getElementById('today-activities');
            const activeUsersEl = document.getElementById('active-users');
            const activityRateEl = document.getElementById('activity-rate');
            const todayActivitiesChangeEl = document.getElementById('today-activities-change');
            const activeUsersChangeEl = document.getElementById('active-users-change');
            const activityRateChangeEl = document.getElementById('activity-rate-change');
            
            if (todayActivitiesEl) {
                todayActivitiesEl.textContent = formatNumber(stats.today_activities || 0);
            }
            
            if (activeUsersEl) {
                activeUsersEl.textContent = formatNumber(stats.active_users_today || 0);
            }
            
            // Calculate activity rate
            const currentHour = new Date().getHours();
            const rate = currentHour > 0 ? Math.round((stats.today_activities || 0) / currentHour) : (stats.today_activities || 0);
            
            if (activityRateEl) {
                activityRateEl.textContent = `${rate}/hr`;
            }

            // Update change indicators with real trends
            if (trends) {
                if (todayActivitiesChangeEl) {
                    todayActivitiesChangeEl.textContent = 
                        `${trends.today_activities_change > 0 ? '+' : ''}${trends.today_activities_change}% from yesterday`;
                }
                if (activeUsersChangeEl) {
                    activeUsersChangeEl.textContent = 
                        `${trends.active_users_change > 0 ? '+' : ''}${trends.active_users_change}% from yesterday`;
                }
            } else {
                if (todayActivitiesChangeEl) {
                    todayActivitiesChangeEl.textContent = 'Loading trends...';
                }
                if (activeUsersChangeEl) {
                    activeUsersChangeEl.textContent = 'Loading trends...';
                }
            }
            
            if (activityRateChangeEl) {
                activityRateChangeEl.textContent = 'Peak at 2:00 PM';
            }

        }

        function renderActivityTimeline(activities) {
            const container = document.getElementById('activity-timeline');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">No activities found for the selected period</p>
                    </div>
                `;
                return;
            }

            const html = activities.map(activity => {
                const timeAgo = getTimeAgo(activity.timestamp);
                const actionIcon = getActionTypeIcon(activity.action_type);
                const actionColor = getActionTypeColor(activity.action_type);
                const actionDescription = getDetailedActionDescription(activity);
                
                return `
                    <div class="activity-item bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                        <div class="flex items-start space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-${actionColor}-100 rounded-lg flex items-center justify-center">
                                    <i class="${actionIcon} text-${actionColor}-600 text-lg"></i>
                                </div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold text-gray-900">${actionDescription}</h4>
                                    <span class="text-xs text-gray-500 font-mono">${timeAgo}</span>
                                </div>
                                
                                ${activity.user ? `
                                    <div class="flex items-center space-x-2 mb-2">
                                        <i class="fas fa-user text-gray-400 text-xs"></i>
                                        <span class="text-sm text-gray-600">${activity.user.first_name} ${activity.user.last_name}</span>
                                        ${activity.user.email ? `<span class="text-xs text-gray-500">(${activity.user.email})</span>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${activity.details ? `
                                    ${activity.action_type === 'registration_failed' ? `
                                        <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                                            <div class="flex items-start">
                                                <div class="w-5 h-5 bg-red-100 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                                    <i class="fas fa-exclamation-triangle text-red-600 text-xs"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <h5 class="text-sm font-semibold text-red-800 mb-2">Registration Details</h5>
                                                    ${formatRegistrationFailedDetails(activity.details)}
                                                </div>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="text-xs text-gray-500 bg-gray-50 rounded p-2 mt-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            ${activity.details}
                                        </div>
                                    `}
                                ` : ''}
                                
                                <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                    <span><i class="fas fa-tag mr-1"></i>${activity.action_type}</span>
                                    ${activity.ip_address ? `<span><i class="fas fa-globe mr-1"></i>${activity.ip_address}</span>` : ''}
                                    ${activity.user_agent ? `<span><i class="fas fa-desktop mr-1"></i>${getBrowserInfo(activity.user_agent)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function renderTopUsers(users) {
            const container = document.getElementById('top-users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No user data available</p>';
                return;
            }

            const html = users.map((user, index) => {
                const rankIcon = index < 3 ? ['🥇', '🥈', '🥉'][index] : `#${index + 1}`;
                const lastActivity = user.last_activity ? getTimeAgo(user.last_activity) : 'Unknown';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-bold text-gray-600" style="min-width: 30px;">${rankIcon}</span>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${user.first_name} ${user.last_name}</p>
                                <p class="text-xs text-gray-600">${user.club_name || 'Unknown Club'}</p>
                                <p class="text-xs text-gray-500">
                                    <i class="fas fa-clock mr-1"></i>${lastActivity}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-gray-900">${formatNumber(user.activity_count)}</p>
                            <p class="text-xs text-gray-600">activities</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        function updateSystemStatus(metrics) {
            document.getElementById('db-status').textContent = 'Online';
            document.getElementById('api-status').textContent = 'Online';
            document.getElementById('jobs-status').textContent = 'Running';
            document.getElementById('memory-usage').textContent = metrics.memory_usage || '45%';
            document.getElementById('cpu-usage').textContent = metrics.cpu_usage || '12%';
        }

        function updateActivityChart(chartData) {
            if (!dashboardState.charts.activity) return;
            
            const chart = dashboardState.charts.activity;
            
            // Clear existing datasets
            chart.data.labels = chartData.labels || [];
            chart.data.datasets = [];
            
            // Add datasets for each action type
            Object.keys(chartData.datasets || {}).forEach(actionType => {
                const dataset = chartData.datasets[actionType];
                chart.data.datasets.push({
                    label: dataset.label,
                    data: dataset.data,
                    borderColor: dataset.borderColor || getActionTypeColor(actionType),
                    backgroundColor: dataset.backgroundColor || `${getActionTypeColor(actionType)}20`,
                    tension: 0.4,
                    fill: true
                });
            });
            
            chart.update();
        }

        function setupCharts() {
            // Activity trend chart
            const ctx = document.getElementById('activity-chart').getContext('2d');
            dashboardState.charts.activity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Activities',
                        data: [],
                        borderColor: '#10645c',
                        backgroundColor: 'rgba(16, 100, 92, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });

            // Daily users chart
            const dailyCtx = document.getElementById('daily-users-chart').getContext('2d');
            dashboardState.charts.dailyUsers = new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'New Users (Daily)',
                        data: [],
                        borderColor: '#10645c',
                        backgroundColor: 'rgba(16, 100, 92, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });

            // Cumulative users chart
            const cumulativeCtx = document.getElementById('cumulative-users-chart').getContext('2d');
            dashboardState.charts.cumulativeUsers = new Chart(cumulativeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Total Users (Cumulative)',
                        data: [],
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    }
                }
            });
        }

        function startRealTimeUpdates() {
            // Refresh data every 30 seconds (except activity data to preserve filter state)
            dashboardState.refreshInterval = setInterval(() => {
                loadAllDataExceptActivity();
            }, 30000);
        }

        function refreshAllData() {
            loadAllData();
        }

        function refreshActivityData() {
            loadActivityData();
        }


        function setActivityFilter(filter) {
            console.log(`Setting activity filter to: ${filter}`);
            dashboardState.currentFilter = filter;
            
            // Update button states
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300';
            });
            
            const activeBtn = document.getElementById(`filter-${filter}`);
            if (activeBtn) {
                activeBtn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-rally-primary text-white';
            } else {
                console.error(`Button with id 'filter-${filter}' not found`);
            }
            
            // Load activities with new filter
            loadActivityData();
        }

        function getDateRangeForFilter(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (filter) {
                case 'realtime':
                    return { dateFrom: null, dateTo: null }; // Last 50 activities
                case 'hour':
                    const hourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                    return { dateFrom: hourAgo.toISOString(), dateTo: now.toISOString() };
                case 'day':
                    // Get today's date in YYYY-MM-DD format
                    const todayStr = today.toISOString().split('T')[0];
                    return { dateFrom: todayStr, dateTo: null };
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    const weekAgoStr = weekAgo.toISOString().split('T')[0];
                    return { dateFrom: weekAgoStr, dateTo: null };
                default:
                    return { dateFrom: null, dateTo: null };
            }
        }

        function getDateRangeForTopUsersFilter(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (filter) {
                case 'today':
                    return { dateFrom: today.toISOString().split('T')[0], dateTo: null };
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    return { dateFrom: weekAgo.toISOString().split('T')[0], dateTo: null };
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setDate(today.getDate() - 30);
                    return { dateFrom: monthAgo.toISOString().split('T')[0], dateTo: null };
                default:
                    return { dateFrom: today.toISOString().split('T')[0], dateTo: null };
            }
        }

        function setTopUsersFilter(filter) {
            dashboardState.topUsersFilter = filter;
            
            // Update button states
            document.querySelectorAll('[id^="top-users-filter-"]').forEach(btn => {
                btn.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300';
            });
            
            const activeBtn = document.getElementById(`top-users-filter-${filter}`);
            activeBtn.className = 'px-3 py-1 text-xs font-medium rounded-lg bg-rally-primary text-white';
            
            // Reload top users with new filter
            loadTopUsers();
        }

        function updateLastUpdated() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('last-updated').textContent = timeString;
            dashboardState.lastUpdate = now;
        }


        function updateUserCountChart(data) {
            // Update the daily chart data
            if (dashboardState.charts.dailyUsers && data.daily_chart_data) {
                dashboardState.charts.dailyUsers.data.labels = data.daily_chart_data.labels;
                dashboardState.charts.dailyUsers.data.datasets[0].data = data.daily_chart_data.datasets[0].data;
                dashboardState.charts.dailyUsers.update();
            }

            // Update the cumulative chart data
            if (dashboardState.charts.cumulativeUsers && data.cumulative_chart_data) {
                dashboardState.charts.cumulativeUsers.data.labels = data.cumulative_chart_data.labels;
                dashboardState.charts.cumulativeUsers.data.datasets[0].data = data.cumulative_chart_data.datasets[0].data;
                dashboardState.charts.cumulativeUsers.update();
            }

            // Update the summary text
            const totalEl = document.getElementById('user-count-total');
            const growthEl = document.getElementById('user-count-growth');
            
            if (totalEl) {
                totalEl.textContent = `Total: ${formatNumber(data.total_users)}`;
            }
            
            if (growthEl) {
                const growthText = data.growth_rate >= 0 ? `+${data.growth_rate}%` : `${data.growth_rate}%`;
                growthEl.textContent = `Growth: ${growthText}`;
            }
        }

        // Utility functions
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        }

        function getActionTypeIcon(actionType) {
            const iconMap = {
                'page_visit': 'fas fa-eye',
                'login': 'fas fa-sign-in-alt',
                'logout': 'fas fa-sign-out-alt',
                'registration_successful': 'fas fa-user-plus',
                'registration_failed': 'fas fa-user-times',
                'player_search': 'fas fa-search',
                'team_switch': 'fas fa-exchange-alt',
                'settings_update': 'fas fa-cog',
                'poll_voted': 'fas fa-vote-yea',
                'poll_created': 'fas fa-poll',
                'availability_update': 'fas fa-calendar-check',
                'ai_chat': 'fas fa-robot',
                'simulation_run': 'fas fa-dice',
                'score_submitted': 'fas fa-trophy',
                'team_email': 'fas fa-envelope',
                'court_reservation': 'fas fa-calendar-plus',
                'admin_action': 'fas fa-shield-alt',
                'user_action': 'fas fa-user-cog'
            };
            return iconMap[actionType] || 'fas fa-info-circle';
        }

        function getActionTypeColor(actionType) {
            const colorMap = {
                'page_visit': 'blue',
                'login': 'green',
                'logout': 'gray',
                'registration_successful': 'green',
                'registration_failed': 'red',
                'player_search': 'blue',
                'team_switch': 'purple',
                'settings_update': 'orange',
                'poll_voted': 'green',
                'poll_created': 'blue',
                'availability_update': 'green',
                'ai_chat': 'purple',
                'simulation_run': 'yellow',
                'score_submitted': 'gold',
                'team_email': 'blue',
                'court_reservation': 'green',
                'admin_action': 'red',
                'user_action': 'gray'
            };
            return colorMap[actionType] || 'gray';
        }

        function getDetailedActionDescription(activity) {
            const baseDescription = activity.action_description || activity.action_type;
            
            // Add more context based on action type
            switch (activity.action_type) {
                case 'page_visit':
                    return `${formatPageName(activity.page) || 'Unknown Page'}`;
                case 'login':
                    return `Logged in successfully`;
                case 'logout':
                    return `Logged out`;
                case 'registration_successful':
                    return `New user registration completed`;
                case 'registration_failed':
                    return `Registration failed`;
                case 'player_search':
                    return `Searched for players`;
                case 'team_switch':
                    return `Switched team context`;
                case 'settings_update':
                    return `Updated user settings`;
                case 'poll_voted':
                    return `Voted in poll`;
                case 'availability_update':
                    return `Updated availability`;
                case 'ai_chat':
                    return `Used AI chat feature`;
                case 'simulation_run':
                    return `Ran simulation`;
                case 'score_submitted':
                    return `Submitted match score`;
                case 'team_email':
                    return `Sent team email`;
                case 'court_reservation':
                    return `Made court reservation`;
                case 'admin_action':
                    return `Admin action performed`;
                default:
                    return baseDescription;
            }
        }

        function formatRegistrationFailedDetails(details) {
            try {
                const detailsObj = typeof details === 'string' ? JSON.parse(details) : details;
                
                let html = '';
                
                // Show reason
                if (detailsObj.reason) {
                    html += `<div class="mb-2">
                        <span class="font-medium text-red-700">Reason:</span>
                        <span class="text-red-600 ml-1">${detailsObj.reason}</span>
                    </div>`;
                }
                
                // Show lookup method if available
                if (detailsObj.lookup_method) {
                    html += `<div class="mb-2">
                        <span class="font-medium text-red-700">Lookup Method:</span>
                        <span class="text-red-600 ml-1 font-mono text-xs">${detailsObj.lookup_method}</span>
                    </div>`;
                }
                
                // Show lookup attempt details
                if (detailsObj.lookup_attempt) {
                    const attempt = detailsObj.lookup_attempt;
                    html += `<div class="mb-2">
                        <span class="font-medium text-red-700">Lookup Attempt:</span>
                        <div class="ml-2 mt-1 text-xs text-red-600">
                            <div><strong>Name:</strong> ${attempt.first_name} ${attempt.last_name}</div>
                            <div><strong>League:</strong> ${attempt.league_id}</div>
                            <div><strong>Club:</strong> ${attempt.club_name}</div>
                            <div><strong>Series:</strong> ${attempt.series_display || attempt.series_name || 'N/A'}</div>
                        </div>
                    </div>`;
                }
                
                // Show player lookup result
                if (detailsObj.player_lookup_result) {
                    const result = detailsObj.player_lookup_result;
                    html += `<div class="mb-2">
                        <span class="font-medium text-red-700">Lookup Result:</span>
                        <div class="ml-2 mt-1 text-xs text-red-600">
                            <div><strong>Match Type:</strong> ${result.match_type}</div>
                            <div><strong>Message:</strong> ${result.message}</div>
                        </div>
                    </div>`;
                }
                
                return html || '<span class="text-red-600 text-xs">No additional details available</span>';
            } catch (error) {
                console.error('Error parsing registration failed details:', error);
                return '<span class="text-red-600 text-xs">Error parsing details</span>';
            }
        }

        function formatPageName(page) {
            if (!page) return 'Unknown Page';
            
            // Define mapping for common page names - matches the backend format_page_name function
            const pageMap = {
                // Mobile App Pages
                'mobile_home': 'Home Page',
                'mobile_matches': 'Matches',
                'mobile_rankings': 'Rankings',
                'mobile_profile': 'Profile',
                'mobile_view_schedule': 'Schedule',
                'mobile_analyze_me': 'Analyze Me',
                'mobile_my_team': 'My Team Page',
                'mobile_settings': 'Settings',
                'mobile_my_series': 'My Series Page',
                'mobile_teams_players': 'Teams & Players',
                'mobile_player_search': 'Player Search',
                'mobile_my_club': 'My Club Page',
                'mobile_player_stats': 'Player Stats',
                'mobile_email_team': 'Email Team',
                'mobile_practice_times': 'Practice Times',
                'mobile_availability': 'Availability',
                'mobile_availability_calendar': 'Availability Calendar',
                'mobile_all_team_availability': 'Team Availability',
                'mobile_team_schedule': 'Team Schedule',
                'mobile_matchup_simulator': 'Matchup Simulator',
                'mobile_polls': 'Team Polls',
                'mobile_poll_vote': 'Poll Vote',
                'mobile_ask_ai': 'Ask AI',
                'mobile_find_subs': 'Find Subs',
                'mobile_find_people_to_play': 'Find People to Play',
                'mobile_lineup': 'Lineup',
                'mobile_lineup_escrow': 'Lineup Escrow',
                'mobile_improve': 'Improve Game',
                'mobile_training_videos': 'Training Videos',
                'mobile_reserve_court': 'Reserve Court',
                'mobile_player_detail': 'Player Detail',
                'mobile_track_byes_courts': 'Track Byes & Courts',
                'mobile_create_pickup_game': 'Create Pickup Game',
                'mobile_pickup_games': 'Pickup Games',
                'mobile_rally': 'Rally AI Chat',
                'mobile_schedule': 'Schedule Page',
                // Utility Pages
                'track_byes_courts': 'Track Byes & Courts',
                'contact_sub': 'Contact Sub',
                'player_detail': 'Player Detail',
                'pti_vs_opponents_analysis': 'PTI vs Opponents Analysis',
                'find_people_to_play': 'Find People to Play',
                'pickup_games': 'Pickup Games',
                'private_groups': 'Private Groups',
                'create_pickup_game': 'Create Pickup Game',
                'reserve_court': 'Reserve Court',
                'share_rally': 'Share Rally',
                'create_team': 'Create Team',
                'matchup_simulator': 'Matchup Simulator',
                'polls': 'Polls',
                'schedule_lesson': 'Schedule Lesson',
                'email_team': 'Email Team',
                'practice_times': 'Practice Times',
                'availability': 'Availability',
                'team_schedule': 'Team Schedule',
                'player_search': 'Player Search',
                'player_stats': 'Player Stats',
                'my_series': 'My Series',
                'analyze_me': 'Analyze Me',
                'my_team': 'My Team',
                'my_club': 'My Club',
                'user_activity': 'User Activity',
                'home_submenu': 'Home Page',
                'home_alt1': 'Home Page',
                'home_classic': 'Home Page',
                // Admin Pages
                'admin': 'Admin Dashboard',
                'admin_users': 'Admin - User Management',
                'admin_leagues': 'Admin - League Management',
                'admin_clubs': 'Admin - Club Management',
                'admin_series': 'Admin - Series Management',
                'admin_etl': 'Admin - Data Import',
                'admin_user_activity': 'Admin - User Activity',
                'admin_dashboard': 'Admin - Activity Dashboard',
                'admin_cockpit': 'Admin - Rally Cockpit',
                // Authentication Pages
                'login': 'Login Page',
                'logout': 'Logout',
                'register': 'Registration Page',
                // API Endpoints
                'api': 'API Endpoint',
                // Other Pages
                'pti_calculator': 'PTI Calculator',
                'schedule': 'Schedule Page',
                'matches': 'Matches Page',
                'rankings': 'Rankings Page',
                'profile': 'Profile Page',
                'settings': 'Settings Page',
                // Common patterns that might appear
                'home': 'Home Page',
                'index': 'Home Page',
                'main': 'Main Page',
                'dashboard': 'Dashboard',
                'welcome': 'Welcome Page',
                'interstitial': 'Welcome Page',
                'interstitial_welcome': 'Welcome Page',
                'contact_sub': 'Contact Substitute',
                'contact-sub': 'Contact Substitute',
                'user_activity': 'User Activity Page',
                'user-activity': 'User Activity Page',
                'api': 'API Endpoint',
                'static': 'Static Resource',
                'favicon.ico': 'Favicon',
                'robots.txt': 'Robots File',
                'sitemap.xml': 'Sitemap'
            };
            
            // Check for exact matches first
            if (pageMap[page]) {
                return pageMap[page];
            }
            
            // Handle pages that start with mobile/
            if (page.startsWith('mobile/')) {
                const cleanPage = page.replace('mobile/', '').replace(/-/g, '_');
                const mobileKey = `mobile_${cleanPage}`;
                if (pageMap[mobileKey]) {
                    return pageMap[mobileKey];
                }
            }
            
            // Handle admin pages
            if (page.startsWith('admin_') || page.startsWith('admin/')) {
                const cleanPage = page.replace('admin/', '').replace('admin_', '');
                return `Admin - ${cleanPage.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
            }
            
            // Handle API endpoints
            if (page.startsWith('api/')) {
                return `API - ${page.replace('api/', '').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
            }
            
            // Fallback: clean up the page name
            return page
                .replace(/[/_-]/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase())
                .replace(/^Mobile\s+/, '')
                + ' Page';
        }

        function getBrowserInfo(userAgent) {
            if (!userAgent) return 'Unknown';
            
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Other';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (dashboardState.refreshInterval) {
                clearInterval(dashboardState.refreshInterval);
            }
        });
    </script>
</body>
</html>
